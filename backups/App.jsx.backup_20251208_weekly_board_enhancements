// MODA Dashboard - React Components
// Extracted from index.html for optimization

        const { useState, useEffect, useMemo, useRef } = React;

        // ===== AUTOVOL LOGO =====
        const AUTOVOL_LOGO = "./public/autovol-logo.png";

        // ===== LICENSE PLATE UTILITIES =====
        const generateQRCode = (text) => {
            const qr = qrcode(0, 'M');
            qr.addData(text);
            qr.make();
            return qr.createDataURL(4, 0);
        };

        const buildModuleUrl = (baseUrl, projectId, serialNumber) => {
            // Point to the Module Scanner page
            const scannerUrl = baseUrl.replace(/[^/]*$/, 'Module_Scanner.html');
            return `${scannerUrl}?project=${encodeURIComponent(projectId)}&module=${encodeURIComponent(serialNumber)}`;
        };

        // Extract Building, Level, Module from BLM ID (e.g., B1L2M52 ‚Üí Building 1, Level 2, Module 52)
        const extractFromBLM = (blmId) => {
            const blm = String(blmId || '').toUpperCase();
            // Pattern: B{building}L{level}M{module} e.g., B1L2M52
            const match = blm.match(/B(\d+)L(\d+)M(\d+)/);
            if (match) {
                return {
                    building: `B${match[1]}`,
                    level: `L${match[2]}`,
                    module: `M${match[3].padStart(2, '0')}`
                };
            }
            // Fallback: Try 3-digit serial format (e.g., 313 = Building 3, Level 1, Module 3)
            const serialMatch = String(blmId).match(/^(\d)(\d)(\d+)$/);
            if (serialMatch) {
                return {
                    building: `B${serialMatch[1]}`,
                    level: `L${serialMatch[2]}`,
                    module: `M${serialMatch[3].padStart(2, '0')}`
                };
            }
            return { building: 'OTHER', level: 'OTHER', module: 'OTHER' };
        };

        const extractStack = (serialNumber) => {
            // Keep for backwards compatibility - now uses BLM extraction
            const result = extractFromBLM(serialNumber);
            return result.building !== 'OTHER' ? result.building : 'OTHER';
        };

        const extractUnitType = (unitType) => {
            const type = String(unitType).toUpperCase().replace(/[.\-_]/g, ' ').trim();
            const match = type.match(/^(\d*\s*B|STUDIO|STU)/i);
            return match ? match[0].replace(/\s+/g, '') : type.split(' ')[0] || 'OTHER';
        };

        const getLicensePlateIndicators = (module) => {
            const indicators = [];
            const difficulties = module.difficulties || {};
            
            if (difficulties.sidewall) indicators.push({ key: 'SW', label: 'SW' });
            if (difficulties.short) indicators.push({ key: 'SHORT', label: 'SHORT' });
            if (difficulties.stair) indicators.push({ key: 'STAIR', label: 'STAIR' });
            if (difficulties.hr3Wall) indicators.push({ key: '3HR', label: '3HR' });
            if (difficulties.doubleStudio) indicators.push({ key: 'DBL', label: 'DBL STUDIO' });
            if (difficulties.sawbox) indicators.push({ key: 'SAWBOX', label: 'SAWBOX' });
            if (difficulties.proto) indicators.push({ key: 'PROTO', label: 'PROTO' });
            
            return indicators;
        };
// ===== AUTHENTICATION SYSTEM =====

// ============================================================================
// DASHBOARD ROLES SYSTEM - ADDED FOR ROLE-BASED ACCESS CONTROL
// ============================================================================

// All available tabs in MODA system
const ALL_AVAILABLE_TABS = [
    { id: 'executive', label: 'üìä Executive', icon: 'üìä', description: 'High-level operational overview' },
    { id: 'production', label: 'üè≠ Production', icon: 'üè≠', description: 'Production floor management' },
    { id: 'projects', label: 'üìã Projects', icon: 'üìã', description: 'Project directory and tracking' },
    { id: 'people', label: 'üë• People', icon: 'üë•', description: 'Workforce management' },
    { id: 'qa', label: '‚úÖ QA', icon: '‚úÖ', description: 'Quality assurance tracking' },
    { id: 'transport', label: 'üöõ Transport', icon: 'üöõ', description: 'Transportation & logistics' },
    { id: 'equipment', label: 'üîß Equipment', icon: 'üîß', description: 'Tools & equipment tracking' },
    { id: 'precon', label: 'üìù Precon', icon: 'üìù', description: 'Preconstruction planning & estimates' },
    { id: 'rfi', label: 'üìã RFI', icon: 'üìã', description: 'Request for Information management' },
    { id: 'onsite', label: 'üèóÔ∏è On-Site', icon: 'üèóÔ∏è', description: 'Field operations & reporting' },
    { id: 'engineering', label: 'üìê Engineering', icon: 'üìê', description: 'Engineering documentation' },
    { id: 'automation', label: 'ü§ñ Automation', icon: 'ü§ñ', description: 'Automation systems' },
    { id: 'tracker', label: 'üì¶ Tracker', icon: 'üì¶', description: 'Module tracking system' },
    { id: 'admin', label: '‚öôÔ∏è Admin', icon: '‚öôÔ∏è', description: 'System administration' }
];

// Default role configurations
// tabPermissions: per-tab edit permissions. If not specified, falls back to global canEdit capability.
const DEFAULT_DASHBOARD_ROLES = [
    {
        id: 'admin',
        name: 'Admin',
        description: 'Full system access for operations management',
        tabs: ['production', 'projects', 'people', 'qa', 'transport', 'equipment', 'precon', 'rfi', 'onsite', 'engineering', 'automation', 'tracker', 'admin'],
        capabilities: {
            canEdit: true,
            canDelete: true,
            canCreate: true,
            canManageUsers: true,
            canAccessAdmin: true,
            canExportData: true
        },
        // Admin can edit all tabs
        tabPermissions: {
            production: { canEdit: true },
            projects: { canEdit: true },
            people: { canEdit: true },
            qa: { canEdit: true },
            transport: { canEdit: true },
            equipment: { canEdit: true },
            precon: { canEdit: true },
            rfi: { canEdit: true },
            onsite: { canEdit: true },
            engineering: { canEdit: true },
            automation: { canEdit: true },
            tracker: { canEdit: true },
            admin: { canEdit: true }
        },
        isDefault: false,
        isProtected: true // Cannot be deleted
    },
    {
        id: 'executive',
        name: 'Executive',
        description: 'CEO/CTO high-level operational view (view-only)',
        tabs: ['executive', 'production', 'projects', 'people'],
        capabilities: {
            canEdit: false,
            canDelete: false,
            canCreate: false,
            canManageUsers: false,
            canAccessAdmin: false,
            canExportData: true
        },
        // Executive is view-only on all tabs
        tabPermissions: {
            executive: { canEdit: false },
            production: { canEdit: false },
            projects: { canEdit: false },
            people: { canEdit: false }
        },
        isDefault: false,
        isProtected: false
    },
    {
        id: 'department-supervisor',
        name: 'Department Supervisor',
        description: 'Department-level management view',
        tabs: ['production', 'projects', 'people'],
        capabilities: {
            canEdit: true,
            canDelete: false,
            canCreate: true,
            canManageUsers: false,
            canAccessAdmin: false,
            canExportData: true
        },
        // Supervisor can edit production but view-only on people
        tabPermissions: {
            production: { canEdit: true },
            projects: { canEdit: true },
            people: { canEdit: false }
        },
        isDefault: false,
        isProtected: false
    },
    {
        id: 'coordinator',
        name: 'Coordinator',
        description: 'Cross-department coordination role',
        tabs: ['production', 'projects'],
        capabilities: {
            canEdit: true,
            canDelete: false,
            canCreate: true,
            canManageUsers: false,
            canAccessAdmin: false,
            canExportData: false
        },
        // Coordinator can edit production but view-only on projects
        tabPermissions: {
            production: { canEdit: true },
            projects: { canEdit: false }
        },
        isDefault: false,
        isProtected: false
    },
    {
        id: 'employee',
        name: 'Employee',
        description: 'Basic production floor view (view-only)',
        tabs: ['production'],
        capabilities: {
            canEdit: false,
            canDelete: false,
            canCreate: false,
            canManageUsers: false,
            canAccessAdmin: false,
            canExportData: false
        },
        // Employee is view-only
        tabPermissions: {
            production: { canEdit: false }
        },
        isDefault: true, // Default role for new users
        isProtected: false
    },
    {
        id: 'no-access',
        name: 'No Access',
        description: 'Cannot log in to system',
        tabs: [],
        capabilities: {
            canEdit: false,
            canDelete: false,
            canCreate: false,
            canManageUsers: false,
            canAccessAdmin: false,
            canExportData: false
        },
        tabPermissions: {},
        isDefault: false,
        isProtected: true // Cannot be deleted
    }
];

// Initialize roles in localStorage
function initializeDashboardRoles() {
    const existing = localStorage.getItem('autovol_dashboard_roles');
    const ROLES_VERSION = 2; // Increment this if you change DEFAULT_DASHBOARD_ROLES (v2: added tabPermissions)
    
    if (!existing) {
        // No roles exist, initialize
        localStorage.setItem('autovol_dashboard_roles', JSON.stringify(DEFAULT_DASHBOARD_ROLES));
        localStorage.setItem('autovol_dashboard_roles_version', ROLES_VERSION);
        console.log('‚úÖ Dashboard roles initialized');
    } else {
        // Check if we need to upgrade
        const currentVersion = parseInt(localStorage.getItem('autovol_dashboard_roles_version') || '0');
        if (currentVersion < ROLES_VERSION) {
            // Version mismatch - reinitialize
            localStorage.setItem('autovol_dashboard_roles', JSON.stringify(DEFAULT_DASHBOARD_ROLES));
            localStorage.setItem('autovol_dashboard_roles_version', ROLES_VERSION);
            console.log('‚úÖ Dashboard roles upgraded to version ' + ROLES_VERSION);
        }
    }
}

// Hook for managing dashboard roles
function useDashboardRoles() {
    const [roles, setRoles] = useState(() => {
        initializeDashboardRoles();
        const saved = localStorage.getItem('autovol_dashboard_roles');
        return saved ? JSON.parse(saved) : DEFAULT_DASHBOARD_ROLES;
    });

    useEffect(() => {
        localStorage.setItem('autovol_dashboard_roles', JSON.stringify(roles));
    }, [roles]);

    const addRole = (roleData) => {
        const newRole = {
            id: `role-${Date.now()}`,
            ...roleData,
            tabs: roleData.tabs || [],
            capabilities: roleData.capabilities || {},
            isProtected: false
        };
        setRoles([...roles, newRole]);
        return newRole;
    };

    const updateRole = (roleId, updates) => {
        setRoles(roles.map(role => 
            role.id === roleId ? { ...role, ...updates } : role
        ));
    };

    const deleteRole = (roleId) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.isProtected) {
            return { success: false, error: 'Cannot delete protected role' };
        }
        setRoles(roles.filter(role => role.id !== roleId));
        return { success: true };
    };

    const setDefaultRole = (roleId) => {
        setRoles(roles.map(role => ({
            ...role,
            isDefault: role.id === roleId
        })));
    };

    const moveTab = (roleId, tabId, direction) => {
        const role = roles.find(r => r.id === roleId);
        if (!role) return;

        const tabs = [...role.tabs];
        const currentIndex = tabs.indexOf(tabId);
        
        if (direction === 'up' && currentIndex > 0) {
            [tabs[currentIndex], tabs[currentIndex - 1]] = [tabs[currentIndex - 1], tabs[currentIndex]];
        } else if (direction === 'down' && currentIndex < tabs.length - 1) {
            [tabs[currentIndex], tabs[currentIndex + 1]] = [tabs[currentIndex + 1], tabs[currentIndex]];
        }

        updateRole(roleId, { tabs });
    };

    const toggleTab = (roleId, tabId) => {
        const role = roles.find(r => r.id === roleId);
        if (!role) return;

        const tabs = role.tabs.includes(tabId)
            ? role.tabs.filter(t => t !== tabId)
            : [...role.tabs, tabId];

        updateRole(roleId, { tabs });
    };

    const toggleCapability = (roleId, capability) => {
        const role = roles.find(r => r.id === roleId);
        if (!role) return;

        const capabilities = {
            ...role.capabilities,
            [capability]: !role.capabilities[capability]
        };

        updateRole(roleId, { capabilities });
    };

    const getRoleById = (roleId) => {
        return roles.find(r => r.id === roleId);
    };

    const getVisibleTabs = (roleId) => {
        const role = getRoleById(roleId);
        return role ? role.tabs : [];
    };

    const hasCapability = (roleId, capability) => {
        const role = getRoleById(roleId);
        return role?.capabilities?.[capability] || false;
    };

    // Check if a role can edit a specific tab
    // Falls back to global canEdit capability if tabPermissions not defined
    const canEditTab = (roleId, tabId) => {
        const role = getRoleById(roleId);
        if (!role) return false;
        
        // Check tab-specific permission first
        if (role.tabPermissions && role.tabPermissions[tabId] !== undefined) {
            return role.tabPermissions[tabId]?.canEdit || false;
        }
        
        // Fall back to global canEdit capability
        return role.capabilities?.canEdit || false;
    };

    // Toggle tab-specific edit permission
    const toggleTabPermission = (roleId, tabId) => {
        const role = roles.find(r => r.id === roleId);
        if (!role) return;

        const currentPermissions = role.tabPermissions || {};
        const currentTabPerm = currentPermissions[tabId] || { canEdit: role.capabilities?.canEdit || false };
        
        const tabPermissions = {
            ...currentPermissions,
            [tabId]: { ...currentTabPerm, canEdit: !currentTabPerm.canEdit }
        };

        updateRole(roleId, { tabPermissions });
    };

    // Get tab permission for a specific tab
    const getTabPermission = (roleId, tabId) => {
        const role = getRoleById(roleId);
        if (!role) return { canEdit: false };
        
        if (role.tabPermissions && role.tabPermissions[tabId]) {
            return role.tabPermissions[tabId];
        }
        
        // Default to global canEdit
        return { canEdit: role.capabilities?.canEdit || false };
    };

    return { 
        roles, 
        addRole, 
        updateRole, 
        deleteRole, 
        setDefaultRole, 
        moveTab, 
        toggleTab, 
        toggleCapability,
        getRoleById,
        getVisibleTabs,
        hasCapability,
        canEditTab,
        toggleTabPermission,
        getTabPermission
    };
}

// ============================================================================
// END DASHBOARD ROLES SYSTEM
// ============================================================================


        // ===== AUTHENTICATION SYSTEM =====

const INITIAL_USERS = [
    { 
        id: 1, 
        email: 'trevor@autovol.com', 
        password: 'admin123', 
        name: 'Trevor Fletcher', 
        dashboardRole: 'admin',     // CHANGED: Uses dashboardRole instead of role
        isProtected: true,          // NEW: Trevor cannot be changed
        department: 'Operations', 
        active: true, 
        createdAt: '2024-01-01' 
    },
    { 
        id: 2, 
        email: 'curtis@autovol.com', 
        password: 'admin123', 
        name: 'Curtis Fletcher', 
        dashboardRole: 'executive',  // CHANGED: Curtis gets Executive role
        isProtected: false,
        department: 'CTO', 
        active: true, 
        createdAt: '2024-01-01' 
    },
    { 
        id: 3, 
        email: 'user@autovol.com', 
        password: 'user123', 
        name: 'Demo User', 
        dashboardRole: 'employee',  // CHANGED: Uses dashboardRole instead of role
        isProtected: false,
        department: 'Production', 
        active: true, 
        createdAt: '2024-01-15' 
    }
];

        
function useAuth() {
    // Initialize dashboard roles system
    initializeDashboardRoles();
    
    const [currentUser, setCurrentUser] = useState(() => {
        const saved = localStorage.getItem('autovol_session');
        return saved ? JSON.parse(saved) : null;
    });
    
    const [users, setUsers] = useState(() => {
        const saved = localStorage.getItem('autovol_users');
        if (saved) {
            const savedUsers = JSON.parse(saved);
            // Merge in any new INITIAL_USERS that don't exist in saved
            const savedEmails = savedUsers.map(u => u.email.toLowerCase());
            const newUsers = INITIAL_USERS.filter(u => !savedEmails.includes(u.email.toLowerCase()));
            if (newUsers.length > 0) {
                return [...savedUsers, ...newUsers];
            }
            return savedUsers;
        }
        return INITIAL_USERS;
    });

    // MIGRATION: Convert old role/permissions to dashboardRole
    useEffect(() => {
        let needsMigration = false;
        const migratedUsers = users.map(user => {
            // Migrate old 'role' field to 'dashboardRole'
            if (user.role && !user.dashboardRole) {
                needsMigration = true;
                let dashboardRole = 'employee';
                if (user.role === 'Admin') dashboardRole = 'admin';
                else if (user.role === 'User') dashboardRole = 'employee';
                
                const isProtected = user.email === 'trevor@autovol.com';
                if (isProtected) dashboardRole = 'admin';
                
                return { 
                    ...user, 
                    dashboardRole, 
                    isProtected,
                    role: undefined,        // Remove old field
                    permissions: undefined  // Remove if exists
                };
            }
            
            // Migrate old 'permissions' field to 'dashboardRole'
            if (user.permissions && !user.dashboardRole) {
                needsMigration = true;
                let dashboardRole = 'employee';
                if (user.permissions === 'Admin') dashboardRole = 'admin';
                else if (user.permissions === 'User') dashboardRole = 'employee';
                else if (user.permissions === 'No Access') dashboardRole = 'no-access';
                
                const isProtected = user.email === 'trevor@autovol.com';
                if (isProtected) dashboardRole = 'admin';
                
                return { 
                    ...user, 
                    dashboardRole, 
                    isProtected,
                    permissions: undefined,
                    role: undefined
                };
            }
            
            // Ensure Trevor is always protected
            if (user.email === 'trevor@autovol.com' && !user.isProtected) {
                needsMigration = true;
                return { ...user, isProtected: true, dashboardRole: 'admin' };
            }
            
            return user;
        });
        
        if (needsMigration) {
            setUsers(migratedUsers);
            console.log('‚úÖ Migrated users to dashboard role system');
        }
    }, []);

    useEffect(() => { 
        localStorage.setItem('autovol_users', JSON.stringify(users)); 
    }, [users]);

    const login = (email, password, rememberMe) => {
    const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password && u.active);
    if (user) {
        // MIGRATION FIX: Ensure user has dashboardRole
        let migratedUser = { ...user };
        if (user.role && !user.dashboardRole) {
            // Convert old role to dashboardRole
            if (user.role === 'Admin') migratedUser.dashboardRole = 'admin';
            else if (user.role === 'User') migratedUser.dashboardRole = 'employee';
            migratedUser.isProtected = user.email === 'trevor@autovol.com';
            delete migratedUser.role;
            delete migratedUser.permissions;
        }
        
        const session = { ...migratedUser, password: undefined };
        setCurrentUser(session);
        if (rememberMe) localStorage.setItem('autovol_session', JSON.stringify(session));
        else sessionStorage.setItem('autovol_session', JSON.stringify(session));
        return { success: true };
    }
    return { success: false, error: 'Invalid email or password' };
};

    const logout = () => { 
        setCurrentUser(null); 
        localStorage.removeItem('autovol_session'); 
        sessionStorage.removeItem('autovol_session'); 
    };
    
    const addUser = (userData) => { 
        const newUser = { 
            ...userData, 
            id: Date.now(), 
            active: true, 
            createdAt: new Date().toISOString().split('T')[0],
            dashboardRole: userData.dashboardRole || 'employee',
            isProtected: false
        }; 
        setUsers([...users, newUser]); 
        return newUser; 
    };
    
    const updateUser = (userId, updates) => { 
        setUsers(users.map(u => {
            if (u.id === userId) {
                // Prevent changing protected accounts
                if (u.isProtected && updates.dashboardRole && updates.dashboardRole !== u.dashboardRole) {
                    console.warn('Cannot change role of protected account');
                    return u;
                }
                return { ...u, ...updates };
            }
            return u;
        })); 
    };
    
    const toggleUserActive = (userId) => { 
        setUsers(users.map(u => u.id === userId ? { ...u, active: !u.active } : u)); 
    };
    
    const resetPassword = (email) => { 
        const user = users.find(u => u.email.toLowerCase() === email.toLowerCase()); 
        return user ? { success: true, message: 'Password reset email sent (simulated)' } : { success: false, error: 'Email not found' }; 
    };

    // Dashboard roles integration
    const dashboardRoles = useDashboardRoles();
    const userRole = currentUser ? dashboardRoles.getRoleById(currentUser.dashboardRole) : null;
    const visibleTabs = currentUser ? dashboardRoles.getVisibleTabs(currentUser.dashboardRole) : [];
    
    // Capability checks
    const canEdit = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canEdit') : false;
    const canDelete = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canDelete') : false;
    const canCreate = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canCreate') : false;
    const canManageUsers = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canManageUsers') : false;
    const canAccessAdmin = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canAccessAdmin') : false;
    const canExportData = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canExportData') : false;

    // Tab-specific edit permission check
    // Usage: auth.canEditTab('production') returns true/false
    const canEditTabFn = (tabId) => {
        if (!currentUser) return false;
        return dashboardRoles.canEditTab(currentUser.dashboardRole, tabId);
    };

    return { 
        currentUser, 
        users, 
        login, 
        logout, 
        addUser, 
        updateUser, 
        toggleUserActive, 
        resetPassword,
        // Dashboard role system
        dashboardRoles,
        userRole,
        visibleTabs,
        // Capabilities
        canEdit,
        canDelete,
        canCreate,
        canManageUsers,
        canAccessAdmin,
        canExportData,
        // Tab-specific permissions
        canEditTab: canEditTabFn,
        // Backward compatibility
        isAdmin: canAccessAdmin
    };
}


        function LoginForm({ auth, onForgotPassword }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setLoading(true);
                await new Promise(r => setTimeout(r, 500));
                const result = auth.login(email, password, rememberMe);
                if (!result.success) setError(result.error);
                setLoading(false);
            };

            return (
                <>
                    <div className="text-center mb-8">
                        <img 
                            src={AUTOVOL_LOGO} 
                            alt="Autovol Volumetric Modular" 
                            style={{height: '60px', width: 'auto', margin: '0 auto'}}
                        />
                        <p className="text-gray-500 text-xs mt-3">Making Smart Construction Brilliant‚Ñ¢</p>
                    </div>
                    <h2 style={{color: '#1E3A5F'}} className="text-xl font-semibold text-center mb-6">Sign in to MODA</h2>
                    {error && <div className="mb-4 p-3 rounded-lg text-sm" style={{backgroundColor: '#FDEAEA', color: '#E31B23'}}>{error}</div>}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field" placeholder="you@autovol.com" required /></div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <div className="relative">
                                <input 
                                    type={showPassword ? 'text' : 'password'} 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    className="input-field pr-10" 
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                    required 
                                />
                                <button 
                                    type="button" 
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                    tabIndex={-1}
                                >
                                    {showPassword ? 'üôà' : 'üëÅ'}
                                </button>
                            </div>
                        </div>
                        <div className="flex items-center justify-between">
                            <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="w-4 h-4 rounded" /><span className="text-sm text-gray-600">Remember me</span></label>
                            <button type="button" onClick={onForgotPassword} className="text-sm font-medium" style={{color: '#007B8A'}}>Forgot password?</button>
                        </div>
                        <button type="submit" disabled={loading} className="w-full py-3 rounded-lg font-semibold btn-primary">{loading ? 'Signing in...' : 'Sign In'}</button>
                    </form>
                    <div className="mt-6 pt-6 border-t text-center">
                        <p className="text-xs text-gray-400">Modular Operations Dashboard Application</p>
                        <p className="text-xs text-gray-300 mt-2">Admin: trevor@autovol.com or curtis@autovol.com / admin123</p>
                    </div>
                </>
            );
        }

        function ForgotPasswordForm({ auth, onBack }) {
            const [email, setEmail] = useState('');
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setMessage(''); setLoading(true);
                await new Promise(r => setTimeout(r, 500));
                const result = auth.resetPassword(email);
                if (result.success) setMessage(result.message);
                else setError(result.error);
                setLoading(false);
            };

            return (
                <>
                    <button onClick={onBack} className="mb-4 text-sm flex items-center gap-1" style={{color: '#007B8A'}}>‚Üê Back to login</button>
                    <h2 style={{color: '#1E3A5F'}} className="text-xl font-semibold mb-2">Reset Password</h2>
                    <p className="text-gray-500 text-sm mb-6">Enter your email and we'll send you a reset link.</p>
                    {error && <div className="mb-4 p-3 rounded-lg text-sm" style={{backgroundColor: '#FDEAEA', color: '#E31B23'}}>{error}</div>}
                    {message && <div className="mb-4 p-3 rounded-lg text-sm" style={{backgroundColor: '#E6F4F5', color: '#007B8A'}}>{message}</div>}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field" placeholder="you@autovol.com" required /></div>
                        <button type="submit" disabled={loading} className="w-full py-3 rounded-lg font-semibold btn-primary">{loading ? 'Sending...' : 'Send Reset Link'}</button>
                    </form>
                </>
            );
        }

        function LoginPage({ auth }) {
            const [view, setView] = useState('login');
            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative login-background">
                    <div className="production-lines"></div>
                    <div className="login-card w-full max-w-md p-8 relative z-10">
                        {view === 'login' && <LoginForm auth={auth} onForgotPassword={() => setView('forgot')} />}
                        {view === 'forgot' && <ForgotPasswordForm auth={auth} onBack={() => setView('login')} />}
                    </div>
                </div>
            );
        }
        // ===== END AUTHENTICATION SYSTEM =====

        // Production Stages Definition - 21 stations with staggers
        // startingSerial: the module serial # that starts at this station this week
        // stagger: offset from Automation (calculated from starting modules)
        const productionStages = [
            { id: 'auto-fc', name: 'Automation (Floor/Ceiling)', dept: 'AUTO-FC', color: 'bg-slate-600', group: 'automation', startingSerial: '25-0861' },
            { id: 'auto-walls', name: 'Automation (Walls)', dept: 'AUTO-W', color: 'bg-slate-500', group: 'automation', startingSerial: '25-0861' },
            { id: 'mezzanine', name: 'Mezzanine (FC Prep, Plumbing - Floors)', dept: 'MEZZ', color: 'bg-violet-500', group: null, startingSerial: '25-0860' },
            { id: 'elec-ceiling', name: 'Electrical - Ceilings', dept: 'ELEC-C', color: 'bg-amber-400', group: null, startingSerial: '25-0857' },
            { id: 'wall-set', name: 'Wall Set', dept: 'WALL', color: 'bg-autovol-teal', group: null, startingSerial: '25-0856' },
            { id: 'ceiling-set', name: 'Ceiling Set', dept: 'CEIL', color: 'bg-teal-400', group: null, startingSerial: '25-0855' },
            { id: 'soffits', name: 'Soffits', dept: 'SOFF', color: 'bg-sky-500', group: null, startingSerial: '25-0854' },
            { id: 'mech-rough', name: 'Mechanical Rough-In', dept: 'MECH-R', color: 'bg-cyan-600', group: 'mep-rough', startingSerial: '25-0959' },
            { id: 'elec-rough', name: 'Electrical Rough-In', dept: 'ELEC-R', color: 'bg-cyan-500', group: 'mep-rough', startingSerial: '25-0959' },
            { id: 'plumb-rough', name: 'Plumbing Rough-In', dept: 'PLMB-R', color: 'bg-cyan-400', group: 'mep-rough', startingSerial: '25-0959' },
            { id: 'exteriors', name: 'Exteriors', dept: 'EXT', color: 'bg-teal-500', group: null, startingSerial: '25-0853' },
            { id: 'drywall-bp', name: 'Drywall - BackPanel', dept: 'DRY-BP', color: 'bg-green-600', group: null, startingSerial: '25-0852' },
            { id: 'drywall-ttp', name: 'Drywall - Tape/Texture/Paint', dept: 'DRY-TTP', color: 'bg-green-500', group: null, startingSerial: '25-0846' },
            { id: 'roofing', name: 'Roofing', dept: 'ROOF', color: 'bg-amber-500', group: null, startingSerial: '25-0848' },
            { id: 'pre-finish', name: 'Pre-Finish', dept: 'PRE-FIN', color: 'bg-lime-500', group: null, startingSerial: '25-0840' },
            { id: 'mech-trim', name: 'Mechanical Trim', dept: 'MECH-T', color: 'bg-yellow-600', group: 'mep-trim', startingSerial: '25-0956' },
            { id: 'elec-trim', name: 'Electrical Trim', dept: 'ELEC-T', color: 'bg-yellow-500', group: 'mep-trim', startingSerial: '25-0956' },
            { id: 'plumb-trim', name: 'Plumbing Trim', dept: 'PLMB-T', color: 'bg-yellow-400', group: 'mep-trim', startingSerial: '25-0956' },
            { id: 'final-finish', name: 'Final Finish', dept: 'FINAL', color: 'bg-orange-500', group: null, startingSerial: '25-0958' },
            { id: 'sign-off', name: 'Module Sign-Off', dept: 'SIGN-OFF', color: 'bg-rose-500', group: null, startingSerial: '25-0955' },
            { id: 'close-up', name: 'Close-Up', dept: 'CLOSE', color: 'bg-red-500', group: null, startingSerial: '25-0953' }
        ];

        // Station groups for visual styling
        const stationGroups = {
            'automation': { name: 'Automation', borderColor: 'border-autovol-teal', stations: ['auto-fc', 'auto-walls'] },
            'mep-rough': { name: 'MEP Rough-In', borderColor: 'border-cyan-500', stations: ['mech-rough', 'elec-rough', 'plumb-rough'] },
            'mep-trim': { name: 'MEP Trim', borderColor: 'border-yellow-500', stations: ['mech-trim', 'elec-trim', 'plumb-trim'] }
        };

        // Station staggers (offset from Automation in build sequence)
        // Higher number = station is working on modules further ahead in production
        // Default values as of Dec 5, 2025
        const stationStaggers = {
            'auto-fc': 0,        // Automation (Floor/Ceiling) - Base
            'auto-walls': 0,     // Automation (Walls) - Parallel with F/C
            'mezzanine': 1,      // Mezzanine (FC Prep, Plumbing - Floors)
            'elec-ceiling': 4,   // Electrical - Ceilings
            'wall-set': 5,       // Wall Set
            'ceiling-set': 6,    // Ceiling Set
            'soffits': 7,        // Soffits
            'mech-rough': 8,     // Mechanical Rough-In (MEP Rough-In group)
            'elec-rough': 8,     // Electrical Rough-In (MEP Rough-In group)
            'plumb-rough': 8,    // Plumbing Rough-In (MEP Rough-In group)
            'exteriors': 9,      // Exteriors
            'drywall-bp': 10,    // Drywall - BackPanel
            'drywall-ttp': 18,   // Drywall - Tape/Texture/Paint
            'roofing': 15,       // Roofing
            'pre-finish': 24,    // Pre-Finish
            'mech-trim': 25,     // Mechanical Trim (MEP Trim group)
            'elec-trim': 25,     // Electrical Trim (MEP Trim group)
            'plumb-trim': 25,    // Plumbing Trim (MEP Trim group)
            'final-finish': 27,  // Final Finish
            'sign-off': 29,      // Module Sign-Off
            'close-up': 36       // Close-Up
        };

        // Difficulty color mappings
        const difficultyColors = {
            sidewall: 'bg-orange-100 text-orange-800',
            stair: 'bg-purple-100 text-purple-800',
            hr3Wall: 'bg-red-100 text-red-800',
            short: 'bg-yellow-100 text-yellow-800',
            doubleStudio: 'bg-indigo-100 text-indigo-800',
            sawbox: 'bg-pink-100 text-pink-800'
        };

        const difficultyLabels = {
            sidewall: 'Sidewall',
            stair: 'Stair',
            hr3Wall: '3HR-Wall',
            short: 'Short',
            doubleStudio: 'Dbl Studio',
            sawbox: 'Sawbox'
        };

        // Default Employee Roster (from Autovol_Roster_Current.xlsx)
        const defaultEmployees = [];

// ===== PRODUCTION WEEK MANAGEMENT HOOK =====
const useProductionWeeks = () => {
    const [weeks, setWeeks] = useState(() => {
        const saved = localStorage.getItem('autovol_production_weeks');
        return saved ? JSON.parse(saved) : [];
    });
    
    const [staggerConfig, setStaggerConfig] = useState(() => {
        const saved = localStorage.getItem('autovol_station_staggers');
        return saved ? JSON.parse(saved) : { ...stationStaggers };
    });
    
    // Stagger change log - tracks all saved stagger configurations
    const [staggerChangeLog, setStaggerChangeLog] = useState(() => {
        const saved = localStorage.getItem('autovol_stagger_change_log');
        return saved ? JSON.parse(saved) : [];
    });
    
    // Track if there are unsaved changes
    const [hasUnsavedStaggerChanges, setHasUnsavedStaggerChanges] = useState(false);
    const [pendingStaggerChanges, setPendingStaggerChanges] = useState({});
    
    useEffect(() => {
        localStorage.setItem('autovol_production_weeks', JSON.stringify(weeks));
    }, [weeks]);
    
    useEffect(() => {
        localStorage.setItem('autovol_station_staggers', JSON.stringify(staggerConfig));
    }, [staggerConfig]);
    
    useEffect(() => {
        localStorage.setItem('autovol_stagger_change_log', JSON.stringify(staggerChangeLog));
    }, [staggerChangeLog]);
    
    const addWeek = (weekData) => {
        const newWeek = { ...weekData, id: `week-${Date.now()}`, createdAt: new Date().toISOString() };
        setWeeks(prev => [...prev, newWeek]);
        return newWeek;
    };
    
    const updateWeek = (weekId, updates) => {
        setWeeks(prev => prev.map(w => w.id === weekId ? { ...w, ...updates } : w));
    };
    
    const deleteWeek = (weekId) => {
        setWeeks(prev => prev.filter(w => w.id !== weekId));
    };
    
    // Update stagger value (marks as pending until saved)
    const updateStagger = (stationId, value) => {
        const newValue = parseInt(value) || 0;
        setPendingStaggerChanges(prev => ({ ...prev, [stationId]: newValue }));
        setStaggerConfig(prev => ({ ...prev, [stationId]: newValue }));
        setHasUnsavedStaggerChanges(true);
    };
    
    // Save stagger changes with description to change log
    const saveStaggerChanges = (description, userName = 'Unknown') => {
        if (!hasUnsavedStaggerChanges) return;
        
        const logEntry = {
            id: `stagger-${Date.now()}`,
            timestamp: new Date().toISOString(),
            description: description || 'No description provided',
            changedBy: userName,
            changes: { ...pendingStaggerChanges },
            fullConfig: { ...staggerConfig }
        };
        
        setStaggerChangeLog(prev => [logEntry, ...prev]);
        setPendingStaggerChanges({});
        setHasUnsavedStaggerChanges(false);
        
        return logEntry;
    };
    
    // Revert to a previous stagger configuration
    const revertToStaggerConfig = (logEntryId) => {
        const entry = staggerChangeLog.find(e => e.id === logEntryId);
        if (entry && entry.fullConfig) {
            setStaggerConfig({ ...entry.fullConfig });
            setPendingStaggerChanges({});
            setHasUnsavedStaggerChanges(false);
        }
    };
    
    // Reset to default staggers
    const resetToDefaultStaggers = () => {
        setStaggerConfig({ ...stationStaggers });
        setPendingStaggerChanges({});
        setHasUnsavedStaggerChanges(true);
    };
    
    const validateWeek = (weekData, excludeId = null) => {
        const start = new Date(weekData.weekStart);
        const end = new Date(weekData.weekEnd);
        if (end <= start) return { valid: false, error: 'End date must be after start date' };
        const overlap = weeks.find(w => {
            if (w.id === excludeId) return false;
            const wStart = new Date(w.weekStart);
            const wEnd = new Date(w.weekEnd);
            return (start <= wEnd && end >= wStart);
        });
        if (overlap) return { valid: false, error: 'Week overlaps with existing schedule' };
        return { valid: true };
    };
    
    const getCurrentWeek = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return weeks.find(week => {
            const start = new Date(week.weekStart);
            const end = new Date(week.weekEnd);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            return today >= start && today <= end;
        });
    };
    
    const getWeekForDate = (date) => {
        const targetDate = new Date(date);
        targetDate.setHours(0, 0, 0, 0);
        return weeks.find(week => {
            const start = new Date(week.weekStart);
            const end = new Date(week.weekEnd);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            return targetDate >= start && targetDate <= end;
        });
    };

    return { 
        weeks, 
        staggerConfig, 
        staggerChangeLog,
        hasUnsavedStaggerChanges,
        addWeek, 
        updateWeek, 
        deleteWeek, 
        updateStagger,
        saveStaggerChanges,
        revertToStaggerConfig,
        resetToDefaultStaggers,
        validateWeek,
        getCurrentWeek,
        getWeekForDate
    };
};

// ===== STAGGER CONFIG TAB COMPONENT =====
function StaggerConfigTab({ productionStages, stationGroups, staggerConfig, staggerChangeLog, hasUnsavedStaggerChanges, updateStagger, saveStaggerChanges, revertToStaggerConfig, resetToDefaultStaggers, currentUser, isAdmin }) {
    // Only admins can edit staggers
    const [changeDescription, setChangeDescription] = useState('');
    const [showChangeLog, setShowChangeLog] = useState(false);
    const [confirmRevert, setConfirmRevert] = useState(null);

    const handleSaveChanges = () => {
        if (!changeDescription.trim()) { alert('Please enter a description for this change'); return; }
        const userName = currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'Unknown';
        saveStaggerChanges(changeDescription.trim(), userName);
        setChangeDescription('');
    };

    const handleRevert = (logEntryId) => { revertToStaggerConfig(logEntryId); setConfirmRevert(null); };

    const formatDate = (isoString) => {
        const date = new Date(isoString);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    };

    return (
        <div className="space-y-6">
            <div className="flex items-start justify-between gap-4">
                <div>
                    <h3 className="text-lg font-semibold text-autovol-navy">Station Stagger Configuration</h3>
                    <p className="text-sm text-gray-600">Configure the offset between departments. A stagger of 5 means that station is working on modules 5 positions ahead of Automation.</p>
                    {!isAdmin && <p className="text-xs text-amber-600 mt-1">üîí View only - Admin access required to modify staggers</p>}
                </div>
                <div className="flex items-center gap-2">
                    {isAdmin && (
                        <button onClick={resetToDefaultStaggers} className="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600">Reset to Default</button>
                    )}
                    <button onClick={() => setShowChangeLog(!showChangeLog)} className={`px-3 py-1.5 text-sm border rounded-lg flex items-center gap-1 ${showChangeLog ? 'bg-blue-50 border-blue-300 text-blue-700' : 'border-gray-300 hover:bg-gray-50 text-gray-600'}`}>
                        üìã Change Log ({staggerChangeLog.length})
                    </button>
                </div>
            </div>

            {/* Unsaved Changes Banner */}
            {hasUnsavedStaggerChanges && isAdmin && (
                <div className="bg-amber-50 border border-amber-300 rounded-lg p-4">
                    <div className="flex items-center gap-2 text-amber-800 font-medium mb-2">‚ö†Ô∏è You have unsaved stagger changes</div>
                    <div className="flex items-center gap-2">
                        <input type="text" value={changeDescription} onChange={(e) => setChangeDescription(e.target.value)} placeholder="Describe why you're making this change..." className="flex-1 px-3 py-2 border border-amber-300 rounded-lg text-sm" />
                        <button onClick={handleSaveChanges} disabled={!changeDescription.trim()} className="px-4 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed">Save Changes</button>
                    </div>
                </div>
            )}

            {/* Change Log Panel */}
            {showChangeLog && (
                <div className="bg-gray-50 border rounded-lg">
                    <div className="p-3 border-b bg-gray-100 flex items-center justify-between">
                        <h4 className="font-semibold text-gray-700">Stagger Change History</h4>
                        <button onClick={() => setShowChangeLog(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <div className="max-h-64 overflow-y-auto">
                        {staggerChangeLog.length === 0 ? (
                            <div className="p-4 text-center text-gray-500 text-sm">No changes recorded yet.</div>
                        ) : (
                            <div className="divide-y">
                                {staggerChangeLog.map((entry, idx) => (
                                    <div key={entry.id} className="p-3 hover:bg-white">
                                        <div className="flex items-start justify-between gap-2">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 text-sm">
                                                    <span className="font-medium text-gray-800">{entry.description}</span>
                                                    {idx === 0 && <span className="px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded">Current</span>}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-0.5">{formatDate(entry.timestamp)} ‚Ä¢ by {entry.changedBy}</div>
                                                {Object.keys(entry.changes || {}).length > 0 && (
                                                    <div className="mt-1 text-xs text-gray-600">
                                                        Changed: {Object.entries(entry.changes).map(([station, value]) => (
                                                            <span key={station} className="inline-block bg-gray-200 px-1.5 py-0.5 rounded mr-1 mb-1">{station}: {value}</span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            {idx !== 0 && isAdmin && (
                                                confirmRevert === entry.id ? (
                                                    <div className="flex items-center gap-1">
                                                        <button onClick={() => handleRevert(entry.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded">Confirm</button>
                                                        <button onClick={() => setConfirmRevert(null)} className="px-2 py-1 bg-gray-300 text-gray-700 text-xs rounded">Cancel</button>
                                                    </div>
                                                ) : (
                                                    <button onClick={() => setConfirmRevert(entry.id)} className="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-100">Revert</button>
                                                )
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Stagger Table */}
            <div className="overflow-x-auto">
                <table className="w-full text-sm">
                    <thead>
                        <tr className="border-b">
                            <th className="text-left py-2 px-3 font-semibold text-gray-700">Station</th>
                            <th className="text-left py-2 px-3 font-semibold text-gray-700">Dept Code</th>
                            <th className="text-left py-2 px-3 font-semibold text-gray-700">Stagger Offset</th>
                            <th className="text-left py-2 px-3 font-semibold text-gray-700">Group</th>
                        </tr>
                    </thead>
                    <tbody>
                        {productionStages.map((station, idx) => (
                            <tr key={station.id} className={idx % 2 === 0 ? 'bg-gray-50' : ''}>
                                <td className="py-2 px-3">{station.name}</td>
                                <td className="py-2 px-3 font-mono">{station.dept}</td>
                                <td className="py-2 px-3">
                                    <input type="number" min="0" max="50" value={staggerConfig[station.id] || 0} onChange={(e) => isAdmin && updateStagger(station.id, e.target.value)} disabled={!isAdmin} className={`w-20 px-2 py-1 border rounded text-center font-mono ${!isAdmin ? 'bg-gray-100 cursor-not-allowed' : ''}`} />
                                </td>
                                <td className="py-2 px-3">
                                    {station.group && <span className="text-xs bg-gray-200 px-2 py-0.5 rounded">{stationGroups[station.group]?.name || station.group}</span>}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Info Tip */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700">
                <strong>Tip:</strong> Stagger values determine which module appears at each station on the Weekly Board. <strong>Remember to save your changes with a description!</strong>
            </div>
        </div>
    );
}

function DashboardRoleManager({ auth }) {
    const { 
        roles, 
        addRole, 
        updateRole, 
        deleteRole, 
        setDefaultRole, 
        moveTab, 
        toggleTab, 
        toggleCapability
    } = auth.dashboardRoles;
    
    const [selectedRoleId, setSelectedRoleId] = useState(roles[0]?.id);
    const [showEditModal, setShowEditModal] = useState(false);
    const [editingRole, setEditingRole] = useState(null);
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [deletingRole, setDeletingRole] = useState(null);

    const selectedRole = roles.find(r => r.id === selectedRoleId);

    // Handlers
    const handleCreateRole = () => {
        setEditingRole(null);
        setShowEditModal(true);
    };

    const handleEditRole = () => {
        setEditingRole(selectedRole);
        setShowEditModal(true);
    };

    const handleSaveRole = (roleData) => {
        if (editingRole) {
            updateRole(editingRole.id, roleData);
            if (roleData.isDefault) {
                setDefaultRole(editingRole.id);
            }
        } else {
            const newRole = addRole(roleData);
            setSelectedRoleId(newRole.id);
            if (roleData.isDefault) {
                setDefaultRole(newRole.id);
            }
        }
        setShowEditModal(false);
        setEditingRole(null);
    };

    const handleDeleteRole = () => {
        setDeletingRole(selectedRole);
        setShowDeleteModal(true);
    };

    const confirmDelete = () => {
        const result = deleteRole(deletingRole.id);
        if (result.success) {
            setShowDeleteModal(false);
            setDeletingRole(null);
            setSelectedRoleId(roles[0]?.id);
        }
    };

    const canDeleteRole = (role) => {
        if (role.isProtected) {
            return { canDelete: false, reason: 'This is a protected system role.' };
        }
        return { canDelete: true };
    };

    const deletionCheck = selectedRole ? canDeleteRole(selectedRole) : { canDelete: true };

    // Emergency recovery function
    const handleEmergencyRecovery = () => {
        if (confirm('This will restore Trevor Fletcher as Admin. Continue?')) {
            const updatedUsers = auth.users.map(u => {
                if (u.email === 'trevor@autovol.com') {
                    return { ...u, dashboardRole: 'admin', isProtected: true };
                }
                return u;
            });
            localStorage.setItem('autovol_users', JSON.stringify(updatedUsers));
            alert('‚úÖ Trevor Fletcher restored as Admin. Please refresh the page.');
            window.location.reload();
        }
    };

    return (
        <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ 
                background: 'white', 
                padding: '20px', 
                borderRadius: '8px', 
                marginBottom: '20px',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
            }}>
                <h1 style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--autovol-navy)', marginBottom: '5px' }}>
                    üé≠ Dashboard Role Manager
                </h1>
                <p style={{ fontSize: '14px', color: '#6B7280' }}>
                    Configure role-based views and capabilities - Manage who sees what
                </p>
            </div>

            {/* Safety Alert */}
            <div style={{ 
                padding: '12px',
                borderRadius: '6px',
                marginBottom: '20px',
                fontSize: '13px',
                background: '#D1FAE5',
                color: '#065F46',
                border: '2px solid #6EE7B7'
            }}>
                <strong>‚úÖ Protected System:</strong> Trevor Fletcher's admin access is permanently protected.
            </div>

            {/* Main Grid */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: '300px 1fr 350px', 
                gap: '20px',
                minHeight: '600px'
            }}>
                {/* LEFT PANEL - Role List */}
                <div style={{ 
                    background: 'white', 
                    borderRadius: '8px', 
                    padding: '20px',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    overflowY: 'auto'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                        <h2 style={{ fontSize: '18px', color: 'var(--autovol-navy)' }}>Roles</h2>
                        <button 
                            onClick={handleCreateRole}
                            className="btn-primary"
                            style={{ padding: '8px 16px', borderRadius: '6px', fontSize: '14px' }}
                        >
                            + New
                        </button>
                    </div>

                    {roles.map(role => (
                        <div
                            key={role.id}
                            onClick={() => setSelectedRoleId(role.id)}
                            style={{
                                padding: '12px',
                                border: `2px solid ${selectedRoleId === role.id ? 'var(--autovol-red)' : '#E5E7EB'}`,
                                borderRadius: '6px',
                                marginBottom: '8px',
                                cursor: 'pointer',
                                background: selectedRoleId === role.id ? '#FEF2F2' : (role.isProtected ? '#F0FDF4' : 'white'),
                                transition: 'all 0.2s'
                            }}
                        >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div style={{ fontWeight: '600', color: 'var(--autovol-navy)', fontSize: '14px' }}>
                                    {role.isProtected && 'üõ°Ô∏è '}
                                    {role.name}
                                </div>
                                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                    {role.isDefault && (
                                        <span style={{
                                            background: '#10B981',
                                            color: 'white',
                                            fontSize: '10px',
                                            padding: '2px 6px',
                                            borderRadius: '4px',
                                            fontWeight: '600'
                                        }}>DEFAULT</span>
                                    )}
                                    {role.capabilities?.canAccessAdmin && (
                                        <span style={{
                                            background: 'var(--autovol-red)',
                                            color: 'white',
                                            fontSize: '10px',
                                            padding: '2px 6px',
                                            borderRadius: '4px',
                                            fontWeight: '600'
                                        }}>ADMIN</span>
                                    )}
                                </div>
                            </div>
                            {role.description && (
                                <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px' }}>
                                    {role.description}
                                </div>
                            )}
                            <div style={{ fontSize: '11px', color: '#9CA3AF', marginTop: '4px' }}>
                                {role.tabs.length} tabs ‚Ä¢ {Object.values(role.capabilities || {}).filter(Boolean).length} capabilities
                            </div>
                        </div>
                    ))}

                    {/* Emergency Recovery */}
                    <div style={{
                        background: '#FEE2E2',
                        border: '2px solid #EF4444',
                        borderRadius: '8px',
                        padding: '15px',
                        marginTop: '20px'
                    }}>
                        <div style={{
                            color: '#991B1B',
                            fontWeight: '600',
                            fontSize: '14px',
                            marginBottom: '8px'
                        }}>
                            üö® Emergency Recovery
                        </div>
                        <div style={{ fontSize: '12px', color: '#7F1D1D', marginBottom: '10px' }}>
                            Restore admin access if locked out
                        </div>
                        <button 
                            onClick={handleEmergencyRecovery}
                            style={{
                                background: '#EF4444',
                                color: 'white',
                                border: 'none',
                                padding: '8px 12px',
                                borderRadius: '6px',
                                fontSize: '12px',
                                cursor: 'pointer',
                                fontWeight: '500'
                            }}
                        >
                            Restore Trevor's Admin
                        </button>
                    </div>
                </div>

                {/* CENTER PANEL - Configuration */}
                <div style={{ 
                    background: 'white', 
                    borderRadius: '8px', 
                    padding: '20px',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    overflowY: 'auto'
                }}>
                    {selectedRole ? (
                        <>
                            {/* Role Header */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: '20px',
                                paddingBottom: '15px',
                                borderBottom: '2px solid #E5E7EB'
                            }}>
                                <div>
                                    <div style={{ fontSize: '20px', fontWeight: '700', color: 'var(--autovol-navy)' }}>
                                        {selectedRole.isProtected && 'üõ°Ô∏è '}
                                        {selectedRole.name}
                                    </div>
                                    {selectedRole.description && (
                                        <p style={{ fontSize: '13px', color: '#6B7280', marginTop: '4px' }}>
                                            {selectedRole.description}
                                        </p>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button 
                                        onClick={handleEditRole}
                                        className="btn-secondary"
                                        style={{ padding: '8px 16px', borderRadius: '6px', fontSize: '14px' }}
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        onClick={handleDeleteRole}
                                        disabled={!deletionCheck.canDelete}
                                        title={!deletionCheck.canDelete ? deletionCheck.reason : ''}
                                        style={{
                                            padding: '8px 16px',
                                            borderRadius: '6px',
                                            fontSize: '14px',
                                            fontWeight: '500',
                                            cursor: deletionCheck.canDelete ? 'pointer' : 'not-allowed',
                                            border: 'none',
                                            background: '#EF4444',
                                            color: 'white',
                                            opacity: deletionCheck.canDelete ? 1 : 0.4
                                        }}
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>

                            {selectedRole.isProtected && (
                                <div style={{
                                    padding: '12px',
                                    borderRadius: '6px',
                                    marginBottom: '20px',
                                    fontSize: '13px',
                                    background: '#DBEAFE',
                                    color: '#1E40AF',
                                    border: '2px solid #93C5FD'
                                }}>
                                    <strong>üõ°Ô∏è Protected Role:</strong> Cannot be deleted to ensure system integrity.
                                </div>
                            )}

                            {/* Default Role Toggle */}
                            <div style={{ marginBottom: '25px' }}>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: 'var(--autovol-navy)', marginBottom: '12px' }}>
                                    Default Role Setting
                                </div>
                                <div 
                                    onClick={() => setDefaultRole(selectedRole.id)}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px',
                                        padding: '12px',
                                        background: '#F9FAFB',
                                        borderRadius: '6px',
                                        border: '2px solid #E5E7EB',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <div style={{
                                        width: '44px',
                                        height: '24px',
                                        background: selectedRole.isDefault ? '#10B981' : '#D1D5DB',
                                        borderRadius: '12px',
                                        position: 'relative',
                                        transition: 'background 0.2s'
                                    }}>
                                        <div style={{
                                            width: '20px',
                                            height: '20px',
                                            background: 'white',
                                            borderRadius: '50%',
                                            position: 'absolute',
                                            top: '2px',
                                            left: selectedRole.isDefault ? '22px' : '2px',
                                            transition: 'left 0.2s',
                                            boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
                                        }} />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontSize: '13px', fontWeight: '500', color: 'var(--autovol-navy)' }}>
                                            {selectedRole.isDefault ? 'This is the default role' : 'Set as default role'}
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#6B7280' }}>
                                            New employees automatically receive this role
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Capabilities */}
                            <div style={{ marginBottom: '25px' }}>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: 'var(--autovol-navy)', marginBottom: '12px' }}>
                                    Role Capabilities
                                </div>
                                <p style={{ fontSize: '12px', color: '#6B7280', marginBottom: '12px' }}>
                                    Define what actions users with this role can perform
                                </p>

                                {[
                                    { key: 'canEdit', name: 'Can Edit Data', desc: 'Modify existing records' },
                                    { key: 'canCreate', name: 'Can Create Records', desc: 'Add new modules and projects' },
                                    { key: 'canDelete', name: 'Can Delete Data', desc: 'Remove records from system' },
                                    { key: 'canManageUsers', name: 'Can Manage Users', desc: 'Edit employee roles' },
                                    { key: 'canAccessAdmin', name: 'Can Access Admin', desc: 'Full system administration' },
                                    { key: 'canExportData', name: 'Can Export Data', desc: 'Download Excel reports' }
                                ].map(cap => (
                                    <div 
                                        key={cap.key}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '10px',
                                            padding: '10px 12px',
                                            background: 'white',
                                            border: '2px solid #E5E7EB',
                                            borderRadius: '6px',
                                            marginBottom: '8px'
                                        }}
                                    >
                                        <input
                                            type="checkbox"
                                            checked={selectedRole.capabilities?.[cap.key] || false}
                                            onChange={() => toggleCapability(selectedRole.id, cap.key)}
                                            style={{ width: '20px', height: '20px', cursor: 'pointer' }}
                                        />
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontSize: '13px', fontWeight: '500', color: 'var(--autovol-navy)' }}>
                                                {cap.name}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#6B7280', marginTop: '2px' }}>
                                                {cap.desc}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Tab Visibility */}
                            <div style={{ marginBottom: '25px' }}>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: 'var(--autovol-navy)', marginBottom: '12px' }}>
                                    Tab Visibility & Order
                                </div>
                                <p style={{ fontSize: '12px', color: '#6B7280', marginBottom: '12px' }}>
                                    Check to enable, use arrows to reorder tabs
                                </p>

                                <div style={{ border: '2px solid #E5E7EB', borderRadius: '6px', overflow: 'hidden' }}>
                                    {ALL_AVAILABLE_TABS.map((tab) => {
                                        const isEnabled = selectedRole.tabs.includes(tab.id);
                                        const enabledIndex = selectedRole.tabs.indexOf(tab.id);
                                        const isFirst = enabledIndex === 0;
                                        const isLast = enabledIndex === selectedRole.tabs.length - 1;

                                        return (
                                            <div 
                                                key={tab.id} 
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    padding: '12px',
                                                    borderBottom: '1px solid #E5E7EB',
                                                    background: 'white',
                                                    opacity: isEnabled ? 1 : 0.5
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={isEnabled}
                                                    onChange={() => toggleTab(selectedRole.id, tab.id)}
                                                    style={{ width: '20px', height: '20px', cursor: 'pointer' }}
                                                />
                                                
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ fontSize: '14px', fontWeight: '500', color: 'var(--autovol-navy)' }}>
                                                        {tab.label}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: '#9CA3AF', marginTop: '2px' }}>
                                                        {tab.description}
                                                    </div>
                                                </div>

                                                {isEnabled && (
                                                    <>
                                                        <div style={{
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            color: 'var(--autovol-navy)',
                                                            minWidth: '20px',
                                                            textAlign: 'center'
                                                        }}>
                                                            #{enabledIndex + 1}
                                                        </div>
                                                        <div style={{ display: 'flex', gap: '4px' }}>
                                                            <button
                                                                onClick={() => moveTab(selectedRole.id, tab.id, 'up')}
                                                                disabled={isFirst}
                                                                style={{
                                                                    width: '28px',
                                                                    height: '28px',
                                                                    border: '1px solid #D1D5DB',
                                                                    background: 'white',
                                                                    borderRadius: '4px',
                                                                    cursor: isFirst ? 'not-allowed' : 'pointer',
                                                                    fontSize: '12px',
                                                                    opacity: isFirst ? 0.3 : 1
                                                                }}
                                                                title="Move up"
                                                            >
                                                                ‚ñ≤
                                                            </button>
                                                            <button
                                                                onClick={() => moveTab(selectedRole.id, tab.id, 'down')}
                                                                disabled={isLast}
                                                                style={{
                                                                    width: '28px',
                                                                    height: '28px',
                                                                    border: '1px solid #D1D5DB',
                                                                    background: 'white',
                                                                    borderRadius: '4px',
                                                                    cursor: isLast ? 'not-allowed' : 'pointer',
                                                                    fontSize: '12px',
                                                                    opacity: isLast ? 0.3 : 1
                                                                }}
                                                                title="Move down"
                                                            >
                                                                ‚ñº
                                                            </button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '60px 20px', color: '#9CA3AF' }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>üé≠</div>
                            <p>Select a role to configure</p>
                        </div>
                    )}
                </div>

                {/* RIGHT PANEL - Preview */}
                <div style={{ 
                    background: 'white', 
                    borderRadius: '8px', 
                    padding: '20px',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    overflowY: 'auto'
                }}>
                    {selectedRole ? (
                        <>
                            <div style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: 'var(--autovol-navy)', marginBottom: '5px' }}>
                                    Navigation Preview
                                </div>
                                <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                    How navigation appears for this role
                                </div>
                            </div>

                            <div style={{
                                background: '#F9FAFB',
                                border: '2px solid #E5E7EB',
                                borderRadius: '6px',
                                padding: '8px'
                            }}>
                                {selectedRole.tabs.length === 0 ? (
                                    <div style={{
                                        padding: '20px',
                                        textAlign: 'center',
                                        color: '#9CA3AF',
                                        fontSize: '13px'
                                    }}>
                                        No tabs enabled
                                    </div>
                                ) : (
                                    selectedRole.tabs.map((tabId, index) => {
                                        const tab = ALL_AVAILABLE_TABS.find(t => t.id === tabId);
                                        if (!tab) return null;

                                        return (
                                            <div
                                                key={tabId}
                                                style={{
                                                    padding: '8px 12px',
                                                    marginBottom: '4px',
                                                    borderRadius: '4px',
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    background: index === 0 ? 'var(--autovol-red)' : 'white',
                                                    color: index === 0 ? 'white' : 'var(--autovol-navy)',
                                                    border: index === 0 ? 'none' : '1px solid #E5E7EB'
                                                }}
                                            >
                                                <span>{tab.icon}</span>
                                                <span>{tab.label.replace(tab.icon + ' ', '')}</span>
                                            </div>
                                        );
                                    })
                                )}
                            </div>

                            {/* Stats */}
                            <div style={{
                                marginTop: '15px',
                                padding: '12px',
                                background: '#F9FAFB',
                                borderRadius: '6px',
                                border: '2px solid #E5E7EB'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    fontSize: '13px',
                                    marginBottom: '8px',
                                    color: 'var(--autovol-navy)'
                                }}>
                                    <span>Enabled Tabs:</span>
                                    <span style={{ fontWeight: '600' }}>
                                        {selectedRole.tabs.length} / {ALL_AVAILABLE_TABS.length}
                                    </span>
                                </div>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    fontSize: '13px',
                                    marginBottom: '8px',
                                    color: 'var(--autovol-navy)'
                                }}>
                                    <span>Default Role:</span>
                                    <span style={{ fontWeight: '600' }}>
                                        {selectedRole.isDefault ? 'Yes' : 'No'}
                                    </span>
                                </div>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    fontSize: '13px',
                                    color: 'var(--autovol-navy)'
                                }}>
                                    <span>Protected:</span>
                                    <span style={{ fontWeight: '600' }}>
                                        {selectedRole.isProtected ? 'üõ°Ô∏è Yes' : 'No'}
                                    </span>
                                </div>
                            </div>

                            {/* Capabilities Preview */}
                            <div style={{ marginTop: '15px' }}>
                                <div style={{ fontWeight: '600', fontSize: '13px', marginBottom: '10px' }}>
                                    Capabilities:
                                </div>
                                {[
                                    { key: 'canEdit', icon: '‚úèÔ∏è', label: 'Can Edit Data' },
                                    { key: 'canCreate', icon: '‚ûï', label: 'Can Create Records' },
                                    { key: 'canDelete', icon: 'üóëÔ∏è', label: 'Can Delete Data' },
                                    { key: 'canManageUsers', icon: 'üë•', label: 'Can Manage Users' },
                                    { key: 'canAccessAdmin', icon: '‚öôÔ∏è', label: 'Can Access Admin' },
                                    { key: 'canExportData', icon: 'üì•', label: 'Can Export Data' }
                                ].filter(cap => selectedRole.capabilities?.[cap.key]).map(cap => (
                                    <div key={cap.key} style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        fontSize: '12px',
                                        color: 'var(--autovol-navy)',
                                        marginBottom: '6px'
                                    }}>
                                        <span style={{ fontSize: '14px' }}>{cap.icon}</span>
                                        <span>{cap.label}</span>
                                    </div>
                                ))}
                                {Object.values(selectedRole.capabilities || {}).every(v => !v) && (
                                    <div style={{ fontSize: '12px', color: '#9CA3AF', fontStyle: 'italic' }}>
                                        View-only access
                                    </div>
                                )}
                            </div>
                        </>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '60px 20px', color: '#9CA3AF' }}>
                            <div style={{ fontSize: '48px', marginBottom: '15px' }}>üëÅÔ∏è</div>
                            <p>Preview will appear here</p>
                        </div>
                    )}
                </div>
            </div>

            {/* Modals */}
            {showEditModal && (
                <RoleEditModal
                    role={editingRole}
                    onSave={handleSaveRole}
                    onCancel={() => {
                        setShowEditModal(false);
                        setEditingRole(null);
                    }}
                />
            )}

            {showDeleteModal && (
                <DeleteConfirmModal
                    role={deletingRole}
                    onConfirm={confirmDelete}
                    onCancel={() => {
                        setShowDeleteModal(false);
                        setDeletingRole(null);
                    }}
                    cannotDelete={!deletionCheck.canDelete}
                    reason={deletionCheck.reason}
                />
            )}
        </div>
    );
}

// Role Edit Modal Component
function RoleEditModal({ role, onSave, onCancel }) {
    const [formData, setFormData] = useState({
        name: role?.name || '',
        description: role?.description || '',
        isDefault: role?.isDefault || false
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
    };

    return (
        <div 
            style={{
                position: 'fixed',
                inset: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '20px'
            }}
            onClick={onCancel}
        >
            <div 
                style={{
                    background: 'white',
                    borderRadius: '8px',
                    maxWidth: '500px',
                    width: '100%',
                    maxHeight: '90vh',
                    overflowY: 'auto',
                    boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3)'
                }}
                onClick={e => e.stopPropagation()}
            >
                <div style={{ padding: '20px', borderBottom: '2px solid #E5E7EB' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: 'var(--autovol-navy)' }}>
                        {role ? 'Edit Dashboard Role' : 'Create Dashboard Role'}
                    </div>
                </div>
                <form onSubmit={handleSubmit}>
                    <div style={{ padding: '20px' }}>
                        {!role && (
                            <div style={{
                                padding: '12px',
                                borderRadius: '6px',
                                marginBottom: '15px',
                                fontSize: '13px',
                                background: '#DBEAFE',
                                color: '#1E40AF',
                                border: '2px solid #93C5FD'
                            }}>
                                After creating, you'll configure tabs and capabilities
                            </div>
                        )}
                        
                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#374151', marginBottom: '6px' }}>
                                Role Name *
                            </label>
                            <input
                                type="text"
                                value={formData.name}
                                onChange={e => setFormData({ ...formData, name: e.target.value })}
                                placeholder="e.g., Department Supervisor"
                                required
                                style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '2px solid #E5E7EB',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }}
                            />
                        </div>

                        <div style={{ marginBottom: '15px' }}>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#374151', marginBottom: '6px' }}>
                                Description
                            </label>
                            <textarea
                                value={formData.description}
                                onChange={e => setFormData({ ...formData, description: e.target.value })}
                                placeholder="Brief description of this role's purpose"
                                style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '2px solid #E5E7EB',
                                    borderRadius: '6px',
                                    fontSize: '14px',
                                    minHeight: '60px',
                                    resize: 'vertical'
                                }}
                            />
                            <div style={{ fontSize: '12px', color: '#6B7280', marginTop: '4px' }}>
                                Help users understand who this role is for
                            </div>
                        </div>

                        <div 
                            onClick={() => setFormData({ ...formData, isDefault: !formData.isDefault })}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px',
                                padding: '12px',
                                background: '#F9FAFB',
                                borderRadius: '6px',
                                border: '2px solid #E5E7EB',
                                cursor: 'pointer'
                            }}
                        >
                            <div style={{
                                width: '44px',
                                height: '24px',
                                background: formData.isDefault ? '#10B981' : '#D1D5DB',
                                borderRadius: '12px',
                                position: 'relative',
                                transition: 'background 0.2s'
                            }}>
                                <div style={{
                                    width: '20px',
                                    height: '20px',
                                    background: 'white',
                                    borderRadius: '50%',
                                    position: 'absolute',
                                    top: '2px',
                                    left: formData.isDefault ? '22px' : '2px',
                                    transition: 'left 0.2s',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
                                }} />
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: 'var(--autovol-navy)' }}>
                                    Set as Default Role
                                </div>
                                <div style={{ fontSize: '11px', color: '#6B7280' }}>
                                    New employees automatically get this role
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style={{ padding: '20px', borderTop: '2px solid #E5E7EB', display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                        <button 
                            type="button" 
                            onClick={onCancel}
                            style={{
                                padding: '8px 16px',
                                borderRadius: '6px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                border: 'none',
                                background: '#E5E7EB',
                                color: 'var(--autovol-navy)'
                            }}
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            className="btn-primary"
                            style={{ padding: '8px 16px', borderRadius: '6px', fontSize: '14px' }}
                        >
                            {role ? 'Save Changes' : 'Create Role'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// Delete Confirmation Modal
function DeleteConfirmModal({ role, onConfirm, onCancel, cannotDelete, reason }) {
    const [confirmText, setConfirmText] = useState('');

    return (
        <div 
            style={{
                position: 'fixed',
                inset: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '20px'
            }}
            onClick={onCancel}
        >
            <div 
                style={{
                    background: 'white',
                    borderRadius: '8px',
                    maxWidth: '500px',
                    width: '100%',
                    boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3)'
                }}
                onClick={e => e.stopPropagation()}
            >
                <div style={{ padding: '20px', borderBottom: '2px solid #E5E7EB' }}>
                    <div style={{ fontSize: '20px', fontWeight: '700', color: 'var(--autovol-navy)' }}>
                        Delete Dashboard Role
                    </div>
                </div>
                <div style={{ padding: '20px' }}>
                    {cannotDelete ? (
                        <div style={{
                            padding: '12px',
                            borderRadius: '6px',
                            fontSize: '13px',
                            background: '#FEE2E2',
                            color: '#991B1B',
                            border: '2px solid #FCA5A5'
                        }}>
                            <strong>Cannot Delete Role:</strong> {reason}
                        </div>
                    ) : (
                        <>
                            <div style={{
                                padding: '12px',
                                borderRadius: '6px',
                                marginBottom: '15px',
                                fontSize: '13px',
                                background: '#FEF3C7',
                                color: '#92400E',
                                border: '2px solid #FCD34D'
                            }}>
                                <strong>Warning:</strong> This cannot be undone. Users assigned this role will need reassignment.
                            </div>
                            
                            <p style={{ marginBottom: '15px', fontSize: '14px', color: 'var(--autovol-navy)' }}>
                                Delete: <strong>{role.name}</strong>
                            </p>

                            <div style={{ marginBottom: '15px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#374151', marginBottom: '6px' }}>
                                    Type "<strong>DELETE</strong>" to confirm
                                </label>
                                <input
                                    type="text"
                                    value={confirmText}
                                    onChange={e => setConfirmText(e.target.value)}
                                    placeholder="DELETE"
                                    style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        border: '2px solid #E5E7EB',
                                        borderRadius: '6px',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                        </>
                    )}
                </div>
                <div style={{ padding: '20px', borderTop: '2px solid #E5E7EB', display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                    <button 
                        onClick={onCancel}
                        style={{
                            padding: '8px 16px',
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            border: 'none',
                            background: '#E5E7EB',
                            color: 'var(--autovol-navy)'
                        }}
                    >
                        {cannotDelete ? 'Close' : 'Cancel'}
                    </button>
                    {!cannotDelete && (
                        <button 
                            onClick={onConfirm}
                            disabled={confirmText !== 'DELETE'}
                            style={{
                                padding: '8px 16px',
                                borderRadius: '6px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: confirmText === 'DELETE' ? 'pointer' : 'not-allowed',
                                border: 'none',
                                background: '#EF4444',
                                color: 'white',
                                opacity: confirmText === 'DELETE' ? 1 : 0.4
                            }}
                        >
                            Delete Role
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
}

// ============================================================================
// END DASHBOARD ROLE MANAGER COMPONENT
// ============================================================================

        // Main Dashboard Component (requires authentication)
        function Dashboard({ auth }) {
            const [activeTab, setActiveTab] = useState('production');
            const [projects, setProjects] = useState(() => {
                const saved = localStorage.getItem('autovol_projects');
                return saved ? JSON.parse(saved) : [];
            });
            const [trashedProjects, setTrashedProjects] = useState(() => {
                const saved = localStorage.getItem('autovol_trash_projects');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Auto-purge items older than 90 days
                    const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
                    return parsed.filter(p => p.deletedAt > ninetyDaysAgo);
                }
                return [];
            });
            const [trashedEmployees, setTrashedEmployees] = useState(() => {
                const saved = localStorage.getItem('autovol_trash_employees');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Auto-purge items older than 90 days
                    const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
                    return parsed.filter(e => e.deletedAt > ninetyDaysAgo);
                }
                return [];
            });
            const [showDataManagement, setShowDataManagement] = useState(false);
            const [selectedProject, setSelectedProject] = useState(null);
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [viewMode, setViewMode] = useState('grid'); // grid, list
            const [searchTerm, setSearchTerm] = useState('');
            const [stageFilter, setStageFilter] = useState('all');
            
            // Theme state (dark mode)
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('moda_theme');
                if (saved) return saved === 'dark';
                // Auto-detect system preference
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            
            // Keyboard shortcuts help modal
            const [showShortcutsHelp, setShowShortcutsHelp] = useState(false);
            
            // Apply theme to document
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
                localStorage.setItem('moda_theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);
            
            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Don't trigger shortcuts when typing in inputs
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    
                    const key = e.key.toLowerCase();
                    const ctrl = e.ctrlKey || e.metaKey;
                    
                    // Ctrl+D: Toggle dark mode
                    if (ctrl && key === 'd') {
                        e.preventDefault();
                        setDarkMode(prev => !prev);
                        return;
                    }
                    
                    // ?: Show shortcuts help
                    if (e.key === '?' || (e.shiftKey && key === '/')) {
                        e.preventDefault();
                        setShowShortcutsHelp(true);
                        return;
                    }
                    
                    // Escape: Close modals
                    if (key === 'escape') {
                        setShowShortcutsHelp(false);
                        setShowProjectModal(false);
                        setShowImportModal(false);
                        setShowDataManagement(false);
                        return;
                    }
                    
                    // Tab navigation with number keys (1-9)
                    if (!ctrl && !e.altKey && /^[1-9]$/.test(key)) {
                        const tabIndex = parseInt(key) - 1;
                        const visibleTabs = [
                            'executive', 'production', 'projects', 'people', 'qa', 
                            'transport', 'equipment', 'precon', 'onsite', 'engineering', 
                            'automation', 'tracker'
                        ].filter(tab => auth.visibleTabs.includes(tab));
                        
                        if (tabIndex < visibleTabs.length) {
                            e.preventDefault();
                            setActiveTab(visibleTabs[tabIndex]);
                            setSelectedProject(null);
                        }
                        return;
                    }
                    
                    // Ctrl+E: Export data (admin only)
                    if (ctrl && key === 'e' && auth.isAdmin) {
                        e.preventDefault();
                        exportData();
                        return;
                    }
                    
                    // Ctrl+F: Focus search (if on projects tab)
                    if (ctrl && key === 'f' && activeTab === 'projects') {
                        e.preventDefault();
                        const searchInput = document.querySelector('input[placeholder*="Search"]');
                        if (searchInput) searchInput.focus();
                        return;
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [activeTab, auth.visibleTabs, auth.isAdmin]);
            
            // People Module State
            const [employees, setEmployees] = useState(() => {
                const saved = localStorage.getItem('autovol_employees');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Use defaults if saved is empty array
                    return parsed.length > 0 ? parsed : defaultEmployees;
                }
                return defaultEmployees;
            });
            const [departments, setDepartments] = useState(() => {
                const saved = localStorage.getItem('autovol_departments');
                return saved ? JSON.parse(saved) : productionStages.map(s => ({
                    id: s.id,
                    name: s.name,
                    supervisor: null,
                    employeeCount: 0
                }));
            });

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('autovol_projects', JSON.stringify(projects));
                // Sync to unified layer for any modules with close-up at 100%
                MODA_UNIFIED.migrateFromProjects();
            }, [projects]);

            useEffect(() => {
                localStorage.setItem('autovol_trash_projects', JSON.stringify(trashedProjects));
            }, [trashedProjects]);

            useEffect(() => {
                localStorage.setItem('autovol_trash_employees', JSON.stringify(trashedEmployees));
            }, [trashedEmployees]);

            useEffect(() => {
                localStorage.setItem('autovol_employees', JSON.stringify(employees));
            }, [employees]);

            useEffect(() => {
                localStorage.setItem('autovol_departments', JSON.stringify(departments));
            }, [departments]);

            // Export all data as JSON
            const exportData = () => {
                const data = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    projects,
                    trashedProjects,
                    employees,
                    trashedEmployees,
                    departments
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MODA_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // Import data from JSON file
            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.projects) setProjects(data.projects);
                        if (data.trashedProjects) setTrashedProjects(data.trashedProjects);
                        if (data.employees) setEmployees(data.employees);
                        if (data.trashedEmployees) setTrashedEmployees(data.trashedEmployees);
                        if (data.departments) setDepartments(data.departments);
                        alert('Data restored successfully!');
                    } catch (err) {
                        alert('Error reading backup file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };

            // Calculate department status from ALL active projects
            const departmentStatus = useMemo(() => {
                const status = {};
                productionStages.forEach(stage => {
                    status[stage.id] = { inProgress: 0, completed: 0 };
                });

                projects.filter(p => p.status === 'Active').forEach(project => {
                    (project.modules || []).forEach(module => {
                        productionStages.forEach(stage => {
                            const progress = module.stageProgress?.[stage.id] || 0;
                            if (progress > 0 && progress < 100) {
                                status[stage.id].inProgress++;
                            } else if (progress === 100) {
                                status[stage.id].completed++;
                            }
                        });
                    });
                });

                return status;
            }, [projects]);

            // Active projects count
            const activeProjects = projects.filter(p => p.status === 'Active');
            const totalActiveModules = activeProjects.reduce((sum, p) => sum + (p.modules?.length || 0), 0);

            return (
                <div className="min-h-screen" style={{backgroundColor: 'var(--autovol-gray-bg)'}}>
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Autovol Logo */}
                                <img 
                                    src={AUTOVOL_LOGO}
                                    alt="Autovol Volumetric Modular" 
                                    style={{height: '45px', width: 'auto'}}
                                />
                                <div className="border-l pl-4" style={{borderColor: 'var(--autovol-teal)'}}>
                                    <h1 className="text-lg font-bold" style={{color: 'var(--autovol-navy)'}}>Modular Operations Dashboard</h1>
                                    <p className="text-xs" style={{color: 'var(--autovol-teal)'}}>MODA</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {/* Theme Toggle */}
                                <button 
                                    onClick={() => setDarkMode(prev => !prev)}
                                    className="theme-toggle"
                                    title={`Switch to ${darkMode ? 'light' : 'dark'} mode (Ctrl+D)`}
                                >
                                    {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                </button>
                                {/* Keyboard Shortcuts Help */}
                                <button 
                                    onClick={() => setShowShortcutsHelp(true)}
                                    className="theme-toggle"
                                    title="Keyboard shortcuts (?)"
                                >
                                    ‚å®Ô∏è
                                </button>
                                {auth.isAdmin && (
                                    <button 
                                        onClick={() => setShowDataManagement(true)}
                                        className="px-3 py-1.5 text-sm rounded-lg border border-gray-300 hover:bg-gray-100 transition flex items-center gap-1"
                                        title="Data Management"
                                    >
                                        <span>‚öô</span> Data
                                    </button>
                                )}
                                <div className="text-right">
                                    <p className="text-sm font-medium" style={{color: 'var(--autovol-navy)'}}>{auth.currentUser?.name || 'User'}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${auth.isAdmin ? 'role-badge-admin' : 'role-badge-user'}`}>
                                        {auth.userRole?.name || auth.currentUser?.dashboardRole || 'User'}
                                    </span>
                                </div>
                                <button 
                                    onClick={auth.logout} 
                                    className="px-3 py-1.5 text-sm rounded-lg border border-gray-300 hover:bg-gray-100 transition"
                                >
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Navigation Tabs - FILTERED BY ROLE */}
                    <nav className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex gap-1">
                                {[
                                    {id: 'executive', label: 'Executive', icon: 'icon-executive'},
                                    {id: 'production', label: 'Production', icon: 'icon-production'},
                                    {id: 'projects', label: 'Projects', icon: 'icon-projects'},
                                    {id: 'people', label: 'People', icon: 'icon-people'},
                                    {id: 'qa', label: 'QA', icon: 'icon-qa'},
                                    {id: 'transport', label: 'Transport', icon: 'icon-transport'},
                                    {id: 'equipment', label: 'Tools & Equipment', icon: 'icon-equipment'},
                                    {id: 'precon', label: 'Precon', icon: 'icon-precon'},
                                    {id: 'onsite', label: 'On-Site', icon: 'icon-onsite'},
                                    {id: 'engineering', label: 'Engineering', icon: 'icon-engineering'},
                                    {id: 'automation', label: 'Automation', icon: 'icon-automation'},
                                    {id: 'tracker', label: 'Tracker', icon: 'icon-tracker'}
                                ]
                                .filter(tab => auth.visibleTabs.includes(tab.id)) // FILTER BASED ON ROLE
                                .map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => { setActiveTab(tab.id); setSelectedProject(null); }}
                                        className={`tab-button px-4 py-3 text-sm font-medium transition rounded-t-lg ${activeTab === tab.id ? 'active' : ''}`}
                                        style={activeTab === tab.id 
                                            ? {backgroundColor: 'var(--autovol-red)', color: 'white'} 
                                            : {color: 'var(--autovol-navy)'}}
                                    >
                                        <span className={`tab-icon ${tab.icon}`}></span>
                                        {tab.label}
                                    </button>
                                ))}
                                {/* ADMIN TAB - ONLY VISIBLE WITH canAccessAdmin */}
                                {auth.canAccessAdmin && (
                                    <button
                                        key="admin"
                                        onClick={() => { setActiveTab('admin'); setSelectedProject(null); }}
                                        className={`tab-button px-4 py-3 text-sm font-medium transition rounded-t-lg ml-auto ${activeTab === 'admin' ? 'active' : ''}`}
                                        style={activeTab === 'admin' 
                                            ? {backgroundColor: 'var(--autovol-navy)', color: 'white'} 
                                            : {backgroundColor: 'var(--autovol-gray-bg)', color: 'var(--autovol-navy)'}}
                                    >
                                        <span className="tab-icon icon-admin"></span>
                                        Admin
                                    </button>
                                )}
                            </div>
                        </div>
                    </nav>
                    

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {activeTab === 'production' && !selectedProject && (
                            <ProductionDashboard 
                                projects={projects}
                                setProjects={setProjects}
                                departmentStatus={departmentStatus}
                                onSelectProject={setSelectedProject}
                                auth={auth}
                            />
                        )}
                        
                        {activeTab === 'projects' && !selectedProject && (
                            <ProjectsDirectory 
                                projects={projects}
                                setProjects={setProjects}
                                trashedProjects={trashedProjects}
                                setTrashedProjects={setTrashedProjects}
                                onSelectProject={setSelectedProject}
                                showNewProjectModal={() => setShowProjectModal(true)}
                                auth={auth}
                                exportData={exportData}
                                importData={importData}
                            />
                        )}

                        {activeTab === 'people' && (
                            <PeopleModule 
                                employees={employees}
                                setEmployees={setEmployees}
                                departments={departments}
                                setDepartments={setDepartments}
                                productionStages={productionStages}
                                isAdmin={auth.isAdmin}
                            />
                        )}


                        {activeTab === 'qa' && (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">‚úÖ</div>
                                <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>QA Module</h2>
                                <p className="text-gray-600">Coming soon - Module integration pending</p>
                            </div>
                        )}

                        {activeTab === 'transport' && (
                            <div className="bg-white rounded-lg shadow-sm">
                                <TransportApp canEdit={auth.canEditTab('transport')} />
                            </div>
                        )}

                        {activeTab === 'equipment' && (
                            <div className="bg-white rounded-lg shadow-sm">
                                <EquipmentApp />
                            </div>
                        )}

                        {activeTab === 'precon' && (
                            <PreconModule projects={projects} employees={employees} />
                        )}

                        {activeTab === 'onsite' && (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">üèóÔ∏è</div>
                                <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>On-Site Services Module</h2>
                                <p className="text-gray-600">Coming soon - Module integration pending</p>
                            </div>
                        )}

                        {activeTab === 'engineering' && (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">üìã¬ê</div>
                                <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>Engineering Module</h2>
                                <p className="text-gray-600">Coming soon - Module integration pending</p>
                            </div>
                        )}

                        {activeTab === 'automation' && (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">ü§ñ</div>
                                <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>Automation Module</h2>
                                <p className="text-gray-600">Coming soon - Module integration pending</p>
                            </div>
                        )}

                        {activeTab === 'tracker' && (
                            <ModuleTrackerPanel projects={projects} />
                        )}

                        
                        {activeTab === 'admin' && auth.canAccessAdmin && (
                            <DashboardRoleManager auth={auth} />
                        )}

                        {activeTab === 'admin' && !auth.canAccessAdmin && (
                            <div className="text-center py-20">
                                <div className="text-6xl mb-4">üîí</div>
                                <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>Access Denied</h2>
                                <p className="text-gray-600">You don't have permission to access this area</p>
                            </div>
                        )}


                        {selectedProject && (
                            <ProjectDetail 
                                project={projects.find(p => p.id === selectedProject.id) || selectedProject}
                                projects={projects}
                                setProjects={setProjects}
                                onBack={() => setSelectedProject(null)}
                                viewMode={viewMode}
                                setViewMode={setViewMode}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                stageFilter={stageFilter}
                                setStageFilter={setStageFilter}
                            />
                        )}
                    </main>

                    {/* New Project Modal */}
                    {showProjectModal && (
                        <NewProjectModal 
                            onClose={() => setShowProjectModal(false)}
                            onSave={(project) => {
                                setProjects([...projects, { ...project, id: Date.now(), modules: [], createdAt: new Date().toISOString() }]);
                                setShowProjectModal(false);
                            }}
                        />
                    )}

                    {/* Data Management Panel (Admin Only) */}
                    {showDataManagement && auth.isAdmin && (
                        <DataManagementPanel
                            onClose={() => setShowDataManagement(false)}
                            projects={projects}
                            setProjects={setProjects}
                            trashedProjects={trashedProjects}
                            setTrashedProjects={setTrashedProjects}
                            employees={employees}
                            setEmployees={setEmployees}
                            trashedEmployees={trashedEmployees}
                            setTrashedEmployees={setTrashedEmployees}
                            exportData={exportData}
                            importData={importData}
                        />
                    )}

                    {/* Keyboard Shortcuts Help Modal */}
                    {showShortcutsHelp && (
                        <div className="shortcuts-modal-overlay" onClick={() => setShowShortcutsHelp(false)}>
                            <div className="shortcuts-modal" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold" style={{color: 'var(--autovol-navy)'}}>Keyboard Shortcuts</h2>
                                    <button 
                                        onClick={() => setShowShortcutsHelp(false)}
                                        className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    >
                                        √ó
                                    </button>
                                </div>
                                
                                <div className="mb-4">
                                    <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">Navigation</h3>
                                    <div className="shortcut-row">
                                        <span>Go to tab 1-9</span>
                                        <span className="shortcut-key"><kbd>1</kbd> - <kbd>9</kbd></span>
                                    </div>
                                    <div className="shortcut-row">
                                        <span>Close modal / Go back</span>
                                        <span className="shortcut-key"><kbd>Esc</kbd></span>
                                    </div>
                                </div>
                                
                                <div className="mb-4">
                                    <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">Actions</h3>
                                    <div className="shortcut-row">
                                        <span>Toggle dark mode</span>
                                        <span className="shortcut-key"><kbd>Ctrl</kbd> + <kbd>D</kbd></span>
                                    </div>
                                    <div className="shortcut-row">
                                        <span>Focus search (Projects tab)</span>
                                        <span className="shortcut-key"><kbd>Ctrl</kbd> + <kbd>F</kbd></span>
                                    </div>
                                    {auth.isAdmin && (
                                        <div className="shortcut-row">
                                            <span>Export data backup</span>
                                            <span className="shortcut-key"><kbd>Ctrl</kbd> + <kbd>E</kbd></span>
                                        </div>
                                    )}
                                </div>
                                
                                <div>
                                    <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">Help</h3>
                                    <div className="shortcut-row">
                                        <span>Show this help</span>
                                        <span className="shortcut-key"><kbd>?</kbd></span>
                                    </div>
                                </div>
                                
                                <div className="mt-6 pt-4 border-t text-center">
                                    <p className="text-xs text-gray-500">
                                        Press <kbd className="bg-gray-100 px-1 rounded">Esc</kbd> to close
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ===== MODULE TRACKER PANEL =====
        // Unified lifecycle view showing all modules across all phases
        function ModuleTrackerPanel({ projects }) {
            const [unifiedModules, setUnifiedModules] = useState({});
            const [stats, setStats] = useState({ total: 0, byPhase: {} });
            const [selectedPhase, setSelectedPhase] = useState('all');
            const [selectedProject, setSelectedProject] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedModule, setSelectedModule] = useState(null);
            const [sortConfig, setSortConfig] = useState({ key: 'serial', direction: 'asc' });
            
            // Load and sync unified modules
            useEffect(() => {
                const loadUnified = () => {
                    MODA_UNIFIED.migrateFromProjects();
                    setUnifiedModules(MODA_UNIFIED.getAll());
                    setStats(MODA_UNIFIED.getStats());
                };
                loadUnified();
                
                // Re-sync when projects change
                const interval = setInterval(loadUnified, 5000);
                return () => clearInterval(interval);
            }, [projects]);
            
            // Handle column sort
            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
            };
            
            // Sort indicator
            const SortIndicator = ({ columnKey }) => {
                if (sortConfig.key !== columnKey) return <span className="text-gray-300 ml-1">‚áÖ</span>;
                return sortConfig.direction === 'asc' 
                    ? <span className="ml-1">‚Üë</span> 
                    : <span className="ml-1">‚Üì</span>;
            };
            
            // Filter and sort modules
            const filteredModules = useMemo(() => {
                let mods = Object.values(unifiedModules);
                
                if (selectedPhase !== 'all') {
                    mods = mods.filter(m => m.currentPhase === selectedPhase);
                }
                if (selectedProject !== 'all') {
                    mods = mods.filter(m => m.projectId === selectedProject);
                }
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    mods = mods.filter(m => 
                        m.serialNumber.toLowerCase().includes(term) ||
                        m.projectName?.toLowerCase().includes(term) ||
                        m.specs.blmHitch?.toLowerCase().includes(term) ||
                        m.specs.blmRear?.toLowerCase().includes(term)
                    );
                }
                
                // Apply sorting
                const phaseOrder = ['production', 'yard', 'transport', 'onsite', 'complete'];
                mods.sort((a, b) => {
                    let comparison = 0;
                    switch (sortConfig.key) {
                        case 'serial':
                            comparison = a.serialNumber.localeCompare(b.serialNumber);
                            break;
                        case 'project':
                            comparison = (a.projectName || '').localeCompare(b.projectName || '');
                            break;
                        case 'blm':
                            const blmA = a.specs.blmHitch || a.specs.blmRear || '';
                            const blmB = b.specs.blmHitch || b.specs.blmRear || '';
                            comparison = blmA.localeCompare(blmB);
                            break;
                        case 'phase':
                            comparison = phaseOrder.indexOf(a.currentPhase) - phaseOrder.indexOf(b.currentPhase);
                            break;
                        case 'progress':
                            const progressA = Object.values(a.production?.stageProgress || {}).reduce((sum, v) => sum + v, 0);
                            const progressB = Object.values(b.production?.stageProgress || {}).reduce((sum, v) => sum + v, 0);
                            comparison = progressA - progressB;
                            break;
                        case 'updated':
                            comparison = new Date(a.updatedAt || 0) - new Date(b.updatedAt || 0);
                            break;
                        default:
                            comparison = (a.production?.buildSequence || 0) - (b.production?.buildSequence || 0);
                    }
                    return sortConfig.direction === 'asc' ? comparison : -comparison;
                });
                
                return mods;
            }, [unifiedModules, selectedPhase, selectedProject, searchTerm, sortConfig]);
            
            const phaseConfig = {
                production: { label: 'Production', icon: 'üè≠', color: '#3B82F6' },
                yard: { label: 'Yard', icon: 'üì¶', color: '#6366F1' },
                transport: { label: 'Transport', icon: 'üöõ', color: '#F59E0B' },
                onsite: { label: 'On-Site', icon: 'üèó', color: '#8B5CF6' },
                complete: { label: 'Complete', icon: '‚úÖ', color: '#10B981' }
            };
            
            const getPhaseColor = (phase) => phaseConfig[phase]?.color || '#6B7280';
            
            const getProductionProgress = (mod) => {
                const progress = mod.production?.stageProgress || {};
                const values = Object.values(progress);
                if (values.length === 0) return 0;
                return Math.round(values.reduce((a, b) => a + b, 0) / values.length);
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold" style={{color: 'var(--autovol-navy)'}}>
                                üì¶ Module Lifecycle Tracker
                            </h1>
                            <p className="text-gray-600 text-sm mt-1">
                                Unified view of all modules: Production ‚Üí Yard ‚Üí Transport ‚Üí On-Site ‚Üí Complete
                            </p>
                        </div>
                        <div className="text-right">
                            <div className="text-3xl font-bold" style={{color: 'var(--autovol-red)'}}>{stats.total}</div>
                            <div className="text-sm text-gray-500">Total Modules</div>
                        </div>
                    </div>
                    
                    {/* Phase Summary Cards */}
                    <div className="grid grid-cols-5 gap-4">
                        {Object.entries(phaseConfig).map(([phase, config]) => (
                            <button
                                key={phase}
                                onClick={() => setSelectedPhase(selectedPhase === phase ? 'all' : phase)}
                                className={`p-4 rounded-lg border-2 transition-all ${
                                    selectedPhase === phase ? 'ring-2 ring-offset-2' : ''
                                }`}
                                style={{
                                    borderColor: config.color,
                                    backgroundColor: selectedPhase === phase ? config.color + '15' : 'white'
                                }}
                            >
                                <div className="text-3xl mb-2">{config.icon}</div>
                                <div className="text-2xl font-bold" style={{color: config.color}}>
                                    {stats.byPhase?.[phase] || 0}
                                </div>
                                <div className="text-sm text-gray-600">{config.label}</div>
                            </button>
                        ))}
                    </div>
                    
                    {/* Filters */}
                    <div className="flex gap-4 items-center bg-white p-4 rounded-lg shadow">
                        <div className="flex-1">
                            <input
                                type="text"
                                placeholder="Search by serial, BLM, or project..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                        </div>
                        <select
                            value={selectedProject}
                            onChange={(e) => setSelectedProject(e.target.value)}
                            className="px-4 py-2 border rounded-lg"
                        >
                            <option value="all">All Projects</option>
                            {projects.filter(p => p.status === 'Active').map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                        <button
                            onClick={() => {
                                setSelectedPhase('all');
                                setSelectedProject('all');
                                setSearchTerm('');
                            }}
                            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                        >
                            Clear Filters
                        </button>
                    </div>
                    
                    {/* Module List */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="p-4 border-b" style={{backgroundColor: 'var(--autovol-navy)'}}>
                            <h3 className="font-semibold text-white">
                                {filteredModules.length} Module{filteredModules.length !== 1 ? 's' : ''} 
                                {selectedPhase !== 'all' && ` in ${phaseConfig[selectedPhase]?.label}`}
                            </h3>
                        </div>
                        
                        <div className="max-h-[500px] overflow-y-auto">
                            {filteredModules.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    No modules found matching your criteria
                                </div>
                            ) : (
                                <table className="w-full">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('serial')}
                                            >
                                                Serial <SortIndicator columnKey="serial" />
                                            </th>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('project')}
                                            >
                                                Project <SortIndicator columnKey="project" />
                                            </th>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('blm')}
                                            >
                                                BLM <SortIndicator columnKey="blm" />
                                            </th>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('phase')}
                                            >
                                                Phase <SortIndicator columnKey="phase" />
                                            </th>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('progress')}
                                            >
                                                Progress <SortIndicator columnKey="progress" />
                                            </th>
                                            <th 
                                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                                                onClick={() => handleSort('updated')}
                                            >
                                                Updated <SortIndicator columnKey="updated" />
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {filteredModules.map(mod => {
                                            const progress = getProductionProgress(mod);
                                            const phaseInfo = phaseConfig[mod.currentPhase];
                                            return (
                                                <tr 
                                                    key={mod.id}
                                                    className="hover:bg-gray-50 cursor-pointer"
                                                    onClick={() => setSelectedModule(mod)}
                                                >
                                                    <td className="px-4 py-3">
                                                        <span className="font-mono font-semibold">{mod.serialNumber}</span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-gray-600">
                                                        {mod.projectName || 'Unknown'}
                                                    </td>
                                                    <td className="px-4 py-3 text-sm">
                                                        {mod.specs.blmHitch || mod.specs.blmRear ? (
                                                            <span className="font-mono text-xs">
                                                                {mod.specs.blmHitch}{mod.specs.blmHitch && mod.specs.blmRear && ' / '}{mod.specs.blmRear}
                                                            </span>
                                                        ) : (
                                                            <span className="text-gray-400">-</span>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span 
                                                            className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium"
                                                            style={{backgroundColor: phaseInfo?.color + '20', color: phaseInfo?.color}}
                                                        >
                                                            {phaseInfo?.icon} {phaseInfo?.label}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                <div 
                                                                    className="h-full rounded-full transition-all"
                                                                    style={{
                                                                        width: `${progress}%`,
                                                                        backgroundColor: progress === 100 ? '#10B981' : 'var(--autovol-blue)'
                                                                    }}
                                                                />
                                                            </div>
                                                            <span className="text-xs text-gray-500">{progress}%</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3 text-xs text-gray-500">
                                                        {mod.updatedAt ? new Date(mod.updatedAt).toLocaleDateString() : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                    
                    {/* Module Detail Modal */}
                    {selectedModule && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b sticky top-0 bg-white flex items-center justify-between">
                                    <div>
                                        <h2 className="text-xl font-bold" style={{color: 'var(--autovol-navy)'}}>
                                            Module {selectedModule.serialNumber}
                                        </h2>
                                        <p className="text-sm text-gray-500">{selectedModule.projectName}</p>
                                    </div>
                                    <button 
                                        onClick={() => setSelectedModule(null)}
                                        className="p-2 hover:bg-gray-100 rounded-lg"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                <div className="p-6 space-y-6">
                                    {/* Lifecycle Progress */}
                                    <div>
                                        <h3 className="font-semibold mb-3">Lifecycle Progress</h3>
                                        <div className="flex items-center gap-2">
                                            {Object.entries(phaseConfig).map(([phase, config], idx) => (
                                                <React.Fragment key={phase}>
                                                    <div 
                                                        className={`flex-1 p-3 rounded-lg text-center ${
                                                            selectedModule.currentPhase === phase ? 'ring-2' : ''
                                                        }`}
                                                        style={{
                                                            backgroundColor: selectedModule.currentPhase === phase ? config.color + '20' : '#F3F4F6',
                                                            ringColor: config.color
                                                        }}
                                                    >
                                                        <div className="text-2xl">{config.icon}</div>
                                                        <div className="text-xs mt-1" style={{
                                                            color: selectedModule.currentPhase === phase ? config.color : '#6B7280'
                                                        }}>{config.label}</div>
                                                    </div>
                                                    {idx < 3 && (
                                                        <div className="text-gray-300">‚Üí'</div>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Specs */}
                                    <div>
                                        <h3 className="font-semibold mb-3">Specifications</h3>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div className="p-3 bg-gray-50 rounded">
                                                <div className="text-gray-500">BLM Hitch</div>
                                                <div className="font-mono">{selectedModule.specs.blmHitch || '-'}</div>
                                            </div>
                                            <div className="p-3 bg-gray-50 rounded">
                                                <div className="text-gray-500">BLM Rear</div>
                                                <div className="font-mono">{selectedModule.specs.blmRear || '-'}</div>
                                            </div>
                                            <div className="p-3 bg-gray-50 rounded">
                                                <div className="text-gray-500">Unit Type</div>
                                                <div>{selectedModule.specs.unit || '-'}</div>
                                            </div>
                                            <div className="p-3 bg-gray-50 rounded">
                                                <div className="text-gray-500">Dimensions</div>
                                                <div>
                                                    {selectedModule.specs.width && selectedModule.specs.length 
                                                        ? `${selectedModule.specs.width}' x ${selectedModule.specs.length}'`
                                                        : '-'
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Difficulties */}
                                    {Object.values(selectedModule.specs.difficulties || {}).some(v => v) && (
                                        <div>
                                            <h3 className="font-semibold mb-3">Difficulties</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {selectedModule.specs.difficulties?.sidewall && <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">Sidewall</span>}
                                                {selectedModule.specs.difficulties?.stair && <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">Stair</span>}
                                                {selectedModule.specs.difficulties?.hr3Wall && <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">3HR Wall</span>}
                                                {selectedModule.specs.difficulties?.short && <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Short</span>}
                                                {selectedModule.specs.difficulties?.doubleStudio && <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Double Studio</span>}
                                                {selectedModule.specs.difficulties?.sawbox && <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Sawbox</span>}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Production Progress */}
                                    <div>
                                        <h3 className="font-semibold mb-3">Production Stages ({getProductionProgress(selectedModule)}% Complete)</h3>
                                        <div className="grid grid-cols-3 gap-2 text-xs">
                                            {Object.entries(selectedModule.production?.stageProgress || {}).map(([stage, progress]) => (
                                                <div key={stage} className="flex items-center gap-2">
                                                    <div className="w-full">
                                                        <div className="flex justify-between text-gray-500 mb-1">
                                                            <span>{stage}</span>
                                                            <span>{progress}%</span>
                                                        </div>
                                                        <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                                            <div 
                                                                className="h-full rounded-full"
                                                                style={{
                                                                    width: `${progress}%`,
                                                                    backgroundColor: progress === 100 ? '#10B981' : progress > 0 ? '#3B82F6' : '#E5E7EB'
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* History */}
                                    <div>
                                        <h3 className="font-semibold mb-3">History</h3>
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {(selectedModule.history || []).slice().reverse().map((entry, idx) => (
                                                <div key={idx} className="flex gap-3 text-sm">
                                                    <div className="text-gray-400 text-xs w-32 flex-shrink-0">
                                                        {new Date(entry.timestamp).toLocaleString()}
                                                    </div>
                                                    <div className="text-gray-600">{entry.action}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================================================
        // ENGINEERING ISSUE CONSTANTS
        // ============================================================================
        const ENGINEERING_ISSUE_CATEGORIES = [
            { id: 'design-error', label: 'Design Error', icon: 'üìê', color: '#EF4444' },
            { id: 'dimension-issue', label: 'Dimension Issue', icon: 'üìè', color: '#F59E0B' },
            { id: 'material-spec', label: 'Material Specification', icon: 'üîß', color: '#3B82F6' },
            { id: 'structural', label: 'Structural Concern', icon: 'üèóÔ∏è', color: '#8B5CF6' },
            { id: 'mep-conflict', label: 'MEP Conflict', icon: '‚ö°', color: '#EC4899' },
            { id: 'drawing-update', label: 'Drawing Update Needed', icon: 'üìã', color: '#06B6D4' },
            { id: 'rfi', label: 'RFI (Request for Information)', icon: '‚ùì', color: '#10B981' },
            { id: 'change-order', label: 'Change Order Request', icon: 'üìù', color: '#6366F1' },
            { id: 'other', label: 'Other', icon: 'üìå', color: '#6B7280' }
        ];

        const URGENCY_LEVELS = [
            { id: 'critical', label: 'Critical - Production Stopped', color: '#DC2626', bgColor: '#FEE2E2' },
            { id: 'high', label: 'High - Blocking Progress', color: '#EA580C', bgColor: '#FFEDD5' },
            { id: 'medium', label: 'Medium - Needs Attention', color: '#CA8A04', bgColor: '#FEF9C3' },
            { id: 'low', label: 'Low - When Time Permits', color: '#16A34A', bgColor: '#DCFCE7' }
        ];

        const ENGINEERING_DEPARTMENTS = [
            'Automation', 'Auto Floor/Ceiling', 'Auto Walls', 'Mezzanine', 'Electrical',
            'Wall Set', 'Ceiling Set', 'Soffits', 'Mechanical', 'Plumbing', 'Exteriors',
            'Drywall', 'Roofing', 'Pre-Finish', 'Final Finish', 'Sign-Off', 'Close-Up',
            'QA', 'Transport', 'On-Site', 'General'
        ];

        // Production Dashboard Component - Vertical Department Workflow
        function ProductionDashboard({ projects, setProjects, departmentStatus, onSelectProject, auth }) {
            const activeProjects = projects.filter(p => p.status === 'Active');
            const [selectedProjectId, setSelectedProjectId] = useState(activeProjects[0]?.id || null);
            const [productionTab, setProductionTab] = useState('weekly-board');
            
            // Module Detail State (for Station Board "View Details" button)
            const [selectedModuleDetail, setSelectedModuleDetail] = useState(null);
            const [editMode, setEditMode] = useState(false);
            
            // Report Issue State
            const [showReportIssueModal, setShowReportIssueModal] = useState(false);
            const [reportIssueContext, setReportIssueContext] = useState(null);
            const [engineeringIssues, setEngineeringIssues] = useState(() => {
                const saved = localStorage.getItem('autovol_engineering_issues');
                return saved ? JSON.parse(saved) : [];
            });
            
            // Production weeks integration
            const { weeks, staggerConfig, staggerChangeLog, hasUnsavedStaggerChanges, addWeek, updateWeek, deleteWeek, updateStagger, saveStaggerChanges, revertToStaggerConfig, resetToDefaultStaggers, validateWeek, getCurrentWeek } = useProductionWeeks();
            const currentWeek = getCurrentWeek();
            
            // Weekly schedule integration (from WeeklyBoard.jsx)
            const weeklySchedule = window.WeeklyBoardComponents?.useWeeklySchedule?.() || {
                scheduleSetup: { shift1: { monday: 5, tuesday: 5, wednesday: 5, thursday: 5 }, shift2: { friday: 0, saturday: 0, sunday: 0 } },
                completedWeeks: [],
                updateShiftSchedule: () => {},
                getShiftTotal: () => 0,
                getLineBalance: () => 20,
                completeWeek: () => {},
                getCompletedWeek: () => null,
                getRecentWeeks: () => [],
                deleteCompletedWeek: () => {}
            };
            
            // Save engineering issues to localStorage
            useEffect(() => {
                localStorage.setItem('autovol_engineering_issues', JSON.stringify(engineeringIssues));
            }, [engineeringIssues]);
            
            // Open report issue modal with context
            const openReportIssue = (module, station) => {
                setReportIssueContext({ module, station, project: selectedProject });
                setShowReportIssueModal(true);
            };
            
            // Handle issue submission
            const handleSubmitIssue = (issueData) => {
                const newIssue = {
                    id: `ENG-${Date.now()}`,
                    ...issueData,
                    status: 'open',
                    createdAt: new Date().toISOString(),
                    history: [{
                        action: 'Issue Created',
                        timestamp: new Date().toISOString(),
                        by: issueData.reportedBy
                    }]
                };
                setEngineeringIssues(prev => [newIssue, ...prev]);
                setShowReportIssueModal(false);
                setReportIssueContext(null);
            };
            
            const selectedProject = projects.find(p => p.id === selectedProjectId);
            const modules = selectedProject?.modules || [];
            
            // Sort modules by build sequence (lower = further along)
            const sortedModules = [...modules].sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
            
            // Categorize modules
            const categorizeModules = () => {
                const scheduled = []; // Not yet in Automation
                const inProduction = []; // Automation through Sign-Off
                const allComplete = []; // Completed Close-Up (all of them)
                
                sortedModules.forEach(module => {
                    const progress = module.stageProgress || {};
                    const autoProgress = Math.max(progress['auto-fc'] || 0, progress['auto-walls'] || 0);
                    const closeUpProgress = progress['close-up'] || 0;
                    
                    if (closeUpProgress === 100) {
                        // Include close-up completion timestamp if available
                        const completedAt = module.stationCompletedAt?.['close-up'] || 0;
                        allComplete.push({ ...module, completedAt });
                    } else if (autoProgress > 0) {
                        inProduction.push(module);
                    } else {
                        scheduled.push(module);
                    }
                });
                
                // Limit to 5 most recently completed (by completion timestamp)
                // For modules without timestamps (legacy), use build sequence as fallback
                const complete = allComplete
                    .sort((a, b) => {
                        if (a.completedAt && b.completedAt) return b.completedAt - a.completedAt;
                        if (a.completedAt && !b.completedAt) return -1;
                        if (!a.completedAt && b.completedAt) return 1;
                        return (b.buildSequence || 0) - (a.buildSequence || 0);
                    })
                    .slice(0, 5)
                    .reverse();  // Oldest at top, newest at bottom
                
                return { scheduled, inProduction, complete };
            };
            

            // Update module progress for a specific station
            const updateModuleProgress = (moduleId, stationId, newProgress) => {
                setProjects(prevProjects => prevProjects.map(project => {
                    if (project.id !== selectedProjectId) return project;
                    
                    return {
                        ...project,
                        modules: project.modules.map(module => {
                            if (module.id !== moduleId) return module;
                            
                            const updatedProgress = { ...module.stageProgress };
                            const wasComplete = updatedProgress[stationId] === 100;
                            updatedProgress[stationId] = newProgress;
                            
                            // Track completion timestamps per station
                            let stationCompletedAt = module.stationCompletedAt || {};
                            if (newProgress === 100 && !wasComplete) {
                                // Just marked complete - record timestamp
                                stationCompletedAt = { ...stationCompletedAt, [stationId]: Date.now() };
                            } else if (newProgress < 100 && wasComplete) {
                                // Reverted from complete - remove timestamp
                                stationCompletedAt = { ...stationCompletedAt };
                                delete stationCompletedAt[stationId];
                            }
                            
                            return { ...module, stageProgress: updatedProgress, stationCompletedAt };
                        })
                    };
                }));
            };
            
            const { scheduled, inProduction, complete } = categorizeModules();
            
         
            return (
                <div className="space-y-4">
                    {/* Header */}
                    <div className="flex items-center justify-between flex-wrap gap-4">
                        <h2 className="text-2xl font-bold text-autovol-navy">Production Dashboard</h2>
                        <div className="flex items-center gap-4">
                            {activeProjects.length > 0 && (
                                <select 
                                    value={selectedProjectId || ''}
                                    onChange={(e) => setSelectedProjectId(e.target.value)}
                                    className="border rounded px-3 py-2 font-medium"
                                >
                                    {activeProjects.map(p => (
                                        <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                </select>
                            )}
                        </div>
                    </div>
                    
                    {activeProjects.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-8 text-center">
                            <p className="text-gray-500">No active projects. Go to Projects tab to create one and set status to Active.</p>
                        </div>
                    ) : !selectedProject ? (
                        <div className="bg-white rounded-lg shadow p-8 text-center">
                            <p className="text-gray-500">Select a project to view production.</p>
                        </div>
                    ) : (
                        <>
                            {/* Sub-tabs */}
                            <div className="bg-white rounded-lg shadow">
                                <div className="border-b flex overflow-x-auto">
                                    {[
                                        { id: 'weekly-board', label: 'Weekly Board' },
                                        { id: 'module-status', label: 'Module Status' },
                                        { id: 'staggers', label: 'Station Stagger' },
                                        { id: 'schedule-setup', label: 'Schedule Setup' }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setProductionTab(tab.id)}
                                            className={`px-6 py-3 text-sm font-medium transition ${
                                                productionTab === tab.id
                                                    ? 'text-autovol-teal border-b-2 border-autovol-teal'
                                                    : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Tab Content */}
                                <div className="p-4">
                                    
                                    
                                    {productionTab === 'module-status' && (
                                        <div className="space-y-6">
                                            {/* Scheduled */}
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <span className="w-3 h-3 rounded-full bg-gray-400"></span>
                                                    Scheduled ({scheduled.length})
                                                    <span className="font-normal text-sm text-gray-500">‚Äì Not yet in Automation</span>
                                                </h3>
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2">
                                                    {scheduled.slice(0, 24).map(module => (
                                                        <div key={module.id} className="border rounded p-2 text-center bg-gray-50">
                                                            <div className="font-mono text-xs font-bold text-gray-600">
                                                                {module.serialNumber?.slice(-4)}
                                                            </div>
                                                            <div className="text-xs text-gray-400">#{module.buildSequence}</div>
                                                        </div>
                                                    ))}
                                                    {scheduled.length > 24 && (
                                                        <div className="border rounded p-2 text-center bg-gray-100 text-gray-500 text-xs">
                                                            +{scheduled.length - 24} more
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* In Production */}
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <span className="w-3 h-3 rounded-full bg-autovol-teal"></span>
                                                    In Production ({inProduction.length})
                                                    <span className="font-normal text-sm text-gray-500">‚Äì Automation through Sign-Off</span>
                                                </h3>
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2">
                                                    {inProduction.map(module => (
                                                        <div key={module.id} className="border rounded p-2 text-center bg-teal-50 border-autovol-teal">
                                                            <div className="font-mono text-xs font-bold text-gray-800">
                                                                {module.serialNumber?.slice(-4)}
                                                            </div>
                                                            <div className="text-xs text-gray-500">#{module.buildSequence}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Complete */}
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <span className="w-3 h-3 rounded-full bg-green-500"></span>
                                                    Recently Complete ({complete.length})
                                                    <span className="font-normal text-sm text-gray-500">‚Äì Last 5 finished Close-Up</span>
                                                </h3>
                                                <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2">
                                                    {complete.map(module => (
                                                        <div key={module.id} className="border rounded p-2 text-center bg-green-50 border-green-500">
                                                            <div className="font-mono text-xs font-bold text-gray-800">
                                                                {module.serialNumber?.slice(-4)}
                                                            </div>
                                                            <div className="text-xs text-gray-500">#{module.buildSequence}</div>
                                                        </div>
                                                    ))}
                                                    {complete.length === 0 && (
                                                        <div className="text-sm text-gray-400 col-span-full">No completed modules yet</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {productionTab === 'staggers' && (
                                        <StaggerConfigTab 
                                            productionStages={productionStages}
                                            stationGroups={stationGroups}
                                            staggerConfig={staggerConfig}
                                            staggerChangeLog={staggerChangeLog}
                                            hasUnsavedStaggerChanges={hasUnsavedStaggerChanges}
                                            updateStagger={updateStagger}
                                            saveStaggerChanges={saveStaggerChanges}
                                            revertToStaggerConfig={revertToStaggerConfig}
                                            resetToDefaultStaggers={resetToDefaultStaggers}
                                            currentUser={auth.currentUser}
                                            isAdmin={auth.isAdmin}
                                        />
                                    )}
                                    
                                    {productionTab === 'weekly-board' && (
                                        window.WeeklyBoardComponents?.WeeklyBoardTab ? (
                                            <window.WeeklyBoardComponents.WeeklyBoardTab
                                                projects={projects}
                                                productionStages={productionStages}
                                                staggerConfig={staggerConfig}
                                                currentWeek={currentWeek}
                                                weeks={weeks}
                                                scheduleSetup={weeklySchedule.scheduleSetup}
                                                getLineBalance={weeklySchedule.getLineBalance}
                                                completedWeeks={weeklySchedule.completedWeeks}
                                                completeWeek={weeklySchedule.completeWeek}
                                                addWeek={addWeek}
                                                onModuleClick={setSelectedModuleDetail}
                                                setProductionTab={setProductionTab}
                                                setProjects={setProjects}
                                                canEdit={auth.canEditTab('production')}
                                                onReportIssue={(module, station) => {
                                                    setReportIssueContext({ module, station, project: selectedProject });
                                                    setShowReportIssueModal(true);
                                                }}
                                            />
                                        ) : (
                                            <div className="text-center py-8 text-gray-500">
                                                <p>Weekly Board component loading...</p>
                                                <p className="text-sm mt-2">If this persists, check that WeeklyBoard.jsx is loaded.</p>
                                            </div>
                                        )
                                    )}
                                    
                                    {productionTab === 'schedule-setup' && (
                                        window.WeeklyBoardComponents?.ScheduleSetupTab ? (
                                            <window.WeeklyBoardComponents.ScheduleSetupTab
                                                scheduleSetup={weeklySchedule.scheduleSetup}
                                                updateShiftSchedule={weeklySchedule.updateShiftSchedule}
                                                getShiftTotal={weeklySchedule.getShiftTotal}
                                                getLineBalance={weeklySchedule.getLineBalance}
                                                weeks={weeks}
                                                currentWeek={currentWeek}
                                                addWeek={addWeek}
                                                updateWeek={updateWeek}
                                                deleteWeek={deleteWeek}
                                                validateWeek={validateWeek}
                                                allModules={activeProjects.flatMap(p => (p.modules || []).map(m => ({ ...m, projectId: p.id, projectName: p.name })))}
                                                projects={projects}
                                                setProjects={setProjects}
                                                canEdit={auth.canEditTab('production')}
                                            />
                                        ) : (
                                            <div className="text-center py-8 text-gray-500">
                                                <p>Schedule Setup component loading...</p>
                                                <p className="text-sm mt-2">If this persists, check that WeeklyBoard.jsx is loaded.</p>
                                            </div>
                                        )
                                    )}
                                </div>
                            </div>
                        </>
                    )}
                    
                    {/* Report Issue Modal */}
                    {showReportIssueModal && reportIssueContext && (
                        <ReportIssueModal
                            context={reportIssueContext}
                            onSubmit={handleSubmitIssue}
                            onClose={() => {
                                setShowReportIssueModal(false);
                                setReportIssueContext(null);
                            }}
                        />
                    )}
                    
                    {/* Module Detail Modal (for Station Board "View Details" button) */}
                    {selectedModuleDetail && (
                        <ModuleDetailModal 
                            module={selectedModuleDetail}
                            project={selectedProject}
                            projects={projects}
                            setProjects={setProjects}
                            onClose={() => { setSelectedModuleDetail(null); setEditMode(false); }}
                            editMode={editMode}
                            setEditMode={setEditMode}
                        />
                    )}
                </div>
            );
        }

        // ============================================================================
        // REPORT ISSUE MODAL COMPONENT
        // ============================================================================
        function ReportIssueModal({ context, onSubmit, onClose }) {
            const { module, station, project } = context;
            const fileInputRef = useRef(null);
            const [formData, setFormData] = useState({
                title: '',
                category: '',
                urgency: 'medium',
                department: station?.name || '',
                moduleSerial: module?.serialNumber || '',
                projectName: project?.name || '',
                description: '',
                reportedBy: '',
                contactPhone: '',
                location: station?.name || '',
                photos: []
            });
            const [photoPreview, setPhotoPreview] = useState([]);

            const handlePhotoCapture = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setPhotoPreview(prev => [...prev, event.target.result]);
                        setFormData(prev => ({
                            ...prev,
                            photos: [...prev.photos, {
                                data: event.target.result,
                                name: file.name,
                                timestamp: new Date().toISOString()
                            }]
                        }));
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removePhoto = (index) => {
                setPhotoPreview(prev => prev.filter((_, i) => i !== index));
                setFormData(prev => ({
                    ...prev,
                    photos: prev.photos.filter((_, i) => i !== index)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.title || !formData.category || !formData.reportedBy) {
                    alert('Please fill in Title, Category, and Your Name');
                    return;
                }
                onSubmit(formData);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="p-4 border-b sticky top-0 bg-white z-10" style={{borderTopColor: 'var(--autovol-red)', borderTopWidth: '4px'}}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-xl font-bold" style={{color: 'var(--autovol-navy)'}}>
                                        ‚ö†Ô∏è Report Issue to Engineering
                                    </h2>
                                    <p className="text-sm text-gray-500 mt-1">
                                        Module: <span className="font-mono font-semibold">{module?.serialNumber}</span>
                                        {station && <> ‚Ä¢ Station: <span className="font-semibold">{station.name}</span></>}
                                    </p>
                                </div>
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg text-2xl">√ó</button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="p-6 space-y-5">
                            {/* Issue Title */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">
                                    Issue Title <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    placeholder="Brief description of the issue"
                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            {/* Category Selection */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Issue Category <span className="text-red-500">*</span>
                                </label>
                                <div className="grid grid-cols-3 gap-2">
                                    {ENGINEERING_ISSUE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            onClick={() => setFormData({...formData, category: cat.id})}
                                            className={`p-2 rounded-lg border-2 text-left transition text-sm ${
                                                formData.category === cat.id 
                                                    ? 'border-blue-500 bg-blue-50' 
                                                    : 'border-gray-200 hover:border-gray-300'
                                            }`}
                                        >
                                            <span className="mr-1">{cat.icon}</span>
                                            <span className="font-medium">{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Urgency Level */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Urgency Level <span className="text-red-500">*</span>
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    {URGENCY_LEVELS.map(u => (
                                        <button
                                            key={u.id}
                                            type="button"
                                            onClick={() => setFormData({...formData, urgency: u.id})}
                                            className={`p-2 rounded-lg border-2 text-left transition text-sm ${
                                                formData.urgency === u.id ? 'ring-2 ring-offset-1' : ''
                                            }`}
                                            style={{
                                                borderColor: u.color,
                                                backgroundColor: formData.urgency === u.id ? u.bgColor : 'white'
                                            }}
                                        >
                                            <span className="font-medium" style={{color: u.color}}>{u.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Department & Location */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                    <select
                                        value={formData.department}
                                        onChange={(e) => setFormData({...formData, department: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg"
                                    >
                                        <option value="">Select department...</option>
                                        {ENGINEERING_DEPARTMENTS.map(dept => (
                                            <option key={dept} value={dept}>{dept}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Location/Station</label>
                                    <input
                                        type="text"
                                        value={formData.location}
                                        onChange={(e) => setFormData({...formData, location: e.target.value})}
                                        placeholder="e.g., Station 5, Bay 3"
                                        className="w-full px-3 py-2 border rounded-lg"
                                    />
                                </div>
                            </div>

                            {/* Description */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Detailed Description</label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Describe the issue in detail..."
                                    rows={3}
                                    className="w-full px-3 py-2 border rounded-lg"
                                />
                            </div>

                            {/* Photo Capture */}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Photos (Optional)</label>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    multiple
                                    capture="environment"
                                    onChange={handlePhotoCapture}
                                    className="hidden"
                                />
                                <button
                                    type="button"
                                    onClick={() => fileInputRef.current?.click()}
                                    className="px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-gray-400 hover:bg-gray-50 w-full"
                                >
                                    üì∑ Add Photos
                                </button>
                                {photoPreview.length > 0 && (
                                    <div className="flex gap-2 mt-2 flex-wrap">
                                        {photoPreview.map((src, idx) => (
                                            <div key={idx} className="relative">
                                                <img src={src} alt={`Photo ${idx + 1}`} className="w-20 h-20 object-cover rounded-lg" />
                                                <button
                                                    type="button"
                                                    onClick={() => removePhoto(idx)}
                                                    className="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Reporter Info */}
                            <div className="border-t pt-4">
                                <h3 className="font-semibold text-gray-700 mb-3">Your Information</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Your Name <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.reportedBy}
                                            onChange={(e) => setFormData({...formData, reportedBy: e.target.value})}
                                            placeholder="Full name"
                                            className="w-full px-3 py-2 border rounded-lg"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input
                                            type="tel"
                                            value={formData.contactPhone}
                                            onChange={(e) => setFormData({...formData, contactPhone: e.target.value})}
                                            placeholder="(555) 123-4567"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Submit Buttons */}
                            <div className="flex gap-3 pt-4 border-t">
                                <button type="button" onClick={onClose} className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button type="submit" className="flex-1 px-4 py-2 text-white rounded-lg font-medium" style={{backgroundColor: 'var(--autovol-red)'}}>
                                    üìã Submit Issue
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Projects Directory Component
        function ProjectsDirectory({ projects, setProjects, trashedProjects, setTrashedProjects, onSelectProject, showNewProjectModal, auth, exportData, importData }) {
            const [statusFilter, setStatusFilter] = useState('all');
            const [editMode, setEditMode] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            
            const filteredProjects = projects.filter(p => 
                statusFilter === 'all' || p.status === statusFilter
            );

            const statusCounts = {
                'Pre-Construction': projects.filter(p => p.status === 'Pre-Construction').length,
                'Planned': projects.filter(p => p.status === 'Planned').length,
                'Active': projects.filter(p => p.status === 'Active').length,
                'Complete': projects.filter(p => p.status === 'Complete').length
            };

            // Move to trash instead of permanent delete
            const handleDeleteProject = (project) => {
                const trashedProject = {
                    ...project,
                    deletedAt: Date.now(),
                    deletedBy: auth.currentUser?.name || 'Unknown'
                };
                setTrashedProjects([...trashedProjects, trashedProject]);
                setProjects(projects.filter(p => p.id !== project.id));
                setDeleteConfirm(null);
            };

            const handleUpdateProject = (updatedProject) => {
                setProjects(projects.map(p => p.id === updatedProject.id ? { ...p, ...updatedProject } : p));
                setEditingProject(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-autovol-navy">Project Directory</h2>
                        <div className="flex items-center gap-2">
                            {auth.isAdmin && (
                                <button
                                    onClick={() => setEditMode(!editMode)}
                                    className={`px-4 py-2 rounded-lg transition flex items-center gap-2 ${
                                        editMode 
                                            ? 'bg-gray-800 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    {editMode ? '‚úì Done Editing' : '‚úé Edit Projects'}
                                </button>
                            )}
                            <button
                                onClick={showNewProjectModal}
                                className="px-4 py-2 btn-primary rounded-lg transition flex items-center gap-2"
                            >
                                <span>+</span> New Project
                            </button>
                        </div>
                    </div>

                    {/* Status Filter Pills */}
                    <div className="flex gap-2 flex-wrap">
                        <button
                            onClick={() => setStatusFilter('all')}
                            className={`px-3 py-1 rounded-full text-sm ${statusFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                            All ({projects.length})
                        </button>
                        {Object.entries(statusCounts).map(([status, count]) => (
                            <button
                                key={status}
                                onClick={() => setStatusFilter(status)}
                                className={`px-3 py-1 rounded-full text-sm ${statusFilter === status ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                            >
                                {status} ({count})
                            </button>
                        ))}
                    </div>

                    {/* Project Cards */}
                    <div className="grid gap-4">
                        {filteredProjects.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-500">No projects found. Click "New Project" to create one.</p>
                            </div>
                        ) : (
                            filteredProjects.map(project => (
                                <div 
                                    key={project.id}
                                    className={`bg-white rounded-lg shadow p-4 transition ${!editMode ? 'hover:shadow-md cursor-pointer' : ''}`}
                                    onClick={() => !editMode && onSelectProject(project)}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-900">{project.name}</h3>
                                            <p className="text-sm text-gray-500">{project.location}</p>
                                            {project.description && (
                                                <p className="text-sm text-gray-600 mt-1">{project.description}</p>
                                            )}
                                            <div className="flex items-center gap-2 mt-2">
                                                <span className={`px-2 py-0.5 text-xs rounded ${
                                                    project.status === 'Active' ? 'bg-green-100 text-green-800' :
                                                    project.status === 'Complete' ? 'bg-gray-100 text-gray-800' :
                                                    project.status === 'Planned' ? 'bg-blue-100 text-blue-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                    {project.status}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className="text-sm text-gray-600">{project.modules?.length || 0} modules</span>
                                            {editMode && (
                                                <div className="flex gap-2 ml-4">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setEditingProject(project); }}
                                                        className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm font-medium"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setDeleteConfirm(project); }}
                                                        className="px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm font-medium"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* Edit Project Modal */}
                    {editingProject && (
                        <EditProjectModal
                            project={editingProject}
                            onClose={() => setEditingProject(null)}
                            onSave={handleUpdateProject}
                        />
                    )}

                    {/* Delete Confirmation Modal */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setDeleteConfirm(null)}>
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-gray-900 mb-4">Move to Trash?</h2>
                                <p className="text-gray-600 mb-2">
                                    Are you sure you want to delete <strong>{deleteConfirm.name}</strong>?
                                </p>
                                {deleteConfirm.modules?.length > 0 && (
                                    <p className="text-orange-600 text-sm mb-4">
                                        ‚ö† This project has {deleteConfirm.modules.length} modules that will also be moved to trash.
                                    </p>
                                )}
                                <p className="text-sm text-gray-500 mb-6">
                                    ‚úì This project will be moved to Trash and can be restored within 90 days from the Data Management panel.
                                </p>
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => setDeleteConfirm(null)}
                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => handleDeleteProject(deleteConfirm)}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                    >
                                        Move to Trash
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Edit Project Modal
        function EditProjectModal({ project, onClose, onSave }) {
            const [name, setName] = useState(project.name || '');
            const [location, setLocation] = useState(project.location || '');
            const [description, setDescription] = useState(project.description || '');
            const [status, setStatus] = useState(project.status || 'Pre-Construction');
            const [sharepointSite, setSharepointSite] = useState(project.sharepointSite || 'ProductDevelopmentAutovolPrefab');
            const [sharepointChannel, setSharepointChannel] = useState(project.sharepointChannel || '');
            
            // Shop Drawing Links state - convert existing links object to text format
            const existingLinksText = Object.entries(project.shopDrawingLinks || {})
                .map(([blm, url]) => `${blm}, ${url}`)
                .join('\n');
            const [shopDrawingLinksText, setShopDrawingLinksText] = useState(existingLinksText);
            const [shopDrawingLinksError, setShopDrawingLinksError] = useState('');
            const [parsedLinksCount, setParsedLinksCount] = useState(Object.keys(project.shopDrawingLinks || {}).length);
            
            // Parse shop drawing links from text input
            const parseShopDrawingLinks = (text) => {
                const links = {};
                const lines = text.split('\n').filter(line => line.trim());
                let errorMsg = '';
                
                for (const line of lines) {
                    const parts = line.split(/[,\t]/).map(p => p.trim());
                    if (parts.length >= 2) {
                        const blm = parts[0];
                        const url = parts[1];
                        if (blm && url && url.startsWith('http')) {
                            links[blm] = url;
                        } else if (blm && url && !url.startsWith('http')) {
                            errorMsg = `Invalid URL for BLM "${blm}"`;
                        }
                    }
                }
                
                setShopDrawingLinksError(errorMsg);
                setParsedLinksCount(Object.keys(links).length);
                return links;
            };
            
            const handleLinksTextChange = (text) => {
                setShopDrawingLinksText(text);
                parseShopDrawingLinks(text);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                onSave({ 
                    ...project, 
                    name: name.trim(), 
                    location: location.trim(), 
                    description: description.trim(), 
                    status, 
                    sharepointSite: sharepointSite.trim(), 
                    sharepointChannel: sharepointChannel.trim(),
                    shopDrawingLinks: parseShopDrawingLinks(shopDrawingLinksText)
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold">Edit Project</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Project Name *</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        placeholder="e.g., Building A - Phoenix"
                                        className="w-full px-3 py-2 border rounded-lg"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input
                                        type="text"
                                        value={location}
                                        onChange={(e) => setLocation(e.target.value)}
                                        placeholder="e.g., Phoenix, AZ"
                                        className="w-full px-3 py-2 border rounded-lg"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        placeholder="Brief project description..."
                                        className="w-full px-3 py-2 border rounded-lg"
                                        rows={3}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select
                                        value={status}
                                        onChange={(e) => setStatus(e.target.value)}
                                        className="w-full px-3 py-2 border rounded-lg"
                                    >
                                        <option value="Pre-Construction">Pre-Construction</option>
                                        <option value="Planned">Planned</option>
                                        <option value="Active">Active</option>
                                        <option value="Complete">Complete</option>
                                    </select>
                                </div>
                                
                                {/* SharePoint Integration */}
                                <div className="border-t pt-4 mt-4">
                                    <h3 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <span>üìã¬Å</span> SharePoint Integration
                                        <span className="text-xs font-normal text-gray-500">(for Shop Drawings)</span>
                                    </h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">SharePoint Site</label>
                                            <input
                                                type="text"
                                                value={sharepointSite}
                                                onChange={(e) => setSharepointSite(e.target.value)}
                                                placeholder="e.g., ProductDevelopmentAutovolPrefab"
                                                className="w-full px-3 py-2 border rounded-lg text-sm"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Site name from SharePoint URL</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Teams Channel Folder</label>
                                            <input
                                                type="text"
                                                value={sharepointChannel}
                                                onChange={(e) => setSharepointChannel(e.target.value)}
                                                placeholder="e.g., Alvarado Creek - San Diego, CA (TPC)"
                                                className="w-full px-3 py-2 border rounded-lg text-sm"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Exact channel name from Teams</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Shop Drawing Links */}
                                <div className="border-t pt-4 mt-4">
                                    <h3 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <span>üìê</span> Shop Drawing Links
                                    </h3>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">BLM / URL Mapping</label>
                                        <textarea
                                            value={shopDrawingLinksText}
                                            onChange={(e) => handleLinksTextChange(e.target.value)}
                                            placeholder="B1L2M39, https://sharepoint.com/..."
                                            rows={5}
                                            className="w-full px-3 py-2 border rounded-lg text-sm font-mono"
                                        />
                                        <div className="flex justify-between mt-1">
                                            <p className="text-xs text-gray-500">Format: BLM, URL (one per line)</p>
                                            {parsedLinksCount > 0 && (
                                                <p className="text-xs text-green-600 font-medium">{parsedLinksCount} links</p>
                                            )}
                                        </div>
                                        {shopDrawingLinksError && (
                                            <p className="text-xs text-red-600 mt-1">{shopDrawingLinksError}</p>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 justify-end pt-4">
                                    <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                        Cancel
                                    </button>
                                    <button type="submit" className="px-4 py-2 btn-primary rounded-lg">
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Data Management Panel (Admin Only)
        function DataManagementPanel({ onClose, projects, setProjects, trashedProjects, setTrashedProjects, employees, setEmployees, trashedEmployees, setTrashedEmployees, exportData, importData }) {
            const [activeTab, setActiveTab] = useState('trash');
            const [trashTab, setTrashTab] = useState('projects');
            const [confirmEmpty, setConfirmEmpty] = useState(false);

            const formatDate = (timestamp) => {
                if (!timestamp) return 'Unknown';
                return new Date(timestamp).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
            };

            const getDaysRemaining = (deletedAt) => {
                const ninetyDays = 90 * 24 * 60 * 60 * 1000;
                const expiresAt = deletedAt + ninetyDays;
                const remaining = Math.ceil((expiresAt - Date.now()) / (24 * 60 * 60 * 1000));
                return remaining;
            };

            const restoreProject = (project) => {
                const { deletedAt, deletedBy, ...cleanProject } = project;
                setProjects([...projects, cleanProject]);
                setTrashedProjects(trashedProjects.filter(p => p.id !== project.id));
            };

            const restoreEmployee = (employee) => {
                const { deletedAt, deletedBy, ...cleanEmployee } = employee;
                setEmployees([...employees, cleanEmployee]);
                setTrashedEmployees(trashedEmployees.filter(e => e.id !== employee.id));
            };

            const permanentlyDeleteProject = (projectId) => {
                setTrashedProjects(trashedProjects.filter(p => p.id !== projectId));
            };

            const permanentlyDeleteEmployee = (employeeId) => {
                setTrashedEmployees(trashedEmployees.filter(e => e.id !== employeeId));
            };

            const emptyTrash = () => {
                if (trashTab === 'projects') {
                    setTrashedProjects([]);
                } else {
                    setTrashedEmployees([]);
                }
                setConfirmEmpty(false);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="p-4 border-b bg-gray-50 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <span className="text-xl">‚öô</span>
                                <h2 className="text-xl font-bold text-gray-900">Data Management</h2>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        {/* Tabs */}
                        <div className="border-b">
                            <div className="flex">
                                <button
                                    onClick={() => setActiveTab('trash')}
                                    className={`px-6 py-3 text-sm font-medium ${activeTab === 'trash' ? 'border-b-2 border-red-500 text-red-600' : 'text-gray-600'}`}
                                >
                                    üóë Trash ({trashedProjects.length + trashedEmployees.length})
                                </button>
                                <button
                                    onClick={() => setActiveTab('backup')}
                                    className={`px-6 py-3 text-sm font-medium ${activeTab === 'backup' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                                >
                                    üíæ Backup & Restore
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto" style={{maxHeight: 'calc(90vh - 140px)'}}>
                            {activeTab === 'trash' && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setTrashTab('projects')}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium ${trashTab === 'projects' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                                            >
                                                Projects ({trashedProjects.length})
                                            </button>
                                            <button
                                                onClick={() => setTrashTab('employees')}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium ${trashTab === 'employees' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                                            >
                                                Employees ({trashedEmployees.length})
                                            </button>
                                        </div>
                                        {((trashTab === 'projects' && trashedProjects.length > 0) || (trashTab === 'employees' && trashedEmployees.length > 0)) && (
                                            <button
                                                onClick={() => setConfirmEmpty(true)}
                                                className="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded"
                                            >
                                                Empty {trashTab === 'projects' ? 'Projects' : 'Employees'} Trash
                                            </button>
                                        )}
                                    </div>

                                    <p className="text-sm text-gray-500">
                                        Items in trash are automatically deleted after 90 days.
                                    </p>

                                    {trashTab === 'projects' && (
                                        <div className="space-y-2">
                                            {trashedProjects.length === 0 ? (
                                                <div className="text-center py-8 text-gray-500">
                                                    <p>No deleted projects</p>
                                                </div>
                                            ) : (
                                                trashedProjects.map(project => (
                                                    <div key={project.id} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">{project.name}</h4>
                                                            <p className="text-sm text-gray-500">
                                                                {project.modules?.length || 0} modules ‚Ä¢ Deleted {formatDate(project.deletedAt)}
                                                            </p>
                                                            <p className="text-xs text-orange-600">
                                                                {getDaysRemaining(project.deletedAt)} days until permanent deletion
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => restoreProject(project)}
                                                                className="px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
                                                            >
                                                                Restore
                                                            </button>
                                                            <button
                                                                onClick={() => permanentlyDeleteProject(project.id)}
                                                                className="px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
                                                            >
                                                                Delete Forever
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    )}

                                    {trashTab === 'employees' && (
                                        <div className="space-y-2">
                                            {trashedEmployees.length === 0 ? (
                                                <div className="text-center py-8 text-gray-500">
                                                    <p>No deleted employees</p>
                                                </div>
                                            ) : (
                                                trashedEmployees.map(employee => (
                                                    <div key={employee.id} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">
                                                                {employee.firstName} {employee.lastName}
                                                            </h4>
                                                            <p className="text-sm text-gray-500">
                                                                {employee.jobTitle} ‚Ä¢ {employee.department} ‚Ä¢ Deleted {formatDate(employee.deletedAt)}
                                                            </p>
                                                            <p className="text-xs text-orange-600">
                                                                {getDaysRemaining(employee.deletedAt)} days until permanent deletion
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => restoreEmployee(employee)}
                                                                className="px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
                                                            >
                                                                Restore
                                                            </button>
                                                            <button
                                                                onClick={() => permanentlyDeleteEmployee(employee.id)}
                                                                className="px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
                                                            >
                                                                Delete Forever
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'backup' && (
                                <div className="space-y-6">
                                    {/* Export Section */}
                                    <div className="p-4 border rounded-lg">
                                        <h3 className="font-semibold text-gray-900 mb-2">üìã¬§ Export Data</h3>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Download a complete backup of all MODA data including projects, modules, employees, and trash.
                                        </p>
                                        <button
                                            onClick={exportData}
                                            className="px-4 py-2 btn-primary rounded-lg"
                                        >
                                            Download Backup
                                        </button>
                                    </div>

                                    {/* Import Section */}
                                    <div className="p-4 border rounded-lg">
                                        <h3 className="font-semibold text-gray-900 mb-2">üìã¬• Import Data</h3>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Restore MODA data from a previously exported backup file. This will replace current data.
                                        </p>
                                        <label className="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700">
                                            Select Backup File
                                            <input 
                                                type="file" 
                                                accept=".json" 
                                                className="hidden" 
                                                onChange={(e) => {
                                                    if (e.target.files[0]) {
                                                        if (confirm('This will replace all current data. Are you sure?')) {
                                                            importData(e.target.files[0]);
                                                        }
                                                    }
                                                }}
                                            />
                                        </label>
                                    </div>

                                    {/* Data Summary */}
                                    <div className="p-4 bg-gray-50 rounded-lg">
                                        <h3 className="font-semibold text-gray-900 mb-3">üìã≈† Current Data Summary</h3>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span className="text-gray-600">Projects:</span>
                                                <span className="ml-2 font-medium">{projects.length}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-600">Trashed Projects:</span>
                                                <span className="ml-2 font-medium">{trashedProjects.length}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-600">Employees:</span>
                                                <span className="ml-2 font-medium">{employees.length}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-600">Trashed Employees:</span>
                                                <span className="ml-2 font-medium">{trashedEmployees.length}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-600">Total Modules:</span>
                                                <span className="ml-2 font-medium">{projects.reduce((sum, p) => sum + (p.modules?.length || 0), 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Empty Trash Confirmation */}
                        {confirmEmpty && (
                            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                                <div className="bg-white rounded-lg p-6 max-w-sm">
                                    <h3 className="font-bold text-lg mb-2">Empty {trashTab === 'projects' ? 'Projects' : 'Employees'} Trash?</h3>
                                    <p className="text-gray-600 text-sm mb-4">
                                        This will permanently delete all {trashTab === 'projects' ? trashedProjects.length + ' projects' : trashedEmployees.length + ' employees'}. This cannot be undone.
                                    </p>
                                    <div className="flex gap-2 justify-end">
                                        <button onClick={() => setConfirmEmpty(false)} className="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                                        <button onClick={emptyTrash} className="px-4 py-2 bg-red-600 text-white rounded-lg">Delete All</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Project Detail View
        function ProjectDetail({ project, projects, setProjects, onBack, viewMode, setViewMode, searchTerm, setSearchTerm, stageFilter, setStageFilter }) {
            const [showImportModal, setShowImportModal] = useState(false);
            const [selectedModule, setSelectedModule] = useState(null);
            const [editMode, setEditMode] = useState(false);
            const [editingModule, setEditingModule] = useState(null);
            const [showLicensePlates, setShowLicensePlates] = useState(false);
            
            // Report Issue State
            const [showReportIssueModal, setShowReportIssueModal] = useState(false);
            const [reportIssueContext, setReportIssueContext] = useState(null);
            const [engineeringIssues, setEngineeringIssues] = useState(() => {
                const saved = localStorage.getItem('autovol_engineering_issues');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [difficultyFilters, setDifficultyFilters] = useState({
                sidewall: false,
                stair: false,
                hr3Wall: false,
                short: false,
                doubleStudio: false,
                sawbox: false
            });
            
            // Get fresh project data from projects array to ensure we have latest modules
            const currentProject = projects.find(p => p.id === project.id) || project;
            const modules = currentProject.modules || [];
            
            // Toggle difficulty filter
            const toggleDifficultyFilter = (key) => {
                setDifficultyFilters(prev => ({ ...prev, [key]: !prev[key] }));
            };
            
            // Check if any difficulty filter is active
            const anyDifficultyFilterActive = Object.values(difficultyFilters).some(v => v);
            
            // Filter modules
            const filteredModules = modules.filter(m => {
                const matchesSearch = !searchTerm || 
                    m.serialNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    m.hitchBLM?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    m.rearBLM?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(m.hitchUnit)?.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesStage = stageFilter === 'all' || 
                    (m.stageProgress?.[stageFilter] > 0 && m.stageProgress?.[stageFilter] < 100);
                
                // Difficulty filter - show modules that have ANY of the selected difficulties
                const matchesDifficulty = !anyDifficultyFilterActive || (
                    (difficultyFilters.sidewall && m.difficulties?.sidewall) ||
                    (difficultyFilters.stair && m.difficulties?.stair) ||
                    (difficultyFilters.hr3Wall && m.difficulties?.hr3Wall) ||
                    (difficultyFilters.short && m.difficulties?.short) ||
                    (difficultyFilters.doubleStudio && m.difficulties?.doubleStudio) ||
                    (difficultyFilters.sawbox && m.difficulties?.sawbox)
                );
                
                return matchesSearch && matchesStage && matchesDifficulty;
            });

            // Save engineering issues to localStorage
            useEffect(() => {
                localStorage.setItem('autovol_engineering_issues', JSON.stringify(engineeringIssues));
            }, [engineeringIssues]);
            
            // Open report issue modal with context
            const openReportIssue = (module, station) => {
                setReportIssueContext({ module, station: station || null, project: currentProject });
                setShowReportIssueModal(true);
            };
            
            // Handle issue submission
            const handleSubmitIssue = (issueData) => {
                const newIssue = {
                    id: `ENG-${Date.now()}`,
                    ...issueData,
                    status: 'open',
                    createdAt: new Date().toISOString(),
                    history: [{
                        action: 'Issue Created',
                        timestamp: new Date().toISOString(),
                        by: issueData.reportedBy
                    }]
                };
                setEngineeringIssues(prev => [newIssue, ...prev]);
                setShowReportIssueModal(false);
                setReportIssueContext(null);
            };
            
            // Update project modules
            const updateProjectModules = (newModules) => {
                const updatedProjects = projects.map(p => 
                    p.id === project.id ? { ...p, modules: newModules } : p
                );
                setProjects(updatedProjects);
            };

            // Import handler
            const handleImport = (importedModules) => {
                const newModules = importedModules.map((m, idx) => ({
                    ...m,
                    id: Date.now() + idx,
                    stageProgress: productionStages.reduce((acc, stage) => {
                        acc[stage.id] = 0;
                        return acc;
                    }, {})
                }));
                updateProjectModules([...modules, ...newModules]);
                setShowImportModal(false);
            };

            // Update project status
            const updateProjectStatus = (newStatus) => {
                const updatedProjects = projects.map(p => 
                    p.id === project.id ? { ...p, status: newStatus } : p
                );
                setProjects(updatedProjects);
            };

            // Get progress color class
            const getProgressClass = (progress) => {
                if (progress === 100) return 'stage-bg-100';
                if (progress >= 75) return 'stage-bg-75';
                if (progress >= 50) return 'stage-bg-50';
                if (progress >= 25) return 'stage-bg-25';
                return 'stage-bg-0';
            };

            // Get current stage for display
            const getCurrentStage = (module) => {
                const stageProgress = module.stageProgress || {};
                for (let i = productionStages.length - 1; i >= 0; i--) {
                    const stage = productionStages[i];
                    if (stageProgress[stage.id] > 0) {
                        return { stage, progress: stageProgress[stage.id] };
                    }
                }
                return { stage: null, progress: 0 };
            };

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <button 
                                onClick={onBack}
                                className="text-autovol-red hover:text-autovol-red text-sm mb-2 flex items-center gap-1"
                            >
                                ‚Üê Back to Projects
                            </button>
                            <h2 className="text-2xl font-bold text-autovol-navy">{project.name}</h2>
                            <p className="text-gray-500">{project.location}</p>
                            {project.description && <p className="text-sm text-gray-600">{project.description}</p>}
                            <div className="flex items-center gap-2 mt-2">
                                <span className={`px-2 py-0.5 text-xs rounded ${
                                    project.status === 'Active' ? 'bg-green-100 text-green-800' :
                                    project.status === 'Complete' ? 'bg-gray-100 text-gray-800' :
                                    project.status === 'Planned' ? 'bg-blue-100 text-blue-800' :
                                    'bg-yellow-100 text-yellow-800'
                                }`}>
                                    {project.status}
                                </span>
                                <span className="text-sm text-gray-600">{modules.length} modules</span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {project.status !== 'Active' && (
                                <button
                                    onClick={() => updateProjectStatus('Active')}
                                    className="px-4 py-2 btn-secondary rounded-lg transition"
                                >
                                    Go Online
                                </button>
                            )}
                            <button
                                onClick={() => setShowLicensePlates(true)}
                                disabled={modules.length === 0}
                                className={`px-4 py-2 rounded-lg transition flex items-center gap-2 ${
                                    modules.length === 0 
                                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                        : 'bg-autovol-navy text-white hover:bg-autovol-navy-light'
                                }`}
                            >
                                üè∑Ô∏è License Plates
                            </button>
                            <button
                                onClick={() => setShowImportModal(true)}
                                className="px-4 py-2 btn-primary rounded-lg transition"
                            >
                                Import Modules
                            </button>
                        </div>
                    </div>

                    {/* Filters */}
                    <div className="bg-white rounded-lg shadow p-4">
                        <div className="flex flex-wrap items-center gap-4">
                            <input
                                type="text"
                                placeholder="Search serial, BLM, unit..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="px-3 py-2 border rounded-lg flex-1 min-w-48"
                            />
                            <select
                                value={stageFilter}
                                onChange={(e) => setStageFilter(e.target.value)}
                                className="px-3 py-2 border rounded-lg"
                            >
                                <option value="all">All Stages</option>
                                {productionStages.map(stage => (
                                    <option key={stage.id} value={stage.id}>{stage.name}</option>
                                ))}
                            </select>
                            <div className="flex gap-1 border rounded-lg p-1">
                                <button
                                    onClick={() => setViewMode('grid')}
                                    className={`px-3 py-1 rounded ${viewMode === 'grid' ? 'bg-gray-800 text-white' : 'text-gray-600'}`}
                                >
                                    Grid
                                </button>
                                <button
                                    onClick={() => setViewMode('list')}
                                    className={`px-3 py-1 rounded ${viewMode === 'list' ? 'bg-gray-800 text-white' : 'text-gray-600'}`}
                                >
                                    List
                                </button>
                            </div>
                        </div>
                        
                        {/* Difficulty Filters */}
                        <div className="flex flex-wrap items-center gap-2 mt-3 pt-3 border-t">
                            <span className="text-sm text-gray-600 font-medium">Difficulty Filters:</span>
                            <button
                                onClick={() => toggleDifficultyFilter('sidewall')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.sidewall ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-600 border-gray-300 hover:border-orange-400'}`}
                            >
                                Sidewall
                            </button>
                            <button
                                onClick={() => toggleDifficultyFilter('stair')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.stair ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-600 border-gray-300 hover:border-purple-400'}`}
                            >
                                Stair
                            </button>
                            <button
                                onClick={() => toggleDifficultyFilter('hr3Wall')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.hr3Wall ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-600 border-gray-300 hover:border-red-400'}`}
                            >
                                3HR-Wall
                            </button>
                            <button
                                onClick={() => toggleDifficultyFilter('short')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.short ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-600 border-gray-300 hover:border-yellow-400'}`}
                            >
                                Short
                            </button>
                            <button
                                onClick={() => toggleDifficultyFilter('doubleStudio')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.doubleStudio ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-400'}`}
                            >
                                Dbl Studio
                            </button>
                            <button
                                onClick={() => toggleDifficultyFilter('sawbox')}
                                className={`px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.sawbox ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-gray-300 hover:border-green-400'}`}
                            >
                                Sawbox
                            </button>
                            {anyDifficultyFilterActive && (
                                <button
                                    onClick={() => setDifficultyFilters({ sidewall: false, stair: false, hr3Wall: false, short: false, doubleStudio: false, sawbox: false })}
                                    className="px-2 py-1 text-xs text-gray-500 hover:text-gray-700 underline"
                                >
                                    Clear filters
                                </button>
                            )}
                        </div>
                        
                        <p className="text-sm text-gray-500 mt-2">
                            Showing {filteredModules.length} of {modules.length} modules
                        </p>
                    </div>

                    {/* Module Grid/List */}
                    <div className="bg-white rounded-lg shadow">
                        <div className="p-4 border-b">
                            <h3 className="font-semibold text-gray-900">Project Modules</h3>
                        </div>
                        
                        {modules.length === 0 ? (
                            <div className="p-8 text-center text-gray-500">
                                No modules imported yet. Click "Import Modules" to add modules from Excel.
                            </div>
                        ) : viewMode === 'grid' ? (
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredModules.map(module => {
                                    const { stage: currentStage, progress } = getCurrentStage(module);
                                    const hasDifficulties = Object.values(module.difficulties || {}).some(v => v);
                                    
                                    return (
                                        <div 
                                            key={module.id}
                                            onClick={() => setSelectedModule(module)}
                                            className="border rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                                        >
                                            {/* Header with Serial & Stage */}
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="flex items-center gap-1">
                                                        <h4 className="font-bold text-lg text-gray-900">{module.serialNumber}</h4>
                                                        {module.isPrototype && (
                                                            <span 
                                                                className="text-yellow-500 cursor-help" 
                                                                title="Prototype"
                                                                style={{ fontSize: '14px' }}
                                                            >
                                                                ‚òÖ
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="text-sm text-gray-500">Build Seq: {module.buildSequence}</p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {currentStage && (
                                                        <span className={`px-2 py-1 text-xs rounded ${getProgressClass(progress)} ${progress === 100 ? 'text-white' : progress >= 50 ? 'text-white' : 'text-gray-800'}`}>
                                                            {currentStage.name}
                                                        </span>
                                                    )}
                                                    {/* Module Actions Menu */}
                                                    <div className="relative group">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); }}
                                                            className="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-gray-600"
                                                            title="More options"
                                                        >
                                                            ‚ãÆ
                                                        </button>
                                                        <div className="absolute right-0 top-full mt-1 w-40 bg-white rounded-lg shadow-lg border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-20">
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); setSelectedModule(module); }}
                                                                className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                                                            >
                                                                üëÅÔ∏è View Details
                                                            </button>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); setEditingModule(module); }}
                                                                className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                                                            >
                                                                ‚úèÔ∏è Edit Module
                                                            </button>
                                                            <div className="border-t"></div>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); openReportIssue(module, null); }}
                                                                className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                                                            >
                                                                ‚ö†Ô∏è Report Issue
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Unit Info */}
                                            <div className="text-sm text-gray-600 mb-2">
                                                <span className="font-medium">Unit:</span> {module.hitchUnit || 'N/A'}
                                            </div>
                                            
                                            {/* Dimensions */}
                                            <div className="flex gap-4 text-sm text-gray-600 mb-3">
                                                <span><strong>W:</strong> {module.moduleWidth}'</span>
                                                <span><strong>L:</strong> {module.moduleLength}'</span>
                                                <span><strong>SF:</strong> {module.squareFootage}</span>
                                            </div>

                                            {/* HITCH/REAR BLM */}
                                            <div className="border-t pt-2 space-y-1 text-sm">
                                                <div className="flex gap-2">
                                                    <span className="text-gray-500 w-12">HITCH:</span>
                                                    <span className="font-medium">{module.hitchBLM || 'N/A'}</span>
                                                    <span className="text-gray-500">|</span>
                                                    <span>{module.hitchRoomType || 'N/A'}</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    <span className="text-gray-500 w-12">REAR:</span>
                                                    <span className="font-medium">{module.rearBLM || 'N/A'}</span>
                                                    <span className="text-gray-500">|</span>
                                                    <span>{module.rearRoomType || 'N/A'}</span>
                                                </div>
                                            </div>

                                            {/* Difficulty Indicators */}
                                            {hasDifficulties && (
                                                <div className="flex flex-wrap gap-1 mt-3 pt-2 border-t">
                                                    {Object.entries(module.difficulties || {}).map(([key, value]) => 
                                                        value && (
                                                            <span key={key} className={`px-2 py-0.5 text-xs rounded ${difficultyColors[key]}`}>
                                                                {difficultyLabels[key]}
                                                            </span>
                                                        )
                                                    )}
                                                </div>
                                            )}

                                            {/* Progress Bar */}
                                            {progress > 0 && (
                                                <div className="mt-3">
                                                    <div className="flex justify-between text-xs text-gray-500 mb-1">
                                                        <span>{currentStage?.name}</span>
                                                        <span>{progress}%</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                        <div 
                                                            className={`h-2 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`}
                                                            style={{ width: `${progress}%` }}
                                                        />
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Serial #</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Build Seq</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dimensions</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hitch BLM</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rear BLM</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stage</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Difficulties</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {filteredModules.map(module => {
                                            const { stage: currentStage, progress } = getCurrentStage(module);
                                            return (
                                                <tr 
                                                    key={module.id} 
                                                    onClick={() => setSelectedModule(module)}
                                                    className="hover:bg-gray-50 cursor-pointer"
                                                >
                                                    <td className="px-4 py-3 font-medium">
                                                        <span className="flex items-center gap-1">
                                                            {module.serialNumber}
                                                            {module.isPrototype && (
                                                                <span 
                                                                    className="text-yellow-500 cursor-help" 
                                                                    title="Prototype"
                                                                    style={{ fontSize: '12px' }}
                                                                >
                                                                    ‚òÖ
                                                                </span>
                                                            )}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">{module.buildSequence}</td>
                                                    <td className="px-4 py-3">{module.hitchUnit}</td>
                                                    <td className="px-4 py-3 text-sm">{module.moduleWidth}' x {module.moduleLength}'</td>
                                                    <td className="px-4 py-3">{module.hitchBLM}</td>
                                                    <td className="px-4 py-3">{module.rearBLM}</td>
                                                    <td className="px-4 py-3">
                                                        {currentStage && (
                                                            <span className={`px-2 py-1 text-xs rounded ${getProgressClass(progress)} ${progress >= 50 ? 'text-white' : ''}`}>
                                                                {currentStage.name}
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-20 bg-gray-200 rounded-full h-2">
                                                                <div 
                                                                    className={`h-2 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`}
                                                                    style={{ width: `${progress}%` }}
                                                                />
                                                            </div>
                                                            <span className="text-xs text-gray-500">{progress}%</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex flex-wrap gap-1">
                                                            {Object.entries(module.difficulties || {}).map(([key, value]) => 
                                                                value && (
                                                                    <span key={key} className={`px-1.5 py-0.5 text-xs rounded ${difficultyColors[key]}`}>
                                                                        {difficultyLabels[key]}
                                                                    </span>
                                                                )
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* Import Modal */}
                    {showImportModal && (
                        <ImportModal 
                            onClose={() => setShowImportModal(false)}
                            onImport={handleImport}
                        />
                    )}

                    {/* Module Detail Modal */}
                    {selectedModule && (
                        <ModuleDetailModal 
                            module={selectedModule}
                            project={project}
                            projects={projects}
                            setProjects={setProjects}
                            onClose={() => { setSelectedModule(null); setEditMode(false); }}
                            editMode={editMode}
                            setEditMode={setEditMode}
                        />
                    )}

                    {/* License Plate Generator */}
                    {showLicensePlates && (
                        <LicensePlateGenerator
                            project={currentProject}
                            modules={modules}
                            onClose={() => setShowLicensePlates(false)}
                        />
                    )}
                    
                    {/* Report Issue Modal */}
                    {showReportIssueModal && reportIssueContext && (
                        <ReportIssueModal
                            context={reportIssueContext}
                            onSubmit={handleSubmitIssue}
                            onClose={() => {
                                setShowReportIssueModal(false);
                                setReportIssueContext(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        // ===== LICENSE PLATE GENERATOR =====
        function LicensePlateGenerator({ project, modules, onClose }) {
            const [selectedModules, setSelectedModules] = useState(new Set(modules.map((_, i) => i)));
            const [searchTerm, setSearchTerm] = useState('');
            const [buildingFilters, setBuildingFilters] = useState(new Set());
            const [levelFilters, setLevelFilters] = useState(new Set());
            const [difficultyFilters, setDifficultyFilters] = useState(new Set());
            const [unitTypeFilters, setUnitTypeFilters] = useState(new Set());
            const [seqFrom, setSeqFrom] = useState('');
            const [seqTo, setSeqTo] = useState('');
            const [previewModule, setPreviewModule] = useState(modules[0] || null);
            const [previewSide, setPreviewSide] = useState('H');
            const [pageSize, setPageSize] = useState('letter');
            const [footerNotes, setFooterNotes] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);

            const baseUrl = window.location.origin + window.location.pathname;
            const pageSizes = {
                letter: { width: 612, height: 792, label: 'Letter (8.5" √ó 11")' },
                legal: { width: 612, height: 1008, label: 'Legal (8.5" √ó 14")' },
                tabloid: { width: 792, height: 1224, label: 'Tabloid (11" √ó 17")' }
            };

            // Extract filter options
            const filterOptions = useMemo(() => {
                const buildings = new Map();
                const levels = new Map();
                const difficulties = new Map();
                const unitTypes = new Map();
                
                modules.forEach((module) => {
                    // Extract from BLM ID (hitchBLM) for Building/Level
                    const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
                    if (blmData.building !== 'OTHER') {
                        buildings.set(blmData.building, (buildings.get(blmData.building) || 0) + 1);
                    }
                    if (blmData.level !== 'OTHER') {
                        levels.set(blmData.level, (levels.get(blmData.level) || 0) + 1);
                    }
                    
                    const indicators = getLicensePlateIndicators(module);
                    indicators.forEach(ind => {
                        difficulties.set(ind.key, (difficulties.get(ind.key) || 0) + 1);
                    });
                    
                    const unitType = extractUnitType(module.hitchUnit || module.unitType || '');
                    unitTypes.set(unitType, (unitTypes.get(unitType) || 0) + 1);
                });
                
                // Sort buildings and levels naturally (B1, B2, B3... and L0, L1, L2...)
                const sortNatural = (a, b) => {
                    const numA = parseInt(a[0].slice(1)) || 0;
                    const numB = parseInt(b[0].slice(1)) || 0;
                    return numA - numB;
                };
                
                return {
                    buildings: Array.from(buildings.entries()).sort(sortNatural),
                    levels: Array.from(levels.entries()).sort(sortNatural),
                    difficulties: Array.from(difficulties.entries()),
                    unitTypes: Array.from(unitTypes.entries()).sort((a, b) => a[0].localeCompare(b[0]))
                };
            }, [modules]);

            // Filter modules
            const filteredModules = useMemo(() => {
                return modules.filter((module) => {
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        const serial = String(module.serialNumber || '').toLowerCase();
                        const buildSeq = String(module.buildSequence || '').toLowerCase();
                        const unitType = String(module.hitchUnit || module.unitType || '').toLowerCase();
                        const blm = String(module.hitchBLM || '').toLowerCase();
                        if (!serial.includes(term) && !buildSeq.includes(term) && !unitType.includes(term) && !blm.includes(term)) return false;
                    }
                    // Building filter
                    if (buildingFilters.size > 0) {
                        const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
                        if (!buildingFilters.has(blmData.building)) return false;
                    }
                    // Level filter
                    if (levelFilters.size > 0) {
                        const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
                        if (!levelFilters.has(blmData.level)) return false;
                    }
                    if (difficultyFilters.size > 0) {
                        const indicators = getLicensePlateIndicators(module);
                        const indicatorKeys = indicators.map(i => i.key);
                        if (!Array.from(difficultyFilters).some(f => indicatorKeys.includes(f))) return false;
                    }
                    if (unitTypeFilters.size > 0) {
                        const unitType = extractUnitType(module.hitchUnit || module.unitType || '');
                        if (!unitTypeFilters.has(unitType)) return false;
                    }
                    const seq = parseInt(module.buildSequence) || 0;
                    if (seqFrom && seq < parseInt(seqFrom)) return false;
                    if (seqTo && seq > parseInt(seqTo)) return false;
                    return true;
                });
            }, [modules, searchTerm, buildingFilters, levelFilters, difficultyFilters, unitTypeFilters, seqFrom, seqTo]);

            const toggleFilter = (set, setFn, value) => {
                const newSet = new Set(set);
                newSet.has(value) ? newSet.delete(value) : newSet.add(value);
                setFn(newSet);
            };

            const clearFilters = () => {
                setBuildingFilters(new Set());
                setLevelFilters(new Set());
                setDifficultyFilters(new Set());
                setUnitTypeFilters(new Set());
                setSeqFrom('');
                setSeqTo('');
                setSearchTerm('');
            };

            const hasActiveFilters = buildingFilters.size > 0 || levelFilters.size > 0 || difficultyFilters.size > 0 || unitTypeFilters.size > 0 || seqFrom || seqTo || searchTerm;

            const selectAllFiltered = () => {
                const indices = filteredModules.map(m => modules.indexOf(m));
                setSelectedModules(new Set(indices));
            };

            const selectNone = () => setSelectedModules(new Set());

            const toggleModuleSelection = (moduleIdx) => {
                const newSelected = new Set(selectedModules);
                newSelected.has(moduleIdx) ? newSelected.delete(moduleIdx) : newSelected.add(moduleIdx);
                setSelectedModules(newSelected);
            };

            const selectedInFiltered = Array.from(selectedModules).filter(idx => filteredModules.includes(modules[idx])).length;

            // PDF Generation
            const generatePDF = async () => {
                const selectedArray = Array.from(selectedModules).filter(idx => filteredModules.includes(modules[idx])).sort((a, b) => {
                    const seqA = parseInt(modules[a].buildSequence) || 0;
                    const seqB = parseInt(modules[b].buildSequence) || 0;
                    return seqA - seqB;
                });
                if (selectedArray.length === 0) return alert('Please select at least one module');
                setIsGenerating(true);
                try {
                    const { jsPDF } = window.jspdf;
                    const size = pageSizes[pageSize];
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [size.width, size.height] });
                    let isFirstPage = true;
                    for (const idx of selectedArray) {
                        const module = modules[idx];
                        if (!isFirstPage) doc.addPage();
                        isFirstPage = false;
                        drawPlate(doc, module, 'H', size);
                        doc.addPage();
                        drawPlate(doc, module, 'R', size);
                    }
                    doc.save(`License_Plates_${project.name.replace(/\s+/g, '_')}_${new Date().toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'2-digit'}).replace(/\//g,'-')}.pdf`);
                } catch (error) {
                    alert('Error generating PDF: ' + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const drawPlate = (doc, module, side, size) => {
                const { width, height } = size;
                const centerX = width / 2;
                const scale = height > 900 ? (height > 1100 ? 1.3 : 1.15) : 1;
                const serial = module.serialNumber || '';
                const buildSeq = module.buildSequence || '';
                const blm = side === 'H' ? (module.hitchBLM || '') : (module.rearBLM || '');
                const unitType = module.hitchUnit || module.unitType || '';
                const indicators = getLicensePlateIndicators(module);
                
                // Get shop drawing URL for this module's BLM
                const shopDrawingLinks = project.shopDrawingLinks || {};
                const shopDrawingUrl = shopDrawingLinks[blm] || '';
                
                let y = 50 * scale;
                doc.setFontSize(14 * scale).setFont('helvetica', 'bold');
                doc.text(`PROJECT: ${project.name.toUpperCase()}`, centerX, y, { align: 'center' });
                y += 18 * scale;
                doc.text(`LOCATION: ${(project.location || '').toUpperCase()}`, centerX, y, { align: 'center' });
                y += 35 * scale;
                doc.setFontSize(36 * scale).text(`#${buildSeq}`, centerX, y, { align: 'center' });
                y += 45 * scale;
                doc.setFontSize(42 * scale).text(String(serial), centerX, y, { align: 'center' });
                y += 55 * scale;
                doc.setFontSize(54 * scale).text(`(${side}) - ${blm}`, centerX, y, { align: 'center' });
                y += 50 * scale;
                if (indicators.length > 0) {
                    doc.setTextColor(220, 38, 38).setFontSize(24 * scale);
                    doc.text(indicators.map(i => i.label).join('; '), centerX, y, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                }
                y += 35 * scale;
                doc.setFontSize(32 * scale).text(String(unitType).toUpperCase(), centerX, y, { align: 'center' });
                y += 50 * scale;
                
                // Only show QR code if shop drawing URL exists
                if (shopDrawingUrl) {
                    doc.setFontSize(8 * scale).setFont('helvetica', 'bold');
                    doc.text('Shop Drawing Package Link', centerX, y, { align: 'center' });
                    y += 12 * scale;
                    const qr = qrcode(0, 'M');
                    qr.addData(shopDrawingUrl);
                    qr.make();
                    const qrSize = 100 * scale;
                    doc.addImage(qr.createDataURL(4, 0), 'PNG', centerX - qrSize/2, y, qrSize, qrSize);
                    y += qrSize + 12 * scale;
                    doc.setFontSize(8 * scale).setFont('helvetica', 'normal');
                    doc.text('Scan to open shop drawing', centerX, y, { align: 'center' });
                }
                
                let footerY = height - 50 * scale;
                doc.setFontSize(10 * scale);
                doc.text(new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' }), centerX, footerY, { align: 'center' });
                if (footerNotes?.trim()) {
                    doc.setFont('helvetica', 'italic').setFontSize(9 * scale);
                    doc.text(footerNotes.trim(), centerX, footerY - 15 * scale, { align: 'center' });
                }
            };

            // Filter Chip Component
            const FilterChip = ({ label, count, selected, onClick, color = 'blue' }) => {
                const colors = {
                    blue: selected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400',
                    orange: selected ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-400',
                    purple: selected ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-700 border-gray-300 hover:border-purple-400',
                    red: selected ? 'bg-red-600 text-white border-red-600' : 'bg-white text-gray-700 border-gray-300 hover:border-red-400',
                    yellow: selected ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-700 border-gray-300 hover:border-yellow-400',
                    green: selected ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-700 border-gray-300 hover:border-green-400',
                    pink: selected ? 'bg-pink-600 text-white border-pink-600' : 'bg-white text-gray-700 border-gray-300 hover:border-pink-400',
                };
                return (
                    <button onClick={onClick} className={`px-3 py-1.5 rounded-full border text-sm font-medium flex items-center gap-1.5 transition ${colors[color]}`}>
                        {label}
                        {count !== undefined && <span className={`text-xs px-1.5 rounded-full ${selected ? 'bg-white/30' : 'bg-gray-200'}`}>{count}</span>}
                    </button>
                );
            };

            const difficultyColors = { 'PROTO': 'pink', 'STAIR': 'purple', '3HR': 'red', 'SW': 'orange', 'SHORT': 'yellow', 'DBL': 'blue', 'SAWBOX': 'green' };

            // Plate Preview Component
            const PlatePreview = ({ module, side }) => {
                if (!module) return <div className="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center text-gray-500">Select a module to preview</div>;
                const serial = module.serialNumber || '';
                const buildSeq = module.buildSequence || '';
                const blm = side === 'H' ? (module.hitchBLM || '') : (module.rearBLM || '');
                const unitType = module.hitchUnit || module.unitType || '';
                const indicators = getLicensePlateIndicators(module);
                const shopDrawingLinks = project.shopDrawingLinks || {};
                const shopDrawingUrl = shopDrawingLinks[blm] || '';
                return (
                    <div className="bg-white border-2 border-gray-400 rounded p-4 w-64 text-center mx-auto shadow-lg" style={{ fontFamily: 'Arial, sans-serif' }}>
                        <div className="text-xs font-bold text-gray-700">PROJECT: {project.name.toUpperCase()}</div>
                        <div className="text-xs font-bold text-gray-700 mb-2">LOCATION: {(project.location || '').toUpperCase()}</div>
                        <div className="text-3xl font-bold text-gray-900">#{buildSeq}</div>
                        <div className="text-2xl font-bold text-gray-800 my-1">{serial}</div>
                        <div className="text-4xl font-bold my-2" style={{ color: 'var(--autovol-navy)' }}>({side}) - {blm}</div>
                        {indicators.length > 0 && <div className="text-red-600 font-bold text-sm my-1">{indicators.map(i => i.label).join('; ')}</div>}
                        <div className="text-xl font-bold text-gray-800 my-1">{String(unitType).toUpperCase()}</div>
                        {shopDrawingUrl ? (
                            <div className="my-3">
                                <div className="text-xs font-bold text-gray-600 mb-1">Shop Drawing Package Link</div>
                                <img src={generateQRCode(shopDrawingUrl)} className="w-20 h-20 mx-auto" alt="QR Code" />
                                <div className="text-xs text-gray-500 mt-1">Scan to open shop drawing</div>
                            </div>
                        ) : (
                            <div className="my-3 py-4 text-xs text-gray-400 italic">No shop drawing link</div>
                        )}
                        {footerNotes && <div className="text-xs italic text-gray-600 my-1">{footerNotes}</div>}
                        <div className="text-xs text-gray-500 border-t pt-2 mt-2">
                            <div>{new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' })}</div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-autovol-gray z-50 overflow-auto">
                    {/* Header */}
                    <div className="bg-autovol-navy text-white p-4 sticky top-0 z-10 shadow-lg">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <button onClick={onClose} className="hover:bg-autovol-navy-light p-2 rounded flex items-center gap-1">
                                    <span>‚Üê</span> Back
                                </button>
                                <div>
                                    <h1 className="text-xl font-bold flex items-center gap-2">üè∑Ô∏è License Plate Generator</h1>
                                    <p className="text-blue-200 text-sm">{project.name} ‚Ä¢ {modules.length} modules</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4">
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
                            {/* Filters Column */}
                            <div className="lg:col-span-1 space-y-4">
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">üè¢ Building</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {filterOptions.buildings.length > 0 ? filterOptions.buildings.map(([building, count]) => (
                                            <FilterChip key={building} label={building} count={count} selected={buildingFilters.has(building)} onClick={() => toggleFilter(buildingFilters, setBuildingFilters, building)} color="blue" />
                                        )) : <p className="text-sm text-gray-500">No building data</p>}
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">üìã≈† Level</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {filterOptions.levels.length > 0 ? filterOptions.levels.map(([level, count]) => (
                                            <FilterChip key={level} label={level} count={count} selected={levelFilters.has(level)} onClick={() => toggleFilter(levelFilters, setLevelFilters, level)} color="purple" />
                                        )) : <p className="text-sm text-gray-500">No level data</p>}
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">‚ö† Difficulty</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {filterOptions.difficulties.map(([diff, count]) => (
                                            <FilterChip key={diff} label={diff} count={count} selected={difficultyFilters.has(diff)} onClick={() => toggleFilter(difficultyFilters, setDifficultyFilters, diff)} color={difficultyColors[diff] || 'blue'} />
                                        ))}
                                    </div>
                                    {filterOptions.difficulties.length === 0 && <p className="text-sm text-gray-500">No difficulty indicators</p>}
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">üè† Unit Type</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {filterOptions.unitTypes.map(([type, count]) => (
                                            <FilterChip key={type} label={type} count={count} selected={unitTypeFilters.has(type)} onClick={() => toggleFilter(unitTypeFilters, setUnitTypeFilters, type)} color="green" />
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">üì¢ Sequence Range</h3>
                                    <div className="flex items-center gap-2">
                                        <input type="number" placeholder="From" value={seqFrom} onChange={(e) => setSeqFrom(e.target.value)} className="w-20 border rounded px-2 py-1.5 text-sm" min="1" />
                                        <span className="text-gray-500">to</span>
                                        <input type="number" placeholder="To" value={seqTo} onChange={(e) => setSeqTo(e.target.value)} className="w-20 border rounded px-2 py-1.5 text-sm" min="1" />
                                    </div>
                                </div>
                                {hasActiveFilters && (
                                    <button onClick={clearFilters} className="w-full py-2 text-sm text-autovol-red hover:bg-red-50 rounded-lg border border-red-200 font-medium">
                                        ‚úï Clear All Filters
                                    </button>
                                )}
                            </div>

                            {/* Module List */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow">
                                    <div className="p-4 border-b">
                                        <div className="flex flex-wrap items-center gap-3 mb-3">
                                            <h3 className="font-bold text-autovol-navy">Modules</h3>
                                            <span className="text-sm text-gray-500">{filteredModules.length} of {modules.length} shown</span>
                                            <div className="flex-1" />
                                            <button onClick={selectAllFiltered} className="text-sm text-autovol-teal hover:underline font-medium">Select All</button>
                                            <button onClick={selectNone} className="text-sm text-gray-600 hover:underline font-medium">Select None</button>
                                        </div>
                                        <input type="text" placeholder="Search by serial, sequence, or unit type..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                                    </div>
                                    <div className="max-h-[500px] overflow-y-auto">
                                        {filteredModules.length === 0 ? (
                                            <div className="p-8 text-center text-gray-500">
                                                <div className="text-4xl mb-2">üìç</div>
                                                <p>No modules match your filters</p>
                                                <button onClick={clearFilters} className="mt-2 text-autovol-teal hover:underline font-medium">Clear filters</button>
                                            </div>
                                        ) : (
                                            filteredModules.map((module) => {
                                                const idx = modules.indexOf(module);
                                                const isSelected = selectedModules.has(idx);
                                                const indicators = getLicensePlateIndicators(module);
                                                return (
                                                    <div key={idx} className={`p-3 border-b flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'bg-blue-50' : ''}`} onClick={() => toggleModuleSelection(idx)}>
                                                        <input type="checkbox" checked={isSelected} readOnly className="w-4 h-4 rounded" />
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-gray-900">#{module.buildSequence}</span>
                                                                <span className="text-gray-700">{module.serialNumber}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2 text-sm text-gray-500">
                                                                <span>{module.hitchUnit || module.unitType}</span>
                                                                <span>‚Ä¢</span>
                                                                <span>H:{module.hitchBLM}</span>
                                                                <span>R:{module.rearBLM}</span>
                                                            </div>
                                                            {indicators.length > 0 && (
                                                                <div className="flex gap-1 mt-1">
                                                                    {indicators.map((ind, i) => (
                                                                        <span key={i} className="text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-medium">{ind.label}</span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <button onClick={(e) => { e.stopPropagation(); setPreviewModule(module); }} className="p-2 text-gray-400 hover:text-autovol-teal hover:bg-teal-50 rounded" title="Preview">üëÅ¬Å</button>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Preview & Generate */}
                            <div className="lg:col-span-1 space-y-4">
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">Preview</h3>
                                    <div className="flex justify-center gap-2 mb-4">
                                        <button onClick={() => setPreviewSide('H')} className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${previewSide === 'H' ? 'bg-autovol-navy text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>Hitch (H)</button>
                                        <button onClick={() => setPreviewSide('R')} className={`px-4 py-1.5 rounded text-sm font-medium transition-colors ${previewSide === 'R' ? 'bg-autovol-navy text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>Rear (R)</button>
                                    </div>
                                    <PlatePreview module={previewModule} side={previewSide} />
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="font-bold text-autovol-navy mb-3">PDF Settings</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Page Size</label>
                                            <select value={pageSize} onChange={(e) => setPageSize(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm">
                                                {Object.entries(pageSizes).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Footer Notes</label>
                                            <textarea value={footerNotes} onChange={(e) => setFooterNotes(e.target.value)} placeholder="e.g., Rev 2, Updated 11/23..." className="w-full border rounded-lg px-3 py-2 text-sm" rows={2} maxLength={100} />
                                            <p className="text-xs text-gray-500 mt-1">{footerNotes.length}/100</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <div className="bg-autovol-teal-light rounded-lg p-3 mb-4 text-sm">
                                        <div className="flex justify-between mb-1"><span className="text-gray-600">Selected Modules:</span><span className="font-bold text-gray-900">{selectedInFiltered}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-600">Total Pages:</span><span className="font-bold text-autovol-teal">{selectedInFiltered * 2}</span></div>
                                    </div>
                                    <button onClick={generatePDF} disabled={isGenerating || selectedInFiltered === 0} className={`w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 transition-colors ${isGenerating || selectedInFiltered === 0 ? 'bg-gray-400 cursor-not-allowed' : 'btn-primary'}`}>
                                        {isGenerating ? (<><span className="animate-spin">‚è≥</span>Generating...</>) : (<>üìã‚Äû Generate {selectedInFiltered * 2} Plates</>)}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Module Detail Modal
        function ModuleDetailModal({ module, project, projects, setProjects, onClose, editMode, setEditMode }) {
            const [editingModule, setEditingModule] = useState({ ...module });
            
            // Close on Escape key
            useEffect(() => {
                const handleEscapeKey = (e) => {
                    if (e.key === 'Escape') {
                        onClose();
                    }
                };
                document.addEventListener('keydown', handleEscapeKey);
                return () => document.removeEventListener('keydown', handleEscapeKey);
            }, [onClose]);

            const handleSave = () => {
                const updatedProjects = projects.map(p => {
                    if (p.id === project.id) {
                        return {
                            ...p,
                            modules: p.modules.map(m => m.id === module.id ? editingModule : m)
                        };
                    }
                    return p;
                });
                setProjects(updatedProjects);
                
                // DUAL-WRITE: When close-up hits 100%, update unified layer to "Ready for Yard"
                const closeUpProgress = editingModule.stageProgress?.['close-up'] || 0;
                const wasCloseUpComplete = module.stageProgress?.['close-up'] === 100;
                
                if (closeUpProgress === 100 && !wasCloseUpComplete) {
                    // Module just completed production - mark as Ready for Yard
                    console.log(`[MODA] Module ${editingModule.serialNumber} completed close-up - marking Ready for Yard`);
                    
                    // IMPORTANT: Save to localStorage IMMEDIATELY before sync
                    // React setState is async, so migrateFromProjects would read stale data
                    localStorage.setItem('autovol_projects', JSON.stringify(updatedProjects));
                    console.log(`[MODA] Saved project data to localStorage`);
                    
                    // Now sync to unified layer with fresh data
                    MODA_UNIFIED.migrateFromProjects();
                    
                    // Then update transport status to 'ready' (Ready for Yard)
                    MODA_UNIFIED.updateTransport(
                        editingModule.id,
                        { 
                            status: MODA_UNIFIED.TRANSPORT_STAGES.READY,
                            completedProductionAt: new Date().toISOString()
                        },
                        'station-board'
                    );
                    
                    console.log(`[MODA] Module ${editingModule.serialNumber} now in Yard phase - Ready for Transport`);
                }
                
                setEditMode(false);
                onClose();
            };

            const updateField = (field, value) => {
                setEditingModule(prev => ({ ...prev, [field]: value }));
            };

            const updateStageProgress = (stageId, value) => {
                setEditingModule(prev => ({
                    ...prev,
                    stageProgress: { ...prev.stageProgress, [stageId]: parseInt(value) }
                }));
            };

            const displayModule = editMode ? editingModule : module;

            const handleOpenShopDrawing = () => {
                const shopDrawingLinks = project?.shopDrawingLinks || {};
                const blmToCheck = [displayModule.hitchBLM, displayModule.rearBLM].filter(Boolean);
                let foundUrl = null;
                
                for (const blm of blmToCheck) {
                    if (shopDrawingLinks[blm]) {
                        foundUrl = shopDrawingLinks[blm];
                        break;
                    }
                }
                
                if (foundUrl) {
                    window.open(foundUrl, '_blank');
                } else {
                    const blmList = blmToCheck.length > 0 ? blmToCheck.join(', ') : 'No BLM';
                    alert(`Shop Drawing Not Found\n\nNo shop drawing link found for module ${displayModule.serialNumber} (BLM: ${blmList}).\n\nTo add shop drawing links, go to Projects ‚Üí Edit Project ‚Üí Shop Drawing Links.`);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            {/* Header */}
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-autovol-navy">{displayModule.serialNumber}</h2>
                                    <p className="text-gray-500">Build Sequence: {displayModule.buildSequence}</p>
                                </div>
                                <div className="flex gap-2">
                                    {editMode ? (
                                        <>
                                            <button onClick={handleSave} className="px-3 py-1 btn-secondary rounded">Save</button>
                                            <button onClick={() => { setEditMode(false); setEditingModule({ ...module }); }} className="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancel</button>
                                        </>
                                    ) : (
                                        <button onClick={() => setEditMode(true)} className="px-3 py-1 btn-primary rounded">Edit</button>
                                    )}
                                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                                </div>
                            </div>
                            
                            {/* Shop Drawing Button */}
                            <div className="mb-6">
                                <button
                                    onClick={handleOpenShopDrawing}
                                    className="w-full py-3 bg-autovol-navy text-white rounded-lg font-medium hover:bg-autovol-navy-light transition flex items-center justify-center gap-2"
                                >
                                    <span>üìê</span> Open Shop Drawing
                                </button>
                            </div>

                            {/* Dimensions */}
                            <div className="grid grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <span className="text-sm text-gray-500">Width</span>
                                    {editMode ? (
                                        <input type="number" value={displayModule.moduleWidth} onChange={(e) => updateField('moduleWidth', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                    ) : (
                                        <p className="font-semibold">{displayModule.moduleWidth}'</p>
                                    )}
                                </div>
                                <div>
                                    <span className="text-sm text-gray-500">Length</span>
                                    {editMode ? (
                                        <input type="number" value={displayModule.moduleLength} onChange={(e) => updateField('moduleLength', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                    ) : (
                                        <p className="font-semibold">{displayModule.moduleLength}'</p>
                                    )}
                                </div>
                                <div>
                                    <span className="text-sm text-gray-500">Square Footage</span>
                                    {editMode ? (
                                        <input type="number" value={displayModule.squareFootage} onChange={(e) => updateField('squareFootage', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                    ) : (
                                        <p className="font-semibold">{displayModule.squareFootage ? parseFloat(displayModule.squareFootage).toFixed(2) : '‚Äî'} SF</p>
                                    )}
                                </div>
                            </div>

                            {/* HITCH Details */}
                            <div className="mb-4">
                                <h3 className="font-semibold text-gray-700 mb-2">HITCH Side</h3>
                                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg text-sm">
                                    <div>
                                        <span className="text-gray-500">BLM ID</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.hitchBLM || ''} onChange={(e) => updateField('hitchBLM', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.hitchBLM}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Unit</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.hitchUnit || ''} onChange={(e) => updateField('hitchUnit', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.hitchUnit}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Room</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.hitchRoom || ''} onChange={(e) => updateField('hitchRoom', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.hitchRoom}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Room Type</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.hitchRoomType || ''} onChange={(e) => updateField('hitchRoomType', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.hitchRoomType}</p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* REAR Details */}
                            <div className="mb-4">
                                <h3 className="font-semibold text-gray-700 mb-2">REAR Side</h3>
                                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg text-sm">
                                    <div>
                                        <span className="text-gray-500">BLM ID</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.rearBLM || ''} onChange={(e) => updateField('rearBLM', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.rearBLM}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Unit</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.rearUnit || ''} onChange={(e) => updateField('rearUnit', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.rearUnit}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Room</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.rearRoom || ''} onChange={(e) => updateField('rearRoom', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.rearRoom}</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Room Type</span>
                                        {editMode ? (
                                            <input type="text" value={displayModule.rearRoomType || ''} onChange={(e) => updateField('rearRoomType', e.target.value)} className="w-full mt-1 px-2 py-1 border rounded" />
                                        ) : (
                                            <p className="font-medium">{displayModule.rearRoomType}</p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Difficulty Indicators */}
                            <div className="mb-4">
                                <h3 className="font-semibold text-gray-700 mb-2">Difficulty Indicators</h3>
                                <div className="flex flex-wrap gap-2">
                                    {Object.entries(difficultyLabels).map(([key, label]) => (
                                        <label key={key} className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${
                                            displayModule.difficulties?.[key] ? difficultyColors[key] : 'bg-gray-100'
                                        }`}>
                                            <input
                                                type="checkbox"
                                                checked={displayModule.difficulties?.[key] || false}
                                                onChange={(e) => {
                                                    if (editMode) {
                                                        setEditingModule(prev => ({
                                                            ...prev,
                                                            difficulties: { ...prev.difficulties, [key]: e.target.checked }
                                                        }));
                                                    }
                                                }}
                                                disabled={!editMode}
                                                className="rounded"
                                            />
                                            <span className="text-sm">{label}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Stage Progress */}
                            <div>
                                <h3 className="font-semibold text-gray-700 mb-2">Production Progress</h3>
                                <div className="space-y-2">
                                    {productionStages.map(stage => {
                                        const progress = displayModule.stageProgress?.[stage.id] || 0;
                                        return (
                                            <div key={stage.id} className="flex items-center gap-3">
                                                <span className="w-36 text-sm text-gray-600">{stage.name}</span>
                                                {editMode ? (
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="100"
                                                        step="25"
                                                        value={progress}
                                                        onChange={(e) => updateStageProgress(stage.id, e.target.value)}
                                                        className="flex-1"
                                                    />
                                                ) : (
                                                    <div className="flex-1 bg-gray-200 rounded-full h-3">
                                                        <div 
                                                            className={`h-3 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`}
                                                            style={{ width: `${progress}%` }}
                                                        />
                                                    </div>
                                                )}
                                                <span className="w-10 text-right text-sm">{progress}%</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Import Modal Component
        function ImportModal({ onClose, onImport }) {
            const [dragActive, setDragActive] = useState(false);
            const [preview, setPreview] = useState(null);
            const [error, setError] = useState(null);

            const handleFile = (file) => {
                setError(null);
                
                if (!file) {
                    setError('No file selected');
                    return;
                }
                
                console.log('Processing file:', file.name, file.type, file.size);
                
                const reader = new FileReader();
                reader.onerror = () => {
                    setError('Error reading file');
                };
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('File loaded, size:', data.length);
                        
                        if (typeof XLSX === 'undefined') {
                            setError('Excel library not loaded. Please refresh the page.');
                            return;
                        }
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook sheets:', workbook.SheetNames);
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        console.log('Rows found:', jsonData.length);
                        console.log('First row (headers):', jsonData[0]);
                        
                        if (jsonData.length < 2) {
                            setError('File must have at least a header row and one data row');
                            return;
                        }

                        const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
                        const modules = [];

                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0 || !row[0]) continue;

                            const getVal = (keywords) => {
                                for (const keyword of keywords) {
                                    const idx = headers.findIndex(h => h.includes(keyword.toLowerCase()));
                                    if (idx !== -1 && row[idx] !== undefined) return row[idx];
                                }
                                return '';
                            };

                            modules.push({
                                serialNumber: getVal(['serial']) || row[0],
                                buildSequence: getVal(['build', 'sequence']) || i,
                                moduleWidth: parseFloat(getVal(['width'])) || 0,
                                moduleLength: parseFloat(getVal(['length'])) || 0,
                                squareFootage: parseFloat(getVal(['square', 'sf', 'footage'])) || 0,
                                hitchBLM: getVal(['hitch blm', 'hitch_blm']) || getVal(['blm']) || '',
                                hitchUnit: getVal(['hitch unit', 'hitch_unit']) || getVal(['unit']) || '',
                                hitchRoom: getVal(['hitch room', 'hitch_room']) || '',
                                hitchRoomType: getVal(['hitch room type', 'hitch_room_type', 'hitch type']) || '',
                                rearBLM: getVal(['rear blm', 'rear_blm']) || '',
                                rearUnit: getVal(['rear unit', 'rear_unit']) || '',
                                rearRoom: getVal(['rear room', 'rear_room']) || '',
                                rearRoomType: getVal(['rear room type', 'rear_room_type', 'rear type']) || '',
                                difficulties: {
                                    sidewall: String(getVal(['sidewall'])).toLowerCase() === 'x' || String(getVal(['sidewall'])).toLowerCase() === 'true',
                                    stair: String(getVal(['stair'])).toLowerCase() === 'x' || String(getVal(['stair'])).toLowerCase() === 'true',
                                    hr3Wall: String(getVal(['3hr', '3 hr', 'three hr'])).toLowerCase() === 'x' || String(getVal(['3hr'])).toLowerCase() === 'true',
                                    short: String(getVal(['short'])).toLowerCase() === 'x' || String(getVal(['short'])).toLowerCase() === 'true',
                                    doubleStudio: String(getVal(['double', 'dbl studio'])).toLowerCase() === 'x' || String(getVal(['double studio'])).toLowerCase() === 'true',
                                    sawbox: String(getVal(['sawbox'])).toLowerCase() === 'x' || String(getVal(['sawbox'])).toLowerCase() === 'true'
                                },
                                isPrototype: String(getVal(['proto', 'prototype'])).toLowerCase() === 'x' || String(getVal(['proto', 'prototype'])).toLowerCase() === 'true'
                            });
                        }

                        if (modules.length === 0) {
                            setError('No valid modules found in file. Make sure your file has data rows after the header.');
                            console.log('No modules parsed from file');
                            return;
                        }

                        console.log('Successfully parsed', modules.length, 'modules');
                        setPreview({ modules, headers: jsonData[0] });
                    } catch (err) {
                        console.error('Import error:', err);
                        setError('Error reading file: ' + err.message + '. Check browser console for details.');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold">Import Modules from Excel</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>

                            {!preview ? (
                                <>
                                    <div
                                        className={`border-2 border-dashed rounded-lg p-12 text-center transition ${dragActive ? 'border-autovol-teal bg-autovol-teal-light' : 'border-gray-300'}`}
                                        onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                                        onDragLeave={() => setDragActive(false)}
                                        onDrop={(e) => { e.preventDefault(); setDragActive(false); handleFile(e.dataTransfer.files[0]); }}
                                    >
                                        <p className="text-gray-600 mb-2">Drag and drop your Excel file here, or</p>
                                        <label className="inline-block px-4 py-2 btn-primary rounded-lg cursor-pointer">
                                            Browse Files
                                            <input type="file" accept=".xlsx,.xls,.csv" className="hidden" onChange={(e) => handleFile(e.target.files[0])} />
                                        </label>
                                    </div>
                                    {error && <p className="text-red-600 mt-4">{error}</p>}
                                    
                                    <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                        <h3 className="font-semibold mb-2">Expected Columns:</h3>
                                        <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                            <span>‚Ä¢ Serial Number</span>
                                            <span>‚Ä¢ Build Sequence</span>
                                            <span>‚Ä¢ Module Width</span>
                                            <span>‚Ä¢ Module Length</span>
                                            <span>‚Ä¢ Square Footage</span>
                                            <span>‚Ä¢ HITCH BLM ID</span>
                                            <span>‚Ä¢ HITCH Unit</span>
                                            <span>‚Ä¢ HITCH Room</span>
                                            <span>‚Ä¢ HITCH Room Type</span>
                                            <span>‚Ä¢ REAR BLM ID</span>
                                            <span>‚Ä¢ REAR Unit</span>
                                            <span>‚Ä¢ REAR Room</span>
                                            <span>‚Ä¢ REAR Room Type</span>
                                            <span>‚Ä¢ Sidewall (X)</span>
                                            <span>‚Ä¢ Stair (X)</span>
                                            <span>‚Ä¢ 3HR-Wall (X)</span>
                                            <span>‚Ä¢ Short (X)</span>
                                            <span>‚Ä¢ Double Studio (X)</span>
                                            <span>‚Ä¢ Sawbox (X)</span>
                                            <span>‚Ä¢ Proto (X)</span>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <p className="text-green-800 font-medium">‚úì Found {preview.modules.length} modules to import</p>
                                    </div>
                                    
                                    <div className="overflow-x-auto max-h-64 mb-4">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th className="px-2 py-1 text-left">Serial #</th>
                                                    <th className="px-2 py-1 text-left">Build Seq</th>
                                                    <th className="px-2 py-1 text-left">Dimensions</th>
                                                    <th className="px-2 py-1 text-left">Hitch BLM</th>
                                                    <th className="px-2 py-1 text-left">Unit</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {preview.modules.slice(0, 10).map((m, i) => (
                                                    <tr key={i}>
                                                        <td className="px-2 py-1 font-medium">{m.serialNumber}</td>
                                                        <td className="px-2 py-1">{m.buildSequence}</td>
                                                        <td className="px-2 py-1">{m.moduleWidth}' x {m.moduleLength}'</td>
                                                        <td className="px-2 py-1">{m.hitchBLM}</td>
                                                        <td className="px-2 py-1">{m.hitchUnit}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {preview.modules.length > 10 && (
                                            <p className="text-sm text-gray-500 mt-2 text-center">...and {preview.modules.length - 10} more</p>
                                        )}
                                    </div>
                                    
                                    <div className="flex gap-2 justify-end">
                                        <button onClick={() => setPreview(null)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                                        <button onClick={() => onImport(preview.modules)} className="px-4 py-2 btn-primary rounded-lg">Import {preview.modules.length} Modules</button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // New Project Modal
        function NewProjectModal({ onClose, onSave }) {
            const [name, setName] = useState('');
            const [location, setLocation] = useState('');
            const [description, setDescription] = useState('');
            const [status, setStatus] = useState('Pre-Construction');
            const [sharepointSite, setSharepointSite] = useState('ProductDevelopmentAutovolPrefab');
            const [sharepointChannel, setSharepointChannel] = useState('');
            const [shopDrawingLinksText, setShopDrawingLinksText] = useState('');
            const [shopDrawingLinksError, setShopDrawingLinksError] = useState('');
            const [parsedLinksCount, setParsedLinksCount] = useState(0);
            
            // Parse shop drawing links from text input
            const parseShopDrawingLinks = (text) => {
                const links = {};
                const lines = text.split('\n').filter(line => line.trim());
                let errorMsg = '';
                
                for (const line of lines) {
                    // Support formats: "BLM, URL" or "BLM URL" or "BLM\tURL"
                    const parts = line.split(/[,\t]/).map(p => p.trim());
                    if (parts.length >= 2) {
                        const blm = parts[0];
                        const url = parts[1];
                        if (blm && url && url.startsWith('http')) {
                            links[blm] = url;
                        } else if (blm && !url.startsWith('http')) {
                            errorMsg = `Invalid URL for BLM "${blm}"`;
                        }
                    }
                }
                
                setShopDrawingLinksError(errorMsg);
                setParsedLinksCount(Object.keys(links).length);
                return links;
            };
            
            // Handle text change and parse
            const handleLinksTextChange = (text) => {
                setShopDrawingLinksText(text);
                parseShopDrawingLinks(text);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold">New Project</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Project Name *</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        placeholder="e.g., Building A - Phoenix"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Location *</label>
                                    <input
                                        type="text"
                                        value={location}
                                        onChange={(e) => setLocation(e.target.value)}
                                        placeholder="e.g., Phoenix, AZ"
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        placeholder="Phase 1 residential units..."
                                        rows={2}
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select
                                        value={status}
                                        onChange={(e) => setStatus(e.target.value)}
                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="Pre-Construction">Pre-Construction</option>
                                        <option value="Planned">Planned</option>
                                        <option value="Active">Active</option>
                                        <option value="Complete">Complete</option>
                                    </select>
                                </div>
                                
                                {/* SharePoint Integration */}
                                <div className="border-t pt-4 mt-4">
                                    <h3 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <span>üìã¬Å</span> SharePoint Integration
                                        <span className="text-xs font-normal text-gray-500">(for Shop Drawings)</span>
                                    </h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">SharePoint Site</label>
                                            <input
                                                type="text"
                                                value={sharepointSite}
                                                onChange={(e) => setSharepointSite(e.target.value)}
                                                placeholder="e.g., ProductDevelopmentAutovolPrefab"
                                                className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Site name from SharePoint URL</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Teams Channel Folder</label>
                                            <input
                                                type="text"
                                                value={sharepointChannel}
                                                onChange={(e) => setSharepointChannel(e.target.value)}
                                                placeholder="e.g., Alvarado Creek - San Diego, CA (TPC)"
                                                className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Exact channel name from Teams</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Shop Drawing Links */}
                                <div className="border-t pt-4 mt-4">
                                    <h3 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <span>üìê</span> Shop Drawing Links
                                        <span className="text-xs font-normal text-gray-500">(optional)</span>
                                    </h3>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">BLM / URL Mapping</label>
                                        <textarea
                                            value={shopDrawingLinksText}
                                            onChange={(e) => handleLinksTextChange(e.target.value)}
                                            placeholder="B1L2M39, https://sharepoint.com/..."
                                            rows={4}
                                            className="w-full px-3 py-2 border rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                        <div className="flex justify-between mt-1">
                                            <p className="text-xs text-gray-500">Format: BLM, URL (comma or tab separated)</p>
                                            {parsedLinksCount > 0 && (
                                                <p className="text-xs text-green-600 font-medium">{parsedLinksCount} links parsed</p>
                                            )}
                                        </div>
                                        {shopDrawingLinksError && (
                                            <p className="text-xs text-red-600 mt-1">{shopDrawingLinksError}</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 justify-end mt-6">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                                <button 
                                    onClick={() => onSave({ 
                                        name, 
                                        location, 
                                        description, 
                                        status, 
                                        sharepointSite, 
                                        sharepointChannel,
                                        shopDrawingLinks: parseShopDrawingLinks(shopDrawingLinksText)
                                    })}
                                    disabled={!name || !location}
                                    className="px-4 py-2 btn-primary rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Create Project
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // People Module Component
        function PeopleModule({ employees, setEmployees, departments, setDepartments, productionStages, isAdmin }) {
            const [activeView, setActiveView] = useState('directory');
            const [showEmployeeModal, setShowEmployeeModal] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [permissionFilter, setPermissionFilter] = useState('all');
            const [showInviteConfirm, setShowInviteConfirm] = useState(null);
            const [sortColumn, setSortColumn] = useState('name');
            const [sortDirection, setSortDirection] = useState('asc');
            
            // Department management state
            const [showDeptModal, setShowDeptModal] = useState(false);
            const [editingDept, setEditingDept] = useState(null);
            const [showDeleteDeptConfirm, setShowDeleteDeptConfirm] = useState(null);

            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };

            const getSortValue = (emp, column) => {
                switch(column) {
                    case 'name':
                        return [emp.lastName, emp.firstName].filter(Boolean).join(' ').toLowerCase();
                    case 'lastName':
                        return (emp.lastName || '').toLowerCase();
                    case 'jobTitle':
                        return (emp.jobTitle || '').toLowerCase();
                    case 'department':
                        return (emp.department || '').toLowerCase();
                    case 'shift':
                        return (emp.shift || '').toLowerCase();
                    case 'permissions':
                        const permOrder = { 'Admin': 0, 'User': 1, 'No Access': 2 };
                        return permOrder[emp.permissions] ?? 3;
                    case 'accessStatus':
                        const statusOrder = { 'active': 0, 'invited': 1, 'none': 2 };
                        return statusOrder[emp.accessStatus] ?? 3;
                    default:
                        return '';
                }
            };

            const filteredEmployees = employees.filter(e => {
                const fullName = [e.prefix, e.firstName, e.middleName, e.lastName, e.suffix]
                    .filter(Boolean).join(' ').toLowerCase();
                const matchesSearch = 
                    fullName.includes(searchTerm.toLowerCase()) ||
                    e.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    e.department?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    e.jobTitle?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    e.email?.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesPermission = permissionFilter === 'all' || e.permissions === permissionFilter;
                return matchesSearch && matchesPermission;
            }).sort((a, b) => {
                const aVal = getSortValue(a, sortColumn);
                const bVal = getSortValue(b, sortColumn);
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const SortHeader = ({ column, label }) => (
                <th 
                    className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200 select-none"
                    onClick={() => handleSort(column)}
                >
                    <div className="flex items-center gap-1">
                        {label}
                        <span className="text-gray-400">
                            {sortColumn === column ? (
                                sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'
                            ) : '‚áÖ'}
                        </span>
                    </div>
                </th>
            );

            const handleSaveEmployee = (employeeData) => {
                if (editingEmployee) {
                    setEmployees(employees.map(e => e.id === editingEmployee.id ? { ...e, ...employeeData } : e));
                } else {
                    setEmployees([...employees, { ...employeeData, id: Date.now(), accessStatus: 'none' }]);
                }
                setShowEmployeeModal(false);
                setEditingEmployee(null);
            };

            const handleDeleteEmployee = (id) => {
                if (confirm('Are you sure you want to remove this employee?')) {
                    setEmployees(employees.filter(e => e.id !== id));
                }
            };

            const handleSendInvite = (employee) => {
                const empName = [employee.prefix, employee.firstName, employee.middleName, employee.lastName, employee.suffix]
                    .filter(Boolean).join(' ') || employee.name || 'Employee';
                // Simulate sending invite
                setEmployees(employees.map(e => 
                    e.id === employee.id 
                        ? { ...e, accessStatus: 'invited', invitedAt: new Date().toISOString() } 
                        : e
                ));
                setShowInviteConfirm(null);
                alert(`Invite sent to ${empName} at ${employee.email}!\n\n(In production, this would send an actual email)`);
            };

            const handleResendInvite = (employee) => {
                const empName = [employee.prefix, employee.firstName, employee.middleName, employee.lastName, employee.suffix]
                    .filter(Boolean).join(' ') || employee.name || 'Employee';
                setEmployees(employees.map(e => 
                    e.id === employee.id 
                        ? { ...e, invitedAt: new Date().toISOString() } 
                        : e
                ));
                alert(`Invite resent to ${empName} at ${employee.email}!`);
            };

            const updateDepartmentSupervisor = (deptId, supervisorId) => {
                setDepartments(departments.map(d => 
                    d.id === deptId ? { ...d, supervisor: supervisorId } : d
                ));
            };

            // Department management functions
            const handleAddDepartment = () => {
                setEditingDept({ id: '', name: '', supervisor: null, linkedStationId: null });
                setShowDeptModal(true);
            };

            const handleEditDepartment = (dept) => {
                setEditingDept({ ...dept });
                setShowDeptModal(true);
            };

            const handleSaveDepartment = (deptData) => {
                if (editingDept.id) {
                    // Editing existing - also update employees if name changed
                    const oldName = departments.find(d => d.id === editingDept.id)?.name;
                    setDepartments(departments.map(d => 
                        d.id === editingDept.id ? { ...d, ...deptData } : d
                    ));
                    if (oldName && oldName !== deptData.name) {
                        setEmployees(employees.map(e => 
                            e.department === oldName ? { ...e, department: deptData.name } : e
                        ));
                    }
                } else {
                    // Adding new
                    const newDept = {
                        ...deptData,
                        id: deptData.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now(),
                        employeeCount: 0
                    };
                    setDepartments([...departments, newDept]);
                }
                setShowDeptModal(false);
                setEditingDept(null);
            };

            const handleDeleteDepartment = (dept) => {
                const deptEmployees = employees.filter(e => e.department === dept.name);
                if (deptEmployees.length > 0) {
                    // Has employees - show confirmation
                    setShowDeleteDeptConfirm(dept);
                } else {
                    // No employees - delete immediately
                    setDepartments(departments.filter(d => d.id !== dept.id));
                }
            };

            const confirmDeleteDepartment = () => {
                if (showDeleteDeptConfirm) {
                    // Unassign employees from this department
                    setEmployees(employees.map(e => 
                        e.department === showDeleteDeptConfirm.name ? { ...e, department: '' } : e
                    ));
                    // Delete the department
                    setDepartments(departments.filter(d => d.id !== showDeleteDeptConfirm.id));
                    setShowDeleteDeptConfirm(null);
                }
            };

            const getLinkedStationName = (stationId) => {
                if (!stationId || !productionStages) return null;
                const station = productionStages.find(s => s.id === stationId);
                return station ? station.dept : null;
            };

            // Permission counts
            const permissionCounts = {
                all: employees.length,
                'No Access': employees.filter(e => e.permissions === 'No Access' || !e.permissions).length,
                'User': employees.filter(e => e.permissions === 'User').length,
                'Admin': employees.filter(e => e.permissions === 'Admin').length
            };

            // Access status badge
            const getAccessBadge = (emp) => {
                if (emp.permissions === 'No Access' || !emp.permissions) {
                    return <span className="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">No Access</span>;
                }
                if (emp.accessStatus === 'invited') {
                    return <span className="px-2 py-0.5 text-xs rounded bg-yellow-100 text-yellow-800">Invited</span>;
                }
                if (emp.accessStatus === 'active') {
                    return <span className="px-2 py-0.5 text-xs rounded bg-green-100 text-green-800">Active</span>;
                }
                // Has permission but not invited yet
                return <span className="px-2 py-0.5 text-xs rounded bg-orange-100 text-orange-800">Pending Invite</span>;
            };

            // Permission badge
            const getPermissionBadge = (permission) => {
                if (permission === 'Admin') {
                    return <span className="px-2 py-0.5 text-xs rounded text-white" style={{backgroundColor: 'var(--autovol-red)'}}>Admin</span>;
                }
                if (permission === 'User') {
                    return <span className="px-2 py-0.5 text-xs rounded text-white" style={{backgroundColor: 'var(--autovol-teal)'}}>User</span>;
                }
                return <span className="px-2 py-0.5 text-xs rounded bg-gray-200 text-gray-600">No Access</span>;
            };

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-autovol-navy">People</h2>
                        <div className="flex gap-2">
                            <button
                                onClick={() => setActiveView('directory')}
                                className={`px-3 py-1 rounded ${activeView === 'directory' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                            >
                                Directory
                            </button>
                            <button
                                onClick={() => setActiveView('departments')}
                                className={`px-3 py-1 rounded ${activeView === 'departments' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                            >
                                Departments
                            </button>
                            <button
                                onClick={() => setActiveView('training')}
                                className={`px-3 py-1 rounded ${activeView === 'training' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                            >
                                Training
                            </button>
                        </div>
                    </div>

                    {activeView === 'training' ? (
                        <TrainingMatrixView 
                            employees={employees}
                            currentUser="Admin"
                            isAdmin={isAdmin}
                        />
                    ) : activeView === 'directory' ? (
                        <div className="space-y-4">
                            {/* Search, Filter, and Add */}
                            <div className="flex flex-wrap gap-4 items-center">
                                <input
                                    type="text"
                                    placeholder="Search by name, department, title, email..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="flex-1 min-w-64 px-3 py-2 border rounded-lg"
                                />
                                <select
                                    value={permissionFilter}
                                    onChange={(e) => setPermissionFilter(e.target.value)}
                                    className="px-3 py-2 border rounded-lg"
                                >
                                    <option value="all">All Permissions ({permissionCounts.all})</option>
                                    <option value="No Access">No Access ({permissionCounts['No Access']})</option>
                                    <option value="User">User ({permissionCounts['User']})</option>
                                    <option value="Admin">Admin ({permissionCounts['Admin']})</option>
                                </select>
                                <button
                                    onClick={() => { setEditingEmployee(null); setShowEmployeeModal(true); }}
                                    className="px-4 py-2 btn-primary rounded-lg"
                                >
                                    + Add Employee
                                </button>
                            </div>

                            <p className="text-sm text-gray-500">
                                Showing {filteredEmployees.length} of {employees.length} employees
                            </p>

                            {/* Employee List */}
                            <div className="bg-white rounded-lg shadow overflow-x-auto">
                                {filteredEmployees.length === 0 ? (
                                    <div className="p-8 text-center text-gray-500">
                                        No employees found. {employees.length === 0 && 'Click "Add Employee" to get started.'}
                                    </div>
                                ) : (
                                    <table className="w-full">
                                        <thead style={{backgroundColor: 'var(--autovol-gray-bg)'}}>
                                            <tr>
                                                <SortHeader column="name" label="Name" />
                                                <SortHeader column="jobTitle" label="Job Title" />
                                                <SortHeader column="department" label="Department" />
                                                <SortHeader column="shift" label="Shift" />
                                                <SortHeader column="permissions" label="Permissions" />
                                                <SortHeader column="accessStatus" label="Access Status" />
                                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {filteredEmployees.map(emp => {
                                                const fullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix]
                                                    .filter(Boolean).join(' ');
                                                return (
                                                <tr key={emp.id} className="hover:bg-gray-50">
                                                    <td className="px-4 py-3">
                                                        <div>
                                                            <p className="font-medium">{fullName || emp.name || 'Unnamed'}</p>
                                                            <p className="text-xs text-gray-500">{emp.email}</p>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm">{emp.jobTitle || '-'}</td>
                                                    <td className="px-4 py-3 text-sm">{emp.department || '-'}</td>
                                                    <td className="px-4 py-3 text-sm">{emp.shift || '-'}</td>
                                                    <td className="px-4 py-3">{getPermissionBadge(emp.permissions)}</td>
                                                    <td className="px-4 py-3">{getAccessBadge(emp)}</td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex gap-2 flex-wrap">
                                                            <button 
                                                                onClick={() => { setEditingEmployee(emp); setShowEmployeeModal(true); }}
                                                                className="text-sm hover:underline"
                                                                style={{color: 'var(--autovol-teal)'}}
                                                            >
                                                                Edit
                                                            </button>
                                                            {/* Show Send Invite for users with permission but not yet invited */}
                                                            {(emp.permissions === 'User' || emp.permissions === 'Admin') && 
                                                             emp.accessStatus !== 'invited' && emp.accessStatus !== 'active' && emp.email && (
                                                                <button 
                                                                    onClick={() => setShowInviteConfirm(emp)}
                                                                    className="text-sm hover:underline"
                                                                    style={{color: 'var(--autovol-red)'}}
                                                                >
                                                                    Send Invite
                                                                </button>
                                                            )}
                                                            {/* Show Resend for invited but not active */}
                                                            {emp.accessStatus === 'invited' && (
                                                                <button 
                                                                    onClick={() => handleResendInvite(emp)}
                                                                    className="text-sm text-orange-600 hover:underline"
                                                                >
                                                                    Resend
                                                                </button>
                                                            )}
                                                            <button 
                                                                onClick={() => handleDeleteEmployee(emp.id)}
                                                                className="text-sm text-gray-400 hover:text-red-600 hover:underline"
                                                            >
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ); })}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {/* Admin Add Button */}
                            {isAdmin && (
                                <div className="flex justify-end">
                                    <button
                                        onClick={handleAddDepartment}
                                        className="px-4 py-2 btn-primary rounded-lg flex items-center gap-2"
                                    >
                                        <span className="text-lg">+</span> Add Department
                                    </button>
                                </div>
                            )}
                            
                            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                                {departments.map(dept => {
                                    const supervisor = employees.find(e => e.id === dept.supervisor);
                                    const deptEmployees = employees.filter(e => e.department === dept.name);
                                    const linkedStation = productionStages.find(s => s.id === dept.linkedStationId);
                                    
                                    return (
                                        <div key={dept.id} className="bg-white rounded-lg shadow p-4">
                                            <div className="flex items-start justify-between mb-2">
                                                <h3 className="font-semibold text-gray-900">{dept.name}</h3>
                                                {isAdmin && (
                                                    <div className="flex gap-1">
                                                        <button
                                                            onClick={() => handleEditDepartment(dept)}
                                                            className="p-1 text-gray-400 hover:text-autovol-teal"
                                                            title="Edit department"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                            </svg>
                                                        </button>
                                                        <button
                                                            onClick={() => handleDeleteDepartment(dept)}
                                                            className="p-1 text-gray-400 hover:text-red-500"
                                                            title="Delete department"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="space-y-2 text-sm">
                                                {linkedStation && (
                                                    <div className="flex items-center gap-2">
                                                        <span className={`px-2 py-0.5 text-xs rounded ${linkedStation.color} text-white`}>
                                                            {linkedStation.dept}
                                                        </span>
                                                        <span className="text-gray-400 text-xs">Station Link</span>
                                                    </div>
                                                )}
                                                <div>
                                                    <span className="text-gray-500">Supervisor:</span>
                                                    <select
                                                        value={dept.supervisor || ''}
                                                        onChange={(e) => updateDepartmentSupervisor(dept.id, e.target.value || null)}
                                                        className="ml-2 px-2 py-1 border rounded text-sm"
                                                        disabled={!isAdmin}
                                                    >
                                                        <option value="">None assigned</option>
                                                        {employees.map(emp => {
                                                            const empFullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix]
                                                                .filter(Boolean).join(' ') || emp.name || 'Unnamed';
                                                            return (
                                                                <option key={emp.id} value={emp.id}>{empFullName}</option>
                                                            );
                                                        })}
                                                    </select>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Employees:</span>
                                                    <span className="ml-2 font-medium">{deptEmployees.length}</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Add/Edit Employee Modal */}
                    {showEmployeeModal && (
                        <EmployeeModal 
                            employee={editingEmployee}
                            onClose={() => { setShowEmployeeModal(false); setEditingEmployee(null); }}
                            onSave={handleSaveEmployee}
                            departments={departments}
                        />
                    )}

                    {/* Add/Edit Department Modal */}
                    {showDeptModal && editingDept && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowDeptModal(false); setEditingDept(null); }}>
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4" style={{color: 'var(--autovol-navy)'}}>
                                    {editingDept.id ? 'Edit Department' : 'Add Department'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Department Name *</label>
                                        <input
                                            type="text"
                                            value={editingDept.name}
                                            onChange={(e) => setEditingDept({ ...editingDept, name: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal"
                                            placeholder="e.g., Human Resources"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Linked Production Station</label>
                                        <select
                                            value={editingDept.linkedStationId || ''}
                                            onChange={(e) => setEditingDept({ ...editingDept, linkedStationId: e.target.value || null })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal"
                                        >
                                            <option value="">None (Non-Production)</option>
                                            {productionStages.map(stage => (
                                                <option key={stage.id} value={stage.id}>{stage.dept} - {stage.name}</option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-gray-500 mt-1">Link to a station on the Production Board for tracking</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Supervisor</label>
                                        <select
                                            value={editingDept.supervisor || ''}
                                            onChange={(e) => setEditingDept({ ...editingDept, supervisor: e.target.value || null })}
                                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal"
                                        >
                                            <option value="">None assigned</option>
                                            {employees.map(emp => {
                                                const empFullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix]
                                                    .filter(Boolean).join(' ') || emp.name || 'Unnamed';
                                                return <option key={emp.id} value={emp.id}>{empFullName}</option>;
                                            })}
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-2 justify-end mt-6">
                                    <button 
                                        onClick={() => { setShowDeptModal(false); setEditingDept(null); }}
                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => handleSaveDepartment(editingDept)}
                                        disabled={!editingDept.name.trim()}
                                        className="px-4 py-2 btn-primary rounded-lg disabled:opacity-50"
                                    >
                                        {editingDept.id ? 'Save Changes' : 'Add Department'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Department Confirmation Modal */}
                    {showDeleteDeptConfirm && (() => {
                        const deptEmployees = employees.filter(e => e.department === showDeleteDeptConfirm.name);
                        return (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowDeleteDeptConfirm(null)}>
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-2 text-red-600">Delete Department</h3>
                                <p className="text-gray-600 mb-4">
                                    Are you sure you want to delete <strong>{showDeleteDeptConfirm.name}</strong>?
                                </p>
                                {deptEmployees.length > 0 && (
                                    <div className="p-3 rounded-lg mb-4 bg-yellow-50 border border-yellow-200">
                                        <p className="text-sm text-yellow-800 font-medium">
                                            ‚ö† Warning: This department has {deptEmployees.length} employee{deptEmployees.length !== 1 ? 's' : ''} assigned.
                                        </p>
                                        <p className="text-xs text-yellow-700 mt-1">
                                            They will be unassigned from this department but not deleted.
                                        </p>
                                    </div>
                                )}
                                {showDeleteDeptConfirm.linkedStationId && (
                                    <div className="p-3 rounded-lg mb-4 bg-blue-50 border border-blue-200">
                                        <p className="text-sm text-blue-800">
                                            This department is linked to a production station. The station board will not be affected.
                                        </p>
                                    </div>
                                )}
                                <div className="flex gap-2 justify-end">
                                    <button 
                                        onClick={() => setShowDeleteDeptConfirm(null)}
                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={confirmDeleteDepartment}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                    >
                                        Delete Department
                                    </button>
                                </div>
                            </div>
                        </div>
                        );
                    })()}

                    {/* Invite Confirmation Modal */}
                    {showInviteConfirm && (() => {
                        const inviteeName = [showInviteConfirm.prefix, showInviteConfirm.firstName, showInviteConfirm.middleName, showInviteConfirm.lastName, showInviteConfirm.suffix]
                            .filter(Boolean).join(' ') || showInviteConfirm.name || 'this employee';
                        return (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowInviteConfirm(null)}>
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-2" style={{color: 'var(--autovol-navy)'}}>Send Invite</h3>
                                <p className="text-gray-600 mb-4">
                                    Send MODA access invite to <strong>{inviteeName}</strong>?
                                </p>
                                <p className="text-sm text-gray-500 mb-4">
                                    An email will be sent to: <strong>{showInviteConfirm.email}</strong>
                                </p>
                                <div className="p-3 rounded-lg mb-4" style={{backgroundColor: 'var(--autovol-gray-bg)'}}>
                                    <p className="text-sm">
                                        <span className="text-gray-500">Permission Level:</span>{' '}
                                        <span className="font-medium">{showInviteConfirm.permissions}</span>
                                    </p>
                                </div>
                                <div className="flex gap-2 justify-end">
                                    <button 
                                        onClick={() => setShowInviteConfirm(null)}
                                        className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => handleSendInvite(showInviteConfirm)}
                                        className="px-4 py-2 btn-primary rounded-lg"
                                    >
                                        Send Invite
                                    </button>
                                </div>
                            </div>
                        </div>
                        );
                    })()}
                </div>
            );
        }

        // Employee Modal (Add/Edit)
        function EmployeeModal({ employee, onClose, onSave, departments }) {
            const [formData, setFormData] = useState({
                prefix: employee?.prefix || '',
                firstName: employee?.firstName || '',
                middleName: employee?.middleName || '',
                lastName: employee?.lastName || '',
                suffix: employee?.suffix || '',
                jobTitle: employee?.jobTitle || '',
                department: employee?.department || '',
                shift: employee?.shift || 'Shift-A',
                hireDate: employee?.hireDate || '',
                email: employee?.email || '',
                phone: employee?.phone || '',
                permissions: employee?.permissions || 'No Access',
                accessStatus: employee?.accessStatus || 'none'
            });

            const [showInvitePrompt, setShowInvitePrompt] = useState(false);

            const handlePermissionChange = (newPermission) => {
                const wasNoAccess = formData.permissions === 'No Access' || !formData.permissions;
                const nowHasAccess = newPermission === 'User' || newPermission === 'Admin';
                
                setFormData({ ...formData, permissions: newPermission });
                
                // Show invite prompt when upgrading from No Access to User/Admin
                if (wasNoAccess && nowHasAccess && formData.email) {
                    setShowInvitePrompt(true);
                } else {
                    setShowInvitePrompt(false);
                }
            };

            const handleSubmit = () => {
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold" style={{color: 'var(--autovol-navy)'}}>
                                    {employee ? 'Edit Employee' : 'Add Employee'}
                                </h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <div className="space-y-4">
                                {/* Row 1: Prefix, First Name, Middle Name */}
                                <div className="grid grid-cols-6 gap-3">
                                    <div className="col-span-1">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Prefix</label>
                                        <select
                                            value={formData.prefix}
                                            onChange={(e) => setFormData({ ...formData, prefix: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        >
                                            <option value=""></option>
                                            <option value="Mr.">Mr.</option>
                                            <option value="Mrs.">Mrs.</option>
                                            <option value="Ms.">Ms.</option>
                                            <option value="Dr.">Dr.</option>
                                        </select>
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                        <input
                                            type="text"
                                            value={formData.firstName}
                                            onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Middle Name</label>
                                        <input
                                            type="text"
                                            value={formData.middleName}
                                            onChange={(e) => setFormData({ ...formData, middleName: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="col-span-1">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Suffix</label>
                                        <select
                                            value={formData.suffix}
                                            onChange={(e) => setFormData({ ...formData, suffix: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        >
                                            <option value=""></option>
                                            <option value="Jr.">Jr.</option>
                                            <option value="Sr.">Sr.</option>
                                            <option value="II">II</option>
                                            <option value="III">III</option>
                                            <option value="IV">IV</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Row 2: Last Name, Job Title */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                        <input
                                            type="text"
                                            value={formData.lastName}
                                            onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                                        <input
                                            type="text"
                                            value={formData.jobTitle}
                                            onChange={(e) => setFormData({ ...formData, jobTitle: e.target.value })}
                                            placeholder="e.g., Framer, Electrician"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>

                                {/* Row 2: Department */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Department *</label>
                                    <select
                                        value={formData.department}
                                        onChange={(e) => setFormData({ ...formData, department: e.target.value })}
                                        className="w-full px-3 py-2 border rounded-lg"
                                    >
                                        <option value="">Select department...</option>
                                        {departments.map(d => (
                                            <option key={d.id} value={d.name}>{d.name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* Row 3: Shift, Hire Date */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                                        <select
                                            value={formData.shift}
                                            onChange={(e) => setFormData({ ...formData, shift: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        >
                                            <option value="Shift-A">Shift-A (Mon-Thu)</option>
                                            <option value="Shift-B">Shift-B (Fri-Sun)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Hire Date</label>
                                        <input
                                            type="date"
                                            value={formData.hireDate}
                                            onChange={(e) => setFormData({ ...formData, hireDate: e.target.value })}
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>

                                {/* Row 4: Email, Phone */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                            placeholder="email@autovol.com"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input
                                            type="tel"
                                            value={formData.phone}
                                            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                            placeholder="(555) 123-4567"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>

                                {/* Permissions */}
                                <div className="border-t pt-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">MODA Permissions</label>
                                    <div className="flex gap-2">
                                        {['No Access', 'User', 'Admin'].map(perm => (
                                            <button
                                                key={perm}
                                                type="button"
                                                onClick={() => handlePermissionChange(perm)}
                                                className={`flex-1 px-3 py-2 rounded-lg border-2 text-sm font-medium transition ${
                                                    formData.permissions === perm
                                                        ? perm === 'Admin' 
                                                            ? 'border-red-500 bg-red-50 text-red-700'
                                                            : perm === 'User'
                                                                ? 'border-teal-500 bg-teal-50 text-teal-700'
                                                                : 'border-gray-400 bg-gray-100 text-gray-700'
                                                        : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300'
                                                }`}
                                            >
                                                {perm}
                                            </button>
                                        ))}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">
                                        {formData.permissions === 'No Access' && 'Employee is in directory only - no MODA login access'}
                                        {formData.permissions === 'User' && 'Can view and update production data in MODA'}
                                        {formData.permissions === 'Admin' && 'Full MODA access including user management'}
                                    </p>

                                    {/* Invite Prompt */}
                                    {showInvitePrompt && (
                                        <div className="mt-3 p-3 rounded-lg" style={{backgroundColor: 'var(--autovol-red-light)'}}>
                                            <p className="text-sm" style={{color: 'var(--autovol-red)'}}>
                                                <strong>Note:</strong> After saving, you'll be able to send an invite to this employee's email.
                                            </p>
                                        </div>
                                    )}
                                    
                                    {!formData.email && (formData.permissions === 'User' || formData.permissions === 'Admin') && (
                                        <div className="mt-3 p-3 rounded-lg bg-yellow-50">
                                            <p className="text-sm text-yellow-800">
                                                <strong>Note:</strong> Add an email address to enable sending invites.
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex gap-2 justify-end mt-6">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button 
                                    onClick={handleSubmit}
                                    disabled={!formData.firstName || !formData.lastName}
                                    className="px-4 py-2 btn-primary rounded-lg disabled:opacity-50"
                                >
                                    {employee ? 'Save Changes' : 'Add Employee'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render App
        // Main App with Authentication
        
        // ============================================================================
        // TRANSPORTATION MODULE - Integrated
        // ============================================================================

    // ============================================================================
    // MODA TRANSPORTATION MODULE - AV STYLE
    // ============================================================================

    const COLORS = {
      red: '#E31B23',
      blue: '#1E3A5F',
      charcoal: '#1E3A5F',
      lightGray: '#F5F6FA',
      white: '#FFFFFF',
      success: '#10B981',
      warning: '#F59E0B',
      info: '#3B82F6',
    };

    // Transport Stage SVG Icons (black, 16x16)
    const TransportIcon = ({ type, size = 16, color = 'currentColor' }) => {
      const icons = {
        ready: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M7,7H17V5H19V19H5V5H7V7M12,17V15H17V17H12M7,17V15H9V17H7M7,13V11H9V13H7M10,13V11H17V13H10Z"/></svg>,
        staged: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A2.25,2.25 0 0,1 14.25,11A2.25,2.25 0 0,1 12,13.25A2.25,2.25 0 0,1 9.75,11A2.25,2.25 0 0,1 12,8.75M12,15C14.67,15 20,16.34 20,19V20H4V19C4,16.34 9.33,15 12,15Z"/></svg>,
        scheduledTransit: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M19,4H5A2,2 0 0,0 3,6V18A2,2 0 0,0 5,20H19A2,2 0 0,0 21,18V6A2,2 0 0,0 19,4M19,18H5V8H19V18M17,10H7V12H17V10M15,14H7V16H15V14Z"/></svg>,
        scheduledShuttle: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4M18.32,5.68A10,10 0 0,0 12,2V4A8,8 0 0,1 18.32,5.68M20,12A8,8 0 0,1 12,20V22A10,10 0 0,0 22,12H20M5.68,18.32A8,8 0 0,1 4,12H2A10,10 0 0,0 5.68,18.32M12,20A8,8 0 0,1 5.68,18.32L4.27,19.73A10,10 0 0,0 12,22V20M18.32,18.32L19.73,19.73A10,10 0 0,0 22,12H20A8,8 0 0,1 18.32,18.32Z"/></svg>,
        inTransit: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5M19.5,9.5L21.46,12H17V9.5M6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5M20,8H17V4H3C1.89,4 1,4.89 1,6V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V12L20,8Z"/></svg>,
        arrived: <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/></svg>
      };
      return <span style={{ display: 'inline-flex', alignItems: 'center', verticalAlign: 'middle' }}>{icons[type]}</span>;
    };

    const TRANSPORT_STAGES = [
      { id: 'ready', label: 'Ready for Yard', color: '#6366F1', iconType: 'ready' },
      { id: 'staged', label: 'Staged in Yard', color: '#8B5CF6', iconType: 'staged' },
      { id: 'scheduledTransit', label: 'Scheduled for Transit', color: '#EC4899', iconType: 'scheduledTransit' },
      { id: 'scheduledShuttle', label: 'Scheduled for Shuttle', color: '#F97316', iconType: 'scheduledShuttle' },
      { id: 'inTransit', label: 'In-Transit', color: '#0EA5E9', iconType: 'inTransit' },
      { id: 'arrived', label: 'Arrived to Site', color: '#10B981', iconType: 'arrived' },
    ];

    const DEFAULT_YARDS = [
      { id: 'front', name: 'Front Yard', address: 'Autovol Property - Main Entrance', isAutovol: true },
      { id: 'back', name: 'Back Yard', address: 'Autovol Property - Rear Lot', isAutovol: true },
      { id: 'northside', name: 'Northside', address: '', isAutovol: false },
      { id: 'cherry', name: 'Cherry', address: '', isAutovol: false },
      { id: 'barger', name: 'Barger', address: '', isAutovol: false },
      { id: 'westervelt', name: 'Westervelt', address: '', isAutovol: false },
      { id: 'transit', name: 'Transit', address: 'Temporary Hold', isAutovol: false },
    ];

    const SAMPLE_COMPANIES = [
      { id: 'tc1', name: 'Mountain West Transport', address: '1234 Industrial Blvd, Nampa, ID 83687', phone: '(208) 555-0101', contact: 'Mike Johnson', contactPhone: '(208) 555-0102', email: 'dispatch@mwt.com' },
      { id: 'tc2', name: 'Pacific Modular Hauling', address: '5678 Highway 20, Caldwell, ID 83605', phone: '(208) 555-0201', contact: 'Sarah Williams', contactPhone: '(208) 555-0202', email: 'sarah@pmhauling.com' },
    ];

    const SAMPLE_MODULES = [
      { id: 'm1', moduleId: '24-505-A1-01', blm: 'BLM-1001', project: 'Riverside Apartments', stage: 'ready', yardId: null, transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm2', moduleId: '24-505-A1-02', blm: 'BLM-1002', project: 'Riverside Apartments', stage: 'ready', yardId: null, transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm3', moduleId: '24-505-B2-01', blm: 'BLM-1003', project: 'Riverside Apartments', stage: 'staged', yardId: 'front', transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm4', moduleId: '24-612-A1-01', blm: 'BLM-2001', project: 'Downtown Lofts', stage: 'staged', yardId: 'northside', transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm5', moduleId: '24-612-A1-02', blm: 'BLM-2002', project: 'Downtown Lofts', stage: 'scheduledTransit', yardId: 'back', transportCompanyId: 'tc1', scheduledDate: '2025-01-20', notes: 'Morning delivery preferred' },
      { id: 'm6', moduleId: '24-612-B1-01', blm: 'BLM-2003', project: 'Downtown Lofts', stage: 'inTransit', yardId: null, transportCompanyId: 'tc2', scheduledDate: '2025-01-18', departureTime: '2025-01-18T07:30:00', notes: '' },
      { id: 'm7', moduleId: '24-505-C1-01', blm: 'BLM-1004', project: 'Riverside Apartments', stage: 'arrived', yardId: null, transportCompanyId: 'tc1', scheduledDate: '2025-01-15', arrivalTime: '2025-01-15T14:22:00', notes: 'Signed off by foreman' },
      { id: 'm8', moduleId: '24-505-C1-02', blm: 'BLM-1005', project: 'Riverside Apartments', stage: 'ready', yardId: null, transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm9', moduleId: '24-612-C2-01', blm: 'BLM-2004', project: 'Downtown Lofts', stage: 'staged', yardId: 'cherry', transportCompanyId: null, scheduledDate: null, notes: '' },
      { id: 'm10', moduleId: '24-718-A1-01', blm: 'BLM-3001', project: 'Harbor View', stage: 'scheduledShuttle', yardId: 'barger', transportCompanyId: 'tc1', scheduledDate: '2025-01-22', notes: 'Moving to Front Yard' },
    ];

    // LocalStorage Keys
    const STORAGE_KEYS = {
      modules: 'autovol_transport_modules',
      yards: 'autovol_transport_yards',
      companies: 'autovol_transport_companies',
    };

    function TransportApp() {
      const [activeView, setActiveView] = useState('board');
      const [modules, setModules] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEYS.modules);
        return saved ? JSON.parse(saved) : SAMPLE_MODULES;
      });
      const [yards, setYards] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEYS.yards);
        return saved ? JSON.parse(saved) : DEFAULT_YARDS;
      });
      const [companies, setCompanies] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEYS.companies);
        return saved ? JSON.parse(saved) : SAMPLE_COMPANIES;
      });
      const [selectedModule, setSelectedModule] = useState(null);
      const [showAddYard, setShowAddYard] = useState(false);
      const [showAddCompany, setShowAddCompany] = useState(false);
      const [filterProject, setFilterProject] = useState('all');
      const [editingYard, setEditingYard] = useState(null);
      const [editingCompany, setEditingCompany] = useState(null);

      // Save to localStorage
      useEffect(() => { localStorage.setItem(STORAGE_KEYS.modules, JSON.stringify(modules)); }, [modules]);
      useEffect(() => { localStorage.setItem(STORAGE_KEYS.yards, JSON.stringify(yards)); }, [yards]);
      useEffect(() => { localStorage.setItem(STORAGE_KEYS.companies, JSON.stringify(companies)); }, [companies]);

      // Sync from unified layer - import modules marked "Ready for Yard" from Station Board
      useEffect(() => {
        const syncFromUnified = () => {
          if (typeof MODA_UNIFIED === 'undefined') return;
          
          // Get modules in YARD phase (production complete, waiting in staging yard)
          const yardModules = MODA_UNIFIED.getByPhase('yard');
          // Also get modules in transport phase (already scheduled)
          const transportModules = MODA_UNIFIED.getByPhase('transport');
          const allTransportModules = [...yardModules, ...transportModules];
          
          // Check for modules not yet in our transport list
          allTransportModules.forEach(unified => {
            const existsInTransport = modules.some(m => 
              m.moduleId === unified.serialNumber || m.id === unified.id
            );
            
            if (!existsInTransport) {
              console.log(`[Transport] Auto-importing ${unified.serialNumber} from Station Board (phase: ${unified.currentPhase})`);
              setModules(prev => [...prev, {
                id: unified.id,
                moduleId: unified.serialNumber,
                blm: unified.specs?.blmHitch || '',
                project: unified.projectName || 'Unknown',
                stage: 'ready',
                yardId: null,
                transportCompanyId: null,
                scheduledDate: null,
                notes: `Auto-imported from Station Board on ${new Date().toLocaleDateString()}`,
                importedAt: new Date().toISOString()
              }]);
            }
          });
        };
        
        // Run sync on mount and periodically
        syncFromUnified();
        const interval = setInterval(syncFromUnified, 10000); // Check every 10 seconds
        return () => clearInterval(interval);
      }, [modules]);

      const projects = [...new Set(modules.map(m => m.project))];
      const filteredModules = filterProject === 'all' ? modules : modules.filter(m => m.project === filterProject);
      const modulesByStage = TRANSPORT_STAGES.reduce((acc, stage) => {
        acc[stage.id] = filteredModules.filter(m => m.stage === stage.id);
        return acc;
      }, {});

      const updateModuleStage = (moduleId, newStage, additionalData = {}) => {
        setModules(prev => prev.map(m => {
          if (m.id === moduleId) {
            const { stage: oldStage, ...dataWithoutStage } = additionalData;
            const updated = { ...m, ...dataWithoutStage, stage: newStage };
            if (newStage === 'inTransit') updated.departureTime = new Date().toISOString();
            if (newStage === 'arrived') updated.arrivalTime = new Date().toISOString();
            return updated;
          }
          return m;
        }));
        setSelectedModule(null);
      };

      const addYard = (yard) => {
        setYards(prev => [...prev, { ...yard, id: `yard-${Date.now()}` }]);
        setShowAddYard(false);
      };

      const updateYard = (yardId, updates) => {
        setYards(prev => prev.map(y => y.id === yardId ? { ...y, ...updates } : y));
        setEditingYard(null);
      };

      const deleteYard = (yardId) => {
        if (modules.some(m => m.yardId === yardId)) {
          alert('Cannot delete yard with modules staged there. Move modules first.');
          return;
        }
        setYards(prev => prev.filter(y => y.id !== yardId));
      };

      const addCompany = (company) => {
        setCompanies(prev => [...prev, { ...company, id: `tc-${Date.now()}` }]);
        setShowAddCompany(false);
      };

      const updateCompany = (companyId, updates) => {
        setCompanies(prev => prev.map(c => c.id === companyId ? { ...c, ...updates } : c));
        setEditingCompany(null);
      };

      const deleteCompany = (companyId) => {
        if (modules.some(m => m.transportCompanyId === companyId)) {
          alert('Cannot delete company with assigned modules. Reassign modules first.');
          return;
        }
        setCompanies(prev => prev.filter(c => c.id !== companyId));
      };

      const getCompanyName = (id) => companies.find(c => c.id === id)?.name || 'Unassigned';
      const getYardName = (id) => yards.find(y => y.id === id)?.name || 'Not Staged';

      // ============================================================================
      // STYLES - AV BRANDED
      // ============================================================================
      
      const styles = {
        header: {
          background: COLORS.charcoal,
          padding: '12px 32px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          borderBottom: `4px solid ${COLORS.red}`,
          position: 'sticky',
          top: 0,
          zIndex: 100,
        },
        logo: { display: 'flex', alignItems: 'center', gap: '12px' },
        logoIcon: {
          width: '44px',
          height: '44px',
          background: `linear-gradient(135deg, ${COLORS.red} 0%, ${COLORS.blue} 100%)`,
          borderRadius: '10px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: COLORS.white,
          fontWeight: '800',
          fontSize: '20px',
          fontFamily: "'Inter', sans-serif",
        },
        nav: {
          display: 'flex',
          gap: '4px',
          background: 'rgba(255,255,255,0.1)',
          padding: '4px',
          borderRadius: '8px',
        },
        navBtn: (active) => ({
          padding: '10px 22px',
          background: active ? COLORS.blue : 'transparent',
          color: active ? COLORS.white : 'rgba(255,255,255,0.7)',
          border: 'none',
          borderRadius: '6px',
          cursor: 'pointer',
          fontWeight: '600',
          fontSize: '13px',
          fontFamily: "'Inter', sans-serif",
          transition: 'all 0.2s ease',
        }),
        main: { padding: '24px 32px', maxWidth: '1800px', margin: '0 auto' },
        statsBar: { display: 'flex', gap: '12px', marginBottom: '20px' },
        statCard: (color) => ({
          padding: '14px 22px',
          background: COLORS.white,
          borderRadius: '10px',
          borderLeft: `4px solid ${color}`,
          display: 'flex',
          alignItems: 'center',
          gap: '14px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        }),
        boardContainer: {
          display: 'grid',
          gridTemplateColumns: 'repeat(6, 1fr)',
          gap: '16px',
          alignItems: 'start',
        },
        stageColumn: {
          background: COLORS.white,
          borderRadius: '10px',
          overflow: 'hidden',
          boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        },
        stageHeader: (color) => ({
          padding: '14px 16px',
          background: color,
          color: COLORS.white,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }),
        stageBody: { padding: '12px', maxHeight: '600px', overflowY: 'auto' },
        moduleCard: {
          background: COLORS.lightGray,
          borderRadius: '8px',
          padding: '14px',
          marginBottom: '10px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          borderLeft: '3px solid transparent',
        },
        btn: (variant = 'primary') => ({
          padding: '10px 18px',
          background: variant === 'primary' ? COLORS.blue : variant === 'danger' ? COLORS.red : COLORS.lightGray,
          color: variant === 'secondary' ? COLORS.charcoal : COLORS.white,
          border: 'none',
          borderRadius: '6px',
          cursor: 'pointer',
          fontWeight: '600',
          fontSize: '13px',
          fontFamily: "'Inter', sans-serif",
          transition: 'all 0.2s ease',
        }),
        table: {
          width: '100%',
          borderCollapse: 'collapse',
          background: COLORS.white,
          borderRadius: '10px',
          overflow: 'hidden',
          boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        },
        th: {
          padding: '14px 16px',
          textAlign: 'left',
          background: COLORS.charcoal,
          color: COLORS.white,
          fontWeight: '600',
          fontSize: '13px',
          fontFamily: "'Inter', sans-serif",
        },
        td: { 
          padding: '14px 16px', 
          borderBottom: '1px solid #eee', 
          fontSize: '13px',
          fontFamily: "'Inter', sans-serif",
        },
        modal: {
          position: 'fixed',
          inset: 0,
          background: 'rgba(45, 52, 54, 0.6)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
        },
        modalContent: {
          background: COLORS.white,
          borderRadius: '12px',
          width: '100%',
          maxWidth: '560px',
          maxHeight: '85vh',
          overflow: 'auto',
          boxShadow: '0 25px 60px rgba(0,0,0,0.3)',
          borderTop: `4px solid ${COLORS.blue}`,
        },
        modalHeader: {
          padding: '20px 24px',
          borderBottom: '1px solid #eee',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
        },
        modalBody: { padding: '24px' },
        input: {
          width: '100%',
          padding: '12px 14px',
          borderRadius: '6px',
          border: '1px solid #ddd',
          fontSize: '14px',
          fontFamily: "'Inter', sans-serif",
          boxSizing: 'border-box',
          transition: 'all 0.2s ease',
        },
        label: {
          display: 'block',
          marginBottom: '6px',
          fontWeight: '600',
          fontSize: '13px',
          color: COLORS.charcoal,
          fontFamily: "'Inter', sans-serif",
        },
        fieldGroup: { marginBottom: '16px' },
      };

      // ============================================================================
      // COMPONENTS
      // ============================================================================

      const ModuleCard = ({ module }) => {
        const [hovered, setHovered] = useState(false);
        return (
          <div
            onClick={() => setSelectedModule(module)}
            onMouseEnter={() => setHovered(true)}
            onMouseLeave={() => setHovered(false)}
            style={{
              ...styles.moduleCard,
              background: hovered ? '#e8eaed' : COLORS.lightGray,
              borderLeftColor: hovered ? COLORS.blue : 'transparent',
              transform: hovered ? 'translateX(3px)' : 'none',
              boxShadow: hovered ? '0 2px 8px rgba(0,87,184,0.1)' : 'none',
            }}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '6px' }}>
              <span style={{ fontWeight: '700', fontSize: '14px', color: COLORS.charcoal, fontFamily: "'JetBrains Mono', monospace" }}>{module.moduleId}</span>
              {module.scheduledDate && (
                <span style={{ fontSize: '11px', color: COLORS.red, fontWeight: '600' }}>
                  {new Date(module.scheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                </span>
              )}
            </div>
            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px', fontFamily: "'JetBrains Mono', monospace" }}>{module.blm}</div>
            <div style={{ fontSize: '12px', color: COLORS.blue, fontWeight: '600' }}>{module.project}</div>
            {module.yardId && (
              <div style={{ fontSize: '11px', color: '#888', marginTop: '8px' }}>üìã¬ç {getYardName(module.yardId)}</div>
            )}
            {module.transportCompanyId && (
              <div style={{ fontSize: '11px', color: '#888' }}>üöõ {getCompanyName(module.transportCompanyId)}</div>
            )}
          </div>
        );
      };

      const StageColumn = ({ stage, modules }) => (
        <div style={styles.stageColumn}>
          <div style={styles.stageHeader(stage.color)}>
            <span style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '700', fontSize: '13px' }}>
              <TransportIcon type={stage.iconType} color="white" /> {stage.label}
            </span>
            <span style={{
              background: 'rgba(255,255,255,0.25)',
              padding: '3px 12px',
              borderRadius: '12px',
              fontSize: '12px',
              fontWeight: '700',
            }}>
              {modules.length}
            </span>
          </div>
          <div style={styles.stageBody}>
            {modules.map(m => <ModuleCard key={m.id} module={m} />)}
            {modules.length === 0 && (
              <div style={{ textAlign: 'center', padding: '30px 10px', color: '#999', fontSize: '12px' }}>
                No modules
              </div>
            )}
          </div>
        </div>
      );

      const BoardView = () => (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <label style={{ fontWeight: '600', color: COLORS.charcoal, fontSize: '13px' }}>Project Filter:</label>
              <select
                value={filterProject}
                onChange={e => setFilterProject(e.target.value)}
                style={{ ...styles.input, width: '240px' }}
              >
                <option value="all">All Projects ({modules.length} modules)</option>
                {projects.map(p => (
                  <option key={p} value={p}>{p} ({modules.filter(m => m.project === p).length})</option>
                ))}
              </select>
            </div>
            <div style={styles.statsBar}>
              <div style={styles.statCard(COLORS.info)}>
                <span style={{ fontSize: '28px', fontWeight: '700', color: COLORS.info }}>
                  {modules.filter(m => m.stage === 'inTransit').length}
                </span>
                <span style={{ fontSize: '12px', color: '#666', fontWeight: '500' }}>In Transit</span>
              </div>
              <div style={styles.statCard(COLORS.warning)}>
                <span style={{ fontSize: '28px', fontWeight: '700', color: COLORS.warning }}>
                  {modules.filter(m => m.stage === 'scheduledTransit' || m.stage === 'scheduledShuttle').length}
                </span>
                <span style={{ fontSize: '12px', color: '#666', fontWeight: '500' }}>Scheduled</span>
              </div>
              <div style={styles.statCard(COLORS.success)}>
                <span style={{ fontSize: '28px', fontWeight: '700', color: COLORS.success }}>
                  {modules.filter(m => m.stage === 'arrived').length}
                </span>
                <span style={{ fontSize: '12px', color: '#666', fontWeight: '500' }}>Delivered</span>
              </div>
            </div>
          </div>
          <div style={styles.boardContainer}>
            {TRANSPORT_STAGES.map(stage => (
              <StageColumn key={stage.id} stage={stage} modules={modulesByStage[stage.id]} />
            ))}
          </div>
        </div>
      );

      const YardsView = () => (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ margin: 0, color: COLORS.charcoal, fontSize: '22px', fontWeight: '700' }}>Staging Yards Directory</h2>
            <button 
              onClick={() => setShowAddYard(true)} 
              style={styles.btn('primary')}
              onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
              onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
            >
              + Add Yard
            </button>
          </div>
          <table style={styles.table}>
            <thead>
              <tr>
                <th style={styles.th}>Yard Name</th>
                <th style={styles.th}>Address</th>
                <th style={styles.th}>Type</th>
                <th style={{ ...styles.th, textAlign: 'center' }}>Modules Staged</th>
                <th style={{ ...styles.th, width: '140px' }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {yards.map((yard, idx) => {
                const moduleCount = modules.filter(m => m.yardId === yard.id).length;
                return (
                  <tr key={yard.id} style={{ background: idx % 2 === 0 ? COLORS.white : '#fafafa' }}>
                    <td style={{ ...styles.td, fontWeight: '600', color: COLORS.charcoal }}>{yard.name}</td>
                    <td style={styles.td}>{yard.address || '‚Äì'}</td>
                    <td style={styles.td}>
                      {yard.isAutovol ? (
                        <span style={{
                          background: COLORS.red,
                          color: COLORS.white,
                          padding: '4px 12px',
                          borderRadius: '4px',
                          fontSize: '11px',
                          fontWeight: '700',
                        }}>AUTOVOL</span>
                      ) : (
                        <span style={{ color: '#666' }}>External</span>
                      )}
                    </td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      <span style={{
                        background: moduleCount > 0 ? COLORS.blue : '#eee',
                        color: moduleCount > 0 ? COLORS.white : '#999',
                        padding: '5px 16px',
                        borderRadius: '14px',
                        fontWeight: '700',
                        fontSize: '13px',
                      }}>
                        {moduleCount}
                      </span>
                    </td>
                    <td style={styles.td}>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button onClick={() => setEditingYard(yard)} style={{ ...styles.btn('secondary'), padding: '6px 12px' }}>Edit</button>
                        <button onClick={() => deleteYard(yard.id)} style={{ ...styles.btn('danger'), padding: '6px 12px' }}>Delete</button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      );

      const CompaniesView = () => (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ margin: 0, color: COLORS.charcoal, fontSize: '22px', fontWeight: '700' }}>Transport Companies Directory</h2>
            <button 
              onClick={() => setShowAddCompany(true)} 
              style={styles.btn('primary')}
              onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
              onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
            >
              + Add Company
            </button>
          </div>
          <table style={styles.table}>
            <thead>
              <tr>
                <th style={styles.th}>Company Name</th>
                <th style={styles.th}>Address</th>
                <th style={styles.th}>Office Phone</th>
                <th style={styles.th}>Contact</th>
                <th style={styles.th}>Contact Phone</th>
                <th style={{ ...styles.th, textAlign: 'center' }}>Scheduled</th>
                <th style={{ ...styles.th, textAlign: 'center' }}>In Transit</th>
                <th style={{ ...styles.th, textAlign: 'center' }}>Delivered</th>
                <th style={{ ...styles.th, width: '140px' }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {companies.map((company, idx) => {
                const assigned = modules.filter(m => m.transportCompanyId === company.id);
                const scheduled = assigned.filter(m => m.stage === 'scheduledTransit' || m.stage === 'scheduledShuttle').length;
                const inTransit = assigned.filter(m => m.stage === 'inTransit').length;
                const delivered = assigned.filter(m => m.stage === 'arrived').length;
                return (
                  <tr key={company.id} style={{ background: idx % 2 === 0 ? COLORS.white : '#fafafa' }}>
                    <td style={{ ...styles.td, fontWeight: '600', color: COLORS.charcoal }}>üöõ {company.name}</td>
                    <td style={{ ...styles.td, fontSize: '12px' }}>{company.address}</td>
                    <td style={{ ...styles.td, fontFamily: "'JetBrains Mono', monospace", fontSize: '12px' }}>{company.phone}</td>
                    <td style={styles.td}>{company.contact}</td>
                    <td style={{ ...styles.td, fontFamily: "'JetBrains Mono', monospace", fontSize: '12px' }}>{company.contactPhone || '‚Äì'}</td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      <span style={{ color: scheduled > 0 ? COLORS.warning : '#999', fontWeight: '700' }}>{scheduled}</span>
                    </td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      <span style={{ color: inTransit > 0 ? COLORS.info : '#999', fontWeight: '700' }}>{inTransit}</span>
                    </td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      <span style={{ color: delivered > 0 ? COLORS.success : '#999', fontWeight: '700' }}>{delivered}</span>
                    </td>
                    <td style={styles.td}>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button onClick={() => setEditingCompany(company)} style={{ ...styles.btn('secondary'), padding: '6px 12px' }}>Edit</button>
                        <button onClick={() => deleteCompany(company.id)} style={{ ...styles.btn('danger'), padding: '6px 12px' }}>Delete</button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      );

      const HistoryView = () => {
        const arrivedModules = modules.filter(m => m.stage === 'arrived').sort((a, b) => 
          new Date(b.arrivalTime || 0) - new Date(a.arrivalTime || 0)
        );
        return (
          <div>
            <h2 style={{ margin: '0 0 20px 0', color: COLORS.charcoal, fontSize: '22px', fontWeight: '700' }}>Shipment History</h2>
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>Module ID</th>
                  <th style={styles.th}>BLM</th>
                  <th style={styles.th}>Project</th>
                  <th style={styles.th}>Transport Company</th>
                  <th style={styles.th}>Scheduled Date</th>
                  <th style={styles.th}>Departure Time</th>
                  <th style={styles.th}>Arrival Time</th>
                  <th style={styles.th}>Notes</th>
                </tr>
              </thead>
              <tbody>
                {arrivedModules.map((module, idx) => (
                  <tr key={module.id} style={{ background: idx % 2 === 0 ? COLORS.white : '#fafafa' }}>
                    <td style={{ ...styles.td, fontWeight: '600', fontFamily: "'JetBrains Mono', monospace" }}>{module.moduleId}</td>
                    <td style={{ ...styles.td, fontFamily: "'JetBrains Mono', monospace", color: '#666' }}>{module.blm}</td>
                    <td style={{ ...styles.td, color: COLORS.blue, fontWeight: '600' }}>{module.project}</td>
                    <td style={styles.td}>{getCompanyName(module.transportCompanyId)}</td>
                    <td style={styles.td}>{module.scheduledDate ? new Date(module.scheduledDate).toLocaleDateString() : '‚Äì'}</td>
                    <td style={styles.td}>{module.departureTime ? new Date(module.departureTime).toLocaleString() : '‚Äì'}</td>
                    <td style={{ ...styles.td, color: COLORS.success, fontWeight: '600' }}>{module.arrivalTime ? new Date(module.arrivalTime).toLocaleString() : '‚Äì'}</td>
                    <td style={{ ...styles.td, fontSize: '12px', color: '#666' }}>{module.notes || '‚Äì'}</td>
                  </tr>
                ))}
                {arrivedModules.length === 0 && (
                  <tr>
                    <td colSpan={8} style={{ ...styles.td, textAlign: 'center', padding: '50px', color: '#999' }}>
                      No completed shipments yet
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        );
      };

      // Module Detail Modal
      const ModuleModal = () => {
        const [localModule, setLocalModule] = useState({ ...selectedModule });
        const [shuttleDestinationYardId, setShuttleDestinationYardId] = useState(selectedModule?.shuttleDestinationYardId || '');
        
        const handleSave = () => {
          setModules(prev => prev.map(m => m.id === localModule.id ? localModule : m));
          setSelectedModule(null);
        };
        
        // Validate shuttle destination - must be off-property yard
        const validateShuttleDestination = () => {
          if (!shuttleDestinationYardId) {
            return { valid: false, error: 'Please select a destination yard for the shuttle' };
          }
          const destinationYard = yards.find(y => y.id === shuttleDestinationYardId);
          if (destinationYard?.isAutovol) {
            return { valid: false, error: 'Shuttles are for moving modules to off-property yards. Please select an external yard location.' };
          }
          return { valid: true };
        };
        
        const getNextStages = () => {
          const stages = [];
          if (localModule.stage === 'ready') stages.push({ id: 'staged', label: 'Move to Yard', requiresYard: true });
          if (localModule.stage === 'staged') {
            stages.push({ id: 'scheduledTransit', label: 'Schedule for Transit', requiresCompany: true, requiresDate: true });
            stages.push({ id: 'scheduledShuttle', label: 'Schedule for Shuttle', requiresDate: true, requiresShuttleDestination: true });
          }
          if (localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') stages.push({ id: 'inTransit', label: 'Mark In-Transit' });
          if (localModule.stage === 'inTransit') stages.push({ id: 'arrived', label: 'Mark Arrived to Site' });
          return stages;
        };
        const currentStage = TRANSPORT_STAGES.find(s => s.id === localModule.stage);

        return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, borderTop: `4px solid ${currentStage?.color || COLORS.blue}` }}>
              <div style={{ ...styles.modalHeader, background: currentStage?.color, color: COLORS.white }}>
                <div>
                  <h2 style={{ margin: 0, fontSize: '18px', fontFamily: "'JetBrains Mono', monospace" }}>{localModule.moduleId}</h2>
                  <p style={{ margin: '4px 0 0 0', opacity: 0.9, fontSize: '13px' }}>{localModule.blm} ‚Ä¢ {localModule.project}</p>
                </div>
                <button onClick={() => setSelectedModule(null)} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', color: COLORS.white, width: '34px', height: '34px', borderRadius: '8px', cursor: 'pointer', fontSize: '16px', fontWeight: '600' }}>‚úï</button>
              </div>
              <div style={styles.modalBody}>
                <div style={{ padding: '16px 18px', background: currentStage?.color + '12', borderRadius: '10px', marginBottom: '20px', borderLeft: `4px solid ${currentStage?.color}` }}>
                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px', fontWeight: '600', textTransform: 'uppercase' }}>Current Status</div>
                  <div style={{ fontSize: '18px', fontWeight: '700', color: COLORS.charcoal }}>{currentStage?.iconType && <TransportIcon type={currentStage.iconType} size={20} />} {currentStage?.label}</div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  {(localModule.stage === 'ready' || localModule.stage === 'staged') && (
                    <div style={styles.fieldGroup}>
                      <label style={styles.label}>Staging Yard</label>
                      <select value={localModule.yardId || ''} onChange={e => setLocalModule({ ...localModule, yardId: e.target.value })} style={styles.input}>
                        <option value="">-- Select Yard --</option>
                        {yards.map(y => <option key={y.id} value={y.id}>{y.name} {y.isAutovol ? '(Autovol)' : ''}</option>)}
                      </select>
                    </div>
                  )}
                  {(localModule.stage === 'staged' || localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') && (
                    <div style={styles.fieldGroup}>
                      <label style={styles.label}>Transport Company</label>
                      <select value={localModule.transportCompanyId || ''} onChange={e => setLocalModule({ ...localModule, transportCompanyId: e.target.value })} style={styles.input}>
                        <option value="">-- Select Company --</option>
                        {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                      </select>
                    </div>
                  )}
                  {(localModule.stage === 'staged' || localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') && (
                    <div style={styles.fieldGroup}>
                      <label style={styles.label}>Scheduled Date</label>
                      <input type="date" value={localModule.scheduledDate || ''} onChange={e => setLocalModule({ ...localModule, scheduledDate: e.target.value })} style={styles.input} />
                    </div>
                  )}
                  {localModule.stage === 'staged' && (
                    <div style={styles.fieldGroup}>
                      <label style={styles.label}>Shuttle Destination Yard</label>
                      <select value={shuttleDestinationYardId} onChange={e => setShuttleDestinationYardId(e.target.value)} style={styles.input}>
                        <option value="">-- Select Destination --</option>
                        {yards.filter(y => !y.isAutovol).map(y => <option key={y.id} value={y.id}>{y.name}</option>)}
                      </select>
                      <p style={{ fontSize: '11px', color: '#888', marginTop: '4px' }}>Required for shuttle (off-property yards only)</p>
                    </div>
                  )}
                </div>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Notes</label>
                  <textarea value={localModule.notes || ''} onChange={e => setLocalModule({ ...localModule, notes: e.target.value })} placeholder="Delivery instructions, special handling notes..." rows={3} style={{ ...styles.input, resize: 'vertical' }} />
                </div>
                {getNextStages().length > 0 && (
                  <div style={{ borderTop: '1px solid #eee', paddingTop: '20px', marginTop: '8px' }}>
                    <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Quick Actions</div>
                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                      {getNextStages().map(nextStage => {
                        const stageInfo = TRANSPORT_STAGES.find(s => s.id === nextStage.id);
                        return (
                          <button
                            key={nextStage.id}
                            onClick={() => {
                              if (nextStage.requiresYard && !localModule.yardId) { alert('Please select a yard first'); return; }
                              if (nextStage.requiresCompany && !localModule.transportCompanyId) { alert('Please select a transport company first'); return; }
                              if (nextStage.requiresDate && !localModule.scheduledDate) { alert('Please set a scheduled date first'); return; }
                              if (nextStage.requiresShuttleDestination) {
                                const validation = validateShuttleDestination();
                                if (!validation.valid) { alert(validation.error); return; }
                              }
                              updateModuleStage(localModule.id, nextStage.id, { ...localModule, shuttleDestinationYardId });
                            }}
                            style={{ padding: '12px 20px', background: stageInfo?.color || COLORS.blue, color: COLORS.white, border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px', transition: 'all 0.2s ease' }}
                            onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'; }}
                            onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                          >
                            {stageInfo?.iconType && <TransportIcon type={stageInfo.iconType} color="white" />} {nextStage.label}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}
                <div style={{ display: 'flex', gap: '12px', marginTop: '24px', paddingTop: '16px', borderTop: '1px solid #eee' }}>
                  <button onClick={() => setSelectedModule(null)} style={{ ...styles.btn('secondary'), flex: 1 }}>Cancel</button>
                  <button 
                    onClick={handleSave} 
                    style={{ ...styles.btn('primary'), flex: 1 }}
                    onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
                    onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Add Yard Modal
      const AddYardModal = () => {
        const [newYard, setNewYard] = useState({ name: '', address: '', isAutovol: false });
        return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: '450px' }}>
              <div style={styles.modalHeader}>
                <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: COLORS.charcoal }}>Add Staging Yard</h2>
                <button onClick={() => setShowAddYard(false)} style={{ background: 'none', border: 'none', fontSize: '22px', cursor: 'pointer', color: '#666' }}>‚úï</button>
              </div>
              <div style={styles.modalBody}>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Yard Name *</label>
                  <input type="text" value={newYard.name} onChange={e => setNewYard({ ...newYard, name: e.target.value })} placeholder="e.g., East Lot" style={styles.input} />
                </div>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Address</label>
                  <input type="text" value={newYard.address} onChange={e => setNewYard({ ...newYard, address: e.target.value })} placeholder="Full address..." style={styles.input} />
                </div>
                <div style={{ ...styles.fieldGroup, marginBottom: '24px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                    <input type="checkbox" checked={newYard.isAutovol} onChange={e => setNewYard({ ...newYard, isAutovol: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: COLORS.red }} />
                    <span style={{ fontSize: '14px', fontWeight: '500' }}>Autovol Property</span>
                  </label>
                </div>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button onClick={() => setShowAddYard(false)} style={{ ...styles.btn('secondary'), flex: 1 }}>Cancel</button>
                  <button 
                    onClick={() => newYard.name && addYard(newYard)} 
                    style={{ ...styles.btn('primary'), flex: 1 }}
                    onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
                    onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                  >
                    Add Yard
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Edit Yard Modal
      const EditYardModal = () => {
        const [editedYard, setEditedYard] = useState({ ...editingYard });
        return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: '450px' }}>
              <div style={styles.modalHeader}>
                <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: COLORS.charcoal }}>Edit Yard</h2>
                <button onClick={() => setEditingYard(null)} style={{ background: 'none', border: 'none', fontSize: '22px', cursor: 'pointer', color: '#666' }}>‚úï</button>
              </div>
              <div style={styles.modalBody}>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Yard Name *</label>
                  <input type="text" value={editedYard.name} onChange={e => setEditedYard({ ...editedYard, name: e.target.value })} style={styles.input} />
                </div>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Address</label>
                  <input type="text" value={editedYard.address} onChange={e => setEditedYard({ ...editedYard, address: e.target.value })} style={styles.input} />
                </div>
                <div style={{ ...styles.fieldGroup, marginBottom: '24px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                    <input type="checkbox" checked={editedYard.isAutovol} onChange={e => setEditedYard({ ...editedYard, isAutovol: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: COLORS.red }} />
                    <span style={{ fontSize: '14px', fontWeight: '500' }}>Autovol Property</span>
                  </label>
                </div>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button onClick={() => setEditingYard(null)} style={{ ...styles.btn('secondary'), flex: 1 }}>Cancel</button>
                  <button 
                    onClick={() => updateYard(editedYard.id, editedYard)} 
                    style={{ ...styles.btn('primary'), flex: 1 }}
                    onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
                    onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Add Company Modal
      const AddCompanyModal = () => {
        const [newCompany, setNewCompany] = useState({ name: '', address: '', phone: '', contact: '', contactPhone: '', email: '' });
        return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: '560px' }}>
              <div style={styles.modalHeader}>
                <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: COLORS.charcoal }}>Add Transport Company</h2>
                <button onClick={() => setShowAddCompany(false)} style={{ background: 'none', border: 'none', fontSize: '22px', cursor: 'pointer', color: '#666' }}>‚úï</button>
              </div>
              <div style={styles.modalBody}>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Company Name *</label>
                  <input type="text" value={newCompany.name} onChange={e => setNewCompany({ ...newCompany, name: e.target.value })} placeholder="Company name..." style={styles.input} />
                </div>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Address</label>
                  <input type="text" value={newCompany.address} onChange={e => setNewCompany({ ...newCompany, address: e.target.value })} placeholder="Full address..." style={styles.input} />
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Office Phone</label>
                    <input type="tel" value={newCompany.phone} onChange={e => setNewCompany({ ...newCompany, phone: e.target.value })} placeholder="(208) 555-0000" style={styles.input} />
                  </div>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Email</label>
                    <input type="email" value={newCompany.email} onChange={e => setNewCompany({ ...newCompany, email: e.target.value })} placeholder="dispatch@company.com" style={styles.input} />
                  </div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '8px' }}>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Contact Name</label>
                    <input type="text" value={newCompany.contact} onChange={e => setNewCompany({ ...newCompany, contact: e.target.value })} placeholder="Primary contact..." style={styles.input} />
                  </div>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Contact Phone</label>
                    <input type="tel" value={newCompany.contactPhone} onChange={e => setNewCompany({ ...newCompany, contactPhone: e.target.value })} placeholder="(208) 555-0000" style={styles.input} />
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', marginTop: '16px' }}>
                  <button onClick={() => setShowAddCompany(false)} style={{ ...styles.btn('secondary'), flex: 1 }}>Cancel</button>
                  <button 
                    onClick={() => newCompany.name && addCompany(newCompany)} 
                    style={{ ...styles.btn('primary'), flex: 1 }}
                    onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
                    onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                  >
                    Add Company
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Edit Company Modal
      const EditCompanyModal = () => {
        const [editedCompany, setEditedCompany] = useState({ ...editingCompany });
        return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: '560px' }}>
              <div style={styles.modalHeader}>
                <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: COLORS.charcoal }}>Edit Company</h2>
                <button onClick={() => setEditingCompany(null)} style={{ background: 'none', border: 'none', fontSize: '22px', cursor: 'pointer', color: '#666' }}>‚úï</button>
              </div>
              <div style={styles.modalBody}>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Company Name *</label>
                  <input type="text" value={editedCompany.name} onChange={e => setEditedCompany({ ...editedCompany, name: e.target.value })} style={styles.input} />
                </div>
                <div style={styles.fieldGroup}>
                  <label style={styles.label}>Address</label>
                  <input type="text" value={editedCompany.address} onChange={e => setEditedCompany({ ...editedCompany, address: e.target.value })} style={styles.input} />
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Office Phone</label>
                    <input type="tel" value={editedCompany.phone} onChange={e => setEditedCompany({ ...editedCompany, phone: e.target.value })} style={styles.input} />
                  </div>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Email</label>
                    <input type="email" value={editedCompany.email} onChange={e => setEditedCompany({ ...editedCompany, email: e.target.value })} style={styles.input} />
                  </div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '8px' }}>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Contact Name</label>
                    <input type="text" value={editedCompany.contact} onChange={e => setEditedCompany({ ...editedCompany, contact: e.target.value })} style={styles.input} />
                  </div>
                  <div style={styles.fieldGroup}>
                    <label style={styles.label}>Contact Phone</label>
                    <input type="tel" value={editedCompany.contactPhone} onChange={e => setEditedCompany({ ...editedCompany, contactPhone: e.target.value })} style={styles.input} />
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', marginTop: '16px' }}>
                  <button onClick={() => setEditingCompany(null)} style={{ ...styles.btn('secondary'), flex: 1 }}>Cancel</button>
                  <button 
                    onClick={() => updateCompany(editedCompany.id, editedCompany)} 
                    style={{ ...styles.btn('primary'), flex: 1 }}
                    onMouseOver={e => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)'; }}
                    onMouseOut={e => { e.target.style.transform = 'none'; e.target.style.boxShadow = 'none'; }}
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ============================================================================
      // MAIN RENDER
      // ============================================================================

      return (
        <div className="p-6">
          {/* Internal Navigation */}
          <div className="flex gap-2 mb-6 border-b border-gray-200">
            {[
              { id: 'board', label: 'üöõ Transport Board' },
              { id: 'yards', label: 'üèóÔ∏è Staging Yards' },
              { id: 'companies', label: 'üöö Transport Companies' },
              { id: 'history', label: 'üìã‚Äπ Shipment History' },
            ].map(tab => (
              <button 
                key={tab.id} 
                onClick={() => setActiveView(tab.id)} 
                className={`px-4 py-3 font-semibold text-sm transition-all ${
                  activeView === tab.id 
                    ? 'text-white bg-autovol-red border-b-2 border-autovol-red' 
                    : 'text-autovol-navy hover:text-autovol-red'
                }`}
                style={{
                  borderBottom: activeView === tab.id ? '3px solid var(--autovol-red)' : '3px solid transparent',
                }}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* Content Area */}
          <div>
            {activeView === 'board' && <BoardView />}
            {activeView === 'yards' && <YardsView />}
            {activeView === 'companies' && <CompaniesView />}
            {activeView === 'history' && <HistoryView />}
          </div>

          {/* Modals */}
          {selectedModule && <ModuleModal />}
          {showAddYard && <AddYardModal />}
          {editingYard && <EditYardModal />}
          {showAddCompany && <AddCompanyModal />}
          {editingCompany && <EditCompanyModal />}
        </div>
      );
    }

        // ============================================================================
        // EQUIPMENT MODULE - Integrated
        // ============================================================================

        // Sample People/Departments Data (would come from People module)
        const equipmentSamplePeople = [
            { id: 'EMP-001', name: 'John Martinez', department: 'Framing' },
            { id: 'EMP-002', name: 'Sarah Johnson', department: 'Electrical' },
            { id: 'EMP-003', name: 'Mike Chen', department: 'Plumbing' },
            { id: 'EMP-004', name: 'Lisa Anderson', department: 'Framing' },
            { id: 'EMP-005', name: 'Robert Williams', department: 'Finishing' },
            { id: 'EMP-006', name: 'Emily Davis', department: 'HVAC' },
            { id: 'EMP-007', name: 'James Wilson', department: 'Welding' },
            { id: 'EMP-008', name: 'Maria Garcia', department: 'Assembly' },
        ];

        const equipmentDepartments = [
            'Framing', 'Electrical', 'Plumbing', 'HVAC', 'Finishing', 
            'Welding', 'Assembly', 'Quality Control', 'Maintenance', 
            'Automation', 'Drywall', 'Roofing', 'Tool Crib'
        ];

        // Initial Equipment Data
        const equipmentInitialData = [
            {
                id: 'TOOL-0001',
                name: 'DeWalt 20V Impact Driver',
                type: 'Tool',
                category: 'Power Tools',
                partNumber: 'DCF887B',
                serialId: 'DW-2024-0001',
                location: 'Station 5',
                status: 'Active',
                toolStatus: 'Present',
                assignmentType: 'Individual',
                assignedTo: 'John Martinez',
                department: 'Framing',
                purchaseDate: '2024-03-15',
                cost: 179.99,
                vendor: 'Home Depot',
                warranty: '2027-03-15',
                isSparePart: false,
                quantity: 1,
                notes: 'Primary impact driver for framing crew',
                assignmentHistory: [
                    { date: '2024-03-15', type: 'Individual', assignedTo: 'John Martinez', department: 'Framing', action: 'Initial Assignment' }
                ],
                loanInfo: null
            },
            {
                id: 'TOOL-0002',
                name: 'Milwaukee M18 Circular Saw',
                type: 'Tool',
                category: 'Power Tools',
                partNumber: '2631-20',
                serialId: 'MW-2024-0015',
                location: 'Tool Crib',
                status: 'Active',
                toolStatus: 'Loaned',
                assignmentType: 'Department',
                assignedTo: null,
                department: 'Tool Crib',
                purchaseDate: '2024-01-20',
                cost: 249.00,
                vendor: 'Grainger',
                warranty: '2027-01-20',
                isSparePart: false,
                quantity: 1,
                notes: 'Loaned to Electrical for special project',
                assignmentHistory: [
                    { date: '2024-01-20', type: 'Department', assignedTo: null, department: 'Tool Crib', action: 'Initial Assignment' }
                ],
                loanInfo: {
                    loanedTo: 'Sarah Johnson',
                    loanedToDept: 'Electrical',
                    loanDate: '2024-11-15',
                    expectedReturn: '2024-12-01',
                    reason: 'Panel installation project'
                }
            },
            {
                id: 'TOOL-0003',
                name: 'Makita Reciprocating Saw',
                type: 'Tool',
                category: 'Power Tools',
                partNumber: 'XRJ05Z',
                serialId: 'MK-2023-0042',
                location: 'Unknown',
                status: 'Active',
                toolStatus: 'Missing',
                assignmentType: 'Individual',
                assignedTo: 'Mike Chen',
                department: 'Plumbing',
                purchaseDate: '2023-08-10',
                cost: 199.00,
                vendor: 'Home Depot',
                warranty: '2026-08-10',
                isSparePart: false,
                quantity: 1,
                notes: 'Last seen at Station 12',
                assignmentHistory: [
                    { date: '2023-08-10', type: 'Individual', assignedTo: 'Mike Chen', department: 'Plumbing', action: 'Initial Assignment' }
                ],
                loanInfo: null,
                missingInfo: {
                    reportedDate: '2024-11-01',
                    reportedBy: 'Mike Chen',
                    lastKnownLocation: 'Station 12',
                    notes: 'Was using during pipe fitting, cannot locate after lunch break'
                }
            },
            {
                id: 'TOOL-0004',
                name: 'Bosch Rotary Hammer',
                type: 'Tool',
                category: 'Power Tools',
                partNumber: 'GBH18V-26DK15',
                serialId: 'BO-2024-0008',
                location: 'Maintenance Shop',
                status: 'Active',
                toolStatus: 'Warranty/Repair',
                assignmentType: 'Department',
                assignedTo: null,
                department: 'Maintenance',
                purchaseDate: '2024-02-28',
                cost: 449.00,
                vendor: 'Fastenal',
                warranty: '2027-02-28',
                isSparePart: false,
                quantity: 1,
                notes: 'Sent for repair - chuck issue',
                assignmentHistory: [
                    { date: '2024-02-28', type: 'Department', assignedTo: null, department: 'Maintenance', action: 'Initial Assignment' }
                ],
                loanInfo: null,
                repairInfo: {
                    sentDate: '2024-11-10',
                    vendor: 'Bosch Service Center',
                    issue: 'Chuck not holding bits properly',
                    expectedReturn: '2024-11-25',
                    ticketNumber: 'BSC-2024-1142'
                }
            }
        ];

        const equipmentInitialVendors = [
            { id: 'VEND-0001', name: 'Home Depot', contactPerson: 'Commercial Desk', phone: '(208) 555-0100', email: 'commercial@homedepot.com', website: 'www.homedepot.com', categories: ['Power Tools', 'Hand Tools'], paymentTerms: 'Net 30', preferred: true, notes: 'Local store' },
            { id: 'VEND-0002', name: 'Grainger', contactPerson: 'John Smith', phone: '(800) 555-0200', email: 'jsmith@grainger.com', website: 'www.grainger.com', categories: ['Industrial Supplies', 'Power Tools'], paymentTerms: 'Net 30', preferred: true, notes: 'Fast shipping' },
            { id: 'VEND-0003', name: 'Fastenal', contactPerson: 'Branch Manager', phone: '(208) 555-0400', email: 'nampa@fastenal.com', website: 'www.fastenal.com', categories: ['Fasteners', 'Power Tools'], paymentTerms: 'Net 30', preferred: false, notes: 'Vending on-site' },
        ];

        // Main App
        function EquipmentApp() {
            const [activeTab, setActiveTab] = useState('equipment');
            const [equipment, setEquipment] = useState([]);
            const [vendors, setVendors] = useState([]);
            const [inventoryLogs, setInventoryLogs] = useState([]);
            const [missingResolutions, setMissingResolutions] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [showEquipmentModal, setShowEquipmentModal] = useState(false);
            const [showVendorModal, setShowVendorModal] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('All');
            const [filterStatus, setFilterStatus] = useState('All');
            const [filterToolStatus, setFilterToolStatus] = useState('All');

            // Load data
            useEffect(() => {
                const savedEquipment = localStorage.getItem('modaEquipmentV2');
                const savedVendors = localStorage.getItem('modaVendorsV2');
                const savedLogs = localStorage.getItem('modaInventoryLogs');
                const savedResolutions = localStorage.getItem('modaMissingResolutions');
                
                setEquipment(savedEquipment ? JSON.parse(savedEquipment) : equipmentInitialData);
                setVendors(savedVendors ? JSON.parse(savedVendors) : equipmentInitialVendors);
                setInventoryLogs(savedLogs ? JSON.parse(savedLogs) : []);
                setMissingResolutions(savedResolutions ? JSON.parse(savedResolutions) : []);
            }, []);

            // Save data
            useEffect(() => {
                if (equipment.length > 0) localStorage.setItem('modaEquipmentV2', JSON.stringify(equipment));
            }, [equipment]);

            useEffect(() => {
                if (vendors.length > 0) localStorage.setItem('modaVendorsV2', JSON.stringify(vendors));
            }, [vendors]);

            useEffect(() => {
                localStorage.setItem('modaInventoryLogs', JSON.stringify(inventoryLogs));
            }, [inventoryLogs]);

            useEffect(() => {
                localStorage.setItem('modaMissingResolutions', JSON.stringify(missingResolutions));
            }, [missingResolutions]);

            // Notification system
            const showNotification = (message, type = 'info') => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== id));
                }, 4000);
            };

            // Check for duplicate Serial ID
            const isSerialIdDuplicate = (serialId, excludeId = null) => {
                return equipment.some(e => 
                    e.serialId && 
                    e.serialId.toLowerCase() === serialId.toLowerCase() && 
                    e.id !== excludeId
                );
            };

            // Equipment CRUD
            const addEquipment = (item) => {
                if (item.serialId && isSerialIdDuplicate(item.serialId)) {
                    showNotification(`‚ö† Duplicate Serial ID: ${item.serialId} already exists!`, 'error');
                    return false;
                }
                const newItem = {
                    ...item,
                    id: item.id || `TOOL-${String(equipment.length + 1).padStart(4, '0')}`,
                    assignmentHistory: [{
                        date: new Date().toISOString().split('T')[0],
                        type: item.assignmentType,
                        assignedTo: item.assignedTo,
                        department: item.department,
                        action: 'Initial Assignment'
                    }]
                };
                setEquipment([...equipment, newItem]);
                showNotification(`‚úÖ Equipment added: ${item.name}`, 'success');
                return true;
            };

            const updateEquipment = (item) => {
                if (item.serialId && isSerialIdDuplicate(item.serialId, item.id)) {
                    showNotification(`‚ö† Duplicate Serial ID: ${item.serialId} already exists!`, 'error');
                    return false;
                }
                
                const oldItem = equipment.find(e => e.id === item.id);
                let updatedItem = { ...item };
                
                // Track assignment changes
                if (oldItem && (
                    oldItem.assignmentType !== item.assignmentType ||
                    oldItem.assignedTo !== item.assignedTo ||
                    oldItem.department !== item.department
                )) {
                    updatedItem.assignmentHistory = [
                        ...(oldItem.assignmentHistory || []),
                        {
                            date: new Date().toISOString().split('T')[0],
                            type: item.assignmentType,
                            assignedTo: item.assignedTo,
                            department: item.department,
                            action: 'Reassignment'
                        }
                    ];
                }
                
                setEquipment(equipment.map(e => e.id === item.id ? updatedItem : e));
                showNotification(`‚úÖ Equipment updated: ${item.name}`, 'success');
                return true;
            };

            const deleteEquipment = (id) => {
                if (confirm('Delete this equipment? This cannot be undone.')) {
                    const item = equipment.find(e => e.id === id);
                    setEquipment(equipment.filter(e => e.id !== id));
                    showNotification(`üóë Equipment deleted: ${item?.name}`, 'info');
                }
            };

            // Update tool status
            const updateToolStatus = (id, newStatus, additionalInfo = {}) => {
                setEquipment(equipment.map(e => {
                    if (e.id === id) {
                        const updated = { ...e, toolStatus: newStatus };
                        if (newStatus === 'Missing') {
                            updated.missingInfo = additionalInfo;
                        } else if (newStatus === 'Loaned') {
                            updated.loanInfo = additionalInfo;
                        } else if (newStatus === 'Warranty/Repair') {
                            updated.repairInfo = additionalInfo;
                        }
                        return updated;
                    }
                    return e;
                }));
            };

            // Resolve missing tool
            const resolveMissingTool = (id, resolution, notes) => {
                const tool = equipment.find(e => e.id === id);
                if (!tool) return;

                const resolutionRecord = {
                    id: `RES-${Date.now()}`,
                    toolId: id,
                    toolName: tool.name,
                    serialId: tool.serialId,
                    resolution,
                    notes,
                    resolvedDate: new Date().toISOString(),
                    resolvedBy: 'Current User' // Would come from auth
                };

                setMissingResolutions([...missingResolutions, resolutionRecord]);

                if (resolution === 'Found') {
                    setEquipment(equipment.map(e => 
                        e.id === id ? { ...e, toolStatus: 'Present', missingInfo: null } : e
                    ));
                    showNotification(`‚úÖ Tool marked as Found: ${tool.name}`, 'success');
                } else {
                    // Abandoned or Broken - mark as retired
                    setEquipment(equipment.map(e => 
                        e.id === id ? { ...e, toolStatus: 'Present', status: 'Retired', missingInfo: null } : e
                    ));
                    showNotification(`üìã¬¶ Tool retired (${resolution}): ${tool.name}`, 'info');
                }
            };

            // Vendor CRUD
            const addVendor = (item) => {
                const newItem = { ...item, id: item.id || `VEND-${String(vendors.length + 1).padStart(4, '0')}` };
                setVendors([...vendors, newItem]);
                showNotification(`‚úÖ Vendor added: ${item.name}`, 'success');
            };

            const updateVendor = (item) => {
                setVendors(vendors.map(v => v.id === item.id ? item : v));
                showNotification(`‚úÖ Vendor updated: ${item.name}`, 'success');
            };

            const deleteVendor = (id) => {
                if (confirm('Delete this vendor?')) {
                    setVendors(vendors.filter(v => v.id !== id));
                }
            };

            // Save inventory log
            const saveInventoryLog = (log) => {
                setInventoryLogs([...inventoryLogs, log]);
                
                // Update equipment statuses based on log
                log.items.forEach(item => {
                    updateToolStatus(item.equipmentId, item.status, item.additionalInfo);
                });
                
                showNotification(`‚úÖ Inventory log saved for ${log.department}`, 'success');
            };

            // Filtered equipment
            const filteredEquipment = equipment.filter(item => {
                const matchesSearch = 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (item.serialId && item.serialId.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.assignedTo && item.assignedTo.toLowerCase().includes(searchTerm.toLowerCase()));
                const matchesType = filterType === 'All' || item.type === filterType;
                const matchesStatus = filterStatus === 'All' || item.status === filterStatus;
                const matchesToolStatus = filterToolStatus === 'All' || item.toolStatus === filterToolStatus;
                return matchesSearch && matchesType && matchesStatus && matchesToolStatus;
            });

            // Missing tools
            const missingTools = equipment.filter(e => e.toolStatus === 'Missing');

            // Stats
            const stats = {
                total: equipment.length,
                present: equipment.filter(e => e.toolStatus === 'Present').length,
                missing: missingTools.length,
                loaned: equipment.filter(e => e.toolStatus === 'Loaned').length,
                repair: equipment.filter(e => e.toolStatus === 'Warranty/Repair').length
            };

            // Export
            const exportToExcel = () => {
                const ws1 = XLSX.utils.json_to_sheet(equipment.map(e => ({
                    ...e,
                    assignmentHistory: JSON.stringify(e.assignmentHistory),
                    loanInfo: JSON.stringify(e.loanInfo),
                    missingInfo: JSON.stringify(e.missingInfo),
                    repairInfo: JSON.stringify(e.repairInfo)
                })));
                const ws2 = XLSX.utils.json_to_sheet(vendors);
                const ws3 = XLSX.utils.json_to_sheet(inventoryLogs);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws1, "Equipment");
                XLSX.utils.book_append_sheet(wb, ws2, "Vendors");
                XLSX.utils.book_append_sheet(wb, ws3, "InventoryLogs");
                XLSX.writeFile(wb, `MODA_Equipment_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="p-6">
                    {/* Notifications */}
                    {notifications.map(n => (
                        <div
                            key={n.id}
                            className={`equipment-notification ${
                                n.type === 'error' ? 'bg-red-600 text-white' :
                                n.type === 'success' ? 'bg-green-600 text-white' :
                                'bg-blue-600 text-white'
                            }`}
                        >
                            {n.message}
                        </div>
                    ))}

                    {/* Stats Bar */}
                    <div className="bg-white rounded-lg shadow-sm p-4 mb-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    background: 'linear-gradient(135deg, var(--autovol-red) 0%, var(--autovol-navy) 100%)',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontWeight: '700',
                                    fontSize: '18px'
                                }}>
                                    üîß
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold" style={{ color: 'var(--autovol-navy)' }}>
                                        Tools & Equipment
                                    </h2>
                                    <p className="text-sm text-gray-500">Power Tool Tracking & Inventory</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-6">
                                <div className="text-center">
                                    <div className="text-2xl font-bold" style={{ color: 'var(--autovol-navy)' }}>{stats.total}</div>
                                    <div className="text-xs text-gray-500">Total Tools</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-green-600">{stats.present}</div>
                                    <div className="text-xs text-gray-500">Present</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-red-600">{stats.missing}</div>
                                    <div className="text-xs text-gray-500">Missing</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-yellow-600">{stats.loaned}</div>
                                    <div className="text-xs text-gray-500">Loaned</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-blue-600">{stats.repair}</div>
                                    <div className="text-xs text-gray-500">Repair</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="bg-white rounded-lg shadow-sm mb-4">
                        <div className="px-4">
                            <div className="flex gap-1 overflow-x-auto">
                                {[
                                    { id: 'equipment', label: 'Equipment', count: equipment.length },
                                    { id: 'missing', label: 'Missing Tools', count: missingTools.length, alert: missingTools.length > 0 },
                                    { id: 'inventory', label: 'Inventory Log', count: null },
                                    { id: 'vendors', label: 'Vendors', count: vendors.length },
                                    { id: 'admin', label: 'Data Management', count: null }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`equipment-tab-btn ${activeTab === tab.id ? 'active' : ''} whitespace-nowrap`}
                                    >
                                        {tab.label}
                                        {tab.count !== null && (
                                            <span className={`ml-2 text-xs px-2 py-0.5 rounded font-bold ${
                                                tab.alert ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'
                                            }`}>
                                                {tab.count}
                                            </span>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="py-4">
                        {activeTab === 'equipment' && (
                            <EquipmentDirectory
                                equipment={filteredEquipment}
                                vendors={vendors}
                                people={equipmentSamplePeople}
                                departments={equipmentDepartments}
                                onAdd={() => { setEditingItem(null); setShowEquipmentModal(true); }}
                                onEdit={(item) => { setEditingItem(item); setShowEquipmentModal(true); }}
                                onDelete={deleteEquipment}
                                onUpdateStatus={updateToolStatus}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                filterType={filterType}
                                setFilterType={setFilterType}
                                filterStatus={filterStatus}
                                setFilterStatus={setFilterStatus}
                                filterToolStatus={filterToolStatus}
                                setFilterToolStatus={setFilterToolStatus}
                            />
                        )}

                        {activeTab === 'missing' && (
                            <MissingToolBoard
                                missingTools={missingTools}
                                resolutions={missingResolutions}
                                onResolve={resolveMissingTool}
                            />
                        )}

                        {activeTab === 'inventory' && (
                            <InventoryLogSection
                                equipment={equipment}
                                departments={equipmentDepartments}
                                logs={inventoryLogs}
                                onSaveLog={saveInventoryLog}
                            />
                        )}

                        {activeTab === 'vendors' && (
                            <VendorDirectory
                                vendors={vendors}
                                onAdd={() => { setEditingItem(null); setShowVendorModal(true); }}
                                onEdit={(item) => { setEditingItem(item); setShowVendorModal(true); }}
                                onDelete={deleteVendor}
                            />
                        )}

                        {activeTab === 'admin' && (
                            <AdminPanel
                                stats={stats}
                                onExport={exportToExcel}
                            />
                        )}
                    </main>

                    {/* Equipment Modal */}
                    {showEquipmentModal && (
                        <EquipmentModal
                            item={editingItem}
                            vendors={vendors}
                            people={equipmentSamplePeople}
                            departments={equipmentDepartments}
                            onSave={(item) => {
                                const success = editingItem ? updateEquipment(item) : addEquipment(item);
                                if (success) {
                                    setShowEquipmentModal(false);
                                    setEditingItem(null);
                                }
                            }}
                            onClose={() => { setShowEquipmentModal(false); setEditingItem(null); }}
                        />
                    )}

                    {/* Vendor Modal */}
                    {showVendorModal && (
                        <VendorModal
                            item={editingItem}
                            onSave={(item) => {
                                editingItem ? updateVendor(item) : addVendor(item);
                                setShowVendorModal(false);
                                setEditingItem(null);
                            }}
                            onClose={() => { setShowVendorModal(false); setEditingItem(null); }}
                        />
                    )}
                </div>
            );
        }

        // Equipment Directory
        function EquipmentDirectory({ 
            equipment, vendors, people, departments,
            onAdd, onEdit, onDelete, onUpdateStatus,
            searchTerm, setSearchTerm,
            filterType, setFilterType,
            filterStatus, setFilterStatus,
            filterToolStatus, setFilterToolStatus
        }) {
            const [selectedItem, setSelectedItem] = useState(null);

            return (
                <div className="grid grid-cols-12 gap-6">
                    <div className="col-span-12 lg:col-span-5">
                        <div className="mb-4 space-y-3">
                            <input
                                type="text"
                                placeholder="Search name, ID, serial, assignee..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                style={{ fontSize: '14px' }}
                            />
                            
                            <div className="grid grid-cols-3 gap-2">
                                <select
                                    value={filterType}
                                    onChange={(e) => setFilterType(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="All">All Types</option>
                                    <option value="Tool">Tool</option>
                                    <option value="Equipment">Equipment</option>
                                    <option value="Jig/Fixture">Jig/Fixture</option>
                                </select>

                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="All">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Retired">Retired</option>
                                </select>

                                <select
                                    value={filterToolStatus}
                                    onChange={(e) => setFilterToolStatus(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="All">All Locations</option>
                                    <option value="Present">Present</option>
                                    <option value="Missing">Missing</option>
                                    <option value="Loaned">Loaned</option>
                                    <option value="Warranty/Repair">Repair</option>
                                </select>
                            </div>

                            <button onClick={onAdd} className="btn-equipment-primary w-full">
                                + Add Equipment
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="bg-gray-50 px-4 py-2 border-b text-sm font-semibold text-gray-600">
                                Equipment ({equipment.length})
                            </div>
                            <div className="max-h-[calc(100vh-450px)] overflow-y-auto">
                                {equipment.map(item => (
                                    <EquipmentListRow
                                        key={item.id}
                                        item={item}
                                        isSelected={selectedItem?.id === item.id}
                                        onClick={() => setSelectedItem(item)}
                                    />
                                ))}
                                {equipment.length === 0 && (
                                    <div className="text-center py-12 text-gray-500">No equipment found</div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="col-span-12 lg:col-span-7">
                        {selectedItem ? (
                            <EquipmentDetailPanel
                                item={selectedItem}
                                onEdit={onEdit}
                                onDelete={onDelete}
                                onClose={() => setSelectedItem(null)}
                            />
                        ) : (
                            <div className="bg-white rounded-lg shadow p-12 text-center text-gray-400">
                                <div className="text-6xl mb-4">üîß</div>
                                <p className="text-lg font-medium">Select a tool to view details</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Equipment List Row
        function EquipmentListRow({ item, isSelected, onClick }) {
            const getToolStatusStyle = (status) => {
                switch(status) {
                    case 'Present': return 'bg-green-100 text-green-800';
                    case 'Missing': return 'bg-red-100 text-red-800';
                    case 'Loaned': return 'bg-yellow-100 text-yellow-800';
                    case 'Warranty/Repair': return 'bg-blue-100 text-blue-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            return (
                <div className={`equipment-list-row ${isSelected ? 'selected' : ''}`} onClick={onClick}>
                    <div className="flex items-center justify-between">
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                                <span className="text-xs font-mono text-gray-500 serial-id">{item.serialId || item.id}</span>
                            </div>
                            <h4 className="font-semibold text-gray-900 truncate" style={{ fontSize: '15px' }}>{item.name}</h4>
                            <div className="text-xs text-gray-600 mt-1 font-medium">
                                {item.assignmentType === 'Individual' ? (
                                    <span>üë§ {item.assignedTo}</span>
                                ) : (
                                    <span>üè¢ {item.department}</span>
                                )}
                            </div>
                        </div>
                        <div className="ml-3">
                            <span className={`badge ${getToolStatusStyle(item.toolStatus)}`}>
                                {item.toolStatus === 'Warranty/Repair' ? 'üîß Repair' : item.toolStatus}
                            </span>
                        </div>
                    </div>
                </div>
            );
        }

        // Equipment Detail Panel
        function EquipmentDetailPanel({ item, onEdit, onDelete, onClose }) {
            const getToolStatusStyle = (status) => {
                switch(status) {
                    case 'Present': return 'bg-green-100 text-green-800';
                    case 'Missing': return 'bg-red-100 text-red-800';
                    case 'Loaned': return 'bg-yellow-100 text-yellow-800';
                    case 'Warranty/Repair': return 'bg-blue-100 text-blue-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            return (
                <div className="equipment-detail-panel">
                    <div className="equipment-detail-section">
                        <div className="flex items-start justify-between mb-4">
                            <div>
                                <div className="text-sm text-gray-500 font-mono mb-1 tool-id">{item.id}</div>
                                <h2 className="text-2xl font-bold text-gray-900">{item.name}</h2>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl font-bold" style={{ width: '32px', height: '32px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>√ó</button>
                        </div>
                        
                        <div className="flex items-center gap-2 flex-wrap">
                            <span className={`badge ${getToolStatusStyle(item.toolStatus)}`}>
                                {item.toolStatus}
                            </span>
                            <span className={`badge ${item.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                                {item.status}
                            </span>
                        </div>
                    </div>

                    {/* Tool Identification */}
                    <div className="equipment-detail-section">
                        <h3 className="font-bold text-lg mb-3">Tool Identification</h3>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Part Number / Model</div>
                                <div className="font-semibold font-mono">{item.partNumber || '‚Äì'}</div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Serial ID</div>
                                <div className="font-semibold font-mono text-autovol-blue serial-id">{item.serialId || '‚Äì'}</div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Category</div>
                                <div className="font-semibold">{item.category || '‚Äì'}</div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Location</div>
                                <div className="font-semibold">{item.location || '‚Äì'}</div>
                            </div>
                        </div>
                    </div>

                    {/* Assignment */}
                    <div className="equipment-detail-section">
                        <h3 className="font-bold text-lg mb-3">Current Assignment</h3>
                        <div className="bg-blue-50 p-4 rounded-lg border-l-4" style={{ borderLeftColor: '#0057B8' }}>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <div className="text-gray-500 mb-1 font-medium">Assignment Type</div>
                                    <div className="font-semibold">{item.assignmentType}</div>
                                </div>
                                <div>
                                    <div className="text-gray-500 mb-1 font-medium">Department</div>
                                    <div className="font-semibold">{item.department || '‚Äì'}</div>
                                </div>
                                {item.assignmentType === 'Individual' && (
                                    <div className="col-span-2">
                                        <div className="text-gray-500 mb-1 font-medium">Assigned To</div>
                                        <div className="font-semibold text-lg">üë§ {item.assignedTo}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Loan Info */}
                    {item.toolStatus === 'Loaned' && item.loanInfo && (
                        <div className="equipment-detail-section">
                            <h3 className="font-bold text-lg mb-3 text-yellow-700">üìã¬§ Loan Information</h3>
                            <div className="bg-yellow-50 p-4 rounded-lg text-sm border-l-4 border-yellow-500">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Loaned To</div>
                                        <div className="font-semibold">{item.loanInfo.loanedTo}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Department</div>
                                        <div className="font-semibold">{item.loanInfo.loanedToDept}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Loan Date</div>
                                        <div className="font-semibold">{item.loanInfo.loanDate}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Expected Return</div>
                                        <div className="font-semibold text-yellow-700">{item.loanInfo.expectedReturn}</div>
                                    </div>
                                </div>
                                {item.loanInfo.reason && (
                                    <div className="mt-3 pt-3 border-t border-yellow-200">
                                        <div className="text-gray-500 mb-1 font-medium">Reason</div>
                                        <div>{item.loanInfo.reason}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Repair Info */}
                    {item.toolStatus === 'Warranty/Repair' && item.repairInfo && (
                        <div className="equipment-detail-section">
                            <h3 className="font-bold text-lg mb-3 text-blue-700">üîß Repair Information</h3>
                            <div className="bg-blue-50 p-4 rounded-lg text-sm border-l-4 border-blue-500">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Service Provider</div>
                                        <div className="font-semibold">{item.repairInfo.vendor}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Ticket #</div>
                                        <div className="font-semibold font-mono">{item.repairInfo.ticketNumber}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Sent Date</div>
                                        <div className="font-semibold">{item.repairInfo.sentDate}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Expected Return</div>
                                        <div className="font-semibold text-blue-700">{item.repairInfo.expectedReturn}</div>
                                    </div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-blue-200">
                                    <div className="text-gray-500 mb-1 font-medium">Issue</div>
                                    <div>{item.repairInfo.issue}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Missing Info */}
                    {item.toolStatus === 'Missing' && item.missingInfo && (
                        <div className="equipment-detail-section">
                            <h3 className="font-bold text-lg mb-3 text-red-700">‚ö† Missing Tool Report</h3>
                            <div className="bg-red-50 p-4 rounded-lg text-sm border-l-4 border-red-500">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Reported Date</div>
                                        <div className="font-semibold">{item.missingInfo.reportedDate}</div>
                                    </div>
                                    <div>
                                        <div className="text-gray-500 mb-1 font-medium">Reported By</div>
                                        <div className="font-semibold">{item.missingInfo.reportedBy}</div>
                                    </div>
                                    <div className="col-span-2">
                                        <div className="text-gray-500 mb-1 font-medium">Last Known Location</div>
                                        <div className="font-semibold">{item.missingInfo.lastKnownLocation}</div>
                                    </div>
                                </div>
                                {item.missingInfo.notes && (
                                    <div className="mt-3 pt-3 border-t border-red-200">
                                        <div className="text-gray-500 mb-1 font-medium">Notes</div>
                                        <div>{item.missingInfo.notes}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Purchase Info */}
                    <div className="equipment-detail-section">
                        <h3 className="font-bold text-lg mb-3">Purchase Information</h3>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Vendor</div>
                                <div className="font-semibold">{item.vendor || '‚Äì'}</div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Purchase Date</div>
                                <div className="font-semibold">{item.purchaseDate || '‚Äì'}</div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Cost</div>
                                <div className="font-semibold">
                                    {item.cost ? `$${parseFloat(item.cost).toFixed(2)}` : '‚Äì'}
                                </div>
                            </div>
                            <div>
                                <div className="text-gray-500 mb-1 font-medium">Warranty Exp.</div>
                                <div className="font-semibold">{item.warranty || '‚Äì'}</div>
                            </div>
                        </div>
                    </div>

                    {/* Assignment History */}
                    {item.assignmentHistory && item.assignmentHistory.length > 0 && (
                        <div className="equipment-detail-section">
                            <h3 className="font-bold text-lg mb-3">Assignment History</h3>
                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                {[...item.assignmentHistory].reverse().map((h, idx) => (
                                    <div key={idx} className="text-sm p-3 bg-gray-50 rounded-lg flex justify-between items-start">
                                        <div>
                                            <span className="font-semibold">{h.action}</span>
                                            <span className="text-gray-500 mx-2">‚Üí</span>
                                            {h.type === 'Individual' ? (
                                                <span>üë§ {h.assignedTo} ({h.department})</span>
                                            ) : (
                                                <span>üè¢ {h.department}</span>
                                            )}
                                        </div>
                                        <span className="text-gray-500 text-xs">{h.date}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Notes */}
                    {item.notes && (
                        <div className="equipment-detail-section">
                            <h3 className="font-bold text-lg mb-3">Notes</h3>
                            <p className="text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">{item.notes}</p>
                        </div>
                    )}

                    {/* Actions */}
                    <div className="equipment-detail-section">
                        <div className="flex gap-3">
                            <button onClick={() => onEdit(item)} className="btn-equipment-primary flex-1">
                                ‚úè Edit
                            </button>
                            <button onClick={() => onDelete(item.id)} className="btn-equipment-danger">
                                üóë Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Missing Tool Board
        function MissingToolBoard({ missingTools, resolutions, onResolve }) {
            const [selectedTool, setSelectedTool] = useState(null);
            const [showResolveModal, setShowResolveModal] = useState(false);

            // Calculate days missing
            const getDaysMissing = (reportedDate) => {
                if (!reportedDate) return 0;
                const reported = new Date(reportedDate);
                const today = new Date();
                return Math.floor((today - reported) / (1000 * 60 * 60 * 24));
            };

            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold mb-2">Missing Tool Tracking Board</h2>
                        <p className="text-gray-600">Track and resolve missing tools. Tools missing over 30 days are marked critical.</p>
                    </div>

                    {missingTools.length === 0 ? (
                        <div className="bg-green-50 border-2 border-green-200 rounded-lg p-12 text-center">
                            <div className="text-6xl mb-4">‚úÖ</div>
                            <h3 className="text-xl font-bold text-green-800 mb-2">All Tools Accounted For</h3>
                            <p className="text-green-600">No missing tools reported at this time.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {missingTools.map(tool => {
                                const daysMissing = getDaysMissing(tool.missingInfo?.reportedDate);
                                const isCritical = daysMissing > 30;
                                
                                return (
                                    <div
                                        key={tool.id}
                                        className={`missing-card ${isCritical ? 'border-red-600 bg-red-50' : ''}`}
                                    >
                                        {isCritical && (
                                            <div className="bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded mb-3 inline-block">
                                                üö® CRITICAL: {daysMissing} DAYS MISSING
                                            </div>
                                        )}
                                        
                                        <div className="text-sm text-gray-500 font-mono mb-1 serial-id">{tool.serialId || tool.id}</div>
                                        <h3 className="font-bold text-lg mb-2">{tool.name}</h3>
                                        
                                        <div className="text-sm space-y-1.5 mb-4">
                                            <div className="flex justify-between">
                                                <span className="text-gray-500 font-medium">Assigned To:</span>
                                                <span className="font-semibold">
                                                    {tool.assignmentType === 'Individual' ? tool.assignedTo : tool.department}
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500 font-medium">Reported:</span>
                                                <span className="font-semibold">{tool.missingInfo?.reportedDate || 'Unknown'}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500 font-medium">Last Location:</span>
                                                <span className="font-semibold">{tool.missingInfo?.lastKnownLocation || 'Unknown'}</span>
                                            </div>
                                            {!isCritical && (
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500 font-medium">Days Missing:</span>
                                                    <span className="font-bold text-red-600">{daysMissing} days</span>
                                                </div>
                                            )}
                                        </div>

                                        {tool.missingInfo?.notes && (
                                            <div className="text-sm text-gray-600 italic border-t pt-2 mb-4 bg-gray-50 p-2 rounded">
                                                "{tool.missingInfo.notes}"
                                            </div>
                                        )}

                                        <button
                                            onClick={() => {
                                                setSelectedTool(tool);
                                                setShowResolveModal(true);
                                            }}
                                            className="btn-equipment-primary w-full"
                                        >
                                            Resolve
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Resolution History */}
                    {resolutions.length > 0 && (
                        <div className="mt-8">
                            <h3 className="text-xl font-bold mb-4">Resolution History</h3>
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left font-semibold">Date</th>
                                            <th className="px-4 py-3 text-left font-semibold">Tool</th>
                                            <th className="px-4 py-3 text-left font-semibold">Serial</th>
                                            <th className="px-4 py-3 text-left font-semibold">Resolution</th>
                                            <th className="px-4 py-3 text-left font-semibold">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {[...resolutions].reverse().map((r, idx) => (
                                            <tr key={r.id} className="border-t" style={{ background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                <td className="px-4 py-3">{new Date(r.resolvedDate).toLocaleDateString()}</td>
                                                <td className="px-4 py-3 font-semibold">{r.toolName}</td>
                                                <td className="px-4 py-3 font-mono text-gray-500 serial-id">{r.serialId}</td>
                                                <td className="px-4 py-3">
                                                    <span className={`badge ${
                                                        r.resolution === 'Found' ? 'bg-green-100 text-green-800' :
                                                        r.resolution === 'Abandoned' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        {r.resolution}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-gray-600">{r.notes || '‚Äì'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Resolve Modal */}
                    {showResolveModal && selectedTool && (
                        <ResolveModal
                            tool={selectedTool}
                            onResolve={(resolution, notes) => {
                                onResolve(selectedTool.id, resolution, notes);
                                setShowResolveModal(false);
                                setSelectedTool(null);
                            }}
                            onClose={() => {
                                setShowResolveModal(false);
                                setSelectedTool(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        // Resolve Modal
        function ResolveModal({ tool, onResolve, onClose }) {
            const [resolution, setResolution] = useState('');
            const [notes, setNotes] = useState('');

            const resolutionOptions = [
                { value: 'Found', label: '‚úÖ Tool Found', description: 'Tool has been located and is back in service', color: 'bg-green-100 border-green-500' },
                { value: 'Abandoned', label: 'üìã¬¶ Abandoned', description: 'Search abandoned - tool written off', color: 'bg-yellow-100 border-yellow-500' },
                { value: 'Broken', label: 'üî® Broken/Non-repairable', description: 'Tool found but not repairable', color: 'bg-red-100 border-red-500' }
            ];

            return (
                <div className="equipment-modal-overlay" onClick={onClose}>
                    <div className="equipment-modal-content" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-start mb-4">
                                <h2 className="text-2xl font-bold">Resolve Missing Tool</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg mb-6 border-l-4" style={{ borderLeftColor: '#0057B8' }}>
                                <div className="text-sm text-gray-500 font-mono serial-id">{tool.serialId || tool.id}</div>
                                <div className="font-bold text-lg">{tool.name}</div>
                                <div className="text-sm text-gray-600 mt-1">
                                    Assigned: {tool.assignmentType === 'Individual' ? tool.assignedTo : tool.department}
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block font-semibold mb-3">Select Resolution:</label>
                                <div className="space-y-2">
                                    {resolutionOptions.map(opt => (
                                        <div
                                            key={opt.value}
                                            onClick={() => setResolution(opt.value)}
                                            className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                                resolution === opt.value 
                                                    ? opt.color + ' border-opacity-100' 
                                                    : 'bg-white border-gray-200 hover:border-gray-300'
                                            }`}
                                        >
                                            <div className="font-semibold">{opt.label}</div>
                                            <div className="text-sm text-gray-600 mt-1">{opt.description}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block font-semibold mb-2">Notes (required):</label>
                                <textarea
                                    value={notes}
                                    onChange={e => setNotes(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                    rows="3"
                                    placeholder="Provide details about the resolution..."
                                    required
                                />
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        if (!resolution) {
                                            alert('Please select a resolution');
                                            return;
                                        }
                                        if (!notes.trim()) {
                                            alert('Please provide notes for this resolution');
                                            return;
                                        }
                                        onResolve(resolution, notes);
                                    }}
                                    className="btn-equipment-success flex-1"
                                >
                                    Confirm Resolution
                                </button>
                                <button onClick={onClose} className="btn-equipment-secondary">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Inventory Log Section
        function InventoryLogSection({ equipment, departments, logs, onSaveLog }) {
            const [activeView, setActiveView] = useState('conduct');
            const [selectedDept, setSelectedDept] = useState('');
            const [inventoryItems, setInventoryItems] = useState([]);
            const [isInventoryActive, setIsInventoryActive] = useState(false);

            // Start inventory for department
            const startInventory = () => {
                if (!selectedDept) return;
                
                const deptEquipment = equipment.filter(e => 
                    e.department === selectedDept && e.status === 'Active'
                );
                
                setInventoryItems(deptEquipment.map(e => ({
                    equipmentId: e.id,
                    name: e.name,
                    serialId: e.serialId,
                    currentStatus: e.toolStatus,
                    status: null,
                    additionalInfo: {}
                })));
                
                setIsInventoryActive(true);
            };

            // Update item status
            const updateItemStatus = (equipmentId, status) => {
                setInventoryItems(items => items.map(item => 
                    item.equipmentId === equipmentId ? { ...item, status } : item
                ));
            };

            // Submit inventory
            const submitInventory = () => {
                const incompleteItems = inventoryItems.filter(i => !i.status);
                if (incompleteItems.length > 0) {
                    alert(`Please mark status for all items. ${incompleteItems.length} items remaining.`);
                    return;
                }

                const log = {
                    id: `LOG-${Date.now()}`,
                    department: selectedDept,
                    date: new Date().toISOString(),
                    conductedBy: 'Current User',
                    items: inventoryItems,
                    summary: {
                        total: inventoryItems.length,
                        present: inventoryItems.filter(i => i.status === 'Present').length,
                        missing: inventoryItems.filter(i => i.status === 'Missing').length,
                        loaned: inventoryItems.filter(i => i.status === 'Loaned').length,
                        repair: inventoryItems.filter(i => i.status === 'Warranty/Repair').length
                    }
                };

                onSaveLog(log);
                setIsInventoryActive(false);
                setSelectedDept('');
                setInventoryItems([]);
            };

            // Get next inventory due date (monthly)
            const getNextInventoryDate = (dept) => {
                const deptLogs = logs.filter(l => l.department === dept);
                if (deptLogs.length === 0) return 'Not yet conducted';
                
                const lastLog = deptLogs.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const lastDate = new Date(lastLog.date);
                const nextDate = new Date(lastDate);
                nextDate.setMonth(nextDate.getMonth() + 1);
                
                const today = new Date();
                const isOverdue = nextDate < today;
                
                return {
                    date: nextDate.toLocaleDateString(),
                    isOverdue
                };
            };

            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold mb-2">Tool Inventory Log</h2>
                        <p className="text-gray-600">Monthly inventory exercises by department. Track tool status and accountability.</p>
                    </div>

                    {/* View Toggle */}
                    <div className="flex gap-2 mb-6">
                        <button
                            onClick={() => setActiveView('conduct')}
                            className={`px-4 py-2 rounded-lg font-semibold ${
                                activeView === 'conduct' ? 'bg-autovol-blue text-white' : 'bg-gray-200'
                            }`}
                        >
                            Conduct Inventory
                        </button>
                        <button
                            onClick={() => setActiveView('history')}
                            className={`px-4 py-2 rounded-lg font-semibold ${
                                activeView === 'history' ? 'bg-autovol-blue text-white' : 'bg-gray-200'
                            }`}
                        >
                            View History
                        </button>
                        <button
                            onClick={() => setActiveView('schedule')}
                            className={`px-4 py-2 rounded-lg font-semibold ${
                                activeView === 'schedule' ? 'bg-autovol-blue text-white' : 'bg-gray-200'
                            }`}
                        >
                            Schedule Overview
                        </button>
                    </div>

                    {activeView === 'conduct' && !isInventoryActive && (
                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="font-bold text-lg mb-4">Start New Inventory Exercise</h3>
                            <div className="max-w-md">
                                <label className="block mb-2 font-semibold">Select Department:</label>
                                <select
                                    value={selectedDept}
                                    onChange={e => setSelectedDept(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4"
                                >
                                    <option value="">Choose department...</option>
                                    {departments.map(d => (
                                        <option key={d} value={d}>{d}</option>
                                    ))}
                                </select>
                                <button
                                    onClick={startInventory}
                                    disabled={!selectedDept}
                                    className="btn-equipment-primary w-full disabled:opacity-50"
                                >
                                    Start Inventory
                                </button>
                            </div>
                        </div>
                    )}

                    {activeView === 'conduct' && isInventoryActive && (
                        <div className="bg-white rounded-lg shadow">
                            <div className="p-4 border-b bg-gray-50">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-lg">Inventory: {selectedDept}</h3>
                                        <p className="text-sm text-gray-600">
                                            {inventoryItems.filter(i => i.status).length} / {inventoryItems.length} items marked
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                setIsInventoryActive(false);
                                                setInventoryItems([]);
                                            }}
                                            className="btn-equipment-secondary"
                                        >
                                            Cancel
                                        </button>
                                        <button onClick={submitInventory} className="btn-equipment-success">
                                            Submit Inventory
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {inventoryItems.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    No equipment found for this department.
                                </div>
                            ) : (
                                <div className="divide-y">
                                    {inventoryItems.map(item => (
                                        <div key={item.equipmentId} className="p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <div>
                                                    <div className="text-sm text-gray-500 font-mono serial-id">{item.serialId || item.equipmentId}</div>
                                                    <div className="font-semibold">{item.name}</div>
                                                </div>
                                                {item.status && (
                                                    <span className={`badge ${
                                                        item.status === 'Present' ? 'bg-green-100 text-green-800' :
                                                        item.status === 'Missing' ? 'bg-red-100 text-red-800' :
                                                        item.status === 'Loaned' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-blue-100 text-blue-800'
                                                    }`}>
                                                        {item.status}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="flex gap-2 flex-wrap">
                                                {['Present', 'Missing', 'Warranty/Repair', 'Loaned'].map(status => (
                                                    <button
                                                        key={status}
                                                        onClick={() => updateItemStatus(item.equipmentId, status)}
                                                        className={`equipment-status-btn ${
                                                            item.status === status ? 'selected' : ''
                                                        } ${
                                                            status === 'Present' ? 'bg-green-50 text-green-800' :
                                                            status === 'Missing' ? 'bg-red-50 text-red-800' :
                                                            status === 'Loaned' ? 'bg-yellow-50 text-yellow-800' :
                                                            'bg-blue-50 text-blue-800'
                                                        }`}
                                                    >
                                                        {status === 'Present' ? '‚úÖ' : 
                                                         status === 'Missing' ? '‚ùå' :
                                                         status === 'Loaned' ? 'üìã¬§' : 'üîß'} {status}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {activeView === 'history' && (
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left font-semibold">Date</th>
                                        <th className="px-4 py-3 text-left font-semibold">Department</th>
                                        <th className="px-4 py-3 text-left font-semibold">Conducted By</th>
                                        <th className="px-4 py-3 text-center font-semibold">Total</th>
                                        <th className="px-4 py-3 text-center font-semibold">Present</th>
                                        <th className="px-4 py-3 text-center font-semibold">Missing</th>
                                        <th className="px-4 py-3 text-center font-semibold">Loaned</th>
                                        <th className="px-4 py-3 text-center font-semibold">Repair</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {logs.length === 0 ? (
                                        <tr>
                                            <td colSpan="8" className="px-4 py-8 text-center text-gray-500">
                                                No inventory logs yet.
                                            </td>
                                        </tr>
                                    ) : (
                                        [...logs].reverse().map((log, idx) => (
                                            <tr key={log.id} className="border-t" style={{ background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                <td className="px-4 py-3">{new Date(log.date).toLocaleDateString()}</td>
                                                <td className="px-4 py-3 font-semibold">{log.department}</td>
                                                <td className="px-4 py-3">{log.conductedBy}</td>
                                                <td className="px-4 py-3 text-center">{log.summary.total}</td>
                                                <td className="px-4 py-3 text-center text-green-600 font-bold">{log.summary.present}</td>
                                                <td className="px-4 py-3 text-center text-red-600 font-bold">{log.summary.missing}</td>
                                                <td className="px-4 py-3 text-center text-yellow-600 font-bold">{log.summary.loaned}</td>
                                                <td className="px-4 py-3 text-center text-blue-600 font-bold">{log.summary.repair}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {activeView === 'schedule' && (
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left font-semibold">Department</th>
                                        <th className="px-4 py-3 text-left font-semibold">Tool Count</th>
                                        <th className="px-4 py-3 text-left font-semibold">Last Inventory</th>
                                        <th className="px-4 py-3 text-left font-semibold">Next Due</th>
                                        <th className="px-4 py-3 text-left font-semibold">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {departments.map((dept, idx) => {
                                        const deptEquip = equipment.filter(e => e.department === dept && e.status === 'Active');
                                        const deptLogs = logs.filter(l => l.department === dept);
                                        const lastLog = deptLogs.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                        const nextInfo = getNextInventoryDate(dept);
                                        
                                        if (deptEquip.length === 0) return null;
                                        
                                        return (
                                            <tr key={dept} className="border-t" style={{ background: idx % 2 === 0 ? 'white' : '#fafafa' }}>
                                                <td className="px-4 py-3 font-semibold">{dept}</td>
                                                <td className="px-4 py-3">{deptEquip.length}</td>
                                                <td className="px-4 py-3">
                                                    {lastLog ? new Date(lastLog.date).toLocaleDateString() : 'Never'}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {typeof nextInfo === 'string' ? nextInfo : nextInfo.date}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {typeof nextInfo === 'string' ? (
                                                        <span className="equipment-badge bg-gray-100 text-gray-800">Pending</span>
                                                    ) : nextInfo.isOverdue ? (
                                                        <span className="equipment-badge bg-red-100 text-red-800">‚ö† Overdue</span>
                                                    ) : (
                                                        <span className="equipment-badge bg-green-100 text-green-800">On Track</span>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // Vendor Directory
        function VendorDirectory({ vendors, onAdd, onEdit, onDelete }) {
            const [selectedVendor, setSelectedVendor] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filteredVendors = vendors.filter(v =>
                v.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="grid grid-cols-12 gap-6">
                    <div className="col-span-12 lg:col-span-5">
                        <div className="mb-4 space-y-3">
                            <input
                                type="text"
                                placeholder="Search vendors..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                            />
                            <button onClick={onAdd} className="btn-equipment-primary w-full">
                                + Add Vendor
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="bg-gray-50 px-4 py-2 border-b text-sm font-semibold text-gray-600">
                                Vendors ({filteredVendors.length})
                            </div>
                            <div className="max-h-[calc(100vh-400px)] overflow-y-auto">
                                {filteredVendors.map(vendor => (
                                    <div
                                        key={vendor.id}
                                        className={`equipment-list-row ${selectedVendor?.id === vendor.id ? 'selected' : ''}`}
                                        onClick={() => setSelectedVendor(vendor)}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-semibold">{vendor.name}</span>
                                                    {vendor.preferred && <span className="text-yellow-500">‚≠ê</span>}
                                                </div>
                                                <div className="text-sm text-gray-500 font-mono">{vendor.phone}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="col-span-12 lg:col-span-7">
                        {selectedVendor ? (
                            <div className="equipment-detail-panel">
                                <div className="equipment-detail-section">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className="text-2xl font-bold">{selectedVendor.name}</h2>
                                            {selectedVendor.preferred && (
                                                <span className="equipment-badge bg-green-100 text-green-800 mt-2">‚≠ê Preferred Vendor</span>
                                            )}
                                        </div>
                                        <button onClick={() => setSelectedVendor(null)} className="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                                    </div>
                                </div>

                                <div className="equipment-detail-section">
                                    <h3 className="font-bold text-lg mb-3">Contact Information</h3>
                                    <div className="space-y-2 text-sm">
                                        <div><span className="text-gray-500 font-medium">Contact:</span> <span className="font-semibold">{selectedVendor.contactPerson}</span></div>
                                        <div><span className="text-gray-500 font-medium">Phone:</span> <span className="font-semibold font-mono">{selectedVendor.phone}</span></div>
                                        <div><span className="text-gray-500 font-medium">Email:</span> <span className="font-semibold text-blue-600">{selectedVendor.email}</span></div>
                                        <div><span className="text-gray-500 font-medium">Website:</span> <span className="font-semibold text-blue-600">{selectedVendor.website}</span></div>
                                        <div><span className="text-gray-500 font-medium">Payment Terms:</span> <span className="font-semibold">{selectedVendor.paymentTerms}</span></div>
                                    </div>
                                </div>

                                {selectedVendor.categories && (
                                    <div className="equipment-detail-section">
                                        <h3 className="font-bold text-lg mb-3">Product Categories</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {selectedVendor.categories.map((cat, i) => (
                                                <span key={i} className="equipment-badge bg-blue-100 text-blue-800">{cat}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {selectedVendor.notes && (
                                    <div className="equipment-detail-section">
                                        <h3 className="font-bold text-lg mb-3">Notes</h3>
                                        <p className="text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">{selectedVendor.notes}</p>
                                    </div>
                                )}

                                <div className="equipment-detail-section">
                                    <div className="flex gap-3">
                                        <button onClick={() => onEdit(selectedVendor)} className="btn-equipment-primary flex-1">‚úè Edit</button>
                                        <button onClick={() => onDelete(selectedVendor.id)} className="btn-equipment-danger">üóë Delete</button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-lg shadow p-12 text-center text-gray-400">
                                <div className="text-6xl mb-4">üè¢</div>
                                <p className="text-lg font-medium">Select a vendor to view details</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Admin Panel
        function AdminPanel({ stats, onExport }) {
            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold mb-4">System Overview</h2>
                        <div className="grid grid-cols-5 gap-4">
                            <div className="text-center p-4 bg-gray-50 rounded-lg">
                                <div className="text-3xl font-bold">{stats.total}</div>
                                <div className="text-sm text-gray-600 font-medium">Total Tools</div>
                            </div>
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-3xl font-bold text-green-600">{stats.present}</div>
                                <div className="text-sm text-gray-600 font-medium">Present</div>
                            </div>
                            <div className="text-center p-4 bg-red-50 rounded-lg">
                                <div className="text-3xl font-bold text-red-600">{stats.missing}</div>
                                <div className="text-sm text-gray-600 font-medium">Missing</div>
                            </div>
                            <div className="text-center p-4 bg-yellow-50 rounded-lg">
                                <div className="text-3xl font-bold text-yellow-600">{stats.loaned}</div>
                                <div className="text-sm text-gray-600 font-medium">Loaned</div>
                            </div>
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-3xl font-bold text-blue-600">{stats.repair}</div>
                                <div className="text-sm text-gray-600 font-medium">In Repair</div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold mb-4">Data Management</h2>
                        <button onClick={onExport} className="btn-equipment-primary">
                            üìã≈† Export to Excel
                        </button>
                    </div>
                </div>
            );
        }

        // Equipment Modal
        function EquipmentModal({ item, vendors, people, departments, onSave, onClose }) {
            const [formData, setFormData] = useState(item || {
                name: '',
                type: 'Tool',
                category: 'Power Tools',
                partNumber: '',
                serialId: '',
                location: '',
                status: 'Active',
                toolStatus: 'Present',
                assignmentType: 'Unassigned',
                assignedTo: null,
                department: '',
                purchaseDate: '',
                cost: '',
                vendor: '',
                warranty: '',
                notes: ''
            });

            // Auto-fill department when individual selected
            const handleAssigneeChange = (personName) => {
                const person = people.find(p => p.name === personName);
                setFormData({
                    ...formData,
                    assignedTo: personName,
                    department: person ? person.department : formData.department
                });
            };

            return (
                <div className="equipment-modal-overlay" onClick={onClose}>
                    <div className="equipment-modal-content" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-start mb-4">
                                <h2 className="text-2xl font-bold">{item ? 'Edit Equipment' : 'Add Equipment'}</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                            </div>

                            <form onSubmit={e => { e.preventDefault(); onSave(formData); }} className="space-y-4">
                                {/* Basic Info */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2">
                                        <label className="block text-sm font-semibold mb-1">Tool Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={e => setFormData({...formData, name: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                            placeholder="e.g., DeWalt 20V Impact Driver"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Part Number / Model</label>
                                        <input
                                            type="text"
                                            value={formData.partNumber}
                                            onChange={e => setFormData({...formData, partNumber: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded font-mono"
                                            placeholder="e.g., DCF887B"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Serial ID (Unique) *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.serialId}
                                            onChange={e => setFormData({...formData, serialId: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded font-mono"
                                            placeholder="e.g., DW-2024-0001"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Type</label>
                                        <select
                                            value={formData.type}
                                            onChange={e => setFormData({...formData, type: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        >
                                            <option value="Tool">Tool</option>
                                            <option value="Equipment">Equipment</option>
                                            <option value="Jig/Fixture">Jig/Fixture</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Category</label>
                                        <input
                                            type="text"
                                            value={formData.category}
                                            onChange={e => setFormData({...formData, category: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                            placeholder="e.g., Power Tools"
                                        />
                                    </div>
                                </div>

                                {/* Assignment */}
                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-3">Assignment</h3>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Assignment Type</label>
                                            <select
                                                value={formData.assignmentType}
                                                onChange={e => setFormData({
                                                    ...formData,
                                                    assignmentType: e.target.value,
                                                    assignedTo: e.target.value !== 'Individual' ? null : formData.assignedTo
                                                })}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                            >
                                                <option value="Unassigned">Unassigned</option>
                                                <option value="Individual">Individual</option>
                                                <option value="Department">Department</option>
                                            </select>
                                        </div>

                                        {formData.assignmentType === 'Individual' && (
                                            <div>
                                                <label className="block text-sm font-semibold mb-1">Assigned To</label>
                                                <select
                                                    value={formData.assignedTo || ''}
                                                    onChange={e => handleAssigneeChange(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded"
                                                >
                                                    <option value="">Select person...</option>
                                                    {people.map(p => (
                                                        <option key={p.id} value={p.name}>{p.name} ({p.department})</option>
                                                    ))}
                                                </select>
                                            </div>
                                        )}

                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Department</label>
                                            <select
                                                value={formData.department}
                                                onChange={e => setFormData({...formData, department: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                                disabled={formData.assignmentType === 'Individual' && formData.assignedTo}
                                            >
                                                <option value="">Select department...</option>
                                                {departments.map(d => (
                                                    <option key={d} value={d}>{d}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Location & Status */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Location</label>
                                        <input
                                            type="text"
                                            value={formData.location}
                                            onChange={e => setFormData({...formData, location: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                            placeholder="e.g., Station 5"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Status</label>
                                        <select
                                            value={formData.status}
                                            onChange={e => setFormData({...formData, status: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        >
                                            <option value="Active">Active</option>
                                            <option value="Retired">Retired</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Tool Status</label>
                                        <select
                                            value={formData.toolStatus}
                                            onChange={e => setFormData({...formData, toolStatus: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        >
                                            <option value="Present">Present</option>
                                            <option value="Missing">Missing</option>
                                            <option value="Loaned">Loaned</option>
                                            <option value="Warranty/Repair">Warranty/Repair</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Purchase Info */}
                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-3">Purchase Information</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Vendor</label>
                                            <select
                                                value={formData.vendor}
                                                onChange={e => setFormData({...formData, vendor: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                            >
                                                <option value="">Select vendor...</option>
                                                {vendors.map(v => (
                                                    <option key={v.id} value={v.name}>{v.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Purchase Date</label>
                                            <input
                                                type="date"
                                                value={formData.purchaseDate}
                                                onChange={e => setFormData({...formData, purchaseDate: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Cost ($)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.cost}
                                                onChange={e => setFormData({...formData, cost: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-1">Warranty Expiration</label>
                                            <input
                                                type="date"
                                                value={formData.warranty}
                                                onChange={e => setFormData({...formData, warranty: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Notes */}
                                <div>
                                    <label className="block text-sm font-semibold mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={e => setFormData({...formData, notes: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                        rows="2"
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button type="submit" className="btn-equipment-primary flex-1">
                                        {item ? 'Update' : 'Add'} Equipment
                                    </button>
                                    <button type="button" onClick={onClose} className="btn-equipment-secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Vendor Modal
        function VendorModal({ item, onSave, onClose }) {
            const [formData, setFormData] = useState(item || {
                name: '',
                contactPerson: '',
                phone: '',
                email: '',
                website: '',
                categories: [],
                paymentTerms: 'Net 30',
                preferred: false,
                notes: ''
            });
            const [categoryInput, setCategoryInput] = useState('');

            const addCategory = () => {
                if (categoryInput.trim() && !formData.categories.includes(categoryInput.trim())) {
                    setFormData({ ...formData, categories: [...formData.categories, categoryInput.trim()] });
                    setCategoryInput('');
                }
            };

            return (
                <div className="equipment-modal-overlay" onClick={onClose}>
                    <div className="equipment-modal-content" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <h2 className="text-2xl font-bold mb-4">{item ? 'Edit' : 'Add'} Vendor</h2>

                            <form onSubmit={e => { e.preventDefault(); onSave(formData); }} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2">
                                        <label className="block text-sm font-semibold mb-1">Vendor Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.name}
                                            onChange={e => setFormData({...formData, name: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Contact Person</label>
                                        <input
                                            type="text"
                                            value={formData.contactPerson}
                                            onChange={e => setFormData({...formData, contactPerson: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Phone</label>
                                        <input
                                            type="tel"
                                            value={formData.phone}
                                            onChange={e => setFormData({...formData, phone: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded font-mono"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={e => setFormData({...formData, email: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Website</label>
                                        <input
                                            type="text"
                                            value={formData.website}
                                            onChange={e => setFormData({...formData, website: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Payment Terms</label>
                                        <select
                                            value={formData.paymentTerms}
                                            onChange={e => setFormData({...formData, paymentTerms: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                        >
                                            <option value="Net 30">Net 30</option>
                                            <option value="Net 60">Net 60</option>
                                            <option value="Due on Receipt">Due on Receipt</option>
                                            <option value="COD">COD</option>
                                        </select>
                                    </div>
                                    <div className="flex items-end">
                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={formData.preferred}
                                                onChange={e => setFormData({...formData, preferred: e.target.checked})}
                                                className="w-4 h-4"
                                                style={{ accentColor: '#C8102E' }}
                                            />
                                            <span className="font-medium">Preferred Vendor</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-1">Categories</label>
                                    <div className="flex gap-2 mb-2">
                                        <input
                                            type="text"
                                            value={categoryInput}
                                            onChange={e => setCategoryInput(e.target.value)}
                                            onKeyPress={e => e.key === 'Enter' && (e.preventDefault(), addCategory())}
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded"
                                            placeholder="Add category..."
                                        />
                                        <button type="button" onClick={addCategory} className="btn-equipment-secondary">Add</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {formData.categories.map((cat, i) => (
                                            <span key={i} className="equipment-badge bg-blue-100 text-blue-800 flex items-center gap-1">
                                                {cat}
                                                <button
                                                    type="button"
                                                    onClick={() => setFormData({
                                                        ...formData,
                                                        categories: formData.categories.filter(c => c !== cat)
                                                    })}
                                                    className="text-red-500 hover:text-red-700 ml-1 font-bold"
                                                >√ó</button>
                                            </span>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-1">Notes</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={e => setFormData({...formData, notes: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                        rows="2"
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button type="submit" className="btn-equipment-primary flex-1">{item ? 'Update' : 'Add'} Vendor</button>
                                    <button type="button" onClick={onClose} className="btn-equipment-secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

    
  
        
        function App() {
            const auth = useAuth();
            
            // If not logged in, show login page
            if (!auth.currentUser) {
                return <LoginPage auth={auth} />;
            }
            
            // If logged in, show dashboard
            return <Dashboard auth={auth} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
        // ============================================================================
// EMERGENCY RECOVERY FUNCTION
// Accessible from browser console in case of lockout
// ============================================================================
window.MODA_EMERGENCY_ADMIN_RESTORE = function() {
    console.log('üö® EMERGENCY ADMIN RESTORE INITIATED');
    
    // Restore Trevor as protected admin
    const users = JSON.parse(localStorage.getItem('autovol_users') || '[]');
    const trevor = users.find(u => 
        u.email === 'trevor@autovol.com' || 
        (u.firstName === 'Trevor' && u.lastName === 'Fletcher')
    );
    
    if (trevor) {
        trevor.dashboardRole = 'admin';
        trevor.isProtected = true;
        localStorage.setItem('autovol_users', JSON.stringify(users));
        console.log('‚úÖ Trevor Fletcher restored as protected Admin');
        alert('‚úÖ Admin access restored to Trevor Fletcher. Refreshing page...');
        window.location.reload();
    } else {
        console.error('‚ùå Trevor Fletcher not found in user records');
        alert('‚ùå Could not find Trevor Fletcher in user records');
    }
};

// Log system status
console.log('üõ°Ô∏è MODA Dashboard Role System Loaded');
console.log('üõ°Ô∏è Emergency recovery: MODA_EMERGENCY_ADMIN_RESTORE()');
console.log('üõ°Ô∏è Trevor Fletcher account is protected');