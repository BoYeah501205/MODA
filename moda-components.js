/**
 * MODA Pre-Compiled Components
 * Generated: 2026-01-26T03:59:13.862Z
 * 
 * This file contains all JSX components pre-compiled to JavaScript.
 * DO NOT EDIT - regenerate with: node scripts/build-jsx.cjs
 */

// Extract React hooks once at bundle top (prevents duplicate declarations)
const { 
    useState, useEffect, useCallback, useMemo, useRef, 
    useContext, useReducer, useLayoutEffect, useImperativeHandle,
    useDebugValue, useDeferredValue, useTransition, useId,
    createContext, forwardRef, memo, lazy, Suspense, Fragment
} = React;


// ============================================================================
// FILE: ../js/contexts/ProjectContext.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA PROJECT CONTEXT
// Centralized state management for projects to eliminate props drilling
// ============================================================================

const ProjectContext = React.createContext(null);

// Custom hook to use project context
function useProjects() {
  const context = React.useContext(ProjectContext);
  if (!context) {
    throw new Error('useProjects must be used within a ProjectProvider');
  }
  return context;
}

// Project Provider Component
function ProjectProvider({
  children,
  initialProjects = []
}) {
// [Removed duplicate React destructuring]
  // Core project state
  const [projects, setProjects] = useState(initialProjects);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [lastSync, setLastSync] = useState(null);

  // Load projects from Supabase on mount
  useEffect(() => {
    let mounted = true;
    const loadProjects = async () => {
      // Check if Supabase is available
      if (window.MODA_SUPABASE_DATA?.isAvailable?.() && window.MODA_SUPABASE_DATA?.projects) {
        try {
          console.log('[ProjectContext] Loading from Supabase...');
          const supabaseProjects = await window.MODA_SUPABASE_DATA.projects.getAll();
          if (mounted && supabaseProjects) {
            setProjects(supabaseProjects);
            setLastSync(new Date());
            // Cache to localStorage for offline fallback
            localStorage.setItem('autovol_projects', JSON.stringify(supabaseProjects));
          }
        } catch (err) {
          console.error('[ProjectContext] Supabase load failed:', err);
          setError(err.message);
          // Fallback to localStorage
          loadFromLocalStorage();
        }
      } else {
        console.log('[ProjectContext] Supabase not available, using localStorage');
        loadFromLocalStorage();
      }
      if (mounted) {
        setLoading(false);
      }
    };
    const loadFromLocalStorage = () => {
      try {
        const saved = localStorage.getItem('autovol_projects');
        if (saved && saved !== 'undefined' && saved !== 'null') {
          setProjects(JSON.parse(saved));
        }
      } catch (e) {
        console.error('[ProjectContext] localStorage parse error:', e);
      }
    };

    // Small delay to ensure Supabase client is initialized
    const timer = setTimeout(loadProjects, 100);
    return () => {
      mounted = false;
      clearTimeout(timer);
    };
  }, []);

  // Save to Supabase and localStorage when projects change
  useEffect(() => {
    if (loading) return;

    // Always save to localStorage as fallback
    localStorage.setItem('autovol_projects', JSON.stringify(projects));

    // Sync to Supabase if available (debounced)
    const syncTimer = setTimeout(async () => {
      if (window.MODA_SUPABASE_DATA?.isAvailable?.() && window.MODA_SUPABASE_DATA?.projects) {
        try {
          // Note: Full sync would be handled by individual CRUD operations
          // This is just for tracking sync status
          setLastSync(new Date());
        } catch (err) {
          console.error('[ProjectContext] Sync error:', err);
        }
      }
    }, 500);
    return () => clearTimeout(syncTimer);
  }, [projects, loading]);

  // CRUD Operations
  const addProject = useCallback(async projectData => {
    const newProject = {
      id: projectData.id || `proj-${Date.now()}`,
      name: projectData.name || 'New Project',
      status: projectData.status || 'Planning',
      modules: projectData.modules || [],
      created_at: new Date().toISOString(),
      ...projectData
    };

    // Optimistic update
    setProjects(prev => [...prev, newProject]);

    // Sync to Supabase
    if (window.MODA_SUPABASE_DATA?.projects?.create) {
      try {
        const created = await window.MODA_SUPABASE_DATA.projects.create(newProject);
        // Update with server-generated ID if different
        if (created?.id && created.id !== newProject.id) {
          setProjects(prev => prev.map(p => p.id === newProject.id ? {
            ...p,
            id: created.id
          } : p));
        }
      } catch (err) {
        console.error('[ProjectContext] Create failed:', err);
        setError(err.message);
      }
    }

    // Log activity
    if (window.ActivityLog) {
      window.ActivityLog.logCreate('project', 'project', newProject.id, newProject.name, {
        status: newProject.status
      });
    }
    return newProject;
  }, []);
  const updateProject = useCallback(async (projectId, updates) => {
    // Optimistic update
    setProjects(prev => prev.map(p => p.id === projectId ? {
      ...p,
      ...updates,
      updated_at: new Date().toISOString()
    } : p));

    // Sync to Supabase
    if (window.MODA_SUPABASE_DATA?.projects?.update) {
      try {
        await window.MODA_SUPABASE_DATA.projects.update(projectId, updates);
      } catch (err) {
        console.error('[ProjectContext] Update failed:', err);
        setError(err.message);
      }
    }

    // Log activity
    if (window.ActivityLog) {
      const project = projects.find(p => p.id === projectId);
      window.ActivityLog.logUpdate('project', 'project', projectId, project?.name, updates);
    }
  }, [projects]);
  const deleteProject = useCallback(async projectId => {
    const project = projects.find(p => p.id === projectId);

    // Optimistic update
    setProjects(prev => prev.filter(p => p.id !== projectId));

    // Sync to Supabase
    if (window.MODA_SUPABASE_DATA?.projects?.delete) {
      try {
        await window.MODA_SUPABASE_DATA.projects.delete(projectId);
      } catch (err) {
        console.error('[ProjectContext] Delete failed:', err);
        setError(err.message);
        // Rollback on failure
        if (project) {
          setProjects(prev => [...prev, project]);
        }
      }
    }

    // Log activity
    if (window.ActivityLog && project) {
      window.ActivityLog.logDelete('project', 'project', projectId, project.name);
    }
  }, [projects]);

  // Module operations within projects
  const updateModuleProgress = useCallback((projectId, moduleId, stationId, progress) => {
    setProjects(prev => prev.map(project => {
      if (project.id !== projectId) return project;
      return {
        ...project,
        modules: (project.modules || []).map(module => {
          if (module.id !== moduleId) return module;
          const updatedProgress = {
            ...module.stageProgress
          };
          const wasComplete = updatedProgress[stationId] === 100;
          updatedProgress[stationId] = progress;

          // Track completion timestamps
          let stationCompletedAt = module.stationCompletedAt || {};
          if (progress === 100 && !wasComplete) {
            stationCompletedAt = {
              ...stationCompletedAt,
              [stationId]: Date.now()
            };
          } else if (progress < 100 && wasComplete) {
            stationCompletedAt = {
              ...stationCompletedAt
            };
            delete stationCompletedAt[stationId];
          }
          return {
            ...module,
            stageProgress: updatedProgress,
            stationCompletedAt
          };
        })
      };
    }));
  }, []);

  // Computed values
  const activeProjects = useMemo(() => projects.filter(p => p.status === 'Active'), [projects]);
  const projectCount = useMemo(() => ({
    total: projects.length,
    active: projects.filter(p => p.status === 'Active').length,
    planning: projects.filter(p => p.status === 'Planning').length,
    complete: projects.filter(p => p.status === 'Complete').length
  }), [projects]);

  // Get project by ID
  const getProject = useCallback(projectId => projects.find(p => p.id === projectId), [projects]);

  // Context value
  const value = useMemo(() => ({
    // State
    projects,
    setProjects,
    loading,
    error,
    lastSync,
    // CRUD
    addProject,
    updateProject,
    deleteProject,
    // Module operations
    updateModuleProgress,
    // Computed
    activeProjects,
    projectCount,
    // Utilities
    getProject
  }), [projects, loading, error, lastSync, addProject, updateProject, deleteProject, updateModuleProgress, activeProjects, projectCount, getProject]);
  return React.createElement(ProjectContext.Provider, {
    value
  }, children);
}

// Export to window for global access
window.ProjectContext = ProjectContext;
window.ProjectProvider = ProjectProvider;
window.useProjects = useProjects;
})();


// ============================================================================
// FILE: ui/Modal.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA SHARED MODAL COMPONENT
// Reusable modal dialog to replace 61+ duplicate implementations
// ============================================================================

const Modal = React.memo(function Modal({
  isOpen,
  onClose,
  title,
  size = 'md',
  children,
  footer,
  closeOnBackdrop = true,
  closeOnEscape = true,
  showCloseButton = true,
  className = ''
}) {
// [Removed duplicate React destructuring]
  // Size classes mapping
  const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-2xl',
    lg: 'max-w-4xl',
    xl: 'max-w-6xl',
    full: 'max-w-[95vw]'
  };

  // Handle escape key
  useEffect(() => {
    if (!isOpen || !closeOnEscape) return;
    const handleEscape = e => {
      if (e.key === 'Escape') {
        onClose();
      }
    };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [isOpen, closeOnEscape, onClose]);

  // Lock body scroll when modal is open
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);

  // Handle backdrop click
  const handleBackdropClick = useCallback(e => {
    if (closeOnBackdrop && e.target === e.currentTarget) {
      onClose();
    }
  }, [closeOnBackdrop, onClose]);

  // Don't render if not open
  if (!isOpen) return null;
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: handleBackdropClick
  }, /*#__PURE__*/React.createElement("div", {
    className: `bg-white rounded-lg shadow-xl ${sizeClasses[size] || sizeClasses.md} w-full max-h-[90vh] overflow-hidden flex flex-col ${className}`,
    onClick: e => e.stopPropagation()
  }, (title || showCloseButton) && /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex justify-between items-center shrink-0"
  }, title && /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, title), showCloseButton && /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-1 hover:bg-gray-100 rounded text-gray-500 hover:text-gray-700 text-2xl leading-none ml-auto",
    "aria-label": "Close modal"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 overflow-y-auto flex-1"
  }, children), footer && /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t shrink-0 bg-gray-50"
  }, footer)));
});

// ============================================================================
// MODAL FOOTER HELPERS
// Common footer patterns for consistency
// ============================================================================

const ModalFooter = React.memo(function ModalFooter({
  children,
  className = ''
}) {
  return /*#__PURE__*/React.createElement("div", {
    className: `flex justify-end gap-2 ${className}`
  }, children);
});
const ModalCancelButton = React.memo(function ModalCancelButton({
  onClick,
  children = 'Cancel',
  disabled = false
}) {
  return /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClick,
    disabled: disabled,
    className: "px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors disabled:opacity-50"
  }, children);
});
const ModalSubmitButton = React.memo(function ModalSubmitButton({
  onClick,
  children = 'Save',
  disabled = false,
  loading = false,
  variant = 'primary'
}) {
  const variantClasses = {
    primary: 'bg-teal-600 hover:bg-teal-700 text-white',
    danger: 'bg-red-600 hover:bg-red-700 text-white',
    secondary: 'bg-gray-600 hover:bg-gray-700 text-white'
  };
  return /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClick,
    disabled: disabled || loading,
    className: `px-4 py-2 rounded-lg transition-colors disabled:opacity-50 ${variantClasses[variant] || variantClasses.primary}`
  }, loading ? /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "animate-spin"
  }, "\u21BB"), "Loading...") : children);
});

// ============================================================================
// CONFIRMATION MODAL
// Pre-built modal for delete/confirm actions
// ============================================================================

const ConfirmModal = React.memo(function ConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title = 'Confirm Action',
  message = 'Are you sure you want to proceed?',
  confirmText = 'Confirm',
  cancelText = 'Cancel',
  variant = 'danger',
  loading = false
}) {
  return /*#__PURE__*/React.createElement(Modal, {
    isOpen: isOpen,
    onClose: onClose,
    title: title,
    size: "sm",
    footer: /*#__PURE__*/React.createElement(ModalFooter, null, /*#__PURE__*/React.createElement(ModalCancelButton, {
      onClick: onClose,
      disabled: loading
    }, cancelText), /*#__PURE__*/React.createElement(ModalSubmitButton, {
      onClick: onConfirm,
      variant: variant,
      loading: loading
    }, confirmText))
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, message));
});

// Export to window for global access
window.Modal = Modal;
window.ModalFooter = ModalFooter;
window.ModalCancelButton = ModalCancelButton;
window.ModalSubmitButton = ModalSubmitButton;
window.ConfirmModal = ConfirmModal;
})();


// ============================================================================
// FILE: ui/StatusBadge.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA SHARED STATUS BADGE COMPONENT
// Reusable status/priority badges to replace 36+ duplicate implementations
// ============================================================================

const STATUS_VARIANTS = {
  // General statuses
  active: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  pending: {
    bg: 'bg-yellow-100',
    text: 'text-yellow-800',
    border: 'border-yellow-200'
  },
  complete: {
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    border: 'border-blue-200'
  },
  completed: {
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    border: 'border-blue-200'
  },
  error: {
    bg: 'bg-red-100',
    text: 'text-red-800',
    border: 'border-red-200'
  },
  warning: {
    bg: 'bg-orange-100',
    text: 'text-orange-800',
    border: 'border-orange-200'
  },
  info: {
    bg: 'bg-cyan-100',
    text: 'text-cyan-800',
    border: 'border-cyan-200'
  },
  neutral: {
    bg: 'bg-gray-100',
    text: 'text-gray-800',
    border: 'border-gray-200'
  },
  // Production statuses
  scheduled: {
    bg: 'bg-gray-100',
    text: 'text-gray-600',
    border: 'border-gray-200'
  },
  inprogress: {
    bg: 'bg-teal-100',
    text: 'text-teal-800',
    border: 'border-teal-200'
  },
  'in-progress': {
    bg: 'bg-teal-100',
    text: 'text-teal-800',
    border: 'border-teal-200'
  },
  // Project statuses
  planning: {
    bg: 'bg-purple-100',
    text: 'text-purple-800',
    border: 'border-purple-200'
  },
  production: {
    bg: 'bg-teal-100',
    text: 'text-teal-800',
    border: 'border-teal-200'
  },
  transport: {
    bg: 'bg-indigo-100',
    text: 'text-indigo-800',
    border: 'border-indigo-200'
  },
  onsite: {
    bg: 'bg-orange-100',
    text: 'text-orange-800',
    border: 'border-orange-200'
  },
  // Priority levels
  low: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  medium: {
    bg: 'bg-yellow-100',
    text: 'text-yellow-800',
    border: 'border-yellow-200'
  },
  high: {
    bg: 'bg-orange-100',
    text: 'text-orange-800',
    border: 'border-orange-200'
  },
  critical: {
    bg: 'bg-red-100',
    text: 'text-red-800',
    border: 'border-red-200'
  },
  urgent: {
    bg: 'bg-red-100',
    text: 'text-red-800',
    border: 'border-red-200'
  },
  // Boolean states
  yes: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  no: {
    bg: 'bg-gray-100',
    text: 'text-gray-600',
    border: 'border-gray-200'
  },
  true: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  false: {
    bg: 'bg-gray-100',
    text: 'text-gray-600',
    border: 'border-gray-200'
  },
  // QA statuses
  pass: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  fail: {
    bg: 'bg-red-100',
    text: 'text-red-800',
    border: 'border-red-200'
  },
  hold: {
    bg: 'bg-yellow-100',
    text: 'text-yellow-800',
    border: 'border-yellow-200'
  },
  // Transport statuses
  ready: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  staged: {
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    border: 'border-blue-200'
  },
  intransit: {
    bg: 'bg-purple-100',
    text: 'text-purple-800',
    border: 'border-purple-200'
  },
  'in-transit': {
    bg: 'bg-purple-100',
    text: 'text-purple-800',
    border: 'border-purple-200'
  },
  arrived: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  },
  delivered: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200'
  }
};
const StatusBadge = React.memo(function StatusBadge({
  status,
  label,
  variant,
  size = 'sm',
  showBorder = false,
  className = ''
}) {
  // Normalize the variant key
  const variantKey = (variant || status || 'neutral').toString().toLowerCase().replace(/[\s_]+/g, '');
  const colors = STATUS_VARIANTS[variantKey] || STATUS_VARIANTS.neutral;
  const sizeClasses = {
    xs: 'px-1.5 py-0.5 text-xs',
    sm: 'px-2 py-1 text-xs',
    md: 'px-3 py-1.5 text-sm'
  };

  // Format display label
  const displayLabel = label || status || 'Unknown';
  return /*#__PURE__*/React.createElement("span", {
    className: `
            inline-flex items-center rounded font-medium whitespace-nowrap
            ${colors.bg} ${colors.text}
            ${showBorder ? `border ${colors.border}` : ''}
            ${sizeClasses[size] || sizeClasses.sm}
            ${className}
        `.trim()
  }, displayLabel);
});

// ============================================================================
// PRIORITY BADGE - Specialized for priority levels
// ============================================================================

const PriorityBadge = React.memo(function PriorityBadge({
  priority,
  size = 'sm',
  showIcon = false,
  className = ''
}) {
  const priorityConfig = {
    low: {
      label: 'Low',
      icon: '↓',
      variant: 'low'
    },
    medium: {
      label: 'Medium',
      icon: '→',
      variant: 'medium'
    },
    high: {
      label: 'High',
      icon: '↑',
      variant: 'high'
    },
    critical: {
      label: 'Critical',
      icon: '!!',
      variant: 'critical'
    },
    urgent: {
      label: 'Urgent',
      icon: '!!',
      variant: 'urgent'
    }
  };
  const config = priorityConfig[priority?.toLowerCase()] || priorityConfig.medium;
  return /*#__PURE__*/React.createElement(StatusBadge, {
    status: config.label,
    variant: config.variant,
    size: size,
    label: showIcon ? `${config.icon} ${config.label}` : config.label,
    className: className
  });
});

// ============================================================================
// BOOLEAN BADGE - For yes/no, true/false, pass/fail
// ============================================================================

const BooleanBadge = React.memo(function BooleanBadge({
  value,
  trueLabel = 'Yes',
  falseLabel = 'No',
  size = 'sm',
  className = ''
}) {
  const isTrue = value === true || value === 'yes' || value === 'true' || value === 'pass';
  return /*#__PURE__*/React.createElement(StatusBadge, {
    status: isTrue ? trueLabel : falseLabel,
    variant: isTrue ? 'yes' : 'no',
    size: size,
    className: className
  });
});

// Export to window for global access
window.StatusBadge = StatusBadge;
window.PriorityBadge = PriorityBadge;
window.BooleanBadge = BooleanBadge;
window.STATUS_VARIANTS = STATUS_VARIANTS;
})();


// ============================================================================
// FILE: ui/DifficultyBadge.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA SHARED DIFFICULTY BADGE COMPONENT
// Centralized difficulty colors/labels to replace 116+ duplicate definitions
// ============================================================================

const DIFFICULTY_CONFIG = {
  sidewall: {
    label: 'Sidewall',
    abbrev: 'SW',
    bg: 'bg-orange-100',
    text: 'text-orange-800',
    border: 'border-orange-200',
    description: 'Module with sidewall construction'
  },
  stair: {
    label: 'Stair',
    abbrev: 'STAIR',
    bg: 'bg-purple-100',
    text: 'text-purple-800',
    border: 'border-purple-200',
    description: 'Module contains stairwell'
  },
  hr3Wall: {
    label: '3HR Wall',
    abbrev: '3HR',
    bg: 'bg-red-100',
    text: 'text-red-800',
    border: 'border-red-200',
    description: '3-hour fire-rated wall'
  },
  short: {
    label: 'Short',
    abbrev: 'SHORT',
    bg: 'bg-yellow-100',
    text: 'text-yellow-800',
    border: 'border-yellow-200',
    description: 'Short module (reduced height)'
  },
  doubleStudio: {
    label: 'Dbl Studio',
    abbrev: 'DBL',
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    border: 'border-blue-200',
    description: 'Double studio unit'
  },
  sawbox: {
    label: 'Sawbox',
    abbrev: 'SAWBOX',
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-200',
    description: 'Sawbox construction type'
  },
  proto: {
    label: 'Prototype',
    abbrev: 'PROTO',
    bg: 'bg-pink-100',
    text: 'text-pink-800',
    border: 'border-pink-200',
    description: 'Prototype/first-of-kind module'
  }
};

// Heat map difficulty categories (for labor calculations)
const HEAT_MAP_CATEGORIES = {
  easy: {
    label: 'Easy',
    multiplier: 0.8,
    bg: 'bg-green-100',
    text: 'text-green-800',
    color: '#86efac'
  },
  average: {
    label: 'Average',
    multiplier: 1.0,
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    color: '#93c5fd'
  },
  medium: {
    label: 'Medium',
    multiplier: 1.2,
    bg: 'bg-yellow-100',
    text: 'text-yellow-800',
    color: '#fde047'
  },
  hard: {
    label: 'Hard',
    multiplier: 1.4,
    bg: 'bg-orange-100',
    text: 'text-orange-800',
    color: '#fdba74'
  },
  very_hard: {
    label: 'Very Hard',
    multiplier: 1.6,
    bg: 'bg-red-100',
    text: 'text-red-800',
    color: '#fca5a5'
  }
};

// ============================================================================
// SINGLE DIFFICULTY BADGE
// ============================================================================

const DifficultyBadge = React.memo(function DifficultyBadge({
  type,
  compact = false,
  showBorder = false,
  className = ''
}) {
  const config = DIFFICULTY_CONFIG[type];
  if (!config) return null;
  return /*#__PURE__*/React.createElement("span", {
    className: `
                inline-flex items-center px-2 py-0.5 text-xs rounded font-medium
                ${config.bg} ${config.text}
                ${showBorder ? `border ${config.border}` : ''}
                ${className}
            `.trim(),
    title: config.description
  }, compact ? config.abbrev : config.label);
});

// ============================================================================
// MULTIPLE DIFFICULTY BADGES
// Renders all active difficulties for a module
// ============================================================================

const DifficultyBadges = React.memo(function DifficultyBadges({
  difficulties,
  compact = false,
  maxVisible = null,
  className = ''
}) {
  // Get active difficulties
  const activeDifficulties = Object.entries(difficulties || {}).filter(([_, active]) => active).map(([type]) => type);
  if (activeDifficulties.length === 0) return null;

  // Limit visible badges if maxVisible is set
  const visibleDifficulties = maxVisible ? activeDifficulties.slice(0, maxVisible) : activeDifficulties;
  const hiddenCount = activeDifficulties.length - visibleDifficulties.length;
  return /*#__PURE__*/React.createElement("div", {
    className: `flex flex-wrap gap-1 ${className}`
  }, visibleDifficulties.map(type => /*#__PURE__*/React.createElement(DifficultyBadge, {
    key: type,
    type: type,
    compact: compact
  })), hiddenCount > 0 && /*#__PURE__*/React.createElement("span", {
    className: "inline-flex items-center px-2 py-0.5 text-xs rounded font-medium bg-gray-100 text-gray-600",
    title: activeDifficulties.slice(maxVisible).map(t => DIFFICULTY_CONFIG[t]?.label).join(', ')
  }, "+", hiddenCount));
});

// ============================================================================
// HEAT MAP CATEGORY BADGE
// For labor difficulty ratings
// ============================================================================

const HeatMapBadge = React.memo(function HeatMapBadge({
  category,
  showMultiplier = false,
  className = ''
}) {
  const config = HEAT_MAP_CATEGORIES[category];
  if (!config) return null;
  return /*#__PURE__*/React.createElement("span", {
    className: `
                inline-flex items-center px-2 py-0.5 text-xs rounded font-medium
                ${config.bg} ${config.text}
                ${className}
            `.trim()
  }, config.label, showMultiplier && /*#__PURE__*/React.createElement("span", {
    className: "ml-1 opacity-75"
  }, "(", config.multiplier, "x)"));
});

// ============================================================================
// DIFFICULTY COUNT SUMMARY
// Shows count of each difficulty type
// ============================================================================

const DifficultySummary = React.memo(function DifficultySummary({
  modules,
  className = ''
}) {
  // Count difficulties across all modules
  const counts = React.useMemo(() => {
    const result = {};
    Object.keys(DIFFICULTY_CONFIG).forEach(key => {
      result[key] = 0;
    });
    (modules || []).forEach(module => {
      const difficulties = module.difficulties || {};
      Object.entries(difficulties).forEach(([type, active]) => {
        if (active && result[type] !== undefined) {
          result[type]++;
        }
      });
    });
    return result;
  }, [modules]);

  // Filter to only show non-zero counts
  const activeCounts = Object.entries(counts).filter(([_, count]) => count > 0);
  if (activeCounts.length === 0) {
    return /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 text-sm"
    }, "No difficulties");
  }
  return /*#__PURE__*/React.createElement("div", {
    className: `flex flex-wrap gap-2 ${className}`
  }, activeCounts.map(([type, count]) => {
    const config = DIFFICULTY_CONFIG[type];
    return /*#__PURE__*/React.createElement("span", {
      key: type,
      className: `inline-flex items-center gap-1 px-2 py-1 text-xs rounded ${config.bg} ${config.text}`
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-bold"
    }, count), /*#__PURE__*/React.createElement("span", null, config.abbrev));
  }));
});

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Get difficulty label by type
function getDifficultyLabel(type) {
  return DIFFICULTY_CONFIG[type]?.label || type;
}

// Get difficulty abbreviation by type
function getDifficultyAbbrev(type) {
  return DIFFICULTY_CONFIG[type]?.abbrev || type;
}

// Get all difficulty types
function getDifficultyTypes() {
  return Object.keys(DIFFICULTY_CONFIG);
}

// Check if module has any difficulties
function hasAnyDifficulty(difficulties) {
  return Object.values(difficulties || {}).some(v => v === true);
}

// Count active difficulties
function countDifficulties(difficulties) {
  return Object.values(difficulties || {}).filter(v => v === true).length;
}

// Export to window for global access
window.DifficultyBadge = DifficultyBadge;
window.DifficultyBadges = DifficultyBadges;
window.HeatMapBadge = HeatMapBadge;
window.DifficultySummary = DifficultySummary;
window.DIFFICULTY_CONFIG = DIFFICULTY_CONFIG;
window.HEAT_MAP_CATEGORIES = HEAT_MAP_CATEGORIES;
window.getDifficultyLabel = getDifficultyLabel;
window.getDifficultyAbbrev = getDifficultyAbbrev;
window.getDifficultyTypes = getDifficultyTypes;
window.hasAnyDifficulty = hasAnyDifficulty;
window.countDifficulties = countDifficulties;
})();


// ============================================================================
// FILE: ui/ProgressBar.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA SHARED PROGRESS BAR COMPONENT
// Reusable progress indicators for consistency across the app
// ============================================================================

const ProgressBar = React.memo(function ProgressBar({
  value,
  max = 100,
  size = 'md',
  showLabel = false,
  labelPosition = 'right',
  color = 'auto',
  animate = true,
  className = ''
}) {
  const percentage = Math.min(100, Math.max(0, value / max * 100));
  const sizeClasses = {
    xs: 'h-1',
    sm: 'h-1.5',
    md: 'h-2',
    lg: 'h-3',
    xl: 'h-4'
  };

  // Auto color based on percentage
  const getAutoColor = () => {
    if (percentage === 100) return 'bg-green-500';
    if (percentage >= 75) return 'bg-teal-500';
    if (percentage >= 50) return 'bg-blue-500';
    if (percentage >= 25) return 'bg-yellow-500';
    return 'bg-gray-400';
  };
  const colorClasses = {
    auto: getAutoColor(),
    teal: percentage === 100 ? 'bg-green-500' : 'bg-teal-500',
    blue: 'bg-blue-500',
    green: 'bg-green-500',
    red: 'bg-red-500',
    yellow: 'bg-yellow-500',
    orange: 'bg-orange-500',
    purple: 'bg-purple-500',
    gray: 'bg-gray-500'
  };
  const barColor = colorClasses[color] || colorClasses.auto;
  const label = /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500 tabular-nums"
  }, Math.round(percentage), "%");
  return /*#__PURE__*/React.createElement("div", {
    className: `flex items-center gap-2 ${className}`
  }, showLabel && labelPosition === 'left' && label, /*#__PURE__*/React.createElement("div", {
    className: `flex-1 bg-gray-200 rounded-full ${sizeClasses[size]} overflow-hidden`
  }, /*#__PURE__*/React.createElement("div", {
    className: `
                        ${sizeClasses[size]} rounded-full 
                        ${barColor}
                        ${animate ? 'transition-all duration-300 ease-out' : ''}
                    `.trim(),
    style: {
      width: `${percentage}%`
    }
  })), showLabel && labelPosition === 'right' && label);
});

// ============================================================================
// STAGE PROGRESS BAR
// Specialized for production stage progress (0-100 per stage)
// ============================================================================

const StageProgressBar = React.memo(function StageProgressBar({
  progress = 0,
  stageName = '',
  size = 'sm',
  showPercentage = true,
  onClick,
  className = ''
}) {
  const percentage = Math.min(100, Math.max(0, progress));

  // Color based on progress
  const getColor = () => {
    if (percentage === 100) return 'bg-green-500';
    if (percentage > 0) return 'bg-teal-500';
    return 'bg-gray-300';
  };
  const sizeClasses = {
    xs: 'h-1',
    sm: 'h-2',
    md: 'h-3',
    lg: 'h-4'
  };
  return /*#__PURE__*/React.createElement("div", {
    className: `group ${onClick ? 'cursor-pointer' : ''} ${className}`,
    onClick: onClick,
    title: stageName ? `${stageName}: ${percentage}%` : `${percentage}%`
  }, /*#__PURE__*/React.createElement("div", {
    className: `bg-gray-200 rounded-full ${sizeClasses[size]} overflow-hidden ${onClick ? 'group-hover:bg-gray-300' : ''}`
  }, /*#__PURE__*/React.createElement("div", {
    className: `${sizeClasses[size]} rounded-full transition-all duration-200 ${getColor()}`,
    style: {
      width: `${percentage}%`
    }
  })), showPercentage && /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 text-center mt-0.5"
  }, percentage, "%"));
});

// ============================================================================
// MULTI-STAGE PROGRESS
// Shows progress across multiple production stages
// ============================================================================

const MultiStageProgress = React.memo(function MultiStageProgress({
  stageProgress = {},
  stages = [],
  size = 'sm',
  showLabels = false,
  compact = false,
  className = ''
}) {
  // Calculate overall progress
  const stageCount = stages.length || Object.keys(stageProgress).length;
  const totalProgress = Object.values(stageProgress).reduce((sum, val) => sum + (val || 0), 0);
  const overallPercentage = stageCount > 0 ? Math.round(totalProgress / stageCount) : 0;
  if (compact) {
    // Single bar showing overall progress
    return /*#__PURE__*/React.createElement(ProgressBar, {
      value: overallPercentage,
      size: size,
      showLabel: showLabels,
      className: className
    });
  }

  // Individual bars for each stage
  const stageList = stages.length > 0 ? stages : Object.keys(stageProgress).map(id => ({
    id,
    name: id
  }));
  return /*#__PURE__*/React.createElement("div", {
    className: `flex gap-1 ${className}`
  }, stageList.map(stage => {
    const stageId = typeof stage === 'string' ? stage : stage.id;
    const stageName = typeof stage === 'string' ? stage : stage.name;
    const progress = stageProgress[stageId] || 0;
    return /*#__PURE__*/React.createElement("div", {
      key: stageId,
      className: "flex-1",
      title: `${stageName}: ${progress}%`
    }, /*#__PURE__*/React.createElement(StageProgressBar, {
      progress: progress,
      stageName: stageName,
      size: size,
      showPercentage: false
    }));
  }));
});

// ============================================================================
// CIRCULAR PROGRESS
// Circular/ring progress indicator
// ============================================================================

const CircularProgress = React.memo(function CircularProgress({
  value,
  max = 100,
  size = 40,
  strokeWidth = 4,
  color = 'teal',
  showLabel = true,
  className = ''
}) {
  const percentage = Math.min(100, Math.max(0, value / max * 100));
  const radius = (size - strokeWidth) / 2;
  const circumference = radius * 2 * Math.PI;
  const offset = circumference - percentage / 100 * circumference;
  const colorClasses = {
    teal: 'text-teal-500',
    blue: 'text-blue-500',
    green: 'text-green-500',
    red: 'text-red-500',
    yellow: 'text-yellow-500',
    purple: 'text-purple-500'
  };
  return /*#__PURE__*/React.createElement("div", {
    className: `relative inline-flex items-center justify-center ${className}`
  }, /*#__PURE__*/React.createElement("svg", {
    width: size,
    height: size,
    className: "transform -rotate-90"
  }, /*#__PURE__*/React.createElement("circle", {
    cx: size / 2,
    cy: size / 2,
    r: radius,
    fill: "none",
    stroke: "currentColor",
    strokeWidth: strokeWidth,
    className: "text-gray-200"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: size / 2,
    cy: size / 2,
    r: radius,
    fill: "none",
    stroke: "currentColor",
    strokeWidth: strokeWidth,
    strokeDasharray: circumference,
    strokeDashoffset: offset,
    strokeLinecap: "round",
    className: `${colorClasses[color] || colorClasses.teal} transition-all duration-300`
  })), showLabel && /*#__PURE__*/React.createElement("span", {
    className: "absolute text-xs font-medium text-gray-700"
  }, Math.round(percentage), "%"));
});

// Export to window for global access
window.ProgressBar = ProgressBar;
window.StageProgressBar = StageProgressBar;
window.MultiStageProgress = MultiStageProgress;
window.CircularProgress = CircularProgress;
})();


// ============================================================================
// FILE: auth/AuthConstants.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA AUTH CONSTANTS
// Shared constants for authentication and role management
// Must load before AuthModule.jsx
// ============================================================================

// All available tabs in MODA system
window.ALL_AVAILABLE_TABS = [{
  id: 'executive',
  label: 'Executive',
  icon: 'icon-executive',
  description: 'High-level operational overview'
}, {
  id: 'production',
  label: 'Production',
  icon: 'icon-production',
  description: 'Production floor management'
}, {
  id: 'projects',
  label: 'Projects',
  icon: 'icon-projects',
  description: 'Project directory and tracking'
}, {
  id: 'people',
  label: 'People',
  icon: 'icon-people',
  description: 'Workforce management'
}, {
  id: 'qa',
  label: 'QA',
  icon: 'icon-qa',
  description: 'Quality assurance tracking'
}, {
  id: 'transport',
  label: 'Transport',
  icon: 'icon-transport',
  description: 'Transportation & logistics'
}, {
  id: 'supplychain',
  label: 'Supply Chain',
  icon: 'icon-supply-chain',
  description: 'Material shortage tracking'
}, {
  id: 'equipment',
  label: 'Equipment',
  icon: 'icon-equipment',
  description: 'Tools & equipment tracking'
}, {
  id: 'precon',
  label: 'Precon',
  icon: 'icon-precon',
  description: 'Preconstruction planning & estimates'
}, {
  id: 'rfi',
  label: 'RFI',
  icon: 'icon-rfi',
  description: 'Request for Information management'
}, {
  id: 'onsite',
  label: 'On-Site',
  icon: 'icon-onsite',
  description: 'Field operations & reporting'
}, {
  id: 'engineering',
  label: 'Engineering',
  icon: 'icon-engineering',
  description: 'Engineering documentation'
}, {
  id: 'drawings',
  label: 'Drawings',
  icon: 'icon-drawings',
  description: 'Project drawings management'
}, {
  id: 'automation',
  label: 'Automation',
  icon: 'icon-automation',
  description: 'Automation systems'
}, {
  id: 'tracker',
  label: 'Tracker',
  icon: 'icon-tracker',
  description: 'Module tracking system'
}, {
  id: 'admin',
  label: 'Admin',
  icon: 'icon-admin',
  description: 'System administration'
}];

// Special features/sub-tabs that need permission control (not main navigation tabs)
window.SPECIAL_FEATURES = [{
  id: 'schedule_setup',
  label: 'Schedule Setup',
  parentTab: 'production',
  description: 'Configure weekly production schedule'
}, {
  id: 'weekly_board',
  label: 'Weekly Board',
  parentTab: 'production',
  description: 'Manage weekly production board'
}, {
  id: 'station_stagger',
  label: 'Station Stagger',
  parentTab: 'production',
  description: 'Configure station timing and stagger'
}];

// All permission-controlled items (tabs + special features)
window.ALL_PERMISSION_ITEMS = [...window.ALL_AVAILABLE_TABS, ...window.SPECIAL_FEATURES];

// Default role configurations
// tabPermissions: per-tab permissions object { tabId: { canView, canEdit, canCreate, canDelete } }
// If a tab is in 'tabs' array but not in tabPermissions, it defaults to view-only
// If tabPermissions[tabId] exists, those permissions apply for that specific tab
window.DEFAULT_DASHBOARD_ROLES = [{
  id: 'admin',
  name: 'Admin',
  description: 'Full system access for operations management',
  tabs: ['executive', 'production', 'projects', 'people', 'qa', 'transport', 'supplychain', 'equipment', 'precon', 'rfi', 'onsite', 'engineering', 'drawings', 'automation', 'tracker', 'admin'],
  capabilities: {
    canManageUsers: true,
    canAccessAdmin: true,
    canExportData: true
  },
  tabPermissions: {
    executive: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    production: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    projects: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    people: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    qa: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    transport: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    supplychain: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    equipment: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    precon: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    rfi: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    onsite: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    engineering: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    drawings: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    automation: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    tracker: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    admin: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    schedule_setup: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    weekly_board: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    station_stagger: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    }
  },
  isDefault: false,
  isProtected: true
}, {
  id: 'production_management',
  name: 'Production Management',
  description: 'Manages production schedules, weekly board, and station configuration',
  tabs: ['executive', 'production', 'projects', 'people', 'qa'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    executive: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    production: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    projects: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    people: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    qa: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    schedule_setup: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    weekly_board: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    },
    station_stagger: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'production_supervisor',
  name: 'Production Supervisor',
  description: 'Floor supervisor - can edit Weekly Board but not schedule setup',
  tabs: ['production', 'projects', 'people', 'qa'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    people: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    qa: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    schedule_setup: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    weekly_board: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    station_stagger: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'qa_inspector',
  name: 'QA Inspector',
  description: 'Quality assurance - can edit QA records and inspections',
  tabs: ['production', 'qa', 'projects'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    qa: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'transportation',
  name: 'Transportation',
  description: 'Manages yard, shipping, and logistics',
  tabs: ['production', 'transport', 'projects'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    transport: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'supply_chain',
  name: 'Supply Chain',
  description: 'Manages inventory, materials, and procurement',
  tabs: ['production', 'projects', 'equipment', 'supplychain'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    equipment: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    supplychain: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: true
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'preconstruction',
  name: 'Preconstruction',
  description: 'Project setup, module specs, and planning',
  tabs: ['projects', 'production', 'engineering', 'precon'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    projects: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    engineering: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    precon: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'onsite',
  name: 'On-Site',
  description: 'Field operations, delivery tracking, and site reporting',
  tabs: ['production', 'onsite', 'transport', 'projects'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: false
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    onsite: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    transport: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'engineering',
  name: 'Engineering',
  description: 'Engineering documentation, issues, and drawings',
  tabs: ['production', 'engineering', 'projects', 'qa'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    engineering: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    qa: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    station_stagger: {
      canView: true,
      canEdit: true,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'maintenance',
  name: 'Maintenance',
  description: 'Equipment maintenance and repair tracking',
  tabs: ['production', 'equipment'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: false
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    equipment: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'executive',
  name: 'Executive',
  description: 'CEO/CTO high-level operational view (view-only)',
  tabs: ['executive', 'production', 'projects', 'people'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    executive: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    },
    people: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'department-supervisor',
  name: 'Department Supervisor',
  description: 'Department-level management view',
  tabs: ['production', 'projects', 'people'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: true
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: true,
      canCreate: false,
      canDelete: false
    },
    people: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'coordinator',
  name: 'Coordinator',
  description: 'Cross-department coordination role',
  tabs: ['production', 'projects'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: false
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: true,
      canCreate: true,
      canDelete: false
    },
    projects: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: false,
  isProtected: false
}, {
  id: 'employee',
  name: 'Employee',
  description: 'Basic production floor view (view-only)',
  tabs: ['production'],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: false
  },
  tabPermissions: {
    production: {
      canView: true,
      canEdit: false,
      canCreate: false,
      canDelete: false
    }
  },
  isDefault: true,
  isProtected: false
}, {
  id: 'no-access',
  name: 'No Access',
  description: 'Cannot log in to system',
  tabs: [],
  capabilities: {
    canManageUsers: false,
    canAccessAdmin: false,
    canExportData: false
  },
  tabPermissions: {},
  isDefault: false,
  isProtected: true
}];
console.log('Auth constants loaded');
})();


// ============================================================================
// FILE: auth/AuthModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA AUTHENTICATION MODULE
// Extracted from App.jsx for better maintainability
// ============================================================================
// [Removed duplicate React destructuring]
// Check if Supabase roles API is available
function isSupabaseRolesAvailable() {
  return window.MODA_SUPABASE_DATA?.isAvailable?.() && window.MODA_SUPABASE_DATA?.dashboardRoles;
}

// Get localStorage fallback roles (for offline/initial load)
// Uses DEFAULT_DASHBOARD_ROLES from dashboardRoles.js if available
function getDefaultRoles() {
  // Prefer the full DEFAULT_DASHBOARD_ROLES from dashboardRoles.js
  if (window.DEFAULT_DASHBOARD_ROLES && Array.isArray(window.DEFAULT_DASHBOARD_ROLES) && window.DEFAULT_DASHBOARD_ROLES.length > 0) {
    return window.DEFAULT_DASHBOARD_ROLES;
  }
  // Full fallback with all roles if dashboardRoles.js hasn't loaded yet
  return [{
    id: 'admin',
    name: 'Admin',
    tabs: ['executive', 'production', 'projects', 'people', 'qa', 'transport', 'equipment', 'onsite', 'engineering', 'automation', 'tracker', 'admin'],
    capabilities: {
      canManageUsers: true,
      canAccessAdmin: true,
      canExportData: true,
      canEdit: true,
      canDelete: true,
      canCreate: true
    },
    tabPermissions: {},
    editableTabs: ['production', 'projects', 'people', 'qa', 'transport', 'equipment', 'onsite', 'engineering', 'automation', 'tracker', 'admin'],
    isDefault: false,
    isProtected: true
  }, {
    id: 'production_management',
    name: 'Production Management',
    tabs: ['executive', 'production', 'projects', 'people', 'qa'],
    capabilities: {
      canEdit: true,
      canDelete: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['production', 'projects'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'production_supervisor',
    name: 'Production Supervisor',
    tabs: ['production', 'projects', 'people', 'qa'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['production'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'qa_inspector',
    name: 'QA Inspector',
    tabs: ['production', 'qa', 'projects'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['qa'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'transportation',
    name: 'Transportation',
    tabs: ['production', 'transport', 'projects'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['transport'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'supply_chain',
    name: 'Supply Chain',
    tabs: ['production', 'projects', 'equipment'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['equipment'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'preconstruction',
    name: 'Preconstruction',
    tabs: ['projects', 'production', 'engineering'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['projects'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'onsite',
    name: 'On-Site',
    tabs: ['production', 'onsite', 'transport', 'projects'],
    capabilities: {
      canEdit: true,
      canCreate: true
    },
    tabPermissions: {},
    editableTabs: ['onsite'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'engineering',
    name: 'Engineering',
    tabs: ['production', 'engineering', 'projects', 'qa'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['engineering'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'maintenance',
    name: 'Maintenance',
    tabs: ['production', 'equipment'],
    capabilities: {
      canEdit: true,
      canCreate: true
    },
    tabPermissions: {},
    editableTabs: ['equipment'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'executive',
    name: 'Executive',
    tabs: ['executive', 'production', 'projects', 'people'],
    capabilities: {
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: [],
    isDefault: false,
    isProtected: false
  }, {
    id: 'department-supervisor',
    name: 'Department Supervisor',
    tabs: ['production', 'projects', 'people'],
    capabilities: {
      canEdit: true,
      canCreate: true,
      canExportData: true
    },
    tabPermissions: {},
    editableTabs: ['production'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'coordinator',
    name: 'Coordinator',
    tabs: ['production', 'projects'],
    capabilities: {
      canEdit: true,
      canCreate: true
    },
    tabPermissions: {},
    editableTabs: ['production'],
    isDefault: false,
    isProtected: false
  }, {
    id: 'employee',
    name: 'Employee',
    tabs: ['production'],
    capabilities: {},
    tabPermissions: {},
    editableTabs: [],
    isDefault: true,
    isProtected: false
  }];
}
function getLocalStorageRoles() {
  const ROLES_VERSION = 3; // Increment to force update on all clients
  const currentVersion = parseInt(localStorage.getItem('autovol_dashboard_roles_version') || '0');

  // Force update if version is old
  if (currentVersion < ROLES_VERSION) {
    console.log('[Auth] Upgrading dashboard roles to version', ROLES_VERSION);
    const defaultRoles = getDefaultRoles();
    localStorage.setItem('autovol_dashboard_roles', JSON.stringify(defaultRoles));
    localStorage.setItem('autovol_dashboard_roles_version', ROLES_VERSION.toString());
    return defaultRoles;
  }
  const saved = localStorage.getItem('autovol_dashboard_roles');
  if (saved && saved !== 'undefined' && saved !== 'null') {
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed) && parsed.length > 0) {
        return parsed;
      }
    } catch (e) {
      console.error('[Auth] Error parsing dashboard roles from localStorage:', e);
    }
  }
  // Use full DEFAULT_DASHBOARD_ROLES or fallback
  const defaultRoles = getDefaultRoles();
  // Initialize localStorage with defaults so future loads work
  localStorage.setItem('autovol_dashboard_roles', JSON.stringify(defaultRoles));
  localStorage.setItem('autovol_dashboard_roles_version', ROLES_VERSION.toString());
  return defaultRoles;
}

// Hook for managing dashboard roles - syncs with Supabase
function useDashboardRoles() {
  const [roles, setRoles] = useState(() => getLocalStorageRoles());
  const [isLoading, setIsLoading] = useState(true);
  const [supabaseAvailable, setSupabaseAvailable] = useState(false);
  const unsubscribeRef = useRef(null);

  // Load roles from Supabase on mount
  useEffect(() => {
    let mounted = true;
    const loadRoles = async () => {
      // Check if Supabase is available
      if (isSupabaseRolesAvailable()) {
        try {
          console.log('[DashboardRoles] Loading from Supabase...');
          const supabaseRoles = await window.MODA_SUPABASE_DATA.dashboardRoles.getAll();
          if (mounted && supabaseRoles && supabaseRoles.length > 0) {
            console.log('[DashboardRoles] Loaded', supabaseRoles.length, 'roles from Supabase');
            setRoles(supabaseRoles);
            setSupabaseAvailable(true);
            // Also cache to localStorage for offline fallback
            localStorage.setItem('autovol_dashboard_roles', JSON.stringify(supabaseRoles));
          } else if (mounted) {
            // Supabase returned empty - use localStorage/defaults
            console.log('[DashboardRoles] Supabase returned empty, using localStorage');
            setSupabaseAvailable(true);
          }
        } catch (err) {
          console.warn('[DashboardRoles] Failed to load from Supabase, using localStorage:', err.message);
          setSupabaseAvailable(false);
        }
      } else {
        console.log('[DashboardRoles] Supabase not available, using localStorage');
        setSupabaseAvailable(false);
      }
      if (mounted) {
        setIsLoading(false);
      }
    };

    // Small delay to ensure Supabase client is initialized
    const timer = setTimeout(loadRoles, 100);
    return () => {
      mounted = false;
      clearTimeout(timer);
      if (unsubscribeRef.current) {
        unsubscribeRef.current();
      }
    };
  }, []);

  // Subscribe to real-time updates when Supabase is available
  useEffect(() => {
    if (supabaseAvailable && isSupabaseRolesAvailable()) {
      console.log('[DashboardRoles] Setting up real-time subscription');
      unsubscribeRef.current = window.MODA_SUPABASE_DATA.dashboardRoles.onSnapshot(updatedRoles => {
        if (updatedRoles && updatedRoles.length > 0) {
          setRoles(updatedRoles);
          localStorage.setItem('autovol_dashboard_roles', JSON.stringify(updatedRoles));
        }
      });
    }
    return () => {
      if (unsubscribeRef.current) {
        unsubscribeRef.current();
      }
    };
  }, [supabaseAvailable]);

  // Sync to localStorage whenever roles change (fallback cache)
  useEffect(() => {
    if (!isLoading) {
      localStorage.setItem('autovol_dashboard_roles', JSON.stringify(roles));
    }
  }, [roles, isLoading]);
  const addRole = useCallback(async roleData => {
    const newRole = {
      id: `role-${Date.now()}`,
      ...roleData,
      tabs: roleData.tabs || [],
      capabilities: roleData.capabilities || {},
      tabPermissions: roleData.tabPermissions || {},
      isProtected: false
    };

    // Optimistic update
    setRoles(prev => [...prev, newRole]);

    // Sync to Supabase if available
    if (supabaseAvailable && isSupabaseRolesAvailable()) {
      try {
        const created = await window.MODA_SUPABASE_DATA.dashboardRoles.create(newRole);
        console.log('[DashboardRoles] Created in Supabase:', created?.id);
      } catch (err) {
        console.error('[DashboardRoles] Failed to create in Supabase:', err.message);
      }
    }
    return newRole;
  }, [supabaseAvailable]);
  const updateRole = useCallback(async (roleId, updates) => {
    // Optimistic update
    setRoles(prev => prev.map(role => role.id === roleId ? {
      ...role,
      ...updates
    } : role));

    // Sync to Supabase if available
    if (supabaseAvailable && isSupabaseRolesAvailable()) {
      try {
        await window.MODA_SUPABASE_DATA.dashboardRoles.update(roleId, updates);
        console.log('[DashboardRoles] Updated in Supabase:', roleId);
      } catch (err) {
        console.error('[DashboardRoles] Failed to update in Supabase:', err.message);
      }
    }
  }, [supabaseAvailable]);
  const deleteRole = useCallback(async roleId => {
    const role = roles.find(r => r.id === roleId);
    if (role?.isProtected) {
      return {
        success: false,
        error: 'Cannot delete protected role'
      };
    }

    // Optimistic update
    setRoles(prev => prev.filter(role => role.id !== roleId));

    // Sync to Supabase if available
    if (supabaseAvailable && isSupabaseRolesAvailable()) {
      try {
        await window.MODA_SUPABASE_DATA.dashboardRoles.delete(roleId);
        console.log('[DashboardRoles] Deleted from Supabase:', roleId);
      } catch (err) {
        console.error('[DashboardRoles] Failed to delete from Supabase:', err.message);
      }
    }
    return {
      success: true
    };
  }, [roles, supabaseAvailable]);
  const setDefaultRole = useCallback(async roleId => {
    // Optimistic update
    setRoles(prev => prev.map(role => ({
      ...role,
      isDefault: role.id === roleId
    })));

    // Sync to Supabase if available
    if (supabaseAvailable && isSupabaseRolesAvailable()) {
      try {
        await window.MODA_SUPABASE_DATA.dashboardRoles.setDefault(roleId);
        console.log('[DashboardRoles] Set default in Supabase:', roleId);
      } catch (err) {
        console.error('[DashboardRoles] Failed to set default in Supabase:', err.message);
      }
    }
  }, [supabaseAvailable]);
  const moveTab = useCallback((roleId, tabId, direction) => {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;
    const tabs = [...role.tabs];
    const currentIndex = tabs.indexOf(tabId);
    if (direction === 'up' && currentIndex > 0) {
      [tabs[currentIndex], tabs[currentIndex - 1]] = [tabs[currentIndex - 1], tabs[currentIndex]];
    } else if (direction === 'down' && currentIndex < tabs.length - 1) {
      [tabs[currentIndex], tabs[currentIndex + 1]] = [tabs[currentIndex + 1], tabs[currentIndex]];
    }
    updateRole(roleId, {
      tabs
    });
  }, [roles, updateRole]);
  const toggleTab = useCallback((roleId, tabId) => {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;
    const tabs = role.tabs.includes(tabId) ? role.tabs.filter(t => t !== tabId) : [...role.tabs, tabId];
    updateRole(roleId, {
      tabs
    });
  }, [roles, updateRole]);
  const toggleCapability = useCallback((roleId, capability) => {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;
    const capabilities = {
      ...role.capabilities,
      [capability]: !role.capabilities[capability]
    };
    updateRole(roleId, {
      capabilities
    });
  }, [roles, updateRole]);
  const getRoleById = useCallback(roleId => {
    return roles.find(r => r.id === roleId);
  }, [roles]);
  const getVisibleTabs = useCallback(roleId => {
    const role = getRoleById(roleId);
    return role ? role.tabs : [];
  }, [getRoleById]);
  const hasCapability = useCallback((roleId, capability) => {
    const role = getRoleById(roleId);
    return role?.capabilities?.[capability] || false;
  }, [getRoleById]);

  // Get full tab permissions for a specific tab
  // Returns { canView, canEdit, canCreate, canDelete }
  const getTabPermission = useCallback((roleId, tabId) => {
    const role = getRoleById(roleId);
    const defaultPerms = {
      canView: false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };
    if (!role) return defaultPerms;
    if (role.tabPermissions && role.tabPermissions[tabId]) {
      return {
        ...defaultPerms,
        ...role.tabPermissions[tabId]
      };
    }

    // If tab is in viewable tabs but no specific permissions, default to view-only
    if (role.tabs?.includes(tabId)) {
      return {
        canView: true,
        canEdit: false,
        canCreate: false,
        canDelete: false
      };
    }
    return defaultPerms;
  }, [getRoleById]);

  // Check if a role can perform a specific action on a tab
  const hasTabPermission = useCallback((roleId, tabId, permission) => {
    const perms = getTabPermission(roleId, tabId);
    return perms[permission] || false;
  }, [getTabPermission]);

  // Convenience methods for common permission checks
  const canViewTab = useCallback((roleId, tabId) => hasTabPermission(roleId, tabId, 'canView'), [hasTabPermission]);
  const canEditTab = useCallback((roleId, tabId) => hasTabPermission(roleId, tabId, 'canEdit'), [hasTabPermission]);
  const canCreateInTab = useCallback((roleId, tabId) => hasTabPermission(roleId, tabId, 'canCreate'), [hasTabPermission]);
  const canDeleteInTab = useCallback((roleId, tabId) => hasTabPermission(roleId, tabId, 'canDelete'), [hasTabPermission]);

  // Toggle a specific permission for a tab
  const toggleTabPermission = useCallback((roleId, tabId, permission = 'canEdit') => {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;
    const currentPermissions = role.tabPermissions || {};
    const currentTabPerm = currentPermissions[tabId] || {
      canView: role.tabs?.includes(tabId) || false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };
    const tabPermissions = {
      ...currentPermissions,
      [tabId]: {
        ...currentTabPerm,
        [permission]: !currentTabPerm[permission]
      }
    };
    updateRole(roleId, {
      tabPermissions
    });
  }, [roles, updateRole]);

  // Set all permissions for a tab at once
  const setTabPermissions = useCallback((roleId, tabId, permissions) => {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;
    const currentPermissions = role.tabPermissions || {};
    const tabPermissions = {
      ...currentPermissions,
      [tabId]: {
        ...currentPermissions[tabId],
        ...permissions
      }
    };
    updateRole(roleId, {
      tabPermissions
    });
  }, [roles, updateRole]);
  return {
    roles,
    isLoading,
    supabaseAvailable,
    addRole,
    updateRole,
    deleteRole,
    setDefaultRole,
    moveTab,
    toggleTab,
    toggleCapability,
    getRoleById,
    getVisibleTabs,
    hasCapability,
    // Per-tab permission methods
    getTabPermission,
    hasTabPermission,
    canViewTab,
    canEditTab,
    canCreateInTab,
    canDeleteInTab,
    toggleTabPermission,
    setTabPermissions
  };
}

// ============================================================================
// END DASHBOARD ROLES SYSTEM
// ============================================================================

// ===== AUTHENTICATION SYSTEM =====

const INITIAL_USERS = [{
  id: 1,
  email: 'trevor@autovol.com',
  password: 'admin123',
  name: 'Trevor Fletcher',
  dashboardRole: 'admin',
  // CHANGED: Uses dashboardRole instead of role
  isProtected: true,
  // NEW: Trevor cannot be changed
  department: 'Operations',
  active: true,
  createdAt: '2024-01-01'
}, {
  id: 2,
  email: 'curtis@autovol.com',
  password: 'admin123',
  name: 'Curtis Fletcher',
  dashboardRole: 'executive',
  // CHANGED: Curtis gets Executive role
  isProtected: false,
  department: 'CTO',
  active: true,
  createdAt: '2024-01-01'
}, {
  id: 3,
  email: 'user@autovol.com',
  password: 'user123',
  name: 'Demo User',
  dashboardRole: 'employee',
  // CHANGED: Uses dashboardRole instead of role
  isProtected: false,
  department: 'Production',
  active: true,
  createdAt: '2024-01-15'
}];
function useAuth() {
  // Dashboard roles are now managed by useDashboardRoles hook with Supabase sync
  // No initialization needed here - roles load from Supabase or localStorage fallback

  // Simple state - load from localStorage on init
  const [currentUser, setCurrentUser] = useState(() => {
    const saved = localStorage.getItem('autovol_session');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      try {
        console.log('[Auth] Found saved session in localStorage');
        return JSON.parse(saved);
      } catch (e) {
        console.error('[Auth] Failed to parse localStorage session:', e);
      }
    }
    const sessionSaved = sessionStorage.getItem('autovol_session');
    if (sessionSaved && sessionSaved !== 'undefined' && sessionSaved !== 'null') {
      try {
        console.log('[Auth] Found saved session in sessionStorage');
        return JSON.parse(sessionSaved);
      } catch (e) {
        console.error('[Auth] Failed to parse sessionStorage session:', e);
      }
    }
    return null;
  });
  const [users, setUsers] = useState(() => {
    const saved = localStorage.getItem('autovol_users');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      let savedUsers;
      try {
        savedUsers = JSON.parse(saved);
      } catch (e) {
        return INITIAL_USERS;
      }
      // Merge in any new INITIAL_USERS that don't exist in saved
      const savedEmails = savedUsers.map(u => (u.email || '').toLowerCase());
      const newUsers = INITIAL_USERS.filter(u => !savedEmails.includes((u.email || '').toLowerCase()));
      if (newUsers.length > 0) {
        return [...savedUsers, ...newUsers];
      }
      return savedUsers;
    }
    return INITIAL_USERS;
  });

  // MIGRATION: Convert old role/permissions to dashboardRole
  useEffect(() => {
    let needsMigration = false;
    const migratedUsers = users.map(user => {
      // Migrate old 'role' field to 'dashboardRole'
      if (user.role && !user.dashboardRole) {
        needsMigration = true;
        let dashboardRole = 'employee';
        if (user.role === 'Admin') dashboardRole = 'admin';else if (user.role === 'User') dashboardRole = 'employee';
        const isProtected = user.email === 'trevor@autovol.com';
        if (isProtected) dashboardRole = 'admin';
        return {
          ...user,
          dashboardRole,
          isProtected,
          role: undefined,
          // Remove old field
          permissions: undefined // Remove if exists
        };
      }

      // Migrate old 'permissions' field to 'dashboardRole'
      if (user.permissions && !user.dashboardRole) {
        needsMigration = true;
        let dashboardRole = 'employee';
        if (user.permissions === 'Admin') dashboardRole = 'admin';else if (user.permissions === 'User') dashboardRole = 'employee';else if (user.permissions === 'No Access') dashboardRole = 'no-access';
        const isProtected = user.email === 'trevor@autovol.com';
        if (isProtected) dashboardRole = 'admin';
        return {
          ...user,
          dashboardRole,
          isProtected,
          permissions: undefined,
          role: undefined
        };
      }

      // Ensure Trevor is always protected
      if (user.email === 'trevor@autovol.com' && !user.isProtected) {
        needsMigration = true;
        return {
          ...user,
          isProtected: true,
          dashboardRole: 'admin'
        };
      }
      return user;
    });
    if (needsMigration) {
      setUsers(migratedUsers);
      console.log('✅ Migrated users to dashboard role system');
    }
  }, []);
  useEffect(() => {
    localStorage.setItem('autovol_users', JSON.stringify(users));
  }, [users]);

  // Set global user state for non-React code (like activity logging)
  useEffect(() => {
    window.MODA_CURRENT_USER = currentUser;
  }, [currentUser]);

  // Listen for Supabase profile loaded event AND poll for it if not immediately available
  useEffect(() => {
    let pollInterval = null;
    let pollCount = 0;
    const MAX_POLLS = 20; // Poll for up to 2 seconds (20 * 100ms)

    const updateFromProfile = profile => {
      if (profile && profile.id) {
        console.log('[Auth] Updating session with Supabase profile, role:', profile.dashboard_role, 'customPerms:', profile.custom_tab_permissions ? 'yes' : 'no');
        const updatedSession = {
          id: profile.id,
          email: profile.email,
          name: profile.name || profile.email?.split('@')[0],
          dashboardRole: profile.dashboard_role || 'employee',
          department: profile.department || '',
          isProtected: (profile.email || '').toLowerCase() === 'trevor@autovol.com',
          customTabPermissions: profile.custom_tab_permissions || null
        };
        setCurrentUser(updatedSession);
        // Update storage to keep in sync
        const storage = localStorage.getItem('autovol_session') ? localStorage : sessionStorage;
        storage.setItem('autovol_session', JSON.stringify(updatedSession));
        // Stop polling once we have the profile
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
        return true;
      }
      return false;
    };
    const handleProfileLoaded = event => {
      updateFromProfile(event.detail);
    };
    window.addEventListener('moda-profile-loaded', handleProfileLoaded);

    // Check if profile is already loaded
    if (window.MODA_SUPABASE?.userProfile) {
      console.log('[Auth] Found existing Supabase profile on mount');
      updateFromProfile(window.MODA_SUPABASE.userProfile);
    } else {
      // Poll for profile if not immediately available (handles async loading race condition)
      console.log('[Auth] Profile not available yet, starting poll...');
      pollInterval = setInterval(() => {
        pollCount++;
        if (window.MODA_SUPABASE?.userProfile) {
          console.log('[Auth] Profile found after polling');
          updateFromProfile(window.MODA_SUPABASE.userProfile);
        } else if (pollCount >= MAX_POLLS) {
          console.log('[Auth] Profile poll timeout, using localStorage session');
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }, 100);
    }
    return () => {
      window.removeEventListener('moda-profile-loaded', handleProfileLoaded);
      if (pollInterval) clearInterval(pollInterval);
    };
  }, []);
  const login = async (email, password, rememberMe) => {
    // Try Supabase (primary backend)
    if (window.MODA_SUPABASE) {
      try {
        console.log('[Auth] Attempting Supabase login...');
        console.log('[Auth] MODA_SUPABASE.isInitialized:', MODA_SUPABASE.isInitialized);
        const result = await MODA_SUPABASE.login(email, password);
        console.log('[Auth] Supabase login result:', result);
        if (result.success && result.user) {
          // Use profile from login result (already fetched)
          const profile = result.profile || MODA_SUPABASE.userProfile || {};
          console.log('[Auth] Supabase login success, profile:', profile);
          const session = {
            id: result.user.id,
            email: result.user.email,
            name: profile.name || result.user.email.split('@')[0],
            dashboardRole: profile.dashboard_role || 'employee',
            department: profile.department || '',
            isProtected: (profile.email || result.user.email || '').toLowerCase() === 'trevor@autovol.com',
            customTabPermissions: profile.custom_tab_permissions || null
          };
          console.log('[Auth] Setting session:', session);
          setCurrentUser(session);
          if (rememberMe) localStorage.setItem('autovol_session', JSON.stringify(session));else sessionStorage.setItem('autovol_session', JSON.stringify(session));
          console.log('[Auth] Login complete, returning success');
          return {
            success: true
          };
        } else if (result.error) {
          console.log('[Auth] Supabase login failed:', result.error);
          return {
            success: false,
            error: result.error
          };
        }
      } catch (err) {
        console.log('[Auth] Supabase login error:', err.message);
        return {
          success: false,
          error: err.message
        };
      }
    } else {
      console.log('[Auth] MODA_SUPABASE not available');
    }

    // Fallback to local users (offline/demo mode only)
    const user = users.find(u => (u.email || '').toLowerCase() === (email || '').toLowerCase() && u.password === password && u.active);
    if (user) {
      let migratedUser = {
        ...user
      };
      if (user.role && !user.dashboardRole) {
        if (user.role === 'Admin') migratedUser.dashboardRole = 'admin';else if (user.role === 'User') migratedUser.dashboardRole = 'employee';
        migratedUser.isProtected = user.email === 'trevor@autovol.com';
        delete migratedUser.role;
        delete migratedUser.permissions;
      }
      const session = {
        ...migratedUser,
        password: undefined
      };
      setCurrentUser(session);
      if (rememberMe) localStorage.setItem('autovol_session', JSON.stringify(session));else sessionStorage.setItem('autovol_session', JSON.stringify(session));
      return {
        success: true
      };
    }
    return {
      success: false,
      error: 'Invalid email or password'
    };
  };
  const logout = () => {
    console.log('[Auth] Logout called - clearing session and sensitive data');

    // Clear session data
    localStorage.removeItem('autovol_session');
    sessionStorage.removeItem('autovol_session');
    sessionStorage.removeItem('autovol_current_user');

    // Clear sensitive cached data for security
    // These contain project/employee data that should not persist after logout
    const sensitiveKeys = ['autovol_projects', 'autovol_employees', 'autovol_users', 'autovol_unified_modules', 'autovol_schedule_setup', 'autovol_completed_weeks', 'moda_engineering_issues', 'autovol_transport_data', 'autovol_yard_data'];
    sensitiveKeys.forEach(key => {
      localStorage.removeItem(key);
    });
    console.log('[Auth] Cleared', sensitiveKeys.length, 'sensitive localStorage keys');

    // Keep non-sensitive preferences (theme, UI settings, role definitions)
    // 'autovol_dashboard_roles' - role definitions (not user-specific)
    // 'autovol_theme' - UI preferences
    // 'autovol_dashboard_roles_version' - version tracking

    setCurrentUser(null);

    // Try Supabase logout in background (don't wait for it)
    if (window.MODA_SUPABASE && MODA_SUPABASE.isInitialized) {
      MODA_SUPABASE.logout().catch(err => {
        console.log('[Auth] Supabase logout error (ignored):', err.message);
      });
    }
    console.log('[Auth] Reloading page');
    window.location.reload();
  };
  const addUser = userData => {
    const newUser = {
      ...userData,
      id: Date.now(),
      active: true,
      createdAt: new Date().toISOString().split('T')[0],
      dashboardRole: userData.dashboardRole || 'employee',
      isProtected: false
    };
    setUsers([...users, newUser]);
    return newUser;
  };
  const updateUser = (userId, updates) => {
    setUsers(users.map(u => {
      if (u.id === userId) {
        // Prevent changing protected accounts
        if (u.isProtected && updates.dashboardRole && updates.dashboardRole !== u.dashboardRole) {
          console.warn('Cannot change role of protected account');
          return u;
        }
        return {
          ...u,
          ...updates
        };
      }
      return u;
    }));
  };
  const toggleUserActive = userId => {
    setUsers(users.map(u => u.id === userId ? {
      ...u,
      active: !u.active
    } : u));
  };
  const resetPassword = async email => {
    // Try Supabase
    if (window.MODA_SUPABASE && MODA_SUPABASE.isInitialized) {
      try {
        const result = await MODA_SUPABASE.resetPassword(email);
        if (result.success) {
          return {
            success: true,
            message: 'Password reset email sent! Check your inbox.'
          };
        }
        return {
          success: false,
          error: result.error || 'Failed to send reset email'
        };
      } catch (err) {
        console.log('[Auth] Supabase reset failed:', err.message);
        return {
          success: false,
          error: err.message
        };
      }
    }
    // Fallback to local (simulated - offline mode only)
    const user = users.find(u => (u.email || '').toLowerCase() === (email || '').toLowerCase());
    return user ? {
      success: true,
      message: 'Password reset email sent (simulated)'
    } : {
      success: false,
      error: 'Email not found'
    };
  };

  // Dashboard roles integration
  const dashboardRoles = useDashboardRoles();
  const userRole = currentUser ? dashboardRoles.getRoleById(currentUser.dashboardRole) : null;

  // Compute visible tabs: custom permissions override role defaults
  // If user has customTabPermissions, use tabs where canView is true
  // Otherwise fall back to role's default tabs
  const visibleTabs = React.useMemo(() => {
    if (!currentUser) return [];

    // Check for custom tab permissions first
    if (currentUser.customTabPermissions && Object.keys(currentUser.customTabPermissions).length > 0) {
      const customTabs = Object.entries(currentUser.customTabPermissions).filter(([tabId, perms]) => perms && perms.canView).map(([tabId]) => tabId);
      console.log('[Auth] Using custom tab permissions, visible tabs:', customTabs);
      return customTabs;
    }

    // Fall back to role defaults
    return dashboardRoles.getVisibleTabs(currentUser.dashboardRole);
  }, [currentUser, dashboardRoles]);

  // Capability checks
  const canEdit = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canEdit') : false;
  const canDelete = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canDelete') : false;
  const canCreate = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canCreate') : false;
  const canManageUsers = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canManageUsers') : false;
  const canAccessAdmin = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canAccessAdmin') : false;
  const canExportData = currentUser ? dashboardRoles.hasCapability(currentUser.dashboardRole, 'canExportData') : false;

  // Tab-specific edit permission check
  // Usage: auth.canEditTab('production') returns true/false
  const canEditTabFn = tabId => {
    if (!currentUser) return false;
    return dashboardRoles.canEditTab(currentUser.dashboardRole, tabId);
  };
  return {
    currentUser,
    users,
    login,
    logout,
    addUser,
    updateUser,
    toggleUserActive,
    resetPassword,
    // Dashboard role system
    dashboardRoles,
    userRole,
    visibleTabs,
    // Capabilities
    canEdit,
    canDelete,
    canCreate,
    canManageUsers,
    canAccessAdmin,
    canExportData,
    // Tab-specific permissions
    canEditTab: canEditTabFn,
    // Backward compatibility
    isAdmin: canAccessAdmin
  };
}

// Export for use in App.jsx
window.useAuth = useAuth;
window.useDashboardRoles = useDashboardRoles;
})();


// ============================================================================
// FILE: auth/LoginPage.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA LOGIN PAGE COMPONENT
// Extracted from App.jsx for better maintainability
// ============================================================================
// [Removed duplicate React destructuring]
// Use AUTOVOL_LOGO from App.jsx (loaded before this file)
const AUTOVOL_LOGO = window.AUTOVOL_LOGO || "./public/autovol-logo.png";
function LoginForm({
  auth,
  onForgotPassword
}) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [rememberMe, setRememberMe] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const handleSubmit = async e => {
    e.preventDefault();
    setError('');
    setLoading(true);
    await new Promise(r => setTimeout(r, 500));
    const result = await auth.login(email, password, rememberMe);
    if (!result.success) setError(result.error);
    setLoading(false);
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "text-center mb-8"
  }, /*#__PURE__*/React.createElement("img", {
    src: AUTOVOL_LOGO,
    alt: "Autovol Volumetric Modular",
    style: {
      height: '60px',
      width: 'auto',
      margin: '0 auto'
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-xs mt-3"
  }, "Making Smart Construction Brilliant\u2122")), /*#__PURE__*/React.createElement("h2", {
    style: {
      color: '#1E3A5F'
    },
    className: "text-xl font-semibold text-center mb-6"
  }, "Sign in to MODA"), error && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 rounded-lg text-sm",
    style: {
      backgroundColor: '#FDEAEA',
      color: '#E31B23'
    }
  }, error), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Email"), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: email,
    onChange: e => setEmail(e.target.value),
    className: "input-field",
    placeholder: "you@autovol.com",
    required: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Password"), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("input", {
    type: showPassword ? 'text' : 'password',
    value: password,
    onChange: e => setPassword(e.target.value),
    className: "input-field pr-10",
    placeholder: "\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",
    required: true
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setShowPassword(!showPassword),
    className: "absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",
    tabIndex: -1
  }, showPassword ? /*#__PURE__*/React.createElement("svg", {
    xmlns: "http://www.w3.org/2000/svg",
    className: "w-5 h-5",
    fill: "none",
    viewBox: "0 0 24 24",
    stroke: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
  })) : /*#__PURE__*/React.createElement("svg", {
    xmlns: "http://www.w3.org/2000/svg",
    className: "w-5 h-5",
    fill: "none",
    viewBox: "0 0 24 24",
    stroke: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 12a3 3 0 11-6 0 3 3 0 016 0z"
  }), /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
  }))))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-2 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: rememberMe,
    onChange: e => setRememberMe(e.target.checked),
    className: "w-4 h-4 rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Remember me")), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onForgotPassword,
    className: "text-sm font-medium",
    style: {
      color: '#007B8A'
    }
  }, "Forgot password?")), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    disabled: loading,
    className: "w-full py-3 rounded-lg font-semibold btn-primary"
  }, loading ? 'Signing in...' : 'Sign In')), /*#__PURE__*/React.createElement("div", {
    className: "mt-6 pt-6 border-t text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400"
  }, "Modular Operations Dashboard Application")));
}

// Set Password Form - shown when user clicks invite link
function SetPasswordForm({
  auth,
  onComplete
}) {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const handleSubmit = async e => {
    e.preventDefault();
    setError('');
    if (password.length < 6) {
      setError('Password must be at least 6 characters');
      return;
    }
    if (password !== confirmPassword) {
      setError('Passwords do not match');
      return;
    }
    setLoading(true);
    try {
      // Get access token from localStorage (avoids SDK Promise hanging)
      const SUPABASE_URL = 'https://syreuphexagezawjyjgt.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cmV1cGhleGFnZXphd2p5amd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2Mzc1MDEsImV4cCI6MjA4MTIxMzUwMX0.-0Th_v-LDCXER9v06-mjfdEUZtRxZZSHHWypmTQXmbs';
      let accessToken = null;
      try {
        const storageKey = 'sb-syreuphexagezawjyjgt-auth-token';
        const stored = localStorage.getItem(storageKey);
        if (stored) {
          const parsed = JSON.parse(stored);
          accessToken = parsed?.access_token;
        }
      } catch (e) {
        console.warn('[SetPasswordForm] Could not get token from storage:', e);
      }
      console.log('[SetPasswordForm] Got access token:', !!accessToken);
      if (!accessToken) {
        setError('Session expired. Please use the invite link again.');
        setLoading(false);
        return;
      }
      console.log('[SetPasswordForm] Updating password via fetch API...');
      const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({
          password: password
        })
      });
      const result = await response.json();
      console.log('[SetPasswordForm] Update response:', response.status, result);
      if (!response.ok || result.error) {
        setError(result.error_description || result.error || result.msg || 'Failed to set password');
        setLoading(false);
        return;
      }
      console.log('[SetPasswordForm] Password updated successfully');

      // Ensure profile exists - create if missing
      const userId = result.id;
      const userEmail = result.email;
      const userName = result.user_metadata?.name || userEmail?.split('@')[0] || 'User';
      if (userId) {
        try {
          // Check if profile exists
          const profileCheck = await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${userId}&select=id`, {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${accessToken}`
            }
          });
          const profiles = await profileCheck.json();
          if (!profiles || profiles.length === 0) {
            console.log('[SetPasswordForm] Profile missing, creating...');
            // Profile doesn't exist, create it
            const createProfile = await fetch(`${SUPABASE_URL}/rest/v1/profiles`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${accessToken}`,
                'Prefer': 'return=minimal'
              },
              body: JSON.stringify({
                id: userId,
                email: userEmail,
                name: userName,
                dashboard_role: result.user_metadata?.dashboard_role || 'employee',
                is_protected: false
              })
            });
            console.log('[SetPasswordForm] Profile create response:', createProfile.status);
          } else {
            console.log('[SetPasswordForm] Profile already exists');
          }
        } catch (profileErr) {
          console.warn('[SetPasswordForm] Profile check/create error (non-fatal):', profileErr);
        }
      }

      // Password set successfully - complete the flow
      if (onComplete) onComplete();
    } catch (err) {
      console.error('[SetPasswordForm] Exception:', err);
      setError(err.message || 'Failed to set password');
    }
    setLoading(false);
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "text-center mb-8"
  }, /*#__PURE__*/React.createElement("img", {
    src: AUTOVOL_LOGO,
    alt: "Autovol Volumetric Modular",
    style: {
      height: '60px',
      width: 'auto',
      margin: '0 auto'
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-xs mt-3"
  }, "Making Smart Construction Brilliant\u2122")), /*#__PURE__*/React.createElement("h2", {
    style: {
      color: '#1E3A5F'
    },
    className: "text-xl font-semibold text-center mb-2"
  }, "Welcome to MODA!"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm text-center mb-6"
  }, "Set your password to complete your account setup."), error && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 rounded-lg text-sm",
    style: {
      backgroundColor: '#FDEAEA',
      color: '#E31B23'
    }
  }, error), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "New Password"), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("input", {
    type: showPassword ? 'text' : 'password',
    value: password,
    onChange: e => setPassword(e.target.value),
    className: "input-field pr-10",
    placeholder: "At least 6 characters",
    required: true,
    minLength: 6
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setShowPassword(!showPassword),
    className: "absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",
    tabIndex: -1
  }, showPassword ? /*#__PURE__*/React.createElement("svg", {
    xmlns: "http://www.w3.org/2000/svg",
    className: "w-5 h-5",
    fill: "none",
    viewBox: "0 0 24 24",
    stroke: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
  })) : /*#__PURE__*/React.createElement("svg", {
    xmlns: "http://www.w3.org/2000/svg",
    className: "w-5 h-5",
    fill: "none",
    viewBox: "0 0 24 24",
    stroke: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 12a3 3 0 11-6 0 3 3 0 016 0z"
  }), /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
  }))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Confirm Password"), /*#__PURE__*/React.createElement("input", {
    type: showPassword ? 'text' : 'password',
    value: confirmPassword,
    onChange: e => setConfirmPassword(e.target.value),
    className: "input-field",
    placeholder: "Re-enter your password",
    required: true
  })), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    disabled: loading,
    className: "w-full py-3 rounded-lg font-semibold btn-primary"
  }, loading ? 'Setting up...' : 'Set Password & Continue')), /*#__PURE__*/React.createElement("div", {
    className: "mt-6 pt-6 border-t text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400"
  }, "Modular Operations Dashboard Application")));
}
function ForgotPasswordForm({
  auth,
  onBack
}) {
  const [email, setEmail] = useState('');
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const handleSubmit = async e => {
    e.preventDefault();
    setError('');
    setMessage('');
    setLoading(true);
    const result = await auth.resetPassword(email);
    if (result.success) setMessage(result.message);else setError(result.error);
    setLoading(false);
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: onBack,
    className: "mb-4 text-sm flex items-center gap-1",
    style: {
      color: '#007B8A'
    }
  }, "\u2190 Back to login"), /*#__PURE__*/React.createElement("h2", {
    style: {
      color: '#1E3A5F'
    },
    className: "text-xl font-semibold mb-2"
  }, "Reset Password"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm mb-6"
  }, "Enter your email and we'll send you a reset link."), error && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 rounded-lg text-sm",
    style: {
      backgroundColor: '#FDEAEA',
      color: '#E31B23'
    }
  }, error), message && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 rounded-lg text-sm",
    style: {
      backgroundColor: '#E6F4F5',
      color: '#007B8A'
    }
  }, message), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Email"), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: email,
    onChange: e => setEmail(e.target.value),
    className: "input-field",
    placeholder: "you@autovol.com",
    required: true
  })), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    disabled: loading,
    className: "w-full py-3 rounded-lg font-semibold btn-primary"
  }, loading ? 'Sending...' : 'Send Reset Link')));
}
function LoginPage({
  auth
}) {
  const [view, setView] = useState('login');
  const [isInviteFlow, setIsInviteFlow] = useState(false);

  // Check for invite/recovery tokens in URL on mount
  React.useEffect(() => {
    const checkForInviteToken = async () => {
      // Supabase puts tokens in the URL hash after redirect
      const hash = window.location.hash;
      const params = new URLSearchParams(hash.replace('#', ''));
      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');
      const type = params.get('type');
      console.log('[LoginPage] Checking URL for tokens, type:', type);

      // If this is an invite or recovery flow
      if (accessToken && (type === 'invite' || type === 'recovery' || type === 'signup')) {
        console.log('[LoginPage] Invite/recovery token detected, setting session');
        setIsInviteFlow(true);

        // Set the session with the tokens from the URL
        try {
          const {
            error
          } = await window.MODA_SUPABASE.client.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
          });
          if (error) {
            console.error('[LoginPage] Error setting session:', error);
            setIsInviteFlow(false);
          } else {
            // Clear the hash from URL for cleaner look
            window.history.replaceState(null, '', window.location.pathname);
          }
        } catch (err) {
          console.error('[LoginPage] Exception setting session:', err);
          setIsInviteFlow(false);
        }
      }
    };
    checkForInviteToken();
  }, []);
  const handlePasswordSetComplete = () => {
    // Password was set, user should now be logged in via Supabase auth state change
    setIsInviteFlow(false);
    // Force a page reload to pick up the new auth state
    window.location.reload();
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen flex items-center justify-center py-8 px-4 relative login-background",
    style: {
      minHeight: '100vh',
      overflowY: 'auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "production-lines"
  }), /*#__PURE__*/React.createElement("div", {
    className: "login-card w-full max-w-md p-8 relative z-10"
  }, isInviteFlow && /*#__PURE__*/React.createElement(SetPasswordForm, {
    auth: auth,
    onComplete: handlePasswordSetComplete
  }), !isInviteFlow && view === 'login' && /*#__PURE__*/React.createElement(LoginForm, {
    auth: auth,
    onForgotPassword: () => setView('forgot')
  }), !isInviteFlow && view === 'forgot' && /*#__PURE__*/React.createElement(ForgotPasswordForm, {
    auth: auth,
    onBack: () => setView('login')
  })));
}
// ===== END AUTHENTICATION SYSTEM =====

// Export for use in App.jsx
window.LoginPage = LoginPage;
window.LoginForm = LoginForm;
window.ForgotPasswordForm = ForgotPasswordForm;
window.SetPasswordForm = SetPasswordForm;
})();


// ============================================================================
// FILE: auth/RoleManager.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA DASHBOARD ROLE MANAGER
// Extracted from App.jsx for better maintainability
// v2.0 - Added Per-Tab Permission Matrix UI
// ============================================================================
// [Removed duplicate React destructuring]
function DashboardRoleManager({
  auth
}) {
  const {
    roles,
    addRole,
    updateRole,
    deleteRole,
    setDefaultRole,
    moveTab,
    toggleTab,
    toggleCapability,
    getTabPermission,
    toggleTabPermission,
    setTabPermissions
  } = auth.dashboardRoles;
  const [selectedRoleId, setSelectedRoleId] = useState(roles[0]?.id);
  const [showEditModal, setShowEditModal] = useState(false);
  const [editingRole, setEditingRole] = useState(null);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deletingRole, setDeletingRole] = useState(null);

  // Unsaved changes tracking
  const [pendingChanges, setPendingChanges] = useState({});
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const originalRolesRef = useRef(JSON.stringify(roles));

  // Track changes
  useEffect(() => {
    const currentRoles = JSON.stringify(roles);
    setHasUnsavedChanges(currentRoles !== originalRolesRef.current);
  }, [roles]);

  // Warn before leaving with unsaved changes
  useEffect(() => {
    const handleBeforeUnload = e => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes to role permissions. Are you sure you want to leave?';
        return e.returnValue;
      }
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [hasUnsavedChanges]);

  // Save all changes
  const handleSaveAllChanges = useCallback(() => {
    // Changes are already applied to roles via the hook functions
    // Just update the reference to mark as saved
    originalRolesRef.current = JSON.stringify(roles);
    setHasUnsavedChanges(false);
    alert('Role permissions saved successfully!');
  }, [roles]);

  // Discard changes
  const handleDiscardChanges = useCallback(() => {
    if (confirm('Discard all unsaved changes? This cannot be undone.')) {
      // Reload from localStorage to discard changes
      window.location.reload();
    }
  }, []);
  const selectedRole = roles.find(r => r.id === selectedRoleId);

  // Handlers
  const handleCreateRole = () => {
    setEditingRole(null);
    setShowEditModal(true);
  };
  const handleEditRole = () => {
    setEditingRole(selectedRole);
    setShowEditModal(true);
  };
  const handleSaveRole = roleData => {
    if (editingRole) {
      updateRole(editingRole.id, roleData);
      if (roleData.isDefault) {
        setDefaultRole(editingRole.id);
      }
    } else {
      const newRole = addRole(roleData);
      setSelectedRoleId(newRole.id);
      if (roleData.isDefault) {
        setDefaultRole(newRole.id);
      }
    }
    setShowEditModal(false);
    setEditingRole(null);
  };
  const handleDeleteRole = () => {
    setDeletingRole(selectedRole);
    setShowDeleteModal(true);
  };
  const confirmDelete = () => {
    const result = deleteRole(deletingRole.id);
    if (result.success) {
      setShowDeleteModal(false);
      setDeletingRole(null);
      setSelectedRoleId(roles[0]?.id);
    }
  };
  const canDeleteRole = role => {
    if (role.isProtected) {
      return {
        canDelete: false,
        reason: 'This is a protected system role.'
      };
    }
    return {
      canDelete: true
    };
  };
  const deletionCheck = selectedRole ? canDeleteRole(selectedRole) : {
    canDelete: true
  };

  // Emergency recovery function
  const handleEmergencyRecovery = () => {
    if (confirm('This will restore Trevor Fletcher as Admin. Continue?')) {
      const updatedUsers = auth.users.map(u => {
        if (u.email === 'trevor@autovol.com') {
          return {
            ...u,
            dashboardRole: 'admin',
            isProtected: true
          };
        }
        return u;
      });
      localStorage.setItem('autovol_users', JSON.stringify(updatedUsers));
      alert('✅ Trevor Fletcher restored as Admin. Please refresh the page.');
      window.location.reload();
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    style: {
      maxWidth: '1400px',
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      padding: '20px',
      borderRadius: '8px',
      marginBottom: '20px',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
    }
  }, /*#__PURE__*/React.createElement("h1", {
    style: {
      fontSize: '24px',
      fontWeight: 'bold',
      color: 'var(--autovol-navy)',
      marginBottom: '5px'
    }
  }, "\uD83C\uDFAD Dashboard Role Manager"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '14px',
      color: '#6B7280'
    }
  }, "Configure role-based views and capabilities - Manage who sees what")), hasUnsavedChanges && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      borderRadius: '6px',
      marginBottom: '20px',
      fontSize: '13px',
      background: '#FEF3C7',
      color: '#92400E',
      border: '2px solid #FCD34D',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Unsaved Changes:"), " You have modified role permissions. Click \"Save All Changes\" to apply."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleDiscardChanges,
    style: {
      padding: '6px 14px',
      fontSize: '12px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: 'white',
      color: '#374151',
      cursor: 'pointer',
      fontWeight: '500'
    }
  }, "Discard"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveAllChanges,
    style: {
      padding: '6px 14px',
      fontSize: '12px',
      border: 'none',
      borderRadius: '4px',
      background: 'var(--autovol-teal)',
      color: 'white',
      cursor: 'pointer',
      fontWeight: '600'
    }
  }, "Save All Changes"))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px',
      borderRadius: '6px',
      marginBottom: '20px',
      fontSize: '13px',
      background: '#D1FAE5',
      color: '#065F46',
      border: '2px solid #6EE7B7'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Protected System:"), " Trevor Fletcher's admin access is permanently protected."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '300px 1fr 350px',
      gap: '20px',
      minHeight: '600px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      borderRadius: '8px',
      padding: '20px',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
      overflowY: 'auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '15px'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontSize: '18px',
      color: 'var(--autovol-navy)'
    }
  }, "Roles"), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateRole,
    className: "btn-primary",
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px'
    }
  }, "+ New")), roles.map(role => /*#__PURE__*/React.createElement("div", {
    key: role.id,
    onClick: () => setSelectedRoleId(role.id),
    style: {
      padding: '12px',
      border: `2px solid ${selectedRoleId === role.id ? 'var(--autovol-red)' : '#E5E7EB'}`,
      borderRadius: '6px',
      marginBottom: '8px',
      cursor: 'pointer',
      background: selectedRoleId === role.id ? '#FEF2F2' : role.isProtected ? '#F0FDF4' : 'white',
      transition: 'all 0.2s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      fontSize: '14px'
    }
  }, role.isProtected && '🛡️ ', role.name), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '4px',
      flexWrap: 'wrap'
    }
  }, role.isDefault && /*#__PURE__*/React.createElement("span", {
    style: {
      background: '#10B981',
      color: 'white',
      fontSize: '10px',
      padding: '2px 6px',
      borderRadius: '4px',
      fontWeight: '600'
    }
  }, "DEFAULT"), role.capabilities?.canAccessAdmin && /*#__PURE__*/React.createElement("span", {
    style: {
      background: 'var(--autovol-red)',
      color: 'white',
      fontSize: '10px',
      padding: '2px 6px',
      borderRadius: '4px',
      fontWeight: '600'
    }
  }, "ADMIN"))), role.description && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#6B7280',
      marginTop: '4px'
    }
  }, role.description), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '11px',
      color: '#9CA3AF',
      marginTop: '4px'
    }
  }, role.tabs.length, " tabs \u2022 ", Object.values(role.capabilities || {}).filter(Boolean).length, " capabilities"))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#FEE2E2',
      border: '2px solid #EF4444',
      borderRadius: '8px',
      padding: '15px',
      marginTop: '20px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      color: '#991B1B',
      fontWeight: '600',
      fontSize: '14px',
      marginBottom: '8px'
    }
  }, "\uD83D\uDEA8 Emergency Recovery"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#7F1D1D',
      marginBottom: '10px'
    }
  }, "Restore admin access if locked out"), /*#__PURE__*/React.createElement("button", {
    onClick: handleEmergencyRecovery,
    style: {
      background: '#EF4444',
      color: 'white',
      border: 'none',
      padding: '8px 12px',
      borderRadius: '6px',
      fontSize: '12px',
      cursor: 'pointer',
      fontWeight: '500'
    }
  }, "Restore Trevor's Admin"))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      borderRadius: '8px',
      padding: '20px',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
      overflowY: 'auto'
    }
  }, selectedRole ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '20px',
      paddingBottom: '15px',
      borderBottom: '2px solid #E5E7EB'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '20px',
      fontWeight: '700',
      color: 'var(--autovol-navy)'
    }
  }, selectedRole.isProtected && '🛡️ ', selectedRole.name), selectedRole.description && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '13px',
      color: '#6B7280',
      marginTop: '4px'
    }
  }, selectedRole.description)), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleEditRole,
    className: "btn-secondary",
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px'
    }
  }, "Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: handleDeleteRole,
    disabled: !deletionCheck.canDelete,
    title: !deletionCheck.canDelete ? deletionCheck.reason : '',
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      cursor: deletionCheck.canDelete ? 'pointer' : 'not-allowed',
      border: 'none',
      background: '#EF4444',
      color: 'white',
      opacity: deletionCheck.canDelete ? 1 : 0.4
    }
  }, "Delete"))), selectedRole.isProtected && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px',
      borderRadius: '6px',
      marginBottom: '20px',
      fontSize: '13px',
      background: '#DBEAFE',
      color: '#1E40AF',
      border: '2px solid #93C5FD'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "\uD83D\uDEE1\uFE0F Protected Role:"), " Cannot be deleted to ensure system integrity."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '25px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '16px',
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      marginBottom: '12px'
    }
  }, "Default Role Setting"), /*#__PURE__*/React.createElement("div", {
    onClick: () => setDefaultRole(selectedRole.id),
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      padding: '12px',
      background: '#F9FAFB',
      borderRadius: '6px',
      border: '2px solid #E5E7EB',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '44px',
      height: '24px',
      background: selectedRole.isDefault ? '#10B981' : '#D1D5DB',
      borderRadius: '12px',
      position: 'relative',
      transition: 'background 0.2s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '20px',
      height: '20px',
      background: 'white',
      borderRadius: '50%',
      position: 'absolute',
      top: '2px',
      left: selectedRole.isDefault ? '22px' : '2px',
      transition: 'left 0.2s',
      boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '13px',
      fontWeight: '500',
      color: 'var(--autovol-navy)'
    }
  }, selectedRole.isDefault ? 'This is the default role' : 'Set as default role'), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '11px',
      color: '#6B7280'
    }
  }, "New employees automatically receive this role")))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '25px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '16px',
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      marginBottom: '12px'
    }
  }, "Role Capabilities"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '12px',
      color: '#6B7280',
      marginBottom: '12px'
    }
  }, "Define what actions users with this role can perform"), [{
    key: 'canEdit',
    name: 'Can Edit Data',
    desc: 'Modify existing records'
  }, {
    key: 'canCreate',
    name: 'Can Create Records',
    desc: 'Add new modules and projects'
  }, {
    key: 'canDelete',
    name: 'Can Delete Data',
    desc: 'Remove records from system'
  }, {
    key: 'canManageUsers',
    name: 'Can Manage Users',
    desc: 'Edit employee roles'
  }, {
    key: 'canAccessAdmin',
    name: 'Can Access Admin',
    desc: 'Full system administration'
  }, {
    key: 'canExportData',
    name: 'Can Export Data',
    desc: 'Download Excel reports'
  }].map(cap => /*#__PURE__*/React.createElement("div", {
    key: cap.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      padding: '10px 12px',
      background: 'white',
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      marginBottom: '8px'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedRole.capabilities?.[cap.key] || false,
    onChange: () => toggleCapability(selectedRole.id, cap.key),
    style: {
      width: '20px',
      height: '20px',
      cursor: 'pointer'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '13px',
      fontWeight: '500',
      color: 'var(--autovol-navy)'
    }
  }, cap.name), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '11px',
      color: '#6B7280',
      marginTop: '2px'
    }
  }, cap.desc))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '25px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '16px',
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      marginBottom: '12px'
    }
  }, "Tab Permission Matrix"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '12px',
      color: '#6B7280',
      marginBottom: '12px'
    }
  }, "Configure specific permissions for each tab/feature"), /*#__PURE__*/React.createElement("div", {
    style: {
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      overflow: 'hidden',
      fontSize: '12px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'minmax(180px, 1fr) 60px 60px 60px 60px',
      background: '#F3F4F6',
      borderBottom: '2px solid #E5E7EB',
      fontWeight: '600',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 12px'
    }
  }, "Tab / Feature"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, "View"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, "Edit"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, "Create"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, "Delete")), (window.ALL_AVAILABLE_TABS || []).map((tab, index) => {
    const perms = selectedRole.tabPermissions?.[tab.id] || {
      canView: false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };
    const isInTabs = selectedRole.tabs?.includes(tab.id);
    return /*#__PURE__*/React.createElement("div", {
      key: tab.id,
      style: {
        display: 'grid',
        gridTemplateColumns: 'minmax(180px, 1fr) 60px 60px 60px 60px',
        borderBottom: '1px solid #E5E7EB',
        background: index % 2 === 0 ? 'white' : '#FAFAFA'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '8px 12px',
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        color: 'var(--autovol-navy)',
        fontWeight: '500'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: tab.icon,
      style: {
        width: '14px',
        height: '14px',
        opacity: 0.7
      }
    }), tab.label), ['canView', 'canEdit', 'canCreate', 'canDelete'].map(perm => /*#__PURE__*/React.createElement("div", {
      key: perm,
      style: {
        padding: '8px',
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: perms[perm] || false,
      onChange: () => toggleTabPermission(selectedRole.id, tab.id, perm),
      style: {
        width: '16px',
        height: '16px',
        cursor: 'pointer',
        accentColor: perm === 'canDelete' ? '#EF4444' : 'var(--autovol-teal)'
      }
    }))));
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'minmax(180px, 1fr) 60px 60px 60px 60px',
      background: '#E0F2FE',
      borderBottom: '1px solid #E5E7EB',
      fontWeight: '600',
      color: '#0369A1'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 12px'
    }
  }, "Special Features"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px',
      textAlign: 'center'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px',
      textAlign: 'center'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px',
      textAlign: 'center'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px',
      textAlign: 'center'
    }
  })), (window.SPECIAL_FEATURES || []).map((feature, index) => {
    const perms = selectedRole.tabPermissions?.[feature.id] || {
      canView: false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };
    return /*#__PURE__*/React.createElement("div", {
      key: feature.id,
      style: {
        display: 'grid',
        gridTemplateColumns: 'minmax(180px, 1fr) 60px 60px 60px 60px',
        borderBottom: '1px solid #E5E7EB',
        background: index % 2 === 0 ? '#F0F9FF' : '#E0F2FE'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '8px 12px',
        paddingLeft: '24px',
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        color: '#0369A1',
        fontWeight: '500'
      }
    }, feature.label, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '10px',
        color: '#6B7280',
        fontWeight: '400'
      }
    }, "(", feature.parentTab, ")")), ['canView', 'canEdit', 'canCreate', 'canDelete'].map(perm => /*#__PURE__*/React.createElement("div", {
      key: perm,
      style: {
        padding: '8px',
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: perms[perm] || false,
      onChange: () => toggleTabPermission(selectedRole.id, feature.id, perm),
      style: {
        width: '16px',
        height: '16px',
        cursor: 'pointer',
        accentColor: perm === 'canDelete' ? '#EF4444' : '#0EA5E9'
      }
    }))));
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px',
      marginTop: '12px',
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      // Set all visible tabs to view-only
      const newPerms = {};
      selectedRole.tabs?.forEach(tabId => {
        newPerms[tabId] = {
          canView: true,
          canEdit: false,
          canCreate: false,
          canDelete: false
        };
      });
      updateRole(selectedRole.id, {
        tabPermissions: {
          ...selectedRole.tabPermissions,
          ...newPerms
        }
      });
    },
    style: {
      padding: '6px 12px',
      fontSize: '11px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: 'white',
      cursor: 'pointer',
      color: '#374151'
    }
  }, "Set All View-Only"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      // Set all visible tabs to full edit
      const newPerms = {};
      selectedRole.tabs?.forEach(tabId => {
        newPerms[tabId] = {
          canView: true,
          canEdit: true,
          canCreate: true,
          canDelete: false
        };
      });
      updateRole(selectedRole.id, {
        tabPermissions: {
          ...selectedRole.tabPermissions,
          ...newPerms
        }
      });
    },
    style: {
      padding: '6px 12px',
      fontSize: '11px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: 'white',
      cursor: 'pointer',
      color: '#374151'
    }
  }, "Set All Edit + Create"))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '25px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '16px',
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      marginBottom: '12px'
    }
  }, "Tab Visibility & Order"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '12px',
      color: '#6B7280',
      marginBottom: '12px'
    }
  }, "Check to enable, use arrows to reorder tabs"), /*#__PURE__*/React.createElement("div", {
    style: {
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      overflow: 'hidden'
    }
  }, ALL_AVAILABLE_TABS.map(tab => {
    const isEnabled = selectedRole.tabs.includes(tab.id);
    const enabledIndex = selectedRole.tabs.indexOf(tab.id);
    const isFirst = enabledIndex === 0;
    const isLast = enabledIndex === selectedRole.tabs.length - 1;
    return /*#__PURE__*/React.createElement("div", {
      key: tab.id,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        padding: '12px',
        borderBottom: '1px solid #E5E7EB',
        background: 'white',
        opacity: isEnabled ? 1 : 0.5
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: isEnabled,
      onChange: () => toggleTab(selectedRole.id, tab.id),
      style: {
        width: '20px',
        height: '20px',
        cursor: 'pointer'
      }
    }), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '14px',
        fontWeight: '500',
        color: 'var(--autovol-navy)'
      }
    }, tab.label), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#9CA3AF',
        marginTop: '2px'
      }
    }, tab.description)), isEnabled && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '12px',
        fontWeight: '600',
        color: 'var(--autovol-navy)',
        minWidth: '20px',
        textAlign: 'center'
      }
    }, "#", enabledIndex + 1), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '4px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => moveTab(selectedRole.id, tab.id, 'up'),
      disabled: isFirst,
      style: {
        width: '28px',
        height: '28px',
        border: '1px solid #D1D5DB',
        background: 'white',
        borderRadius: '4px',
        cursor: isFirst ? 'not-allowed' : 'pointer',
        fontSize: '12px',
        opacity: isFirst ? 0.3 : 1
      },
      title: "Move up"
    }, "\u25B2"), /*#__PURE__*/React.createElement("button", {
      onClick: () => moveTab(selectedRole.id, tab.id, 'down'),
      disabled: isLast,
      style: {
        width: '28px',
        height: '28px',
        border: '1px solid #D1D5DB',
        background: 'white',
        borderRadius: '4px',
        cursor: isLast ? 'not-allowed' : 'pointer',
        fontSize: '12px',
        opacity: isLast ? 0.3 : 1
      },
      title: "Move down"
    }, "\u25BC"))));
  })))) : /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '60px 20px',
      color: '#9CA3AF'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '48px',
      marginBottom: '15px'
    }
  }, "\uD83C\uDFAD"), /*#__PURE__*/React.createElement("p", null, "Select a role to configure"))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      borderRadius: '8px',
      padding: '20px',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
      overflowY: 'auto'
    }
  }, selectedRole ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '15px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '16px',
      fontWeight: '600',
      color: 'var(--autovol-navy)',
      marginBottom: '5px'
    }
  }, "Navigation Preview"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#6B7280'
    }
  }, "How navigation appears for this role")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#F9FAFB',
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      padding: '8px'
    }
  }, selectedRole.tabs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px',
      textAlign: 'center',
      color: '#9CA3AF',
      fontSize: '13px'
    }
  }, "No tabs enabled") : selectedRole.tabs.map((tabId, index) => {
    const tab = ALL_AVAILABLE_TABS.find(t => t.id === tabId);
    if (!tab) return null;
    return /*#__PURE__*/React.createElement("div", {
      key: tabId,
      style: {
        padding: '8px 12px',
        marginBottom: '4px',
        borderRadius: '4px',
        fontSize: '13px',
        fontWeight: '500',
        display: 'flex',
        alignItems: 'center',
        gap: '6px',
        background: index === 0 ? 'var(--autovol-red)' : 'white',
        color: index === 0 ? 'white' : 'var(--autovol-navy)',
        border: index === 0 ? 'none' : '1px solid #E5E7EB'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: tab.icon,
      style: {
        width: '16px',
        height: '16px'
      }
    }), /*#__PURE__*/React.createElement("span", null, tab.label));
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '15px',
      padding: '12px',
      background: '#F9FAFB',
      borderRadius: '6px',
      border: '2px solid #E5E7EB'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      fontSize: '13px',
      marginBottom: '8px',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "Enabled Tabs:"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: '600'
    }
  }, selectedRole.tabs.length, " / ", ALL_AVAILABLE_TABS.length)), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      fontSize: '13px',
      marginBottom: '8px',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "Default Role:"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: '600'
    }
  }, selectedRole.isDefault ? 'Yes' : 'No')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      fontSize: '13px',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "Protected:"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: '600'
    }
  }, selectedRole.isProtected ? '🛡️ Yes' : 'No'))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '15px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600',
      fontSize: '13px',
      marginBottom: '10px'
    }
  }, "Capabilities:"), [{
    key: 'canEdit',
    icon: '✏️',
    label: 'Can Edit Data'
  }, {
    key: 'canCreate',
    icon: '➕',
    label: 'Can Create Records'
  }, {
    key: 'canDelete',
    icon: '🗑️',
    label: 'Can Delete Data'
  }, {
    key: 'canManageUsers',
    icon: '👥',
    label: 'Can Manage Users'
  }, {
    key: 'canAccessAdmin',
    icon: '⚙️',
    label: 'Can Access Admin'
  }, {
    key: 'canExportData',
    icon: '📥',
    label: 'Can Export Data'
  }].filter(cap => selectedRole.capabilities?.[cap.key]).map(cap => /*#__PURE__*/React.createElement("div", {
    key: cap.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      fontSize: '12px',
      color: 'var(--autovol-navy)',
      marginBottom: '6px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '14px'
    }
  }, cap.icon), /*#__PURE__*/React.createElement("span", null, cap.label))), Object.values(selectedRole.capabilities || {}).every(v => !v) && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#9CA3AF',
      fontStyle: 'italic'
    }
  }, "View-only access"))) : /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '60px 20px',
      color: '#9CA3AF'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '48px',
      marginBottom: '15px'
    }
  }, "\uD83D\uDC41\uFE0F"), /*#__PURE__*/React.createElement("p", null, "Preview will appear here")))), showEditModal && /*#__PURE__*/React.createElement(RoleEditModal, {
    role: editingRole,
    onSave: handleSaveRole,
    onCancel: () => {
      setShowEditModal(false);
      setEditingRole(null);
    }
  }), showDeleteModal && /*#__PURE__*/React.createElement(DeleteConfirmModal, {
    role: deletingRole,
    onConfirm: confirmDelete,
    onCancel: () => {
      setShowDeleteModal(false);
      setDeletingRole(null);
    },
    cannotDelete: !deletionCheck.canDelete,
    reason: deletionCheck.reason
  }));
}

// Role Edit Modal Component
function RoleEditModal({
  role,
  onSave,
  onCancel
}) {
  const [formData, setFormData] = useState({
    name: role?.name || '',
    description: role?.description || '',
    isDefault: role?.isDefault || false
  });
  const handleSubmit = e => {
    e.preventDefault();
    onSave(formData);
  };
  return /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      padding: '20px'
    },
    onClick: onCancel
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      borderRadius: '8px',
      maxWidth: '500px',
      width: '100%',
      maxHeight: '90vh',
      overflowY: 'auto',
      boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3)'
    },
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px',
      borderBottom: '2px solid #E5E7EB'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '20px',
      fontWeight: '700',
      color: 'var(--autovol-navy)'
    }
  }, role ? 'Edit Dashboard Role' : 'Create Dashboard Role')), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px'
    }
  }, !role && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px',
      borderRadius: '6px',
      marginBottom: '15px',
      fontSize: '13px',
      background: '#DBEAFE',
      color: '#1E40AF',
      border: '2px solid #93C5FD'
    }
  }, "After creating, you'll configure tabs and capabilities"), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '15px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '500',
      color: '#374151',
      marginBottom: '6px'
    }
  }, "Role Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.name,
    onChange: e => setFormData({
      ...formData,
      name: e.target.value
    }),
    placeholder: "e.g., Department Supervisor",
    required: true,
    style: {
      width: '100%',
      padding: '8px 12px',
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      fontSize: '14px'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '15px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '500',
      color: '#374151',
      marginBottom: '6px'
    }
  }, "Description"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.description,
    onChange: e => setFormData({
      ...formData,
      description: e.target.value
    }),
    placeholder: "Brief description of this role's purpose",
    style: {
      width: '100%',
      padding: '8px 12px',
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      fontSize: '14px',
      minHeight: '60px',
      resize: 'vertical'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#6B7280',
      marginTop: '4px'
    }
  }, "Help users understand who this role is for")), /*#__PURE__*/React.createElement("div", {
    onClick: () => setFormData({
      ...formData,
      isDefault: !formData.isDefault
    }),
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      padding: '12px',
      background: '#F9FAFB',
      borderRadius: '6px',
      border: '2px solid #E5E7EB',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '44px',
      height: '24px',
      background: formData.isDefault ? '#10B981' : '#D1D5DB',
      borderRadius: '12px',
      position: 'relative',
      transition: 'background 0.2s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '20px',
      height: '20px',
      background: 'white',
      borderRadius: '50%',
      position: 'absolute',
      top: '2px',
      left: formData.isDefault ? '22px' : '2px',
      transition: 'left 0.2s',
      boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '13px',
      fontWeight: '500',
      color: 'var(--autovol-navy)'
    }
  }, "Set as Default Role"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '11px',
      color: '#6B7280'
    }
  }, "New employees automatically get this role")))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px',
      borderTop: '2px solid #E5E7EB',
      display: 'flex',
      justifyContent: 'flex-end',
      gap: '10px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onCancel,
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      cursor: 'pointer',
      border: 'none',
      background: '#E5E7EB',
      color: 'var(--autovol-navy)'
    }
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "btn-primary",
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px'
    }
  }, role ? 'Save Changes' : 'Create Role')))));
}

// Delete Confirmation Modal
function DeleteConfirmModal({
  role,
  onConfirm,
  onCancel,
  cannotDelete,
  reason
}) {
  const [confirmText, setConfirmText] = useState('');
  return /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      padding: '20px'
    },
    onClick: onCancel
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'white',
      borderRadius: '8px',
      maxWidth: '500px',
      width: '100%',
      boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3)'
    },
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px',
      borderBottom: '2px solid #E5E7EB'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '20px',
      fontWeight: '700',
      color: 'var(--autovol-navy)'
    }
  }, "Delete Dashboard Role")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px'
    }
  }, cannotDelete ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px',
      borderRadius: '6px',
      fontSize: '13px',
      background: '#FEE2E2',
      color: '#991B1B',
      border: '2px solid #FCA5A5'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Cannot Delete Role:"), " ", reason) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px',
      borderRadius: '6px',
      marginBottom: '15px',
      fontSize: '13px',
      background: '#FEF3C7',
      color: '#92400E',
      border: '2px solid #FCD34D'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Warning:"), " This cannot be undone. Users assigned this role will need reassignment."), /*#__PURE__*/React.createElement("p", {
    style: {
      marginBottom: '15px',
      fontSize: '14px',
      color: 'var(--autovol-navy)'
    }
  }, "Delete: ", /*#__PURE__*/React.createElement("strong", null, role.name)), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '15px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '500',
      color: '#374151',
      marginBottom: '6px'
    }
  }, "Type \"", /*#__PURE__*/React.createElement("strong", null, "DELETE"), "\" to confirm"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: confirmText,
    onChange: e => setConfirmText(e.target.value),
    placeholder: "DELETE",
    style: {
      width: '100%',
      padding: '8px 12px',
      border: '2px solid #E5E7EB',
      borderRadius: '6px',
      fontSize: '14px'
    }
  })))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '20px',
      borderTop: '2px solid #E5E7EB',
      display: 'flex',
      justifyContent: 'flex-end',
      gap: '10px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onCancel,
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      cursor: 'pointer',
      border: 'none',
      background: '#E5E7EB',
      color: 'var(--autovol-navy)'
    }
  }, cannotDelete ? 'Close' : 'Cancel'), !cannotDelete && /*#__PURE__*/React.createElement("button", {
    onClick: onConfirm,
    disabled: confirmText !== 'DELETE',
    style: {
      padding: '8px 16px',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      cursor: confirmText === 'DELETE' ? 'pointer' : 'not-allowed',
      border: 'none',
      background: '#EF4444',
      color: 'white',
      opacity: confirmText === 'DELETE' ? 1 : 0.4
    }
  }, "Delete Role"))));
}

// ============================================================================
// END DASHBOARD ROLE MANAGER COMPONENT
// ============================================================================

// Main Dashboard Component (requires authentication)

// Export for use in App.jsx
window.DashboardRoleManager = DashboardRoleManager;
window.RoleEditModal = RoleEditModal;
window.DeleteConfirmModal = DeleteConfirmModal;
})();


// ============================================================================
// FILE: auth/CustomPermissionsEditor.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA Custom Permissions Editor
// Admin UI for managing per-user tab permission overrides
// ============================================================================
// [Removed duplicate React destructuring]
// All available tabs for permission matrix
const PERMISSION_TABS = [{
  id: 'executive',
  label: 'Executive',
  icon: 'icon-executive'
}, {
  id: 'production',
  label: 'Production',
  icon: 'icon-production'
}, {
  id: 'projects',
  label: 'Projects',
  icon: 'icon-projects'
}, {
  id: 'people',
  label: 'People',
  icon: 'icon-people'
}, {
  id: 'qa',
  label: 'QA',
  icon: 'icon-qa'
}, {
  id: 'transport',
  label: 'Transport',
  icon: 'icon-transport'
}, {
  id: 'equipment',
  label: 'Equipment',
  icon: 'icon-equipment'
}, {
  id: 'onsite',
  label: 'On-Site',
  icon: 'icon-onsite'
}, {
  id: 'engineering',
  label: 'Engineering',
  icon: 'icon-engineering'
}, {
  id: 'automation',
  label: 'Automation',
  icon: 'icon-automation'
}, {
  id: 'tracker',
  label: 'Tracker',
  icon: 'icon-tracker'
}, {
  id: 'admin',
  label: 'Admin',
  icon: 'icon-admin'
}];

// Special features that can have permissions
const SPECIAL_FEATURES = [{
  id: 'schedule_setup',
  label: 'Schedule Setup',
  parentTab: 'production'
}, {
  id: 'weekly_board',
  label: 'Weekly Board',
  parentTab: 'production'
}, {
  id: 'station_stagger',
  label: 'Station Stagger',
  parentTab: 'production'
}];
function CustomPermissionsEditor({
  userId,
  userEmail,
  userName,
  userRole,
  onClose,
  onSave
}) {
  const [customPermissions, setCustomPermissions] = useState({});
  const [originalPermissions, setOriginalPermissions] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState(null);
  const [hasChanges, setHasChanges] = useState(false);
  const [isNewCustomization, setIsNewCustomization] = useState(false);

  // Get role-based permissions for a tab from DEFAULT_DASHBOARD_ROLES
  const getRolePermissions = useCallback((roleId, tabId) => {
    const roles = window.DEFAULT_DASHBOARD_ROLES || [];
    const role = roles.find(r => r.id === roleId);
    if (!role) return {
      canView: false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };

    // Check tabPermissions first
    if (role.tabPermissions && role.tabPermissions[tabId]) {
      return {
        canView: role.tabPermissions[tabId].canView || false,
        canEdit: role.tabPermissions[tabId].canEdit || false,
        canCreate: role.tabPermissions[tabId].canCreate || false,
        canDelete: role.tabPermissions[tabId].canDelete || false
      };
    }

    // Fallback: if tab is in viewable tabs, grant view-only
    if (role.tabs?.includes(tabId)) {
      return {
        canView: true,
        canEdit: false,
        canCreate: false,
        canDelete: false
      };
    }
    return {
      canView: false,
      canEdit: false,
      canCreate: false,
      canDelete: false
    };
  }, []);

  // Build full permissions matrix from role defaults
  const buildRoleBasedPermissions = useCallback(roleId => {
    const allItems = [...PERMISSION_TABS, ...SPECIAL_FEATURES];
    const perms = {};
    allItems.forEach(item => {
      const rolePerms = getRolePermissions(roleId, item.id);
      // Only include if at least one permission is true
      if (rolePerms.canView || rolePerms.canEdit || rolePerms.canCreate || rolePerms.canDelete) {
        perms[item.id] = rolePerms;
      }
    });
    return perms;
  }, [getRolePermissions]);

  // Load user's current custom permissions OR pre-populate with role defaults
  useEffect(() => {
    const loadPermissions = async () => {
      if (!userId) return;
      setIsLoading(true);
      setError(null);
      try {
        const result = await window.MODA_SUPABASE.getUserCustomPermissions(userId);
        if (result.success) {
          if (result.hasCustomPermissions) {
            // User already has custom permissions - load them
            const perms = result.customPermissions || {};
            setCustomPermissions(perms);
            setOriginalPermissions(JSON.stringify(perms));
            setIsNewCustomization(false);
          } else {
            // No custom permissions yet - pre-populate with role defaults
            const rolePerms = buildRoleBasedPermissions(userRole);
            setCustomPermissions(rolePerms);
            setOriginalPermissions(JSON.stringify({})); // Original is empty (no custom perms)
            setIsNewCustomization(true);
          }
        } else {
          setError(result.error);
        }
      } catch (err) {
        setError(err.message);
      } finally {
        setIsLoading(false);
      }
    };
    loadPermissions();
  }, [userId, userRole, buildRoleBasedPermissions]);

  // Track changes
  useEffect(() => {
    if (originalPermissions !== null) {
      setHasChanges(JSON.stringify(customPermissions) !== originalPermissions);
    }
  }, [customPermissions, originalPermissions]);

  // Toggle a permission for a tab
  const togglePermission = useCallback((tabId, permission) => {
    setCustomPermissions(prev => {
      const current = prev[tabId] || {
        canView: false,
        canEdit: false,
        canCreate: false,
        canDelete: false
      };
      const newPerms = {
        ...current,
        [permission]: !current[permission]
      };

      // If all permissions are false, remove the tab entry
      const allFalse = !newPerms.canView && !newPerms.canEdit && !newPerms.canCreate && !newPerms.canDelete;
      if (allFalse) {
        const {
          [tabId]: removed,
          ...rest
        } = prev;
        return rest;
      }
      return {
        ...prev,
        [tabId]: newPerms
      };
    });
  }, []);

  // Clear all custom permissions
  const handleClearAll = useCallback(() => {
    if (confirm('Clear all custom permissions? User will revert to role-based defaults.')) {
      setCustomPermissions({});
    }
  }, []);

  // Save permissions to Supabase
  const handleSave = async () => {
    setIsSaving(true);
    setError(null);
    try {
      // If no custom permissions, pass null to clear
      const permsToSave = Object.keys(customPermissions).length === 0 ? null : customPermissions;
      const result = await window.MODA_SUPABASE.updateUserCustomPermissions(userId, permsToSave);
      if (result.success) {
        setOriginalPermissions(JSON.stringify(customPermissions));
        setHasChanges(false);
        if (onSave) onSave(result.user);
        if (onClose) onClose();
      } else {
        setError(result.error);
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setIsSaving(false);
    }
  };

  // Get permission value (with fallback to false)
  const getPermission = (tabId, permission) => {
    return customPermissions[tabId]?.[permission] || false;
  };

  // Check if tab has any custom permissions set
  const hasCustomForTab = tabId => {
    return customPermissions[tabId] !== undefined;
  };
  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '40px',
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '14px',
        color: '#6B7280'
      }
    }, "Loading permissions..."));
  }
  return /*#__PURE__*/React.createElement("div", {
    style: {
      maxWidth: '800px',
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '20px',
      paddingBottom: '15px',
      borderBottom: '2px solid #E5E7EB'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: 0,
      color: 'var(--autovol-navy)',
      fontSize: '18px'
    }
  }, "Custom Permissions"), /*#__PURE__*/React.createElement("p", {
    style: {
      margin: '4px 0 0',
      fontSize: '13px',
      color: '#6B7280'
    }
  }, userName || userEmail, " (", userRole, ")")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px'
    }
  }, Object.keys(customPermissions).length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: handleClearAll,
    style: {
      padding: '8px 16px',
      fontSize: '13px',
      border: '1px solid #EF4444',
      borderRadius: '6px',
      background: 'white',
      color: '#EF4444',
      cursor: 'pointer'
    }
  }, "Clear All"), onClose && /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    style: {
      padding: '8px 16px',
      fontSize: '13px',
      border: '1px solid #D1D5DB',
      borderRadius: '6px',
      background: 'white',
      color: '#374151',
      cursor: 'pointer'
    }
  }, "Cancel"))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: isNewCustomization ? '#F0FDF4' : '#EFF6FF',
      border: `1px solid ${isNewCustomization ? '#BBF7D0' : '#BFDBFE'}`,
      borderRadius: '6px',
      padding: '12px 16px',
      marginBottom: '20px',
      fontSize: '13px',
      color: isNewCustomization ? '#166534' : '#1E40AF'
    }
  }, isNewCustomization ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("strong", null, "Starting from role defaults:"), " The checkboxes below show the current permissions from the \"", userRole, "\" role. Modify as needed and save to create custom permissions for this user.") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("strong", null, "Editing custom permissions:"), " This user has custom overrides. Changes here will update their custom permissions.")), error && /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#FEF2F2',
      border: '1px solid #FECACA',
      borderRadius: '6px',
      padding: '12px 16px',
      marginBottom: '20px',
      fontSize: '13px',
      color: '#DC2626'
    }
  }, error), /*#__PURE__*/React.createElement("div", {
    style: {
      border: '2px solid #E5E7EB',
      borderRadius: '8px',
      overflow: 'hidden',
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 70px 70px 70px 70px',
      background: '#F3F4F6',
      borderBottom: '2px solid #E5E7EB',
      fontWeight: '600',
      fontSize: '12px',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, "Tab / Feature"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 8px',
      textAlign: 'center'
    }
  }, "View"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 8px',
      textAlign: 'center'
    }
  }, "Edit"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 8px',
      textAlign: 'center'
    }
  }, "Create"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 8px',
      textAlign: 'center'
    }
  }, "Delete")), PERMISSION_TABS.map((tab, index) => /*#__PURE__*/React.createElement("div", {
    key: tab.id,
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 70px 70px 70px 70px',
      borderBottom: '1px solid #E5E7EB',
      background: hasCustomForTab(tab.id) ? '#FEF3C7' : index % 2 === 0 ? 'white' : '#FAFAFA'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 16px',
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      color: 'var(--autovol-navy)',
      fontWeight: '500',
      fontSize: '13px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: tab.icon,
    style: {
      width: '16px',
      height: '16px',
      opacity: 0.7
    }
  }), tab.label, hasCustomForTab(tab.id) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '10px',
      background: '#F59E0B',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '4px',
      fontWeight: '600'
    }
  }, "CUSTOM")), ['canView', 'canEdit', 'canCreate', 'canDelete'].map(perm => /*#__PURE__*/React.createElement("div", {
    key: perm,
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: getPermission(tab.id, perm),
    onChange: () => togglePermission(tab.id, perm),
    style: {
      width: '18px',
      height: '18px',
      cursor: 'pointer',
      accentColor: perm === 'canDelete' ? '#EF4444' : 'var(--autovol-teal)'
    }
  }))))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 70px 70px 70px 70px',
      background: '#E0F2FE',
      borderBottom: '1px solid #E5E7EB',
      fontWeight: '600',
      fontSize: '12px',
      color: '#0369A1'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 16px'
    }
  }, "Special Features"), /*#__PURE__*/React.createElement("div", null), /*#__PURE__*/React.createElement("div", null), /*#__PURE__*/React.createElement("div", null), /*#__PURE__*/React.createElement("div", null)), SPECIAL_FEATURES.map((feature, index) => /*#__PURE__*/React.createElement("div", {
    key: feature.id,
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 70px 70px 70px 70px',
      borderBottom: '1px solid #E5E7EB',
      background: hasCustomForTab(feature.id) ? '#FEF3C7' : index % 2 === 0 ? '#F0F9FF' : '#E0F2FE'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 16px',
      paddingLeft: '32px',
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      color: '#0369A1',
      fontWeight: '500',
      fontSize: '13px'
    }
  }, feature.label, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '11px',
      color: '#6B7280',
      fontWeight: '400'
    }
  }, "(", feature.parentTab, ")"), hasCustomForTab(feature.id) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '10px',
      background: '#F59E0B',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '4px',
      fontWeight: '600'
    }
  }, "CUSTOM")), ['canView', 'canEdit', 'canCreate', 'canDelete'].map(perm => /*#__PURE__*/React.createElement("div", {
    key: perm,
    style: {
      padding: '10px 8px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: getPermission(feature.id, perm),
    onChange: () => togglePermission(feature.id, perm),
    style: {
      width: '18px',
      height: '18px',
      cursor: 'pointer',
      accentColor: perm === 'canDelete' ? '#EF4444' : '#0EA5E9'
    }
  })))))), Object.keys(customPermissions).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#FEF3C7',
      border: '1px solid #FCD34D',
      borderRadius: '6px',
      padding: '12px 16px',
      marginBottom: '20px',
      fontSize: '13px',
      color: '#92400E'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Custom overrides active:"), " ", Object.keys(customPermissions).join(', ')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'flex-end',
      gap: '12px'
    }
  }, hasChanges && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#F59E0B',
      alignSelf: 'center',
      fontStyle: 'italic'
    }
  }, "Unsaved changes"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSave,
    disabled: isSaving || !hasChanges,
    style: {
      padding: '10px 24px',
      fontSize: '14px',
      fontWeight: '600',
      border: 'none',
      borderRadius: '6px',
      background: hasChanges ? 'var(--autovol-teal)' : '#D1D5DB',
      color: 'white',
      cursor: hasChanges ? 'pointer' : 'not-allowed',
      opacity: isSaving ? 0.7 : 1
    }
  }, isSaving ? 'Saving...' : 'Save Custom Permissions')));
}

// Export for global access
window.CustomPermissionsEditor = CustomPermissionsEditor;
})();


// ============================================================================
// FILE: auth/UserPermissionsManager.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA User Permissions Manager
// Admin UI for viewing users and managing their custom permissions
// ============================================================================
// [Removed duplicate React destructuring]
const USERS_PER_PAGE = 10;

// Password reset handler
async function sendPasswordReset(email, setResettingFor) {
  if (!email) return;
  if (!confirm(`Send password reset email to ${email}?`)) {
    return;
  }
  setResettingFor(email);
  try {
    const result = await window.MODA_SUPABASE?.resetPassword(email);
    if (result?.success) {
      alert(`Password reset email sent to ${email}`);
    } else {
      alert('Failed to send reset email: ' + (result?.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('[UserPermissions] Password reset error:', err);
    alert('Error sending reset email: ' + err.message);
  } finally {
    setResettingFor(null);
  }
}
function UserPermissionsManager({
  auth
}) {
  const [users, setUsers] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedUser, setSelectedUser] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterRole, setFilterRole] = useState('all');
  const [currentPage, setCurrentPage] = useState(1);
  const [savingRoleFor, setSavingRoleFor] = useState(null);
  const [resettingPasswordFor, setResettingPasswordFor] = useState(null);

  // Get all available dashboard roles
  const allDashboardRoles = window.DEFAULT_DASHBOARD_ROLES || [{
    id: 'admin',
    name: 'Admin'
  }, {
    id: 'executive',
    name: 'Executive'
  }, {
    id: 'production_management',
    name: 'Production Management'
  }, {
    id: 'production_supervisor',
    name: 'Production Supervisor'
  }, {
    id: 'department-supervisor',
    name: 'Department Supervisor'
  }, {
    id: 'coordinator',
    name: 'Coordinator'
  }, {
    id: 'employee',
    name: 'Employee'
  }];

  // Load users from Supabase
  const loadUsers = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const result = await window.MODA_SUPABASE.getAllUsers();
      if (result.success) {
        setUsers(result.users || []);
      } else {
        setError(result.error);
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  }, []);
  useEffect(() => {
    loadUsers();
  }, [loadUsers]);

  // Filter users
  const filteredUsers = users.filter(user => {
    const matchesSearch = !searchTerm || (user.email || '').toLowerCase().includes(searchTerm.toLowerCase()) || (user.name || '').toLowerCase().includes(searchTerm.toLowerCase());
    const matchesRole = filterRole === 'all' || user.dashboard_role === filterRole;
    return matchesSearch && matchesRole;
  });

  // Pagination
  const totalPages = Math.ceil(filteredUsers.length / USERS_PER_PAGE);
  const startIndex = (currentPage - 1) * USERS_PER_PAGE;
  const paginatedUsers = filteredUsers.slice(startIndex, startIndex + USERS_PER_PAGE);

  // Reset to page 1 when filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, filterRole]);

  // Get unique roles for filter dropdown
  const uniqueRoles = [...new Set(users.map(u => u.dashboard_role).filter(Boolean))];

  // Handle user selection for editing
  const handleEditPermissions = user => {
    if (user.is_protected) {
      alert('Cannot modify permissions for protected users.');
      return;
    }
    setSelectedUser(user);
  };

  // Handle save from CustomPermissionsEditor
  const handleSavePermissions = updatedUser => {
    setUsers(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
    setSelectedUser(null);
  };

  // Handle role change from dropdown
  const handleRoleChange = async (userId, newRole) => {
    const user = users.find(u => u.id === userId);
    if (!user || user.is_protected) return;
    setSavingRoleFor(userId);
    try {
      const result = await window.MODA_SUPABASE?.updateUserRole(userId, newRole);
      if (result?.success) {
        setUsers(prev => prev.map(u => u.id === userId ? {
          ...u,
          dashboard_role: newRole
        } : u));
        console.log('[UserPermissions] Role updated:', userId, '->', newRole);
      } else {
        console.error('[UserPermissions] Failed to update role:', result?.error);
        alert('Failed to update role: ' + (result?.error || 'Unknown error'));
      }
    } catch (err) {
      console.error('[UserPermissions] Error updating role:', err);
      alert('Error updating role: ' + err.message);
    } finally {
      setSavingRoleFor(null);
    }
  };

  // Check if user has custom permissions
  const hasCustomPermissions = user => {
    return user.custom_tab_permissions != null && Object.keys(user.custom_tab_permissions).length > 0;
  };
  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-center py-8"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-gray-500"
    }, "Loading users...")));
  }

  // Show CustomPermissionsEditor modal when user is selected
  if (selectedUser) {
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow p-6"
    }, /*#__PURE__*/React.createElement(window.CustomPermissionsEditor, {
      userId: selectedUser.id,
      userEmail: selectedUser.email,
      userName: selectedUser.name,
      userRole: selectedUser.dashboard_role,
      onClose: () => setSelectedUser(null),
      onSave: handleSavePermissions
    }));
  }
  return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'flex-end',
      alignItems: 'center',
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: loadUsers,
    style: {
      padding: '8px 16px',
      fontSize: '13px',
      border: '1px solid #D1D5DB',
      borderRadius: '6px',
      background: 'white',
      color: '#374151',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      gap: '6px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-refresh",
    style: {
      width: '14px',
      height: '14px'
    }
  }), "Refresh")), error && /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#FEF2F2',
      border: '1px solid #FECACA',
      borderRadius: '6px',
      padding: '12px 16px',
      marginBottom: '16px',
      fontSize: '13px',
      color: '#DC2626'
    }
  }, error), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '12px',
      marginBottom: '16px',
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by name or email...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    style: {
      flex: '1',
      minWidth: '200px',
      padding: '8px 12px',
      fontSize: '13px',
      border: '1px solid #D1D5DB',
      borderRadius: '6px'
    }
  }), /*#__PURE__*/React.createElement("select", {
    value: filterRole,
    onChange: e => setFilterRole(e.target.value),
    style: {
      padding: '8px 12px',
      fontSize: '13px',
      border: '1px solid #D1D5DB',
      borderRadius: '6px',
      background: 'white',
      minWidth: '150px'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Roles"), uniqueRoles.map(role => /*#__PURE__*/React.createElement("option", {
    key: role,
    value: role
  }, role)))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#F0FDF4',
      border: '1px solid #BBF7D0',
      borderRadius: '6px',
      padding: '10px 14px',
      marginBottom: '16px',
      fontSize: '12px',
      color: '#166534'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Tip:"), " Custom permissions override role defaults. Users with custom permissions show a yellow badge."), /*#__PURE__*/React.createElement("div", {
    style: {
      border: '1px solid #E5E7EB',
      borderRadius: '8px',
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '2fr 1fr 1fr 200px',
      background: '#F9FAFB',
      borderBottom: '1px solid #E5E7EB',
      fontWeight: '600',
      fontSize: '12px',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, "User"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, "Role"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, "Status"), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      textAlign: 'center'
    }
  }, "Actions")), paginatedUsers.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '24px',
      textAlign: 'center',
      color: '#6B7280'
    }
  }, "No users found") : paginatedUsers.map((user, index) => /*#__PURE__*/React.createElement("div", {
    key: user.id,
    style: {
      display: 'grid',
      gridTemplateColumns: '2fr 1fr 1fr 200px',
      borderBottom: index < paginatedUsers.length - 1 ? '1px solid #E5E7EB' : 'none',
      background: index % 2 === 0 ? 'white' : '#FAFAFA',
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '500',
      color: 'var(--autovol-navy)',
      fontSize: '13px',
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    }
  }, user.name || user.email?.split('@')[0] || 'Unknown', user.is_protected && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '10px',
      background: '#3B82F6',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '4px',
      fontWeight: '600'
    }
  }, "PROTECTED")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#6B7280'
    }
  }, user.email)), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, user.is_protected ? /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'inline-block',
      padding: '4px 10px',
      fontSize: '11px',
      fontWeight: '600',
      borderRadius: '4px',
      background: '#DBEAFE',
      color: '#1E40AF'
    }
  }, user.dashboard_role || 'admin') : /*#__PURE__*/React.createElement("select", {
    value: user.dashboard_role || 'employee',
    onChange: e => handleRoleChange(user.id, e.target.value),
    disabled: savingRoleFor === user.id,
    style: {
      padding: '4px 8px',
      fontSize: '12px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: savingRoleFor === user.id ? '#F3F4F6' : 'white',
      color: '#374151',
      cursor: savingRoleFor === user.id ? 'wait' : 'pointer',
      minWidth: '120px'
    }
  }, allDashboardRoles.filter(r => r.id !== 'no-access').map(role => /*#__PURE__*/React.createElement("option", {
    key: role.id,
    value: role.id
  }, role.name)))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px'
    }
  }, hasCustomPermissions(user) ? /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'inline-flex',
      alignItems: 'center',
      gap: '4px',
      padding: '4px 10px',
      fontSize: '11px',
      fontWeight: '600',
      borderRadius: '4px',
      background: '#FEF3C7',
      color: '#92400E'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      width: '6px',
      height: '6px',
      borderRadius: '50%',
      background: '#F59E0B'
    }
  }), "Custom") : /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#9CA3AF'
    }
  }, "Role defaults")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      textAlign: 'center',
      display: 'flex',
      gap: '6px',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleEditPermissions(user),
    disabled: user.is_protected,
    title: "Edit custom permissions",
    style: {
      padding: '6px 10px',
      fontSize: '11px',
      border: '1px solid',
      borderColor: user.is_protected ? '#E5E7EB' : 'var(--autovol-teal)',
      borderRadius: '4px',
      background: 'white',
      color: user.is_protected ? '#9CA3AF' : 'var(--autovol-teal)',
      cursor: user.is_protected ? 'not-allowed' : 'pointer',
      fontWeight: '500'
    }
  }, hasCustomPermissions(user) ? 'Edit' : 'Customize'), /*#__PURE__*/React.createElement("button", {
    onClick: () => sendPasswordReset(user.email, setResettingPasswordFor),
    disabled: resettingPasswordFor === user.email,
    title: "Send password reset email",
    style: {
      padding: '6px 10px',
      fontSize: '11px',
      border: '1px solid #F59E0B',
      borderRadius: '4px',
      background: resettingPasswordFor === user.email ? '#FEF3C7' : 'white',
      color: '#B45309',
      cursor: resettingPasswordFor === user.email ? 'wait' : 'pointer',
      fontWeight: '500'
    }
  }, resettingPasswordFor === user.email ? 'Sending...' : 'Reset PW'))))), totalPages > 1 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '16px',
      display: 'flex',
      justifyContent: 'center',
      alignItems: 'center',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentPage(p => Math.max(1, p - 1)),
    disabled: currentPage === 1,
    style: {
      padding: '6px 12px',
      fontSize: '12px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: 'white',
      color: currentPage === 1 ? '#9CA3AF' : '#374151',
      cursor: currentPage === 1 ? 'not-allowed' : 'pointer'
    }
  }, "Previous"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '4px'
    }
  }, Array.from({
    length: totalPages
  }, (_, i) => i + 1).filter(page => {
    // Show first, last, current, and adjacent pages
    return page === 1 || page === totalPages || Math.abs(page - currentPage) <= 1;
  }).map((page, idx, arr) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: page
  }, idx > 0 && arr[idx - 1] !== page - 1 && /*#__PURE__*/React.createElement("span", {
    style: {
      padding: '6px 4px',
      color: '#9CA3AF'
    }
  }, "..."), /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentPage(page),
    style: {
      padding: '6px 10px',
      fontSize: '12px',
      border: '1px solid',
      borderColor: currentPage === page ? 'var(--autovol-teal)' : '#D1D5DB',
      borderRadius: '4px',
      background: currentPage === page ? 'var(--autovol-teal)' : 'white',
      color: currentPage === page ? 'white' : '#374151',
      cursor: 'pointer',
      fontWeight: currentPage === page ? '600' : '400'
    }
  }, page)))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentPage(p => Math.min(totalPages, p + 1)),
    disabled: currentPage === totalPages,
    style: {
      padding: '6px 12px',
      fontSize: '12px',
      border: '1px solid #D1D5DB',
      borderRadius: '4px',
      background: 'white',
      color: currentPage === totalPages ? '#9CA3AF' : '#374151',
      cursor: currentPage === totalPages ? 'not-allowed' : 'pointer'
    }
  }, "Next")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '16px',
      fontSize: '12px',
      color: '#6B7280',
      display: 'flex',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("span", null, "Showing ", startIndex + 1, "-", Math.min(startIndex + USERS_PER_PAGE, filteredUsers.length), " of ", filteredUsers.length, " users", filteredUsers.length !== users.length && ` (${users.length} total)`), /*#__PURE__*/React.createElement("span", null, users.filter(hasCustomPermissions).length, " with custom permissions")));
}

// Export for global access
window.UserPermissionsManager = UserPermissionsManager;
})();


// ============================================================================
// FILE: MobileNavigation.jsx
// ============================================================================
(function() {
// ============================================================================
// MOBILE NAVIGATION COMPONENT
// Responsive navigation drawer and bottom nav for mobile devices
// ============================================================================

/**
 * Mobile Navigation Drawer Component
 * Slides in from left on mobile/tablet devices
 */
window.MobileNavigation = function MobileNavigation({
  tabs,
  activeTab,
  onTabChange,
  currentUser,
  onLogout
}) {
  const [isOpen, setIsOpen] = React.useState(false);
  const isMobile = window.useIsMobile ? window.useIsMobile(1025) : true;

  // Close drawer when clicking overlay
  const handleOverlayClick = () => {
    setIsOpen(false);
  };

  // Close drawer when tab is selected
  const handleTabSelect = tabId => {
    onTabChange(tabId);
    setIsOpen(false);
  };

  // Prevent body scroll when drawer is open
  React.useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);

  // Don't render on desktop
  if (!isMobile) {
    return null;
  }
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    className: `mobile-fab-menu ${isOpen ? 'active' : ''}`,
    onClick: () => setIsOpen(!isOpen),
    "aria-label": "Toggle menu"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mobile-fab-icon"
  }, isOpen ? /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '24px',
      lineHeight: 1
    }
  }, "\xD7") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", null), /*#__PURE__*/React.createElement("span", null), /*#__PURE__*/React.createElement("span", null)))), /*#__PURE__*/React.createElement("div", {
    className: `mobile-nav-overlay ${isOpen ? 'active' : ''}`,
    onClick: handleOverlayClick
  }), /*#__PURE__*/React.createElement("div", {
    className: `mobile-nav-drawer ${isOpen ? 'active' : ''}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "mobile-nav-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 'bold',
      fontSize: '1.125rem'
    }
  }, "MODA"), currentUser && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '0.875rem',
      opacity: 0.9,
      marginTop: '0.25rem'
    }
  }, currentUser.email)), /*#__PURE__*/React.createElement("button", {
    className: "mobile-nav-close",
    onClick: () => setIsOpen(false),
    "aria-label": "Close menu"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "mobile-nav-items"
  }, tabs.map(tab => /*#__PURE__*/React.createElement("div", {
    key: tab.id,
    className: `mobile-nav-item ${activeTab === tab.id ? 'active' : ''}`,
    onClick: () => handleTabSelect(tab.id)
  }, /*#__PURE__*/React.createElement("span", {
    className: `mobile-nav-item-icon ${tab.icon}`
  }), /*#__PURE__*/React.createElement("span", {
    className: "mobile-nav-item-label"
  }, tab.label))), /*#__PURE__*/React.createElement("div", {
    style: {
      height: '1px',
      background: '#e5e7eb',
      margin: '1rem 1.5rem'
    }
  }), onLogout && /*#__PURE__*/React.createElement("div", {
    className: "mobile-nav-item",
    onClick: () => {
      setIsOpen(false);
      onLogout();
    },
    style: {
      color: '#dc2626'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "mobile-nav-item-icon icon-logout"
  }), /*#__PURE__*/React.createElement("span", {
    className: "mobile-nav-item-label"
  }, "Logout")))));
};

/**
 * Bottom Navigation Component
 * Fixed bottom navigation for mobile devices (alternative to drawer)
 * Shows only the most important tabs
 */
window.BottomNavigation = function BottomNavigation({
  tabs,
  activeTab,
  onTabChange,
  maxItems = 5
}) {
  const isMobile = window.useIsMobile ? window.useIsMobile(640) : true;

  // Don't render on tablet/desktop
  if (!isMobile) {
    return null;
  }

  // Show only the most important tabs
  const priorityTabs = tabs.slice(0, maxItems);
  return /*#__PURE__*/React.createElement("div", {
    className: "bottom-nav"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bottom-nav-items"
  }, priorityTabs.map(tab => /*#__PURE__*/React.createElement("div", {
    key: tab.id,
    className: `bottom-nav-item ${activeTab === tab.id ? 'active' : ''}`,
    onClick: () => onTabChange(tab.id)
  }, /*#__PURE__*/React.createElement("span", {
    className: "bottom-nav-item-icon"
  }, tab.icon), /*#__PURE__*/React.createElement("span", {
    className: "bottom-nav-item-label"
  }, tab.label.replace(/^[^\s]+\s/, '').substring(0, 10))))));
};

/**
 * Responsive Tab Bar Component
 * Shows full tab bar on desktop, hamburger menu on mobile
 */
window.ResponsiveTabBar = function ResponsiveTabBar({
  tabs,
  activeTab,
  onTabChange,
  currentUser,
  onLogout,
  children
}) {
  const isMobile = window.useIsMobile ? window.useIsMobile(1025) : true;
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '1rem',
      width: '100%'
    }
  }, isMobile && /*#__PURE__*/React.createElement(MobileNavigation, {
    tabs: tabs,
    activeTab: activeTab,
    onTabChange: onTabChange,
    currentUser: currentUser,
    onLogout: onLogout
  }), !isMobile && children);
};
console.log('✅ Mobile navigation components loaded');
})();


// ============================================================================
// FILE: TrainingMatrix.jsx
// ============================================================================
(function() {
// ============================================================================
// TRAINING MATRIX COMPONENT - People Module "Training" Sub-Tab
// Version: 3.0 - December 2024
// ============================================================================

const DEFAULT_TRAINING_STATIONS = [{
  id: 'automation',
  name: 'Automation Stations',
  type: 'hierarchical',
  order: 1,
  substations: [{
    id: 'walls',
    name: 'Walls',
    skills: [{
      skillId: 'auto-walls-0',
      name: 'SE/SSE',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-walls-1',
      name: 'ME',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-walls-2',
      name: 'Sheathing',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-walls-3',
      name: 'Tilt/Transfer',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-walls-4',
      name: 'MEP Rack',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }]
  }, {
    id: 'floors-ceilings',
    name: 'Floors/Ceilings',
    skills: [{
      skillId: 'auto-fc-0',
      name: 'SE',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-fc-1',
      name: 'ME',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-fc-2',
      name: 'Sheathing',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-fc-3',
      name: 'QC',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-fc-4',
      name: 'Transfer/Flip',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }]
  }, {
    id: 'mill',
    name: 'Mill',
    skills: [{
      skillId: 'auto-mill-0',
      name: 'Hundegger 1',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-mill-1',
      name: 'Hundegger 2',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-mill-2',
      name: 'SCM Saw',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }]
  }, {
    id: 'program-use',
    name: 'Program Use',
    skills: [{
      skillId: 'auto-prog-0',
      name: 'Hundegger-Cambium',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-prog-1',
      name: 'MS Teams',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-prog-2',
      name: 'PAT',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }, {
      skillId: 'auto-prog-3',
      name: 'TED',
      expectations: {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      },
      attachments: []
    }]
  }]
}, {
  id: 'floor-ceiling-mez',
  name: 'Floor-Ceiling Mez',
  type: 'standard',
  order: 2,
  skills: [{
    skillId: 'fcm-0',
    name: 'F/C QC',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-1',
    name: 'Flip/Outfeed',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-2',
    name: 'Fire-Blocking',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-3',
    name: 'Structural-Floors',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-4',
    name: 'Structural-Ceilings',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-5',
    name: 'Floor Decking',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-6',
    name: 'Strong-backs',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }, {
    skillId: 'fcm-7',
    name: 'A-Bay Hoist',
    expectations: {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    },
    attachments: []
  }]
}, {
  id: 'plumb-rough-floors',
  name: 'Plumb Rough-Floors',
  type: 'standard',
  order: 3,
  skills: []
}, {
  id: 'plumb-rough',
  name: 'Plumbing Rough-In',
  type: 'standard',
  order: 4,
  skills: []
}, {
  id: 'plumb-trim',
  name: 'Plumbing Trim',
  type: 'standard',
  order: 5,
  skills: []
}, {
  id: 'hvac-rough',
  name: 'HVAC Rough-In',
  type: 'standard',
  order: 6,
  skills: []
}, {
  id: 'hvac-trim',
  name: 'HVAC Trim',
  type: 'standard',
  order: 7,
  skills: []
}, {
  id: 'elec-rough-ceil',
  name: 'Elec Rough-Ceilings',
  type: 'standard',
  order: 8,
  skills: []
}, {
  id: 'elec-rough',
  name: 'Electrical Rough-In',
  type: 'standard',
  order: 9,
  skills: []
}, {
  id: 'elec-trim',
  name: 'Electrical Trim',
  type: 'standard',
  order: 10,
  skills: []
}, {
  id: 'wall-set',
  name: 'Wall Set',
  type: 'standard',
  order: 11,
  skills: []
}, {
  id: 'ceiling-set',
  name: 'Ceiling Set',
  type: 'standard',
  order: 12,
  skills: []
}, {
  id: 'soffits',
  name: 'Soffits',
  type: 'standard',
  order: 13,
  skills: []
}, {
  id: 'exteriors',
  name: 'Exteriors',
  type: 'standard',
  order: 14,
  skills: []
}, {
  id: 'drywall',
  name: 'Drywall',
  type: 'standard',
  order: 15,
  skills: []
}, {
  id: 'roofing',
  name: 'Roofing',
  type: 'standard',
  order: 16,
  skills: []
}, {
  id: 'pre-finish',
  name: 'Pre-Finish',
  type: 'standard',
  order: 17,
  skills: []
}, {
  id: 'final-finish',
  name: 'Final Finish',
  type: 'standard',
  order: 18,
  skills: []
}, {
  id: 'close-up',
  name: 'Close-Up/Transport',
  type: 'standard',
  order: 19,
  skills: []
}];
function getTrainingSkillCount(station) {
  if (station.type === 'hierarchical' && station.substations) {
    return station.substations.reduce((sum, sub) => sum + (sub.skills?.length || 0), 0);
  }
  return station.skills?.length || 0;
}
function getAllSkillsFromStation(station) {
  if (station.type === 'hierarchical' && station.substations) {
    const skills = [];
    station.substations.forEach(sub => {
      (sub.skills || []).forEach(skill => {
        skills.push({
          ...skill,
          substationId: sub.id,
          substationName: sub.name
        });
      });
    });
    return skills;
  }
  return station.skills || [];
}
function TrainingMatrixView({
  employees: propEmployees,
  currentUser,
  isAdmin
}) {
// [Removed duplicate React destructuring]
  const [trainingEmployees, setTrainingEmployees] = useState([]);
  const [trainingStations, setTrainingStations] = useState([]);
  const [trainingProgress, setTrainingProgress] = useState({});
  const [collapsedStations, setCollapsedStations] = useState({});
  const [searchTerm, setSearchTerm] = useState('');
  const [deptFilter, setDeptFilter] = useState('all');
  const [sortBy, setSortBy] = useState('name');
  const [statusMsg, setStatusMsg] = useState(null);
  const [showSkillModal, setShowSkillModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [showManagerModal, setShowManagerModal] = useState(false);
  const [currentStation, setCurrentStation] = useState(null);
  const [currentSubstation, setCurrentSubstation] = useState(null);
  const [currentSkill, setCurrentSkill] = useState(null);

  // Load data
  useEffect(() => {
    if (propEmployees?.length > 0) {
      setTrainingEmployees(propEmployees.filter(e => e.jobTitle === 'Line Solutioneer'));
    }
    const safeParseJSON = (str, fallback) => {
      if (str && str !== 'undefined' && str !== 'null') {
        try {
          return JSON.parse(str);
        } catch (e) {
          return fallback;
        }
      }
      return fallback;
    };
    const stored = localStorage.getItem('moda_training_stations');
    setTrainingStations(safeParseJSON(stored, DEFAULT_TRAINING_STATIONS));
    const prog = localStorage.getItem('moda_training_progress');
    if (prog && prog !== 'undefined' && prog !== 'null') setTrainingProgress(safeParseJSON(prog, {}));
    const coll = localStorage.getItem('moda_training_collapsed');
    if (coll && coll !== 'undefined' && coll !== 'null') setCollapsedStations(safeParseJSON(coll, {}));
  }, [propEmployees]);

  // Save data
  useEffect(() => {
    if (trainingStations.length > 0) localStorage.setItem('moda_training_stations', JSON.stringify(trainingStations));
  }, [trainingStations]);
  useEffect(() => {
    localStorage.setItem('moda_training_progress', JSON.stringify(trainingProgress));
  }, [trainingProgress]);
  useEffect(() => {
    localStorage.setItem('moda_training_collapsed', JSON.stringify(collapsedStations));
  }, [collapsedStations]);
  const depts = useMemo(() => [...new Set(trainingEmployees.map(e => e.department).filter(Boolean))].sort(), [trainingEmployees]);
  const filtered = useMemo(() => {
    let r = trainingEmployees.filter(e => {
      if (!e) return false;
      const fullName = `${e.firstName || ''} ${e.lastName || ''}`.toLowerCase();
      return fullName.includes((searchTerm || '').toLowerCase()) && (deptFilter === 'all' || e.department === deptFilter);
    });
    r.sort((a, b) => {
      if (!a || !b) return 0;
      if (sortBy === 'name') return (a.lastName || '').localeCompare(b.lastName || '');
      if (sortBy === 'department') return (a.department || '').localeCompare(b.department || '');
      if (sortBy === 'hireDate') return new Date(a.hireDate || 0) - new Date(b.hireDate || 0);
      return 0;
    });
    return r;
  }, [trainingEmployees, searchTerm, deptFilter, sortBy]);
  const showStatus = (msg, type = 'success') => {
    setStatusMsg({
      msg,
      type
    });
    setTimeout(() => setStatusMsg(null), 4000);
  };
  const toggleStation = id => setCollapsedStations(p => ({
    ...p,
    [id]: !p[id]
  }));
  const getProgress = (empId, skillId) => trainingProgress[`${empId}-${skillId}`]?.progress || 0;
  const updateProgress = (empId, skillId, val) => {
    setTrainingProgress(p => ({
      ...p,
      [`${empId}-${skillId}`]: {
        progress: val,
        lastUpdated: new Date().toISOString()
      }
    }));
  };
  const saveSkill = (stationId, subId, skill, isEdit) => {
    setTrainingStations(prev => prev.map(s => {
      if (s.id !== stationId) return s;
      if (s.type === 'hierarchical' && subId) {
        return {
          ...s,
          substations: s.substations.map(sub => {
            if (sub.id !== subId) return sub;
            return isEdit ? {
              ...sub,
              skills: sub.skills.map(sk => sk.skillId === skill.skillId ? skill : sk)
            } : {
              ...sub,
              skills: [...(sub.skills || []), skill]
            };
          })
        };
      }
      return isEdit ? {
        ...s,
        skills: s.skills.map(sk => sk.skillId === skill.skillId ? skill : sk)
      } : {
        ...s,
        skills: [...(s.skills || []), skill]
      };
    }));
    showStatus(isEdit ? 'Skill updated' : 'Skill added');
  };
  const removeSkill = (stationId, subId, skillId) => {
    setTrainingStations(prev => prev.map(s => {
      if (s.id !== stationId) return s;
      if (s.type === 'hierarchical' && subId) {
        return {
          ...s,
          substations: s.substations.map(sub => sub.id !== subId ? sub : {
            ...sub,
            skills: sub.skills.filter(sk => sk.skillId !== skillId)
          })
        };
      }
      return {
        ...s,
        skills: s.skills.filter(sk => sk.skillId !== skillId)
      };
    }));
    showStatus('Skill removed');
  };
  const openAddSkill = (stationId, subId) => {
    setCurrentStation(stationId);
    setCurrentSubstation(subId);
    setCurrentSkill(null);
    setShowSkillModal(true);
  };
  const openEditSkill = skill => {
    const st = trainingStations.find(s => s.type === 'hierarchical' ? s.substations?.some(sub => sub.skills?.some(sk => sk.skillId === skill.skillId)) : s.skills?.some(sk => sk.skillId === skill.skillId));
    if (st) {
      setCurrentStation(st.id);
      setCurrentSubstation(st.type === 'hierarchical' ? st.substations.find(sub => sub.skills?.some(sk => sk.skillId === skill.skillId))?.id : null);
    }
    setCurrentSkill(skill);
    setShowSkillModal(true);
  };
  const openManager = st => {
    setCurrentStation(st);
    setShowManagerModal(true);
  };
  const openDetail = sk => {
    setCurrentSkill(sk);
    setShowDetailModal(true);
  };
  const exportAll = () => {
    const d = {
      type: 'complete',
      stations: trainingStations,
      progress: trainingProgress
    };
    const b = new Blob([JSON.stringify(d, null, 2)], {
      type: 'application/json'
    });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = `Training_Matrix_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showStatus('Data exported');
  };
  const exportSkills = () => {
    const d = {
      type: 'skills-config',
      stations: trainingStations
    };
    const b = new Blob([JSON.stringify(d, null, 2)], {
      type: 'application/json'
    });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = `Skills_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showStatus('Skills exported');
  };
  const importSkills = imported => {
    setTrainingStations(prev => prev.map(s => {
      const imp = imported.find(i => i.id === s.id);
      if (!imp) return s;
      if (s.type === 'hierarchical' && imp.substations) {
        return {
          ...s,
          substations: s.substations.map(sub => {
            const iSub = imp.substations.find(is => is.id === sub.id);
            return iSub ? {
              ...sub,
              skills: iSub.skills || []
            } : sub;
          })
        };
      }
      return {
        ...s,
        skills: imp.skills || []
      };
    }));
    showStatus('Skills imported');
  };
  const clearProgress = () => {
    if (confirm('Clear all progress? This cannot be undone!')) {
      setTrainingProgress({});
      showStatus('Progress cleared');
    }
  };

  // Skill Builder Modal
  const SkillModal = () => {
    const [name, setName] = useState(currentSkill?.name || '');
    const [exp, setExp] = useState(currentSkill?.expectations || {
      '25': '',
      '50': '',
      '75': '',
      '100': ''
    });
    useEffect(() => {
      setName(currentSkill?.name || '');
      setExp(currentSkill?.expectations || {
        '25': '',
        '50': '',
        '75': '',
        '100': ''
      });
    }, [currentSkill]);
    if (!showSkillModal) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => setShowSkillModal(false)
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-4"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold"
    }, currentSkill ? 'Edit Skill' : 'Add Skill'), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowSkillModal(false),
      className: "text-2xl text-gray-400"
    }, "\xD7")), /*#__PURE__*/React.createElement("div", {
      className: "space-y-3"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium mb-1"
    }, "Skill Name *"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: name,
      onChange: e => setName(e.target.value),
      className: "w-full px-3 py-2 border rounded-lg"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium mb-1"
    }, "25% Expectation"), /*#__PURE__*/React.createElement("textarea", {
      value: exp['25'],
      onChange: e => setExp({
        ...exp,
        '25': e.target.value
      }),
      rows: "2",
      className: "w-full px-3 py-2 border rounded-lg"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium mb-1"
    }, "50% Expectation"), /*#__PURE__*/React.createElement("textarea", {
      value: exp['50'],
      onChange: e => setExp({
        ...exp,
        '50': e.target.value
      }),
      rows: "2",
      className: "w-full px-3 py-2 border rounded-lg"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium mb-1"
    }, "75% Expectation"), /*#__PURE__*/React.createElement("textarea", {
      value: exp['75'],
      onChange: e => setExp({
        ...exp,
        '75': e.target.value
      }),
      rows: "2",
      className: "w-full px-3 py-2 border rounded-lg"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium mb-1"
    }, "100% Expectation"), /*#__PURE__*/React.createElement("textarea", {
      value: exp['100'],
      onChange: e => setExp({
        ...exp,
        '100': e.target.value
      }),
      rows: "2",
      className: "w-full px-3 py-2 border rounded-lg"
    }))), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 justify-end mt-4"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowSkillModal(false),
      className: "px-4 py-2 bg-gray-200 rounded-lg"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        if (!name.trim()) return alert('Enter skill name');
        saveSkill(currentStation, currentSubstation, {
          skillId: currentSkill?.skillId || `${currentSubstation || currentStation}-${Date.now()}`,
          name: name.trim(),
          expectations: exp,
          attachments: []
        }, !!currentSkill);
        setShowSkillModal(false);
      },
      className: "px-4 py-2 btn-primary rounded-lg"
    }, currentSkill ? 'Update' : 'Add')))));
  };

  // Skill Detail Modal
  const DetailModal = () => {
    if (!showDetailModal || !currentSkill) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => {
        setShowDetailModal(false);
        setCurrentSkill(null);
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-2xl w-full",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-4"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold"
    }, currentSkill.name), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowDetailModal(false);
        setCurrentSkill(null);
      },
      className: "text-2xl text-gray-400"
    }, "\xD7")), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded bg-red-50 border-l-4 border-red-400"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-semibold text-red-800 text-sm"
    }, "25%"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs"
    }, currentSkill.expectations?.['25'] || 'Not defined')), /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded bg-yellow-50 border-l-4 border-yellow-400"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-semibold text-yellow-800 text-sm"
    }, "50%"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs"
    }, currentSkill.expectations?.['50'] || 'Not defined')), /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded bg-orange-50 border-l-4 border-orange-400"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-semibold text-orange-800 text-sm"
    }, "75%"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs"
    }, currentSkill.expectations?.['75'] || 'Not defined')), /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded bg-green-50 border-l-4 border-green-400"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-semibold text-green-800 text-sm"
    }, "100%"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs"
    }, currentSkill.expectations?.['100'] || 'Not defined'))), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 justify-end mt-4"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        openEditSkill(currentSkill);
        setShowDetailModal(false);
      },
      className: "px-4 py-2 bg-blue-600 text-white rounded-lg"
    }, "Edit"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowDetailModal(false);
        setCurrentSkill(null);
      },
      className: "px-4 py-2 bg-gray-200 rounded-lg"
    }, "Close")))));
  };

  // Station Manager Modal
  const ManagerModal = () => {
    if (!showManagerModal || !currentStation) return null;
    const skills = getAllSkillsFromStation(currentStation);
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => {
        setShowManagerModal(false);
        setCurrentStation(null);
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-4"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold"
    }, "Manage: ", currentStation.name), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowManagerModal(false);
        setCurrentStation(null);
      },
      className: "text-2xl text-gray-400"
    }, "\xD7")), skills.length === 0 ? /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 text-center py-4"
    }, "No skills yet") : /*#__PURE__*/React.createElement("ul", {
      className: "space-y-2"
    }, skills.map((sk, i) => /*#__PURE__*/React.createElement("li", {
      key: sk.skillId,
      className: "flex justify-between items-center p-2 bg-gray-50 rounded border"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm"
    }, i + 1, ". ", sk.name, " ", sk.substationName && /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-400"
    }, "(", sk.substationName, ")")), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-1"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        openEditSkill(sk);
        setShowManagerModal(false);
      },
      className: "px-2 py-1 text-xs bg-blue-600 text-white rounded"
    }, "Edit"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        if (confirm(`Remove "${sk.name}"?`)) removeSkill(currentStation.id, sk.substationId, sk.skillId);
      },
      className: "px-2 py-1 text-xs bg-red-600 text-white rounded"
    }, "Remove"))))), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 justify-end mt-4"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        openAddSkill(currentStation.id, currentStation.type === 'hierarchical' ? currentStation.substations[0]?.id : null);
        setShowManagerModal(false);
      },
      className: "px-4 py-2 btn-primary rounded-lg"
    }, "+ Add Skill"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowManagerModal(false);
        setCurrentStation(null);
      },
      className: "px-4 py-2 bg-gray-200 rounded-lg"
    }, "Close")))));
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Training Matrix"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Track skill progress \u2022 Click headers to collapse")), /*#__PURE__*/React.createElement("span", {
    className: "px-3 py-1 rounded-full text-sm font-medium text-white",
    style: {
      backgroundColor: 'var(--autovol-blue)'
    }
  }, filtered.length, " Line Solutioneers")), statusMsg && /*#__PURE__*/React.createElement("div", {
    className: `p-3 rounded-lg ${statusMsg.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`
  }, statusMsg.msg), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2 items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "search",
    placeholder: "Search...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "px-3 py-2 border rounded-lg w-40"
  }), /*#__PURE__*/React.createElement("select", {
    value: deptFilter,
    onChange: e => setDeptFilter(e.target.value),
    className: "px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All (", trainingEmployees.length, ")"), depts.map(d => /*#__PURE__*/React.createElement("option", {
    key: d,
    value: d
  }, d))), /*#__PURE__*/React.createElement("select", {
    value: sortBy,
    onChange: e => setSortBy(e.target.value),
    className: "px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "name"
  }, "Name"), /*#__PURE__*/React.createElement("option", {
    value: "department"
  }, "Dept"), /*#__PURE__*/React.createElement("option", {
    value: "hireDate"
  }, "Hire"))), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "px-3 py-2 bg-green-600 text-white rounded-lg text-sm cursor-pointer"
  }, "Import", /*#__PURE__*/React.createElement("input", {
    type: "file",
    accept: ".json",
    className: "hidden",
    onChange: e => {
      const f = e.target.files[0];
      if (f) {
        const r = new FileReader();
        r.onload = ev => {
          try {
            const d = JSON.parse(ev.target.result);
            if (d.stations) importSkills(d.stations);
          } catch (err) {
            alert('Error');
          }
        };
        r.readAsText(f);
      }
    }
  })), /*#__PURE__*/React.createElement("button", {
    onClick: exportSkills,
    className: "px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
  }, "Export Skills"), /*#__PURE__*/React.createElement("button", {
    onClick: exportAll,
    className: "px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
  }, "Export All"), /*#__PURE__*/React.createElement("button", {
    onClick: clearProgress,
    className: "px-3 py-2 bg-red-600 text-white rounded-lg text-sm"
  }, "Clear"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-x-auto",
    style: {
      maxHeight: 'calc(100vh - 350px)'
    }
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "sticky left-0 z-20 px-3 py-2 text-left font-semibold text-white",
    style: {
      backgroundColor: 'var(--autovol-charcoal)',
      minWidth: '150px'
    },
    rowSpan: "2"
  }, "Employee"), trainingStations.map(st => {
    const collapsed = collapsedStations[st.id];
    const cnt = getTrainingSkillCount(st);
    if (collapsed) {
      return /*#__PURE__*/React.createElement("th", {
        key: st.id,
        className: "px-1 py-2 text-white cursor-pointer text-[10px]",
        style: {
          backgroundColor: 'var(--autovol-blue)',
          writingMode: 'vertical-rl',
          transform: 'rotate(180deg)',
          minWidth: '25px'
        },
        rowSpan: "2",
        onClick: () => toggleStation(st.id)
      }, st.name);
    }
    return /*#__PURE__*/React.createElement("th", {
      key: st.id,
      className: "px-1 py-1 text-white cursor-pointer text-[10px]",
      style: {
        backgroundColor: 'var(--autovol-blue)'
      },
      colSpan: Math.max(cnt, 1),
      onClick: () => toggleStation(st.id)
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-center gap-1"
    }, /*#__PURE__*/React.createElement("span", null, "\u25BC"), /*#__PURE__*/React.createElement("span", null, st.name), /*#__PURE__*/React.createElement("button", {
      className: "ml-1 px-1 bg-white bg-opacity-20 rounded",
      onClick: e => {
        e.stopPropagation();
        openManager(st);
      }
    }, "\u2699")));
  })), /*#__PURE__*/React.createElement("tr", null, trainingStations.map(st => {
    if (collapsedStations[st.id]) return null;
    const skills = getAllSkillsFromStation(st);
    if (skills.length === 0) {
      return /*#__PURE__*/React.createElement("th", {
        key: `${st.id}-add`,
        className: "px-1 py-1 bg-blue-100"
      }, /*#__PURE__*/React.createElement("button", {
        className: "px-1 py-1 text-[9px] bg-blue-600 text-white rounded",
        onClick: () => openAddSkill(st.id, st.type === 'hierarchical' ? st.substations[0]?.id : null)
      }, "+Add"));
    }
    return skills.map(sk => /*#__PURE__*/React.createElement("th", {
      key: sk.skillId,
      className: "px-1 py-1 text-[9px] text-white font-medium",
      style: {
        backgroundColor: '#1E40AF',
        minWidth: '60px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex flex-col items-center"
    }, /*#__PURE__*/React.createElement("span", null, sk.name), /*#__PURE__*/React.createElement("button", {
      className: "mt-1 px-1 bg-white bg-opacity-20 rounded",
      onClick: () => openDetail(sk)
    }, "..."))));
  }))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, filtered.length === 0 ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
    colSpan: "1000",
    className: "px-4 py-8 text-center text-gray-500"
  }, trainingEmployees.length === 0 ? 'No Line Solutioneers found' : 'No matches')) : filtered.map(emp => /*#__PURE__*/React.createElement("tr", {
    key: emp.id,
    className: "hover:bg-gray-50"
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky left-0 z-10 px-3 py-2 bg-white border-r-2",
    style: {
      borderColor: 'var(--autovol-charcoal)'
    }
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-sm"
  }, emp.lastName, ", ", emp.firstName), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, emp.department || '-')), trainingStations.map(st => {
    if (collapsedStations[st.id]) {
      return /*#__PURE__*/React.createElement("td", {
        key: `${emp.id}-${st.id}`,
        className: "px-1 py-1 text-center text-gray-400 bg-gray-50"
      }, "-");
    }
    const skills = getAllSkillsFromStation(st);
    if (skills.length === 0) {
      return /*#__PURE__*/React.createElement("td", {
        key: `${emp.id}-${st.id}`,
        className: "px-1 py-1 text-center text-gray-400 bg-gray-50"
      }, "-");
    }
    return skills.map(sk => /*#__PURE__*/React.createElement("td", {
      key: `${emp.id}-${sk.skillId}`,
      className: "px-1 py-1"
    }, /*#__PURE__*/React.createElement("select", {
      value: getProgress(emp.id, sk.skillId),
      onChange: e => updateProgress(emp.id, sk.skillId, parseInt(e.target.value)),
      className: "w-full px-1 py-1 text-xs border rounded font-semibold"
    }, /*#__PURE__*/React.createElement("option", {
      value: "0"
    }, "0%"), /*#__PURE__*/React.createElement("option", {
      value: "25"
    }, "25%"), /*#__PURE__*/React.createElement("option", {
      value: "50"
    }, "50%"), /*#__PURE__*/React.createElement("option", {
      value: "75"
    }, "75%"), /*#__PURE__*/React.createElement("option", {
      value: "100"
    }, "100%"))));
  })))))), /*#__PURE__*/React.createElement(SkillModal, null), /*#__PURE__*/React.createElement(DetailModal, null), /*#__PURE__*/React.createElement(ManagerModal, null));
}

// Make available globally
window.TrainingMatrixView = TrainingMatrixView;
})();


// ============================================================================
// FILE: WeeklyBoard.jsx
// ============================================================================
(function() {
// ============================================================================
// WEEKLY BOARD COMPONENTS
// Weekly Board and Schedule Setup sub-tabs for Production Dashboard
// ============================================================================

// ===== DATE HELPER FUNCTIONS =====
// Format a Date object to YYYY-MM-DD string in LOCAL timezone (not UTC)
const formatLocalDate = date => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Parse a YYYY-MM-DD string as LOCAL date (not UTC)
// This prevents timezone shift when parsing date strings
const parseLocalDate = dateStr => {
  if (!dateStr) return new Date();
  const [year, month, day] = dateStr.split('-').map(Number);
  return new Date(year, month - 1, day);
};

// ===== WEEKLY SCHEDULE MANAGEMENT HOOK =====
// Manages schedule setup (shift assignments) and completed week history
// Uses Supabase for persistence (shared across all users)
// Only trevor@autovol.com and stephanie@autovol.com can edit schedules
const useWeeklySchedule = () => {
// [Removed duplicate React destructuring]
  const DEFAULT_SCHEDULE = {
    shift1: {
      monday: 5,
      tuesday: 5,
      wednesday: 5,
      thursday: 5
    },
    shift2: {
      friday: 0,
      saturday: 0,
      sunday: 0
    }
  };

  // Current week's schedule setup (per-day module assignments by shift)
  const [scheduleSetup, setScheduleSetup] = useState(DEFAULT_SCHEDULE);

  // Completed weeks history
  const [completedWeeks, setCompletedWeeks] = useState([]);

  // Loading and sync state
  const [loading, setLoading] = useState(true);
  const [synced, setSynced] = useState(false);

  // Debug info for mobile testing (visible in UI)
  const [debugInfo, setDebugInfo] = useState({
    source: 'initializing',
    retries: 0,
    error: null
  });

  // Track if we can edit (only trevor@autovol.com)
  const [canEdit, setCanEdit] = useState(false);

  // Ref to track if we're saving to prevent loops
  const isSaving = useRef(false);
  // Ref to track if update came from real-time (skip save)
  const isFromRealtime = useRef(false);

  // Check Supabase availability
  const isSupabaseAvailable = useCallback(() => {
    return window.MODA_SUPABASE_DATA?.isAvailable?.() && window.MODA_SUPABASE_DATA?.weeklySchedules;
  }, []);

  // Load from Supabase on mount with retry for late initialization
  useEffect(() => {
    let retryCount = 0;
    const MAX_RETRIES = 5;
    let retryTimer = null;
    let unsubscribe = null;
    const loadFromSupabase = async () => {
      const available = isSupabaseAvailable();
      console.log('[WeeklySchedule] Load attempt', retryCount + 1, '- Supabase available:', available);
      setDebugInfo(prev => ({
        ...prev,
        retries: retryCount
      }));
      if (!available) {
        // Retry a few times before falling back to localStorage
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          console.log('[WeeklySchedule] Supabase not ready, retry in 500ms (attempt', retryCount, 'of', MAX_RETRIES, ')');
          retryTimer = setTimeout(loadFromSupabase, 500);
          return;
        }
        console.log('[WeeklySchedule] Supabase not available after retries, using localStorage fallback');
        setDebugInfo({
          source: 'localStorage',
          retries: retryCount,
          error: 'Supabase not available'
        });
        // Fallback to localStorage with safe parsing
        try {
          const savedSetup = localStorage.getItem('autovol_schedule_setup');
          const savedWeeks = localStorage.getItem('autovol_completed_weeks');
          if (savedSetup && savedSetup !== 'undefined' && savedSetup !== 'null') {
            setScheduleSetup(JSON.parse(savedSetup));
          }
          if (savedWeeks && savedWeeks !== 'undefined' && savedWeeks !== 'null') {
            setCompletedWeeks(JSON.parse(savedWeeks));
          }
        } catch (e) {
          console.error('[WeeklySchedule] Error parsing localStorage:', e);
        }
        setLoading(false);
        return;
      }
      try {
        const api = window.MODA_SUPABASE_DATA.weeklySchedules;

        // Check edit permission
        setCanEdit(api.canEdit());

        // Load current schedule
        const current = await api.getCurrent();
        console.log('[WeeklySchedule] Loaded current schedule from Supabase:', current);
        if (current) {
          setScheduleSetup({
            shift1: current.shift1 || DEFAULT_SCHEDULE.shift1,
            shift2: current.shift2 || DEFAULT_SCHEDULE.shift2
          });
        } else {
          console.log('[WeeklySchedule] No current schedule in Supabase, using defaults');
        }

        // Load completed weeks
        const completed = await api.getCompleted();
        setCompletedWeeks(completed.map(w => ({
          id: w.id,
          weekId: w.week_id,
          shift1: w.shift1,
          shift2: w.shift2,
          lineBalance: w.line_balance,
          completedAt: w.completed_at,
          scheduleSnapshot: w.schedule_snapshot
        })));
        setSynced(true);
        setDebugInfo({
          source: 'supabase',
          retries: retryCount,
          error: null
        });
        console.log('[WeeklySchedule] Loaded from Supabase successfully');

        // Subscribe to real-time updates after successful load
        unsubscribe = window.MODA_SUPABASE_DATA.weeklySchedules.onSnapshot(({
          current,
          completed
        }) => {
          if (isSaving.current) return; // Skip if we're the one saving

          console.log('[WeeklySchedule] Real-time update received');
          if (current) {
            isFromRealtime.current = true; // Mark as real-time update to skip save
            setScheduleSetup({
              shift1: current.shift1 || DEFAULT_SCHEDULE.shift1,
              shift2: current.shift2 || DEFAULT_SCHEDULE.shift2
            });
          }
          if (completed) {
            setCompletedWeeks(completed.map(w => ({
              id: w.id,
              weekId: w.week_id,
              shift1: w.shift1,
              shift2: w.shift2,
              lineBalance: w.line_balance,
              completedAt: w.completed_at,
              scheduleSnapshot: w.schedule_snapshot
            })));
          }
        });
      } catch (err) {
        console.error('[WeeklySchedule] Load error:', err);
        setDebugInfo({
          source: 'localStorage',
          retries: retryCount,
          error: err.message
        });
        // Fallback to localStorage with safe parsing
        try {
          const savedSetup = localStorage.getItem('autovol_schedule_setup');
          const savedWeeks = localStorage.getItem('autovol_completed_weeks');
          if (savedSetup && savedSetup !== 'undefined' && savedSetup !== 'null') {
            setScheduleSetup(JSON.parse(savedSetup));
          }
          if (savedWeeks && savedWeeks !== 'undefined' && savedWeeks !== 'null') {
            setCompletedWeeks(JSON.parse(savedWeeks));
          }
        } catch (parseErr) {
          console.error('[WeeklySchedule] Error parsing localStorage fallback:', parseErr);
        }
      } finally {
        setLoading(false);
      }
    };
    loadFromSupabase();
    return () => {
      if (retryTimer) clearTimeout(retryTimer);
      if (unsubscribe) unsubscribe();
    };
  }, [isSupabaseAvailable]);

  // Re-check edit permissions when user profile changes
  // This runs continuously until permission is granted (no timeout)
  useEffect(() => {
    let pollInterval = null;
    let isMounted = true;
    const checkPermissions = () => {
      // Check if user profile is available
      const userProfile = window.MODA_SUPABASE?.userProfile;
      const hasProfile = userProfile && (userProfile.email || userProfile.dashboard_role);
      if (!hasProfile) {
        // Profile not ready yet - keep waiting
        return false;
      }
      if (isSupabaseAvailable() && window.MODA_SUPABASE_DATA?.weeklySchedules) {
        const newCanEdit = window.MODA_SUPABASE_DATA.weeklySchedules.canEdit();
        console.log('[WeeklySchedule] Permission check result:', newCanEdit);
        if (isMounted) {
          setCanEdit(newCanEdit);
        }
        return true; // Profile was checked (regardless of result)
      }
      return false;
    };

    // Check immediately
    if (checkPermissions()) {
      return; // Already have profile, no need to poll
    }

    // Poll every 200ms until profile is available (no timeout - keep trying)
    pollInterval = setInterval(() => {
      if (checkPermissions()) {
        // Profile loaded and checked, stop polling
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }, 200);

    // Listen for profile changes (backup mechanism)
    const handleProfileChange = event => {
      console.log('[WeeklySchedule] Profile loaded event received');
      setTimeout(() => {
        if (checkPermissions() && pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }, 50);
    };
    window.addEventListener('moda-profile-loaded', handleProfileChange);
    return () => {
      isMounted = false;
      if (pollInterval) clearInterval(pollInterval);
      window.removeEventListener('moda-profile-loaded', handleProfileChange);
    };
  }, [isSupabaseAvailable]);

  // Save to Supabase when schedule changes (debounced)
  useEffect(() => {
    if (loading) return; // Don't save during initial load

    // Skip save if this update came from real-time subscription
    if (isFromRealtime.current) {
      isFromRealtime.current = false; // Reset flag
      return;
    }

    // Always save to localStorage as backup
    localStorage.setItem('autovol_schedule_setup', JSON.stringify(scheduleSetup));

    // Save to Supabase if available and user can edit
    if (isSupabaseAvailable() && canEdit) {
      isSaving.current = true;
      const saveTimeout = setTimeout(async () => {
        try {
          await window.MODA_SUPABASE_DATA.weeklySchedules.saveCurrent(scheduleSetup);
          setSynced(true);
        } catch (err) {
          console.error('[WeeklySchedule] Save error:', err);
          setSynced(false);
        } finally {
          isSaving.current = false;
        }
      }, 500); // Debounce 500ms

      return () => clearTimeout(saveTimeout);
    }
  }, [scheduleSetup, loading, isSupabaseAvailable, canEdit]);

  // Update shift schedule (only if user can edit)
  const updateShiftSchedule = useCallback((shift, day, value) => {
    if (!canEdit) {
      console.warn('[WeeklySchedule] Cannot edit - user role does not have schedule_setup permission');
      return;
    }
    setScheduleSetup(prev => ({
      ...prev,
      [shift]: {
        ...prev[shift],
        [day]: parseInt(value) || 0
      }
    }));
  }, [canEdit]);

  // Get total modules for a shift
  const getShiftTotal = useCallback(shift => {
    const shiftData = scheduleSetup[shift] || {};
    return Object.values(shiftData).reduce((sum, val) => sum + (val || 0), 0);
  }, [scheduleSetup]);

  // Get total line balance (all shifts combined)
  const getLineBalance = useCallback(() => {
    return getShiftTotal('shift1') + getShiftTotal('shift2');
  }, [getShiftTotal]);

  // Complete a week - creates historical record
  const completeWeek = useCallback(async weekData => {
    if (!canEdit) {
      console.warn('[WeeklySchedule] Cannot complete week - user role does not have schedule_setup permission');
      return null;
    }
    const completedWeek = {
      weekId: weekData.weekId || `week-${Date.now()}`,
      shift1: scheduleSetup.shift1,
      shift2: scheduleSetup.shift2,
      lineBalance: weekData.lineBalance || getLineBalance(),
      scheduleSnapshot: {
        ...scheduleSetup
      }
    };
    if (isSupabaseAvailable()) {
      try {
        const saved = await window.MODA_SUPABASE_DATA.weeklySchedules.completeWeek(completedWeek);
        const formattedWeek = {
          id: saved.id,
          ...completedWeek,
          completedAt: saved.completed_at
        };
        setCompletedWeeks(prev => [formattedWeek, ...prev]);
        return formattedWeek;
      } catch (err) {
        console.error('[WeeklySchedule] Complete week error:', err);
      }
    }

    // Fallback to localStorage
    const localWeek = {
      id: `completed-week-${Date.now()}`,
      ...completedWeek,
      completedAt: new Date().toISOString()
    };
    setCompletedWeeks(prev => {
      const updated = [localWeek, ...prev];
      localStorage.setItem('autovol_completed_weeks', JSON.stringify(updated));
      return updated;
    });
    return localWeek;
  }, [canEdit, scheduleSetup, getLineBalance, isSupabaseAvailable]);

  // Get completed week by ID
  const getCompletedWeek = useCallback(weekId => {
    return completedWeeks.find(w => w.id === weekId);
  }, [completedWeeks]);

  // Get recent completed weeks (for summary view)
  const getRecentWeeks = useCallback((count = 10) => {
    return completedWeeks.slice(0, count);
  }, [completedWeeks]);

  // Delete a completed week record
  const deleteCompletedWeek = useCallback(async weekId => {
    if (!canEdit) {
      console.warn('[WeeklySchedule] Cannot delete - only trevor@autovol.com or stephanie@autovol.com can modify schedules');
      return;
    }
    if (isSupabaseAvailable()) {
      try {
        await window.MODA_SUPABASE_DATA.weeklySchedules.deleteCompleted(weekId);
      } catch (err) {
        console.error('[WeeklySchedule] Delete error:', err);
      }
    }
    setCompletedWeeks(prev => {
      const updated = prev.filter(w => w.id !== weekId);
      localStorage.setItem('autovol_completed_weeks', JSON.stringify(updated));
      return updated;
    });
  }, [canEdit, isSupabaseAvailable]);
  return {
    scheduleSetup,
    completedWeeks,
    updateShiftSchedule,
    getShiftTotal,
    getLineBalance,
    completeWeek,
    getCompletedWeek,
    getRecentWeeks,
    deleteCompletedWeek,
    loading,
    synced,
    canEdit,
    debugInfo
  };
};

// ===== SCHEDULED PROJECTS SECTION COMPONENT =====
// Shows Active/Scheduled/Planned projects with ability to reorder and remove from schedule
function ScheduledProjectsSection({
  projects,
  setProjects,
  canEdit
}) {
// [Removed duplicate React destructuring]
  // Categorize projects
  const categorizedProjects = useMemo(() => {
    const active = []; // Has progression - locked
    const scheduled = []; // On weekly board (status=Active) but no progression yet
    const planned = []; // Not on weekly board yet (status=Planning/Planned)

    (projects || []).forEach(p => {
      if (p.status === 'Complete') return; // Skip completed projects

      // Check if any module has progression (stageProgress > 0 at any station)
      const hasProgression = (p.modules || []).some(m => {
        const progress = m.stageProgress || {};
        return Object.values(progress).some(v => v > 0);
      });
      if (p.status === 'Active') {
        if (hasProgression) {
          active.push(p);
        } else {
          scheduled.push(p);
        }
      } else {
        planned.push(p);
      }
    });

    // Sort by productionOrder
    active.sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999));
    scheduled.sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999));
    planned.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    return {
      active,
      scheduled,
      planned
    };
  }, [projects]);

  // Move project up in order (swap with previous)
  const handleMoveUp = (project, category) => {
    if (!canEdit || !setProjects) return;
    const list = category === 'scheduled' ? categorizedProjects.scheduled : categorizedProjects.planned;
    const idx = list.findIndex(p => p.id === project.id);
    if (idx <= 0) return;
    const prevProject = list[idx - 1];
    const currentOrder = project.productionOrder || 999;
    const prevOrder = prevProject.productionOrder || 999;

    // Swap production orders
    setProjects(prev => prev.map(p => {
      if (p.id === project.id) return {
        ...p,
        productionOrder: prevOrder
      };
      if (p.id === prevProject.id) return {
        ...p,
        productionOrder: currentOrder
      };
      return p;
    }));
  };

  // Move project down in order (swap with next)
  const handleMoveDown = (project, category) => {
    if (!canEdit || !setProjects) return;
    const list = category === 'scheduled' ? categorizedProjects.scheduled : categorizedProjects.planned;
    const idx = list.findIndex(p => p.id === project.id);
    if (idx < 0 || idx >= list.length - 1) return;
    const nextProject = list[idx + 1];
    const currentOrder = project.productionOrder || 999;
    const nextOrder = nextProject.productionOrder || 999;

    // Swap production orders
    setProjects(prev => prev.map(p => {
      if (p.id === project.id) return {
        ...p,
        productionOrder: nextOrder
      };
      if (p.id === nextProject.id) return {
        ...p,
        productionOrder: currentOrder
      };
      return p;
    }));
  };

  // Remove project from schedule (set back to Planning, clear productionOrder)
  const handleRemoveFromSchedule = project => {
    if (!canEdit || !setProjects) return;
    if (!confirm(`Remove "${project.name}" from the production schedule?\n\nThis will set the project back to Planning status. You can re-schedule it from the Projects tab.`)) return;
    setProjects(prev => prev.map(p => {
      if (p.id !== project.id) return p;
      // Clear productionOrder and set status back to Planning
      const {
        productionOrder,
        ...rest
      } = p;
      return {
        ...rest,
        status: 'Planning',
        modules: (p.modules || []).map(m => ({
          ...m,
          isOnline: false
        }))
      };
    }));
  };
  const totalScheduled = categorizedProjects.active.length + categorizedProjects.scheduled.length;
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white border-2 border-purple-400 rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-purple-500 text-white px-4 py-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, "Scheduled Projects"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm opacity-75"
  }, "Production order for Weekly Board")), /*#__PURE__*/React.createElement("span", {
    className: "bg-purple-700 text-white px-2 py-0.5 rounded text-sm font-medium"
  }, totalScheduled, " project", totalScheduled !== 1 ? 's' : '', " scheduled")), /*#__PURE__*/React.createElement("div", {
    className: "p-4 space-y-4"
  }, categorizedProjects.active.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-semibold text-green-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-2 h-2 bg-green-500 rounded-full"
  }), "Active Projects (Locked - has progression)"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1"
  }, categorizedProjects.active.map((p, idx) => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "flex items-center gap-3 p-2 bg-green-50 border border-green-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400 font-mono text-sm w-6"
  }, "#", p.productionOrder || idx + 1), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-800 flex-1"
  }, p.name), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, (p.modules || []).length, " modules"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded"
  }, "Active"))))), categorizedProjects.scheduled.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-2 h-2 bg-blue-500 rounded-full"
  }), "Scheduled Projects (No progression yet)"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1"
  }, categorizedProjects.scheduled.map((p, idx) => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "flex items-center gap-3 p-2 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400 font-mono text-sm w-6"
  }, "#", p.productionOrder || idx + 1), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-800 flex-1"
  }, p.name), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, (p.modules || []).length, " modules"), canEdit && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleMoveUp(p, 'scheduled'),
    disabled: idx === 0,
    className: "px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded disabled:opacity-30 disabled:cursor-not-allowed",
    title: "Move up"
  }, "\u2191"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleMoveDown(p, 'scheduled'),
    disabled: idx === categorizedProjects.scheduled.length - 1,
    className: "px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded disabled:opacity-30 disabled:cursor-not-allowed",
    title: "Move down"
  }, "\u2193"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleRemoveFromSchedule(p),
    className: "px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-600 rounded",
    title: "Remove from schedule"
  }, "Remove")))))), categorizedProjects.planned.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-semibold text-gray-600 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-2 h-2 bg-gray-400 rounded-full"
  }), "Planned Projects (Not scheduled)"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1"
  }, categorizedProjects.planned.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "flex items-center gap-3 p-2 bg-gray-50 border border-gray-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300 font-mono text-sm w-6"
  }, "\u2014"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-600 flex-1"
  }, p.name), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, (p.modules || []).length, " modules"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded"
  }, p.status || 'Planning')))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, "To schedule a project, go to Projects \u2192 select project \u2192 click \"Schedule Online\"")), totalScheduled === 0 && categorizedProjects.planned.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-4 text-gray-500"
  }, "No projects found. Create projects in the Projects tab.")));
}

// ===== CALENDAR WEEK PICKER COMPONENT =====
// A calendar-style week picker that shows weeks in a monthly grid
function CalendarWeekPicker({
  weeks,
  currentWeek,
  selectedWeekId,
  onSelectWeek,
  onClose
}) {
// [Removed duplicate React destructuring]
  // Initialize to the month of the current/selected week
  const initialDate = useMemo(() => {
    if (selectedWeekId) {
      const selected = weeks.find(w => w.id === selectedWeekId);
      if (selected?.weekStart) return parseLocalDate(selected.weekStart);
    }
    if (currentWeek?.weekStart) return parseLocalDate(currentWeek.weekStart);
    return new Date();
  }, [selectedWeekId, currentWeek, weeks]);
  const [viewDate, setViewDate] = useState(initialDate);

  // Get month/year for display
  const monthYear = viewDate.toLocaleDateString('en-US', {
    month: 'long',
    year: 'numeric'
  });

  // Navigate months
  const prevMonth = () => setViewDate(d => new Date(d.getFullYear(), d.getMonth() - 1, 1));
  const nextMonth = () => setViewDate(d => new Date(d.getFullYear(), d.getMonth() + 1, 1));
  const prevYear = () => setViewDate(d => new Date(d.getFullYear() - 1, d.getMonth(), 1));
  const nextYear = () => setViewDate(d => new Date(d.getFullYear() + 1, d.getMonth(), 1));
  const goToToday = () => setViewDate(new Date());

  // Get weeks that fall within the current view month
  const weeksInMonth = useMemo(() => {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    return weeks.filter(w => {
      if (!w.weekStart) return false;
      const weekStart = parseLocalDate(w.weekStart);
      const weekEnd = parseLocalDate(w.weekEnd || w.weekStart);
      // Include week if it overlaps with this month
      return weekStart <= lastDay && weekEnd >= firstDay;
    }).sort((a, b) => parseLocalDate(a.weekStart) - parseLocalDate(b.weekStart));
  }, [weeks, viewDate]);

  // Get week status
  const getWeekStatus = week => {
    const now = new Date();
    const weekEnd = parseLocalDate(week.weekEnd || week.weekStart);
    const weekStart = parseLocalDate(week.weekStart);
    if (currentWeek?.id === week.id) return 'current';
    if (weekEnd < now) return 'past';
    if (weekStart > now) return 'future';
    return 'active';
  };
  const getWeekStyles = week => {
    const status = getWeekStatus(week);
    const isSelected = selectedWeekId === week.id;
    let base = 'p-2 rounded-lg border-2 cursor-pointer transition-all text-left ';
    if (isSelected) {
      base += 'border-blue-500 bg-blue-50 ring-2 ring-blue-300 ';
    } else if (status === 'current') {
      base += 'border-green-500 bg-green-50 hover:bg-green-100 ';
    } else if (status === 'past') {
      base += 'border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-500 ';
    } else {
      base += 'border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-300 ';
    }
    return base;
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "absolute top-full left-0 mt-2 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 w-80",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 border-b bg-gray-50 rounded-t-xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: prevYear,
    className: "p-1 hover:bg-gray-200 rounded text-gray-500",
    title: "Previous Year"
  }, "\xAB"), /*#__PURE__*/React.createElement("button", {
    onClick: prevMonth,
    className: "p-1 hover:bg-gray-200 rounded text-gray-500",
    title: "Previous Month"
  }, "\u2039")), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-gray-800"
  }, monthYear), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: nextMonth,
    className: "p-1 hover:bg-gray-200 rounded text-gray-500",
    title: "Next Month"
  }, "\u203A"), /*#__PURE__*/React.createElement("button", {
    onClick: nextYear,
    className: "p-1 hover:bg-gray-200 rounded text-gray-500",
    title: "Next Year"
  }, "\xBB"))), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: goToToday,
    className: "text-xs text-blue-600 hover:underline"
  }, "Today"), currentWeek && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onSelectWeek(null);
      onClose();
    },
    className: "text-xs text-green-600 hover:underline"
  }, "Current Week"))), /*#__PURE__*/React.createElement("div", {
    className: "p-3 max-h-64 overflow-y-auto"
  }, weeksInMonth.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-4 text-gray-500 text-sm"
  }, "No weeks configured for this month") : /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, weeksInMonth.map(week => {
    const status = getWeekStatus(week);
    const startDate = parseLocalDate(week.weekStart);
    const endDate = parseLocalDate(week.weekEnd || week.weekStart);
    const weekNum = week.weekNumber || Math.ceil((startDate - new Date(startDate.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    return /*#__PURE__*/React.createElement("button", {
      key: week.id,
      onClick: () => {
        onSelectWeek(week.id);
        onClose();
      },
      className: getWeekStyles(week) + ' w-full'
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, "Week ", weekNum), /*#__PURE__*/React.createElement("div", {
      className: "font-medium text-sm"
    }, startDate.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    }), " - ", endDate.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    }))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, status === 'current' && /*#__PURE__*/React.createElement("span", {
      className: "px-1.5 py-0.5 bg-green-500 text-white text-xs rounded"
    }, "Current"), status === 'past' && /*#__PURE__*/React.createElement("span", {
      className: "px-1.5 py-0.5 bg-gray-400 text-white text-xs rounded"
    }, "Past"), status === 'future' && /*#__PURE__*/React.createElement("span", {
      className: "px-1.5 py-0.5 bg-blue-500 text-white text-xs rounded"
    }, "Future"), week.plannedModules > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-500"
    }, week.plannedModules, " mod"))));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "p-2 border-t bg-gray-50 rounded-b-xl"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "w-full py-1.5 text-sm text-gray-600 hover:bg-gray-200 rounded"
  }, "Close")));
}

// ===== COLLAPSIBLE MODULE DROPDOWN COMPONENT =====
// Custom dropdown that groups modules by project with collapsible sections
// Default order: newest projects first (by production order descending)
function CollapsibleModuleDropdown({
  modules,
  value,
  onChange,
  placeholder = "Select a module..."
}) {
// [Removed duplicate React destructuring]
  const [isOpen, setIsOpen] = useState(false);
  const [collapsedProjects, setCollapsedProjects] = useState({});
  const dropdownRef = useRef(null);

  // Group modules by project, sorted newest first (highest production order first, then by name)
  const groupedModules = useMemo(() => {
    const groups = {};
    (modules || []).forEach(m => {
      const projectKey = m.projectId || 'unknown';
      if (!groups[projectKey]) {
        groups[projectKey] = {
          projectId: m.projectId,
          projectName: m.projectName || 'Unknown Project',
          productionOrder: m.projectProductionOrder || 999,
          modules: []
        };
      }
      groups[projectKey].modules.push(m);
    });

    // Sort modules within each project by buildSequence
    Object.values(groups).forEach(group => {
      group.modules.sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
    });

    // Return as array sorted by production order (newest/highest first)
    return Object.values(groups).sort((a, b) => b.productionOrder - a.productionOrder);
  }, [modules]);

  // Find selected module for display
  const selectedModule = useMemo(() => {
    return (modules || []).find(m => m.serialNumber === value);
  }, [modules, value]);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = e => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  const toggleProject = projectId => {
    setCollapsedProjects(prev => ({
      ...prev,
      [projectId]: !prev[projectId]
    }));
  };
  const handleSelect = module => {
    onChange(module.serialNumber);
    setIsOpen(false);
  };
  return /*#__PURE__*/React.createElement("div", {
    ref: dropdownRef,
    className: "relative"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setIsOpen(!isOpen),
    className: "w-full border rounded-lg px-3 py-2 text-left bg-white flex items-center justify-between hover:border-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: selectedModule ? 'text-gray-900' : 'text-gray-500'
  }, selectedModule ? `${selectedModule.serialNumber} (#${selectedModule.buildSequence}) - ${selectedModule.projectName}` : placeholder), /*#__PURE__*/React.createElement("svg", {
    className: `w-5 h-5 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`,
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M19 9l-7 7-7-7"
  }))), isOpen && /*#__PURE__*/React.createElement("div", {
    className: "absolute z-50 mt-1 w-full bg-white border rounded-lg shadow-lg max-h-80 overflow-y-auto"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      onChange('');
      setIsOpen(false);
    },
    className: "w-full px-3 py-2 text-left text-gray-500 hover:bg-gray-100 border-b"
  }, placeholder), groupedModules.map(group => /*#__PURE__*/React.createElement("div", {
    key: group.projectId,
    className: "border-b last:border-b-0"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => toggleProject(group.projectId),
    className: "w-full px-3 py-2 text-left bg-gray-50 hover:bg-gray-100 flex items-center justify-between font-medium text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-700"
  }, group.projectName, " (", group.modules.length, ")"), /*#__PURE__*/React.createElement("svg", {
    className: `w-4 h-4 text-gray-500 transition-transform ${collapsedProjects[group.projectId] ? '' : 'rotate-180'}`,
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M19 9l-7 7-7-7"
  }))), !collapsedProjects[group.projectId] && /*#__PURE__*/React.createElement("div", {
    className: "max-h-48 overflow-y-auto"
  }, group.modules.map(m => /*#__PURE__*/React.createElement("button", {
    key: m.id,
    type: "button",
    onClick: () => handleSelect(m),
    className: `w-full px-4 py-1.5 text-left text-sm hover:bg-blue-50 flex items-center gap-2 ${value === m.serialNumber ? 'bg-blue-100 text-blue-800' : 'text-gray-700'}`
  }, m.isPrototype && /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-500",
    title: "Prototype"
  }, "\u2605"), /*#__PURE__*/React.createElement("span", {
    className: "font-mono"
  }, m.serialNumber), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "(#", m.buildSequence, ")"))))))));
}

// ===== PROTOTYPE SCHEDULING SECTION COMPONENT =====
function PrototypeSchedulingSection({
  allModules,
  sortedModules,
  projects,
  setProjects,
  onPlaceOnBoard
}) {
// [Removed duplicate React destructuring]
  const [expandedProto, setExpandedProto] = useState(null);

  // Get all prototype modules from ALL projects (not just Active ones)
  // This ensures prototypes are visible for scheduling regardless of parent project status
  const prototypeModules = useMemo(() => {
    return (projects || []).flatMap(p => (p.modules || []).filter(m => m.isPrototype).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name,
      projectAbbreviation: p.abbreviation
    })));
  }, [projects]);

  // Get modules for "Insert After" dropdown (sorted by buildSequence)
  // Include: non-prototypes with integer buildSequence, AND scheduled prototypes (with decimal buildSequence)
  // This allows consecutive prototype scheduling (e.g., Proto 2 after Proto 1)
  // Group by project for better UX in the dropdown
  const insertTargetsByProject = useMemo(() => {
    // Combine sortedModules with already-scheduled prototypes from prototypeModules
    const scheduledPrototypes = prototypeModules.filter(m => m.buildSequence && !Number.isInteger(m.buildSequence)).map(m => ({
      ...m,
      isScheduledPrototype: true
    }));
    const regularModules = sortedModules.filter(m => !m.isPrototype && Number.isInteger(m.buildSequence));

    // Merge all modules
    const allModules = [...regularModules, ...scheduledPrototypes];

    // Group by project, then sort each group by buildSequence
    const grouped = {};
    allModules.forEach(m => {
      const projectKey = m.projectId || 'unknown';
      if (!grouped[projectKey]) {
        grouped[projectKey] = {
          projectId: m.projectId,
          projectName: m.projectName || 'Unknown Project',
          modules: []
        };
      }
      grouped[projectKey].modules.push(m);
    });

    // Sort modules within each project by buildSequence
    Object.values(grouped).forEach(group => {
      group.modules.sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
    });

    // Return as array of project groups, sorted by first module's buildSequence
    return Object.values(grouped).sort((a, b) => {
      const aFirst = a.modules[0]?.buildSequence || 0;
      const bFirst = b.modules[0]?.buildSequence || 0;
      return aFirst - bFirst;
    });
  }, [sortedModules, prototypeModules]);

  // Calculate the next available decimal slot after a given module
  const getNextDecimalSlot = afterBuildSeq => {
    // Combine regular modules and prototype modules to check for existing decimals
    const allModulesForCheck = [...sortedModules, ...prototypeModules];

    // Find all modules with buildSequence between afterBuildSeq and the next integer
    // For decimal afterBuildSeq (e.g., 28.1), look between 28.1 and 29
    const baseInt = Math.floor(afterBuildSeq);
    const existingDecimals = allModulesForCheck.filter(m => m.buildSequence > afterBuildSeq && m.buildSequence < baseInt + 1).map(m => m.buildSequence);
    if (existingDecimals.length === 0) {
      // If afterBuildSeq is already decimal, add 0.1 to it
      // If it's an integer, start at .1
      const newSeq = Number.isInteger(afterBuildSeq) ? afterBuildSeq + 0.1 : Math.round((afterBuildSeq + 0.1) * 100) / 100;
      return newSeq;
    }
    // Find the max and add 0.1
    const maxDecimal = Math.max(...existingDecimals);
    return Math.round((maxDecimal + 0.1) * 100) / 100; // Round to 2 decimal places
  };

  // Update a prototype's buildSequence based on "Insert After" selection
  // Stores original build sequence so it can be restored later
  const handleInsertAfter = (protoModule, afterModuleSerial) => {
    console.log('[PrototypeScheduling] handleInsertAfter called:', {
      protoSerial: protoModule.serialNumber,
      afterSerial: afterModuleSerial,
      hasSetProjects: !!setProjects
    });
    if (!afterModuleSerial || !setProjects) {
      console.warn('[PrototypeScheduling] Missing afterModuleSerial or setProjects');
      return;
    }

    // Search in both regular modules and scheduled prototypes
    let afterModule = sortedModules.find(m => m.serialNumber === afterModuleSerial);
    if (!afterModule) {
      // Check if it's a scheduled prototype
      afterModule = prototypeModules.find(m => m.serialNumber === afterModuleSerial);
    }
    if (!afterModule) {
      console.warn('[PrototypeScheduling] Could not find afterModule:', afterModuleSerial);
      return;
    }
    const newBuildSeq = getNextDecimalSlot(afterModule.buildSequence);
    console.log('[PrototypeScheduling] Calculated newBuildSeq:', newBuildSeq, 'after:', afterModule.buildSequence);

    // Update the module in projects - store original sequence for restoration
    setProjects(prev => {
      const updated = prev.map(project => {
        if (project.id !== protoModule.projectId) return project;
        return {
          ...project,
          modules: (project.modules || []).map(m => {
            if (m.id !== protoModule.id) return m;
            // Store original build sequence if not already stored
            const originalSeq = m.originalBuildSequence || m.buildSequence;
            console.log('[PrototypeScheduling] Updating module:', m.serialNumber, 'with insertedAfter:', afterModuleSerial);
            return {
              ...m,
              buildSequence: newBuildSeq,
              insertedAfter: afterModuleSerial,
              originalBuildSequence: originalSeq
            };
          })
        };
      });
      return updated;
    });
    setExpandedProto(null);
  };

  // Clear insertion (reset to original project sequence)
  // Restores the prototype's original build sequence from its source project
  const handleClearInsertion = protoModule => {
    if (!setProjects) return;

    // Use the stored original build sequence if available, otherwise use module's index in project
    const project = projects?.find(p => p.id === protoModule.projectId);
    const projectModules = project?.modules || [];
    const protoIndex = projectModules.findIndex(m => m.id === protoModule.id);

    // Restore to original sequence (stored when first inserted) or calculate from project position
    const originalSeq = protoModule.originalBuildSequence || protoIndex + 1;
    setProjects(prev => prev.map(proj => {
      if (proj.id !== protoModule.projectId) return proj;
      return {
        ...proj,
        modules: (proj.modules || []).map(m => {
          if (m.id !== protoModule.id) return m;
          const {
            insertedAfter,
            ...rest
          } = m;
          return {
            ...rest,
            buildSequence: originalSeq
          };
        })
      };
    }));
  };
  if (prototypeModules.length === 0) {
    return null; // Don't show section if no prototypes
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white border-2 border-yellow-400 rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-yellow-400 text-yellow-900 px-4 py-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\u2605"), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, "Prototype Scheduling"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm opacity-75"
  }, "Insert prototypes into production schedule")), /*#__PURE__*/React.createElement("span", {
    className: "bg-yellow-600 text-white px-2 py-0.5 rounded text-sm font-medium"
  }, prototypeModules.length, " prototype", prototypeModules.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mb-3"
  }, "Prototypes use decimal build sequences (e.g., 5.1) to slot between main project modules without disrupting their numbering."), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, prototypeModules.map(proto => {
    const isExpanded = expandedProto === proto.id;
    const hasInsertion = proto.insertedAfter;
    const isDecimal = proto.buildSequence && !Number.isInteger(proto.buildSequence);
    return /*#__PURE__*/React.createElement("div", {
      key: proto.id,
      className: `border rounded-lg p-3 ${hasInsertion ? 'border-green-300 bg-green-50' : 'border-yellow-200 bg-yellow-50'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-yellow-500 text-lg"
    }, "\u2605"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "font-mono font-bold text-gray-800"
    }, proto.serialNumber), /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-500 ml-2"
    }, "(", proto.projectName, ")")), /*#__PURE__*/React.createElement("div", {
      className: "text-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Seq:"), /*#__PURE__*/React.createElement("span", {
      className: `font-mono ml-1 ${isDecimal ? 'text-green-600 font-bold' : 'text-gray-600'}`
    }, "#", proto.buildSequence)), hasInsertion && /*#__PURE__*/React.createElement("span", {
      className: "text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded"
    }, "After ", proto.insertedAfter)), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, hasInsertion && /*#__PURE__*/React.createElement("button", {
      onClick: () => handleClearInsertion(proto),
      className: "px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 rounded"
    }, "Clear"), onPlaceOnBoard && /*#__PURE__*/React.createElement("button", {
      onClick: () => onPlaceOnBoard(proto),
      className: "px-3 py-1 text-sm bg-green-500 hover:bg-green-600 text-white rounded font-medium"
    }, "Place on Board"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setExpandedProto(isExpanded ? null : proto.id),
      className: "px-3 py-1 text-sm bg-yellow-200 hover:bg-yellow-300 text-yellow-800 rounded font-medium"
    }, isExpanded ? 'Cancel' : 'Insert After...'))), isExpanded && /*#__PURE__*/React.createElement("div", {
      className: "mt-3 pt-3 border-t border-yellow-200"
    }, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Insert this prototype after:"), /*#__PURE__*/React.createElement("select", {
      className: "w-full border rounded-lg px-3 py-2",
      defaultValue: "",
      onChange: e => handleInsertAfter(proto, e.target.value)
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "Select a module..."), insertTargetsByProject.map(group => /*#__PURE__*/React.createElement("optgroup", {
      key: group.projectId,
      label: group.projectName
    }, group.modules.map(m => /*#__PURE__*/React.createElement("option", {
      key: m.id,
      value: m.serialNumber
    }, m.isScheduledPrototype ? '★ ' : '', m.serialNumber, " (#", m.buildSequence, ")"))))), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-1"
    }, "The prototype will be assigned a decimal sequence to slot after the selected module.")));
  }))));
}

// ===== SCHEDULE SETUP SUB-TAB COMPONENT =====
function ScheduleSetupTab({
  scheduleSetup,
  updateShiftSchedule,
  getShiftTotal,
  getLineBalance,
  // Week configuration props
  weeks,
  currentWeek,
  addWeek,
  updateWeek,
  deleteWeek,
  validateWeek,
  allModules,
  // Prototype scheduling props
  projects,
  setProjects,
  // Permission props
  canEdit = true,
  // Tab-specific edit permission (false = view-only mode)
  userEmail = '',
  // User email passed from Dashboard auth
  // Navigation props
  onViewWeek = null,
  // Callback to view a week in WeeklyBoard: (weekId) => void
  onPlacePrototype = null,
  // Callback to place a prototype on the board: (prototype) => void
  initialEditWeekId = null,
  // Week ID to open edit modal for (from WeeklyBoard Edit Week button)
  onEditWeekHandled = null // Callback when edit week has been handled
}) {
// [Removed duplicate React destructuring]
  // Handle "Place on Board" button click - stores prototype in localStorage and navigates to Weekly Board
  const handlePlaceOnBoard = useCallback(prototype => {
    // Store prototype in localStorage for WeeklyBoardTab to pick up
    localStorage.setItem('moda_prototype_placement', JSON.stringify(prototype));
    // Navigate to Weekly Board tab if callback provided
    if (onViewWeek) {
      onViewWeek(null); // null means current week
    }
  }, [onViewWeek]);
  const shift1Days = ['monday', 'tuesday', 'wednesday', 'thursday'];
  const shift2Days = ['friday', 'saturday', 'sunday'];
  const dayLabels = {
    monday: 'Mon',
    tuesday: 'Tue',
    wednesday: 'Wed',
    thursday: 'Thu',
    friday: 'Fri',
    saturday: 'Sat',
    sunday: 'Sun'
  };

  // Week configuration state
  const [showAddWeek, setShowAddWeek] = useState(false);
  const [editingWeek, setEditingWeek] = useState(null);
  const [error, setError] = useState('');

  // Collapsible state for Year > Quarter grouping
  // Default: current year expanded, current quarter expanded
  const currentYear = new Date().getFullYear();
  const currentQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
  const [expandedYears, setExpandedYears] = useState({
    [currentYear]: true
  });
  const [expandedQuarters, setExpandedQuarters] = useState({
    [`${currentYear}-Q${currentQuarter}`]: true
  });
  const toggleYear = year => {
    setExpandedYears(prev => ({
      ...prev,
      [year]: !prev[year]
    }));
  };
  const toggleQuarter = yearQuarterKey => {
    setExpandedQuarters(prev => ({
      ...prev,
      [yearQuarterKey]: !prev[yearQuarterKey]
    }));
  };

  // Group weeks by year and quarter
  const groupWeeksByYearQuarter = weeksList => {
    const grouped = {};
    (weeksList || []).forEach(week => {
      const year = week.year || parseLocalDate(week.weekStart).getFullYear();
      const quarter = week.quarter || Math.ceil((parseLocalDate(week.weekStart).getMonth() + 1) / 3);
      if (!grouped[year]) grouped[year] = {};
      if (!grouped[year][quarter]) grouped[year][quarter] = [];
      grouped[year][quarter].push(week);
    });
    // Sort weeks within each quarter by week number (ascending)
    Object.keys(grouped).forEach(year => {
      Object.keys(grouped[year]).forEach(quarter => {
        grouped[year][quarter].sort((a, b) => (a.weekNumber || 0) - (b.weekNumber || 0));
      });
    });
    return grouped;
  };
  const [formData, setFormData] = useState({
    weekStart: '',
    weekEnd: '',
    productionGoal: 20,
    dailyGoal: 5,
    startingModule: '',
    notes: '',
    // Per-week daily targets
    shift1: {
      monday: 5,
      tuesday: 5,
      wednesday: 5,
      thursday: 5
    },
    shift2: {
      friday: 0,
      saturday: 0,
      sunday: 0
    }
  });

  // Handle initialEditWeekId from WeeklyBoard Edit Week button
  React.useEffect(() => {
    if (initialEditWeekId && weeks) {
      const weekToEdit = weeks.find(w => w.id === initialEditWeekId);
      if (weekToEdit) {
        // Open the edit modal for this week
        setFormData({
          weekStart: weekToEdit.weekStart,
          weekEnd: weekToEdit.weekEnd,
          productionGoal: weekToEdit.productionGoal || 20,
          dailyGoal: weekToEdit.dailyGoal || 5,
          startingModule: weekToEdit.startingModule || '',
          notes: weekToEdit.notes || '',
          shift1: weekToEdit.shift1 || {
            monday: 5,
            tuesday: 5,
            wednesday: 5,
            thursday: 5
          },
          shift2: weekToEdit.shift2 || {
            friday: 0,
            saturday: 0,
            sunday: 0
          }
        });
        setEditingWeek(weekToEdit);
        setShowAddWeek(true);
        setError('');

        // Expand the year and quarter containing this week
        const year = weekToEdit.year || parseLocalDate(weekToEdit.weekStart).getFullYear();
        const quarter = weekToEdit.quarter || Math.ceil((parseLocalDate(weekToEdit.weekStart).getMonth() + 1) / 3);
        setExpandedYears(prev => ({
          ...prev,
          [year]: true
        }));
        setExpandedQuarters(prev => ({
          ...prev,
          [`${year}-Q${quarter}`]: true
        }));
      }
      // Clear the initialEditWeekId after handling
      if (onEditWeekHandled) onEditWeekHandled();
    }
  }, [initialEditWeekId, weeks, onEditWeekHandled]);

  // Sort modules: first by project (productionOrder, then projectId), then by buildSequence within project
  const sortedModules = [...(allModules || [])].sort((a, b) => {
    // First by production order
    if ((a.projectProductionOrder || 999) !== (b.projectProductionOrder || 999)) {
      return (a.projectProductionOrder || 999) - (b.projectProductionOrder || 999);
    }
    // Then keep projects grouped by projectId
    if (a.projectId !== b.projectId) {
      return (a.projectId || '').localeCompare(b.projectId || '');
    }
    // Then by build sequence within project
    return (a.buildSequence || 0) - (b.buildSequence || 0);
  });
  const getWeekSunday = mondayStr => {
    const monday = parseLocalDate(mondayStr);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);
    return formatLocalDate(sunday);
  };
  const getWeekOptions = () => {
    const options = [];
    const today = new Date();
    const currentMonday = new Date(today);
    const day = currentMonday.getDay();
    currentMonday.setDate(currentMonday.getDate() - day + (day === 0 ? -6 : 1));
    for (let i = -2; i <= 4; i++) {
      const weekMonday = new Date(currentMonday);
      weekMonday.setDate(currentMonday.getDate() + i * 7);
      const weekSunday = new Date(weekMonday);
      weekSunday.setDate(weekMonday.getDate() + 6);
      const label = i === 0 ? 'This Week' : i === 1 ? 'Next Week' : i === -1 ? 'Last Week' : '';
      options.push({
        value: formatLocalDate(weekMonday),
        label: `${weekMonday.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        })} - ${weekSunday.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        })}${label ? ` (${label})` : ''}`,
        isCurrent: i === 0
      });
    }
    return options;
  };
  const resetForm = () => {
    setFormData({
      weekStart: '',
      weekEnd: '',
      productionGoal: 20,
      dailyGoal: 5,
      startingModule: '',
      notes: '',
      shift1: {
        monday: 5,
        tuesday: 5,
        wednesday: 5,
        thursday: 5
      },
      shift2: {
        friday: 0,
        saturday: 0,
        sunday: 0
      }
    });
    setError('');
  };
  const handleOpenAdd = () => {
    resetForm();
    setEditingWeek(null);
    setShowAddWeek(true);
  };
  const handleOpenEdit = week => {
    setFormData({
      weekStart: week.weekStart,
      weekEnd: week.weekEnd,
      productionGoal: week.productionGoal || 20,
      dailyGoal: week.dailyGoal || 5,
      startingModule: week.startingModule || '',
      notes: week.notes || '',
      shift1: week.shift1 || {
        monday: 5,
        tuesday: 5,
        wednesday: 5,
        thursday: 5
      },
      shift2: week.shift2 || {
        friday: 0,
        saturday: 0,
        sunday: 0
      }
    });
    setEditingWeek(week);
    setShowAddWeek(true);
    setError('');
  };
  const handleWeekSelect = weekStartValue => {
    const weekEnd = getWeekSunday(weekStartValue);
    // Use current global schedule as default for new weeks
    setFormData(prev => ({
      ...prev,
      weekStart: weekStartValue,
      weekEnd: weekEnd,
      productionGoal: getLineBalance(),
      shift1: scheduleSetup?.shift1 || prev.shift1,
      shift2: scheduleSetup?.shift2 || prev.shift2
    }));
  };

  // Calculate line balance for form data
  const getFormLineBalance = () => {
    const s1 = formData.shift1 || {};
    const s2 = formData.shift2 || {};
    return (s1.monday || 0) + (s1.tuesday || 0) + (s1.wednesday || 0) + (s1.thursday || 0) + (s2.friday || 0) + (s2.saturday || 0) + (s2.sunday || 0);
  };

  // Update daily target in form
  const updateFormDailyTarget = (shift, day, value) => {
    const numValue = parseInt(value) || 0;
    setFormData(prev => ({
      ...prev,
      [shift]: {
        ...prev[shift],
        [day]: numValue
      }
    }));
  };
  const handleSave = () => {
    if (!formData.weekStart) {
      setError('Please select a week');
      return;
    }
    if (!formData.startingModule) {
      setError('Please select a starting module');
      return;
    }
    const validation = validateWeek?.(formData, editingWeek?.id);
    if (validation && !validation.valid) {
      setError(validation.error);
      return;
    }

    // Calculate and include plannedModules in the saved data
    const plannedModules = getFormLineBalance();
    const dataToSave = {
      ...formData,
      plannedModules
    };
    if (editingWeek) {
      updateWeek?.(editingWeek.id, dataToSave);
    } else {
      addWeek?.(dataToSave);
    }
    setShowAddWeek(false);
    resetForm();
  };
  const handleDelete = weekId => {
    if (confirm('Delete this production week schedule?')) {
      deleteWeek?.(weekId);
    }
  };
  const weekOptions = getWeekOptions();
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, !canEdit && /*#__PURE__*/React.createElement("div", {
    className: "bg-amber-50 border border-amber-200 rounded-lg p-3 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-amber-600 text-xl"
  }, "\uD83D\uDD12"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-amber-800"
  }, "View-Only Mode"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-amber-600"
  }, "Your role does not have permission to modify the schedule setup. Contact an Admin or Production Management to make changes."))), /*#__PURE__*/React.createElement("div", {
    className: `rounded-lg p-2 text-xs font-mono ${window.MODA_SUPABASE_DATA?.isAvailable?.() ? 'bg-green-100 border border-green-300 text-green-800' : 'bg-red-100 border border-red-300 text-red-800'}`
  }, /*#__PURE__*/React.createElement("strong", null, "Sync Status:"), " ", window.MODA_SUPABASE_DATA?.isAvailable?.() ? 'Supabase Connected' : 'localStorage Only', " |", /*#__PURE__*/React.createElement("strong", null, " Shift1 Mon:"), " ", scheduleSetup?.shift1?.monday ?? 'N/A', " |", /*#__PURE__*/React.createElement("strong", null, " User:"), " ", userEmail || 'Not logged in'), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Schedule Setup"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Configure weekly production schedule and starting modules")), /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-teal text-white px-4 py-2 rounded-lg"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm"
  }, "Current Week Balance:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 text-xl font-bold"
  }, currentWeek?.shift1 ? (currentWeek.shift1.monday || 0) + (currentWeek.shift1.tuesday || 0) + (currentWeek.shift1.wednesday || 0) + (currentWeek.shift1.thursday || 0) + (currentWeek.shift2?.friday || 0) + (currentWeek.shift2?.saturday || 0) + (currentWeek.shift2?.sunday || 0) : getLineBalance()), /*#__PURE__*/React.createElement("span", {
    className: "text-sm ml-1"
  }, "modules/week"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white border-2 border-autovol-teal rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-teal text-white px-4 py-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, "Production Week Schedule"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm opacity-75 ml-2"
  }, "Configure starting module for Weekly Board")), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: handleOpenAdd,
    className: "px-3 py-1 bg-white text-autovol-teal rounded font-medium text-sm hover:bg-gray-100"
  }, "+ Add Week")), /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, currentWeek && /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 border border-green-200 rounded-lg p-3 mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-green-700 font-medium"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-3 h-3 bg-green-500 rounded-full animate-pulse"
  }), "Current Week Active"), /*#__PURE__*/React.createElement("div", {
    className: "mt-1 text-sm text-green-600"
  }, currentWeek.weekStart, " to ", currentWeek.weekEnd, " \u2022 Starting: ", /*#__PURE__*/React.createElement("span", {
    className: "font-mono font-bold"
  }, currentWeek.startingModule || 'Not set'))), !weeks || weeks.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-6 text-gray-500 bg-gray-50 rounded-lg"
  }, "No production weeks configured. Click \"+ Add Week\" to create one.") : /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, (() => {
    const grouped = groupWeeksByYearQuarter(weeks);
    const years = Object.keys(grouped).sort((a, b) => b - a); // Descending by year

    return years.map(year => {
      const yearNum = parseInt(year);
      const isYearExpanded = expandedYears[yearNum];
      const quarters = Object.keys(grouped[year]).sort((a, b) => b - a); // Descending by quarter
      const totalWeeksInYear = quarters.reduce((sum, q) => sum + grouped[year][q].length, 0);
      const totalModulesInYear = quarters.reduce((sum, q) => sum + grouped[year][q].reduce((wSum, w) => wSum + (w.plannedModules || 0), 0), 0);
      return /*#__PURE__*/React.createElement("div", {
        key: year,
        className: "border rounded-lg overflow-hidden"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: () => toggleYear(yearNum),
        className: `w-full px-4 py-3 flex items-center justify-between text-left ${yearNum === currentYear ? 'bg-autovol-navy text-white' : 'bg-gray-100 text-gray-800'} hover:opacity-90 transition-opacity`
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-3"
      }, /*#__PURE__*/React.createElement("span", {
        className: `transform transition-transform ${isYearExpanded ? 'rotate-90' : ''}`
      }, "\u25B6"), /*#__PURE__*/React.createElement("span", {
        className: "font-bold text-lg"
      }, year), yearNum === currentYear && /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 bg-green-500 text-white text-xs rounded-full"
      }, "Current Year")), /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-4 text-sm"
      }, /*#__PURE__*/React.createElement("span", null, totalWeeksInYear, " weeks"), /*#__PURE__*/React.createElement("span", {
        className: "font-semibold"
      }, totalModulesInYear.toLocaleString(), " modules planned"))), isYearExpanded && /*#__PURE__*/React.createElement("div", {
        className: "border-t"
      }, quarters.map(quarter => {
        const quarterNum = parseInt(quarter);
        const quarterKey = `${year}-Q${quarter}`;
        const isQuarterExpanded = expandedQuarters[quarterKey];
        const quarterWeeks = grouped[year][quarter];
        const totalModulesInQuarter = quarterWeeks.reduce((sum, w) => sum + (w.plannedModules || 0), 0);
        const quarterLabels = {
          1: 'Q1 (Jan-Mar)',
          2: 'Q2 (Apr-Jun)',
          3: 'Q3 (Jul-Sep)',
          4: 'Q4 (Oct-Dec)'
        };
        const isCurrentQuarterInYear = yearNum === currentYear && quarterNum === currentQuarter;
        return /*#__PURE__*/React.createElement("div", {
          key: quarterKey
        }, /*#__PURE__*/React.createElement("button", {
          onClick: () => toggleQuarter(quarterKey),
          className: `w-full px-6 py-2 flex items-center justify-between text-left border-b ${isCurrentQuarterInYear ? 'bg-green-50' : 'bg-gray-50'} hover:bg-gray-100 transition-colors`
        }, /*#__PURE__*/React.createElement("div", {
          className: "flex items-center gap-2"
        }, /*#__PURE__*/React.createElement("span", {
          className: `transform transition-transform text-xs ${isQuarterExpanded ? 'rotate-90' : ''}`
        }, "\u25B6"), /*#__PURE__*/React.createElement("span", {
          className: "font-semibold text-gray-700"
        }, quarterLabels[quarterNum] || `Q${quarter}`), isCurrentQuarterInYear && /*#__PURE__*/React.createElement("span", {
          className: "px-2 py-0.5 bg-green-500 text-white text-xs rounded-full"
        }, "Current")), /*#__PURE__*/React.createElement("div", {
          className: "flex items-center gap-3 text-sm text-gray-600"
        }, /*#__PURE__*/React.createElement("span", null, quarterWeeks.length, " weeks"), /*#__PURE__*/React.createElement("span", null, totalModulesInQuarter.toLocaleString(), " modules"))), isQuarterExpanded && /*#__PURE__*/React.createElement("div", {
          className: "divide-y"
        }, quarterWeeks.map(week => {
          const isCurrentWeekItem = currentWeek?.id === week.id;
          const isPast = parseLocalDate(week.weekEnd) < new Date();
          const weekShift1 = week.shift1 || {
            monday: 5,
            tuesday: 5,
            wednesday: 5,
            thursday: 5
          };
          const weekShift2 = week.shift2 || {
            friday: 0,
            saturday: 0,
            sunday: 0
          };
          const shift1Total = (weekShift1.monday || 0) + (weekShift1.tuesday || 0) + (weekShift1.wednesday || 0) + (weekShift1.thursday || 0);
          const shift2Total = (weekShift2.friday || 0) + (weekShift2.saturday || 0) + (weekShift2.sunday || 0);
          const weekLineBalance = week.plannedModules || shift1Total + shift2Total;
          return /*#__PURE__*/React.createElement("div", {
            key: week.id,
            className: `px-8 py-2 flex items-center justify-between ${isCurrentWeekItem ? 'bg-green-100' : isPast ? 'bg-gray-50 opacity-70' : 'bg-white'}`
          }, /*#__PURE__*/React.createElement("div", {
            className: "flex items-center gap-3"
          }, /*#__PURE__*/React.createElement("span", {
            className: "font-mono text-sm text-gray-500 w-12"
          }, "W", week.weekNumber || '?'), /*#__PURE__*/React.createElement("span", {
            className: "text-sm text-gray-800"
          }, week.weekStart, " - ", week.weekEnd), isCurrentWeekItem && /*#__PURE__*/React.createElement("span", {
            className: "px-2 py-0.5 bg-green-500 text-white text-xs rounded-full"
          }, "Current"), /*#__PURE__*/React.createElement("span", {
            className: "px-2 py-0.5 bg-autovol-teal text-white text-xs rounded"
          }, weekLineBalance, " modules"), week.startingModule && /*#__PURE__*/React.createElement("span", {
            className: "text-xs text-gray-500"
          }, "Start: ", /*#__PURE__*/React.createElement("span", {
            className: "font-mono"
          }, week.startingModule))), /*#__PURE__*/React.createElement("div", {
            className: "flex gap-1"
          }, onViewWeek && /*#__PURE__*/React.createElement("button", {
            onClick: () => onViewWeek(week.id),
            className: "px-2 py-1 text-xs bg-autovol-teal text-white hover:bg-teal-600 rounded"
          }, "View"), canEdit && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
            onClick: () => handleOpenEdit(week),
            className: "px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded"
          }, "Edit"), /*#__PURE__*/React.createElement("button", {
            onClick: () => handleDelete(week.id),
            className: "px-2 py-1 text-xs bg-red-100 text-red-600 hover:bg-red-200 rounded"
          }, "Delete"))));
        })));
      })));
    });
  })()))), showAddWeek && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-lg w-full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-autovol-navy"
  }, editingWeek ? 'Edit Production Week' : 'Add Production Week'), formData.weekStart && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, (() => {
    const date = parseLocalDate(formData.weekStart);
    return date.toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    });
  })(), formData.weekEnd && ` - ${(() => {
    const date = parseLocalDate(formData.weekEnd);
    return date.toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    });
  })()}`)), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddWeek(false);
      resetForm();
    },
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-4"
  }, error && /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm"
  }, error), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Select Week"), /*#__PURE__*/React.createElement("select", {
    value: formData.weekStart,
    onChange: e => handleWeekSelect(e.target.value),
    className: "w-full border rounded-lg px-3 py-2"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Choose a week..."), weekOptions.map(opt => /*#__PURE__*/React.createElement("option", {
    key: opt.value,
    value: opt.value
  }, opt.label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Starting Module (AUTO-C / AUTO-F / AUTO-W)"), /*#__PURE__*/React.createElement(CollapsibleModuleDropdown, {
    modules: sortedModules,
    value: formData.startingModule,
    onChange: serialNumber => setFormData(prev => ({
      ...prev,
      startingModule: serialNumber
    })),
    placeholder: "Select starting module..."
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "This module will appear at AUTO-C/AUTO-F/AUTO-W. Other stations offset by their stagger.")), /*#__PURE__*/React.createElement("div", {
    className: "border rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-navy text-white px-3 py-2 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-sm"
  }, "Shift #1 (Mon - Thu)"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm bg-white/20 px-2 py-0.5 rounded"
  }, (formData.shift1?.monday || 0) + (formData.shift1?.tuesday || 0) + (formData.shift1?.wednesday || 0) + (formData.shift1?.thursday || 0), " modules")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 grid grid-cols-4 gap-2"
  }, ['monday', 'tuesday', 'wednesday', 'thursday'].map(day => /*#__PURE__*/React.createElement("div", {
    key: day,
    className: "text-center"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-xs font-medium text-gray-600 mb-1"
  }, day.charAt(0).toUpperCase() + day.slice(1, 3)), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "0",
    max: "20",
    value: formData.shift1?.[day] || 0,
    onChange: e => updateFormDailyTarget('shift1', day, e.target.value),
    className: "w-full border rounded px-2 py-1 text-center font-mono text-sm"
  }))))), /*#__PURE__*/React.createElement("div", {
    className: "border rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-600 text-white px-3 py-2 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-sm"
  }, "Shift #2 (Fri - Sun)"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm bg-white/20 px-2 py-0.5 rounded"
  }, (formData.shift2?.friday || 0) + (formData.shift2?.saturday || 0) + (formData.shift2?.sunday || 0), " modules")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 grid grid-cols-3 gap-2"
  }, ['friday', 'saturday', 'sunday'].map(day => /*#__PURE__*/React.createElement("div", {
    key: day,
    className: "text-center"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-xs font-medium text-gray-600 mb-1"
  }, day.charAt(0).toUpperCase() + day.slice(1, 3)), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "0",
    max: "20",
    value: formData.shift2?.[day] || 0,
    onChange: e => updateFormDailyTarget('shift2', day, e.target.value),
    className: "w-full border rounded px-2 py-1 text-center font-mono text-sm"
  }))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-teal/10 border border-autovol-teal rounded-lg p-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-autovol-navy"
  }, "Total Line Balance"), /*#__PURE__*/React.createElement("span", {
    className: "text-xl font-bold text-autovol-teal"
  }, getFormLineBalance(), " modules/week")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Notes (optional)"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData(prev => ({
      ...prev,
      notes: e.target.value
    })),
    className: "w-full border rounded-lg px-3 py-2 h-16",
    placeholder: "Any notes about this week..."
  }))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-end gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddWeek(false);
      resetForm();
    },
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSave,
    className: "px-4 py-2 btn-primary rounded-lg"
  }, editingWeek ? 'Save Changes' : 'Add Week')))), /*#__PURE__*/React.createElement(ScheduledProjectsSection, {
    projects: projects,
    setProjects: setProjects,
    canEdit: canEdit
  }), /*#__PURE__*/React.createElement(PrototypeSchedulingSection, {
    allModules: allModules,
    sortedModules: sortedModules,
    projects: projects,
    setProjects: setProjects,
    onPlaceOnBoard: handlePlaceOnBoard
  }), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Note:"), " Days with '0' modules assigned will not display on the Weekly Board. Configure daily targets when adding or editing a production week above."));
}

// ===== MODULE CARD PROMPT COMPONENT =====
// Reusable prompt that appears when clicking "..." on a module card
// Added: onLogQAInspection for QA role users
function ModuleCardPrompt({
  module,
  station,
  position,
  onClose,
  onViewDetails,
  onReportIssue,
  onShopDrawing,
  onMoveModule,
  onLogQAInspection,
  userRole
}) {
// [Removed duplicate React destructuring]
  const promptRef = useRef(null);

  // Check if user has QA role (qa or admin)
  // userRole is an object with .id property (e.g., { id: 'qa', name: 'QA', ... })
  const roleId = userRole?.id || userRole;
  const isQARole = roleId === 'qa' || roleId === 'admin';

  // Close when clicking outside or pressing Escape
  useEffect(() => {
    const handleClickOutside = e => {
      if (promptRef.current && !promptRef.current.contains(e.target)) {
        onClose();
      }
    };
    const handleEscapeKey = e => {
      if (e.key === 'Escape') {
        onClose();
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    document.addEventListener('keydown', handleEscapeKey);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
      document.removeEventListener('keydown', handleEscapeKey);
    };
  }, [onClose]);
  return /*#__PURE__*/React.createElement("div", {
    ref: promptRef,
    className: "fixed z-[100] bg-white rounded-xl shadow-2xl border border-gray-200 py-2 min-w-[180px]",
    style: {
      top: position.top,
      left: position.left,
      transform: 'translateX(-100%)'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onViewDetails(module);
      onClose();
    },
    className: "w-full px-4 py-2.5 text-left text-sm hover:bg-gray-100 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDCCB"), " View Module Details"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onReportIssue(module, station);
      onClose();
    },
    className: "w-full px-4 py-2.5 text-left text-sm hover:bg-gray-100 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", null, "\u26A0\uFE0F"), " Report Issue"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onShopDrawing(module);
      onClose();
    },
    className: "w-full px-4 py-2.5 text-left text-sm hover:bg-gray-100 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDCD0"), " Shop Drawing"), isQARole && onLogQAInspection && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "border-t my-1"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onLogQAInspection(module, station);
      onClose();
    },
    className: "w-full px-4 py-2.5 text-left text-sm hover:bg-teal-50 flex items-center gap-3 text-teal-700"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-qa",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), " Log QA Inspection")), onMoveModule && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "border-t my-1"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onMoveModule(module);
    },
    className: "w-full px-4 py-2.5 text-left text-sm hover:bg-blue-50 flex items-center gap-3 text-blue-700"
  }, /*#__PURE__*/React.createElement("span", null, "\u2195\uFE0F"), " Move in Schedule")));
}

// ===== MODULE DETAILS TABLE COMPONENT =====
// Reusable read-only table showing module details (same data as Project->Modules)
function ModuleDetailsTable({
  module,
  onClose
}) {
  if (!module) return null;
  const specs = module.specs || {};
  const difficulties = specs.difficulties || {};
  const stageProgress = module.stageProgress || {};
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b sticky top-0 bg-white z-10 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-autovol-navy"
  }, "Module Details"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, module.serialNumber, " \u2022 ", module.projectName || 'Unknown Project')), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm mb-6"
  }, /*#__PURE__*/React.createElement("tbody", null, /*#__PURE__*/React.createElement("tr", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600 w-1/4"
  }, "Serial Number"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-mono"
  }, module.serialNumber), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600 w-1/4"
  }, "Build Sequence"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, "#", module.buildSequence)), /*#__PURE__*/React.createElement("tr", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "BLM Hitch"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-mono"
  }, specs.blmHitch || '—'), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "BLM Rear"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-mono"
  }, specs.blmRear || '—')), /*#__PURE__*/React.createElement("tr", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "Unit Type"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, specs.unit || '—'), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "Dimensions"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, specs.width && specs.length ? `${specs.width}' x ${specs.length}'` : '—')), /*#__PURE__*/React.createElement("tr", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "Project"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, module.projectName || '—'), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-medium text-gray-600"
  }, "Status"), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-0.5 rounded text-xs ${module.status === 'complete' ? 'bg-green-100 text-green-700' : module.status === 'in-progress' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}`
  }, module.status || 'Pending'))))), Object.values(difficulties).some(v => v) && /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "Difficulties"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, difficulties.sidewall && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs"
  }, "Sidewall"), difficulties.stair && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs"
  }, "Stair"), difficulties.hr3Wall && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-red-100 text-red-700 rounded text-xs"
  }, "3HR Wall"), difficulties.short && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"
  }, "Short"), difficulties.doubleStudio && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-green-100 text-green-700 rounded text-xs"
  }, "Double Studio"), difficulties.sawbox && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs"
  }, "Sawbox"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "Station Progress"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2"
  }, Object.entries(stageProgress).map(([stationId, progress]) => /*#__PURE__*/React.createElement("div", {
    key: stationId,
    className: "text-center p-2 bg-gray-50 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 truncate"
  }, stationId), /*#__PURE__*/React.createElement("div", {
    className: `font-bold ${progress === 100 ? 'text-green-600' : progress > 0 ? 'text-blue-600' : 'text-gray-400'}`
  }, progress, "%"))))))));
}

// ===== STATION CAPACITY CONFIG =====
// Default capacity per station (modules that can be worked on simultaneously)
const DEFAULT_STATION_CAPACITY = 5;

// ===== WEEKLY BOARD SUB-TAB COMPONENT =====
function WeeklyBoardTab({
  projects,
  productionStages,
  staggerConfig,
  currentWeek,
  weeks = [],
  // All available weeks for selector
  scheduleSetup,
  getLineBalance,
  completedWeeks,
  completeWeek,
  addWeek,
  // For auto-creating next week
  onModuleClick,
  setProductionTab,
  setProjects,
  // For updating module progress
  onReportIssue,
  // For opening report issue modal
  canEdit = true,
  // Tab-specific edit permission (false = view-only mode)
  stationCapacities = {},
  // Optional: custom capacities per station { stationId: number }
  userRole = null,
  // User's dashboard role (e.g., 'qa', 'admin')
  onLogQAInspection = null,
  // Callback for QA inspection (module, station) => void
  initialSelectedWeekId = null,
  // Initial week to display (from Schedule Setup navigation)
  onWeekSelected = null,
  // Callback when week is selected (to clear initialSelectedWeekId)
  onEditWeek = null,
  // Callback to edit a week in Schedule Setup: (weekId) => void
  isPopout = false,
  // Whether this is rendered in a pop-out window
  // Prototype placement props
  prototypePlacementMode = null,
  // { prototype: module } when placing a prototype
  onCancelPlacement = null,
  // Callback to cancel placement mode
  onPlacePrototype = null // Callback when prototype is placed: (prototype, afterModule) => void
}) {
// [Removed duplicate React destructuring]
  // Mobile detection
  const isMobile = window.useIsMobile ? window.useIsMobile(768) : false;

  // Check if a feature should be hidden on mobile
  const isFeatureHiddenOnMobile = featureId => {
    return isMobile && window.MODA_MOBILE_CONFIG?.isFeatureHidden('production', featureId);
  };
  const [showCompleteModal, setShowCompleteModal] = useState(false);
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [activePrompt, setActivePrompt] = useState(null); // { module, station, position }

  // ===== WEEK SELECTOR =====
  // selectedWeekId: null means "use currentWeek (auto)", otherwise use specific week
  // For popout: read initial week from localStorage if available
  const getInitialWeekId = () => {
    if (initialSelectedWeekId) return initialSelectedWeekId;
    if (isPopout) {
      try {
        const saved = localStorage.getItem('autovol_selected_week_id');
        if (saved && saved !== 'null') {
          console.log('[WeeklyBoard] Popout reading selected week from localStorage:', saved);
          return saved;
        }
      } catch (e) {}
    }
    return null;
  };
  const [selectedWeekId, setSelectedWeekId] = useState(getInitialWeekId);
  const [showWeekPicker, setShowWeekPicker] = useState(false);

  // Handle initialSelectedWeekId from Schedule Setup navigation
  useEffect(() => {
    if (initialSelectedWeekId) {
      setSelectedWeekId(initialSelectedWeekId);
      // Clear the initial selection after applying it
      if (onWeekSelected) onWeekSelected();
    }
  }, [initialSelectedWeekId, onWeekSelected]);

  // Save selected week to localStorage when it changes (for popout sync)
  useEffect(() => {
    if (!isPopout) {
      try {
        localStorage.setItem('autovol_selected_week_id', selectedWeekId || '');
        console.log('[WeeklyBoard] Saved selected week to localStorage:', selectedWeekId);
      } catch (e) {}
    }
  }, [selectedWeekId, isPopout]);

  // Determine which week to display
  const displayWeek = useMemo(() => {
    if (selectedWeekId) {
      return weeks.find(w => w.id === selectedWeekId) || currentWeek;
    }
    return currentWeek;
  }, [selectedWeekId, weeks, currentWeek]);

  // ===== TOAST NOTIFICATION SYSTEM =====
  const [toasts, setToasts] = useState([]); // Array of { id, message, type, moduleSerial, stationName }

  // Add a toast notification
  const addToast = useCallback((message, type = 'success', moduleSerial = '', stationName = '') => {
    const id = Date.now();
    setToasts(prev => [...prev, {
      id,
      message,
      type,
      moduleSerial,
      stationName
    }]);

    // Auto-dismiss after 4 seconds
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, 4000);
  }, []);

  // Remove a toast manually
  const removeToast = useCallback(id => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  // ===== MODULE REORDERING SYSTEM =====
  const [showMoveModal, setShowMoveModal] = useState(null); // { module, currentPosition }
  const [showMoveConfirm, setShowMoveConfirm] = useState(null); // { module, fromPosition, toPosition, applyToAll }
  const [showSequenceHistory, setShowSequenceHistory] = useState(null); // { projectId, projectName, modules }

  // ===== REORDER MODE (Drag-and-Drop) =====
  const [reorderMode, setReorderMode] = useState(false);
  const [pendingReorders, setPendingReorders] = useState([]); // Array of { moduleId, fromSeq, toSeq }
  const [draggedModule, setDraggedModule] = useState(null);
  const [dragOverTarget, setDragOverTarget] = useState(null); // { moduleId, position: 'before' | 'after' }
  const [showReorderConfirm, setShowReorderConfirm] = useState(false);

  // ===== PROTOTYPE PLACEMENT MODE =====
  const [placementTarget, setPlacementTarget] = useState(null); // { moduleId, position: 'before' | 'after' }
  const [localPlacementMode, setLocalPlacementMode] = useState(null); // Prototype module being placed (from localStorage)

  // Check localStorage for prototype placement on mount
  useEffect(() => {
    try {
      const saved = localStorage.getItem('moda_prototype_placement');
      if (saved) {
        const prototype = JSON.parse(saved);
        setLocalPlacementMode(prototype);
        // Clear localStorage after reading
        localStorage.removeItem('moda_prototype_placement');
        console.log('[WeeklyBoard] Entering placement mode for prototype:', prototype.serialNumber);
      }
    } catch (e) {
      console.error('[WeeklyBoard] Error reading prototype placement from localStorage:', e);
    }
  }, []);

  // Use either prop-based or localStorage-based placement mode
  const activePlacementMode = prototypePlacementMode || localPlacementMode;

  // Cancel placement mode handler
  const handleCancelPlacement = useCallback(() => {
    setLocalPlacementMode(null);
    setPlacementTarget(null);
    if (onCancelPlacement) onCancelPlacement();
  }, [onCancelPlacement]);

  // Handle prototype placement - insert after target module
  const handlePlacePrototypeLocal = useCallback((prototype, afterModule, position) => {
    console.log('[WeeklyBoard] handlePlacePrototypeLocal called:', {
      prototype: prototype.serialNumber,
      afterModule: afterModule.serialNumber,
      position,
      hasSetProjects: !!setProjects
    });
    if (!setProjects || !prototype) return;

    // Calculate the new decimal build sequence
    const afterSeq = afterModule.buildSequence || 0;
    const baseSeq = position === 'before' ? Math.floor(afterSeq) - 1 : Math.floor(afterSeq);

    // Find existing decimals in this range to avoid conflicts
    const allModules = (projects || []).flatMap(p => p.modules || []);
    const existingDecimals = allModules.filter(m => m.buildSequence > baseSeq && m.buildSequence < baseSeq + 1).map(m => m.buildSequence);
    let newBuildSeq;
    if (position === 'before') {
      // Insert before: use afterSeq - 0.1 or find available slot
      newBuildSeq = existingDecimals.length === 0 ? afterSeq - 0.1 : Math.min(...existingDecimals) - 0.1;
    } else {
      // Insert after: use afterSeq + 0.1 or next available
      newBuildSeq = existingDecimals.length === 0 ? afterSeq + 0.1 : Math.max(...existingDecimals) + 0.1;
    }
    newBuildSeq = Math.round(newBuildSeq * 100) / 100; // Round to 2 decimals

    // Update the prototype module with new build sequence
    console.log('[WeeklyBoard] Updating prototype with:', {
      newBuildSeq,
      insertedAfter: afterModule.serialNumber,
      prototypeProjectId: prototype.projectId
    });
    setProjects(prev => {
      const targetProject = prev.find(p => p.id === prototype.projectId);
      console.log('[WeeklyBoard] Found target project:', targetProject?.name, 'with', targetProject?.modules?.length, 'modules');
      const updated = prev.map(project => {
        if (project.id !== prototype.projectId) return project;
        return {
          ...project,
          modules: (project.modules || []).map(m => {
            if (m.id !== prototype.id) return m;
            const originalSeq = m.originalBuildSequence || m.buildSequence;
            console.log('[WeeklyBoard] Updating module:', m.serialNumber, 'insertedAfter:', afterModule.serialNumber);
            return {
              ...m,
              buildSequence: newBuildSeq,
              insertedAfter: afterModule.serialNumber,
              originalBuildSequence: originalSeq
            };
          })
        };
      });
      return updated;
    });

    // Exit placement mode
    setLocalPlacementMode(null);
    setPlacementTarget(null);
    addToast(`Prototype ${prototype.serialNumber} placed after ${afterModule.serialNumber} (Seq: ${newBuildSeq})`, 'success');
  }, [projects, setProjects, addToast]);

  // ===== PDF EXPORT =====
  const [showPDFExport, setShowPDFExport] = useState(false);
  const [pdfExportScope, setPdfExportScope] = useState('current'); // 'current', 'all', 'with-prev', 'with-next'

  // ===== BOARD VIEW MODE =====
  // 'compact' = serial number only (original), 'detailed' = full module info like Modules On-Board panel
  const [boardViewMode, setBoardViewMode] = useState('compact');

  // ===== SELECTION SYSTEM =====
  const [selectedModules, setSelectedModules] = useState(new Set()); // Set of "moduleId-stationId" keys
  const [showBulkMenu, setShowBulkMenu] = useState(null); // { x, y } position for context menu
  const [focusedCell, setFocusedCell] = useState(null); // { moduleId, stationId, rowIndex, colIndex } for keyboard nav
  const boardRef = useRef(null);
  const longPressTimer = useRef(null);

  // Generate unique key for module-station combination (use | as separator since IDs may contain dashes)
  const getSelectionKey = (moduleId, stationId) => `${moduleId}|${stationId}`;

  // Check if a module-station is selected
  const isSelected = (moduleId, stationId) => selectedModules.has(getSelectionKey(moduleId, stationId));

  // Toggle selection for a module
  const toggleSelection = (moduleId, stationId, isCtrlKey = false) => {
    const key = getSelectionKey(moduleId, stationId);
    setSelectedModules(prev => {
      const newSet = new Set(isCtrlKey ? prev : []);
      if (prev.has(key) && isCtrlKey) {
        newSet.delete(key);
      } else {
        newSet.add(key);
      }
      return newSet;
    });
  };

  // Clear all selections
  const clearSelection = useCallback(() => {
    setSelectedModules(new Set());
    setShowBulkMenu(null);
    setFocusedCell(null);
  }, []);

  // Handle Escape key to clear selection
  useEffect(() => {
    const handleKeyDown = e => {
      if (e.key === 'Escape' && selectedModules.size > 0) {
        clearSelection();
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [selectedModules.size, clearSelection]);

  // Handle click outside to clear selection
  const handleBoardClick = e => {
    // Only clear if clicking directly on the board background, not on cards
    if (e.target === e.currentTarget || e.target.closest('[data-board-background]')) {
      clearSelection();
    }
  };

  // Handle right-click for bulk menu
  const handleContextMenu = (e, moduleId, stationId) => {
    e.preventDefault();
    e.stopPropagation();

    // If right-clicking on unselected module, select it first
    if (!isSelected(moduleId, stationId)) {
      toggleSelection(moduleId, stationId, e.ctrlKey || e.metaKey);
    }
    setShowBulkMenu({
      x: e.clientX,
      y: e.clientY
    });
  };

  // Bulk update progress for all selected modules
  const bulkUpdateProgress = newProgress => {
    if (!setProjects || selectedModules.size === 0) return;

    // Parse selection keys to get moduleId and stationId (using | separator)
    const updates = Array.from(selectedModules).map(key => {
      const separatorIdx = key.indexOf('|');
      const moduleId = key.substring(0, separatorIdx);
      const stationId = key.substring(separatorIdx + 1);
      return {
        moduleId,
        stationId
      };
    });

    // Find which project each module belongs to
    // Note: Convert IDs to strings for comparison since selection keys are strings
    setProjects(prevProjects => prevProjects.map(project => {
      const projectModuleIds = (project.modules || []).map(m => String(m.id));
      const relevantUpdates = updates.filter(u => projectModuleIds.includes(String(u.moduleId)));
      if (relevantUpdates.length === 0) return project;
      return {
        ...project,
        modules: project.modules.map(module => {
          const moduleUpdates = relevantUpdates.filter(u => String(u.moduleId) === String(module.id));
          if (moduleUpdates.length === 0) return module;
          const updatedProgress = {
            ...module.stageProgress
          };
          let stationCompletedAt = {
            ...module.stationCompletedAt
          } || {};
          moduleUpdates.forEach(({
            stationId
          }) => {
            const wasComplete = updatedProgress[stationId] === 100;
            updatedProgress[stationId] = newProgress;
            if (newProgress === 100 && !wasComplete) {
              stationCompletedAt[stationId] = Date.now();
            } else if (newProgress < 100 && wasComplete) {
              delete stationCompletedAt[stationId];
            }
          });
          return {
            ...module,
            stageProgress: updatedProgress,
            stationCompletedAt
          };
        })
      };
    }));
    clearSelection();
  };

  // Long press handler for mobile
  const handleTouchStart = (moduleId, stationId) => {
    longPressTimer.current = setTimeout(() => {
      toggleSelection(moduleId, stationId, true);
    }, 500); // 500ms long press
  };
  const handleTouchEnd = () => {
    if (longPressTimer.current) {
      clearTimeout(longPressTimer.current);
      longPressTimer.current = null;
    }
  };

  // Get all active projects
  const activeProjects = projects.filter(p => p.status === 'Active');

  // Debug: Log active projects
  console.log('[WeeklyBoard] Active projects:', activeProjects.map(p => ({
    name: p.name,
    status: p.status,
    productionOrder: p.productionOrder,
    moduleCount: p.modules?.length
  })));

  // Get line balance for current display
  // Use the displayed week's plannedModules if available, otherwise fall back to global getLineBalance()
  const lineBalance = displayWeek?.plannedModules || getLineBalance();

  // Get all modules from all active projects, sorted by productionOrder then buildSequence
  // Filter out modules with excludeFromSchedule flag
  // IMPORTANT: Projects are kept grouped together - buildSequence is project-specific, not global
  // EXCEPTION: Scheduled prototypes (with insertedAfter) are sorted by their decimal buildSequence globally
  const allModules = (() => {
    // Get regular modules from active projects only
    const rawModules = activeProjects.sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999)).flatMap(p => (p.modules || []).filter(m => !m.excludeFromSchedule).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name,
      projectAbbreviation: p.abbreviation,
      projectProductionOrder: p.productionOrder || 999
    })));

    // Get scheduled prototypes from ALL projects (not just active)
    // This allows prototypes from non-active projects to appear on the board
    const allScheduledPrototypes = (projects || []).flatMap(p => (p.modules || []).filter(m => m.isPrototype && m.insertedAfter).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name,
      projectAbbreviation: p.abbreviation,
      projectProductionOrder: p.productionOrder || 999
    })));
    console.log('[WeeklyBoard] Found scheduled prototypes from all projects:', allScheduledPrototypes.map(p => `${p.serialNumber} after ${p.insertedAfter}`));

    // Regular modules exclude prototypes with insertedAfter (they'll be added separately)
    const regularModules = rawModules.filter(m => !(m.isPrototype && m.insertedAfter));
    const scheduledPrototypes = allScheduledPrototypes;

    // Sort regular modules by project grouping
    const sortedRegular = regularModules.sort((a, b) => {
      // First sort by project production order
      if (a.projectProductionOrder !== b.projectProductionOrder) {
        return a.projectProductionOrder - b.projectProductionOrder;
      }
      // If same production order, keep projects grouped by projectId
      if (a.projectId !== b.projectId) {
        return a.projectId.localeCompare(b.projectId);
      }
      // Then by build sequence within project
      return (a.buildSequence || 0) - (b.buildSequence || 0);
    });

    // Insert scheduled prototypes at their correct positions
    // Use the insertedAfter field to find the target module, then insert right after it
    const result = [...sortedRegular];

    // Sort prototypes by their buildSequence to insert them in order
    const sortedPrototypes = [...scheduledPrototypes].sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
    sortedPrototypes.forEach(proto => {
      // Find the module this prototype was inserted after using serialNumber
      let insertIdx = -1;
      if (proto.insertedAfter) {
        // Find the target module by serial number
        const targetIdx = result.findIndex(m => m.serialNumber === proto.insertedAfter);
        if (targetIdx !== -1) {
          // Insert right after the target module
          insertIdx = targetIdx + 1;
        }
      }

      // Fallback: if insertedAfter not found, try to find position by buildSequence
      if (insertIdx === -1) {
        insertIdx = result.findIndex(m => (m.buildSequence || 0) > proto.buildSequence);
        if (insertIdx === -1) insertIdx = result.length;
      }
      result.splice(insertIdx, 0, proto);
    });
    return result;
  })();

  // Debug: Log module count and scheduled prototypes
  const scheduledProtos = allModules.filter(m => m.isPrototype && m.insertedAfter);
  console.log('[WeeklyBoard] allModules count:', allModules.length, 'scheduledPrototypes:', scheduledProtos.map(p => `${p.serialNumber} after ${p.insertedAfter}`));

  // Auto-calculate starting module index for the current week
  // Based on cumulative line balance from all previous weeks
  const getAutoCalculatedStartingIndex = useMemo(() => {
    if (!displayWeek || !weeks || weeks.length === 0) return 0;

    // Sort weeks by date
    const sortedWeeks = [...weeks].sort((a, b) => parseLocalDate(a.weekStart) - parseLocalDate(b.weekStart));

    // Find index of current display week
    const currentWeekIdx = sortedWeeks.findIndex(w => w.id === displayWeek.id);
    if (currentWeekIdx === -1) return 0;

    // Sum up line balance from all previous weeks
    let cumulativeModules = 0;
    for (let i = 0; i < currentWeekIdx; i++) {
      const week = sortedWeeks[i];
      const weekBalance = (week.shift1?.monday || 0) + (week.shift1?.tuesday || 0) + (week.shift1?.wednesday || 0) + (week.shift1?.thursday || 0) + (week.shift2?.friday || 0) + (week.shift2?.saturday || 0) + (week.shift2?.sunday || 0);
      cumulativeModules += weekBalance || week.line_balance || 0;
    }
    return cumulativeModules;
  }, [displayWeek, weeks]);

  // Get the auto-calculated starting module for the current week
  const autoStartingModule = allModules[getAutoCalculatedStartingIndex] || null;

  // Check if we have modules to display
  const hasWeekConfig = displayWeek && allModules.length > 0;

  // Get starting module for a station based on stagger
  // Stagger is subtracted because downstream stations work on earlier modules
  // (modules that have already passed through upstream stations)
  const getStationStartingModule = stationId => {
    // Use auto-calculated starting module if no manual override
    const weekStartingModule = displayWeek?.startingModule ? allModules.find(m => m.serialNumber === displayWeek.startingModule) : autoStartingModule;
    if (!weekStartingModule) return null;
    const stagger = staggerConfig?.[stationId] || 0;
    const startIdx = allModules.findIndex(m => m.id === weekStartingModule.id);
    if (startIdx === -1) return null;

    // Apply stagger - downstream stations work on modules earlier in the sequence
    // A stagger of 5 means this station shows modules 5 positions behind Automation
    // (they've already passed through upstream stations)
    const staggeredIdx = Math.max(0, startIdx - stagger);
    return allModules[staggeredIdx] || null;
  };

  // Get modules for a station column based on stagger and line balance
  // Now includes previous week (5 before) and next week preview (5 after)
  const getModulesForStation = station => {
    const startingModule = getStationStartingModule(station.id);
    if (!startingModule) return {
      previous: [],
      current: [],
      next: []
    };

    // Use the displayed week's plannedModules if available
    const weekLineBalance = displayWeek?.plannedModules || getLineBalance();

    // Find the starting module index - try by ID first, then by serial number
    let startIdx = allModules.findIndex(m => m.id === startingModule.id);
    if (startIdx === -1) {
      startIdx = allModules.findIndex(m => m.serialNumber === startingModule.serialNumber);
    }
    if (startIdx === -1) return {
      previous: [],
      current: [],
      next: []
    };

    // Helper to add status info to modules
    const addStatusInfo = (modules, weekSection) => {
      return modules.map(module => {
        const progress = module.stageProgress || {};
        const stationProgress = progress[station.id] || 0;
        let status = 'pending';
        if (stationProgress === 100) status = 'complete';else if (stationProgress > 0) status = 'in-progress';
        return {
          ...module,
          stationProgress,
          status,
          weekSection
        };
      });
    };

    // Previous week: 5 modules before starting module (or fewer if at beginning)
    const prevCount = Math.min(5, startIdx); // Can't go negative
    const prevStartIdx = startIdx - prevCount;
    const previousModules = allModules.slice(prevStartIdx, startIdx);

    // Current week: line balance modules (use weekLineBalance from displayed week)
    const currentModules = allModules.slice(startIdx, startIdx + weekLineBalance);

    // Next week preview: 5 modules after current week (or fewer if at end)
    const nextStartIdx = startIdx + weekLineBalance;
    const nextModules = allModules.slice(nextStartIdx, nextStartIdx + 5);
    return {
      previous: addStatusInfo(previousModules, 'previous'),
      current: addStatusInfo(currentModules, 'current'),
      next: addStatusInfo(nextModules, 'next')
    };
  };

  // ===== STATION CAPACITY CALCULATION =====
  // Calculate current load and capacity status for each station
  const getStationCapacityInfo = useMemo(() => {
    const capacityInfo = {};
    productionStages.forEach(station => {
      const capacity = stationCapacities[station.id] || DEFAULT_STATION_CAPACITY;
      const {
        current
      } = getModulesForStation(station);

      // Count modules that are in-progress (not complete, not pending)
      const inProgress = current.filter(m => m.status === 'in-progress').length;
      const pending = current.filter(m => m.status === 'pending').length;
      const complete = current.filter(m => m.status === 'complete').length;
      const total = current.length;

      // Calculate load percentage (in-progress + pending that should be started)
      const activeLoad = inProgress + Math.min(pending, capacity - inProgress);
      const loadPercent = Math.round(activeLoad / capacity * 100);

      // Determine status: green (under), yellow (at), red (over)
      let status = 'under';
      if (activeLoad >= capacity) status = 'at';
      if (activeLoad > capacity) status = 'over';
      capacityInfo[station.id] = {
        capacity,
        inProgress,
        pending,
        complete,
        total,
        activeLoad,
        loadPercent: Math.min(loadPercent, 100),
        // Cap at 100 for display
        actualPercent: loadPercent,
        // Keep actual for warnings
        status
      };
    });
    return capacityInfo;
  }, [productionStages, stationCapacities, allModules, displayWeek]);

  // Get the last working day date for previous week label
  const getPreviousWeekLastDay = () => {
    if (!displayWeek?.weekStart) return null;
    const weekStart = parseLocalDate(displayWeek.weekStart);
    // Go back to previous Thursday (last working day of previous week)
    const prevThursday = new Date(weekStart);
    prevThursday.setDate(weekStart.getDate() - 4); // Monday - 4 = Thursday of prev week
    return prevThursday;
  };

  // Get recently completed modules (modules that are 100% at ALL stations)
  const getRecentlyCompleted = () => {
    // Filter modules that have 100% progress at ALL production stages
    const fullyCompleted = allModules.filter(module => {
      const progress = module.stageProgress || {};
      // Check if every station has 100% progress
      return productionStages.every(station => progress[station.id] === 100);
    });

    // Sort by the most recent station completion timestamp
    return fullyCompleted.map(module => {
      // Get the latest completion timestamp across all stations
      const completedAt = module.stationCompletedAt ? Math.max(...Object.values(module.stationCompletedAt)) : 0;
      return {
        ...module,
        completedAt
      };
    }).sort((a, b) => b.completedAt - a.completedAt).slice(0, 5);
  };

  // Get all modules currently on the board (previous + current + upcoming)
  const getModulesOnBoard = useMemo(() => {
    if (!hasWeekConfig) return [];
    const firstStation = productionStages[0];
    if (!firstStation) return [];
    const {
      previous,
      current,
      next
    } = getModulesForStation(firstStation);

    // Combine all modules with their section info
    const allOnBoard = [...previous.map(m => ({
      ...m,
      section: 'previous'
    })), ...current.map(m => ({
      ...m,
      section: 'current'
    })), ...next.map(m => ({
      ...m,
      section: 'next'
    }))];
    return allOnBoard;
  }, [hasWeekConfig, productionStages, allModules, displayWeek, staggerConfig, lineBalance]);

  // Difficulty indicator colors
  const difficultyColors = {
    sidewall: '#f97316',
    // orange
    stair: '#8b5cf6',
    // purple
    hr3Wall: '#ef4444',
    // red
    short: '#eab308',
    // yellow
    doubleStudio: '#6366f1',
    // indigo
    sawbox: '#ec4899' // pink
  };
  const difficultyLabels = {
    sidewall: 'SW',
    stair: 'STAIR',
    hr3Wall: '3HR',
    short: 'SHORT',
    doubleStudio: 'DBL',
    sawbox: 'SAW'
  };

  // Update module progress for a specific station (works across all projects)
  const updateModuleProgress = (moduleId, projectId, stationId, newProgress) => {
    if (!setProjects) return;

    // Find module info for toast before updating
    const project = projects.find(p => p.id === projectId);
    const module = project?.modules?.find(m => m.id === moduleId);
    const station = productionStages.find(s => s.id === stationId);
    const wasComplete = module?.stageProgress?.[stationId] === 100;
    setProjects(prevProjects => prevProjects.map(proj => {
      if (proj.id !== projectId) return proj;
      return {
        ...proj,
        modules: proj.modules.map(mod => {
          if (mod.id !== moduleId) return mod;
          const updatedProgress = {
            ...mod.stageProgress
          };
          updatedProgress[stationId] = newProgress;

          // Track completion timestamps per station
          let stationCompletedAt = mod.stationCompletedAt || {};
          if (newProgress === 100 && !wasComplete) {
            stationCompletedAt = {
              ...stationCompletedAt,
              [stationId]: Date.now()
            };
          } else if (newProgress < 100 && wasComplete) {
            stationCompletedAt = {
              ...stationCompletedAt
            };
            delete stationCompletedAt[stationId];
          }
          return {
            ...mod,
            stageProgress: updatedProgress,
            stationCompletedAt
          };
        })
      };
    }));

    // Toast notifications for completions disabled for now
    // if (newProgress === 100 && !wasComplete && module && station) {
    //     addToast(
    //         `${module.serialNumber} completed at ${station.dept}!`,
    //         'success',
    //         module.serialNumber,
    //         station.dept
    //     );
    // }
  };

  // ===== MODULE MOVE FUNCTIONS =====
  // Open move modal for a module
  const openMoveModal = module => {
    setShowMoveModal({
      module,
      currentPosition: module.buildSequence || 0
    });
    setActivePrompt(null); // Close the context menu
  };

  // Apply module move with confirmation
  // Now requires explicit confirmation before renumbering sequences
  const applyModuleMove = async (module, newPosition, applyToAll = true, skipHistory = false) => {
    if (!setProjects) return;
    const oldPosition = module.buildSequence || 0;
    const project = projects.find(p => p.id === module.projectId);

    // Save snapshot BEFORE making changes (unless skipping)
    if (!skipHistory && project && window.MODA_SEQUENCE_HISTORY?.saveSnapshot) {
      await window.MODA_SEQUENCE_HISTORY.saveSnapshot(project.id, project.modules || [], 'reorder', `Moved ${module.serialNumber} from #${oldPosition} to #${newPosition}`, auth?.currentUser);
    }

    // Update the module's build sequence
    setProjects(prevProjects => prevProjects.map(proj => {
      if (proj.id !== module.projectId) return proj;

      // Get all modules sorted by current sequence
      const modules = [...(proj.modules || [])];
      const moduleIndex = modules.findIndex(m => m.id === module.id);
      if (moduleIndex === -1) return proj;

      // Remove the module from its current position
      const [movedModule] = modules.splice(moduleIndex, 1);

      // Find the new index based on the target position
      let newIndex = modules.findIndex(m => (m.buildSequence || 0) >= newPosition);
      if (newIndex === -1) newIndex = modules.length;

      // Insert at new position
      modules.splice(newIndex, 0, {
        ...movedModule,
        buildSequence: newPosition
      });

      // If applying to all, recalculate all build sequences to be sequential
      if (applyToAll) {
        modules.forEach((m, idx) => {
          m.buildSequence = idx + 1;
        });
      }
      return {
        ...proj,
        modules
      };
    }));

    // Show success toast
    addToast(`${module.serialNumber} moved from #${oldPosition} to #${newPosition}`, 'success', module.serialNumber, applyToAll ? 'Sequences renumbered' : 'Position updated');
    setShowMoveModal(null);
    setShowMoveConfirm(null);
  };

  // ===== DRAG-AND-DROP HANDLERS =====
  const handleDragStart = (e, module) => {
    if (!reorderMode) return;
    setDraggedModule(module);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', module.id);
    // Add visual feedback
    e.target.style.opacity = '0.5';
  };
  const handleDragEnd = e => {
    e.target.style.opacity = '1';
    setDraggedModule(null);
    setDragOverTarget(null);
  };
  const handleDragOver = (e, targetModule) => {
    if (!reorderMode || !draggedModule || draggedModule.id === targetModule.id) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    // Determine if dropping before or after based on mouse position
    const rect = e.currentTarget.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    const position = e.clientY < midY ? 'before' : 'after';
    setDragOverTarget({
      moduleId: targetModule.id,
      position
    });
  };
  const handleDragLeave = () => {
    setDragOverTarget(null);
  };
  const handleDrop = (e, targetModule) => {
    e.preventDefault();
    if (!reorderMode || !draggedModule || draggedModule.id === targetModule.id) return;
    const fromSeq = draggedModule.buildSequence || 0;
    const targetSeq = targetModule.buildSequence || 0;
    const position = dragOverTarget?.position || 'after';
    const toSeq = position === 'before' ? targetSeq : targetSeq + 0.5;

    // Add to pending reorders
    setPendingReorders(prev => {
      // Remove any existing reorder for this module
      const filtered = prev.filter(r => r.moduleId !== draggedModule.id);
      return [...filtered, {
        moduleId: draggedModule.id,
        moduleSerial: draggedModule.serialNumber,
        fromSeq,
        toSeq,
        targetSerial: targetModule.serialNumber,
        position
      }];
    });
    setDraggedModule(null);
    setDragOverTarget(null);
  };

  // Apply all pending reorders
  // Now saves sequence history before applying changes
  const applyPendingReorders = async (applyToAll = true) => {
    if (!setProjects || pendingReorders.length === 0) return;

    // Find affected projects and save snapshots BEFORE changes
    const affectedProjectIds = new Set();
    pendingReorders.forEach(r => {
      const project = projects.find(p => p.modules?.some(m => m.id === r.moduleId));
      if (project) affectedProjectIds.add(project.id);
    });

    // Save snapshots for each affected project
    if (window.MODA_SEQUENCE_HISTORY?.saveSnapshot) {
      for (const projectId of affectedProjectIds) {
        const project = projects.find(p => p.id === projectId);
        if (project) {
          const reorderDescriptions = pendingReorders.filter(r => project.modules?.some(m => m.id === r.moduleId)).map(r => `${r.moduleSerial}: #${r.fromSeq} → #${Math.floor(r.toSeq)}`).join(', ');
          await window.MODA_SEQUENCE_HISTORY.saveSnapshot(project.id, project.modules || [], 'reorder', `Reordered ${pendingReorders.length} module(s): ${reorderDescriptions}`, auth?.currentUser);
        }
      }
    }
    setProjects(prevProjects => prevProjects.map(project => {
      // Get modules that have pending reorders
      const projectReorders = pendingReorders.filter(r => project.modules?.some(m => m.id === r.moduleId));
      if (projectReorders.length === 0) return project;

      // Sort modules by their new sequence (using toSeq for reordered ones)
      let modules = [...(project.modules || [])].map(m => {
        const reorder = projectReorders.find(r => r.moduleId === m.id);
        return {
          ...m,
          _sortSeq: reorder ? reorder.toSeq : m.buildSequence || 0
        };
      });
      modules.sort((a, b) => a._sortSeq - b._sortSeq);

      // Reassign sequential build sequences
      if (applyToAll) {
        modules = modules.map((m, idx) => {
          const {
            _sortSeq,
            ...rest
          } = m;
          return {
            ...rest,
            buildSequence: idx + 1
          };
        });
      }
      return {
        ...project,
        modules
      };
    }));

    // Show success toast
    addToast(`Reordered ${pendingReorders.length} module${pendingReorders.length > 1 ? 's' : ''}`, 'success', '', applyToAll ? 'Sequences renumbered (history saved)' : 'Positions updated');

    // Reset reorder mode
    setReorderMode(false);
    setPendingReorders([]);
    setShowReorderConfirm(false);
  };

  // Cancel reorder mode
  const cancelReorderMode = () => {
    setReorderMode(false);
    setPendingReorders([]);
    setDraggedModule(null);
    setDragOverTarget(null);
  };

  // Handle "..." button click - show prompt menu
  const handleMenuClick = (e, module, station) => {
    e.stopPropagation();
    const rect = e.currentTarget.getBoundingClientRect();
    setActivePrompt({
      module,
      station,
      position: {
        top: rect.bottom + 8,
        // Below the button
        left: rect.right // Align right edge of menu with right edge of button
      }
    });
  };

  // Handle shop drawing click - opens current version of shop drawing package
  // First tries the new Drawings Module system, then falls back to legacy shopDrawingLinks
  const handleShopDrawing = async module => {
    // Find the project this module belongs to
    const project = projects.find(p => p.id === module.projectId);
    if (!project) {
      alert('Error: Could not find project for this module.');
      return;
    }

    // First, try the new Drawings Module system with direct file open
    if (window.MODA_SUPABASE_DRAWINGS?.isAvailable?.()) {
      try {
        // Search for drawings in Module Packages folder by BLM
        const blmToCheck = [module.hitchBLM, module.rearBLM].filter(Boolean);

        // Get drawings for this project in Module Packages discipline
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(project.id, 'shop-module-packages');

        // Find drawing that matches this module's BLM
        // Handles partial matches (L4M08 matches B1L4M08) and multi-BLM filenames
        let matchedDrawing = null;
        for (const blm of blmToCheck) {
          const normalizedBLM = blm.toUpperCase().replace(/[_\-\s]/g, '');
          // Extract just the level-module part (e.g., L4M08 from B1L4M08)
          const levelModulePart = normalizedBLM.match(/L\d+M\d+/)?.[0] || normalizedBLM;
          matchedDrawing = drawings.find(d => {
            const fileName = d.name.toUpperCase().replace(/[_\-\s]/g, '');
            // Check if filename contains the BLM (full or partial match)
            return fileName.includes(normalizedBLM) || fileName.includes(levelModulePart);
          });
          if (matchedDrawing) break;
        }
        if (matchedDrawing && matchedDrawing.versions?.length > 0) {
          // Get latest version
          const latestVersion = [...matchedDrawing.versions].sort((a, b) => new Date(b.uploaded_at || b.uploadedAt) - new Date(a.uploaded_at || a.uploadedAt))[0];

          // Get view URL with cache-busting
          const storagePath = latestVersion.storage_path || latestVersion.storagePath;
          const sharePointFileId = latestVersion.sharepoint_file_id || latestVersion.sharepointFileId;
          let url = await window.MODA_SUPABASE_DRAWINGS.versions.getViewUrl(storagePath, sharePointFileId);
          if (url) {
            // Add cache-busting timestamp to ensure current version loads
            const cacheBuster = `_cb=${Date.now()}`;
            url = url.includes('?') ? `${url}&${cacheBuster}` : `${url}?${cacheBuster}`;
            window.open(url, '_blank', 'noopener,noreferrer');
            return;
          }
        }
      } catch (error) {
        console.error('[WeeklyBoard] Error fetching shop drawing:', error);
      }
    }

    // Fallback to legacy shopDrawingLinks system
    const shopDrawingLinks = project.shopDrawingLinks || {};
    const blmToCheck = [module.hitchBLM, module.rearBLM].filter(Boolean);
    let foundUrl = null;
    for (const blm of blmToCheck) {
      if (shopDrawingLinks[blm]) {
        foundUrl = shopDrawingLinks[blm];
        break;
      }
    }
    if (foundUrl) {
      // Add cache-busting and open in new tab
      const cacheBuster = `_cb=${Date.now()}`;
      foundUrl = foundUrl.includes('?') ? `${foundUrl}&${cacheBuster}` : `${foundUrl}?${cacheBuster}`;
      window.open(foundUrl, '_blank', 'noopener,noreferrer');
    } else {
      // Show not found message with instructions
      const blmList = blmToCheck.length > 0 ? blmToCheck.join(', ') : 'No BLM';
      alert(`Shop Drawing Not Found\n\nNo shop drawing found for module ${module.serialNumber} (BLM: ${blmList}).\n\nTo add shop drawings:\n1. Go to Drawings → Shop Drawings → Module Packages\n2. Upload a PDF with the BLM in the filename (e.g., "${blmToCheck[0] || 'B1L2M01'} - Shops.pdf")\n\nOr use legacy links: Projects → Edit Project → Shop Drawing Links.`);
    }
  };

  // Handle PDF export - opens export modal
  const handleExportPDF = () => {
    setShowPDFExport(true);
  };

  // Helper to compute day labels for PDF export
  const computeDayLabelsForPDF = () => {
    const days = [];
    const shift1Days = ['monday', 'tuesday', 'wednesday', 'thursday'];
    const dayNames = {
      monday: 'Mon',
      tuesday: 'Tue',
      wednesday: 'Wed',
      thursday: 'Thu',
      friday: 'Fri',
      saturday: 'Sat',
      sunday: 'Sun'
    };
    let moduleNum = 1;
    shift1Days.forEach(day => {
      // Use displayWeek's shift config when viewing a specific week, fallback to scheduleSetup
      const count = displayWeek?.shift1?.[day] ?? scheduleSetup?.shift1?.[day] ?? 0;
      if (count > 0) {
        const weekStart = displayWeek?.weekStart ? parseLocalDate(displayWeek.weekStart) : new Date();
        const dayOffset = shift1Days.indexOf(day);
        const dayDate = new Date(weekStart);
        dayDate.setDate(dayDate.getDate() + dayOffset);
        const monthStr = dayDate.toLocaleDateString('en-US', {
          month: 'short'
        });
        const dayNum = dayDate.getDate();
        for (let i = 0; i < count; i++) {
          days.push({
            day,
            label: dayNames[day],
            monthStr,
            dayNum,
            slotNum: i + 1,
            moduleNum: moduleNum++
          });
        }
      }
    });
    return days;
  };

  // Generate PDF data for export view - respects pdfExportScope
  const getPDFExportData = useMemo(() => {
    if (!hasWeekConfig) return {
      rows: [],
      stations: []
    };
    const firstStation = productionStages?.[0];
    if (!firstStation) return {
      rows: [],
      stations: []
    };
    const firstStationData = getModulesForStation(firstStation);
    if (!firstStationData) return {
      rows: [],
      stations: []
    };
    const {
      previous = [],
      current = [],
      next = []
    } = firstStationData;

    // Filter rows based on export scope
    let filteredRows = [];
    let prevLength = 0;
    if (pdfExportScope === 'current') {
      filteredRows = [...current];
      prevLength = 0;
    } else if (pdfExportScope === 'with-prev') {
      filteredRows = [...previous, ...current];
      prevLength = previous.length;
    } else if (pdfExportScope === 'with-next') {
      filteredRows = [...current, ...next];
      prevLength = 0;
    } else {
      // 'all'
      filteredRows = [...previous, ...current, ...next];
      prevLength = previous.length;
    }
    if (filteredRows.length === 0) return {
      rows: [],
      stations: productionStages
    };
    const pdfDayLabels = computeDayLabelsForPDF();

    // Build rows with module data for each station
    const rows = filteredRows.map((module, idx) => {
      // Calculate the correct day label index based on scope
      let dayLabelIdx;
      if (pdfExportScope === 'current' || pdfExportScope === 'with-next') {
        dayLabelIdx = idx;
      } else {
        dayLabelIdx = idx - prevLength;
      }
      const dayInfo = pdfDayLabels[dayLabelIdx];
      const rowData = {
        dayLabel: module.weekSection === 'previous' ? 'PREV' : module.weekSection === 'next' ? 'NEXT' : dayInfo?.label || '',
        dateLabel: module.weekSection === 'current' ? `${dayInfo?.monthStr || ''} ${dayInfo?.dayNum || ''}` : '',
        weekSection: module.weekSection,
        stations: {}
      };

      // Get module data for each station - need to find the matching module
      productionStages.forEach(station => {
        const stationData = getModulesForStation(station);
        if (!stationData) return;

        // Find the module with matching serial number in this station's data
        const {
          previous: sPrev = [],
          current: sCurr = [],
          next: sNext = []
        } = stationData;
        let stationModule;
        if (module.weekSection === 'previous') {
          const prevIdx = previous.findIndex(m => m.serialNumber === module.serialNumber);
          stationModule = sPrev[prevIdx];
        } else if (module.weekSection === 'next') {
          const nextIdx = next.findIndex(m => m.serialNumber === module.serialNumber);
          stationModule = sNext[nextIdx];
        } else {
          const currIdx = current.findIndex(m => m.serialNumber === module.serialNumber);
          stationModule = sCurr[currIdx];
        }
        if (stationModule) {
          // stationProgress is the numeric progress for THIS station (set by addStatusInfo)
          const progress = typeof stationModule.stationProgress === 'number' ? stationModule.stationProgress : 0;
          rowData.stations[station.id] = {
            serialNumber: stationModule.serialNumber,
            progress: progress,
            isComplete: progress === 100,
            // Include detailed info for detailed view export
            hitchBLM: stationModule.hitchBLM,
            rearBLM: stationModule.rearBLM,
            hitchUnit: stationModule.hitchUnit,
            rearUnit: stationModule.rearUnit,
            hitchRoomType: stationModule.hitchRoomType,
            rearRoomType: stationModule.rearRoomType,
            difficulties: stationModule.difficulties
          };
        }
      });
      return rowData;
    });
    return {
      rows,
      stations: productionStages
    };
  }, [hasWeekConfig, productionStages, projects, displayWeek, scheduleSetup, pdfExportScope]);

  // Export to PDF using browser print
  const executePDFExport = () => {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      addToast('Please allow popups to export PDF', 'error');
      return;
    }
    const {
      rows,
      stations
    } = getPDFExportData;
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit'
    });
    const isDetailed = boardViewMode === 'detailed';

    // Get progress color based on percentage
    const getProgressColor = progress => {
      if (progress === 0) return '#ffffff';
      if (progress === 25) return '#dcfce7';
      if (progress === 50) return '#bbf7d0';
      if (progress === 75) return '#86efac';
      return '#4ade80'; // 100%
    };

    // Render difficulty dots for detailed view
    const renderDifficultyDots = difficulties => {
      if (!difficulties) return '';
      const colors = {
        sidewall: '#f97316',
        stair: '#8b5cf6',
        hr3Wall: '#ef4444',
        short: '#eab308',
        doubleStudio: '#6366f1',
        sawbox: '#ec4899'
      };
      const dots = Object.entries(difficulties).filter(([_, v]) => v).map(([key]) => `<span style="display:inline-block;width:5px;height:5px;border-radius:50%;background:${colors[key]};margin:0 1px;"></span>`).join('');
      return dots ? `<div style="margin-top:1px;">${dots}</div>` : '';
    };

    // Render cell content based on view mode
    const renderCellContent = data => {
      if (!data) {
        // Empty cell - match height for alignment
        return `<td class="module-cell ${isDetailed ? 'detailed-cell' : ''}" style="color:#ccc;vertical-align:middle;">—</td>`;
      }
      if (isDetailed) {
        return `<td class="module-cell detailed-cell" style="background:${getProgressColor(data.progress)};vertical-align:top;">
                    <div style="font-weight:bold;font-size:7px;border-bottom:1px solid #ddd;padding-bottom:1px;margin-bottom:1px;text-align:center;">
                        ${data.serialNumber?.slice(-7) || '—'}${data.isComplete ? ' <span class="checkmark">✓</span>' : ''}
                    </div>
                    <table style="width:100%;border-collapse:collapse;font-size:5px;line-height:1.2;">
                        <tr>
                            <td style="width:50%;text-align:center;border-right:1px solid #eee;padding:0 1px;vertical-align:top;">
                                <div style="color:#999;font-size:4px;font-weight:bold;">(H)</div>
                                <div style="font-weight:600;font-family:monospace;">${data.hitchBLM || '—'}</div>
                                <div style="color:#555;">${data.hitchUnit || '—'}</div>
                                <div style="color:#777;font-size:4px;">${data.hitchRoomType || '—'}</div>
                            </td>
                            <td style="width:50%;text-align:center;padding:0 1px;vertical-align:top;">
                                <div style="color:#999;font-size:4px;font-weight:bold;">(R)</div>
                                <div style="font-weight:600;font-family:monospace;">${data.rearBLM || '—'}</div>
                                <div style="color:#555;">${data.rearUnit || data.hitchUnit || '—'}</div>
                                <div style="color:#777;font-size:4px;">${data.rearRoomType || '—'}</div>
                            </td>
                        </tr>
                    </table>
                    ${renderDifficultyDots(data.difficulties)}
                </td>`;
      } else {
        return `<td class="module-cell" style="background:${getProgressColor(data.progress)};vertical-align:middle;">
                    ${data.serialNumber?.slice(-7) || '—'}
                    ${data.isComplete ? ' <span class="checkmark">✓</span>' : ''}
                </td>`;
      }
    };
    const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Schedule - ${dateStr}</title>
    <style>
        @page {
            size: 17in 11in landscape;
            margin: 0.25in;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            font-size: 9px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #1a1a1a;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: ${isDetailed ? '8px 16px' : '12px 20px'};
            border-bottom: 3px solid #1e3a5f;
            margin-bottom: ${isDetailed ? '8px' : '12px'};
        }
        .header-left { font-size: ${isDetailed ? '9px' : '11px'}; color: #555; }
        .header-center { font-size: ${isDetailed ? '12px' : '16px'}; font-weight: bold; color: #1e3a5f; letter-spacing: 0.5px; }
        .header-right { font-size: ${isDetailed ? '9px' : '11px'}; color: #555; font-weight: 500; }
        .view-mode { font-size: 8px; color: #888; margin-left: 8px; }
        table { 
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed;
        }
        th {
            background: #1e3a5f;
            color: white;
            padding: ${isDetailed ? '4px 2px' : '8px 4px'};
            font-size: ${isDetailed ? '7px' : '9px'};
            font-weight: 600;
            text-align: center;
            border: 1px solid #1e3a5f;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        th.day-col { width: ${isDetailed ? '45px' : '60px'}; }
        td {
            border: 1px solid #ccc;
            padding: ${isDetailed ? '2px 1px' : '4px 2px'};
            text-align: center;
            vertical-align: ${isDetailed ? 'top' : 'middle'};
            height: ${isDetailed ? '58px' : '26px'};
            background: white;
        }
        /* Nested table inside cells should not have borders */
        td table { border: none; }
        td table td { border: none; height: auto; padding: 0; background: transparent; }
        .day-cell {
            font-weight: 600;
            font-size: ${isDetailed ? '7px' : '9px'};
            background: white;
            border-right: 2px solid #1e3a5f;
            vertical-align: middle;
        }
        .day-cell.prev { 
            background: white; 
            color: #888;
            font-style: italic;
        }
        .day-cell.next { 
            background: white; 
            color: #888;
            font-style: italic;
        }
        .module-cell {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: ${isDetailed ? '6px' : '9px'};
            font-weight: 600;
        }
        .detailed-cell {
            padding: 2px;
        }
        .checkmark { 
            color: #059669; 
            font-weight: bold; 
            font-size: ${isDetailed ? '8px' : '11px'};
        }
        .legend {
            display: flex;
            gap: ${isDetailed ? '12px' : '20px'};
            justify-content: center;
            margin-top: ${isDetailed ? '6px' : '12px'};
            font-size: ${isDetailed ? '7px' : '9px'};
            padding: ${isDetailed ? '4px' : '8px'};
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: ${isDetailed ? '3px' : '6px'};
        }
        .legend-box {
            width: ${isDetailed ? '12px' : '18px'};
            height: ${isDetailed ? '12px' : '18px'};
            border: 1px solid #999;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .legend-label { font-weight: 500; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">${dateStr}, ${timeStr}</div>
        <div class="header-center">Weekly Production Schedule <span class="view-mode">(${isDetailed ? 'Detailed' : 'Compact'} View)</span></div>
        <div class="header-right">Week of ${displayWeek?.weekStart ? parseLocalDate(displayWeek.weekStart).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    }) : dateStr}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th class="day-col">Day</th>
                ${stations.map(s => `<th>${s.dept}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
            ${rows.map(row => `
                <tr>
                    <td class="day-cell ${row.weekSection === 'previous' ? 'prev' : row.weekSection === 'next' ? 'next' : ''}">
                        ${row.dayLabel}${row.dateLabel ? '<br/>' + row.dateLabel : ''}
                    </td>
                    ${stations.map(s => renderCellContent(row.stations[s.id])).join('')}
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="legend">
        <div class="legend-item"><div class="legend-box" style="background:#ffffff"></div> <span class="legend-label">Not Started</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#dcfce7"></div> <span class="legend-label">25%</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#bbf7d0"></div> <span class="legend-label">50%</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#86efac"></div> <span class="legend-label">75%</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#4ade80"></div> <span class="legend-label">Complete ✓</span></div>
        ${isDetailed ? `
        <span style="margin:0 4px;color:#ccc;">|</span>
        <div class="legend-item"><div class="legend-dot" style="background:#f97316;"></div> <span class="legend-label">SW</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> <span class="legend-label">STAIR</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> <span class="legend-label">3HR</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#eab308;"></div> <span class="legend-label">SHORT</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> <span class="legend-label">DBL</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> <span class="legend-label">SAW</span></div>
        ` : ''}
    </div>
    
    <script>
        window.onload = function() {
            window.print();
            setTimeout(function() { window.close(); }, 500);
        };
    </script>
</body>
</html>`;
    printWindow.document.write(html);
    printWindow.document.close();
    setShowPDFExport(false);
    addToast('PDF export opened - save as PDF from print dialog', 'success');
  };

  // Generate detailed report for printing (fits on single 11x17 sheet)
  const executeDetailedReport = () => {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      addToast('Please allow popups to print report', 'error');
      return;
    }

    // Get all modules on board
    const modulesOnBoard = getModulesOnBoard;
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    });
    const timeStr = now.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit'
    });
    const weekDateStr = displayWeek?.weekStart ? parseLocalDate(displayWeek.weekStart).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    }) : dateStr;

    // Calculate columns needed - aim for ~6-8 columns to fit on 11x17
    const totalModules = modulesOnBoard.length;
    const columnsNeeded = Math.min(8, Math.max(4, Math.ceil(totalModules / 6)));
    const rowsPerColumn = Math.ceil(totalModules / columnsNeeded);

    // Split modules into columns
    const columns = [];
    for (let i = 0; i < columnsNeeded; i++) {
      columns.push(modulesOnBoard.slice(i * rowsPerColumn, (i + 1) * rowsPerColumn));
    }

    // Generate module card HTML
    const renderModuleCard = module => {
      const difficulties = module.difficulties || {};
      const activeDiffs = Object.entries(difficulties).filter(([_, v]) => v);
      const sectionBorder = module.section === 'previous' ? '#f87171' : module.section === 'next' ? '#4ade80' : '#3b82f6';
      const diffDots = activeDiffs.map(([key]) => {
        const color = difficultyColors[key];
        return `<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${color};margin:0 1px;" title="${difficultyLabels[key]}"></span>`;
      }).join('');
      return `
                <div style="border:1px solid #ddd;border-left:3px solid ${sectionBorder};border-radius:3px;padding:3px;margin-bottom:3px;background:white;font-size:7px;">
                    <div style="font-weight:bold;font-family:monospace;font-size:8px;text-align:center;border-bottom:1px solid #eee;padding-bottom:2px;margin-bottom:2px;">
                        ${module.serialNumber?.slice(-7) || 'N/A'}
                    </div>
                    <div style="display:flex;font-size:6px;">
                        <div style="flex:1;text-align:center;border-right:1px solid #eee;padding-right:2px;">
                            <div style="color:#999;font-size:5px;">(H)</div>
                            <div style="font-weight:600;font-family:monospace;">${module.hitchBLM || '—'}</div>
                            <div style="color:#666;">${module.hitchUnit || '—'}</div>
                            <div style="color:#888;">${module.hitchRoomType || '—'}</div>
                        </div>
                        <div style="flex:1;text-align:center;padding-left:2px;">
                            <div style="color:#999;font-size:5px;">(R)</div>
                            <div style="font-weight:600;font-family:monospace;">${module.rearBLM || '—'}</div>
                            <div style="color:#666;">${module.rearUnit || module.hitchUnit || '—'}</div>
                            <div style="color:#888;">${module.rearRoomType || '—'}</div>
                        </div>
                    </div>
                    ${activeDiffs.length > 0 ? `<div style="text-align:center;padding-top:2px;border-top:1px solid #eee;margin-top:2px;">${diffDots}</div>` : ''}
                </div>
            `;
    };
    const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Board Report - ${weekDateStr}</title>
    <style>
        @page {
            size: 17in 11in landscape;
            margin: 0.25in;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            font-size: 8px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #1a1a1a;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 2px solid #1e3a5f;
            margin-bottom: 8px;
        }
        .header-left { font-size: 9px; color: #555; }
        .header-center { font-size: 14px; font-weight: bold; color: #1e3a5f; }
        .header-right { font-size: 9px; color: #555; }
        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 9px;
        }
        .stat { padding: 4px 12px; background: #f3f4f6; border-radius: 4px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: bold; color: #1e3a5f; }
        .columns-container {
            display: flex;
            gap: 8px;
            padding: 0 8px;
        }
        .column {
            flex: 1;
            min-width: 0;
        }
        .column-header {
            background: #1e3a5f;
            color: white;
            padding: 4px;
            text-align: center;
            font-weight: 600;
            font-size: 8px;
            border-radius: 3px 3px 0 0;
            margin-bottom: 4px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
            padding: 6px;
            border-top: 1px solid #ddd;
            font-size: 7px;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-box { width: 10px; height: 10px; border-radius: 2px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">${dateStr}, ${timeStr}</div>
        <div class="header-center">Weekly Board - Detailed Module Report</div>
        <div class="header-right">Week of ${weekDateStr}</div>
    </div>
    
    <div class="stats">
        <div class="stat"><span class="stat-label">Total Modules:</span> <span class="stat-value">${totalModules}</span></div>
        <div class="stat"><span class="stat-label">Line Balance:</span> <span class="stat-value">${lineBalance}</span></div>
        <div class="stat"><span class="stat-label">Starting Module:</span> <span class="stat-value">${displayWeek?.startingModule || 'N/A'}</span></div>
    </div>
    
    <div class="columns-container">
        ${columns.map((col, idx) => `
            <div class="column">
                <div class="column-header">Column ${idx + 1}</div>
                ${col.map(m => renderModuleCard(m)).join('')}
            </div>
        `).join('')}
    </div>
    
    <div class="legend">
        <div class="legend-item"><div class="legend-box" style="border-left:3px solid #f87171;background:#fee2e2;"></div> Previous Week</div>
        <div class="legend-item"><div class="legend-box" style="border-left:3px solid #3b82f6;background:#dbeafe;"></div> Current Week</div>
        <div class="legend-item"><div class="legend-box" style="border-left:3px solid #4ade80;background:#dcfce7;"></div> Upcoming</div>
        <span style="margin:0 8px;">|</span>
        <div class="legend-item"><div class="legend-dot" style="background:#f97316;"></div> SW</div>
        <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> STAIR</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> 3HR</div>
        <div class="legend-item"><div class="legend-dot" style="background:#eab308;"></div> SHORT</div>
        <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> DBL</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> SAW</div>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
        };
    </script>
</body>
</html>`;
    printWindow.document.write(html);
    printWindow.document.close();
    addToast('Detailed report opened - print or save as PDF', 'success');
  };

  // Build navigation grid for keyboard navigation
  // Each cell contains the actual module at that station's row position
  const navigationGrid = useMemo(() => {
    if (!productionStages?.length) return {
      rows: [],
      stationCount: 0
    };

    // Get row count from first station
    const firstStation = productionStages[0];
    const {
      previous = [],
      current = [],
      next = []
    } = getModulesForStation(firstStation);
    const rowCount = previous.length + current.length + next.length;

    // Build grid where each cell has the actual module at that position for that station
    const grid = [];
    for (let rowIndex = 0; rowIndex < rowCount; rowIndex++) {
      const row = {
        rowIndex,
        cells: productionStages.map((station, colIndex) => {
          const stationData = getModulesForStation(station);
          const allModules = [...(stationData.previous || []), ...(stationData.current || []), ...(stationData.next || [])];
          const module = allModules[rowIndex];
          return {
            stationId: station.id,
            colIndex,
            moduleId: module?.id || null,
            projectId: module?.projectId || null
          };
        })
      };
      grid.push(row);
    }
    return {
      rows: grid,
      stationCount: productionStages.length
    };
  }, [productionStages, getModulesForStation]);

  // Handle keyboard navigation and shortcuts
  const handleBoardKeyDown = useCallback(e => {
    if (!boardRef.current) return;
    const scrollContainer = boardRef.current.querySelector('.board-scroll-container');
    if (!scrollContainer) return;
    const {
      rows,
      stationCount
    } = navigationGrid;
    if (!rows.length || !stationCount) return;

    // Progress shortcuts: 0-4 keys when a cell is focused (single selection only)
    if (focusedCell && selectedModules.size === 1 && canEdit) {
      const progressMap = {
        '0': 0,
        '1': 25,
        '2': 50,
        '3': 75,
        '4': 100
      };
      if (progressMap[e.key] !== undefined) {
        e.preventDefault();
        // Get the cell data which now contains moduleId and projectId
        const focusedRow = rows[focusedCell.rowIndex];
        if (focusedRow) {
          const cell = focusedRow.cells[focusedCell.colIndex];
          if (cell && cell.moduleId) {
            updateModuleProgress(cell.moduleId, cell.projectId, cell.stationId, progressMap[e.key]);
          }
        }
        return;
      }
    }

    // Arrow key navigation when a cell is focused
    if (focusedCell && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
      e.preventDefault();
      let newRowIndex = focusedCell.rowIndex;
      let newColIndex = focusedCell.colIndex;
      switch (e.key) {
        case 'ArrowUp':
          newRowIndex = Math.max(0, focusedCell.rowIndex - 1);
          break;
        case 'ArrowDown':
          newRowIndex = Math.min(rows.length - 1, focusedCell.rowIndex + 1);
          break;
        case 'ArrowLeft':
          newColIndex = Math.max(0, focusedCell.colIndex - 1);
          break;
        case 'ArrowRight':
          newColIndex = Math.min(stationCount - 1, focusedCell.colIndex + 1);
          break;
      }

      // Get the new cell's module and station
      const newRow = rows[newRowIndex];
      if (newRow) {
        const newCell = newRow.cells[newColIndex];
        if (newCell && newCell.moduleId) {
          const newFocusedCell = {
            moduleId: newCell.moduleId,
            stationId: newCell.stationId,
            rowIndex: newRowIndex,
            colIndex: newColIndex
          };
          setFocusedCell(newFocusedCell);

          // Update selection to the new cell (single selection mode for keyboard nav)
          if (!e.ctrlKey && !e.metaKey) {
            setSelectedModules(new Set([getSelectionKey(newCell.moduleId, newCell.stationId)]));
          }

          // Scroll the cell into view
          const cellElement = document.querySelector(`[data-cell-key="${getSelectionKey(newCell.moduleId, newCell.stationId)}"]`);
          if (cellElement) {
            cellElement.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'nearest'
            });
          }
        }
      }
      return;
    }

    // Default scroll behavior when no cell is focused
    if (!focusedCell) {
      const scrollAmount = 200;
      if (e.key === 'ArrowLeft') {
        scrollContainer.scrollBy({
          left: -scrollAmount,
          behavior: 'smooth'
        });
        e.preventDefault();
      } else if (e.key === 'ArrowRight') {
        scrollContainer.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        });
        e.preventDefault();
      }
    }
  }, [navigationGrid, focusedCell, selectedModules.size, canEdit, productionStages, getModulesForStation, updateModuleProgress, getSelectionKey]);

  // Card height for alignment between date markers and module cards
  // Compact = 58px (serial only), Detailed = 120px (full info with BLM, unit type, room type, difficulty dots)
  const CARD_HEIGHT = boardViewMode === 'detailed' ? 140 : 70;
  const COLUMN_WIDTH = 180; // Width of each station column (increased for more visibility)
  const DATE_MARKER_WIDTH = 100; // Width of date marker column (increased for better readability)

  // Get project abbreviation - use stored abbreviation if available, otherwise auto-generate
  const getProjectAcronym = module => {
    // First check if module has projectAbbreviation from the project
    if (module.projectAbbreviation) return module.projectAbbreviation;
    const projectName = module.projectName;
    if (!projectName) return '';
    const words = projectName.trim().split(/\s+/);
    if (words.length === 1) {
      // Single word: take first 2-3 letters
      return words[0].substring(0, 3).toUpperCase();
    }
    // Multiple words: take first letter of each word (max 3)
    return words.slice(0, 3).map(w => w[0]).join('').toUpperCase();
  };

  // Render a module card with progress buttons and menu (Station Board style)
  const renderModuleCard = (module, station, weekSection = 'current') => {
    const currentProgress = module.stageProgress?.[station.id] || 0;
    const isComplete = currentProgress === 100;
    const moduleIsSelected = isSelected(module.id, station.id);

    // Determine border/background based on week section, selection, completion, and hold status
    let borderClass = 'border';
    let bgClass = 'bg-white';

    // Hold status takes priority for visual indication (thick red border)
    if (module.isOnHold) {
      borderClass = 'border-4 border-red-500';
      bgClass = 'bg-red-50';
    } else if (moduleIsSelected) {
      borderClass = 'border-2 border-blue-500';
      bgClass = 'bg-blue-50';
    } else if (isComplete) {
      borderClass = 'border border-green-300';
      bgClass = 'bg-green-50';
    } else if (weekSection === 'previous') {
      borderClass = 'border border-red-300';
      bgClass = 'bg-red-50';
    } else if (weekSection === 'next') {
      borderClass = 'border border-gray-200';
      bgClass = 'bg-gray-50';
    } else {
      borderClass = 'border border-gray-200';
    }

    // For "next" week modules with no progress, show greyed out "on-deck" style
    const isOnDeck = weekSection === 'next' && currentProgress === 0;
    if (isOnDeck) {
      const difficulties = module.difficulties || {};
      const activeDifficulties = Object.entries(difficulties).filter(([_, v]) => v);
      return /*#__PURE__*/React.createElement("div", {
        key: `${station.id}-${module.id}`,
        "data-module-serial": module.serialNumber,
        "data-cell-key": getSelectionKey(module.id, station.id),
        className: "rounded p-1.5 bg-gray-50 border border-gray-200 opacity-50 hover:opacity-100 transition cursor-pointer",
        style: {
          height: `${CARD_HEIGHT}px`
        },
        onClick: () => updateModuleProgress(module.id, module.projectId, station.id, 25),
        title: "Click to start"
      }, /*#__PURE__*/React.createElement("div", {
        className: "font-mono text-xs font-bold text-gray-500 truncate flex items-center gap-1"
      }, module.serialNumber, module.projectName && /*#__PURE__*/React.createElement("span", {
        className: "text-[9px] px-1 py-0.5 bg-gray-200 text-gray-600 rounded",
        title: module.projectName
      }, getProjectAcronym(module)), module.isPrototype && /*#__PURE__*/React.createElement("span", {
        className: "text-yellow-500 ml-1",
        title: "Prototype"
      }, "\u2605")), boardViewMode === 'detailed' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
        className: "grid grid-cols-2 divide-x text-center mt-1 border-t border-b py-0.5"
      }, /*#__PURE__*/React.createElement("div", {
        className: "px-0.5"
      }, /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-400 font-medium"
      }, "(H)"), /*#__PURE__*/React.createElement("div", {
        className: "font-mono text-[9px] font-semibold truncate"
      }, module.hitchBLM || '—'), /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-600 truncate"
      }, module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-500 truncate"
      }, module.hitchRoomType || '—')), /*#__PURE__*/React.createElement("div", {
        className: "px-0.5"
      }, /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-400 font-medium"
      }, "(R)"), /*#__PURE__*/React.createElement("div", {
        className: "font-mono text-[9px] font-semibold truncate"
      }, module.rearBLM || '—'), /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-600 truncate"
      }, module.rearUnit || module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
        className: "text-[8px] text-gray-500 truncate"
      }, module.rearRoomType || '—'))), activeDifficulties.length > 0 && /*#__PURE__*/React.createElement("div", {
        className: "flex justify-center gap-0.5 py-0.5"
      }, activeDifficulties.map(([key]) => /*#__PURE__*/React.createElement("div", {
        key: key,
        className: "w-2.5 h-2.5 rounded-full",
        style: {
          backgroundColor: difficultyColors[key]
        },
        title: difficultyLabels[key]
      })))), /*#__PURE__*/React.createElement("div", {
        className: "text-xs text-autovol-teal mt-0.5"
      }, "\u25B6 Start"));
    }

    // Check if this module has a pending reorder
    const pendingReorder = pendingReorders.find(r => r.moduleId === module.id);
    const isDragTarget = dragOverTarget?.moduleId === module.id;
    const isPlacementTarget = activePlacementMode && placementTarget?.moduleId === module.id;

    // Determine indicator class: green for placement mode, blue for reorder mode
    let dropIndicatorClass = '';
    if (isPlacementTarget) {
      dropIndicatorClass = placementTarget.position === 'before' ? 'border-t-4 border-t-green-500' : 'border-b-4 border-b-green-500';
    } else if (isDragTarget) {
      dropIndicatorClass = dragOverTarget.position === 'before' ? 'border-t-4 border-t-blue-500' : 'border-b-4 border-b-blue-500';
    }

    // Find col index for this cell (for keyboard navigation)
    const colIndex = productionStages.findIndex(s => s.id === station.id);
    const isFocused = focusedCell?.moduleId === module.id && focusedCell?.stationId === station.id;
    return /*#__PURE__*/React.createElement("div", {
      key: `${station.id}-${module.id}`,
      "data-module-serial": module.serialNumber,
      "data-cell-key": getSelectionKey(module.id, station.id),
      className: `rounded p-1.5 transition-all hover:shadow-md ${bgClass} ${borderClass} ${dropIndicatorClass} ${reorderMode ? 'cursor-grab active:cursor-grabbing' : ''} ${activePlacementMode ? 'cursor-pointer hover:ring-2 hover:ring-green-400' : ''} ${pendingReorder ? 'ring-2 ring-blue-400 ring-offset-1' : ''} ${isFocused ? 'ring-2 ring-blue-600 ring-offset-1' : ''}`,
      style: {
        height: `${CARD_HEIGHT}px`
      },
      draggable: reorderMode && !activePlacementMode,
      onDragStart: e => handleDragStart(e, module),
      onDragEnd: handleDragEnd,
      onDragOver: e => handleDragOver(e, module),
      onDragLeave: handleDragLeave,
      onDrop: e => handleDrop(e, module),
      onMouseMove: e => {
        if (!activePlacementMode) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        const position = e.clientY < midY ? 'before' : 'after';
        if (placementTarget?.moduleId !== module.id || placementTarget?.position !== position) {
          setPlacementTarget({
            moduleId: module.id,
            position
          });
        }
      },
      onMouseLeave: () => {
        if (activePlacementMode && placementTarget?.moduleId === module.id) {
          setPlacementTarget(null);
        }
      },
      onClick: e => {
        if (activePlacementMode) {
          e.stopPropagation();
          handlePlacePrototypeLocal(activePlacementMode, module, placementTarget?.position || 'after');
        }
      },
      onContextMenu: e => handleContextMenu(e, module.id, station.id),
      onTouchStart: () => handleTouchStart(module.id, station.id),
      onTouchEnd: handleTouchEnd,
      onTouchCancel: handleTouchEnd
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", {
      className: `font-mono text-xs font-bold cursor-pointer select-none truncate ${moduleIsSelected ? 'text-blue-600' : isComplete ? 'text-green-800' : 'text-gray-800'} hover:text-blue-500 transition-colors`,
      onClick: e => {
        e.stopPropagation();
        toggleSelection(module.id, station.id, e.ctrlKey || e.metaKey);
        // Set focused cell for keyboard navigation (compute rowIndex from all modules)
        if (!e.ctrlKey && !e.metaKey) {
          const firstStation = productionStages[0];
          if (firstStation) {
            const {
              previous = [],
              current = [],
              next = []
            } = getModulesForStation(firstStation);
            const allModules = [...previous, ...current, ...next];
            const rowIndex = allModules.findIndex(m => m.id === module.id);
            setFocusedCell({
              moduleId: module.id,
              stationId: station.id,
              rowIndex,
              colIndex
            });
          }
        }
      },
      title: "Click to select, Ctrl+Click for multi-select. Use arrow keys to navigate, 0-4 for progress."
    }, moduleIsSelected && /*#__PURE__*/React.createElement("span", {
      className: "text-blue-500 mr-1"
    }, "\u2713"), module.serialNumber, module.projectName && /*#__PURE__*/React.createElement("span", {
      className: "text-[9px] px-1 py-0.5 bg-blue-100 text-blue-700 rounded ml-1",
      title: module.projectName
    }, getProjectAcronym(module)), module.isPrototype && /*#__PURE__*/React.createElement("span", {
      className: "text-yellow-500 ml-1",
      title: "Prototype"
    }, "\u2605")), /*#__PURE__*/React.createElement("button", {
      onClick: e => handleMenuClick(e, module, station),
      className: "text-gray-400 hover:text-gray-600 text-xs px-0.5",
      title: "More options"
    }, "\u2022\u2022\u2022")), boardViewMode === 'detailed' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 divide-x text-center mt-1 border-t border-b py-0.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "px-0.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-400 font-medium"
    }, "(H)"), /*#__PURE__*/React.createElement("div", {
      className: "font-mono text-[9px] font-semibold truncate",
      title: module.hitchBLM
    }, module.hitchBLM || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-600 truncate",
      title: module.hitchUnit
    }, module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-500 truncate",
      title: module.hitchRoomType
    }, module.hitchRoomType || '—')), /*#__PURE__*/React.createElement("div", {
      className: "px-0.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-400 font-medium"
    }, "(R)"), /*#__PURE__*/React.createElement("div", {
      className: "font-mono text-[9px] font-semibold truncate",
      title: module.rearBLM
    }, module.rearBLM || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-600 truncate",
      title: module.rearUnit
    }, module.rearUnit || module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[8px] text-gray-500 truncate",
      title: module.rearRoomType
    }, module.rearRoomType || '—'))), (() => {
      const difficulties = module.difficulties || {};
      const activeDifficulties = Object.entries(difficulties).filter(([_, v]) => v);
      if (activeDifficulties.length === 0) return null;
      return /*#__PURE__*/React.createElement("div", {
        className: "flex justify-center gap-0.5 py-0.5"
      }, activeDifficulties.map(([key]) => /*#__PURE__*/React.createElement("div", {
        key: key,
        className: "w-2.5 h-2.5 rounded-full",
        style: {
          backgroundColor: difficultyColors[key]
        },
        title: difficultyLabels[key]
      })));
    })()), station.id === 'sign-off' ?
    /*#__PURE__*/
    // Sign-Off station: 0%/100%/Hold buttons
    React.createElement("div", {
      className: "flex gap-0.5 mt-1"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        if (canEdit) {
          updateModuleProgress(module.id, module.projectId, station.id, 0);
          // Clear hold status if set
          if (module.isOnHold) {
            setProjects(prev => prev.map(p => ({
              ...p,
              modules: p.modules.map(m => m.id === module.id ? {
                ...m,
                isOnHold: false
              } : m)
            })));
          }
        }
      },
      disabled: !canEdit,
      className: `flex-1 text-xs py-0.5 rounded transition ${currentProgress === 0 && !module.isOnHold ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${!canEdit ? 'cursor-not-allowed opacity-60' : ''}`,
      title: "Reset to 0%"
    }, "0%"), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        if (canEdit) {
          updateModuleProgress(module.id, module.projectId, station.id, 100);
          // Clear hold status if set
          if (module.isOnHold) {
            setProjects(prev => prev.map(p => ({
              ...p,
              modules: p.modules.map(m => m.id === module.id ? {
                ...m,
                isOnHold: false
              } : m)
            })));
          }
        }
      },
      disabled: !canEdit,
      className: `flex-1 text-xs py-0.5 rounded transition ${isComplete && !module.isOnHold ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${!canEdit ? 'cursor-not-allowed opacity-60' : ''}`,
      title: "Mark complete (100%)"
    }, "\u2713"), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        if (canEdit) {
          // Toggle hold status
          setProjects(prev => prev.map(p => ({
            ...p,
            modules: p.modules.map(m => m.id === module.id ? {
              ...m,
              isOnHold: !m.isOnHold
            } : m)
          })));
          addToast(module.isOnHold ? `${module.serialNumber} removed from hold` : `${module.serialNumber} placed on hold`, module.isOnHold ? 'success' : 'warning', module.serialNumber, station.dept);
        }
      },
      disabled: !canEdit,
      className: `flex-1 text-xs py-0.5 rounded transition ${module.isOnHold ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${!canEdit ? 'cursor-not-allowed opacity-60' : ''}`,
      title: module.isOnHold ? "Remove from hold" : "Place on hold"
    }, "!")) :
    /*#__PURE__*/
    // Standard progress buttons for other stations
    React.createElement("div", {
      className: "flex gap-0.5 mt-1"
    }, [25, 50, 75, 100].map(pct => /*#__PURE__*/React.createElement("button", {
      key: pct,
      onClick: e => {
        e.stopPropagation();
        if (canEdit) {
          // Toggle: if clicking the current progress level, reset to previous level (or 0 for 25%)
          const newProgress = currentProgress === pct ? pct === 25 ? 0 : pct - 25 : pct;
          updateModuleProgress(module.id, module.projectId, station.id, newProgress);
        }
      },
      disabled: !canEdit,
      className: `flex-1 text-xs py-0.5 rounded transition ${currentProgress >= pct ? isComplete ? 'bg-green-500 text-white' : 'bg-autovol-teal text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${!canEdit ? 'cursor-not-allowed opacity-60' : ''}`,
      title: canEdit ? currentProgress === pct ? `Click to set to ${pct === 25 ? 0 : pct - 25}%` : `Set to ${pct}%` : 'View-only mode'
    }, pct === 100 ? '✓' : ''))));
  };

  // Get day labels for date markers based on schedule setup
  const getDayLabels = () => {
    const days = [];
    const shift1Days = ['monday', 'tuesday', 'wednesday', 'thursday'];
    const dayNames = {
      monday: 'Mon',
      tuesday: 'Tue',
      wednesday: 'Wed',
      thursday: 'Thu',
      friday: 'Fri',
      saturday: 'Sat',
      sunday: 'Sun'
    };
    let moduleNum = 1;
    shift1Days.forEach(day => {
      // Use displayWeek's shift config when viewing a specific week, fallback to scheduleSetup
      const count = displayWeek?.shift1?.[day] ?? scheduleSetup?.shift1?.[day] ?? 0;
      if (count > 0) {
        // Calculate date for this day
        const weekStart = displayWeek?.weekStart ? parseLocalDate(displayWeek.weekStart) : new Date();
        const dayOffset = shift1Days.indexOf(day);
        const dayDate = new Date(weekStart);
        dayDate.setDate(dayDate.getDate() + dayOffset);
        const monthStr = dayDate.toLocaleDateString('en-US', {
          month: 'short'
        });
        const dayNum = dayDate.getDate();

        // Create an entry for each module slot on this day
        for (let i = 0; i < count; i++) {
          days.push({
            day,
            label: dayNames[day],
            monthStr,
            dayNum,
            slotNum: i + 1,
            moduleNum: moduleNum++
          });
        }
      }
    });
    return days;
  };
  const dayLabels = getDayLabels();

  // Get reference counts from first station (for grid alignment)
  const firstStation = productionStages[0];
  const firstStationModules = firstStation ? getModulesForStation(firstStation) : {
    previous: [],
    current: [],
    next: []
  };
  const expectedPrevCount = firstStationModules.previous.length;
  const expectedNextCount = firstStationModules.next.length;

  // Render placeholder card for empty slots (compact style)
  const renderPlaceholderCard = weekSection => {
    const borderClass = weekSection === 'previous' ? 'border-red-200' : weekSection === 'next' ? 'border-green-200' : 'border-gray-200';
    const bgClass = weekSection === 'previous' ? 'bg-red-50/50' : weekSection === 'next' ? 'bg-green-50/30' : 'bg-gray-50';
    return /*#__PURE__*/React.createElement("div", {
      className: `rounded p-1.5 ${bgClass} border border-dashed ${borderClass}`,
      style: {
        height: `${CARD_HEIGHT}px`
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-center h-full text-gray-300 text-xs"
    }, "\u2014"));
  };

  // Render station column with previous/current/next sections
  const renderStationColumn = station => {
    const {
      previous,
      current,
      next
    } = getModulesForStation(station);
    const startingModule = getStationStartingModule(station.id);
    const hasModules = previous.length > 0 || current.length > 0 || next.length > 0;
    const capacityInfo = getStationCapacityInfo[station.id] || {
      capacity: 5,
      inProgress: 0,
      complete: 0,
      loadPercent: 0,
      status: 'under'
    };

    // Capacity bar colors based on status
    const capacityBarColor = capacityInfo.status === 'over' ? 'bg-red-400' : capacityInfo.status === 'at' ? 'bg-yellow-400' : 'bg-green-400';
    const capacityBgColor = capacityInfo.status === 'over' ? 'bg-red-200' : capacityInfo.status === 'at' ? 'bg-yellow-200' : 'bg-white/30';
    return /*#__PURE__*/React.createElement("div", {
      key: station.id,
      className: "flex-shrink-0 w-36 flex flex-col"
    }, /*#__PURE__*/React.createElement("div", {
      className: `${station.color} text-white px-2 py-2 text-center rounded-t-lg sticky top-0 z-20`,
      style: {
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-semibold text-xs truncate",
      title: station.name
    }, station.dept), /*#__PURE__*/React.createElement("div", {
      className: "text-xs opacity-80"
    }, "Start: ", startingModule?.serialNumber?.slice(-4) || '—'), /*#__PURE__*/React.createElement("div", {
      className: "mt-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: `h-1.5 rounded-full ${capacityBgColor} overflow-hidden`
    }, /*#__PURE__*/React.createElement("div", {
      className: `h-full ${capacityBarColor} transition-all duration-300`,
      style: {
        width: `${capacityInfo.loadPercent}%`
      }
    })), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between text-xs mt-0.5 opacity-90"
    }, /*#__PURE__*/React.createElement("span", null, capacityInfo.inProgress, "/", capacityInfo.capacity), /*#__PURE__*/React.createElement("span", null, capacityInfo.complete, "\u2713")))), /*#__PURE__*/React.createElement("div", {
      className: "bg-white min-h-80 p-1 space-y-1 border-x border-b border-gray-200"
    }, !hasModules && expectedPrevCount === 0 && expectedNextCount === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-400 text-center py-8"
    }, "No modules") : /*#__PURE__*/React.createElement(React.Fragment, null, expectedPrevCount > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, Array.from({
      length: expectedPrevCount
    }).map((_, idx) => /*#__PURE__*/React.createElement(React.Fragment, {
      key: `prev-${idx}`
    }, previous[idx] ? renderModuleCard(previous[idx], station, 'previous') : renderPlaceholderCard('previous'))), /*#__PURE__*/React.createElement("div", {
      className: "border-t-2 border-dashed border-red-300 my-1"
    })), current.map(module => renderModuleCard(module, station, 'current')), expectedNextCount > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "border-t-2 border-dashed border-green-300 my-1"
    }), Array.from({
      length: expectedNextCount
    }).map((_, idx) => /*#__PURE__*/React.createElement(React.Fragment, {
      key: `next-${idx}`
    }, next[idx] ? renderModuleCard(next[idx], station, 'next') : renderPlaceholderCard('next')))))));
  };

  // Render date marker column (sticky left side) - aligned with station columns
  const renderDateMarkerColumn = () => {
    // Use the same reference counts as station columns
    const {
      previous,
      current,
      next
    } = firstStationModules;
    return /*#__PURE__*/React.createElement("div", {
      className: "flex-shrink-0 w-20 sticky left-0 z-30 bg-white flex flex-col",
      style: {
        boxShadow: '4px 0 8px rgba(0,0,0,0.08)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-autovol-navy text-white px-2 py-2 text-center rounded-tl-lg sticky top-0 z-30",
      style: {
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-semibold text-xs"
    }, "Day"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs opacity-80"
    }, "Date"), /*#__PURE__*/React.createElement("div", {
      className: "mt-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-1.5"
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between text-xs mt-0.5 opacity-0"
    }, /*#__PURE__*/React.createElement("span", null, "0/0"), /*#__PURE__*/React.createElement("span", null, "0")))), /*#__PURE__*/React.createElement("div", {
      className: "bg-white min-h-80 p-1 space-y-1 border-l border-b border-gray-200"
    }, previous.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, previous.map((_, idx) => /*#__PURE__*/React.createElement("div", {
      key: `prev-${idx}`,
      className: "rounded border border-red-300 bg-red-50 flex items-center justify-center text-center",
      style: {
        height: `${CARD_HEIGHT}px`
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-red-600"
    }, "PREV"))), /*#__PURE__*/React.createElement("div", {
      className: "border-t border-dashed border-red-300 my-0.5"
    })), dayLabels.map((dayInfo, idx) => /*#__PURE__*/React.createElement("div", {
      key: `${dayInfo.day}-${dayInfo.slotNum}`,
      className: "rounded border border-autovol-teal bg-white flex flex-col items-center justify-center text-center",
      style: {
        height: `${CARD_HEIGHT}px`
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-autovol-navy"
    }, dayInfo.label), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, dayInfo.monthStr, " ", dayInfo.dayNum))), next.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "border-t border-dashed border-green-300 my-0.5"
    }), next.map((_, idx) => /*#__PURE__*/React.createElement("div", {
      key: `next-${idx}`,
      className: "rounded border border-green-300 bg-green-50 flex items-center justify-center text-center",
      style: {
        height: `${CARD_HEIGHT}px`
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-green-600"
    }, "NEXT"))))));
  };

  // Show configuration prompt if week not set up
  if (!hasWeekConfig) {
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between flex-wrap gap-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-semibold text-autovol-navy"
    }, "Weekly Board"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, "Line Balance: ", lineBalance, " modules/week (from Schedule Setup)")), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowHistoryModal(true),
      className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
    }, "\uD83D\uDCCA Week History")), /*#__PURE__*/React.createElement("div", {
      className: "bg-amber-50 border-2 border-amber-300 rounded-xl p-8 text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-4xl mb-4"
    }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("h4", {
      className: "text-xl font-bold text-amber-800 mb-2"
    }, "Week Schedule Not Loaded"), /*#__PURE__*/React.createElement("p", {
      className: "text-amber-700 mb-6 max-w-md mx-auto"
    }, "To populate the Weekly Board, you need to configure a production week with a starting module. This tells the system which modules to display at each station."), /*#__PURE__*/React.createElement("div", {
      className: "space-y-3"
    }, !currentWeek ? /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg p-4 border border-amber-200 max-w-sm mx-auto"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600 mb-3"
    }, /*#__PURE__*/React.createElement("strong", null, "Step 1:"), " Create a production week schedule"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setProductionTab?.('schedule-setup'),
      className: "w-full px-4 py-2 btn-primary rounded-lg font-medium"
    }, "Go to Schedule Setup \u2192")) : /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg p-4 border border-amber-200 max-w-sm mx-auto"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600 mb-2"
    }, /*#__PURE__*/React.createElement("strong", null, "Week Found:"), " ", currentWeek.weekStart, " to ", currentWeek.weekEnd), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-red-600 mb-3"
    }, "\u26A0\uFE0F Missing starting module. Please edit the week to add one."), /*#__PURE__*/React.createElement("button", {
      onClick: () => setProductionTab?.('schedule-setup'),
      className: "w-full px-4 py-2 btn-primary rounded-lg font-medium"
    }, "Edit Week Schedule \u2192")), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-4"
    }, "Tip: The starting module determines which modules appear at AUTO-C/AUTO-F/AUTO-W. Other stations will show modules based on their stagger offset."))), showHistoryModal && /*#__PURE__*/React.createElement(WeekHistoryModal, {
      completedWeeks: completedWeeks,
      onClose: () => setShowHistoryModal(false)
    }));
  }

  // ===== MOBILE VIEW =====
  // Show simplified swipeable view on mobile devices
  if (isMobile) {
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-semibold text-autovol-navy"
    }, "Weekly Board"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500"
    }, "Week: ", displayWeek?.weekStart || 'Not set', " \u2022 ", lineBalance, " modules")), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowHistoryModal(true),
      className: "p-2 bg-gray-100 rounded-lg",
      title: "Week History"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-history",
      style: {
        width: '20px',
        height: '20px',
        display: 'inline-block'
      }
    }))), /*#__PURE__*/React.createElement(MobileWeeklyBoardView, {
      productionStages: productionStages,
      getModulesForStation: getModulesForStation,
      getStationStartingModule: getStationStartingModule,
      getStationCapacityInfo: getStationCapacityInfo,
      onModuleClick: onModuleClick,
      canEdit: canEdit
    }), showHistoryModal && /*#__PURE__*/React.createElement(WeekHistoryModal, {
      completedWeeks: completedWeeks,
      onClose: () => setShowHistoryModal(false)
    }));
  }

  // Helper function to navigate weeks
  const navigateWeek = direction => {
    const sortedWeeks = [...weeks].sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
    const currentIndex = sortedWeeks.findIndex(w => w.id === (selectedWeekId || currentWeek?.id));
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < sortedWeeks.length) {
      setSelectedWeekId(sortedWeeks[newIndex].id);
    }
  };

  // Pop-out mode: Show only the grid with week navigation
  if (isPopout) {
    return /*#__PURE__*/React.createElement("div", {
      className: "h-full flex flex-col p-4 bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-3 px-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => navigateWeek(-1),
      className: "p-2 bg-white hover:bg-gray-100 rounded-lg border shadow-sm transition",
      title: "Previous Week"
    }, /*#__PURE__*/React.createElement("svg", {
      width: "20",
      height: "20",
      viewBox: "0 0 24 24",
      fill: "none",
      stroke: "currentColor",
      strokeWidth: "2"
    }, /*#__PURE__*/React.createElement("polyline", {
      points: "15 18 9 12 15 6"
    }))), /*#__PURE__*/React.createElement("div", {
      className: "text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-sm font-semibold text-autovol-navy"
    }, displayWeek ? /*#__PURE__*/React.createElement(React.Fragment, null, parseLocalDate(displayWeek.weekStart).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    }), ' - ', parseLocalDate(displayWeek.weekEnd).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    })) : 'No Week Selected'), currentWeek?.id === displayWeek?.id && /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-green-600 font-medium"
    }, "Current Week")), /*#__PURE__*/React.createElement("button", {
      onClick: () => navigateWeek(1),
      className: "p-2 bg-white hover:bg-gray-100 rounded-lg border shadow-sm transition",
      title: "Next Week"
    }, /*#__PURE__*/React.createElement("svg", {
      width: "20",
      height: "20",
      viewBox: "0 0 24 24",
      fill: "none",
      stroke: "currentColor",
      strokeWidth: "2"
    }, /*#__PURE__*/React.createElement("polyline", {
      points: "9 18 15 12 9 6"
    })))), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-1 flex-1 min-h-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-[140px] flex-shrink-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white border rounded-lg shadow-sm h-full flex flex-col"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-autovol-navy text-white px-3 py-2 rounded-t-lg"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-semibold text-sm"
    }, "Modules On Board"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs opacity-80"
    }, getModulesOnBoard.length, " modules")), /*#__PURE__*/React.createElement("div", {
      className: "px-2 py-2 border-b bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 font-medium mb-1"
    }, "Difficulty Indicators:"), /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-1"
    }, Object.entries(difficultyLabels).map(([key, label]) => /*#__PURE__*/React.createElement("div", {
      key: key,
      className: "flex items-center gap-0.5",
      title: label
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-2 h-2 rounded-full",
      style: {
        backgroundColor: difficultyColors[key]
      }
    }), /*#__PURE__*/React.createElement("span", {
      className: "text-[9px] text-gray-500"
    }, label))))), /*#__PURE__*/React.createElement("div", {
      className: "overflow-y-auto p-2 space-y-2 flex-1"
    }, getModulesOnBoard.map((module, idx) => {
      const difficulties = module.difficulties || {};
      const activeDifficulties = Object.entries(difficulties).filter(([_, v]) => v);
      const sectionColor = module.section === 'previous' ? 'border-l-red-400' : module.section === 'next' ? 'border-l-green-400' : 'border-l-blue-400';
      return /*#__PURE__*/React.createElement("div", {
        key: module.id || idx,
        className: `bg-white border rounded shadow-sm text-xs cursor-pointer hover:shadow-md transition border-l-4 ${sectionColor}`,
        onClick: () => {
          const moduleCard = document.querySelector(`[data-module-serial="${module.serialNumber}"]`);
          if (moduleCard) {
            moduleCard.scrollIntoView({
              behavior: 'smooth',
              block: 'center',
              inline: 'center'
            });
            moduleCard.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => moduleCard.classList.remove('ring-2', 'ring-blue-500'), 2000);
          }
        },
        title: "Click to highlight on board"
      }, /*#__PURE__*/React.createElement("div", {
        className: "bg-gray-100 px-2 py-1 font-mono font-bold text-center border-b"
      }, module.serialNumber?.slice(-7) || 'N/A'), /*#__PURE__*/React.createElement("div", {
        className: "grid grid-cols-2 divide-x text-center"
      }, /*#__PURE__*/React.createElement("div", {
        className: "p-1"
      }, /*#__PURE__*/React.createElement("div", {
        className: "text-[9px] text-gray-400 font-medium"
      }, "(H)"), /*#__PURE__*/React.createElement("div", {
        className: "font-mono text-[10px] font-semibold truncate",
        title: module.hitchBLM
      }, module.hitchBLM || '—')), /*#__PURE__*/React.createElement("div", {
        className: "p-1"
      }, /*#__PURE__*/React.createElement("div", {
        className: "text-[9px] text-gray-400 font-medium"
      }, "(R)"), /*#__PURE__*/React.createElement("div", {
        className: "font-mono text-[10px] font-semibold truncate",
        title: module.rearBLM
      }, module.rearBLM || '—'))), activeDifficulties.length > 0 && /*#__PURE__*/React.createElement("div", {
        className: "flex justify-center gap-1 py-1 border-t bg-gray-50"
      }, activeDifficulties.map(([key]) => /*#__PURE__*/React.createElement("div", {
        key: key,
        className: "w-3 h-3 rounded-full",
        style: {
          backgroundColor: difficultyColors[key]
        },
        title: difficultyLabels[key]
      }))));
    }), getModulesOnBoard.length === 0 && /*#__PURE__*/React.createElement("div", {
      className: "text-center text-gray-400 py-4 text-xs"
    }, "No modules on board")))), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 relative min-h-0",
      ref: boardRef,
      tabIndex: 0,
      onKeyDown: handleBoardKeyDown
    }, /*#__PURE__*/React.createElement("div", {
      className: "board-scroll-container overflow-auto h-full scrollbar-visible",
      style: {
        scrollbarWidth: 'auto',
        scrollbarColor: '#94a3b8 #f1f5f9'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex gap-1 min-w-max"
    }, renderDateMarkerColumn(), productionStages.map(station => renderStationColumn(station)))))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4 text-xs text-gray-600 flex-wrap mt-3 pt-3 border-t bg-white rounded-lg px-4 py-2 shadow-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Status:"), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 border rounded bg-gray-50 border-gray-200"
    }), /*#__PURE__*/React.createElement("span", null, "Pending")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 border rounded bg-white border-autovol-teal"
    }), /*#__PURE__*/React.createElement("span", null, "In Progress")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 border rounded bg-green-50 border-green-300"
    }), /*#__PURE__*/React.createElement("span", null, "Complete")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 border-2 rounded bg-red-50/30 border-red-300"
    }), /*#__PURE__*/React.createElement("span", null, "Previous")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 border-2 rounded bg-green-50/30 border-green-300"
    }), /*#__PURE__*/React.createElement("span", null, "Next")), /*#__PURE__*/React.createElement("span", {
      className: "font-medium ml-2"
    }, "Capacity:"), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-6 h-1.5 rounded-full bg-green-400"
    }), /*#__PURE__*/React.createElement("span", null, "Under")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-6 h-1.5 rounded-full bg-yellow-400"
    }), /*#__PURE__*/React.createElement("span", null, "At Limit")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1.5"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-6 h-1.5 rounded-full bg-red-400"
    }), /*#__PURE__*/React.createElement("span", null, "Over"))), selectedModules.size > 0 && !isFeatureHiddenOnMobile('bulkOperations') && /*#__PURE__*/React.createElement("div", {
      className: "fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-white rounded-xl shadow-2xl border-2 border-blue-500 p-3 flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-white font-bold text-sm"
    }, selectedModules.size)), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-gray-700"
    }, "selected")), /*#__PURE__*/React.createElement("div", {
      className: "h-8 w-px bg-gray-300"
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-0.5"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-500 mr-2"
    }, "Set to:"), [25, 50, 75, 100].map(value => /*#__PURE__*/React.createElement("button", {
      key: value,
      onClick: () => bulkUpdateProgress(value),
      className: `flex-1 text-xs py-1.5 px-3 rounded transition ${value === 100 ? 'bg-gray-200 hover:bg-green-500 hover:text-white' : 'bg-gray-200 hover:bg-autovol-teal hover:text-white'}`,
      title: `Set all to ${value}%`
    }, value === 100 ? '✓' : '')), /*#__PURE__*/React.createElement("button", {
      onClick: () => bulkUpdateProgress(0),
      className: "text-xs py-1.5 px-2 rounded bg-gray-200 hover:bg-red-400 hover:text-white transition ml-1",
      title: "Reset all to 0%"
    }, "X")), /*#__PURE__*/React.createElement("div", {
      className: "h-8 w-px bg-gray-300"
    }), /*#__PURE__*/React.createElement("button", {
      onClick: clearSelection,
      className: "px-3 py-2 text-sm text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all",
      title: "Clear selection (Esc)"
    }, "X Clear")), activePrompt && /*#__PURE__*/React.createElement(ModuleCardPrompt, {
      module: activePrompt.module,
      station: activePrompt.station,
      position: activePrompt.position,
      onClose: () => setActivePrompt(null),
      onUpdateProgress: progress => {
        handleProgressUpdate(activePrompt.module, activePrompt.station.id, progress);
        setActivePrompt(null);
      },
      onViewDetails: () => {
        onModuleClick?.(activePrompt.module);
        setActivePrompt(null);
      },
      canEdit: canEdit
    }));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, activePlacementMode && !isFeatureHiddenOnMobile('prototypePlacement') && /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 border-2 border-green-400 rounded-lg px-4 py-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-500 text-xl"
  }, "\u2605"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-green-800"
  }, "Placement Mode: ", activePlacementMode.serialNumber), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-green-700"
  }, "Click on a module to insert the prototype after it. The green line shows where it will be placed."))), /*#__PURE__*/React.createElement("button", {
    onClick: handleCancelPlacement,
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium"
  }, "Cancel")), !canEdit && !activePlacementMode && /*#__PURE__*/React.createElement("div", {
    className: "bg-amber-50 border border-amber-300 rounded-lg px-4 py-3 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, "\uD83D\uDC41\uFE0F"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-amber-800"
  }, "View-Only Mode"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-amber-700"
  }, "You have read-only access to this tab. Contact an administrator to request edit permissions."))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Weekly Board"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Starting: ", /*#__PURE__*/React.createElement("span", {
    className: "font-mono"
  }, displayWeek.startingModule), " \u2022 Line Balance: ", lineBalance, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "relative flex items-center gap-1"
  }, !isFeatureHiddenOnMobile('weekNavArrows') && /*#__PURE__*/React.createElement("button", {
    onClick: () => navigateWeek(-1),
    disabled: (() => {
      const sortedWeeks = [...weeks].sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
      const currentIndex = sortedWeeks.findIndex(w => w.id === (selectedWeekId || currentWeek?.id));
      return currentIndex <= 0;
    })(),
    className: "p-2 bg-white hover:bg-gray-100 rounded-lg border shadow-sm transition disabled:opacity-30 disabled:cursor-not-allowed",
    title: "Previous Week"
  }, /*#__PURE__*/React.createElement("svg", {
    width: "16",
    height: "16",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2"
  }, /*#__PURE__*/React.createElement("polyline", {
    points: "15 18 9 12 15 6"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowWeekPicker(!showWeekPicker),
    className: "flex items-center gap-2 border rounded-lg px-3 py-2 text-sm font-medium bg-white hover:bg-gray-50 transition"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "\uD83D\uDCC5"), displayWeek ? /*#__PURE__*/React.createElement("span", null, parseLocalDate(displayWeek.weekStart).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  }), ' - ', parseLocalDate(displayWeek.weekEnd).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  })) : /*#__PURE__*/React.createElement("span", null, "Select Week"), currentWeek?.id === displayWeek?.id && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 bg-green-500 text-white text-xs rounded"
  }, "Current"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "\u25BE")), !isFeatureHiddenOnMobile('weekNavArrows') && /*#__PURE__*/React.createElement("button", {
    onClick: () => navigateWeek(1),
    disabled: (() => {
      const sortedWeeks = [...weeks].sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
      const currentIndex = sortedWeeks.findIndex(w => w.id === (selectedWeekId || currentWeek?.id));
      return currentIndex >= sortedWeeks.length - 1;
    })(),
    className: "p-2 bg-white hover:bg-gray-100 rounded-lg border shadow-sm transition disabled:opacity-30 disabled:cursor-not-allowed",
    title: "Next Week"
  }, /*#__PURE__*/React.createElement("svg", {
    width: "16",
    height: "16",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2"
  }, /*#__PURE__*/React.createElement("polyline", {
    points: "9 18 15 12 9 6"
  }))), showWeekPicker && /*#__PURE__*/React.createElement(CalendarWeekPicker, {
    weeks: weeks,
    currentWeek: currentWeek,
    selectedWeekId: selectedWeekId,
    onSelectWeek: setSelectedWeekId,
    onClose: () => setShowWeekPicker(false)
  }), selectedWeekId && selectedWeekId !== currentWeek?.id && /*#__PURE__*/React.createElement("button", {
    onClick: () => setSelectedWeekId(null),
    className: "text-xs text-blue-600 hover:text-blue-800 underline ml-2"
  }, "Back to Current"))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center border rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setBoardViewMode('compact'),
    className: `px-3 py-2 text-sm font-medium transition ${boardViewMode === 'compact' ? 'bg-autovol-navy text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`,
    title: "Compact view - Serial number only"
  }, "Compact"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setBoardViewMode('detailed'),
    className: `px-3 py-2 text-sm font-medium transition ${boardViewMode === 'detailed' ? 'bg-autovol-navy text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`,
    title: "Detailed view - Full module info"
  }, "Detailed")), canEdit && !reorderMode && !isFeatureHiddenOnMobile('reorderMode') && /*#__PURE__*/React.createElement("button", {
    onClick: () => setReorderMode(true),
    className: "px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 rounded-lg text-sm font-medium",
    title: "Enter reorder mode to drag and drop modules"
  }, "Reorder"), canEdit && reorderMode && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: cancelReorderMode,
    className: "px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowReorderConfirm(true),
    disabled: pendingReorders.length === 0,
    className: "px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Apply (", pendingReorders.length, ")")), canEdit && !isFeatureHiddenOnMobile('editWeekButton') && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      if (onEditWeek && displayWeek?.id) {
        onEditWeek(displayWeek.id);
      } else {
        setProductionTab?.('schedule-setup');
      }
    },
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium",
    title: "Change week configuration"
  }, "Edit Week"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowHistoryModal(true),
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
  }, "\uD83D\uDCCA Week History"), !isPopout && !isFeatureHiddenOnMobile('popoutWindow') && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const popoutUrl = window.location.origin + '/weekly-board-popout.html';
      const popoutWindow = window.open(popoutUrl, 'WeeklyBoardPopout', 'width=1400,height=900,menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes');
      if (!popoutWindow) {
        addToast('Please allow popups to open the Weekly Board in a new window', 'error');
      }
    },
    className: "px-4 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 rounded-lg text-sm font-medium flex items-center gap-1",
    title: "Open Weekly Board in a separate window"
  }, /*#__PURE__*/React.createElement("svg", {
    width: "14",
    height: "14",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "15 3 21 3 21 9"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "10",
    y1: "14",
    x2: "21",
    y2: "3"
  })), "Pop Out"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      if (!confirm('Mark ALL modules on the board as 100% complete at ALL stations?')) return;
      const ALL_STAGES = ['auto-c', 'auto-f', 'auto-walls', 'mezzanine', 'elec-ceiling', 'wall-set', 'ceiling-set', 'soffits', 'mech-rough', 'elec-rough', 'plumb-rough', 'exteriors', 'drywall-bp', 'drywall-ttp', 'roofing', 'pre-finish', 'mech-trim', 'elec-trim', 'plumb-trim', 'final-finish', 'sign-off', 'close-up'];
      const fullProgress = {};
      ALL_STAGES.forEach(stage => fullProgress[stage] = 100);

      // Get all module IDs currently on the board
      const boardModuleIds = new Set(allModules.map(m => m.id));

      // Update all projects that have modules on the board
      setProjects(prev => prev.map(project => ({
        ...project,
        modules: (project.modules || []).map(m => boardModuleIds.has(m.id) ? {
          ...m,
          stageProgress: fullProgress
        } : m)
      })));
      addToast(`Marked ${boardModuleIds.size} modules as 100% complete`, 'success');
    },
    className: "px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium",
    title: "TEMPORARY: Mark all board modules complete"
  }, "Mark All Complete"), canEdit && !isFeatureHiddenOnMobile('completeWeekButton') && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowCompleteModal(true),
    className: "px-4 py-2 btn-primary rounded-lg text-sm font-medium"
  }, "Week Complete"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border p-3 shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 font-medium uppercase"
  }, "This Week"), /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\uD83D\uDCCA")), /*#__PURE__*/React.createElement("div", {
    className: "mt-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold text-autovol-navy"
  }, Object.values(getStationCapacityInfo).reduce((sum, s) => sum + s.complete, 0)), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500 ml-1"
  }, "/ ", lineBalance)), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mt-1"
  }, "modules completed")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border p-3 shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 font-medium uppercase"
  }, "In Progress"), /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\uD83D\uDD04")), /*#__PURE__*/React.createElement("div", {
    className: "mt-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold text-blue-600"
  }, Object.values(getStationCapacityInfo).reduce((sum, s) => sum + s.inProgress, 0))), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mt-1"
  }, "across all stations")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border p-3 shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 font-medium uppercase"
  }, "Completion Rate"), /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\uD83D\uDCC8")), (() => {
    // Count modules that are 100% complete at ALL stations (truly finished)
    const fullyCompleteModules = getRecentlyCompleted().length;
    const rate = lineBalance > 0 ? Math.round(fullyCompleteModules / lineBalance * 100) : 0;
    const rateColor = rate >= 80 ? 'text-green-600' : rate >= 50 ? 'text-yellow-600' : 'text-red-600';
    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "mt-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: `text-2xl font-bold ${rateColor}`
    }, rate, "%")), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, fullyCompleteModules, "/", lineBalance, " modules done"));
  })()), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border p-3 shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 font-medium uppercase"
  }, "Station Status"), /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "\uD83C\uDFED")), (() => {
    const overCount = Object.values(getStationCapacityInfo).filter(s => s.status === 'over').length;
    const atCount = Object.values(getStationCapacityInfo).filter(s => s.status === 'at').length;
    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "mt-1 flex items-center gap-2"
    }, overCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-bold text-red-600"
    }, overCount, " over"), atCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-bold text-yellow-600"
    }, atCount, " at limit"), overCount === 0 && atCount === 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-bold text-green-600"
    }, "All clear")), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, "capacity status"));
  })())), (() => {
    const twoWeeksBalance = lineBalance * 2;
    const currentStartIdx = getAutoCalculatedStartingIndex;
    const remainingModules = allModules.length - currentStartIdx;
    if (remainingModules >= twoWeeksBalance || allModules.length === 0) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-orange-50 border-2 border-orange-300 rounded-lg p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl"
    }, "\u26A0\uFE0F"), /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-bold text-orange-800"
    }, "Running Low on Scheduled Modules"), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-orange-700 mt-1"
    }, "Only ", /*#__PURE__*/React.createElement("strong", null, remainingModules), " modules remaining (less than 2 weeks at current line balance of ", lineBalance, "/week)."), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-orange-600 mt-2"
    }, "Consider scheduling the next project online to ensure continuous production."))));
  })(), (() => {
    const overloadedStations = productionStages.filter(s => getStationCapacityInfo[s.id]?.status === 'over');
    if (overloadedStations.length === 0) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-red-50 border-2 border-red-300 rounded-lg p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl"
    }, "\u26A0\uFE0F"), /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-bold text-red-800"
    }, "Schedule Conflict Detected"), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-red-700 mt-1"
    }, overloadedStations.length, " station", overloadedStations.length > 1 ? 's are' : ' is', " over capacity:"), /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-2 mt-2"
    }, overloadedStations.map(station => {
      const info = getStationCapacityInfo[station.id];
      return /*#__PURE__*/React.createElement("div", {
        key: station.id,
        className: "bg-white border border-red-300 rounded px-3 py-1.5 text-sm"
      }, /*#__PURE__*/React.createElement("span", {
        className: "font-semibold text-red-800"
      }, station.dept), /*#__PURE__*/React.createElement("span", {
        className: "text-red-600 ml-2"
      }, info.inProgress, "/", info.capacity, " active"), /*#__PURE__*/React.createElement("span", {
        className: "text-red-500 ml-1 text-xs"
      }, "(+", info.inProgress - info.capacity, " over)"));
    })), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-red-600 mt-2"
    }, "\uD83D\uDCA1 Consider moving modules to next week or adjusting station capacity in Schedule Setup."))));
  })(), /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 border border-green-200 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-green-700 font-medium text-sm mb-2"
  }, /*#__PURE__*/React.createElement("span", null, "\u2705 Fully Completed (All Stations)")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 flex-wrap"
  }, getRecentlyCompleted().map((module, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "bg-white border border-green-300 rounded px-2 py-1 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-mono font-bold"
  }, module.serialNumber), /*#__PURE__*/React.createElement("span", {
    className: "text-green-600 ml-1"
  }, "\u2713 Done"))), getRecentlyCompleted().length === 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, "No modules fully completed yet (100% at all stations)"))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-[140px] flex-shrink-0 no-print"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white border rounded-lg shadow-sm sticky top-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-navy text-white px-3 py-2 rounded-t-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-sm"
  }, "Modules On Board"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs opacity-80"
  }, getModulesOnBoard.length, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "px-2 py-2 border-b bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 font-medium mb-1"
  }, "Difficulty Indicators:"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-1"
  }, Object.entries(difficultyLabels).map(([key, label]) => /*#__PURE__*/React.createElement("div", {
    key: key,
    className: "flex items-center gap-0.5",
    title: label
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-2 h-2 rounded-full",
    style: {
      backgroundColor: difficultyColors[key]
    }
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-[9px] text-gray-500"
  }, label))))), /*#__PURE__*/React.createElement("div", {
    className: "overflow-y-auto p-2 space-y-2",
    style: {
      maxHeight: 'calc(100vh - 450px)',
      minHeight: '300px'
    }
  }, getModulesOnBoard.map((module, idx) => {
    const difficulties = module.difficulties || {};
    const activeDifficulties = Object.entries(difficulties).filter(([_, v]) => v);
    const sectionColor = module.section === 'previous' ? 'border-l-red-400' : module.section === 'next' ? 'border-l-green-400' : 'border-l-blue-400';
    return /*#__PURE__*/React.createElement("div", {
      key: module.id || idx,
      className: `bg-white border rounded shadow-sm text-xs cursor-pointer hover:shadow-md transition border-l-4 ${sectionColor}`,
      onClick: () => {
        // Scroll to this module on the board
        const moduleCard = document.querySelector(`[data-module-serial="${module.serialNumber}"]`);
        if (moduleCard) {
          moduleCard.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'center'
          });
          moduleCard.classList.add('ring-2', 'ring-blue-500');
          setTimeout(() => moduleCard.classList.remove('ring-2', 'ring-blue-500'), 2000);
        }
      },
      title: "Click to highlight on board"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-100 px-2 py-1 font-mono font-bold text-center border-b"
    }, module.serialNumber?.slice(-7) || 'N/A'), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 divide-x text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-400 font-medium"
    }, "(H)"), /*#__PURE__*/React.createElement("div", {
      className: "font-mono text-[10px] font-semibold truncate",
      title: module.hitchBLM
    }, module.hitchBLM || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-600 truncate",
      title: module.hitchUnit
    }, module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-500 truncate",
      title: module.hitchRoomType
    }, module.hitchRoomType || '—')), /*#__PURE__*/React.createElement("div", {
      className: "p-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-400 font-medium"
    }, "(R)"), /*#__PURE__*/React.createElement("div", {
      className: "font-mono text-[10px] font-semibold truncate",
      title: module.rearBLM
    }, module.rearBLM || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-600 truncate",
      title: module.rearUnit
    }, module.rearUnit || module.hitchUnit || '—'), /*#__PURE__*/React.createElement("div", {
      className: "text-[9px] text-gray-500 truncate",
      title: module.rearRoomType
    }, module.rearRoomType || '—'))), activeDifficulties.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "flex justify-center gap-1 py-1 border-t bg-gray-50"
    }, activeDifficulties.map(([key]) => /*#__PURE__*/React.createElement("div", {
      key: key,
      className: "w-3 h-3 rounded-full",
      style: {
        backgroundColor: difficultyColors[key]
      },
      title: difficultyLabels[key]
    }))));
  }), getModulesOnBoard.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center text-gray-400 py-4 text-xs"
  }, "No modules on board")))), /*#__PURE__*/React.createElement("div", {
    id: "weekly-board-print-area",
    className: "relative flex-1 min-w-0",
    ref: boardRef,
    tabIndex: 0,
    onKeyDown: handleBoardKeyDown
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2 no-print"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-sm text-gray-500"
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDCA1"), /*#__PURE__*/React.createElement("span", null, "Use ", /*#__PURE__*/React.createElement("kbd", {
    className: "px-1.5 py-0.5 bg-gray-100 rounded text-xs font-mono"
  }, "\u2190"), " ", /*#__PURE__*/React.createElement("kbd", {
    className: "px-1.5 py-0.5 bg-gray-100 rounded text-xs font-mono"
  }, "\u2192"), " arrow keys to scroll")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const scrollContainer = boardRef.current?.querySelector('.board-scroll-container');
      if (scrollContainer) scrollContainer.scrollBy({
        left: -300,
        behavior: 'smooth'
      });
    },
    className: "px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm",
    title: "Scroll left"
  }, "\u2190 Prev"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const scrollContainer = boardRef.current?.querySelector('.board-scroll-container');
      if (scrollContainer) scrollContainer.scrollBy({
        left: 300,
        behavior: 'smooth'
      });
    },
    className: "px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm",
    title: "Scroll right"
  }, "Next \u2192"))), /*#__PURE__*/React.createElement("div", {
    className: "board-scroll-container overflow-auto pb-4 scrollbar-visible",
    style: {
      scrollbarWidth: 'auto',
      scrollbarColor: '#94a3b8 #f1f5f9',
      maxHeight: 'calc(100vh - 350px)',
      minHeight: '400px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1 min-w-max"
  }, renderDateMarkerColumn(), productionStages.map(station => renderStationColumn(station)))))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-6 text-sm text-gray-600 flex-wrap"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, "Status:"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 border rounded bg-gray-50 border-gray-200"
  }), /*#__PURE__*/React.createElement("span", null, "Pending")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 border rounded bg-white border-autovol-teal"
  }), /*#__PURE__*/React.createElement("span", null, "In Progress")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 border rounded bg-green-50 border-green-300"
  }), /*#__PURE__*/React.createElement("span", null, "Complete")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 border-2 rounded bg-red-50/30 border-red-300"
  }), /*#__PURE__*/React.createElement("span", null, "Previous Week")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 border-2 rounded bg-green-50/30 border-green-300"
  }), /*#__PURE__*/React.createElement("span", null, "Next Week")), /*#__PURE__*/React.createElement("span", {
    className: "font-medium ml-4"
  }, "Capacity:"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-2 rounded-full bg-green-400"
  }), /*#__PURE__*/React.createElement("span", null, "Under")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-2 rounded-full bg-yellow-400"
  }), /*#__PURE__*/React.createElement("span", null, "At Limit")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-2 rounded-full bg-red-400"
  }), /*#__PURE__*/React.createElement("span", null, "Over"))), selectedModules.size > 0 && /*#__PURE__*/React.createElement("div", {
    className: "fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-white rounded-xl shadow-2xl border-2 border-blue-500 p-3 flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-white font-bold text-sm"
  }, selectedModules.size)), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-700"
  }, "selected")), /*#__PURE__*/React.createElement("div", {
    className: "h-8 w-px bg-gray-300"
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-0.5"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500 mr-2"
  }, "Set to:"), [25, 50, 75, 100].map(value => /*#__PURE__*/React.createElement("button", {
    key: value,
    onClick: () => bulkUpdateProgress(value),
    className: `flex-1 text-xs py-1.5 px-3 rounded transition ${value === 100 ? 'bg-gray-200 hover:bg-green-500 hover:text-white' : 'bg-gray-200 hover:bg-autovol-teal hover:text-white'}`,
    title: `Set all to ${value}%`
  }, value === 100 ? '✓' : '')), /*#__PURE__*/React.createElement("button", {
    onClick: () => bulkUpdateProgress(0),
    className: "text-xs py-1.5 px-2 rounded bg-gray-200 hover:bg-red-400 hover:text-white transition ml-1",
    title: "Reset all to 0%"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "h-8 w-px bg-gray-300"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: clearSelection,
    className: "px-3 py-2 text-sm text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all",
    title: "Clear selection (Esc)"
  }, "\u2715 Clear")), showBulkMenu && /*#__PURE__*/React.createElement("div", {
    className: "fixed z-[100] bg-white rounded-lg shadow-2xl border border-gray-200 py-2 min-w-[160px]",
    style: {
      top: Math.min(showBulkMenu.y, window.innerHeight - 200),
      left: Math.min(showBulkMenu.x, window.innerWidth - 180)
    },
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-3 py-1 text-xs text-gray-500 font-medium border-b mb-1"
  }, "Bulk Progress (", selectedModules.size, " selected)"), [0, 25, 50, 75, 100].map(value => /*#__PURE__*/React.createElement("button", {
    key: value,
    onClick: () => bulkUpdateProgress(value),
    className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-100 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("span", null, "Set to ", value, "%"), value === 100 && /*#__PURE__*/React.createElement("span", {
    className: "text-green-500"
  }, "\u2713"))), /*#__PURE__*/React.createElement("div", {
    className: "border-t mt-1 pt-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: clearSelection,
    className: "w-full px-3 py-2 text-left text-sm text-red-500 hover:bg-red-50"
  }, "Cancel"))), showBulkMenu && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 z-[99]",
    onClick: () => setShowBulkMenu(null)
  }), showCompleteModal && /*#__PURE__*/React.createElement(WeekCompleteModal, {
    currentWeek: currentWeek,
    lineBalance: getLineBalance(),
    activeProjects: activeProjects,
    allModules: allModules,
    onComplete: (data, nextWeekId) => {
      completeWeek(data);
      setShowCompleteModal(false);
      // Auto-advance to next week if one was created
      if (nextWeekId) {
        setSelectedWeekId(nextWeekId);
        addToast('Week completed! Switched to next week.', 'success');
      } else {
        addToast('Week completed!', 'success');
      }
    },
    onClose: () => setShowCompleteModal(false),
    addWeek: addWeek
  }), showHistoryModal && /*#__PURE__*/React.createElement(WeekHistoryModal, {
    completedWeeks: completedWeeks,
    onClose: () => setShowHistoryModal(false)
  }), activePrompt && /*#__PURE__*/React.createElement(ModuleCardPrompt, {
    module: activePrompt.module,
    station: activePrompt.station,
    position: activePrompt.position,
    onClose: () => setActivePrompt(null),
    onViewDetails: module => {
      // Use the existing ModuleDetailModal from App.jsx via onModuleClick
      if (onModuleClick) {
        onModuleClick(module);
      }
    },
    onReportIssue: (module, station) => {
      if (onReportIssue) {
        onReportIssue(module, station);
      } else {
        alert(`Report Issue for ${module.serialNumber} at ${station.name}\n\nThis will open the Report Issue modal.`);
      }
    },
    onShopDrawing: handleShopDrawing,
    onMoveModule: openMoveModal,
    userRole: userRole,
    onLogQAInspection: onLogQAInspection
  }), showMoveModal && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-[150] p-4",
    onClick: () => setShowMoveModal(null)
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-md w-full",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-autovol-navy"
  }, "Move Module in Schedule"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowMoveModal(null),
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Module"), /*#__PURE__*/React.createElement("div", {
    className: "font-mono font-bold text-lg"
  }, showMoveModal.module.serialNumber), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 mt-1"
  }, "Current position: ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, "#", showMoveModal.currentPosition))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Move to position:"), /*#__PURE__*/React.createElement("select", {
    id: "moveToPosition",
    className: "w-full border rounded-lg px-3 py-2",
    defaultValue: showMoveModal.currentPosition
  }, allModules.map((m, idx) => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: idx + 1
  }, "#", idx + 1, " - ", m.serialNumber === showMoveModal.module.serialNumber ? '(current)' : m.serialNumber)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border-2 border-blue-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-start gap-3 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    id: "applyToAllStations",
    defaultChecked: true,
    className: "mt-1 w-5 h-5 rounded text-blue-600"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-blue-800"
  }, "Apply to ALL stations"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-blue-700 mt-1"
  }, "This will update the build sequence for this module across the entire production line (AUTO-C through Close-Up)."), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600 mt-2 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", null, "\u26A0\uFE0F"), " Recommended to keep stations in sync"))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-end gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowMoveModal(null),
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const newPosition = parseInt(document.getElementById('moveToPosition').value);
      const applyToAll = document.getElementById('applyToAllStations').checked;
      applyModuleMove(showMoveModal.module, newPosition, applyToAll);
    },
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "Move Module")))), showReorderConfirm && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-[150] p-4",
    onClick: () => setShowReorderConfirm(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-md w-full",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-autovol-navy"
  }, "\u26A0\uFE0F Confirm Schedule Changes"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowReorderConfirm(false),
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "You are about to reorder ", /*#__PURE__*/React.createElement("span", {
    className: "font-bold"
  }, pendingReorders.length, " module", pendingReorders.length > 1 ? 's' : ''), ":"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto space-y-2"
  }, pendingReorders.map((reorder, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "flex items-center justify-between text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-mono font-bold"
  }, reorder.moduleSerial), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "#", reorder.fromSeq, " \u2192 ", reorder.position, " ", reorder.targetSerial)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border-2 border-blue-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-start gap-3 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    id: "reorderApplyToAll",
    defaultChecked: true,
    className: "mt-1 w-5 h-5 rounded text-blue-600"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-blue-800"
  }, "Apply to ALL stations"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-blue-700 mt-1"
  }, "This will update the build sequence across the entire production line."), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600 mt-2 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", null, "\u26A0\uFE0F"), " Recommended to keep stations in sync"))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-end gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowReorderConfirm(false),
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const applyToAll = document.getElementById('reorderApplyToAll').checked;
      applyPendingReorders(applyToAll);
    },
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "Apply Changes")))), reorderMode && /*#__PURE__*/React.createElement("div", {
    className: "fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-blue-600 text-white rounded-xl shadow-2xl px-6 py-3 flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-lg"
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, "Reorder Mode Active"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm opacity-90"
  }, "Drag modules to reorder \u2022 ", pendingReorders.length, " change", pendingReorders.length !== 1 ? 's' : '', " pending")), /*#__PURE__*/React.createElement("div", {
    className: "h-8 w-px bg-blue-400"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: cancelReorderMode,
    className: "px-3 py-1.5 bg-blue-500 hover:bg-blue-400 rounded-lg text-sm"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowReorderConfirm(true),
    disabled: pendingReorders.length === 0,
    className: "px-3 py-1.5 bg-white text-blue-600 hover:bg-blue-50 rounded-lg text-sm font-semibold disabled:opacity-50"
  }, "Apply Changes")), toasts.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "fixed top-4 right-4 z-[200] space-y-2 pointer-events-none"
  }, toasts.map(toast => /*#__PURE__*/React.createElement("div", {
    key: toast.id,
    className: `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border-l-4 animate-slide-in ${toast.type === 'success' ? 'bg-green-50 border-green-500 text-green-800' : toast.type === 'warning' ? 'bg-yellow-50 border-yellow-500 text-yellow-800' : 'bg-blue-50 border-blue-500 text-blue-800'}`,
    style: {
      animation: 'slideIn 0.3s ease-out',
      minWidth: '280px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-shrink-0 text-xl"
  }, toast.type === 'success' ? '✅' : toast.type === 'warning' ? '⚠️' : 'ℹ️'), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-sm"
  }, toast.message), toast.stationName && /*#__PURE__*/React.createElement("div", {
    className: "text-xs opacity-75 mt-0.5"
  }, "Station: ", toast.stationName)), /*#__PURE__*/React.createElement("button", {
    onClick: () => removeToast(toast.id),
    className: "flex-shrink-0 text-gray-400 hover:text-gray-600 text-lg"
  }, "\xD7")))));
}

// ===== WEEK COMPLETE MODAL =====
function WeekCompleteModal({
  currentWeek,
  lineBalance,
  activeProjects,
  allModules,
  onComplete,
  onClose,
  addWeek
}) {
// [Removed duplicate React destructuring]
  // Form state
  const [modulesProduced, setModulesProduced] = useState(lineBalance);
  const [useAutoProgress, setUseAutoProgress] = useState(true);
  const [manualNextModule, setManualNextModule] = useState('');
  const [createNextWeek, setCreateNextWeek] = useState(true);
  const [nextWeekShift, setNextWeekShift] = useState('shift1'); // shift1 = Mon-Thu, shift2 = Fri-Sun
  const [notes, setNotes] = useState('');

  // Calculate current starting module index
  const currentStartIdx = useMemo(() => {
    if (!currentWeek?.startingModule) return -1;
    const idx = allModules.findIndex(m => m.serialNumber === currentWeek.startingModule);
    // If starting module not found, log warning
    if (idx === -1 && currentWeek?.startingModule) {
      console.warn('[WeekCompleteModal] Starting module not found in allModules:', currentWeek.startingModule);
    }
    return idx;
  }, [currentWeek, allModules]);

  // Calculate suggested next starting module based on ACTUAL modules produced
  const suggestedNextModule = useMemo(() => {
    // If current starting module not found, suggest the first available module
    if (currentStartIdx === -1) {
      console.log('[WeekCompleteModal] Falling back to first available module');
      return allModules[0] || null;
    }
    const nextIdx = currentStartIdx + modulesProduced;
    return allModules[nextIdx] || null;
  }, [currentStartIdx, modulesProduced, allModules]);

  // Calculate variance
  const variance = modulesProduced - lineBalance;
  const varianceText = variance === 0 ? 'On target' : variance > 0 ? `+${variance} ahead` : `${variance} behind`;
  const varianceColor = variance === 0 ? 'text-gray-600' : variance > 0 ? 'text-green-600' : 'text-red-600';

  // Determine the next starting module
  const nextStartingModule = useAutoProgress ? suggestedNextModule?.serialNumber : manualNextModule;

  // Calculate next week dates
  const getNextWeekDates = () => {
    if (!currentWeek?.weekStart) return {
      start: '',
      end: ''
    };
    const currentStart = parseLocalDate(currentWeek.weekStart);
    const nextMonday = new Date(currentStart);
    nextMonday.setDate(currentStart.getDate() + 7);
    const nextSunday = new Date(nextMonday);
    nextSunday.setDate(nextMonday.getDate() + 6);
    return {
      start: formatLocalDate(nextMonday),
      end: formatLocalDate(nextSunday)
    };
  };
  const nextWeekDates = getNextWeekDates();

  // Update manual module when auto-progress changes
  useEffect(() => {
    if (!useAutoProgress && suggestedNextModule) {
      setManualNextModule(suggestedNextModule.serialNumber);
    }
  }, [useAutoProgress, suggestedNextModule]);
  const handleComplete = () => {
    // Build week completion data
    const weekData = {
      weekStart: currentWeek.weekStart,
      weekEnd: currentWeek.weekEnd,
      plannedLineBalance: lineBalance,
      actualProduced: modulesProduced,
      variance: variance,
      startingModule: currentWeek.startingModule,
      nextStartingModule: nextStartingModule,
      projectsIncluded: activeProjects.map(p => ({
        id: p.id,
        name: p.name
      })),
      notes,
      shift: nextWeekShift
    };

    // Auto-create next week if enabled and get its ID
    let nextWeekId = null;
    if (createNextWeek && nextStartingModule && addWeek) {
      const nextWeekData = {
        id: `week-${nextWeekDates.start}`,
        // Generate predictable ID
        weekStart: nextWeekDates.start,
        weekEnd: nextWeekDates.end,
        startingModule: nextStartingModule,
        productionGoal: lineBalance,
        dailyGoal: Math.ceil(lineBalance / 4),
        notes: `Auto-created from week ${currentWeek.weekStart}`
      };
      addWeek(nextWeekData);
      nextWeekId = nextWeekData.id;
    }

    // Complete the current week (saves to history) and pass nextWeekId for auto-advance
    onComplete(weekData, nextWeekId);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between sticky top-0 bg-white"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-autovol-navy"
  }, "Complete Week"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-5"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium text-gray-700 mb-2"
  }, "Week Summary"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Week:"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, currentWeek?.weekStart, " \u2192 ", currentWeek?.weekEnd)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Starting Module:"), /*#__PURE__*/React.createElement("span", {
    className: "font-mono font-medium"
  }, currentWeek?.startingModule)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Planned Line Balance:"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-autovol-teal"
  }, lineBalance, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Active Projects:"), /*#__PURE__*/React.createElement("span", null, activeProjects.length)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border-2 border-blue-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-bold text-blue-800 mb-2"
  }, "Modules Produced This Week"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "0",
    max: allModules.length,
    value: modulesProduced,
    onChange: e => setModulesProduced(parseInt(e.target.value) || 0),
    className: "w-24 text-center text-2xl font-bold border-2 border-blue-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: `font-medium ${varianceColor}`
  }, varianceText), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "vs. ", lineBalance, " planned"))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-blue-600 mt-2"
  }, "This determines the next week's starting module based on actual production.")), /*#__PURE__*/React.createElement("div", {
    className: "border rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-bold text-gray-700 mb-3"
  }, "Next Week's Starting Module"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-start gap-3 p-3 rounded-lg border-2 cursor-pointer hover:bg-gray-50 transition-colors",
    style: {
      borderColor: useAutoProgress ? '#0d9488' : '#e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "radio",
    checked: useAutoProgress,
    onChange: () => setUseAutoProgress(true),
    className: "mt-1"
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-800"
  }, "Auto-progress (Recommended)"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Based on ", modulesProduced, " modules produced:"), suggestedNextModule ? /*#__PURE__*/React.createElement("div", {
    className: "mt-1 font-mono text-lg font-bold text-autovol-teal"
  }, suggestedNextModule.serialNumber) : /*#__PURE__*/React.createElement("div", {
    className: "mt-1 text-sm text-red-500"
  }, "No more modules available"))), /*#__PURE__*/React.createElement("label", {
    className: "flex items-start gap-3 p-3 rounded-lg border-2 cursor-pointer hover:bg-gray-50 transition-colors",
    style: {
      borderColor: !useAutoProgress ? '#0d9488' : '#e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "radio",
    checked: !useAutoProgress,
    onChange: () => setUseAutoProgress(false),
    className: "mt-1"
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-800"
  }, "Choose Different Module"), !useAutoProgress && /*#__PURE__*/React.createElement("select", {
    value: manualNextModule,
    onChange: e => setManualNextModule(e.target.value),
    className: "mt-2 w-full border rounded-lg px-3 py-2 text-sm",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select starting module..."), allModules.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.serialNumber
  }, m.serialNumber, " (#", m.buildSequence, ")"))))))), /*#__PURE__*/React.createElement("div", {
    className: "border rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-3 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: createNextWeek,
    onChange: e => setCreateNextWeek(e.target.checked),
    className: "w-5 h-5 rounded text-autovol-teal"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-800"
  }, "Auto-create Next Week Schedule"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, nextWeekDates.start, " \u2192 ", nextWeekDates.end))), createNextWeek && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 pl-8"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm text-gray-600 mb-1"
  }, "Shift Schedule:"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setNextWeekShift('shift1'),
    className: `px-3 py-1.5 rounded-lg text-sm font-medium transition ${nextWeekShift === 'shift1' ? 'bg-autovol-teal text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, "Shift 1 (Mon-Thu)"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setNextWeekShift('shift2'),
    className: `px-3 py-1.5 rounded-lg text-sm font-medium transition ${nextWeekShift === 'shift2' ? 'bg-autovol-teal text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, "Shift 2 (Fri-Sun)")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Notes (optional)"), /*#__PURE__*/React.createElement("textarea", {
    value: notes,
    onChange: e => setNotes(e.target.value),
    className: "w-full border rounded-lg px-3 py-2 h-20",
    placeholder: "Any notes about this week's production..."
  }))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-white"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleComplete,
    disabled: !nextStartingModule && createNextWeek,
    className: "px-4 py-2 btn-primary rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
  }, createNextWeek ? 'Complete & Create Next Week' : 'Complete Week'))));
}

// ===== WEEK HISTORY MODAL =====
function WeekHistoryModal({
  completedWeeks,
  onClose
}) {
  // Helper to get variance display
  const getVarianceDisplay = week => {
    const variance = week.variance ?? week.actualProduced - (week.plannedLineBalance || week.lineBalance);
    if (variance === 0 || isNaN(variance)) return {
      text: 'On target',
      color: 'text-gray-500',
      bg: 'bg-gray-100'
    };
    if (variance > 0) return {
      text: `+${variance} ahead`,
      color: 'text-green-600',
      bg: 'bg-green-100'
    };
    return {
      text: `${variance} behind`,
      color: 'text-red-600',
      bg: 'bg-red-100'
    };
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between sticky top-0 bg-white"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-autovol-navy"
  }, "Week History"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "p-4 overflow-y-auto max-h-[calc(80vh-80px)]"
  }, completedWeeks.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, "No completed weeks yet. Complete your first week to see history here.") : /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, completedWeeks.map(week => {
    const varianceInfo = getVarianceDisplay(week);
    return /*#__PURE__*/React.createElement("div", {
      key: week.id,
      className: "border rounded-lg p-4 hover:shadow-md transition-shadow"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-semibold text-gray-800"
    }, week.weekStart, " \u2192 ", week.weekEnd), /*#__PURE__*/React.createElement("div", {
      className: "mt-2 flex flex-wrap gap-3 text-sm"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Planned:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, week.plannedLineBalance || week.lineBalance)), week.actualProduced !== undefined && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Actual:"), /*#__PURE__*/React.createElement("span", {
      className: "font-bold text-autovol-teal"
    }, week.actualProduced)), week.actualProduced !== undefined && /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-0.5 rounded text-xs font-medium ${varianceInfo.bg} ${varianceInfo.color}`
    }, varianceInfo.text)), /*#__PURE__*/React.createElement("div", {
      className: "mt-2 text-xs text-gray-500"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Start:"), " ", week.startingModule, week.nextStartingModule && /*#__PURE__*/React.createElement("span", {
      className: "ml-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "\u2192 Next:"), " ", week.nextStartingModule)), week.projectsIncluded && week.projectsIncluded.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, "Projects: ", week.projectsIncluded.map(p => p.name).join(', ')), week.notes && /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-600 mt-2 italic border-l-2 border-gray-200 pl-2"
    }, "\"", week.notes, "\"")), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-400 ml-4"
    }, new Date(week.completedAt).toLocaleDateString())));
  })))));
}

// ===== MOBILE WEEKLY BOARD VIEW =====
// Swipeable single-station view for mobile devices
function MobileWeeklyBoardView({
  productionStages,
  getModulesForStation,
  getStationStartingModule,
  getStationCapacityInfo,
  renderModuleCard,
  CARD_HEIGHT,
  onModuleClick,
  onProgressUpdate,
  canEdit
}) {
// [Removed duplicate React destructuring]
  const [currentStationIndex, setCurrentStationIndex] = useState(0);
  const [isAnimating, setIsAnimating] = useState(false);
  const [slideDirection, setSlideDirection] = useState(null);
  const touchStartX = useRef(0);
  const touchEndX = useRef(0);
  const containerRef = useRef(null);
  const currentStation = productionStages[currentStationIndex];
  const {
    previous,
    current,
    next
  } = getModulesForStation ? getModulesForStation(currentStation) : {
    previous: [],
    current: [],
    next: []
  };
  const startingModule = getStationStartingModule ? getStationStartingModule(currentStation.id) : null;
  const capacityInfo = getStationCapacityInfo?.[currentStation.id] || {
    capacity: 5,
    inProgress: 0,
    complete: 0,
    loadPercent: 0,
    status: 'under'
  };

  // Navigate with animation
  const navigateTo = useCallback((newIndex, direction) => {
    if (isAnimating || newIndex < 0 || newIndex >= productionStages.length) return;
    setIsAnimating(true);
    setSlideDirection(direction);
    setTimeout(() => {
      setCurrentStationIndex(newIndex);
      setSlideDirection(null);
      setIsAnimating(false);
    }, 200);
  }, [isAnimating, productionStages.length]);

  // Swipe handlers - improved for Safari
  const handleTouchStart = e => {
    touchStartX.current = e.touches[0].clientX;
    touchEndX.current = e.touches[0].clientX;
  };
  const handleTouchMove = e => {
    touchEndX.current = e.touches[0].clientX;
  };
  const handleTouchEnd = () => {
    const swipeDistance = touchStartX.current - touchEndX.current;
    const minSwipeDistance = 50;
    if (swipeDistance > minSwipeDistance && currentStationIndex < productionStages.length - 1) {
      navigateTo(currentStationIndex + 1, 'left');
    } else if (swipeDistance < -minSwipeDistance && currentStationIndex > 0) {
      navigateTo(currentStationIndex - 1, 'right');
    }
  };

  // Arrow navigation handlers
  const goToPrevious = () => navigateTo(currentStationIndex - 1, 'right');
  const goToNext = () => navigateTo(currentStationIndex + 1, 'left');

  // Capacity bar colors
  const capacityBarColor = capacityInfo.status === 'over' ? 'bg-red-400' : capacityInfo.status === 'at' ? 'bg-yellow-400' : 'bg-green-400';
  return /*#__PURE__*/React.createElement("div", {
    className: "mobile-weekly-board"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1 overflow-x-auto pb-2 mb-3 scrollbar-hide"
  }, productionStages.map((station, idx) => /*#__PURE__*/React.createElement("button", {
    key: station.id,
    onClick: () => setCurrentStationIndex(idx),
    className: `flex-shrink-0 px-3 py-2 rounded-full text-xs font-medium transition-all ${idx === currentStationIndex ? `${station.color} text-white shadow-md` : 'bg-gray-100 text-gray-600'}`
  }, station.dept))), /*#__PURE__*/React.createElement("div", {
    ref: containerRef,
    className: `touch-pan-y transition-all duration-200 ease-out ${slideDirection === 'left' ? 'opacity-0 -translate-x-4' : slideDirection === 'right' ? 'opacity-0 translate-x-4' : 'opacity-100 translate-x-0'}`,
    onTouchStart: handleTouchStart,
    onTouchMove: handleTouchMove,
    onTouchEnd: handleTouchEnd,
    style: {
      WebkitTransform: slideDirection === 'left' ? 'translateX(-16px)' : slideDirection === 'right' ? 'translateX(16px)' : 'translateX(0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: `${currentStation.color} text-white px-4 py-3 rounded-t-xl`
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-lg"
  }, currentStation.name), /*#__PURE__*/React.createElement("div", {
    className: "text-sm opacity-80"
  }, "Start: ", startingModule?.serialNumber || 'Not set')), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold"
  }, capacityInfo.inProgress), /*#__PURE__*/React.createElement("div", {
    className: "text-xs opacity-80"
  }, "of ", capacityInfo.capacity))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-2 rounded-full bg-white/30 overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: `h-full ${capacityBarColor} transition-all duration-300`,
    style: {
      width: `${Math.min(capacityInfo.loadPercent, 100)}%`
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-xs mt-1 opacity-90"
  }, /*#__PURE__*/React.createElement("span", null, capacityInfo.complete, " complete"), /*#__PURE__*/React.createElement("span", null, currentStationIndex + 1, " of ", productionStages.length)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-100 text-center py-1 text-xs text-gray-500 flex items-center justify-center gap-2"
  }, currentStationIndex > 0 && /*#__PURE__*/React.createElement("span", null, "\u2190 ", productionStages[currentStationIndex - 1]?.dept), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "|"), /*#__PURE__*/React.createElement("span", null, "Swipe to navigate"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "|"), currentStationIndex < productionStages.length - 1 && /*#__PURE__*/React.createElement("span", null, productionStages[currentStationIndex + 1]?.dept, " \u2192")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white border border-gray-200 rounded-b-xl p-3 space-y-2 max-h-96 overflow-y-auto"
  }, previous.length === 0 && current.length === 0 && next.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-400"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-box inline-block w-8 h-8"
  })), /*#__PURE__*/React.createElement("div", null, "No modules at this station")) : /*#__PURE__*/React.createElement(React.Fragment, null, previous.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs font-semibold text-red-600 uppercase tracking-wide"
  }, "Previous Week"), previous.map(module => /*#__PURE__*/React.createElement(MobileModuleCard, {
    key: module.id,
    module: module,
    station: currentStation,
    section: "previous",
    onClick: onModuleClick,
    onProgressUpdate: onProgressUpdate,
    canEdit: canEdit
  })), /*#__PURE__*/React.createElement("div", {
    className: "border-t border-dashed border-red-200 my-2"
  })), current.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs font-semibold text-autovol-teal uppercase tracking-wide"
  }, "Current Week"), current.map(module => /*#__PURE__*/React.createElement(MobileModuleCard, {
    key: module.id,
    module: module,
    station: currentStation,
    section: "current",
    onClick: onModuleClick,
    onProgressUpdate: onProgressUpdate,
    canEdit: canEdit
  }))), next.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "border-t border-dashed border-green-200 my-2"
  }), /*#__PURE__*/React.createElement("div", {
    className: "text-xs font-semibold text-green-600 uppercase tracking-wide"
  }, "Next Week"), next.map(module => /*#__PURE__*/React.createElement(MobileModuleCard, {
    key: module.id,
    module: module,
    station: currentStation,
    section: "next",
    onClick: onModuleClick,
    onProgressUpdate: onProgressUpdate,
    canEdit: canEdit
  })))))), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between mt-3 gap-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: goToPrevious,
    disabled: currentStationIndex === 0 || isAnimating,
    className: `flex-1 px-4 py-3 rounded-lg font-semibold transition-all duration-200 active:scale-95 ${currentStationIndex === 0 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-autovol-navy text-white shadow-md'}`,
    style: {
      minHeight: '48px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-chevron-left inline-block w-4 h-4 mr-1",
    style: {
      filter: currentStationIndex === 0 ? 'none' : 'invert(1)'
    }
  }), "Previous"), /*#__PURE__*/React.createElement("button", {
    onClick: goToNext,
    disabled: currentStationIndex === productionStages.length - 1 || isAnimating,
    className: `flex-1 px-4 py-3 rounded-lg font-semibold transition-all duration-200 active:scale-95 ${currentStationIndex === productionStages.length - 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-autovol-navy text-white shadow-md'}`,
    style: {
      minHeight: '48px'
    }
  }, "Next", /*#__PURE__*/React.createElement("span", {
    className: "icon-chevron-right inline-block w-4 h-4 ml-1",
    style: {
      filter: currentStationIndex === productionStages.length - 1 ? 'none' : 'invert(1)'
    }
  }))));
}

// Mobile Module Card - simplified card for mobile view with progress buttons
// Wrapped with React.memo to prevent unnecessary re-renders in lists
const MobileModuleCard = React.memo(function MobileModuleCard({
  module,
  station,
  section,
  onClick,
  onProgressUpdate,
  canEdit = true
}) {
// [Removed duplicate React destructuring]
  const [showProgressButtons, setShowProgressButtons] = useState(false);
  const progress = module.stageProgress?.[station.id] || 0;
  const isComplete = progress === 100;
  const isInProgress = progress > 0 && progress < 100;
  const sectionStyles = {
    previous: 'border-red-200 bg-red-50/50',
    current: isComplete ? 'border-green-300 bg-green-50' : isInProgress ? 'border-autovol-teal bg-white' : 'border-gray-200 bg-gray-50',
    next: 'border-green-200 bg-green-50/50'
  };
  const progressOptions = [0, 25, 50, 75, 100];
  const handleProgressClick = (e, value) => {
    e.stopPropagation();
    if (onProgressUpdate) {
      onProgressUpdate(module, station, value);
    }
    setShowProgressButtons(false);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: `p-3 rounded-lg border-2 ${sectionStyles[section]} transition-all`,
    onClick: () => onClick?.(module, station)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-autovol-navy"
  }, module.serialNumber), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, module.projectName), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-400"
  }, module.blmId || 'No BLM')), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      if (canEdit) setShowProgressButtons(!showProgressButtons);
    },
    className: `text-lg font-bold px-2 py-1 rounded ${isComplete ? 'text-green-600 bg-green-100' : isInProgress ? 'text-autovol-teal bg-teal-50' : 'text-gray-400 bg-gray-100'} ${canEdit ? 'active:scale-95' : ''}`
  }, progress, "%"), isComplete && /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-green-600 mt-1"
  }, "Complete"))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 h-2 rounded-full bg-gray-200 overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: `h-full transition-all duration-300 ${isComplete ? 'bg-green-500' : 'bg-autovol-teal'}`,
    style: {
      width: `${progress}%`
    }
  })), showProgressButtons && canEdit && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 flex gap-1 justify-center"
  }, progressOptions.map(value => /*#__PURE__*/React.createElement("button", {
    key: value,
    onClick: e => handleProgressClick(e, value),
    className: `flex-1 py-2 rounded-lg text-sm font-semibold transition-all active:scale-95 ${progress === value ? 'bg-autovol-teal text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`
  }, value, "%"))));
});

// Export for use in App.jsx
if (typeof window !== 'undefined') {
  window.WeeklyBoardComponents = {
    useWeeklySchedule,
    ScheduleSetupTab,
    WeeklyBoardTab,
    WeekCompleteModal,
    WeekHistoryModal,
    ModuleCardPrompt,
    ModuleDetailsTable,
    MobileWeeklyBoardView,
    MobileModuleCard
  };
}
})();


// ============================================================================
// FILE: RFIManager.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA RFI MANAGEMENT SYSTEM
// PreCon RFI (Request for Information) tracking and management
// Integrates with existing MODA projects and employees
// ============================================================================

// RFI Manager Component - Add to PreconTab or as standalone tab
function RFIManager({
  projects = [],
  employees = []
}) {
// [Removed duplicate React destructuring]
  // ===== STATE =====
  const [rfis, setRfis] = useState([]);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [selectedRFI, setSelectedRFI] = useState(null);
  const [filters, setFilters] = useState({
    search: '',
    status: '',
    priority: '',
    project: ''
  });
  const [attachments, setAttachments] = useState([]);

  // ===== COLORS (Autovol Brand) =====
  const COLORS = {
    red: '#C8102E',
    blue: '#0057B8',
    charcoal: '#2D3436',
    gray50: '#F9FAFB',
    gray100: '#F3F4F6',
    gray200: '#E5E7EB',
    gray300: '#D1D5DB',
    gray500: '#6B7280',
    gray600: '#4B5563',
    gray700: '#374151',
    gray900: '#111827',
    green500: '#10B981',
    red500: '#EF4444',
    yellow500: '#F59E0B',
    white: '#FFFFFF'
  };
  const [isLoading, setIsLoading] = useState(true);

  // ===== LOAD/SAVE DATA =====
  useEffect(() => {
    const loadData = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[RFI] Loading data from Supabase...');
          const rfisData = await window.MODA_SUPABASE_DATA.rfis.getAll();
          if (rfisData.length > 0) {
            setRfis(rfisData);
            console.log('[RFI] Loaded', rfisData.length, 'RFIs from Supabase');
          } else {
            // Fallback to localStorage or create samples
            let stored = [];
            try {
              const saved = localStorage.getItem('moda_rfis');
              if (saved && saved !== 'undefined' && saved !== 'null') {
                stored = JSON.parse(saved);
              }
            } catch (e) {
              console.error('[RFI] Error parsing localStorage:', e);
            }
            if (stored.length === 0) {
              const samples = createSampleRFIs();
              setRfis(samples);
            } else {
              setRfis(stored);
            }
          }
        } else {
          console.log('[RFI] Supabase not available, using localStorage');
          let stored = [];
          try {
            const saved = localStorage.getItem('moda_rfis');
            if (saved && saved !== 'undefined' && saved !== 'null') {
              stored = JSON.parse(saved);
            }
          } catch (e) {
            console.error('[RFI] Error parsing localStorage:', e);
          }
          if (stored.length === 0) {
            const samples = createSampleRFIs();
            setRfis(samples);
          } else {
            setRfis(stored);
          }
        }
      } catch (error) {
        console.error('[RFI] Error loading data:', error);
        let stored = [];
        try {
          const saved = localStorage.getItem('moda_rfis');
          if (saved && saved !== 'undefined' && saved !== 'null') {
            stored = JSON.parse(saved);
          }
        } catch (e) {/* ignore */}
        setRfis(stored.length > 0 ? stored : createSampleRFIs());
      } finally {
        setIsLoading(false);
      }
    };
    const timer = setTimeout(loadData, 500);
    return () => clearTimeout(timer);
  }, []);

  // Save to localStorage as backup when RFIs change
  useEffect(() => {
    if (!isLoading && rfis.length > 0) {
      localStorage.setItem('moda_rfis', JSON.stringify(rfis));
    }
  }, [rfis, isLoading]);
  const saveRFIs = updatedRFIs => {
    setRfis(updatedRFIs);
    localStorage.setItem('moda_rfis', JSON.stringify(updatedRFIs));
  };

  // ===== SAMPLE DATA =====
  const createSampleRFIs = () => {
    const projectName = projects.length > 0 ? projects[0].name : 'Sample Project';
    const assignee = employees.length > 0 ? `${employees[0].firstName} ${employees[0].lastName}` : 'Unassigned';
    return [{
      id: 'RFI-2025-001',
      project: projectName,
      subject: 'Wall Framing Height Clarification',
      question: 'Drawing A-102 shows wall height at 9\'-2" but specification calls for 9\'-0". Which dimension should we follow for modules B1L2M01-08?',
      module: 'B1L2M01',
      assignedTo: assignee,
      priority: 'High',
      dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      cc: '',
      status: 'Open',
      createdDate: new Date().toISOString(),
      createdBy: 'Trevor Fletcher',
      responses: [],
      attachments: []
    }, {
      id: 'RFI-2025-002',
      project: projectName,
      subject: 'MEP Coordination - HVAC/Plumbing Conflict',
      question: 'HVAC ductwork conflicts with plumbing drain in unit stack. Need coordination drawings for resolution.',
      module: 'A-H205',
      assignedTo: assignee,
      priority: 'High',
      dueDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      cc: '',
      status: 'Open',
      createdDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
      createdBy: 'Trevor Fletcher',
      responses: [{
        author: 'Engineering Team',
        date: new Date().toISOString(),
        text: 'Reviewing coordination drawings. Will provide updated routing by EOD.'
      }],
      attachments: []
    }];
  };

  // ===== UTILITIES =====
  const generateRFINumber = () => {
    const year = new Date().getFullYear();
    const existingRFIs = rfis.filter(r => r.id.startsWith(`RFI-${year}-`));
    const nextNum = existingRFIs.length + 1;
    return `RFI-${year}-${String(nextNum).padStart(3, '0')}`;
  };
  const getRFIStatus = rfi => {
    if (rfi.status === 'Closed') return 'Closed';
    if (new Date(rfi.dueDate) < new Date() && rfi.status !== 'Closed') return 'Overdue';
    if (rfi.responses && rfi.responses.length > 0) return 'Pending';
    return 'Open';
  };

  // ===== STATS =====
  const stats = useMemo(() => {
    const open = rfis.filter(r => getRFIStatus(r) === 'Open').length;
    const pending = rfis.filter(r => getRFIStatus(r) === 'Pending').length;
    const overdue = rfis.filter(r => getRFIStatus(r) === 'Overdue').length;
    const thisMonth = new Date();
    thisMonth.setDate(1);
    const closed = rfis.filter(r => r.status === 'Closed' && new Date(r.dateClosed) >= thisMonth).length;
    return {
      open,
      pending,
      overdue,
      closed
    };
  }, [rfis]);

  // ===== FILTERING =====
  const filteredRFIs = useMemo(() => {
    return rfis.filter(rfi => {
      const status = getRFIStatus(rfi);
      const matchesSearch = !filters.search || (rfi.id || '').toLowerCase().includes((filters.search || '').toLowerCase()) || (rfi.subject || '').toLowerCase().includes((filters.search || '').toLowerCase()) || (rfi.module || '').toLowerCase().includes((filters.search || '').toLowerCase());
      const matchesStatus = !filters.status || status === filters.status;
      const matchesPriority = !filters.priority || rfi.priority === filters.priority;
      const matchesProject = !filters.project || rfi.project === filters.project;
      return matchesSearch && matchesStatus && matchesPriority && matchesProject;
    });
  }, [rfis, filters]);

  // ===== ACTIONS =====
  const createRFI = formData => {
    const newRFI = {
      id: generateRFINumber(),
      ...formData,
      status: 'Open',
      createdDate: new Date().toISOString(),
      createdBy: 'Current User',
      // Would come from auth
      responses: [],
      attachments: [...attachments]
    };
    saveRFIs([...rfis, newRFI]);
    setAttachments([]);
    setShowCreateModal(false);
  };
  const addResponse = (rfiId, responseText) => {
    const updated = rfis.map(rfi => {
      if (rfi.id === rfiId) {
        const newResponse = {
          author: 'Current User',
          date: new Date().toISOString(),
          text: responseText
        };
        return {
          ...rfi,
          responses: [...(rfi.responses || []), newResponse],
          status: rfi.status === 'Open' ? 'Pending' : rfi.status
        };
      }
      return rfi;
    });
    saveRFIs(updated);
    setSelectedRFI(updated.find(r => r.id === rfiId));
  };
  const closeRFI = rfiId => {
    const updated = rfis.map(rfi => {
      if (rfi.id === rfiId) {
        return {
          ...rfi,
          status: 'Closed',
          dateClosed: new Date().toISOString()
        };
      }
      return rfi;
    });
    saveRFIs(updated);
    setShowViewModal(false);
    setSelectedRFI(null);
  };
  const handleFiles = files => {
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        setAttachments(prev => [...prev, {
          name: file.name,
          type: file.type,
          size: file.size,
          data: e.target.result
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  // ===== STYLES =====
  const styles = {
    container: {
      padding: '24px',
      background: `linear-gradient(135deg, ${COLORS.gray100} 0%, ${COLORS.gray200} 100%)`,
      minHeight: '100vh'
    },
    header: {
      background: `linear-gradient(135deg, ${COLORS.red} 0%, #A01027 100%)`,
      color: COLORS.white,
      padding: '24px',
      borderRadius: '12px',
      boxShadow: '0 4px 20px rgba(200, 16, 46, 0.3)',
      marginBottom: '24px'
    },
    statsGrid: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
      gap: '16px',
      marginBottom: '24px'
    },
    statCard: {
      background: COLORS.white,
      padding: '20px',
      borderRadius: '12px',
      boxShadow: '0 2px 8px rgba(0, 0, 0, 0.06)',
      textAlign: 'center'
    },
    statValue: {
      fontSize: '32px',
      fontWeight: '700',
      fontFamily: "'JetBrains Mono', monospace",
      marginBottom: '8px'
    },
    statLabel: {
      fontSize: '13px',
      color: COLORS.gray600,
      textTransform: 'uppercase',
      letterSpacing: '0.5px'
    },
    controls: {
      background: COLORS.white,
      padding: '20px',
      borderRadius: '12px',
      boxShadow: '0 2px 8px rgba(0, 0, 0, 0.06)',
      marginBottom: '24px',
      display: 'flex',
      gap: '16px',
      flexWrap: 'wrap',
      alignItems: 'center'
    },
    searchInput: {
      flex: 1,
      minWidth: '250px',
      padding: '12px 16px',
      border: `2px solid ${COLORS.gray200}`,
      borderRadius: '8px',
      fontSize: '14px',
      fontFamily: 'inherit'
    },
    select: {
      padding: '10px 14px',
      border: `2px solid ${COLORS.gray200}`,
      borderRadius: '8px',
      fontSize: '14px',
      fontFamily: 'inherit',
      background: COLORS.white
    },
    btnPrimary: {
      padding: '12px 24px',
      border: 'none',
      borderRadius: '8px',
      fontSize: '14px',
      fontWeight: '600',
      cursor: 'pointer',
      background: `linear-gradient(135deg, ${COLORS.red} 0%, #A01027 100%)`,
      color: COLORS.white,
      boxShadow: '0 4px 12px rgba(200, 16, 46, 0.3)',
      display: 'inline-flex',
      alignItems: 'center',
      gap: '8px'
    },
    btnSecondary: {
      padding: '12px 24px',
      border: `2px solid ${COLORS.gray300}`,
      borderRadius: '8px',
      fontSize: '14px',
      fontWeight: '600',
      cursor: 'pointer',
      background: COLORS.white,
      color: COLORS.charcoal
    },
    rfiCard: status => ({
      background: COLORS.white,
      borderRadius: '12px',
      padding: '20px',
      boxShadow: '0 2px 8px rgba(0, 0, 0, 0.06)',
      borderLeft: `4px solid ${status === 'Open' ? COLORS.red : status === 'Pending' ? COLORS.yellow500 : status === 'Closed' ? COLORS.green500 : '#DC2626'}`,
      cursor: 'pointer',
      marginBottom: '16px',
      transition: 'all 0.2s'
    }),
    badge: (type, value) => {
      const colors = {
        'status-open': {
          bg: '#FEE2E2',
          color: '#991B1B'
        },
        'status-pending': {
          bg: '#FEF3C7',
          color: '#92400E'
        },
        'status-closed': {
          bg: '#D1FAE5',
          color: '#065F46'
        },
        'status-overdue': {
          bg: '#FEE2E2',
          color: '#7F1D1D'
        },
        'priority-high': {
          bg: '#FEE2E2',
          color: '#991B1B'
        },
        'priority-medium': {
          bg: '#FEF3C7',
          color: '#92400E'
        },
        'priority-low': {
          bg: '#DBEAFE',
          color: '#1E40AF'
        }
      };
      const key = `${type}-${(value || '').toLowerCase()}`;
      const c = colors[key] || {
        bg: COLORS.gray200,
        color: COLORS.gray700
      };
      return {
        padding: '4px 10px',
        borderRadius: '12px',
        fontSize: '11px',
        fontWeight: '600',
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
        background: c.bg,
        color: c.color,
        display: 'inline-block',
        marginRight: '8px'
      };
    },
    modal: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0, 0, 0, 0.6)',
      zIndex: 1000,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px'
    },
    modalContent: {
      background: COLORS.white,
      borderRadius: '16px',
      maxWidth: '800px',
      width: '100%',
      maxHeight: '90vh',
      overflowY: 'auto',
      boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
    },
    modalHeader: {
      background: `linear-gradient(135deg, ${COLORS.red} 0%, #A01027 100%)`,
      color: COLORS.white,
      padding: '24px',
      borderRadius: '16px 16px 0 0',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    },
    modalBody: {
      padding: '24px'
    },
    formGroup: {
      marginBottom: '20px'
    },
    label: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '600',
      color: COLORS.gray700,
      marginBottom: '8px',
      textTransform: 'uppercase',
      letterSpacing: '0.3px'
    },
    input: {
      width: '100%',
      padding: '12px 14px',
      border: `2px solid ${COLORS.gray200}`,
      borderRadius: '8px',
      fontSize: '15px',
      fontFamily: 'inherit'
    },
    textarea: {
      width: '100%',
      padding: '12px 14px',
      border: `2px solid ${COLORS.gray200}`,
      borderRadius: '8px',
      fontSize: '15px',
      fontFamily: 'inherit',
      resize: 'vertical',
      minHeight: '100px'
    }
  };

  // ===== RENDER =====
  return /*#__PURE__*/React.createElement("div", {
    style: styles.container
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.header
  }, /*#__PURE__*/React.createElement("h1", {
    style: {
      margin: '0 0 8px 0',
      fontSize: '28px',
      fontWeight: '600'
    }
  }, "\uD83D\uDCCB PreCon RFI Management"), /*#__PURE__*/React.createElement("p", {
    style: {
      margin: 0,
      opacity: 0.9,
      fontSize: '14px'
    }
  }, "Request for Information \u2022 Timeline Tracking \u2022 Module Integration")), /*#__PURE__*/React.createElement("div", {
    style: styles.statsGrid
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.statCard
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statValue,
      color: COLORS.red
    }
  }, stats.open), /*#__PURE__*/React.createElement("div", {
    style: styles.statLabel
  }, "Open RFIs")), /*#__PURE__*/React.createElement("div", {
    style: styles.statCard
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statValue,
      color: COLORS.yellow500
    }
  }, stats.pending), /*#__PURE__*/React.createElement("div", {
    style: styles.statLabel
  }, "Pending Response")), /*#__PURE__*/React.createElement("div", {
    style: styles.statCard
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statValue,
      color: '#DC2626'
    }
  }, stats.overdue), /*#__PURE__*/React.createElement("div", {
    style: styles.statLabel
  }, "Overdue")), /*#__PURE__*/React.createElement("div", {
    style: styles.statCard
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statValue,
      color: COLORS.green500
    }
  }, stats.closed), /*#__PURE__*/React.createElement("div", {
    style: styles.statLabel
  }, "Closed This Month"))), /*#__PURE__*/React.createElement("div", {
    style: styles.controls
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "\uD83D\uDD0D Search RFI number, subject, module...",
    value: filters.search,
    onChange: e => setFilters({
      ...filters,
      search: e.target.value
    }),
    style: styles.searchInput
  }), /*#__PURE__*/React.createElement("select", {
    value: filters.status,
    onChange: e => setFilters({
      ...filters,
      status: e.target.value
    }),
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Statuses"), /*#__PURE__*/React.createElement("option", {
    value: "Open"
  }, "Open"), /*#__PURE__*/React.createElement("option", {
    value: "Pending"
  }, "Pending"), /*#__PURE__*/React.createElement("option", {
    value: "Closed"
  }, "Closed"), /*#__PURE__*/React.createElement("option", {
    value: "Overdue"
  }, "Overdue")), /*#__PURE__*/React.createElement("select", {
    value: filters.priority,
    onChange: e => setFilters({
      ...filters,
      priority: e.target.value
    }),
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Priorities"), /*#__PURE__*/React.createElement("option", {
    value: "High"
  }, "High"), /*#__PURE__*/React.createElement("option", {
    value: "Medium"
  }, "Medium"), /*#__PURE__*/React.createElement("option", {
    value: "Low"
  }, "Low")), /*#__PURE__*/React.createElement("select", {
    value: filters.project,
    onChange: e => setFilters({
      ...filters,
      project: e.target.value
    }),
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Projects"), projects.map(proj => /*#__PURE__*/React.createElement("option", {
    key: proj.id,
    value: proj.name
  }, proj.name))), /*#__PURE__*/React.createElement("button", {
    style: styles.btnPrimary,
    onClick: () => setShowCreateModal(true)
  }, "\u2795 New RFI")), /*#__PURE__*/React.createElement("div", null, filteredRFIs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '60px',
      color: COLORS.gray500
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '48px',
      marginBottom: '16px'
    }
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '16px'
    }
  }, "No RFIs match your filters")) : filteredRFIs.map(rfi => {
    const status = getRFIStatus(rfi);
    return /*#__PURE__*/React.createElement("div", {
      key: rfi.id,
      style: styles.rfiCard(status),
      onClick: () => {
        setSelectedRFI(rfi);
        setShowViewModal(true);
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        marginBottom: '12px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontFamily: "'JetBrains Mono', monospace",
        fontSize: '16px',
        fontWeight: '600',
        color: COLORS.red
      }
    }, rfi.id), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: styles.badge('status', status)
    }, status), /*#__PURE__*/React.createElement("span", {
      style: styles.badge('priority', rfi.priority)
    }, rfi.priority))), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '18px',
        fontWeight: '600',
        marginBottom: '8px',
        color: COLORS.gray900
      }
    }, rfi.subject), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
        gap: '12px',
        marginTop: '12px',
        paddingTop: '12px',
        borderTop: `1px solid ${COLORS.gray200}`
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray500,
        fontSize: '13px',
        marginBottom: '2px'
      }
    }, "Project"), /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray900,
        fontWeight: '500'
      }
    }, rfi.project)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray500,
        fontSize: '13px',
        marginBottom: '2px'
      }
    }, "Assigned To"), /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray900,
        fontWeight: '500'
      }
    }, rfi.assignedTo)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray500,
        fontSize: '13px',
        marginBottom: '2px'
      }
    }, "Due Date"), /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray900,
        fontWeight: '500'
      }
    }, new Date(rfi.dueDate).toLocaleDateString())), rfi.module && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray500,
        fontSize: '13px',
        marginBottom: '2px'
      }
    }, "Module"), /*#__PURE__*/React.createElement("div", {
      style: {
        color: COLORS.gray900,
        fontWeight: '500',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, rfi.module))));
  })), showCreateModal && /*#__PURE__*/React.createElement(CreateRFIModal, {
    projects: projects,
    employees: employees,
    attachments: attachments,
    onFileUpload: handleFiles,
    onRemoveFile: idx => setAttachments(prev => prev.filter((_, i) => i !== idx)),
    onClose: () => {
      setShowCreateModal(false);
      setAttachments([]);
    },
    onSave: createRFI,
    styles: styles,
    COLORS: COLORS
  }), showViewModal && selectedRFI && /*#__PURE__*/React.createElement(ViewRFIModal, {
    rfi: selectedRFI,
    status: getRFIStatus(selectedRFI),
    onClose: () => {
      setShowViewModal(false);
      setSelectedRFI(null);
    },
    onAddResponse: text => addResponse(selectedRFI.id, text),
    onCloseRFI: () => closeRFI(selectedRFI.id),
    styles: styles,
    COLORS: COLORS
  }));
}

// ===== CREATE RFI MODAL =====
function CreateRFIModal({
  projects,
  employees,
  attachments,
  onFileUpload,
  onRemoveFile,
  onClose,
  onSave,
  styles,
  COLORS
}) {
  const [formData, setFormData] = React.useState({
    project: '',
    subject: '',
    question: '',
    module: '',
    assignedTo: '',
    priority: 'Medium',
    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    cc: ''
  });
  const handleSubmit = e => {
    e.preventDefault();
    onSave(formData);
  };
  return /*#__PURE__*/React.createElement("div", {
    style: styles.modal,
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modalContent,
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modalHeader
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: 0,
      fontSize: '24px',
      fontWeight: '600'
    }
  }, "Create New RFI"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    style: {
      background: 'rgba(255,255,255,0.2)',
      border: 'none',
      color: COLORS.white,
      width: '36px',
      height: '36px',
      borderRadius: '50%',
      cursor: 'pointer',
      fontSize: '20px'
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: styles.modalBody
  }, /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Project *"), /*#__PURE__*/React.createElement("select", {
    required: true,
    value: formData.project,
    onChange: e => setFormData({
      ...formData,
      project: e.target.value
    }),
    style: styles.input
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select Project..."), projects.map(proj => /*#__PURE__*/React.createElement("option", {
    key: proj.id,
    value: proj.name
  }, proj.name)))), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Subject *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    required: true,
    placeholder: "Brief description of the issue",
    value: formData.subject,
    onChange: e => setFormData({
      ...formData,
      subject: e.target.value
    }),
    style: styles.input
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Question / Request *"), /*#__PURE__*/React.createElement("textarea", {
    required: true,
    placeholder: "Detailed description of what needs clarification...",
    value: formData.question,
    onChange: e => setFormData({
      ...formData,
      question: e.target.value
    }),
    style: styles.textarea
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Related Module (BLM ID)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "e.g., A-H102, B1L2M01",
    value: formData.module,
    onChange: e => setFormData({
      ...formData,
      module: e.target.value
    }),
    style: styles.input
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: '16px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Assigned To *"), /*#__PURE__*/React.createElement("select", {
    required: true,
    value: formData.assignedTo,
    onChange: e => setFormData({
      ...formData,
      assignedTo: e.target.value
    }),
    style: styles.input
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select Person..."), employees.map(emp => /*#__PURE__*/React.createElement("option", {
    key: emp.id,
    value: `${emp.firstName} ${emp.lastName}`
  }, emp.firstName, " ", emp.lastName, " - ", emp.jobTitle || emp.department)))), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Priority *"), /*#__PURE__*/React.createElement("select", {
    required: true,
    value: formData.priority,
    onChange: e => setFormData({
      ...formData,
      priority: e.target.value
    }),
    style: styles.input
  }, /*#__PURE__*/React.createElement("option", {
    value: "High"
  }, "\uD83D\uDD34 High - Impacts Schedule"), /*#__PURE__*/React.createElement("option", {
    value: "Medium"
  }, "\uD83D\uDFE1 Medium - Normal"), /*#__PURE__*/React.createElement("option", {
    value: "Low"
  }, "\uD83D\uDFE2 Low - Non-Critical")))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: '16px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Due Date *"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    required: true,
    value: formData.dueDate,
    onChange: e => setFormData({
      ...formData,
      dueDate: e.target.value
    }),
    style: styles.input
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "CC Recipients"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "email1@example.com, email2@example.com",
    value: formData.cc,
    onChange: e => setFormData({
      ...formData,
      cc: e.target.value
    }),
    style: styles.input
  }))), /*#__PURE__*/React.createElement("div", {
    style: styles.formGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Attachments"), /*#__PURE__*/React.createElement("div", {
    style: {
      border: `2px dashed ${COLORS.gray300}`,
      borderRadius: '8px',
      padding: '30px',
      textAlign: 'center',
      cursor: 'pointer'
    },
    onClick: () => document.getElementById('rfi-file-input').click()
  }, /*#__PURE__*/React.createElement("div", null, "\uD83D\uDCCE Click to upload files"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: COLORS.gray500,
      marginTop: '8px'
    }
  }, "Photos, PDFs, Drawings (Max 50MB each)")), /*#__PURE__*/React.createElement("input", {
    type: "file",
    id: "rfi-file-input",
    multiple: true,
    accept: "image/*,.pdf,.dwg,.docx,.xlsx",
    style: {
      display: 'none'
    },
    onChange: e => onFileUpload(e.target.files)
  }), attachments.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '12px'
    }
  }, attachments.map((att, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      padding: '8px 12px',
      background: COLORS.gray50,
      borderRadius: '6px',
      marginBottom: '8px'
    }
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDCCE ", att.name, " (", (att.size / 1024).toFixed(1), " KB)"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => onRemoveFile(idx),
    style: {
      background: 'none',
      border: 'none',
      color: COLORS.red500,
      cursor: 'pointer',
      fontWeight: 'bold'
    }
  }, "\xD7"))))), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    style: {
      ...styles.btnPrimary,
      width: '100%',
      marginTop: '20px',
      justifyContent: 'center'
    }
  }, "\uD83D\uDCBE Create RFI")))));
}

// ===== VIEW RFI MODAL =====
function ViewRFIModal({
  rfi,
  status,
  onClose,
  onAddResponse,
  onCloseRFI,
  styles,
  COLORS
}) {
  const [responseText, setResponseText] = React.useState('');
  const [showResponseInput, setShowResponseInput] = React.useState(false);
  const handleAddResponse = () => {
    if (responseText.trim()) {
      onAddResponse(responseText);
      setResponseText('');
      setShowResponseInput(false);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    style: styles.modal,
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modalContent,
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modalHeader
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: 0,
      fontSize: '24px',
      fontWeight: '600',
      fontFamily: "'JetBrains Mono', monospace"
    }
  }, rfi.id), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    style: {
      background: 'rgba(255,255,255,0.2)',
      border: 'none',
      color: COLORS.white,
      width: '36px',
      height: '36px',
      borderRadius: '50%',
      cursor: 'pointer',
      fontSize: '20px'
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: styles.modalBody
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px',
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.badge('status', status)
  }, status), /*#__PURE__*/React.createElement("span", {
    style: styles.badge('priority', rfi.priority)
  }, rfi.priority, " Priority")), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: '20px',
      marginBottom: '16px',
      color: COLORS.gray900
    }
  }, rfi.subject), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(2, 1fr)',
      gap: '16px',
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray500,
      fontSize: '13px',
      marginBottom: '4px'
    }
  }, "Project"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600'
    }
  }, rfi.project)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray500,
      fontSize: '13px',
      marginBottom: '4px'
    }
  }, "Assigned To"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600'
    }
  }, rfi.assignedTo)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray500,
      fontSize: '13px',
      marginBottom: '4px'
    }
  }, "Due Date"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600'
    }
  }, new Date(rfi.dueDate).toLocaleDateString())), rfi.module && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray500,
      fontSize: '13px',
      marginBottom: '4px'
    }
  }, "Related Module"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600',
      fontFamily: "'JetBrains Mono', monospace"
    }
  }, rfi.module))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: COLORS.gray50,
      padding: '16px',
      borderRadius: '8px',
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray500,
      fontSize: '13px',
      marginBottom: '8px',
      fontWeight: '600',
      textTransform: 'uppercase'
    }
  }, "QUESTION"), /*#__PURE__*/React.createElement("div", {
    style: {
      lineHeight: '1.6'
    }
  }, rfi.question)), rfi.attachments && rfi.attachments.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600',
      marginBottom: '12px'
    }
  }, "Attachments (", rfi.attachments.length, ")"), rfi.attachments.map((att, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      padding: '8px 12px',
      background: COLORS.gray50,
      borderRadius: '6px',
      marginBottom: '8px'
    }
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDCCE ", att.name)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '12px',
      marginBottom: '24px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    style: styles.btnPrimary,
    onClick: () => setShowResponseInput(true)
  }, "\uD83D\uDCAC Add Response"), status !== 'Closed' && /*#__PURE__*/React.createElement("button", {
    style: styles.btnSecondary,
    onClick: onCloseRFI
  }, "\u2705 Close RFI")), showResponseInput && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '24px',
      padding: '16px',
      background: COLORS.gray50,
      borderRadius: '8px'
    }
  }, /*#__PURE__*/React.createElement("textarea", {
    placeholder: "Enter your response...",
    value: responseText,
    onChange: e => setResponseText(e.target.value),
    style: {
      ...styles.textarea,
      marginBottom: '12px'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    style: styles.btnPrimary,
    onClick: handleAddResponse
  }, "Submit Response"), /*#__PURE__*/React.createElement("button", {
    style: styles.btnSecondary,
    onClick: () => {
      setShowResponseInput(false);
      setResponseText('');
    }
  }, "Cancel"))), rfi.responses && rfi.responses.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: '18px',
      marginBottom: '16px'
    }
  }, "Response Timeline"), rfi.responses.map((resp, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    style: {
      paddingLeft: '20px',
      borderLeft: `3px solid ${COLORS.gray300}`,
      marginLeft: '20px',
      marginBottom: '16px',
      position: 'relative'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'absolute',
      left: '-8px',
      top: '4px',
      width: '12px',
      height: '12px',
      borderRadius: '50%',
      background: COLORS.blue,
      border: '3px solid white'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: '8px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '600',
      color: COLORS.gray900
    }
  }, resp.author), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: COLORS.gray500
    }
  }, new Date(resp.date).toLocaleString())), /*#__PURE__*/React.createElement("div", {
    style: {
      color: COLORS.gray700,
      lineHeight: '1.6'
    }
  }, resp.text)))))));
}

// Export for use in MODA
if (typeof window !== 'undefined') {
  window.RFIManager = RFIManager;
}
})();


// ============================================================================
// FILE: PreconModule.jsx
// ============================================================================
(function() {
// ============================================================================
// PRECON MODULE - Preconstruction Planning & Management
// Contains sub-tabs: Overview, RFI, Estimates, Submittals, Schedule
// ============================================================================

function PreconModule({
  projects,
  employees
}) {
// [Removed duplicate React destructuring]
  const [activeSubTab, setActiveSubTab] = useState('overview');

  // Get RFI stats for badges
  const getRfiStats = () => {
    let rfis = [];
    try {
      const saved = localStorage.getItem('autovol_rfis');
      if (saved && saved !== 'undefined' && saved !== 'null') {
        rfis = JSON.parse(saved);
      }
    } catch (e) {
      console.error('[PreconModule] Error parsing RFIs:', e);
    }
    const open = rfis.filter(r => r.status === 'Open').length;
    const pending = rfis.filter(r => r.status === 'Pending').length;
    const overdue = rfis.filter(r => {
      if (r.status === 'Closed') return false;
      return r.dueDate && new Date(r.dueDate) < new Date();
    }).length;
    return {
      open,
      pending,
      overdue,
      total: rfis.length
    };
  };
  const rfiStats = getRfiStats();
  const subTabs = [{
    id: 'overview',
    label: 'Overview',
    icon: '📊'
  }, {
    id: 'rfi',
    label: 'RFI',
    icon: '📋',
    badge: rfiStats.open + rfiStats.pending
  }, {
    id: 'estimates',
    label: 'Estimates',
    icon: '💰'
  }, {
    id: 'submittals',
    label: 'Submittals',
    icon: '📁'
  }, {
    id: 'schedule',
    label: 'Schedule',
    icon: '📅'
  }];
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "\uD83D\uDCDD Preconstruction"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm"
  }, "Planning, estimates, RFIs, and submittals"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm border overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex border-b",
    style: {
      backgroundColor: '#f8fafc'
    }
  }, subTabs.map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveSubTab(tab.id),
    className: "px-5 py-3 text-sm font-medium transition-all relative",
    style: {
      color: activeSubTab === tab.id ? 'var(--autovol-red)' : 'var(--autovol-navy)',
      borderBottom: activeSubTab === tab.id ? '3px solid var(--autovol-red)' : '3px solid transparent',
      backgroundColor: activeSubTab === tab.id ? 'white' : 'transparent'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "mr-2"
  }, tab.icon), tab.label, tab.badge > 0 && /*#__PURE__*/React.createElement("span", {
    className: "ml-2 px-2 py-0.5 text-xs font-bold rounded-full",
    style: {
      backgroundColor: 'var(--autovol-red)',
      color: 'white'
    }
  }, tab.badge)))), /*#__PURE__*/React.createElement("div", {
    className: "p-0"
  }, activeSubTab === 'overview' && /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200 cursor-pointer hover:shadow-md transition",
    onClick: () => setActiveSubTab('rfi')
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, rfiStats.total)), /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "RFIs"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 mt-2 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-orange-600"
  }, rfiStats.open, " Open"), /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-600"
  }, rfiStats.pending, " Pending"), rfiStats.overdue > 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-red-600"
  }, rfiStats.overdue, " Overdue"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCB0"), /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "\u2014")), /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Estimates"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, "Coming soon")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCC1"), /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "\u2014")), /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Submittals"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, "Coming soon")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCC5"), /*#__PURE__*/React.createElement("span", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "\u2014")), /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Schedule"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, "Coming soon"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 border"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Quick Actions"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveSubTab('rfi'),
    className: "px-4 py-2 text-sm font-medium rounded-lg transition",
    style: {
      backgroundColor: 'var(--autovol-teal)',
      color: 'white'
    }
  }, "+ New RFI"), /*#__PURE__*/React.createElement("button", {
    className: "px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 text-gray-500",
    disabled: true
  }, "+ New Estimate"), /*#__PURE__*/React.createElement("button", {
    className: "px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 text-gray-500",
    disabled: true
  }, "+ New Submittal")))), activeSubTab === 'rfi' && /*#__PURE__*/React.createElement(RFIManager, {
    projects: projects,
    employees: employees
  }), activeSubTab === 'estimates' && /*#__PURE__*/React.createElement("div", {
    className: "p-6 text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDCB0"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Estimates"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Coming soon - Cost estimation and budgeting tools")), activeSubTab === 'submittals' && /*#__PURE__*/React.createElement("div", {
    className: "p-6 text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDCC1"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Submittals"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Coming soon - Document submittals and approvals")), activeSubTab === 'schedule' && /*#__PURE__*/React.createElement("div", {
    className: "p-6 text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDCC5"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Schedule"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Coming soon - Preconstruction scheduling and milestones")))));
}
})();


// ============================================================================
// FILE: ExecutiveDashboard.jsx
// ============================================================================
(function() {
// ============================================================================
// EXECUTIVE DASHBOARD - Streamlined Executive View
// High-level operational visibility for leadership (CEO, CTO, CFO)
// Design principle: "Quick glimpse, not overwhelming"
// ============================================================================

// ===== FACTORY CONFIGURATION =====
const FACTORIES = [{
  id: 'all',
  name: 'All Factories',
  icon: '🏭'
}, {
  id: 'nampa',
  name: 'Nampa Star Rd',
  icon: '🏭',
  location: 'Nampa, ID'
}, {
  id: 'factory2',
  name: 'Factory 2 (TBD)',
  icon: '🏗️',
  location: 'TBD',
  isFake: true
}];

// ===== FAKE DATA FOR FACTORY 2 (placeholder until real data) =====
const FACTORY2_FAKE_DATA = {
  thisWeek: {
    completed: 12,
    target: 14
  },
  lastWeek: {
    completed: 13,
    target: 14
  },
  quarterTotal: 98,
  quarterTarget: 126,
  automation: {
    wallLine: {
      actual: 580,
      target: 720,
      downtime: 2.1
    },
    floorLine: {
      actual: 5800,
      target: 6500,
      downtime: 1.4
    }
  },
  weeklyHistory: [{
    week: 'W1',
    completed: 12,
    target: 14
  }, {
    week: 'W2',
    completed: 14,
    target: 14
  }, {
    week: 'W3',
    completed: 11,
    target: 14
  }, {
    week: 'W4',
    completed: 13,
    target: 14
  }, {
    week: 'W5',
    completed: 12,
    target: 14
  }, {
    week: 'W6',
    completed: 14,
    target: 14
  }, {
    week: 'W7',
    completed: 13,
    target: 14
  }, {
    week: 'W8',
    completed: 12,
    target: 14
  }]
};

// ===== FAKE AUTOMATION DATA (placeholder until integration) =====
const getAutomationData = factoryId => {
  if (factoryId === 'factory2') {
    return FACTORY2_FAKE_DATA.automation;
  }
  // Nampa / real data placeholder
  return {
    wallLine: {
      actual: 726.74,
      target: 905.98,
      downtime: 1.64,
      unit: 'LF'
    },
    floorLine: {
      actual: 6601.82,
      target: 7200,
      downtime: 1.73,
      unit: 'LF'
    }
  };
};

// ===== UTILITY FUNCTIONS =====
const formatNumber = num => {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return Math.round(num).toLocaleString();
};
const getPercentColor = percent => {
  if (percent >= 95) return 'text-green-600';
  if (percent >= 80) return 'text-yellow-600';
  return 'text-red-600';
};
const getPercentBgColor = percent => {
  if (percent >= 95) return 'bg-green-500';
  if (percent >= 80) return 'bg-yellow-500';
  return 'bg-red-500';
};
const getCurrentQuarter = () => {
  const now = new Date();
  const quarter = Math.floor(now.getMonth() / 3) + 1;
  return `Q${quarter} '${now.getFullYear().toString().slice(-2)}`;
};

// ===== KPI CARD COMPONENT =====
function KPICard({
  title,
  value,
  target,
  subtitle,
  status,
  large = false
}) {
  const percent = target ? value / target * 100 : null;
  const statusColor = status === 'good' ? 'border-green-400 bg-green-50' : status === 'warning' ? 'border-yellow-400 bg-yellow-50' : status === 'critical' ? 'border-red-400 bg-red-50' : 'border-gray-200 bg-white';
  return /*#__PURE__*/React.createElement("div", {
    className: `rounded-xl border-2 p-4 ${statusColor} transition-all hover:shadow-md`
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-gray-500 uppercase tracking-wide"
  }, title), /*#__PURE__*/React.createElement("div", {
    className: "flex items-baseline gap-2 mt-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: `font-bold ${large ? 'text-3xl' : 'text-2xl'} text-gray-900`
  }, value), target && /*#__PURE__*/React.createElement("span", {
    className: "text-lg text-gray-400"
  }, "/ ", target)), subtitle && /*#__PURE__*/React.createElement("p", {
    className: `text-sm mt-1 font-medium ${percent ? getPercentColor(percent) : 'text-gray-500'}`
  }, subtitle));
}

// ===== WEEKLY TREND CHART =====
function WeeklyTrendChart({
  data,
  target
}) {
  const maxValue = Math.max(...data.map(d => Math.max(d.completed, d.target)), target, 1);
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-800"
  }, "Weekly Trend"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, "Target: ", target, " modules/week")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-end gap-2 h-24"
  }, data.map((week, idx) => {
    const percent = week.completed / maxValue * 100;
    const hitTarget = week.completed >= week.target;
    return /*#__PURE__*/React.createElement("div", {
      key: idx,
      className: "flex-1 flex flex-col items-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "relative w-full flex justify-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: `w-8 rounded-t transition-all ${hitTarget ? 'bg-green-500' : 'bg-red-400'}`,
      style: {
        height: `${percent}%`,
        minHeight: week.completed > 0 ? 8 : 0
      },
      title: `${week.week}: ${week.completed}/${week.target}`
    }), /*#__PURE__*/React.createElement("div", {
      className: "absolute w-10 border-t-2 border-dashed border-gray-400",
      style: {
        bottom: `${week.target / maxValue * 100}%`
      }
    })), /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-500 mt-1"
    }, week.week), /*#__PURE__*/React.createElement("span", {
      className: "text-xs font-semibold text-gray-700"
    }, week.completed));
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center gap-4 mt-3 text-xs"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-3 h-3 bg-green-500 rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Met Target")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-3 h-3 bg-red-400 rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Below Target")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-6 border-t-2 border-dashed border-gray-400"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Target"))));
}

// ===== AUTOMATION STATUS CARD =====
function AutomationCard({
  title,
  actual,
  target,
  downtime,
  unit = 'LF'
}) {
  const percent = actual / target * 100;
  const gap = actual - target;
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-800"
  }, title), /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-bold ${getPercentColor(percent)}`
  }, percent.toFixed(0), "%")), /*#__PURE__*/React.createElement("div", {
    className: "h-3 bg-gray-200 rounded-full overflow-hidden mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: `h-full transition-all ${getPercentBgColor(percent)}`,
    style: {
      width: `${Math.min(percent, 100)}%`
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, formatNumber(actual), " / ", formatNumber(target), " ", unit), /*#__PURE__*/React.createElement("span", {
    className: gap >= 0 ? 'text-green-600' : 'text-red-600'
  }, gap >= 0 ? '+' : '', formatNumber(gap), " ", unit)), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 pt-2 border-t border-gray-100"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, "Downtime: ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-gray-700"
  }, downtime.toFixed(1), " hrs"))));
}

// ===== PROJECT PROGRESS BAR =====
function ProjectProgressBar({
  project,
  completedModules,
  totalModules
}) {
  const percent = totalModules > 0 ? completedModules / totalModules * 100 : 0;
  const isComplete = percent >= 100;
  return /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 py-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-36 truncate"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-800 text-sm"
  }, project.name)), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 h-4 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: `h-full transition-all ${isComplete ? 'bg-green-500' : 'bg-blue-500'}`,
    style: {
      width: `${percent}%`
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "w-24 text-right"
  }, /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-semibold ${isComplete ? 'text-green-600' : 'text-gray-700'}`
  }, isComplete ? 'Complete' : `${completedModules}/${totalModules}`)), /*#__PURE__*/React.createElement("div", {
    className: "w-12 text-right"
  }, /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-medium ${getPercentColor(percent)}`
  }, percent.toFixed(0), "%")));
}

// ===== FACTORY COMPARISON CARD =====
function FactoryCard({
  factory,
  metrics
}) {
  const percent = metrics.target > 0 ? metrics.completed / metrics.target * 100 : 0;
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-4 flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, factory.icon), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-800"
  }, factory.name), factory.location && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, factory.location)), factory.isFake && /*#__PURE__*/React.createElement("span", {
    className: "ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full"
  }, "Sample Data")), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "This Week"), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, metrics.completed, "/", metrics.target, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "h-2 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: `h-full ${getPercentBgColor(percent)}`,
    style: {
      width: `${Math.min(percent, 100)}%`
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-xs text-gray-500"
  }, /*#__PURE__*/React.createElement("span", null, "Efficiency: ", percent.toFixed(0), "%"))));
}

// ===== MAIN EXECUTIVE DASHBOARD COMPONENT =====
function ExecutiveDashboard({
  projects = [],
  completedWeeks = [],
  scheduleSetup = {},
  currentWeek = null
}) {
  const [selectedFactory, setSelectedFactory] = React.useState('all');
  const [lastRefresh, setLastRefresh] = React.useState(new Date());

  // Calculate line balance (weekly target)
  const lineBalance = React.useMemo(() => {
    const shift1 = scheduleSetup?.shift1 || {};
    const shift2 = scheduleSetup?.shift2 || {};
    return Object.values(shift1).reduce((sum, v) => sum + (v || 0), 0) + Object.values(shift2).reduce((sum, v) => sum + (v || 0), 0);
  }, [scheduleSetup]);
  const weeklyTarget = lineBalance || 21; // Default to 21 if not set

  // ===== COMPUTE METRICS =====
  const metrics = React.useMemo(() => {
    const activeProjects = projects.filter(p => p.status === 'Active');
    const allModules = projects.flatMap(p => (p.modules || []).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name
    })));

    // Count completed modules (close-up = 100%)
    const completedModules = allModules.filter(m => m.stageProgress?.['close-up'] === 100).length;

    // Get this week's completed count from currentWeek or estimate
    const thisWeekCompleted = currentWeek?.modulesCompleted || completedWeeks[0]?.modulesCompleted || Math.floor(Math.random() * 5) + 16; // Placeholder

    // Get last week's data
    const lastWeekData = completedWeeks[0] || {
      modulesCompleted: 19,
      lineBalance: weeklyTarget
    };

    // Build weekly history for chart (last 8 weeks)
    const weeklyHistory = [];
    for (let i = 7; i >= 0; i--) {
      const weekData = completedWeeks[i];
      if (weekData) {
        weeklyHistory.push({
          week: `W${8 - i}`,
          completed: weekData.modulesCompleted || 0,
          target: weekData.lineBalance || weeklyTarget
        });
      } else {
        // Generate placeholder data for demo
        weeklyHistory.push({
          week: `W${8 - i}`,
          completed: Math.floor(Math.random() * 6) + 16,
          target: weeklyTarget
        });
      }
    }

    // Quarter calculations
    const now = new Date();
    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
    const weeksInQuarter = Math.ceil((now - quarterStart) / (7 * 24 * 60 * 60 * 1000));
    const quarterTarget = weeksInQuarter * weeklyTarget;
    const quarterTotal = weeklyHistory.reduce((sum, w) => sum + w.completed, 0);

    // Full quarter projection (13 weeks)
    const avgWeekly = quarterTotal / Math.max(weeksInQuarter, 1);
    const quarterProjection = Math.round(avgWeekly * 13);

    // Project-level metrics
    const projectMetrics = activeProjects.map(p => {
      const modules = p.modules || [];
      const completed = modules.filter(m => m.stageProgress?.['close-up'] === 100).length;
      return {
        project: p,
        completed,
        total: modules.length
      };
    });
    return {
      thisWeek: {
        completed: thisWeekCompleted,
        target: weeklyTarget
      },
      lastWeek: {
        completed: lastWeekData.modulesCompleted || 19,
        target: lastWeekData.lineBalance || weeklyTarget
      },
      quarterTotal,
      quarterTarget,
      quarterProjection,
      weeklyHistory,
      projectMetrics,
      activeProjects,
      totalModules: allModules.length,
      completedModules
    };
  }, [projects, completedWeeks, currentWeek, weeklyTarget]);

  // Get automation data based on selected factory
  const automationData = React.useMemo(() => {
    return getAutomationData(selectedFactory === 'all' ? 'nampa' : selectedFactory);
  }, [selectedFactory]);

  // Factory-specific metrics
  const factoryMetrics = React.useMemo(() => {
    if (selectedFactory === 'all') {
      return {
        nampa: metrics.thisWeek,
        factory2: FACTORY2_FAKE_DATA.thisWeek
      };
    }
    return null;
  }, [selectedFactory, metrics]);

  // Manual refresh
  const handleRefresh = () => {
    setLastRefresh(new Date());
  };

  // Determine status for KPI cards
  const getStatus = (completed, target) => {
    const percent = completed / target * 100;
    if (percent >= 95) return 'good';
    if (percent >= 80) return 'warning';
    return 'critical';
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold text-gray-900"
  }, "Executive Dashboard"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "High-level operational overview \u2022 Updated ", lastRefresh.toLocaleTimeString())), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("select", {
    value: selectedFactory,
    onChange: e => setSelectedFactory(e.target.value),
    className: "px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, FACTORIES.map(f => /*#__PURE__*/React.createElement("option", {
    key: f.id,
    value: f.id
  }, f.icon, " ", f.name))), /*#__PURE__*/React.createElement("button", {
    onClick: handleRefresh,
    className: "px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition"
  }, "\u21BB Refresh"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-6 text-white"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-lg font-semibold mb-4 opacity-90"
  }, "Production Scorecard"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement(KPICard, {
    title: "This Week",
    value: metrics.thisWeek.completed,
    target: metrics.thisWeek.target,
    subtitle: `${(metrics.thisWeek.completed / metrics.thisWeek.target * 100).toFixed(0)}% to target`,
    status: getStatus(metrics.thisWeek.completed, metrics.thisWeek.target),
    large: true
  }), /*#__PURE__*/React.createElement(KPICard, {
    title: "Last Week",
    value: metrics.lastWeek.completed,
    target: metrics.lastWeek.target,
    subtitle: `${(metrics.lastWeek.completed / metrics.lastWeek.target * 100).toFixed(0)}% to target`,
    status: getStatus(metrics.lastWeek.completed, metrics.lastWeek.target)
  }), /*#__PURE__*/React.createElement(KPICard, {
    title: `${getCurrentQuarter()} Total`,
    value: metrics.quarterTotal,
    subtitle: "modules completed",
    status: "good"
  }), /*#__PURE__*/React.createElement(KPICard, {
    title: `${getCurrentQuarter()} Projection`,
    value: metrics.quarterProjection,
    target: metrics.quarterTarget,
    subtitle: "projected by quarter end",
    status: getStatus(metrics.quarterProjection, metrics.quarterTarget)
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 lg:grid-cols-2 gap-6"
  }, /*#__PURE__*/React.createElement(WeeklyTrendChart, {
    data: metrics.weeklyHistory,
    target: weeklyTarget
  }), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-800"
  }, "Automation Status"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full"
  }, "Daily Summary")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 sm:grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement(AutomationCard, {
    title: "Wall Line",
    actual: automationData.wallLine.actual,
    target: automationData.wallLine.target,
    downtime: automationData.wallLine.downtime,
    unit: automationData.wallLine.unit || 'LF'
  }), /*#__PURE__*/React.createElement(AutomationCard, {
    title: "Floor Line",
    actual: automationData.floorLine.actual,
    target: automationData.floorLine.target,
    downtime: automationData.floorLine.downtime,
    unit: automationData.floorLine.unit || 'LF'
  })), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 mt-3 text-center"
  }, "* Automation data updates once per day"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-800 mb-4"
  }, "Project Pipeline"), metrics.projectMetrics.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "divide-y divide-gray-100"
  }, metrics.projectMetrics.map(({
    project,
    completed,
    total
  }) => /*#__PURE__*/React.createElement(ProjectProgressBar, {
    key: project.id,
    project: project,
    completedModules: completed,
    totalModules: total
  }))) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-3xl"
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("p", {
    className: "mt-2"
  }, "No active projects"))), selectedFactory === 'all' && factoryMetrics && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-xl border border-gray-200 p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-800 mb-4"
  }, "Factory Comparison"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement(FactoryCard, {
    factory: FACTORIES.find(f => f.id === 'nampa'),
    metrics: factoryMetrics.nampa
  }), /*#__PURE__*/React.createElement(FactoryCard, {
    factory: FACTORIES.find(f => f.id === 'factory2'),
    metrics: factoryMetrics.factory2
  }))), /*#__PURE__*/React.createElement("div", {
    className: "text-center text-xs text-gray-400 py-2"
  }, "Executive Dashboard \u2022 Data refreshes on page load \u2022 Factory 2 data is placeholder"));
}

// Export for use in MODA
window.ExecutiveDashboard = ExecutiveDashboard;
})();


// ============================================================================
// FILE: DashboardHome.jsx
// ============================================================================
(function() {
/**
 * DashboardHome.jsx - Role-Based Dashboard Home
 * 
 * Phase 2 & 5 of MODA Dashboard Migration
 * Provides a central hub with role-adaptive widgets showing key metrics
 * 
 * Role Views:
 * - Admin: Full overview with all widgets + system health
 * - Executive: High-level KPIs, project timeline, completion trends
 * - Supervisor: Production focus, crew assignments, bottlenecks, daily targets
 * - Coordinator: Production flow, cross-department handoffs
 * - Employee: Personal station, assignments, training status
 */

// Dashboard Home Component
function DashboardHome({
  projects = [],
  employees = [],
  auth,
  onNavigate // callback to switch tabs
}) {
// [Removed duplicate React destructuring]
  // Get user's role for adaptive content
  const userRole = auth?.userRole?.id || auth?.currentUser?.dashboardRole || 'employee';
  const userName = auth?.currentUser?.name || auth?.currentUser?.firstName || 'User';

  // Current time for greeting
  const [currentTime, setCurrentTime] = useState(new Date());
  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 60000);
    return () => clearInterval(timer);
  }, []);
  const greeting = useMemo(() => {
    const hour = currentTime.getHours();
    if (hour < 12) return 'Good morning';
    if (hour < 17) return 'Good afternoon';
    return 'Good evening';
  }, [currentTime]);

  // Calculate production metrics from projects
  const metrics = useMemo(() => {
    const activeProjects = projects.filter(p => p.status === 'Active');
    const allModules = activeProjects.flatMap(p => p.modules || []);

    // Count modules by status
    let inProgress = 0;
    let completed = 0;
    let notStarted = 0;
    allModules.forEach(module => {
      const stages = module.stageProgress || {};
      const stageValues = Object.values(stages);
      const avgProgress = stageValues.length > 0 ? stageValues.reduce((a, b) => a + b, 0) / stageValues.length : 0;
      if (avgProgress === 0) notStarted++;else if (avgProgress >= 100) completed++;else inProgress++;
    });

    // Find bottlenecks (stations with most in-progress modules)
    const stationCounts = {};
    allModules.forEach(module => {
      const stages = module.stageProgress || {};
      Object.entries(stages).forEach(([stageId, progress]) => {
        if (progress > 0 && progress < 100) {
          stationCounts[stageId] = (stationCounts[stageId] || 0) + 1;
        }
      });
    });
    const bottlenecks = Object.entries(stationCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([stageId, count]) => ({
      stageId,
      count
    }));
    return {
      activeProjects: activeProjects.length,
      totalModules: allModules.length,
      inProgress,
      completed,
      notStarted,
      bottlenecks
    };
  }, [projects]);

  // Stage name lookup
  const stageNames = {
    'frame': 'Framing',
    'rough': 'Rough-In',
    'closeIn': 'Close-In',
    'finish': 'Finish',
    'closeUp': 'Close-Up',
    'wrap': 'Wrap'
  };

  // Quick actions based on role - using CSS icon classes
  const quickActions = useMemo(() => {
    const actions = [{
      id: 'production',
      label: 'Production Board',
      iconClass: 'icon-production',
      tab: 'production'
    }, {
      id: 'projects',
      label: 'Projects',
      iconClass: 'icon-projects',
      tab: 'projects'
    }];
    if (['admin', 'department-supervisor', 'coordinator'].includes(userRole)) {
      actions.push({
        id: 'people',
        label: 'People',
        iconClass: 'icon-people',
        tab: 'people'
      });
    }
    if (['admin', 'executive'].includes(userRole)) {
      actions.push({
        id: 'executive',
        label: 'Executive View',
        iconClass: 'icon-executive',
        tab: 'executive'
      });
    }
    if (userRole === 'admin') {
      actions.push({
        id: 'admin',
        label: 'Admin',
        iconClass: 'icon-admin',
        tab: 'admin'
      });
    }
    return actions;
  }, [userRole]);
  return /*#__PURE__*/React.createElement("div", {
    className: "dashboard-home"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, greeting, ", ", userName), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm"
  }, currentTime.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }))), /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-sm font-semibold text-gray-500 uppercase mb-3"
  }, "Quick Actions"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"
  }, quickActions.map(action => /*#__PURE__*/React.createElement("button", {
    key: action.id,
    onClick: () => onNavigate?.(action.tab),
    className: "quick-action-card bg-white rounded-lg p-4 shadow-sm border border-gray-200 hover:shadow-md hover:border-gray-300 transition-all text-left"
  }, /*#__PURE__*/React.createElement("span", {
    className: `quick-action-icon ${action.iconClass}`,
    style: {
      width: '28px',
      height: '28px',
      display: 'block',
      marginBottom: '8px'
    }
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-sm",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, action.label))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "metric-card bg-white rounded-lg p-4 shadow-sm border-l-4",
    style: {
      borderLeftColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, metrics.activeProjects), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Active Projects")), /*#__PURE__*/React.createElement("div", {
    className: "metric-card bg-white rounded-lg p-4 shadow-sm border-l-4",
    style: {
      borderLeftColor: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, metrics.totalModules), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Total Modules")), /*#__PURE__*/React.createElement("div", {
    className: "metric-card bg-white rounded-lg p-4 shadow-sm border-l-4",
    style: {
      borderLeftColor: '#F59E0B'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: '#F59E0B'
    }
  }, metrics.inProgress), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "In Progress")), /*#__PURE__*/React.createElement("div", {
    className: "metric-card bg-white rounded-lg p-4 shadow-sm border-l-4",
    style: {
      borderLeftColor: '#10B981'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: '#10B981'
    }
  }, metrics.completed), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Completed"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 lg:grid-cols-2 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-alert",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " Stations Needing Attention"), metrics.bottlenecks.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, metrics.bottlenecks.map(({
    stageId,
    count
  }) => /*#__PURE__*/React.createElement("div", {
    key: stageId,
    className: "flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-200"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, stageNames[stageId] || stageId), /*#__PURE__*/React.createElement("span", {
    className: "text-amber-700 font-semibold"
  }, count, " modules")))) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-400"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-check",
    style: {
      width: '40px',
      height: '40px',
      display: 'block',
      margin: '0 auto 8px',
      filter: 'invert(48%) sepia(79%) saturate(2476%) hue-rotate(130deg) brightness(95%) contrast(95%)'
    }
  }), "No bottlenecks detected")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-projects",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " Active Projects"), projects.filter(p => p.status === 'Active').length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-64 overflow-y-auto"
  }, projects.filter(p => p.status === 'Active').slice(0, 5).map(project => {
    const moduleCount = project.modules?.length || 0;
    const completedCount = (project.modules || []).filter(m => {
      const stages = m.stageProgress || {};
      const avg = Object.values(stages).reduce((a, b) => a + b, 0) / (Object.values(stages).length || 1);
      return avg >= 100;
    }).length;
    const progress = moduleCount > 0 ? Math.round(completedCount / moduleCount * 100) : 0;
    return /*#__PURE__*/React.createElement("div", {
      key: project.id,
      className: "p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer transition",
      onClick: () => onNavigate?.('projects')
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, project.name), /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-500"
    }, moduleCount, " modules")), /*#__PURE__*/React.createElement("div", {
      className: "w-full bg-gray-200 rounded-full h-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-2 rounded-full transition-all",
      style: {
        width: `${progress}%`,
        backgroundColor: progress === 100 ? '#10B981' : 'var(--autovol-teal)'
      }
    })), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, progress, "% complete"));
  })) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-400"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder",
    style: {
      width: '40px',
      height: '40px',
      display: 'block',
      margin: '0 auto 8px',
      opacity: '0.5'
    }
  }), "No active projects"))), ['admin', 'department-supervisor', 'coordinator'].includes(userRole) && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center justify-between",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-tracker",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), "This Week's Schedule"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onNavigate?.('production'),
    className: "text-xs px-3 py-1 rounded-lg transition",
    style: {
      backgroundColor: 'var(--autovol-teal)',
      color: 'white'
    }
  }, "View Production \u2192")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-blue-50 rounded-lg text-center border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-700"
  }, metrics.inProgress), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600"
  }, "In Production")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-amber-50 rounded-lg text-center border border-amber-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-amber-700"
  }, metrics.bottlenecks.length), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-amber-600"
  }, "Bottlenecks")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-green-50 rounded-lg text-center border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-700"
  }, metrics.completed), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-green-600"
  }, "Completed")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded-lg text-center border border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, metrics.notStarted), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600"
  }, "Not Started")))), userRole === 'executive' && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-executive",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " Executive Summary"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-blue-600 font-medium mb-1"
  }, "Completion Rate"), /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-blue-800"
  }, metrics.totalModules > 0 ? Math.round(metrics.completed / metrics.totalModules * 100) : 0, "%"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600 mt-1"
  }, metrics.completed, " of ", metrics.totalModules, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-green-600 font-medium mb-1"
  }, "On Track"), /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-green-800"
  }, metrics.bottlenecks.length === 0 ? 'Yes' : 'Review'), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-green-600 mt-1"
  }, metrics.bottlenecks.length === 0 ? 'No bottlenecks detected' : `${metrics.bottlenecks.length} stations need attention`)), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-purple-600 font-medium mb-1"
  }, "Active Workforce"), /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-purple-800"
  }, employees.filter(e => e.status === 'Active').length), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-purple-600 mt-1"
  }, "employees on roster"))), /*#__PURE__*/React.createElement("div", {
    className: "mt-4 p-3 bg-gray-50 rounded-lg text-center"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => onNavigate?.('executive'),
    className: "text-sm font-medium px-4 py-2 rounded-lg transition",
    style: {
      backgroundColor: 'var(--autovol-navy)',
      color: 'white'
    }
  }, "View Full Executive Dashboard \u2192"))), ['admin', 'department-supervisor'].includes(userRole) && employees.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-people",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " Crew Overview"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center p-3 bg-green-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-600"
  }, employees.filter(e => e.status === 'Active').length), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Active")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-3 bg-blue-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-600"
  }, employees.filter(e => e.shift === 'Day').length), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Day Shift")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-3 bg-purple-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-purple-600"
  }, employees.filter(e => e.shift === 'Night').length), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Night Shift")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-3 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-gray-600"
  }, employees.length), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Total"))), /*#__PURE__*/React.createElement("div", {
    className: "mt-4 p-4 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg border border-teal-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-teal-700 font-medium"
  }, "Today's Target"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-teal-600"
  }, "Modules to complete all stations")), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, metrics.inProgress > 0 ? Math.min(5, metrics.inProgress) : 0), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-teal-600"
  }, "modules in queue"))))), userRole === 'coordinator' && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-production",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " Production Flow"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-2"
  }, Object.entries(stageNames).map(([stageId, stageName]) => {
    const stageModules = projects.flatMap(p => p.modules || []).filter(m => {
      const progress = m.stageProgress?.[stageId] || 0;
      return progress > 0 && progress < 100;
    }).length;
    return /*#__PURE__*/React.createElement("div", {
      key: stageId,
      className: "p-3 bg-gray-50 rounded-lg text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-lg font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, stageModules), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, stageName));
  }))), userRole === 'employee' && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-people",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " My Status"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-blue-50 rounded-lg border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-blue-600 font-medium mb-1"
  }, "My Role"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-blue-800"
  }, auth?.userRole?.name || 'Employee'), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600 mt-1"
  }, auth?.userRole?.description || 'Production floor access')), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-green-50 rounded-lg border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-green-600 font-medium mb-1"
  }, "Access Level"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-green-800"
  }, auth?.visibleTabs?.length || 1, " Tab", (auth?.visibleTabs?.length || 1) !== 1 ? 's' : ''), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-green-600 mt-1"
  }, auth?.visibleTabs?.join(', ') || 'Production'))), /*#__PURE__*/React.createElement("div", {
    className: "mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200 text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-amber-700"
  }, "\uD83D\uDCA1 Need access to more features? Contact your supervisor."))), userRole === 'admin' && /*#__PURE__*/React.createElement("div", {
    className: "mt-6 bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3 flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-admin",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), " System Health"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-green-50 rounded-lg text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-green-600"
  }, "\u2713"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600"
  }, "Firebase")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-green-50 rounded-lg text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-green-600"
  }, "\u2713"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600"
  }, "Auth")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-blue-50 rounded-lg text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-blue-600"
  }, projects.length), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600"
  }, "Projects")), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-blue-50 rounded-lg text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-bold text-blue-600"
  }, employees.length), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600"
  }, "Users")))));
}

// Export for use
window.DashboardHome = DashboardHome;
})();


// ============================================================================
// FILE: NavigationGroups.jsx
// ============================================================================
(function() {
/**
 * NavigationGroups.jsx - Collapsible Navigation System
 * 
 * Phase 3 of MODA Dashboard Migration
 * Groups related tabs into collapsible sections for cleaner navigation
 * 
 * Groups:
 * - Operations: Production, Projects, Tracker, People, Automation, Equipment
 * - Projects: Precon, Engineering
 * - Quality & Site: QA, On-Site
 * - Supply & Logistics: Transport, Supply Chain
 * - Executive: Standalone
 * 
 * Easy to modify: Just update NAV_GROUPS array or STANDALONE_TABS array
 * Single-tab groups auto-render as standalone buttons (no dropdown)
 */

// Navigation group definitions
const NAV_GROUPS = [{
  id: 'operations',
  label: 'Operations',
  iconClass: 'icon-production',
  tabs: [{
    id: 'production',
    label: 'Production Board',
    iconClass: 'icon-production'
  }, {
    id: 'tracker',
    label: 'Tracker',
    iconClass: 'icon-tracker'
  }, {
    id: 'people',
    label: 'People',
    iconClass: 'icon-people'
  }, {
    id: 'automation',
    label: 'Automation',
    iconClass: 'icon-automation'
  }, {
    id: 'equipment',
    label: 'Tools & Equipment',
    iconClass: 'icon-equipment'
  }, {
    id: 'supplychain',
    label: 'Supply Chain',
    iconClass: 'icon-supply-chain'
  }]
}, {
  id: 'design',
  label: 'Projects',
  iconClass: 'icon-precon',
  tabs: [{
    id: 'projects',
    label: 'Projects',
    iconClass: 'icon-projects'
  }, {
    id: 'precon',
    label: 'Precon',
    iconClass: 'icon-precon'
  }, {
    id: 'engineering',
    label: 'Engineering',
    iconClass: 'icon-engineering'
  }, {
    id: 'drawings',
    label: 'Drawings',
    iconClass: 'icon-drawings'
  }]
}, {
  id: 'quality-site',
  label: 'Quality & Site',
  iconClass: 'icon-qa',
  tabs: [{
    id: 'qa',
    label: 'QA',
    iconClass: 'icon-qa'
  }, {
    id: 'onsite',
    label: 'On-Site',
    iconClass: 'icon-onsite'
  }]
}, {
  id: 'supply-logistics',
  label: 'Supply & Logistics',
  iconClass: 'icon-transport',
  tabs: [{
    id: 'transport',
    label: 'Transport',
    iconClass: 'icon-transport'
  }]
}];

// Standalone tabs (not in groups)
const STANDALONE_TABS = [{
  id: 'executive',
  label: 'Executive',
  iconClass: 'icon-executive'
}];

// Navigation Group Component
function NavigationGroups({
  activeTab,
  setActiveTab,
  visibleTabs = [],
  canAccessAdmin = false,
  setSelectedProject
}) {
// [Removed duplicate React destructuring]
  // Track which groups are expanded
  const [expandedGroups, setExpandedGroups] = useState({});

  // Ref for the nav container to detect outside clicks
  const navRef = useRef(null);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = event => {
      if (navRef.current && !navRef.current.contains(event.target)) {
        setExpandedGroups({});
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Filter groups to only show those with visible tabs
  const visibleGroups = useMemo(() => {
    return NAV_GROUPS.map(group => ({
      ...group,
      tabs: group.tabs.filter(tab => visibleTabs.includes(tab.id))
    })).filter(group => group.tabs.length > 0);
  }, [visibleTabs]);

  // Filter standalone tabs
  const visibleStandalone = useMemo(() => {
    return STANDALONE_TABS.filter(tab => visibleTabs.includes(tab.id));
  }, [visibleTabs]);

  // Check if active tab is in a group
  const activeGroupId = useMemo(() => {
    for (const group of visibleGroups) {
      if (group.tabs.some(tab => tab.id === activeTab)) {
        return group.id;
      }
    }
    return null;
  }, [activeTab, visibleGroups]);

  // Toggle group expansion - only one dropdown at a time
  const toggleGroup = groupId => {
    setExpandedGroups(prev => {
      // If this group is already open, close it
      if (prev[groupId]) {
        return {};
      }
      // Otherwise, close all others and open this one
      return {
        [groupId]: true
      };
    });
  };

  // Handle tab click
  const handleTabClick = tabId => {
    setActiveTab(tabId);
    setExpandedGroups({}); // Close all dropdowns
    if (setSelectedProject) setSelectedProject(null);
  };

  // Check if group should show as expanded (dropdown visible)
  const isGroupExpanded = groupId => {
    // Only use manual expansion state - user controls dropdown visibility
    return expandedGroups[groupId] || false;
  };

  // Check if group contains the active tab (for styling)
  const isGroupActive = groupId => {
    return activeGroupId === groupId;
  };
  return /*#__PURE__*/React.createElement("nav", {
    ref: navRef,
    className: "nav-groups bg-white border-b nav-groups-container"
  }, /*#__PURE__*/React.createElement("div", {
    className: "max-w-7xl mx-auto px-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1 overflow-x-auto nav-groups-wrapper"
  }, window.MODA_FEATURE_FLAGS?.isEnabled('enableDashboardHome') && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleTabClick('home'),
    className: `nav-tab px-4 py-3 text-sm font-medium transition rounded-t-lg whitespace-nowrap ${activeTab === 'home' ? 'active' : ''}`,
    style: activeTab === 'home' ? {
      backgroundColor: 'var(--autovol-teal)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tab-icon icon-home"
  }), "Home"), visibleStandalone.map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => handleTabClick(tab.id),
    className: `nav-tab px-4 py-3 text-sm font-medium transition rounded-t-lg whitespace-nowrap ${activeTab === tab.id ? 'active' : ''}`,
    style: activeTab === tab.id ? {
      backgroundColor: 'var(--autovol-red)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tab-icon ${tab.iconClass}`
  }), tab.label)), visibleGroups.map(group => /*#__PURE__*/React.createElement("div", {
    key: group.id,
    className: "nav-group relative"
  }, group.tabs.length === 1 ? /*#__PURE__*/React.createElement("button", {
    onClick: () => handleTabClick(group.tabs[0].id),
    className: `nav-tab px-4 py-3 text-sm font-medium transition rounded-t-lg whitespace-nowrap ${activeTab === group.tabs[0].id ? 'active' : ''}`,
    style: activeTab === group.tabs[0].id ? {
      backgroundColor: 'var(--autovol-red)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tab-icon ${group.tabs[0].iconClass}`
  }), group.tabs[0].label) :
  /*#__PURE__*/
  /* Group has multiple tabs - render as dropdown */
  React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleGroup(group.id),
    className: `nav-group-header nav-group-button px-4 py-3 text-sm font-medium transition rounded-t-lg whitespace-nowrap flex items-center gap-1 ${activeGroupId === group.id ? 'active' : ''}`,
    style: activeGroupId === group.id ? {
      backgroundColor: 'var(--autovol-red)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tab-icon ${group.iconClass}`
  }), group.label, /*#__PURE__*/React.createElement("span", {
    className: `dropdown-arrow ${isGroupExpanded(group.id) ? 'expanded' : ''}`,
    style: {
      fontSize: '10px',
      marginLeft: '4px',
      transition: 'transform 0.2s'
    }
  }, isGroupExpanded(group.id) ? '▲' : '▼')), isGroupExpanded(group.id) && /*#__PURE__*/React.createElement("div", {
    className: "nav-dropdown absolute top-full left-0 bg-white shadow-lg rounded-b-lg border border-gray-200 min-w-48 z-50"
  }, group.tabs.map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => handleTabClick(tab.id),
    className: `nav-dropdown-item w-full px-4 py-2 text-sm text-left hover:bg-gray-50 flex items-center gap-2 ${activeTab === tab.id ? 'bg-gray-100 font-medium' : ''}`,
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tab-icon ${tab.iconClass}`,
    style: {
      width: '16px',
      height: '16px'
    }
  }), tab.label, activeTab === tab.id && /*#__PURE__*/React.createElement("span", {
    className: "ml-auto",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, "\u25CF"))))))), canAccessAdmin && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleTabClick('admin'),
    className: `nav-tab px-4 py-3 text-sm font-medium transition rounded-t-lg ml-auto whitespace-nowrap ${activeTab === 'admin' ? 'active' : ''}`,
    style: activeTab === 'admin' ? {
      backgroundColor: 'var(--autovol-navy)',
      color: 'white'
    } : {
      backgroundColor: 'var(--autovol-gray-bg)',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tab-icon icon-admin"
  }), "Admin"))));
}

// Export for use
window.NavigationGroups = NavigationGroups;
window.NAV_GROUPS = NAV_GROUPS;
})();


// ============================================================================
// FILE: UserProfileModal.jsx
// ============================================================================
(function() {
/**
 * UserProfileModal.jsx - User Profile View
 * 
 * Phase 6 of MODA Dashboard Migration
 * Shows current user's profile information when clicking their name
 * 
 * Sections:
 * - Identity: Name, email, profile initials
 * - Role & Access: Dashboard role, visible tabs, permissions
 * - Employment: Job title, department, shift, hire date
 * - Account: Status, last login
 */

function UserProfileModal({
  auth,
  employees = [],
  onClose,
  darkMode,
  setDarkMode
}) {
// [Removed duplicate React destructuring]
  const viewportSize = window.useViewportSize ? window.useViewportSize() : 'desktop';
  const isMobileOrTablet = viewportSize === 'mobile' || viewportSize === 'tablet';

  // Find employee record for current user
  const employeeRecord = useMemo(() => {
    const email = auth?.currentUser?.email;
    if (!email) return null;
    return employees.find(e => (e.email || '').toLowerCase() === (email || '').toLowerCase());
  }, [auth?.currentUser?.email, employees]);

  // Get user initials for avatar
  const initials = useMemo(() => {
    const name = auth?.currentUser?.name || auth?.currentUser?.firstName || 'U';
    const parts = name.split(' ');
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  }, [auth?.currentUser]);

  // Format date helper
  const formatDate = dateStr => {
    if (!dateStr) return 'Not set';
    try {
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch {
      return dateStr;
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6 border-b border-gray-200 flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold text-white",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, initials), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, auth?.currentUser?.name || 'User'), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, auth?.currentUser?.email)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl font-bold"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-500 uppercase mb-3 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-admin",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Role & Access"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 space-y-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Dashboard Role"), /*#__PURE__*/React.createElement("span", {
    className: "px-3 py-1 rounded-full text-sm font-medium",
    style: {
      backgroundColor: auth?.isAdmin ? 'var(--autovol-red)' : 'var(--autovol-teal)',
      color: 'white'
    }
  }, auth?.userRole?.name || auth?.currentUser?.dashboardRole || 'User')), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Visible Tabs"), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, auth?.visibleTabs?.length || 0, " tabs"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-400 mt-1 max-w-48"
  }, auth?.visibleTabs?.slice(0, 5).join(', '), auth?.visibleTabs?.length > 5 && ` +${auth.visibleTabs.length - 5} more`))), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Can Edit"), /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-medium ${auth?.userRole?.capabilities?.canEdit ? 'text-green-600' : 'text-gray-400'}`
  }, auth?.userRole?.capabilities?.canEdit ? 'Yes' : 'View Only')), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Admin Access"), /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-medium ${auth?.canAccessAdmin ? 'text-green-600' : 'text-gray-400'}`
  }, auth?.canAccessAdmin ? 'Yes' : 'No')))), employeeRecord && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-500 uppercase mb-3 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-people",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Employment"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 space-y-3"
  }, employeeRecord.jobTitle && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Job Title"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, employeeRecord.jobTitle)), employeeRecord.department && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Department"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, employeeRecord.department)), employeeRecord.shift && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Shift"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, employeeRecord.shift)), employeeRecord.hireDate && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Hire Date"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, formatDate(employeeRecord.hireDate))), employeeRecord.phone && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Phone"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, employeeRecord.phone)))), isMobileOrTablet && setDarkMode && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-500 uppercase mb-3 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-cog",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Settings"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 space-y-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Theme"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setDarkMode(prev => !prev),
    className: "flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition touch-target"
  }, /*#__PURE__*/React.createElement("span", {
    className: darkMode ? 'icon-sun' : 'icon-moon',
    style: {
      width: '18px',
      height: '18px',
      display: 'inline-block'
    }
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium"
  }, darkMode ? 'Light Mode' : 'Dark Mode'))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-500 uppercase mb-3 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-tracker",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Account"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 space-y-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Status"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700"
  }, "Active")), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, "Email Verified"), /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-medium ${auth?.currentUser?.emailVerified ? 'text-green-600' : 'text-amber-600'}`
  }, auth?.currentUser?.emailVerified ? 'Yes' : 'Pending'))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center text-xs text-gray-400"
  }, "Need to update your information? Contact your administrator."))));
}

// Export for use
window.UserProfileModal = UserProfileModal;
})();


// ============================================================================
// FILE: QAModule.jsx
// ============================================================================
(function() {
// ============================================================================
// QA MODULE - Quality Assurance & Quality Control Management
// Based on Autovol QA Traveler (Version 240117)
// ============================================================================
// QC = Supervisors/Team Leaders (responsible work-party, signs off traveler items)
// QA = QA Manager & Inspectors (documentation, ensuring compliance with QA manual)
// NTA = Third-Party Inspection Agency (State regulatory compliance)
// ============================================================================

// Stop Stations - Require QA approval to progress
const STOP_STATIONS = ['Mezzanine', 'Prior to Drywall-Back Panel', 'Prior to Module Sign-Off'];

// Traveler Status Categories
const TRAVELER_STATUS = {
  ACTIVE: 'active',
  // In production, linked to weekly board
  PENDING_APPROVAL: 'pending_approval',
  // Completed all stations, awaiting QA Manager sign-off
  COMPLETE: 'complete' // QA Manager approved, traveler closed
};

// Import constants (will be loaded via script tag)
const getQAConstants = () => window.QA_CONSTANTS || {
  PRODUCTION_STATIONS: [],
  CONFORMANCE_STATUS: {},
  DEPARTMENTS: [],
  TEST_TYPES: {},
  DEVIATION_PRIORITIES: [],
  DEVIATION_STATUS: {}
};

// ============================================================================
// MAIN QA MODULE COMPONENT
// ============================================================================
function QAModule({
  projects = [],
  employees = [],
  currentUser = {},
  canEdit = true
}) {
  const QA = getQAConstants();

  // Filter to active projects only (consistent with WeeklyBoard, DashboardHome)
  const activeProjects = React.useMemo(() => projects.filter(p => p.status === 'Active'), [projects]);

  // Active sub-tab
  const [activeSubTab, setActiveSubTab] = React.useState('dashboard');

  // Safe JSON parse helper
  const safeParseJSON = (str, fallback) => {
    if (str && str !== 'undefined' && str !== 'null') {
      try {
        return JSON.parse(str);
      } catch (e) {
        return fallback;
      }
    }
    return fallback;
  };

  // QA Travelers (one per module) - keyed by module serial number
  const [travelers, setTravelers] = React.useState({});

  // Deviations (NC items)
  const [deviations, setDeviations] = React.useState([]);

  // Test Results
  const [testResults, setTestResults] = React.useState([]);

  // Loading state
  const [isLoading, setIsLoading] = React.useState(true);

  // Filters
  const [selectedProject, setSelectedProject] = React.useState('all');
  const [selectedDepartment, setSelectedDepartment] = React.useState('all');
  const [selectedStation, setSelectedStation] = React.useState('all');

  // Modal states
  const [showTravelerModal, setShowTravelerModal] = React.useState(false);
  const [showDeviationModal, setShowDeviationModal] = React.useState(false);
  const [showTestModal, setShowTestModal] = React.useState(false);
  const [selectedModule, setSelectedModule] = React.useState(null);
  const [selectedTraveler, setSelectedTraveler] = React.useState(null);

  // Load data from Supabase on mount
  React.useEffect(() => {
    const loadData = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[QA] Loading data from Supabase...');
          const [travelersData, deviationsData, testsData] = await Promise.all([window.MODA_SUPABASE_DATA.qa.getTravelers(), window.MODA_SUPABASE_DATA.qa.getDeviations(), window.MODA_SUPABASE_DATA.qa.getTests()]);

          // Convert travelers array to object keyed by module_id
          const travelersObj = {};
          travelersData.forEach(t => {
            travelersObj[t.module_id] = t.checklist || {};
          });
          setTravelers(travelersObj);
          setDeviations(deviationsData);
          setTestResults(testsData);
          console.log('[QA] Loaded from Supabase:', travelersData.length, 'travelers,', deviationsData.length, 'deviations,', testsData.length, 'tests');
        } else {
          // Fallback to localStorage
          console.log('[QA] Supabase not available, using localStorage');
          const savedTravelers = localStorage.getItem('moda_qa_travelers');
          const savedDeviations = localStorage.getItem('moda_qa_deviations');
          const savedTests = localStorage.getItem('moda_qa_tests');
          setTravelers(safeParseJSON(savedTravelers, {}));
          setDeviations(safeParseJSON(savedDeviations, []));
          setTestResults(safeParseJSON(savedTests, []));
        }
      } catch (error) {
        console.error('[QA] Error loading data:', error);
        // Fallback to localStorage on error
        const savedTravelers = localStorage.getItem('moda_qa_travelers');
        const savedDeviations = localStorage.getItem('moda_qa_deviations');
        const savedTests = localStorage.getItem('moda_qa_tests');
        setTravelers(safeParseJSON(savedTravelers, {}));
        setDeviations(safeParseJSON(savedDeviations, []));
        setTestResults(safeParseJSON(savedTests, []));
      } finally {
        setIsLoading(false);
      }
    };

    // Wait for Supabase to initialize
    const timer = setTimeout(loadData, 500);
    return () => clearTimeout(timer);
  }, []);

  // Save travelers to Supabase (debounced)
  const lastSavedTravelers = React.useRef(null);
  React.useEffect(() => {
    if (isLoading) return;

    // Always save to localStorage as backup
    localStorage.setItem('moda_qa_travelers', JSON.stringify(travelers));

    // Sync to Supabase
    if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
      const syncTravelers = async () => {
        const lastTravelers = lastSavedTravelers.current || {};
        for (const [moduleId, checklist] of Object.entries(travelers)) {
          if (JSON.stringify(lastTravelers[moduleId]) !== JSON.stringify(checklist)) {
            try {
              await window.MODA_SUPABASE_DATA.qa.saveTraveler({
                module_id: moduleId,
                checklist: checklist
              });
            } catch (err) {
              console.error('[QA] Error saving traveler:', err);
            }
          }
        }
        lastSavedTravelers.current = JSON.parse(JSON.stringify(travelers));
      };
      const timeout = setTimeout(syncTravelers, 1000);
      return () => clearTimeout(timeout);
    }
  }, [travelers, isLoading]);

  // Save deviations to localStorage (Supabase sync happens on create/update)
  React.useEffect(() => {
    if (isLoading) return;
    localStorage.setItem('moda_qa_deviations', JSON.stringify(deviations));
  }, [deviations, isLoading]);

  // Save test results to localStorage (Supabase sync happens on create)
  React.useEffect(() => {
    if (isLoading) return;
    localStorage.setItem('moda_qa_tests', JSON.stringify(testResults));
  }, [testResults, isLoading]);

  // Production stage IDs (must match App.jsx)
  const PRODUCTION_STAGE_IDS = ['auto-c', 'auto-f', 'auto-walls', 'mezzanine', 'elec-ceiling', 'wall-set', 'ceiling-set', 'soffits', 'mech-rough', 'elec-rough', 'plumb-rough', 'exteriors', 'drywall-bp', 'drywall-ttp', 'roofing', 'pre-finish', 'mech-trim', 'elec-trim', 'plumb-trim', 'final-finish', 'sign-off', 'close-up'];

  // Check if module completed all stations (ALL stages at 100%)
  const isModuleFullyComplete = module => {
    const stageProgress = module.stageProgress || {};
    return PRODUCTION_STAGE_IDS.every(stageId => stageProgress[stageId] === 100);
  };

  // Auto-transition travelers to Pending Approval when module completes all stations
  React.useEffect(() => {
    let hasChanges = false;
    const updatedTravelers = {
      ...travelers
    };
    projects.forEach(project => {
      (project.modules || []).forEach(module => {
        const travelerId = `${project.id}-${module.id}`;
        const traveler = updatedTravelers[travelerId];
        const isComplete = isModuleFullyComplete(module);

        // If module completed all stations and traveler is still active, move to pending
        if (isComplete && traveler && traveler.status === TRAVELER_STATUS.ACTIVE) {
          updatedTravelers[travelerId] = {
            ...traveler,
            status: TRAVELER_STATUS.PENDING_APPROVAL,
            completedProductionAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString()
          };
          hasChanges = true;
        }
      });
    });
    if (hasChanges) {
      setTravelers(updatedTravelers);
    }
  }, [projects]); // Re-run when projects change (module progress updates)

  // Get all modules from active projects only
  const allModules = React.useMemo(() => {
    const modules = [];
    activeProjects.forEach(project => {
      (project.modules || []).forEach(module => {
        modules.push({
          ...module,
          projectId: project.id,
          projectName: project.name,
          traveler: travelers[`${project.id}-${module.id}`] || null
        });
      });
    });
    return modules;
  }, [activeProjects, travelers]);

  // Filter modules by project (handle both string and number IDs)
  const filteredModules = React.useMemo(() => {
    if (selectedProject === 'all') return allModules;
    // Compare as strings to handle both UUID and numeric IDs
    return allModules.filter(m => String(m.projectId) === String(selectedProject));
  }, [allModules, selectedProject]);

  // Helper: Check if module is online (has started production)
  const isModuleOnline = module => {
    const stageProgress = module.stageProgress || {};
    return Object.values(stageProgress).some(progress => progress > 0);
  };

  // Calculate QA metrics
  const metrics = React.useMemo(() => {
    const openDeviations = deviations.filter(d => d.status !== 'closed').length;
    const criticalDeviations = deviations.filter(d => d.priority === 'critical' && d.status !== 'closed').length;
    const closedDeviations = deviations.filter(d => d.status === 'closed').length;
    const totalTests = testResults.length;
    const passedTests = testResults.filter(t => t.result === 'PASS').length;
    const failedTests = testResults.filter(t => t.result === 'FAIL').length;

    // Count inspections across all travelers
    let totalInspections = 0;
    let passedInspections = 0;
    let ncInspections = 0;
    Object.values(travelers).forEach(traveler => {
      if (traveler.departmentChecklists) {
        traveler.departmentChecklists.forEach(dept => {
          (dept.items || []).forEach(item => {
            if (item.conformance) {
              totalInspections++;
              if (item.conformance === 'PASS') passedInspections++;
              if (item.conformance === 'NC') ncInspections++;
            }
          });
        });
      }
    });

    // Count modules by status (matching TravelersPanel logic)
    // Active = Online modules not yet complete (close-up < 100)
    // Pending = Completed all stations, awaiting QA approval
    // Complete = QA approved
    const activeModules = filteredModules.filter(m => {
      const online = isModuleOnline(m);
      const complete = isModuleFullyComplete(m);
      const traveler = travelers[`${m.projectId}-${m.id}`];
      return online && !complete && (!traveler || traveler.status === 'active');
    });
    const pendingModules = filteredModules.filter(m => {
      const complete = isModuleFullyComplete(m);
      const traveler = travelers[`${m.projectId}-${m.id}`];
      return complete && (!traveler || traveler.status === 'active' || traveler.status === 'pending_approval');
    });
    const completeModules = filteredModules.filter(m => {
      const traveler = travelers[`${m.projectId}-${m.id}`];
      return traveler?.status === 'complete';
    });

    // Modules awaiting traveler = online modules without a traveler
    const modulesAwaitingTraveler = filteredModules.filter(m => {
      const online = isModuleOnline(m);
      const traveler = travelers[`${m.projectId}-${m.id}`];
      return online && !traveler;
    }).length;

    // Milestone progress
    const milestonesComplete = Object.values(travelers).reduce((acc, t) => {
      return acc + Object.values(t.milestones || {}).filter(m => m.completed).length;
    }, 0);
    return {
      openDeviations,
      criticalDeviations,
      closedDeviations,
      totalDeviations: deviations.length,
      totalTests,
      passedTests,
      failedTests,
      testPassRate: totalTests > 0 ? Math.round(passedTests / totalTests * 100) : 0,
      totalInspections,
      passedInspections,
      ncInspections,
      inspectionPassRate: totalInspections > 0 ? Math.round(passedInspections / totalInspections * 100) : 0,
      // Updated counts to match Travelers tab
      activeTravelers: activeModules.length,
      pendingApproval: pendingModules.length,
      completeTravelers: completeModules.length,
      modulesAwaitingTraveler,
      milestonesComplete
    };
  }, [deviations, testResults, travelers, filteredModules]);

  // Create or get traveler for a module
  // Traveler auto-activates when module goes online at Station 1 (Automation)
  const getOrCreateTraveler = React.useCallback(module => {
    const travelerId = `${module.projectId}-${module.id}`;
    if (travelers[travelerId]) {
      return travelers[travelerId];
    }

    // Create new traveler - captures all module data from Weekly Board
    // Module structure: serialNumber, hitchBLM, rearBLM, specs, stageProgress, etc.
    const newTraveler = {
      id: travelerId,
      moduleId: module.id,
      projectId: module.projectId,
      // Module identification
      serialNumber: module.serialNumber || module.name || '',
      projectName: module.projectName || '',
      buildSequence: module.buildSequence || null,
      // BLM/Unit info (from Weekly Board module data)
      hitchBLM: module.hitchBLM || module.specs?.blmHitch || '',
      rearBLM: module.rearBLM || module.specs?.blmRear || '',
      hitchUnit: module.hitchUnit || module.specs?.hitchUnit || '',
      rearUnit: module.rearUnit || module.specs?.rearUnit || '',
      hitchRoom: module.hitchRoom || '',
      rearRoom: module.rearRoom || '',
      hitchRoomType: module.hitchRoomType || '',
      rearRoomType: module.rearRoomType || '',
      // Dimensions
      width: module.width || module.specs?.width || '',
      length: module.length || module.specs?.length || '',
      squareFootage: module.squareFootage || module.specs?.squareFootage || '',
      // Difficulty indicators
      difficultyIndicators: module.difficultyIndicators || [],
      // Timeline - populated from Weekly Board
      onLineDate: module.onLineDate || null,
      currentStation: module.currentStation || module.stage || 'Automation',
      offLineDate: module.offLineDate || null,
      // Traveler status
      status: TRAVELER_STATUS.ACTIVE,
      createdAt: new Date().toISOString(),
      // Department checklists for inspections
      departmentChecklists: QA.DEPARTMENTS.map(dept => ({
        departmentId: dept.id,
        departmentName: dept.name,
        departmentNumber: dept.number,
        stations: dept.stations,
        items: (dept.checklistItems || []).map(item => ({
          itemId: item.id,
          description: item.description,
          conformance: null,
          inspector: null,
          timestamp: null,
          notes: '',
          photos: []
        })),
        status: 'pending',
        completedDate: null
      })),
      // Stop station approvals
      stopStationApprovals: {},
      // QA Hold status
      qaHold: false,
      qaHoldReason: null,
      // Completion
      completedBy: null,
      completedAt: null,
      lastUpdated: new Date().toISOString()
    };
    setTravelers(prev => ({
      ...prev,
      [travelerId]: newTraveler
    }));
    return newTraveler;
  }, [travelers, QA.DEPARTMENTS]);

  // Update traveler
  const updateTraveler = React.useCallback((travelerId, updates) => {
    setTravelers(prev => ({
      ...prev,
      [travelerId]: {
        ...prev[travelerId],
        ...updates,
        lastUpdated: new Date().toISOString()
      }
    }));
  }, []);

  // Add deviation
  const addDeviation = React.useCallback(deviation => {
    const newDeviation = {
      ...deviation,
      id: `DEV-${Date.now()}`,
      createdAt: new Date().toISOString(),
      status: 'open',
      history: [{
        action: 'created',
        by: currentUser.name || 'QA Inspector',
        timestamp: new Date().toISOString()
      }]
    };
    setDeviations(prev => [...prev, newDeviation]);
    return newDeviation;
  }, [currentUser]);

  // Update deviation status
  const updateDeviationStatus = React.useCallback((deviationId, status, notes = '') => {
    setDeviations(prev => prev.map(d => {
      if (d.id === deviationId) {
        return {
          ...d,
          status,
          history: [...(d.history || []), {
            action: `status changed to ${status}`,
            by: currentUser.name || 'User',
            timestamp: new Date().toISOString(),
            notes
          }]
        };
      }
      return d;
    }));
  }, [currentUser]);

  // Add test result
  const addTestResult = React.useCallback(test => {
    const newTest = {
      ...test,
      id: `TEST-${Date.now()}`,
      timestamp: new Date().toISOString(),
      inspector: currentUser.name || 'QA Inspector'
    };
    setTestResults(prev => [...prev, newTest]);
    return newTest;
  }, [currentUser]);

  // Sub-tab navigation
  const subTabs = [{
    id: 'dashboard',
    label: 'Dashboard',
    icon: 'icon-chart'
  }, {
    id: 'travelers',
    label: 'Travelers',
    icon: 'icon-clipboard'
  }, {
    id: 'deviations',
    label: 'Deviations',
    icon: 'icon-alert',
    badge: metrics.openDeviations
  }, {
    id: 'reports',
    label: 'Reports',
    icon: 'icon-blueprint'
  }];
  return /*#__PURE__*/React.createElement("div", {
    className: "qa-module"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex border-b overflow-x-auto production-tabs"
  }, subTabs.map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveSubTab(tab.id),
    className: `px-6 py-4 text-sm font-medium whitespace-nowrap transition flex items-center gap-2 ${activeSubTab === tab.id ? 'border-b-2 text-teal-600' : 'text-gray-500 hover:text-gray-700'}`,
    style: activeSubTab === tab.id ? {
      borderColor: 'var(--autovol-teal)'
    } : {}
  }, /*#__PURE__*/React.createElement("span", {
    className: tab.icon,
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), tab.label, tab.badge > 0 && /*#__PURE__*/React.createElement("span", {
    className: "bg-red-500 text-white text-xs px-2 py-0.5 rounded-full"
  }, tab.badge))))), /*#__PURE__*/React.createElement("div", {
    className: "mb-6 flex flex-wrap items-center gap-4 bg-white p-4 rounded-lg shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "text-sm font-medium text-gray-700"
  }, "Project:"), /*#__PURE__*/React.createElement("select", {
    value: selectedProject,
    onChange: e => setSelectedProject(e.target.value),
    className: "px-3 py-2 border rounded-lg text-sm min-w-[200px]"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Active Projects"), activeProjects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name)))), (activeSubTab === 'inspections' || activeSubTab === 'travelers') && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "text-sm font-medium text-gray-700"
  }, "Department:"), /*#__PURE__*/React.createElement("select", {
    value: selectedDepartment,
    onChange: e => setSelectedDepartment(e.target.value),
    className: "px-3 py-2 border rounded-lg text-sm min-w-[200px]"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Departments"), QA.DEPARTMENTS.map(d => /*#__PURE__*/React.createElement("option", {
    key: d.id,
    value: d.id
  }, d.number, ". ", d.name))))), activeSubTab === 'dashboard' && /*#__PURE__*/React.createElement(QADashboard, {
    metrics: metrics,
    deviations: deviations,
    travelers: travelers,
    modules: filteredModules,
    QA: QA
  }), activeSubTab === 'travelers' && /*#__PURE__*/React.createElement(TravelersPanel, {
    modules: filteredModules,
    travelers: travelers,
    getOrCreateTraveler: getOrCreateTraveler,
    updateTraveler: updateTraveler,
    onSelectTraveler: module => {
      setSelectedModule(module);
      setSelectedTraveler(getOrCreateTraveler(module));
      setShowTravelerModal(true);
    },
    onCompleteTraveler: travelerId => {
      updateTraveler(travelerId, {
        status: TRAVELER_STATUS.COMPLETE,
        completedBy: currentUser.name || 'QA Manager',
        completedAt: new Date().toISOString()
      });
    },
    stopStations: STOP_STATIONS,
    TRAVELER_STATUS: TRAVELER_STATUS,
    QA: QA,
    canEdit: canEdit,
    currentUser: currentUser
  }), activeSubTab === 'deviations' && /*#__PURE__*/React.createElement(DeviationsPanel, {
    deviations: deviations,
    updateDeviationStatus: updateDeviationStatus,
    modules: filteredModules,
    employees: employees,
    QA: QA,
    canEdit: canEdit,
    currentUser: currentUser,
    onNewDeviation: () => setShowDeviationModal(true)
  }), activeSubTab === 'reports' && /*#__PURE__*/React.createElement(QAReportsPanel, {
    metrics: metrics,
    deviations: deviations,
    testResults: testResults,
    travelers: travelers,
    modules: filteredModules,
    QA: QA
  }), showTravelerModal && selectedTraveler && /*#__PURE__*/React.createElement(TravelerDetailModal, {
    traveler: selectedTraveler,
    module: selectedModule,
    updateTraveler: updateTraveler,
    addDeviation: addDeviation,
    onClose: () => {
      setShowTravelerModal(false);
      setSelectedTraveler(null);
      setSelectedModule(null);
    },
    QA: QA,
    canEdit: canEdit,
    currentUser: currentUser
  }), showDeviationModal && /*#__PURE__*/React.createElement(NewDeviationModal, {
    modules: filteredModules,
    employees: employees,
    onClose: () => setShowDeviationModal(false),
    onSave: deviation => {
      addDeviation(deviation);
      setShowDeviationModal(false);
    },
    QA: QA
  }));
}

// Make component available globally
window.QAModule = QAModule;
})();


// ============================================================================
// FILE: qa/QADashboard.jsx
// ============================================================================
(function() {
// ============================================================================
// QA DASHBOARD - Overview metrics and status
// ============================================================================

function QADashboard({
  metrics,
  deviations,
  travelers,
  modules,
  QA
}) {
  // Recent deviations (last 10)
  const recentDeviations = [...deviations].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);

  // Modules needing attention (no traveler or has open deviations)
  const modulesNeedingAttention = modules.filter(m => {
    const hasOpenDeviations = deviations.some(d => d.moduleId === m.id && d.status !== 'closed');
    return !m.traveler || hasOpenDeviations;
  }).slice(0, 5);
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 border-l-4 border-red-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-red-600"
  }, metrics.openDeviations), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Open Deviations")), /*#__PURE__*/React.createElement("span", {
    className: "icon-alert",
    style: {
      width: '32px',
      height: '32px',
      display: 'inline-block',
      opacity: 0.3
    }
  })), metrics.criticalDeviations > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-red-600 font-medium"
  }, metrics.criticalDeviations, " Critical")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-green-600"
  }, metrics.inspectionPassRate, "%"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Inspection Pass Rate")), /*#__PURE__*/React.createElement("span", {
    className: "icon-checkmark",
    style: {
      width: '32px',
      height: '32px',
      display: 'inline-block',
      opacity: 0.3
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-500"
  }, metrics.passedInspections, " of ", metrics.totalInspections, " passed")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-blue-600"
  }, metrics.testPassRate, "%"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Test Pass Rate")), /*#__PURE__*/React.createElement("span", {
    className: "icon-construction",
    style: {
      width: '32px',
      height: '32px',
      display: 'inline-block',
      opacity: 0.3
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-500"
  }, metrics.passedTests, " of ", metrics.totalTests, " passed")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 border-l-4",
    style: {
      borderColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, metrics.activeTravelers), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Active Travelers")), /*#__PURE__*/React.createElement("span", {
    className: "icon-clipboard",
    style: {
      width: '32px',
      height: '32px',
      display: 'inline-block',
      opacity: 0.3
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-500"
  }, metrics.pendingApproval, " pending approval, ", metrics.completeTravelers, " complete"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Milestone Progress"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-5 gap-4"
  }, (QA.MILESTONES || []).map((milestone, index) => {
    // Count modules that have completed this milestone
    const completedCount = Object.values(travelers).filter(t => t.milestones?.[milestone.id]?.completed).length;
    const totalTravelers = Object.keys(travelers).length;
    const percentage = totalTravelers > 0 ? Math.round(completedCount / totalTravelers * 100) : 0;
    return /*#__PURE__*/React.createElement("div", {
      key: milestone.id,
      className: "text-center p-4 rounded-lg bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 mx-auto mb-2 rounded-full flex items-center justify-center text-white font-bold",
      style: {
        backgroundColor: percentage === 100 ? '#43A047' : percentage > 0 ? '#FB8C00' : '#9E9E9E'
      }
    }, index + 1), /*#__PURE__*/React.createElement("div", {
      className: "text-sm font-medium",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, milestone.name), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, completedCount, " / ", totalTravelers), /*#__PURE__*/React.createElement("div", {
      className: "mt-2 h-2 bg-gray-200 rounded-full overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-full rounded-full transition-all",
      style: {
        width: `${percentage}%`,
        backgroundColor: percentage === 100 ? '#43A047' : '#FB8C00'
      }
    })));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 lg:grid-cols-2 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Recent Deviations"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, deviations.length, " total")), recentDeviations.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-checkmark",
    style: {
      width: '48px',
      height: '48px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-2"
  }, "No deviations recorded")) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, recentDeviations.map(deviation => {
    const priority = (QA.DEVIATION_PRIORITIES || []).find(p => p.id === deviation.priority);
    const status = QA.DEVIATION_STATUS?.[deviation.status?.toUpperCase()] || {};
    return /*#__PURE__*/React.createElement("div", {
      key: deviation.id,
      className: "flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 border-l-4",
      style: {
        borderColor: priority?.color || '#9E9E9E'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-medium truncate"
    }, deviation.title || deviation.item), /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded-full text-white",
      style: {
        backgroundColor: status.color || '#9E9E9E'
      }
    }, status.name || deviation.status)), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, "Station ", deviation.station, " \u2022 ", deviation.department)), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-400"
    }, new Date(deviation.createdAt).toLocaleDateString()));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Modules Needing Attention")), modulesNeedingAttention.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-checkmark",
    style: {
      width: '48px',
      height: '48px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-2"
  }, "All modules up to date")) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, modulesNeedingAttention.map(module => {
    const moduleDeviations = deviations.filter(d => d.moduleId === module.id && d.status !== 'closed');
    return /*#__PURE__*/React.createElement("div", {
      key: module.id,
      className: "flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 border"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm",
      style: {
        backgroundColor: 'var(--autovol-navy)'
      }
    }, module.name?.substring(0, 2) || 'M'), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-sm font-medium truncate"
    }, module.name), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, module.projectName)), /*#__PURE__*/React.createElement("div", {
      className: "text-right"
    }, !module.traveler && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-1 rounded bg-gray-100 text-gray-600"
    }, "No Traveler"), moduleDeviations.length > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-1 rounded bg-red-100 text-red-600 ml-1"
    }, moduleDeviations.length, " NC")));
  })))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Department Inspection Progress"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
  }, (QA.DEPARTMENTS || []).map(dept => {
    // Calculate completion for this department across all travelers
    let totalItems = 0;
    let completedItems = 0;
    Object.values(travelers).forEach(traveler => {
      const deptChecklist = traveler.departmentChecklists?.find(d => d.departmentId === dept.id);
      if (deptChecklist) {
        (deptChecklist.items || []).forEach(item => {
          totalItems++;
          if (item.conformance) completedItems++;
        });
      }
    });
    const percentage = totalItems > 0 ? Math.round(completedItems / totalItems * 100) : 0;
    return /*#__PURE__*/React.createElement("div", {
      key: dept.id,
      className: "p-4 rounded-lg border hover:shadow-md transition"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-medium",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, dept.number, ". ", dept.name), /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-bold",
      style: {
        color: 'var(--autovol-teal)'
      }
    }, percentage, "%")), /*#__PURE__*/React.createElement("div", {
      className: "h-2 bg-gray-200 rounded-full overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-full rounded-full transition-all",
      style: {
        width: `${percentage}%`,
        backgroundColor: percentage === 100 ? '#43A047' : 'var(--autovol-teal)'
      }
    })), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, completedItems, " / ", totalItems, " items inspected"));
  }))));
}

// Make available globally
window.QADashboard = QADashboard;
})();


// ============================================================================
// FILE: qa/TravelersPanel.jsx
// ============================================================================
(function() {
// ============================================================================
// TRAVELERS PANEL - List and manage QA Travelers with sub-sections
// Sub-sections: Active Travelers, Pending Approval, Complete
// 
// Logic:
// - Active = Module is online (stageProgress > 0) AND close-up < 100
// - Pending Approval = Module completed all stations (close-up = 100) awaiting QA approval
// - Complete = QA Manager has approved the traveler
// ============================================================================

function TravelersPanel({
  modules,
  travelers,
  getOrCreateTraveler,
  updateTraveler,
  onSelectTraveler,
  onCompleteTraveler,
  stopStations = [],
  TRAVELER_STATUS,
  QA,
  canEdit,
  currentUser
}) {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [activeSection, setActiveSection] = React.useState('active'); // 'active', 'pending', 'complete'

  // Check if module is online (has started production)
  const isModuleOnline = module => {
    const stageProgress = module.stageProgress || {};
    return Object.values(stageProgress).some(progress => progress > 0);
  };

  // Check if module has completed all stations
  // A module is complete when ALL stages are at 100% (same logic as Weekly Board)
  const PRODUCTION_STAGE_IDS = ['auto-c', 'auto-f', 'auto-walls', 'mezzanine', 'elec-ceiling', 'wall-set', 'ceiling-set', 'soffits', 'mech-rough', 'elec-rough', 'plumb-rough', 'exteriors', 'drywall-bp', 'drywall-ttp', 'roofing', 'pre-finish', 'mech-trim', 'elec-trim', 'plumb-trim', 'final-finish', 'sign-off', 'close-up'];
  const isModuleComplete = module => {
    const stageProgress = module.stageProgress || {};
    // Check if ALL stages are at 100%
    return PRODUCTION_STAGE_IDS.every(stageId => stageProgress[stageId] === 100);
  };

  // Calculate traveler progress
  const getTravelerProgress = traveler => {
    if (!traveler) return 0;
    let totalItems = 0,
      completedItems = 0;
    (traveler.departmentChecklists || []).forEach(dept => {
      (dept.items || []).forEach(item => {
        totalItems++;
        if (item.conformance) completedItems++;
      });
    });
    return totalItems > 0 ? Math.round(completedItems / totalItems * 100) : 0;
  };

  // Check if at stop station
  const isAtStopStation = traveler => {
    return stopStations.includes(traveler?.currentStation);
  };

  // Filter modules by search and section
  // Active = Online modules that haven't completed all stations
  // Pending = Completed all stations, awaiting QA approval
  // Complete = QA approved
  const getFilteredModules = section => {
    return modules.filter(module => {
      const matchesSearch = !searchTerm || (module.name || '').toLowerCase().includes((searchTerm || '').toLowerCase()) || (module.projectName || '').toLowerCase().includes((searchTerm || '').toLowerCase()) || (module.serialNumber || '').toLowerCase().includes((searchTerm || '').toLowerCase());
      if (!matchesSearch) return false;
      const traveler = travelers[`${module.projectId}-${module.id}`];
      const online = isModuleOnline(module);
      const completedAllStations = isModuleComplete(module);
      if (section === 'active') {
        // Active = Module is online AND not completed all stations
        // Traveler status must be 'active' or no traveler yet
        return online && !completedAllStations && (!traveler || traveler.status === 'active');
      } else if (section === 'pending') {
        // Pending = Module completed all stations (close-up = 100)
        // Show if: no traveler yet, OR traveler status is pending_approval
        // (Modules that complete production automatically need QA approval)
        return completedAllStations && (!traveler || traveler.status === 'active' || traveler.status === 'pending_approval');
      } else if (section === 'complete') {
        // Complete = Traveler has been approved by QA Manager
        return traveler?.status === 'complete';
      }
      return false;
    });
  };
  const activeModules = getFilteredModules('active');
  const pendingModules = getFilteredModules('pending');
  const completeModules = getFilteredModules('complete');

  // Section tabs
  const sections = [{
    id: 'active',
    label: 'Active Travelers',
    count: activeModules.length
  }, {
    id: 'pending',
    label: 'Pending Approval',
    count: pendingModules.length
  }, {
    id: 'complete',
    label: 'Complete',
    count: completeModules.length
  }];
  const currentModules = activeSection === 'active' ? activeModules : activeSection === 'pending' ? pendingModules : completeModules;

  // Get production progress (average of all stages)
  const getProductionProgress = module => {
    const stageProgress = module.stageProgress || {};
    const values = Object.values(stageProgress);
    if (values.length === 0) return 0;
    return Math.round(values.reduce((a, b) => a + b, 0) / values.length);
  };

  // Production stages in order (matches App.jsx)
  const PRODUCTION_STAGES = [{
    id: 'auto-c',
    name: 'Auto-C'
  }, {
    id: 'auto-f',
    name: 'Auto-F'
  }, {
    id: 'auto-walls',
    name: 'Auto-Walls'
  }, {
    id: 'mezzanine',
    name: 'Mezzanine'
  }, {
    id: 'elec-ceiling',
    name: 'Elec-Ceiling'
  }, {
    id: 'wall-set',
    name: 'Wall Set'
  }, {
    id: 'ceiling-set',
    name: 'Ceiling Set'
  }, {
    id: 'soffits',
    name: 'Soffits'
  }, {
    id: 'mech-rough',
    name: 'Mech Rough'
  }, {
    id: 'elec-rough',
    name: 'Elec Rough'
  }, {
    id: 'plumb-rough',
    name: 'Plumb Rough'
  }, {
    id: 'exteriors',
    name: 'Exteriors'
  }, {
    id: 'drywall-bp',
    name: 'Drywall-BP'
  }, {
    id: 'drywall-ttp',
    name: 'Drywall-TTP'
  }, {
    id: 'roofing',
    name: 'Roofing'
  }, {
    id: 'pre-finish',
    name: 'Pre-Finish'
  }, {
    id: 'mech-trim',
    name: 'Mech Trim'
  }, {
    id: 'elec-trim',
    name: 'Elec Trim'
  }, {
    id: 'plumb-trim',
    name: 'Plumb Trim'
  }, {
    id: 'final-finish',
    name: 'Final Finish'
  }, {
    id: 'sign-off',
    name: 'Sign-Off'
  }, {
    id: 'close-up',
    name: 'Close-Up'
  }];

  // Get current station from stageProgress
  const getCurrentStation = module => {
    const stageProgress = module.stageProgress || {};
    // Find the last stage with progress > 0 but < 100 (in progress)
    for (let i = PRODUCTION_STAGES.length - 1; i >= 0; i--) {
      const stage = PRODUCTION_STAGES[i];
      if (stageProgress[stage.id] > 0 && stageProgress[stage.id] < 100) {
        return stage.name;
      }
    }
    // If close-up is 100, module is complete
    if (stageProgress['close-up'] === 100) return 'Complete';
    // Find the last completed stage
    for (let i = PRODUCTION_STAGES.length - 1; i >= 0; i--) {
      const stage = PRODUCTION_STAGES[i];
      if (stageProgress[stage.id] === 100) {
        // Return the next stage name
        if (i < PRODUCTION_STAGES.length - 1) {
          return PRODUCTION_STAGES[i + 1].name;
        }
        return 'Complete';
      }
    }
    return 'Not Started';
  };

  // Render module card
  const renderModuleCard = (module, section) => {
    const travelerId = `${module.projectId}-${module.id}`;
    const traveler = travelers[travelerId];
    const inspectionProgress = getTravelerProgress(traveler);
    const productionProgress = getProductionProgress(module);
    const currentStation = getCurrentStation(module);
    const atStopStation = isAtStopStation(traveler);
    return /*#__PURE__*/React.createElement("div", {
      key: module.id,
      className: "bg-white rounded-lg shadow-sm border hover:shadow-md transition cursor-pointer",
      onClick: () => onSelectTraveler(module)
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-4 border-b",
      style: {
        backgroundColor: traveler?.qaHold ? '#FEE2E2' : atStopStation ? '#FEF3C7' : traveler ? 'var(--autovol-teal-light)' : '#f9fafb'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h4", {
      className: "font-semibold text-lg font-mono",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, module.serialNumber || module.name || `Module ${module.id}`), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500"
    }, module.projectName), module.buildSequence && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400"
    }, "Build Sequence: #", module.buildSequence), (module.hitchBLM || module.specs?.blmHitch) && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400 font-mono"
    }, module.hitchBLM || module.specs?.blmHitch, (module.rearBLM || module.specs?.blmRear) && ` / ${module.rearBLM || module.specs?.blmRear}`)), /*#__PURE__*/React.createElement("div", {
      className: "flex flex-col items-end gap-1"
    }, traveler?.qaHold && /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-1 text-xs rounded bg-red-500 text-white font-medium"
    }, "QA HOLD"), atStopStation && !traveler?.qaHold && /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-1 text-xs rounded bg-yellow-500 text-white font-medium"
    }, "STOP STATION"), !traveler && section === 'active' && /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-1 text-xs rounded bg-gray-100 text-gray-600"
    }, "No Traveler")))), /*#__PURE__*/React.createElement("div", {
      className: "p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-2 text-xs mb-3"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 block"
    }, "Current Station"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium",
      style: {
        color: atStopStation ? '#D97706' : 'var(--autovol-navy)'
      }
    }, currentStation)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 block"
    }, "Production"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium",
      style: {
        color: productionProgress === 100 ? '#43A047' : 'var(--autovol-navy)'
      }
    }, productionProgress, "%"))), traveler ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between text-sm mb-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-600"
    }, "QA Inspection"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium",
      style: {
        color: inspectionProgress === 100 ? '#43A047' : 'var(--autovol-teal)'
      }
    }, inspectionProgress, "%")), /*#__PURE__*/React.createElement("div", {
      className: "h-2 bg-gray-200 rounded-full overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-full rounded-full transition-all",
      style: {
        width: `${inspectionProgress}%`,
        backgroundColor: inspectionProgress === 100 ? '#43A047' : 'var(--autovol-teal)'
      }
    })), section === 'pending' && canEdit && onCompleteTraveler && /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        if (confirm('Mark this traveler as complete? This action cannot be undone.')) {
          onCompleteTraveler(travelerId);
        }
      },
      className: "mt-3 w-full px-4 py-2 rounded-lg text-white text-sm font-medium",
      style: {
        backgroundColor: '#43A047'
      }
    }, "Approve & Complete Traveler"), section === 'complete' && traveler.completedAt && /*#__PURE__*/React.createElement("div", {
      className: "mt-3 text-xs text-gray-500 text-center"
    }, "Completed by ", traveler.completedBy, " on ", new Date(traveler.completedAt).toLocaleDateString())) : /*#__PURE__*/React.createElement("div", {
      className: "text-center py-2 text-gray-500 text-sm"
    }, /*#__PURE__*/React.createElement("p", null, "Click to create QA traveler"))));
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by module name, project, or serial number...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "w-full px-4 py-2 border rounded-lg text-sm"
  })), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex border-b"
  }, sections.map(section => /*#__PURE__*/React.createElement("button", {
    key: section.id,
    onClick: () => setActiveSection(section.id),
    className: `flex-1 px-4 py-3 text-sm font-medium transition ${activeSection === section.id ? 'border-b-2 bg-white' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`,
    style: activeSection === section.id ? {
      borderColor: 'var(--autovol-teal)',
      color: 'var(--autovol-teal)'
    } : {}
  }, section.label, /*#__PURE__*/React.createElement("span", {
    className: `ml-2 px-2 py-0.5 rounded-full text-xs ${activeSection === section.id ? 'bg-teal-100 text-teal-700' : 'bg-gray-100 text-gray-600'}`
  }, section.count))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
  }, currentModules.map(module => renderModuleCard(module, activeSection))), currentModules.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12 text-gray-500 bg-white rounded-lg shadow-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-clipboard",
    style: {
      width: '48px',
      height: '48px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-4 font-medium"
  }, activeSection === 'active' ? 'No modules currently in production' : activeSection === 'pending' ? 'No travelers pending approval' : 'No completed travelers'), /*#__PURE__*/React.createElement("p", {
    className: "mt-2 text-sm text-gray-400"
  }, activeSection === 'active' ? 'Modules will appear here when they go online (start production)' : activeSection === 'pending' ? 'Travelers move here when modules complete all stations (Close-Up = 100%)' : 'Approved travelers will appear here')));
}
window.TravelersPanel = TravelersPanel;
})();


// ============================================================================
// FILE: qa/InspectionsPanel.jsx
// ============================================================================
(function() {
// ============================================================================
// INSPECTIONS PANEL - Department checklist inspection interface
// ============================================================================

function InspectionsPanel({
  modules,
  travelers,
  updateTraveler,
  addDeviation,
  selectedDepartment,
  QA,
  canEdit,
  currentUser
}) {
  const [selectedModuleId, setSelectedModuleId] = React.useState(null);
  const [expandedDepts, setExpandedDepts] = React.useState({});

  // Get modules with travelers
  const modulesWithTravelers = modules.filter(m => travelers[`${m.projectId}-${m.id}`]);

  // Selected module's traveler
  const selectedModule = modulesWithTravelers.find(m => m.id === selectedModuleId);
  const selectedTraveler = selectedModule ? travelers[`${selectedModule.projectId}-${selectedModule.id}`] : null;

  // Filter departments
  const departments = selectedTraveler?.departmentChecklists?.filter(d => selectedDepartment === 'all' || d.departmentId === selectedDepartment) || [];

  // Toggle department expansion
  const toggleDept = deptId => {
    setExpandedDepts(prev => ({
      ...prev,
      [deptId]: !prev[deptId]
    }));
  };

  // Update checklist item
  const updateChecklistItem = (deptId, itemId, updates) => {
    if (!selectedTraveler || !canEdit) return;
    const travelerId = `${selectedModule.projectId}-${selectedModule.id}`;
    const updatedChecklists = selectedTraveler.departmentChecklists.map(dept => {
      if (dept.departmentId !== deptId) return dept;
      return {
        ...dept,
        items: dept.items.map(item => {
          if (item.itemId !== itemId) return item;
          return {
            ...item,
            ...updates,
            inspector: currentUser?.name || 'Inspector',
            timestamp: new Date().toISOString()
          };
        })
      };
    });
    updateTraveler(travelerId, {
      departmentChecklists: updatedChecklists
    });

    // If NC, prompt for deviation
    if (updates.conformance === 'NC') {
      const dept = QA.DEPARTMENTS.find(d => d.id === deptId);
      const item = dept?.checklistItems?.find(i => i.id === itemId);
      addDeviation({
        moduleId: selectedModule.id,
        moduleName: selectedModule.name,
        projectId: selectedModule.projectId,
        department: dept?.name || deptId,
        station: selectedTraveler.timeline?.currentStation || 'Unknown',
        item: item?.description || itemId,
        title: `NC: ${item?.description?.substring(0, 50) || itemId}`,
        priority: 'major',
        notedBy: currentUser?.name || 'QA Inspector'
      });
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Select Module to Inspect"), /*#__PURE__*/React.createElement("select", {
    value: selectedModuleId || '',
    onChange: e => setSelectedModuleId(e.target.value ? parseInt(e.target.value) : null),
    className: "w-full px-4 py-2 border rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "-- Select a module --"), modulesWithTravelers.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.name, " - ", m.projectName)))), !selectedTraveler ? /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-12 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-clipboard",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-4"
  }, "Select a module with an active traveler to begin inspection")) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, selectedModule.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Station: ", selectedTraveler.timeline?.currentStation || 'Not set')), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Traveler ID"), /*#__PURE__*/React.createElement("div", {
    className: "font-mono text-sm"
  }, selectedTraveler.id))), departments.map(dept => {
    const isExpanded = expandedDepts[dept.departmentId] !== false;
    const completedCount = dept.items.filter(i => i.conformance).length;
    const ncCount = dept.items.filter(i => i.conformance === 'NC').length;
    return /*#__PURE__*/React.createElement("div", {
      key: dept.departmentId,
      className: "bg-white rounded-lg shadow-sm overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-4 border-b cursor-pointer hover:bg-gray-50 flex items-center justify-between",
      onClick: () => toggleDept(dept.departmentId),
      style: {
        backgroundColor: completedCount === dept.items.length ? '#E8F5E9' : 'white'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: `transform transition ${isExpanded ? 'rotate-90' : ''}`
    }, "\u25B6"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h4", {
      className: "font-medium",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, dept.departmentNumber, ". ", dept.departmentName), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500"
    }, "Stations: ", dept.stations?.join(', ')))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, ncCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-1 text-xs rounded bg-red-100 text-red-600"
    }, ncCount, " NC"), /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-500"
    }, completedCount, "/", dept.items.length))), isExpanded && /*#__PURE__*/React.createElement("div", {
      className: "divide-y"
    }, dept.items.map((item, idx) => /*#__PURE__*/React.createElement("div", {
      key: item.itemId,
      className: "p-4 hover:bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-4"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-400 w-6"
    }, idx + 1, "."), /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, item.description), item.timestamp && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400 mt-1"
    }, item.inspector, " \u2022 ", new Date(item.timestamp).toLocaleString())), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, ['PASS', 'NC', 'N/A'].map(status => /*#__PURE__*/React.createElement("button", {
      key: status,
      onClick: () => updateChecklistItem(dept.departmentId, item.itemId, {
        conformance: status
      }),
      disabled: !canEdit,
      className: `px-3 py-1 text-xs font-medium rounded transition ${item.conformance === status ? status === 'PASS' ? 'bg-green-500 text-white' : status === 'NC' ? 'bg-red-500 text-white' : 'bg-gray-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
    }, status))))))));
  })));
}
window.InspectionsPanel = InspectionsPanel;
})();


// ============================================================================
// FILE: qa/DeviationsPanel.jsx
// ============================================================================
(function() {
// ============================================================================
// DEVIATIONS PANEL - Non-Conformance tracking and workflow
// ============================================================================

function DeviationsPanel({
  deviations,
  updateDeviationStatus,
  modules,
  employees,
  QA,
  canEdit,
  currentUser,
  onNewDeviation
}) {
  const [filter, setFilter] = React.useState('open');
  const [priorityFilter, setPriorityFilter] = React.useState('all');
  const [selectedDeviation, setSelectedDeviation] = React.useState(null);

  // Filter deviations
  const filteredDeviations = deviations.filter(d => {
    const matchesStatus = filter === 'all' || filter === 'open' && d.status !== 'closed' || d.status === filter;
    const matchesPriority = priorityFilter === 'all' || d.priority === priorityFilter;
    return matchesStatus && matchesPriority;
  }).sort((a, b) => {
    // Sort by priority then date
    const priorityOrder = {
      critical: 0,
      major: 1,
      minor: 2,
      cosmetic: 3
    };
    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    }
    return new Date(b.createdAt) - new Date(a.createdAt);
  });

  // Status workflow
  const getNextStatuses = currentStatus => {
    const workflow = {
      'open': ['assigned'],
      'assigned': ['in-progress', 'open'],
      'in-progress': ['ready-reinspect', 'assigned'],
      'ready-reinspect': ['closed', 'in-progress'],
      'closed': []
    };
    return workflow[currentStatus] || [];
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Deviation Tracking"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: onNewDeviation,
    className: "px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center gap-2",
    style: {
      backgroundColor: 'var(--autovol-red)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "+"), " New Deviation")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 flex flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, ['all', 'open', 'assigned', 'in-progress', 'ready-reinspect', 'closed'].map(status => /*#__PURE__*/React.createElement("button", {
    key: status,
    onClick: () => setFilter(status),
    className: `px-3 py-1 text-sm rounded-full transition ${filter === status ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`,
    style: filter === status ? {
      backgroundColor: 'var(--autovol-teal)'
    } : {}
  }, status === 'all' ? 'All' : status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())))), /*#__PURE__*/React.createElement("select", {
    value: priorityFilter,
    onChange: e => setPriorityFilter(e.target.value),
    className: "px-3 py-1 border rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Priorities"), (QA.DEVIATION_PRIORITIES || []).map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name)))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, filteredDeviations.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-12 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-checkmark",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-4"
  }, "No deviations found")) : filteredDeviations.map(deviation => {
    const priority = (QA.DEVIATION_PRIORITIES || []).find(p => p.id === deviation.priority);
    const status = QA.DEVIATION_STATUS?.[deviation.status?.toUpperCase()?.replace('-', '_')] || {
      name: deviation.status,
      color: '#9E9E9E'
    };
    const nextStatuses = getNextStatuses(deviation.status);
    return /*#__PURE__*/React.createElement("div", {
      key: deviation.id,
      className: "bg-white rounded-lg shadow-sm border-l-4 overflow-hidden",
      style: {
        borderColor: priority?.color || '#9E9E9E'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 mb-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-mono text-xs text-gray-400"
    }, deviation.id), /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-0.5 text-xs rounded text-white",
      style: {
        backgroundColor: priority?.color || '#9E9E9E'
      }
    }, priority?.name || deviation.priority), /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-0.5 text-xs rounded text-white",
      style: {
        backgroundColor: status.color
      }
    }, status.name)), /*#__PURE__*/React.createElement("h4", {
      className: "font-medium",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, deviation.title || deviation.item), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500 mt-1"
    }, deviation.moduleName, " \u2022 Station ", deviation.station, " \u2022 ", deviation.department)), /*#__PURE__*/React.createElement("div", {
      className: "text-right text-xs text-gray-400"
    }, /*#__PURE__*/React.createElement("div", null, "Noted by: ", deviation.notedBy), /*#__PURE__*/React.createElement("div", null, new Date(deviation.createdAt).toLocaleDateString()))), canEdit && nextStatuses.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "mt-4 pt-4 border-t flex gap-2"
    }, nextStatuses.map(nextStatus => /*#__PURE__*/React.createElement("button", {
      key: nextStatus,
      onClick: () => updateDeviationStatus(deviation.id, nextStatus),
      className: "px-3 py-1 text-xs rounded border hover:bg-gray-50"
    }, "\u2192 ", nextStatus.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())))), deviation.history?.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "mt-4 pt-4 border-t"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mb-2"
    }, "History"), /*#__PURE__*/React.createElement("div", {
      className: "space-y-1"
    }, deviation.history.slice(-3).map((h, i) => /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "text-xs text-gray-400"
    }, new Date(h.timestamp).toLocaleString(), " - ", h.action, " by ", h.by))))));
  })));
}

// New Deviation Modal
function NewDeviationModal({
  modules,
  employees,
  onClose,
  onSave,
  QA
}) {
  const [formData, setFormData] = React.useState({
    moduleId: '',
    station: '',
    department: '',
    title: '',
    item: '',
    priority: 'major',
    notedBy: ''
  });

  // Compare as strings to handle both UUID and numeric IDs
  const selectedModule = modules.find(m => String(m.id) === String(formData.moduleId));
  const handleSubmit = e => {
    e.preventDefault();
    if (!formData.moduleId || !formData.title) return;
    onSave({
      ...formData,
      moduleId: formData.moduleId,
      // Keep as-is (may be UUID or number)
      moduleName: selectedModule?.name || selectedModule?.serialNumber || '',
      projectId: selectedModule?.projectId
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between",
    style: {
      backgroundColor: 'var(--autovol-red)'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-white"
  }, "New Deviation"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-white hover:text-gray-200 text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Module *"), /*#__PURE__*/React.createElement("select", {
    value: formData.moduleId,
    onChange: e => setFormData({
      ...formData,
      moduleId: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    required: true
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select module..."), modules.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.name, " - ", m.projectName)))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Station"), /*#__PURE__*/React.createElement("select", {
    value: formData.station,
    onChange: e => setFormData({
      ...formData,
      station: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), (QA.PRODUCTION_STATIONS || []).map(s => /*#__PURE__*/React.createElement("option", {
    key: s,
    value: s
  }, s)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Department"), /*#__PURE__*/React.createElement("select", {
    value: formData.department,
    onChange: e => setFormData({
      ...formData,
      department: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), (QA.DEPARTMENTS || []).map(d => /*#__PURE__*/React.createElement("option", {
    key: d.id,
    value: d.name
  }, d.name))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Title *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.title,
    onChange: e => setFormData({
      ...formData,
      title: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    placeholder: "Brief description",
    required: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Details"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.item,
    onChange: e => setFormData({
      ...formData,
      item: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    rows: "3",
    placeholder: "Detailed description of non-conformance..."
  })), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Priority"), /*#__PURE__*/React.createElement("select", {
    value: formData.priority,
    onChange: e => setFormData({
      ...formData,
      priority: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, (QA.DEVIATION_PRIORITIES || []).map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Noted By"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.notedBy,
    onChange: e => setFormData({
      ...formData,
      notedBy: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    placeholder: "Inspector name"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-4"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "flex-1 px-4 py-2 rounded-lg text-white",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, "Create Deviation")))));
}
window.DeviationsPanel = DeviationsPanel;
window.NewDeviationModal = NewDeviationModal;
})();


// ============================================================================
// FILE: qa/TestingPanel.jsx
// ============================================================================
(function() {
// ============================================================================
// TESTING PANEL - Pressure tests, electrical tests, HVAC tests
// ============================================================================

function TestingPanel({
  testResults,
  addTestResult,
  modules,
  travelers,
  QA,
  canEdit,
  currentUser
}) {
  const [showNewTest, setShowNewTest] = React.useState(false);
  const [filter, setFilter] = React.useState('all');
  const [testTypeFilter, setTestTypeFilter] = React.useState('all');

  // Filter test results
  const filteredTests = testResults.filter(t => {
    const matchesResult = filter === 'all' || t.result === filter;
    const matchesType = testTypeFilter === 'all' || t.testType === testTypeFilter;
    return matchesResult && matchesType;
  }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  // Get test type info
  const getTestType = typeId => QA.TEST_TYPES?.[typeId] || {
    name: typeId,
    description: ''
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Testing & Verification"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowNewTest(true),
    className: "px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center gap-2",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "+"), " Record Test")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"
  }, Object.entries(QA.TEST_TYPES || {}).map(([key, test]) => {
    const count = testResults.filter(t => t.testType === key).length;
    const passCount = testResults.filter(t => t.testType === key && t.result === 'PASS').length;
    return /*#__PURE__*/React.createElement("div", {
      key: key,
      className: "bg-white rounded-lg shadow-sm p-4 text-center cursor-pointer hover:shadow-md transition",
      onClick: () => setTestTypeFilter(testTypeFilter === key ? 'all' : key),
      style: {
        borderBottom: testTypeFilter === key ? '3px solid var(--autovol-teal)' : '3px solid transparent'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, count), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 truncate"
    }, test.name), count > 0 && /*#__PURE__*/React.createElement("div", {
      className: "text-xs mt-1",
      style: {
        color: passCount === count ? '#43A047' : '#FB8C00'
      }
    }, passCount, "/", count, " passed"));
  })), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 flex gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, ['all', 'PASS', 'FAIL'].map(status => /*#__PURE__*/React.createElement("button", {
    key: status,
    onClick: () => setFilter(status),
    className: `px-3 py-1 text-sm rounded-full transition ${filter === status ? status === 'PASS' ? 'bg-green-500 text-white' : status === 'FAIL' ? 'bg-red-500 text-white' : 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`,
    style: filter === status && status === 'all' ? {
      backgroundColor: 'var(--autovol-teal)'
    } : {}
  }, status === 'all' ? 'All Results' : status)))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, filteredTests.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-12 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-construction",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block',
      opacity: 0.3
    }
  }), /*#__PURE__*/React.createElement("p", {
    className: "mt-4"
  }, "No test results recorded")) : filteredTests.map(test => {
    const testType = getTestType(test.testType);
    const module = modules.find(m => m.id === test.moduleId);
    return /*#__PURE__*/React.createElement("div", {
      key: test.id,
      className: "bg-white rounded-lg shadow-sm p-4 border-l-4",
      style: {
        borderColor: test.result === 'PASS' ? '#43A047' : '#E53935'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 mb-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-0.5 text-xs rounded text-white ${test.result === 'PASS' ? 'bg-green-500' : 'bg-red-500'}`
    }, test.result), /*#__PURE__*/React.createElement("span", {
      className: "font-medium",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, testType.name)), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, module?.name || 'Unknown Module', " \u2022 Station ", test.station), test.parameters && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400 mt-1"
    }, test.parameters.pressure && `${test.parameters.pressure} ${test.parameters.unit}`, test.parameters.duration && ` for ${test.parameters.duration} min`), test.notes && /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600 mt-2"
    }, test.notes)), /*#__PURE__*/React.createElement("div", {
      className: "text-right text-xs text-gray-400"
    }, /*#__PURE__*/React.createElement("div", null, test.inspector), /*#__PURE__*/React.createElement("div", null, new Date(test.timestamp).toLocaleString()))));
  })), showNewTest && /*#__PURE__*/React.createElement(NewTestModal, {
    modules: modules,
    travelers: travelers,
    QA: QA,
    currentUser: currentUser,
    onClose: () => setShowNewTest(false),
    onSave: test => {
      addTestResult(test);
      setShowNewTest(false);
    }
  }));
}

// New Test Modal
function NewTestModal({
  modules,
  travelers,
  QA,
  currentUser,
  onClose,
  onSave
}) {
  const [formData, setFormData] = React.useState({
    moduleId: '',
    testType: '',
    station: '',
    result: 'PASS',
    parameters: {},
    notes: ''
  });
  const [timerRunning, setTimerRunning] = React.useState(false);
  const [timerSeconds, setTimerSeconds] = React.useState(0);
  const selectedTestType = QA.TEST_TYPES?.[formData.testType];
  const modulesWithTravelers = modules.filter(m => travelers[`${m.projectId}-${m.id}`]);

  // Timer effect
  React.useEffect(() => {
    let interval;
    if (timerRunning) {
      interval = setInterval(() => setTimerSeconds(s => s + 1), 1000);
    }
    return () => clearInterval(interval);
  }, [timerRunning]);
  const formatTime = seconds => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };
  const handleSubmit = e => {
    e.preventDefault();
    if (!formData.moduleId || !formData.testType) return;
    const module = modules.find(m => m.id === parseInt(formData.moduleId));
    onSave({
      ...formData,
      moduleId: parseInt(formData.moduleId),
      moduleName: module?.name,
      projectId: module?.projectId,
      duration: timerSeconds > 0 ? Math.floor(timerSeconds / 60) : formData.parameters?.duration
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-white"
  }, "Record Test Result"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-white hover:text-gray-200 text-2xl"
  }, "\xD7"))), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Module *"), /*#__PURE__*/React.createElement("select", {
    value: formData.moduleId,
    onChange: e => setFormData({
      ...formData,
      moduleId: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    required: true
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select module..."), modulesWithTravelers.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.name, " - ", m.projectName)))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Test Type *"), /*#__PURE__*/React.createElement("select", {
    value: formData.testType,
    onChange: e => {
      const testType = QA.TEST_TYPES?.[e.target.value];
      setFormData({
        ...formData,
        testType: e.target.value,
        parameters: testType?.defaultParams || {}
      });
    },
    className: "w-full px-3 py-2 border rounded-lg",
    required: true
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), Object.entries(QA.TEST_TYPES || {}).map(([key, test]) => /*#__PURE__*/React.createElement("option", {
    key: key,
    value: key
  }, test.name)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Station"), /*#__PURE__*/React.createElement("select", {
    value: formData.station,
    onChange: e => setFormData({
      ...formData,
      station: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), (QA.PRODUCTION_STATIONS || []).map(s => /*#__PURE__*/React.createElement("option", {
    key: s,
    value: s
  }, s))))), selectedTestType?.defaultParams && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium text-gray-700 mb-3"
  }, "Test Parameters"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4"
  }, selectedTestType.defaultParams.pressure && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-xs text-gray-500 mb-1"
  }, "Pressure (", selectedTestType.defaultParams.unit, ")"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: formData.parameters?.pressure || selectedTestType.defaultParams.pressure,
    onChange: e => setFormData({
      ...formData,
      parameters: {
        ...formData.parameters,
        pressure: e.target.value
      }
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  })), selectedTestType.defaultParams.duration && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-xs text-gray-500 mb-1"
  }, "Duration (min)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: formData.parameters?.duration || selectedTestType.defaultParams.duration,
    onChange: e => setFormData({
      ...formData,
      parameters: {
        ...formData.parameters,
        duration: e.target.value
      }
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "mt-4 text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-mono font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, formatTime(timerSeconds)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setTimerRunning(!timerRunning),
    className: `px-4 py-2 rounded-lg text-white ${timerRunning ? 'bg-red-500' : 'bg-green-500'}`
  }, timerRunning ? 'Stop' : 'Start Timer'), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      setTimerRunning(false);
      setTimerSeconds(0);
    },
    className: "px-4 py-2 rounded-lg border hover:bg-gray-50"
  }, "Reset")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Result *"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-4"
  }, ['PASS', 'FAIL'].map(result => /*#__PURE__*/React.createElement("button", {
    key: result,
    type: "button",
    onClick: () => setFormData({
      ...formData,
      result
    }),
    className: `flex-1 py-3 rounded-lg font-medium transition ${formData.result === result ? result === 'PASS' ? 'bg-green-500 text-white' : 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, result)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData({
      ...formData,
      notes: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg",
    rows: "2",
    placeholder: "Test observations..."
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-4"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "flex-1 px-4 py-2 rounded-lg text-white",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, "Save Test Result")))));
}
window.TestingPanel = TestingPanel;
window.NewTestModal = NewTestModal;
})();


// ============================================================================
// FILE: qa/QAReportsPanel.jsx
// ============================================================================
(function() {
// ============================================================================
// QA REPORTS PANEL - Analytics and reporting
// ============================================================================

function QAReportsPanel({
  metrics,
  deviations,
  testResults,
  travelers,
  modules,
  QA
}) {
  const [reportType, setReportType] = React.useState('summary');

  // Calculate department-level stats
  const departmentStats = React.useMemo(() => {
    const stats = {};
    (QA.DEPARTMENTS || []).forEach(dept => {
      stats[dept.id] = {
        name: dept.name,
        number: dept.number,
        total: 0,
        passed: 0,
        nc: 0,
        pending: 0
      };
    });
    Object.values(travelers).forEach(traveler => {
      (traveler.departmentChecklists || []).forEach(dept => {
        if (stats[dept.departmentId]) {
          (dept.items || []).forEach(item => {
            stats[dept.departmentId].total++;
            if (item.conformance === 'PASS') stats[dept.departmentId].passed++;else if (item.conformance === 'NC') stats[dept.departmentId].nc++;else stats[dept.departmentId].pending++;
          });
        }
      });
    });
    return Object.values(stats).sort((a, b) => a.number - b.number);
  }, [travelers, QA.DEPARTMENTS]);

  // Deviation stats by category
  const deviationsByPriority = React.useMemo(() => {
    const stats = {};
    (QA.DEVIATION_PRIORITIES || []).forEach(p => {
      stats[p.id] = {
        ...p,
        count: 0,
        open: 0,
        closed: 0
      };
    });
    deviations.forEach(d => {
      if (stats[d.priority]) {
        stats[d.priority].count++;
        if (d.status === 'closed') stats[d.priority].closed++;else stats[d.priority].open++;
      }
    });
    return Object.values(stats);
  }, [deviations, QA.DEVIATION_PRIORITIES]);

  // Test stats by type
  const testsByType = React.useMemo(() => {
    const stats = {};
    Object.entries(QA.TEST_TYPES || {}).forEach(([key, test]) => {
      stats[key] = {
        ...test,
        key,
        total: 0,
        passed: 0,
        failed: 0
      };
    });
    testResults.forEach(t => {
      if (stats[t.testType]) {
        stats[t.testType].total++;
        if (t.result === 'PASS') stats[t.testType].passed++;else stats[t.testType].failed++;
      }
    });
    return Object.values(stats);
  }, [testResults, QA.TEST_TYPES]);
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, [{
    id: 'summary',
    label: 'Executive Summary'
  }, {
    id: 'departments',
    label: 'By Department'
  }, {
    id: 'deviations',
    label: 'Deviation Analysis'
  }, {
    id: 'testing',
    label: 'Test Results'
  }].map(type => /*#__PURE__*/React.createElement("button", {
    key: type.id,
    onClick: () => setReportType(type.id),
    className: `px-4 py-2 text-sm rounded-lg transition ${reportType === type.id ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`,
    style: reportType === type.id ? {
      backgroundColor: 'var(--autovol-navy)'
    } : {}
  }, type.label)))), reportType === 'summary' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Key Performance Indicators"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 rounded-lg bg-green-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-4xl font-bold text-green-600"
  }, metrics.inspectionPassRate, "%"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, "Inspection Pass Rate")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 rounded-lg bg-blue-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-4xl font-bold text-blue-600"
  }, metrics.testPassRate, "%"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, "Test Pass Rate")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 rounded-lg bg-red-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-4xl font-bold text-red-600"
  }, metrics.openDeviations), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, "Open Deviations")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 rounded-lg",
    style: {
      backgroundColor: 'var(--autovol-teal-light)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-4xl font-bold",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, metrics.modulesWithTravelers), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, "Active Travelers")))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Inspection Summary"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Total Inspections"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold"
  }, metrics.totalInspections)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Passed"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-green-600"
  }, metrics.passedInspections)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Non-Conformance"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-red-600"
  }, metrics.ncInspections)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Deviation Summary"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Total Deviations"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold"
  }, metrics.totalDeviations)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Open"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-red-600"
  }, metrics.openDeviations)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Closed"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-green-600"
  }, metrics.closedDeviations)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Critical Open"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-red-700"
  }, metrics.criticalDeviations)))))), reportType === 'departments' && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b",
    style: {
      backgroundColor: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-white"
  }, "Department Inspection Status")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-sm font-medium text-gray-700"
  }, "Department"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Total Items"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Passed"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "NC"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Pending"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Pass Rate"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, departmentStats.map(dept => {
    const inspected = dept.passed + dept.nc;
    const passRate = inspected > 0 ? Math.round(dept.passed / inspected * 100) : 0;
    return /*#__PURE__*/React.createElement("tr", {
      key: dept.number,
      className: "hover:bg-gray-50"
    }, /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm"
    }, dept.number, ". ", dept.name), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-center"
    }, dept.total), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-center text-green-600 font-medium"
    }, dept.passed), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-center text-red-600 font-medium"
    }, dept.nc), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-center text-gray-500"
    }, dept.pending), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-1 rounded ${passRate >= 90 ? 'bg-green-100 text-green-700' : passRate >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`
    }, passRate, "%")));
  }))))), reportType === 'deviations' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Deviations by Priority"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, deviationsByPriority.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "p-4 rounded-lg border-l-4",
    style: {
      borderColor: p.color,
      backgroundColor: `${p.color}10`
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold",
    style: {
      color: p.color
    }
  }, p.count), /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium"
  }, p.name), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mt-1"
  }, p.open, " open \u2022 ", p.closed, " closed"))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Recent Deviations")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-sm font-medium text-gray-700"
  }, "ID"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-sm font-medium text-gray-700"
  }, "Module"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-sm font-medium text-gray-700"
  }, "Description"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Priority"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center text-sm font-medium text-gray-700"
  }, "Status"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-sm font-medium text-gray-700"
  }, "Date"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, deviations.slice(0, 20).map(d => {
    const priority = (QA.DEVIATION_PRIORITIES || []).find(p => p.id === d.priority);
    return /*#__PURE__*/React.createElement("tr", {
      key: d.id,
      className: "hover:bg-gray-50"
    }, /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-xs font-mono"
    }, d.id), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm"
    }, d.moduleName), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm truncate max-w-xs"
    }, d.title || d.item), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-1 text-xs rounded text-white",
      style: {
        backgroundColor: priority?.color || '#9E9E9E'
      }
    }, priority?.name || d.priority)), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-center text-sm"
    }, d.status), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-gray-500"
    }, new Date(d.createdAt).toLocaleDateString()));
  })))))), reportType === 'testing' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Test Results by Type"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-3 gap-4"
  }, testsByType.map(t => {
    const passRate = t.total > 0 ? Math.round(t.passed / t.total * 100) : 0;
    return /*#__PURE__*/React.createElement("div", {
      key: t.key,
      className: "p-4 rounded-lg border"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-medium mb-2",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, t.name), /*#__PURE__*/React.createElement("div", {
      className: "flex items-end gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-3xl font-bold",
      style: {
        color: passRate >= 90 ? '#43A047' : passRate >= 70 ? '#FB8C00' : '#E53935'
      }
    }, passRate, "%"), /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-500 mb-1"
    }, "pass rate")), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-2"
    }, t.total, " tests \u2022 ", t.passed, " passed \u2022 ", t.failed, " failed"));
  })))));
}
window.QAReportsPanel = QAReportsPanel;
})();


// ============================================================================
// FILE: qa/TravelerDetailModal.jsx
// ============================================================================
(function() {
// ============================================================================
// TRAVELER DETAIL MODAL - Full module information from Weekly Board
// Shows: Serial Number, BLM IDs, Units, Rooms, Dimensions, Difficulty Indicators
// Stop Station Approvals with Pass/Fail, Notes, and Photo Gallery
// ============================================================================

// Stop Stations constant (shared with QAModule)
const STOP_STATIONS_MODAL = ['Mezzanine', 'Prior to Drywall-Back Panel', 'Prior to Module Sign-Off'];
function TravelerDetailModal({
  traveler,
  module,
  updateTraveler,
  addDeviation,
  onClose,
  QA,
  canEdit,
  currentUser
}) {
  const [localTraveler, setLocalTraveler] = React.useState(traveler);
  const [expandedStation, setExpandedStation] = React.useState(null);
  const [newComment, setNewComment] = React.useState('');
  const [commentPhotos, setCommentPhotos] = React.useState([]); // Photos to attach to current comment
  const [selectedPhotos, setSelectedPhotos] = React.useState([]);
  const [showPhotoViewer, setShowPhotoViewer] = React.useState(null);

  // Save changes
  const saveChanges = () => {
    updateTraveler(traveler.id, localTraveler);
  };

  // Update local state
  const updateLocal = updates => {
    setLocalTraveler(prev => ({
      ...prev,
      ...updates
    }));
  };

  // Handle Stop Station Pass/Fail
  const handleStopStationResult = (station, result) => {
    const approvals = {
      ...localTraveler.stopStationApprovals
    };
    approvals[station] = {
      ...approvals[station],
      result: result,
      // 'PASS' or 'FAIL'
      inspectedBy: currentUser?.name || 'QA Inspector',
      inspectedAt: new Date().toISOString(),
      comments: approvals[station]?.comments || [],
      photos: approvals[station]?.photos || []
    };
    updateLocal({
      stopStationApprovals: approvals
    });
  };

  // Add comment to stop station (with optional attached photos)
  const addStationComment = station => {
    if (!newComment.trim() && commentPhotos.length === 0) return;
    const approvals = {
      ...localTraveler.stopStationApprovals
    };
    const stationData = approvals[station] || {
      comments: [],
      photos: []
    };
    stationData.comments = [...(stationData.comments || []), {
      id: Date.now(),
      text: newComment.trim(),
      author: currentUser?.name || 'QA Inspector',
      timestamp: new Date().toISOString(),
      photos: commentPhotos // Attach photos to this comment
    }];
    approvals[station] = stationData;
    updateLocal({
      stopStationApprovals: approvals
    });
    setNewComment('');
    setCommentPhotos([]); // Clear pending photos
  };

  // Handle photo upload for comment attachment
  const handleCommentPhotoUpload = event => {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        setCommentPhotos(prev => [...prev, {
          id: Date.now() + Math.random(),
          data: e.target.result,
          name: file.name
        }]);
      };
      reader.readAsDataURL(file);
    });
    // Reset input so same file can be selected again
    event.target.value = '';
  };

  // Remove pending photo from comment
  const removeCommentPhoto = photoId => {
    setCommentPhotos(prev => prev.filter(p => p.id !== photoId));
  };

  // Handle photo upload
  const handlePhotoUpload = (station, event) => {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    // Convert files to base64 for storage
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const approvals = {
          ...localTraveler.stopStationApprovals
        };
        const stationData = approvals[station] || {
          comments: [],
          photos: []
        };
        stationData.photos = [...(stationData.photos || []), {
          id: Date.now() + Math.random(),
          data: e.target.result,
          name: file.name,
          uploadedBy: currentUser?.name || 'QA Inspector',
          uploadedAt: new Date().toISOString()
        }];
        approvals[station] = stationData;
        updateLocal({
          stopStationApprovals: approvals
        });
      };
      reader.readAsDataURL(file);
    });
  };

  // Delete photo
  const deletePhoto = (station, photoId) => {
    const approvals = {
      ...localTraveler.stopStationApprovals
    };
    const stationData = approvals[station];
    if (stationData?.photos) {
      stationData.photos = stationData.photos.filter(p => p.id !== photoId);
      approvals[station] = stationData;
      updateLocal({
        stopStationApprovals: approvals
      });
    }
  };

  // Production stages in order (matches App.jsx)
  const PRODUCTION_STAGES = [{
    id: 'auto-c',
    name: 'Auto-C'
  }, {
    id: 'auto-f',
    name: 'Auto-F'
  }, {
    id: 'auto-walls',
    name: 'Auto-Walls'
  }, {
    id: 'mezzanine',
    name: 'Mezzanine'
  }, {
    id: 'elec-ceiling',
    name: 'Elec-Ceiling'
  }, {
    id: 'wall-set',
    name: 'Wall Set'
  }, {
    id: 'ceiling-set',
    name: 'Ceiling Set'
  }, {
    id: 'soffits',
    name: 'Soffits'
  }, {
    id: 'mech-rough',
    name: 'Mech Rough'
  }, {
    id: 'elec-rough',
    name: 'Elec Rough'
  }, {
    id: 'plumb-rough',
    name: 'Plumb Rough'
  }, {
    id: 'exteriors',
    name: 'Exteriors'
  }, {
    id: 'drywall-bp',
    name: 'Drywall-BP'
  }, {
    id: 'drywall-ttp',
    name: 'Drywall-TTP'
  }, {
    id: 'roofing',
    name: 'Roofing'
  }, {
    id: 'pre-finish',
    name: 'Pre-Finish'
  }, {
    id: 'mech-trim',
    name: 'Mech Trim'
  }, {
    id: 'elec-trim',
    name: 'Elec Trim'
  }, {
    id: 'plumb-trim',
    name: 'Plumb Trim'
  }, {
    id: 'final-finish',
    name: 'Final Finish'
  }, {
    id: 'sign-off',
    name: 'Sign-Off'
  }, {
    id: 'close-up',
    name: 'Close-Up'
  }];

  // Get current station from module stageProgress
  const getCurrentStation = () => {
    const stageProgress = module?.stageProgress || {};
    // Find the last stage with progress > 0 but < 100 (in progress)
    for (let i = PRODUCTION_STAGES.length - 1; i >= 0; i--) {
      const stage = PRODUCTION_STAGES[i];
      if (stageProgress[stage.id] > 0 && stageProgress[stage.id] < 100) {
        return stage.name;
      }
    }
    // If close-up is 100, module is complete
    if (stageProgress['close-up'] === 100) return 'Complete';
    // Find the last completed stage
    for (let i = PRODUCTION_STAGES.length - 1; i >= 0; i--) {
      const stage = PRODUCTION_STAGES[i];
      if (stageProgress[stage.id] === 100) {
        if (i < PRODUCTION_STAGES.length - 1) {
          return PRODUCTION_STAGES[i + 1].name;
        }
        return 'Complete';
      }
    }
    return 'Auto-C';
  };
  const currentStation = getCurrentStation();
  const isAtStopStation = STOP_STATIONS_MODAL.includes(currentStation);

  // Get inspection progress
  const getProgress = () => {
    let total = 0,
      completed = 0;
    (localTraveler.departmentChecklists || []).forEach(dept => {
      (dept.items || []).forEach(item => {
        total++;
        if (item.conformance) completed++;
      });
    });
    return {
      total,
      completed,
      percent: total > 0 ? Math.round(completed / total * 100) : 0
    };
  };
  const progress = getProgress();

  // Get module data (prefer from module prop, fallback to traveler)
  const serialNumber = module?.serialNumber || localTraveler.serialNumber || '-';
  const projectName = module?.projectName || localTraveler.projectName || '-';
  const buildSequence = module?.buildSequence || localTraveler.buildSequence;
  const hitchBLM = module?.hitchBLM || module?.specs?.blmHitch || localTraveler.hitchBLM || '-';
  const rearBLM = module?.rearBLM || module?.specs?.blmRear || localTraveler.rearBLM || '-';
  const hitchUnit = module?.hitchUnit || module?.specs?.hitchUnit || localTraveler.hitchUnit || '-';
  const rearUnit = module?.rearUnit || module?.specs?.rearUnit || localTraveler.rearUnit || '-';
  const hitchRoom = module?.hitchRoom || localTraveler.hitchRoom || '-';
  const rearRoom = module?.rearRoom || localTraveler.rearRoom || '-';
  const hitchRoomType = module?.hitchRoomType || localTraveler.hitchRoomType || '-';
  const rearRoomType = module?.rearRoomType || localTraveler.rearRoomType || '-';
  const width = module?.width || module?.specs?.width || localTraveler.width || '-';
  const length = module?.length || module?.specs?.length || localTraveler.length || '-';
  const squareFootage = module?.squareFootage || module?.specs?.squareFootage || localTraveler.squareFootage || '-';
  const difficultyIndicators = module?.difficultyIndicators || localTraveler.difficultyIndicators || [];
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",
    style: {
      zIndex: 9999
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between",
    style: {
      backgroundColor: localTraveler.qaHold ? '#DC2626' : 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-xl font-bold text-white"
  }, serialNumber), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-300"
  }, projectName, buildSequence && /*#__PURE__*/React.createElement("span", {
    className: "ml-2"
  }, "Build Sequence: ", buildSequence))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-white hover:text-gray-200 text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto p-6 space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Module Information"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Width"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-lg"
  }, width)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Length"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-lg"
  }, length)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Square Footage"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-lg"
  }, squareFootage)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "HITCH Side"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "BLM ID"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium font-mono"
  }, hitchBLM)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Unit"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, hitchUnit)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Room"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, hitchRoom)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Room Type"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, hitchRoomType)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "REAR Side"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "BLM ID"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium font-mono"
  }, rearBLM)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Unit"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, rearUnit)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Room"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, rearRoom)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Room Type"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, rearRoomType)))), difficultyIndicators.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Difficulty Indicators"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, difficultyIndicators.map((indicator, idx) => /*#__PURE__*/React.createElement("span", {
    key: idx,
    className: "px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm"
  }, indicator)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Timeline", /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-normal text-gray-400 ml-2"
  }, "(from Weekly Board)")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "On-Line Date"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, localTraveler.onLineDate ? new Date(localTraveler.onLineDate).toLocaleDateString() : '-')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Current Station"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium",
    style: {
      color: isAtStopStation ? '#D97706' : 'var(--autovol-navy)'
    }
  }, currentStation, isAtStopStation && /*#__PURE__*/React.createElement("span", {
    className: "ml-2 text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded"
  }, "STOP"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 block"
  }, "Off-Line Date"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, localTraveler.offLineDate ? new Date(localTraveler.offLineDate).toLocaleDateString() : '-')))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Inspection Progress"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-3 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-full rounded-full transition-all",
    style: {
      width: `${progress.percent}%`,
      backgroundColor: progress.percent === 100 ? '#43A047' : 'var(--autovol-teal)'
    }
  }))), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-sm",
    style: {
      color: progress.percent === 100 ? '#43A047' : 'var(--autovol-teal)'
    }
  }, progress.completed, "/", progress.total, " (", progress.percent, "%)"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Stop Station Approvals", /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-normal text-gray-400 ml-2"
  }, "QC/QA Inspection Points")), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, STOP_STATIONS_MODAL.map((station, idx) => {
    const approval = localTraveler.stopStationApprovals?.[station] || {};
    const isCurrent = currentStation === station || currentStation === 'Mezzanine' && station === 'Mezzanine';
    const isExpanded = expandedStation === station;
    const hasResult = approval.result;
    const isPassed = approval.result === 'PASS';
    const isFailed = approval.result === 'FAIL';
    const commentCount = (approval.comments || []).length;
    const photoCount = (approval.photos || []).length;
    return /*#__PURE__*/React.createElement("div", {
      key: station,
      className: `rounded-lg border overflow-hidden ${isFailed ? 'border-red-300 bg-red-50' : isPassed ? 'border-green-300 bg-green-50' : isCurrent ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-white'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between p-3 cursor-pointer hover:bg-opacity-80",
      onClick: () => setExpandedStation(isExpanded ? null : station)
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: `w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm ${isFailed ? 'bg-red-500' : isPassed ? 'bg-green-500' : isCurrent ? 'bg-yellow-500' : 'bg-gray-300'}`
    }, idx + 1), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-sm"
    }, station), hasResult && /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, approval.result, " by ", approval.inspectedBy, " - ", new Date(approval.inspectedAt).toLocaleDateString()))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, commentCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700"
    }, commentCount, " note", commentCount !== 1 ? 's' : ''), photoCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700"
    }, photoCount, " photo", photoCount !== 1 ? 's' : ''), isPassed && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded bg-green-600 text-white font-medium"
    }, "PASS"), isFailed && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded bg-red-600 text-white font-medium"
    }, "FAIL"), !hasResult && /*#__PURE__*/React.createElement("span", {
      className: "text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-600"
    }, "Pending"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 text-lg"
    }, isExpanded ? '-' : '+'))), isExpanded && /*#__PURE__*/React.createElement("div", {
      className: "border-t p-4 space-y-4 bg-white"
    }, canEdit && /*#__PURE__*/React.createElement("div", {
      className: "flex gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleStopStationResult(station, 'PASS'),
      className: `flex-1 py-3 rounded-lg font-medium text-sm transition ${isPassed ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`
    }, "PASS Inspection"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleStopStationResult(station, 'FAIL'),
      className: `flex-1 py-3 rounded-lg font-medium text-sm transition ${isFailed ? 'bg-red-600 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}`
    }, "FAIL Inspection")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h5", {
      className: "text-sm font-medium text-gray-700 mb-2"
    }, "Inspection Notes", /*#__PURE__*/React.createElement("span", {
      className: "text-xs font-normal text-gray-400 ml-1"
    }, "(visible to all inspectors)")), (approval.comments || []).length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "space-y-2 mb-3 max-h-60 overflow-y-auto"
    }, approval.comments.map(comment => /*#__PURE__*/React.createElement("div", {
      key: comment.id,
      className: "bg-gray-50 rounded p-2 text-sm"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-start"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-gray-700"
    }, comment.author), /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-400"
    }, new Date(comment.timestamp).toLocaleString())), comment.text && /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mt-1"
    }, comment.text), (comment.photos || []).length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-2 mt-2"
    }, comment.photos.map(photo => /*#__PURE__*/React.createElement("img", {
      key: photo.id,
      src: photo.data,
      alt: photo.name,
      className: "w-20 h-20 object-cover rounded border cursor-pointer hover:opacity-80",
      onClick: () => setShowPhotoViewer(photo)
    })))))), canEdit && /*#__PURE__*/React.createElement("div", {
      className: "space-y-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newComment,
      onChange: e => setNewComment(e.target.value),
      onKeyPress: e => e.key === 'Enter' && !e.shiftKey && addStationComment(station),
      placeholder: "Add inspection note...",
      className: "flex-1 px-3 py-2 border rounded-lg text-sm"
    }), /*#__PURE__*/React.createElement("label", {
      className: "px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 flex items-center gap-1 text-gray-600",
      title: "Attach photos"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-lg"
    }, "\uD83D\uDCF7"), /*#__PURE__*/React.createElement("input", {
      type: "file",
      accept: "image/*",
      multiple: true,
      className: "hidden",
      onChange: handleCommentPhotoUpload
    })), /*#__PURE__*/React.createElement("button", {
      onClick: () => addStationComment(station),
      className: "px-4 py-2 rounded-lg text-white text-sm",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, "Add")), commentPhotos.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-500 w-full mb-1"
    }, "Attached photos (", commentPhotos.length, "):"), commentPhotos.map(photo => /*#__PURE__*/React.createElement("div", {
      key: photo.id,
      className: "relative group"
    }, /*#__PURE__*/React.createElement("img", {
      src: photo.data,
      alt: photo.name,
      className: "w-16 h-16 object-cover rounded border"
    }), /*#__PURE__*/React.createElement("button", {
      onClick: () => removeCommentPhoto(photo.id),
      className: "absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center"
    }, "\xD7")))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h5", {
      className: "text-sm font-medium text-gray-700 mb-2"
    }, "Inspection Photos"), (approval.photos || []).length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-4 gap-2 mb-3"
    }, approval.photos.map(photo => /*#__PURE__*/React.createElement("div", {
      key: photo.id,
      className: "relative group"
    }, /*#__PURE__*/React.createElement("img", {
      src: photo.data,
      alt: photo.name,
      className: "w-full h-20 object-cover rounded cursor-pointer hover:opacity-80",
      onClick: () => setShowPhotoViewer(photo)
    }), canEdit && /*#__PURE__*/React.createElement("button", {
      onClick: () => deletePhoto(station, photo.id),
      className: "absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition"
    }, "x")))), canEdit && /*#__PURE__*/React.createElement("label", {
      className: "inline-flex items-center gap-2 px-4 py-2 border border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-sm text-gray-600"
    }, /*#__PURE__*/React.createElement("span", null, "+ Add Photos"), /*#__PURE__*/React.createElement("input", {
      type: "file",
      accept: "image/*",
      multiple: true,
      className: "hidden",
      onChange: e => handlePhotoUpload(station, e)
    })))));
  }))), showPhotoViewer && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4",
    style: {
      zIndex: 10000
    },
    onClick: () => setShowPhotoViewer(null)
  }, /*#__PURE__*/React.createElement("div", {
    className: "max-w-4xl max-h-full"
  }, /*#__PURE__*/React.createElement("img", {
    src: showPhotoViewer.data,
    alt: showPhotoViewer.name,
    className: "max-w-full max-h-[80vh] object-contain"
  }), /*#__PURE__*/React.createElement("div", {
    className: "text-white text-center mt-4"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm"
  }, showPhotoViewer.name), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400"
  }, "Uploaded by ", showPhotoViewer.uploadedBy, " on ", new Date(showPhotoViewer.uploadedAt).toLocaleString())))), /*#__PURE__*/React.createElement("div", {
    className: `rounded-lg p-4 ${localTraveler.qaHold ? 'bg-red-50 border border-red-200' : 'bg-gray-50'}`
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-3",
    style: {
      color: localTraveler.qaHold ? '#DC2626' : 'var(--autovol-navy)'
    }
  }, "QA Hold Status"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-2 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: localTraveler.qaHold || false,
    onChange: e => updateLocal({
      qaHold: e.target.checked,
      qaHoldReason: e.target.checked ? localTraveler.qaHoldReason : null
    }),
    className: "w-5 h-5",
    disabled: !canEdit
  }), /*#__PURE__*/React.createElement("span", {
    className: `text-sm font-medium ${localTraveler.qaHold ? 'text-red-600' : 'text-gray-600'}`
  }, "Place on QA Hold"))), localTraveler.qaHold && /*#__PURE__*/React.createElement("div", {
    className: "mt-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Hold Reason"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: localTraveler.qaHoldReason || '',
    onChange: e => updateLocal({
      qaHoldReason: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg border-red-300",
    placeholder: "Enter reason for hold...",
    disabled: !canEdit
  }))), canEdit && localTraveler.status === 'active' && progress.percent === 100 && /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 rounded-lg p-4 border border-green-200"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold mb-2 text-green-700"
  }, "Ready for Completion"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-green-600 mb-3"
  }, "All inspections complete. Move this traveler to Pending Approval for QA Manager sign-off."), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      updateLocal({
        status: 'pending_approval'
      });
      saveChanges();
    },
    className: "px-4 py-2 rounded-lg text-white text-sm font-medium",
    style: {
      backgroundColor: '#43A047'
    }
  }, "Move to Pending Approval"))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-between items-center bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-400"
  }, "Created: ", new Date(localTraveler.createdAt).toLocaleDateString(), localTraveler.lastUpdated && ` | Updated: ${new Date(localTraveler.lastUpdated).toLocaleDateString()}`), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 border rounded-lg hover:bg-gray-100"
  }, "Close"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      saveChanges();
      onClose();
    },
    className: "px-4 py-2 rounded-lg text-white",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, "Save Changes")))));
}
window.TravelerDetailModal = TravelerDetailModal;
})();


// ============================================================================
// FILE: qa/QAInspectionModal.jsx
// ============================================================================
(function() {
// ============================================================================
// QA INSPECTION MODAL - Quick inspection entry from Weekly Board
// Opens when QA role clicks "Log QA Inspection" on module card
// Temporary prompt until full traveler linkage is implemented
// ============================================================================

function QAInspectionModal({
  module,
  station,
  onClose,
  onSave,
  currentUser
}) {
  const [formData, setFormData] = React.useState({
    inspectionType: 'general',
    result: 'PASS',
    notes: '',
    department: ''
  });
  const inspectionTypes = [{
    id: 'general',
    label: 'General Inspection'
  }, {
    id: 'stop-station',
    label: 'Stop Station Approval'
  }, {
    id: 'deviation',
    label: 'Log Deviation/NC'
  }];
  const handleSubmit = e => {
    e.preventDefault();
    onSave({
      ...formData,
      moduleId: module.id,
      moduleName: module.name || module.serialNumber,
      projectId: module.projectId,
      station: station?.name || station,
      inspector: currentUser?.name || 'QA Inspector',
      timestamp: new Date().toISOString()
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-white"
  }, "Log QA Inspection"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-teal-100"
  }, module?.name || module?.serialNumber, " at ", station?.name || station)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-white hover:text-gray-200 text-2xl"
  }, "\xD7"))), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Module:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, module?.name || module?.serialNumber)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Station:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, station?.name || station)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Project:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, module?.projectName || '-')))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Inspection Type"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, inspectionTypes.map(type => /*#__PURE__*/React.createElement("label", {
    key: type.id,
    className: "flex items-center gap-2 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "radio",
    name: "inspectionType",
    value: type.id,
    checked: formData.inspectionType === type.id,
    onChange: e => setFormData({
      ...formData,
      inspectionType: e.target.value
    }),
    className: "w-4 h-4"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm"
  }, type.label))))), formData.inspectionType !== 'deviation' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Result"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, ['PASS', 'NC', 'N/A'].map(result => /*#__PURE__*/React.createElement("button", {
    key: result,
    type: "button",
    onClick: () => setFormData({
      ...formData,
      result
    }),
    className: `flex-1 py-2 rounded-lg font-medium text-sm transition ${formData.result === result ? result === 'PASS' ? 'bg-green-500 text-white' : result === 'NC' ? 'bg-red-500 text-white' : 'bg-gray-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, result)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, formData.inspectionType === 'deviation' ? 'Deviation Description *' : 'Notes'), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData({
      ...formData,
      notes: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg text-sm",
    rows: "3",
    placeholder: formData.inspectionType === 'deviation' ? 'Describe the non-conformance...' : 'Optional inspection notes...',
    required: formData.inspectionType === 'deviation'
  })), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Note:"), " This is a temporary inspection log. Full traveler integration will link inspections directly to the QA Traveler system."), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "flex-1 px-4 py-2 rounded-lg text-white",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, "Log Inspection")))));
}
window.QAInspectionModal = QAInspectionModal;
})();


// ============================================================================
// FILE: YardMap.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA YARD MAP COMPONENT
// Visual yard mapping with PDF backgrounds and interactive module placement
// ============================================================================

const YardMapComponent = ({
  projects = []
}) => {
  const [activeTab, setActiveTab] = useState('map');
  const [yardMaps, setYardMaps] = useState([]);
  const [selectedYardMap, setSelectedYardMap] = useState(null);
  const [modules, setModules] = useState([]);
  const [settings, setSettings] = useState({
    defaultFontSize: 14,
    defaultYardMapId: null
  });
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // Canvas state
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const [pdfImage, setPdfImage] = useState(null);
  const [zoom, setZoom] = useState(1);
  const [pan, setPan] = useState({
    x: 0,
    y: 0
  });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({
    x: 0,
    y: 0
  });

  // Module interaction state
  const [selectedModule, setSelectedModule] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [drawStart, setDrawStart] = useState(null);
  const [drawEnd, setDrawEnd] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [isRotating, setIsRotating] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const [dragOffset, setDragOffset] = useState({
    x: 0,
    y: 0
  });

  // New module form
  const [newModuleForm, setNewModuleForm] = useState({
    projectId: '',
    blm: '',
    abbreviation: '',
    color: '#3B82F6'
  });
  const [isDrawMode, setIsDrawMode] = useState(false);

  // Upload state
  const [isUploading, setIsUploading] = useState(false);
  const [uploadForm, setUploadForm] = useState({
    name: '',
    yardType: 'front'
  });
  const fileInputRef = useRef(null);

  // Fullscreen state
  const [isFullscreen, setIsFullscreen] = useState(false);

  // Colors
  const COLORS = {
    red: '#E31B23',
    blue: '#1E3A5F',
    white: '#FFFFFF',
    lightGray: '#F5F6FA'
  };

  // Yard types
  const YARD_TYPES = [{
    id: 'front',
    label: 'Front Yard'
  }, {
    id: 'back',
    label: 'Back Yard'
  }, {
    id: 'staging',
    label: 'Staging Area'
  }, {
    id: 'overflow',
    label: 'Overflow'
  }, {
    id: 'other',
    label: 'Other'
  }];

  // ============================================================================
  // DATA LOADING
  // ============================================================================

  useEffect(() => {
    loadData();
  }, []);
  const loadData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
        // Load yard maps
        const mapsData = await supabaseFetch('yard_maps?select=id,name,yard_type,created_at,updated_at&order=name');
        setYardMaps(mapsData || []);

        // Load settings
        const settingsData = await supabaseFetch('yard_settings?id=eq.1');
        if (settingsData && settingsData.length > 0) {
          setSettings({
            defaultFontSize: settingsData[0].default_font_size || 14,
            defaultYardMapId: settingsData[0].default_yard_map_id
          });

          // Auto-select default yard map
          if (settingsData[0].default_yard_map_id) {
            const defaultMap = mapsData?.find(m => m.id === settingsData[0].default_yard_map_id);
            if (defaultMap) {
              await selectYardMap(defaultMap);
            }
          }
        }
      }
    } catch (err) {
      console.error('[YardMap] Error loading data:', err);
      setError('Failed to load yard map data');
    } finally {
      setIsLoading(false);
    }
  };

  // Helper for Supabase fetch
  const supabaseFetch = async (endpoint, options = {}) => {
    const SUPABASE_URL = 'https://syreuphexagezawjyjgt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cmV1cGhleGFnZXphd2p5amd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2Mzc1MDEsImV4cCI6MjA4MTIxMzUwMX0.-0Th_v-LDCXER9v06-mjfdEUZtRxZZSHHWypmTQXmbs';
    let accessToken = null;
    try {
      const storageKey = `sb-syreuphexagezawjyjgt-auth-token`;
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        accessToken = parsed?.access_token;
      }
    } catch (e) {}
    const headers = {
      'apikey': SUPABASE_ANON_KEY,
      'Content-Type': 'application/json',
      ...(accessToken ? {
        'Authorization': `Bearer ${accessToken}`
      } : {}),
      ...options.headers
    };
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
      ...options,
      headers
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({
        message: response.statusText
      }));
      throw new Error(error.message || 'Request failed');
    }
    const text = await response.text();
    if (!text || text.trim() === '') return null;
    return JSON.parse(text);
  };

  // ============================================================================
  // YARD MAP SELECTION & PDF LOADING
  // ============================================================================

  const selectYardMap = async yardMap => {
    setSelectedYardMap(yardMap);
    setSelectedModule(null);
    setIsDrawMode(false);
    try {
      // Load full yard map with PDF data
      const fullMap = await supabaseFetch(`yard_maps?id=eq.${yardMap.id}&select=*`);
      if (fullMap && fullMap.length > 0 && fullMap[0].pdf_data) {
        await loadPdfImage(fullMap[0].pdf_data);
      } else {
        setPdfImage(null);
      }

      // Load modules for this yard map
      const modulesData = await supabaseFetch(`yard_modules?yard_map_id=eq.${yardMap.id}&select=*`);
      setModules(modulesData || []);
    } catch (err) {
      console.error('[YardMap] Error loading yard map:', err);
      setError('Failed to load yard map');
    }
  };
  const loadPdfImage = async pdfData => {
    try {
      // Check if pdf.js is available
      if (!window.pdfjsLib) {
        console.warn('[YardMap] PDF.js not loaded, showing placeholder');
        setPdfImage(null);
        return;
      }

      // Convert base64 to array buffer
      const base64 = pdfData.replace(/^data:application\/pdf;base64,/, '');
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      // Load PDF
      const pdf = await window.pdfjsLib.getDocument({
        data: bytes
      }).promise;
      const page = await pdf.getPage(1);

      // Render to canvas
      const viewport = page.getViewport({
        scale: 2
      });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({
        canvasContext: context,
        viewport
      }).promise;

      // Convert to image
      const img = new Image();
      img.src = canvas.toDataURL();
      await new Promise(resolve => {
        img.onload = resolve;
      });
      setPdfImage(img);
    } catch (err) {
      console.error('[YardMap] Error loading PDF:', err);
      setPdfImage(null);
    }
  };

  // ============================================================================
  // CANVAS RENDERING
  // ============================================================================

  useEffect(() => {
    renderCanvas();
  }, [pdfImage, modules, selectedModule, zoom, pan, drawStart, drawEnd, isDrawing]);

  // Use ref to track zoom for wheel handler (avoids re-registering listener)
  const zoomRef = useRef(zoom);
  useEffect(() => {
    zoomRef.current = zoom;
  }, [zoom]);

  // Add non-passive wheel event listener to prevent scroll while zooming
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const handleWheelEvent = e => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const newZoom = Math.max(0.1, Math.min(5, zoomRef.current * delta));
      setZoom(newZoom);
    };
    canvas.addEventListener('wheel', handleWheelEvent, {
      passive: false
    });
    return () => canvas.removeEventListener('wheel', handleWheelEvent);
  }, []); // Empty dependency - register once on mount

  const renderCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const container = containerRef.current;
    if (!container) return;

    // Set canvas size
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    // Clear
    ctx.fillStyle = '#e5e7eb';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Apply transformations
    ctx.save();
    ctx.translate(pan.x, pan.y);
    ctx.scale(zoom, zoom);

    // Draw PDF background
    if (pdfImage) {
      ctx.drawImage(pdfImage, 0, 0);
    } else if (selectedYardMap) {
      // Placeholder when no PDF
      ctx.fillStyle = '#f3f4f6';
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = '#9ca3af';
      ctx.font = '16px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('No PDF uploaded for this yard map', 400, 300);
    }

    // Draw modules
    modules.forEach(module => {
      drawModule(ctx, module, module.id === selectedModule?.id);
    });

    // Draw preview while drawing
    if (isDrawing && drawStart && drawEnd) {
      const x = Math.min(drawStart.x, drawEnd.x);
      const y = Math.min(drawStart.y, drawEnd.y);
      const width = Math.abs(drawEnd.x - drawStart.x);
      const height = Math.abs(drawEnd.y - drawStart.y);
      ctx.strokeStyle = newModuleForm.color;
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(x, y, width, height);
      ctx.setLineDash([]);
    }
    ctx.restore();
  };
  const drawModule = (ctx, module, isSelected) => {
    const {
      x,
      y,
      width,
      height,
      rotation = 0,
      color,
      abbreviation,
      blm,
      text_size = 14
    } = module;
    ctx.save();

    // Translate to center for rotation
    const centerX = x + width / 2;
    const centerY = y + height / 2;
    ctx.translate(centerX, centerY);
    ctx.rotate(rotation * Math.PI / 180);
    ctx.translate(-width / 2, -height / 2);

    // Draw rectangle
    ctx.fillStyle = color + '40'; // 25% opacity
    ctx.fillRect(0, 0, width, height);
    ctx.strokeStyle = color;
    ctx.lineWidth = isSelected ? 3 : 2;
    ctx.strokeRect(0, 0, width, height);

    // Draw text
    ctx.fillStyle = color;
    ctx.font = `bold ${text_size}px Inter, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Draw abbreviation
    ctx.fillText(abbreviation, width / 2, height / 2 - 8);

    // Draw BLM
    ctx.font = `${text_size - 2}px Inter, sans-serif`;
    ctx.fillText(blm, width / 2, height / 2 + 10);
    ctx.restore();

    // Draw selection handles if selected
    if (isSelected) {
      drawSelectionHandles(ctx, module);
    }
  };
  const drawSelectionHandles = (ctx, module) => {
    const {
      x,
      y,
      width,
      height
    } = module;
    const handleSize = 8;
    ctx.fillStyle = COLORS.blue;

    // Corner handles for resize
    const corners = [{
      x: x,
      y: y
    }, {
      x: x + width,
      y: y
    }, {
      x: x,
      y: y + height
    }, {
      x: x + width,
      y: y + height
    }];
    corners.forEach(corner => {
      ctx.fillRect(corner.x - handleSize / 2, corner.y - handleSize / 2, handleSize, handleSize);
    });

    // Rotation handle (top center)
    ctx.beginPath();
    ctx.arc(x + width / 2, y - 20, 6, 0, Math.PI * 2);
    ctx.fill();

    // Line to rotation handle
    ctx.strokeStyle = COLORS.blue;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x + width / 2, y);
    ctx.lineTo(x + width / 2, y - 14);
    ctx.stroke();
  };

  // ============================================================================
  // MOUSE HANDLERS
  // ============================================================================

  const getCanvasCoords = e => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - pan.x) / zoom;
    const y = (e.clientY - rect.top - pan.y) / zoom;
    return {
      x,
      y
    };
  };
  const handleMouseDown = e => {
    const coords = getCanvasCoords(e);
    if (isDrawMode) {
      setIsDrawing(true);
      setDrawStart(coords);
      setDrawEnd(coords);
      return;
    }

    // Check if clicking on a module
    const clickedModule = findModuleAtPoint(coords);
    if (clickedModule) {
      setSelectedModule(clickedModule);

      // Check if clicking on rotation handle
      if (isOnRotationHandle(coords, clickedModule)) {
        setIsRotating(true);
        return;
      }

      // Check if clicking on resize handle
      const resizeHandle = getResizeHandle(coords, clickedModule);
      if (resizeHandle) {
        setIsResizing(resizeHandle);
        return;
      }

      // Start dragging
      setIsDragging(true);
      setDragOffset({
        x: coords.x - clickedModule.x,
        y: coords.y - clickedModule.y
      });
    } else {
      setSelectedModule(null);
      // Start panning
      setIsPanning(true);
      setPanStart({
        x: e.clientX - pan.x,
        y: e.clientY - pan.y
      });
    }
  };
  const handleMouseMove = e => {
    const coords = getCanvasCoords(e);
    if (isDrawing) {
      setDrawEnd(coords);
      return;
    }
    if (isPanning) {
      setPan({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
      return;
    }
    if (isDragging && selectedModule) {
      updateModule(selectedModule.id, {
        x: coords.x - dragOffset.x,
        y: coords.y - dragOffset.y
      });
      return;
    }
    if (isRotating && selectedModule) {
      const centerX = selectedModule.x + selectedModule.width / 2;
      const centerY = selectedModule.y + selectedModule.height / 2;
      const angle = Math.atan2(coords.y - centerY, coords.x - centerX) * (180 / Math.PI) + 90;
      const snappedAngle = Math.round(angle / 5) * 5; // Snap to 5 degree increments
      updateModule(selectedModule.id, {
        rotation: snappedAngle
      });
      return;
    }
    if (isResizing && selectedModule) {
      const newProps = calculateResize(selectedModule, coords, isResizing);
      updateModule(selectedModule.id, newProps);
      return;
    }
  };
  const handleMouseUp = async () => {
    if (isDrawing && drawStart && drawEnd) {
      const x = Math.min(drawStart.x, drawEnd.x);
      const y = Math.min(drawStart.y, drawEnd.y);
      const width = Math.abs(drawEnd.x - drawStart.x);
      const height = Math.abs(drawEnd.y - drawStart.y);
      if (width > 20 && height > 20) {
        await createModule(x, y, width, height);
      }
      setIsDrawing(false);
      setDrawStart(null);
      setDrawEnd(null);
      setIsDrawMode(false);
    }

    // Save module position after drag/rotate/resize
    if ((isDragging || isRotating || isResizing) && selectedModule) {
      await saveModuleToSupabase(selectedModule);
    }
    setIsPanning(false);
    setIsDragging(false);
    setIsRotating(false);
    setIsResizing(false);
  };

  // ============================================================================
  // MODULE HELPERS
  // ============================================================================

  const findModuleAtPoint = point => {
    // Check in reverse order (top-most first)
    for (let i = modules.length - 1; i >= 0; i--) {
      const m = modules[i];
      if (point.x >= m.x && point.x <= m.x + m.width && point.y >= m.y && point.y <= m.y + m.height) {
        return m;
      }
    }
    return null;
  };
  const isOnRotationHandle = (point, module) => {
    const handleX = module.x + module.width / 2;
    const handleY = module.y - 20;
    const distance = Math.sqrt((point.x - handleX) ** 2 + (point.y - handleY) ** 2);
    return distance < 10;
  };
  const getResizeHandle = (point, module) => {
    const handleSize = 12;
    const corners = {
      'nw': {
        x: module.x,
        y: module.y
      },
      'ne': {
        x: module.x + module.width,
        y: module.y
      },
      'sw': {
        x: module.x,
        y: module.y + module.height
      },
      'se': {
        x: module.x + module.width,
        y: module.y + module.height
      }
    };
    for (const [key, corner] of Object.entries(corners)) {
      if (Math.abs(point.x - corner.x) < handleSize && Math.abs(point.y - corner.y) < handleSize) {
        return key;
      }
    }
    return null;
  };
  const calculateResize = (module, point, handle) => {
    let {
      x,
      y,
      width,
      height
    } = module;
    switch (handle) {
      case 'se':
        width = Math.max(30, point.x - x);
        height = Math.max(30, point.y - y);
        break;
      case 'sw':
        width = Math.max(30, x + width - point.x);
        height = Math.max(30, point.y - y);
        x = point.x;
        break;
      case 'ne':
        width = Math.max(30, point.x - x);
        height = Math.max(30, y + height - point.y);
        y = point.y;
        break;
      case 'nw':
        width = Math.max(30, x + width - point.x);
        height = Math.max(30, y + height - point.y);
        x = point.x;
        y = point.y;
        break;
    }
    return {
      x,
      y,
      width,
      height
    };
  };
  const updateModule = (moduleId, updates) => {
    setModules(prev => prev.map(m => m.id === moduleId ? {
      ...m,
      ...updates
    } : m));
    if (selectedModule?.id === moduleId) {
      setSelectedModule(prev => ({
        ...prev,
        ...updates
      }));
    }
  };

  // ============================================================================
  // SUPABASE OPERATIONS
  // ============================================================================

  const createModule = async (x, y, width, height) => {
    if (!selectedYardMap || !newModuleForm.blm || !newModuleForm.abbreviation) {
      alert('Please fill in BLM and abbreviation before drawing');
      return;
    }
    const newModule = {
      yard_map_id: selectedYardMap.id,
      blm: newModuleForm.blm,
      abbreviation: newModuleForm.abbreviation,
      color: newModuleForm.color,
      x,
      y,
      width,
      height,
      rotation: 0,
      text_size: settings.defaultFontSize
    };
    try {
      const result = await supabaseFetch('yard_modules?select=*', {
        method: 'POST',
        headers: {
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(newModule)
      });
      if (result && result.length > 0) {
        setModules(prev => [...prev, result[0]]);
        setNewModuleForm({
          projectId: '',
          blm: '',
          abbreviation: '',
          color: '#3B82F6'
        });
      }
    } catch (err) {
      console.error('[YardMap] Error creating module:', err);
      alert('Failed to create module');
    }
  };
  const saveModuleToSupabase = async module => {
    try {
      await supabaseFetch(`yard_modules?id=eq.${module.id}`, {
        method: 'PATCH',
        body: JSON.stringify({
          x: module.x,
          y: module.y,
          width: module.width,
          height: module.height,
          rotation: module.rotation,
          text_size: module.text_size,
          updated_at: new Date().toISOString()
        })
      });
    } catch (err) {
      console.error('[YardMap] Error saving module:', err);
    }
  };
  const deleteSelectedModule = async () => {
    if (!selectedModule) return;
    if (!confirm(`Delete module ${selectedModule.blm}?`)) return;
    try {
      await supabaseFetch(`yard_modules?id=eq.${selectedModule.id}`, {
        method: 'DELETE'
      });
      setModules(prev => prev.filter(m => m.id !== selectedModule.id));
      setSelectedModule(null);
    } catch (err) {
      console.error('[YardMap] Error deleting module:', err);
      alert('Failed to delete module');
    }
  };

  // ============================================================================
  // YARD MAP MANAGEMENT
  // ============================================================================

  const handleFileUpload = async e => {
    const file = e.target.files?.[0];
    if (!file || !file.type.includes('pdf')) {
      alert('Please select a PDF file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      return;
    }
    if (!uploadForm.name) {
      alert('Please enter a name for the yard map');
      return;
    }
    setIsUploading(true);
    try {
      // Convert to base64
      const reader = new FileReader();
      const base64 = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Save to Supabase
      const result = await supabaseFetch('yard_maps?select=*', {
        method: 'POST',
        headers: {
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({
          name: uploadForm.name,
          yard_type: uploadForm.yardType,
          pdf_data: base64
        })
      });
      if (result && result.length > 0) {
        setYardMaps(prev => [...prev, result[0]]);
        setUploadForm({
          name: '',
          yardType: 'front'
        });
        alert('Yard map uploaded successfully!');
      }
    } catch (err) {
      console.error('[YardMap] Error uploading:', err);
      alert('Failed to upload yard map');
    } finally {
      setIsUploading(false);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };
  const deleteYardMap = async mapId => {
    if (!confirm('Delete this yard map and all its modules?')) return;
    try {
      await supabaseFetch(`yard_maps?id=eq.${mapId}`, {
        method: 'DELETE'
      });
      setYardMaps(prev => prev.filter(m => m.id !== mapId));
      if (selectedYardMap?.id === mapId) {
        setSelectedYardMap(null);
        setModules([]);
        setPdfImage(null);
      }
    } catch (err) {
      console.error('[YardMap] Error deleting yard map:', err);
      alert('Failed to delete yard map');
    }
  };
  const setAsDefault = async mapId => {
    try {
      await supabaseFetch('yard_settings?id=eq.1', {
        method: 'PATCH',
        body: JSON.stringify({
          default_yard_map_id: mapId
        })
      });
      setSettings(prev => ({
        ...prev,
        defaultYardMapId: mapId
      }));
    } catch (err) {
      console.error('[YardMap] Error setting default:', err);
    }
  };

  // ============================================================================
  // STYLES
  // ============================================================================

  const styles = {
    container: {
      display: 'flex',
      flexDirection: 'column',
      height: '100%',
      minHeight: '600px',
      background: COLORS.white,
      borderRadius: '12px',
      overflow: 'hidden',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
    },
    toolbar: {
      display: 'flex',
      alignItems: 'center',
      gap: '16px',
      padding: '12px 16px',
      borderBottom: '1px solid #e5e7eb',
      background: '#fafafa',
      flexWrap: 'wrap'
    },
    select: {
      padding: '8px 12px',
      borderRadius: '6px',
      border: '1px solid #ddd',
      fontSize: '14px',
      minWidth: '200px'
    },
    input: {
      padding: '8px 12px',
      borderRadius: '6px',
      border: '1px solid #ddd',
      fontSize: '14px'
    },
    btn: (variant = 'primary') => ({
      padding: '8px 16px',
      background: variant === 'primary' ? COLORS.blue : variant === 'danger' ? COLORS.red : '#e5e7eb',
      color: variant === 'secondary' ? '#333' : COLORS.white,
      border: 'none',
      borderRadius: '6px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '13px',
      transition: 'all 0.2s ease'
    }),
    canvasContainer: {
      flex: 1,
      position: 'relative',
      overflow: 'hidden',
      cursor: isDrawMode ? 'crosshair' : isPanning ? 'grabbing' : 'grab'
    },
    canvas: {
      display: 'block',
      width: '100%',
      height: '100%'
    },
    sidebar: {
      width: '280px',
      borderLeft: '1px solid #e5e7eb',
      padding: '16px',
      overflowY: 'auto',
      background: '#fafafa'
    },
    moduleForm: {
      background: COLORS.white,
      padding: '16px',
      borderRadius: '8px',
      marginBottom: '16px',
      border: '1px solid #e5e7eb'
    },
    fieldGroup: {
      marginBottom: '12px'
    },
    label: {
      display: 'block',
      marginBottom: '4px',
      fontWeight: '600',
      fontSize: '12px',
      color: '#666'
    },
    modulesList: {
      maxHeight: '300px',
      overflowY: 'auto'
    },
    moduleItem: isSelected => ({
      padding: '10px 12px',
      background: isSelected ? COLORS.blue + '15' : COLORS.white,
      borderRadius: '6px',
      marginBottom: '6px',
      cursor: 'pointer',
      border: isSelected ? `2px solid ${COLORS.blue}` : '1px solid #e5e7eb',
      transition: 'all 0.2s ease'
    })
  };

  // ============================================================================
  // RENDER - MAP TAB
  // ============================================================================

  const renderMapTab = () => /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flex: 1,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      display: 'flex',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.toolbar
  }, /*#__PURE__*/React.createElement("select", {
    value: selectedYardMap?.id || '',
    onChange: e => {
      const map = yardMaps.find(m => m.id === e.target.value);
      if (map) selectYardMap(map);
    },
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "-- Select Yard Map --"), yardMaps.map(map => /*#__PURE__*/React.createElement("option", {
    key: map.id,
    value: map.id
  }, map.name, " (", map.yard_type, ")", map.id === settings.defaultYardMapId ? ' (Default)' : ''))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, "Zoom: ", Math.round(zoom * 100), "%"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setZoom(z => Math.min(5, z * 1.2)),
    style: styles.btn('secondary')
  }, "+"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setZoom(z => Math.max(0.1, z / 1.2)),
    style: styles.btn('secondary')
  }, "-"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setZoom(1);
      setPan({
        x: 0,
        y: 0
      });
    },
    style: styles.btn('secondary')
  }, "Reset")), selectedModule && /*#__PURE__*/React.createElement("button", {
    onClick: deleteSelectedModule,
    style: styles.btn('danger')
  }, "Delete Selected")), /*#__PURE__*/React.createElement("div", {
    ref: containerRef,
    style: styles.canvasContainer
  }, /*#__PURE__*/React.createElement("canvas", {
    ref: canvasRef,
    style: styles.canvas,
    onMouseDown: handleMouseDown,
    onMouseMove: handleMouseMove,
    onMouseUp: handleMouseUp,
    onMouseLeave: handleMouseUp
  }), !selectedYardMap && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'absolute',
      inset: 0,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      background: 'rgba(255,255,255,0.9)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      color: '#666'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '48px',
      marginBottom: '16px'
    }
  }, "\uD83D\uDDFA"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '18px',
      fontWeight: '600',
      marginBottom: '8px'
    }
  }, "No Yard Map Selected"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '14px'
    }
  }, "Select a yard map from the dropdown or upload a new one in Settings"))))), selectedYardMap && /*#__PURE__*/React.createElement("div", {
    style: styles.sidebar
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0',
      fontSize: '16px',
      color: COLORS.blue
    }
  }, "Add Module"), /*#__PURE__*/React.createElement("div", {
    style: styles.moduleForm
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.fieldGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Project"), /*#__PURE__*/React.createElement("select", {
    value: newModuleForm.projectId,
    onChange: e => {
      const project = projects.find(p => p.id === e.target.value);
      setNewModuleForm(prev => ({
        ...prev,
        projectId: e.target.value,
        abbreviation: project?.abbreviation || prev.abbreviation,
        color: project?.color || prev.color
      }));
    },
    style: {
      ...styles.input,
      width: '100%'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "-- Select Project --"), projects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name)))), /*#__PURE__*/React.createElement("div", {
    style: styles.fieldGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "BLM Number *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newModuleForm.blm,
    onChange: e => setNewModuleForm(prev => ({
      ...prev,
      blm: e.target.value
    })),
    placeholder: "e.g., BLM-1001",
    style: {
      ...styles.input,
      width: '100%'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.fieldGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Abbreviation *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newModuleForm.abbreviation,
    onChange: e => setNewModuleForm(prev => ({
      ...prev,
      abbreviation: e.target.value
    })),
    placeholder: "e.g., ARA-T",
    style: {
      ...styles.input,
      width: '100%'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.fieldGroup
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Color"), /*#__PURE__*/React.createElement("input", {
    type: "color",
    value: newModuleForm.color,
    onChange: e => setNewModuleForm(prev => ({
      ...prev,
      color: e.target.value
    })),
    style: {
      ...styles.input,
      width: '100%',
      height: '36px',
      padding: '2px'
    }
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsDrawMode(true),
    disabled: !newModuleForm.blm || !newModuleForm.abbreviation,
    style: {
      ...styles.btn(isDrawMode ? 'primary' : 'secondary'),
      width: '100%',
      opacity: !newModuleForm.blm || !newModuleForm.abbreviation ? 0.5 : 1
    }
  }, isDrawMode ? 'Drawing... Click & Drag on Map' : 'Draw on Map')), /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 12px 0',
      fontSize: '16px',
      color: COLORS.blue
    }
  }, "Modules (", modules.length, ")"), /*#__PURE__*/React.createElement("div", {
    style: styles.modulesList
  }, modules.map(module => /*#__PURE__*/React.createElement("div", {
    key: module.id,
    onClick: () => setSelectedModule(module),
    style: styles.moduleItem(selectedModule?.id === module.id)
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      fontSize: '13px',
      color: module.color
    }
  }, module.abbreviation), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, module.blm))), modules.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px',
      color: '#999',
      fontSize: '13px'
    }
  }, "No modules placed yet"))));

  // ============================================================================
  // RENDER - SETTINGS TAB
  // ============================================================================

  const renderSettingsTab = () => /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '24px',
      maxWidth: '800px'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: '0 0 24px 0',
      color: COLORS.blue
    }
  }, "Yard Map Settings"), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#fafafa',
      padding: '20px',
      borderRadius: '8px',
      marginBottom: '24px'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0',
      fontSize: '16px'
    }
  }, "Upload New Yard Map"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: '16px',
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: uploadForm.name,
    onChange: e => setUploadForm(prev => ({
      ...prev,
      name: e.target.value
    })),
    placeholder: "e.g., Front Yard - Main",
    style: {
      ...styles.input,
      width: '100%'
    }
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Yard Type"), /*#__PURE__*/React.createElement("select", {
    value: uploadForm.yardType,
    onChange: e => setUploadForm(prev => ({
      ...prev,
      yardType: e.target.value
    })),
    style: {
      ...styles.input,
      width: '100%'
    }
  }, YARD_TYPES.map(type => /*#__PURE__*/React.createElement("option", {
    key: type.id,
    value: type.id
  }, type.label))))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '12px'
    }
  }, /*#__PURE__*/React.createElement("input", {
    ref: fileInputRef,
    type: "file",
    accept: ".pdf",
    onChange: handleFileUpload,
    style: {
      display: 'none'
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => fileInputRef.current?.click(),
    disabled: isUploading || !uploadForm.name,
    style: {
      ...styles.btn('primary'),
      opacity: isUploading || !uploadForm.name ? 0.5 : 1
    }
  }, isUploading ? 'Uploading...' : 'Select PDF & Upload'), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, "Max 5MB, PDF only"))), /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0',
      fontSize: '16px'
    }
  }, "Existing Yard Maps"), yardMaps.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: '#999',
      background: '#fafafa',
      borderRadius: '8px'
    }
  }, "No yard maps uploaded yet") : /*#__PURE__*/React.createElement("table", {
    style: {
      width: '100%',
      borderCollapse: 'collapse'
    }
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    style: {
      background: COLORS.blue,
      color: COLORS.white
    }
  }, /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'left'
    }
  }, "Name"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'left'
    }
  }, "Type"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'center'
    }
  }, "Default"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'right'
    }
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, yardMaps.map((map, idx) => /*#__PURE__*/React.createElement("tr", {
    key: map.id,
    style: {
      background: idx % 2 === 0 ? COLORS.white : '#fafafa'
    }
  }, /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      fontWeight: '600'
    }
  }, map.name), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px'
    }
  }, YARD_TYPES.find(t => t.id === map.yard_type)?.label || map.yard_type), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      textAlign: 'center'
    }
  }, map.id === settings.defaultYardMapId ? /*#__PURE__*/React.createElement("span", {
    style: {
      color: '#10B981',
      fontWeight: '600'
    }
  }, "Default") : /*#__PURE__*/React.createElement("button", {
    onClick: () => setAsDefault(map.id),
    style: styles.btn('secondary')
  }, "Set Default")), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => deleteYardMap(map.id),
    style: styles.btn('danger')
  }, "Delete")))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '24px',
      background: '#fafafa',
      padding: '20px',
      borderRadius: '8px'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0',
      fontSize: '16px'
    }
  }, "Default Settings"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '12px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      fontWeight: '600',
      fontSize: '14px'
    }
  }, "Default Font Size:"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: settings.defaultFontSize,
    onChange: async e => {
      const size = parseInt(e.target.value) || 14;
      setSettings(prev => ({
        ...prev,
        defaultFontSize: size
      }));
      try {
        await supabaseFetch('yard_settings?id=eq.1', {
          method: 'PATCH',
          body: JSON.stringify({
            default_font_size: size
          })
        });
      } catch (err) {
        console.error('[YardMap] Error saving font size:', err);
      }
    },
    min: "8",
    max: "32",
    style: {
      ...styles.input,
      width: '80px'
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, "px"))));

  // ============================================================================
  // RENDER - PROJECT LIBRARY TAB
  // ============================================================================

  const renderProjectLibraryTab = () => /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '24px'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: '0 0 24px 0',
      color: COLORS.blue
    }
  }, "Project Library"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: '#666',
      marginBottom: '24px'
    }
  }, "Projects from MODA's Project Directory. Select a project when adding modules to auto-fill abbreviation and color."), projects.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: '#999',
      background: '#fafafa',
      borderRadius: '8px'
    }
  }, "No projects available. Add projects in the Projects module.") : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
      gap: '16px'
    }
  }, projects.map(project => /*#__PURE__*/React.createElement("div", {
    key: project.id,
    style: {
      padding: '16px',
      background: COLORS.white,
      borderRadius: '8px',
      border: '1px solid #e5e7eb',
      borderLeft: `4px solid ${project.color || '#3B82F6'}`
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      fontSize: '15px',
      marginBottom: '4px'
    }
  }, project.name), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '13px',
      color: '#666',
      marginBottom: '8px'
    }
  }, project.abbreviation || 'No abbreviation'), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '20px',
      height: '20px',
      borderRadius: '4px',
      background: project.color || '#3B82F6'
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#999'
    }
  }, project.color || '#3B82F6'))))));

  // ============================================================================
  // MAIN RENDER
  // ============================================================================

  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '400px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        textAlign: 'center',
        color: '#666'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '24px',
        marginBottom: '12px'
      }
    }, "Loading Yard Map...")));
  }

  // Fullscreen container styles
  const fullscreenStyles = isFullscreen ? {
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    zIndex: 9999,
    background: COLORS.white
  } : {};
  return /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.container,
      ...fullscreenStyles
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      borderBottom: '1px solid #e5e7eb',
      background: '#fafafa',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex'
    }
  }, [{
    id: 'map',
    label: 'Yard Map'
  }, {
    id: 'library',
    label: 'Project Library'
  }, {
    id: 'settings',
    label: 'Settings'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveTab(tab.id),
    style: {
      padding: '12px 24px',
      border: 'none',
      background: activeTab === tab.id ? COLORS.white : 'transparent',
      color: activeTab === tab.id ? COLORS.blue : '#666',
      fontWeight: '600',
      fontSize: '14px',
      cursor: 'pointer',
      borderBottom: activeTab === tab.id ? `3px solid ${COLORS.blue}` : '3px solid transparent',
      transition: 'all 0.2s ease'
    }
  }, tab.label))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsFullscreen(!isFullscreen),
    style: {
      padding: '8px 16px',
      margin: '8px 16px',
      background: isFullscreen ? COLORS.red : COLORS.blue,
      color: COLORS.white,
      border: 'none',
      borderRadius: '6px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '13px'
    }
  }, isFullscreen ? 'Exit Fullscreen' : 'Fullscreen')), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      display: 'flex',
      flexDirection: 'column',
      overflow: 'hidden'
    }
  }, activeTab === 'map' && renderMapTab(), activeTab === 'library' && renderProjectLibraryTab(), activeTab === 'settings' && renderSettingsTab()), error && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      bottom: '20px',
      right: '20px',
      padding: '12px 20px',
      background: COLORS.red,
      color: COLORS.white,
      borderRadius: '8px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
    }
  }, error, /*#__PURE__*/React.createElement("button", {
    onClick: () => setError(null),
    style: {
      marginLeft: '12px',
      background: 'none',
      border: 'none',
      color: COLORS.white,
      cursor: 'pointer'
    }
  }, "\u2715")));
};

// Export for use in TransportModule
window.YardMapComponent = YardMapComponent;
})();


// ============================================================================
// FILE: YardMapV2.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA YARD MAP v2.0 - MAIN COMPONENT
// ============================================================================
// Integrated yard mapping with Transport workflow sync
// Workflow: WeeklyBoard → Transport → Yard Map → Shipped Confirmation

const YardMapV2 = ({
  projects = []
}) => {
  // Core state
  const [activeTab, setActiveTab] = useState('map');
  const [yardMaps, setYardMaps] = useState([]);
  const [selectedYardMap, setSelectedYardMap] = useState(null);
  const [modules, setModules] = useState([]);
  const [settings, setSettings] = useState({
    defaultFontSize: 14,
    defaultYardMapId: null
  });
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // Transport queue
  const [transportQueue, setTransportQueue] = useState([]);
  const [selectedQueueItem, setSelectedQueueItem] = useState(null);

  // Canvas state
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const [pdfImage, setPdfImage] = useState(null);
  const [zoom, setZoom] = useState(1);
  const [pan, setPan] = useState({
    x: 0,
    y: 0
  });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({
    x: 0,
    y: 0
  });

  // Module interaction
  const [selectedModule, setSelectedModule] = useState(null);
  const [isDrawMode, setIsDrawMode] = useState(false);
  const [drawingModule, setDrawingModule] = useState(null);
  const [drawStart, setDrawStart] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [isRotating, setIsRotating] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const [dragOffset, setDragOffset] = useState({
    x: 0,
    y: 0
  });

  // Shipped confirmation modal
  const [shippedModule, setShippedModule] = useState(null);
  const [showShippedModal, setShowShippedModal] = useState(false);

  // Stats & Search
  const [stats, setStats] = useState({
    total: 0,
    active: 0,
    shippedKept: 0,
    byProject: {}
  });
  const [searchTerm, setSearchTerm] = useState('');

  // Upload state
  const [isUploading, setIsUploading] = useState(false);
  const [uploadForm, setUploadForm] = useState({
    name: '',
    yardType: 'front'
  });
  const fileInputRef = useRef(null);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const COLORS = {
    red: '#E31B23',
    blue: '#1E3A5F',
    white: '#FFFFFF',
    lightGray: '#F5F6FA',
    green: '#10B981',
    orange: '#F59E0B',
    gray: '#6B7280'
  };
  const YARD_TYPES = [{
    id: 'front',
    label: 'Front Yard'
  }, {
    id: 'back',
    label: 'Back Yard'
  }, {
    id: 'staging',
    label: 'Staging Area'
  }, {
    id: 'overflow',
    label: 'Overflow'
  }, {
    id: 'other',
    label: 'Other'
  }];

  // Data loading
  useEffect(() => {
    loadData();
    return () => {
      if (window.MODA_YARD_MAP_DATA?.YardMapRealtime) {
        window.MODA_YARD_MAP_DATA.YardMapRealtime.unsubscribeAll();
      }
    };
  }, []);
  const loadData = async () => {
    setIsLoading(true);
    try {
      const data = window.MODA_YARD_MAP_DATA;
      if (!data?.isAvailable?.()) throw new Error('Yard Map data layer not available');
      const mapsData = await data.YardMapData.getYardMaps();
      setYardMaps(mapsData || []);
      const settingsData = await data.YardSettingsData.get();
      setSettings({
        defaultFontSize: settingsData.default_font_size || 14,
        defaultYardMapId: settingsData.default_yard_map_id
      });
      const queueData = await data.TransportStatusData.getReadyForYardQueue();
      setTransportQueue(queueData || []);
      if (settingsData.default_yard_map_id) {
        const defaultMap = mapsData?.find(m => m.id === settingsData.default_yard_map_id);
        if (defaultMap) await selectYardMap(defaultMap);
      }
    } catch (err) {
      console.error('[YardMapV2] Error:', err);
      setError('Failed to load yard map data');
    } finally {
      setIsLoading(false);
    }
  };
  const selectYardMap = async yardMap => {
    setSelectedYardMap(yardMap);
    setSelectedModule(null);
    setIsDrawMode(false);
    setSelectedQueueItem(null);
    try {
      const data = window.MODA_YARD_MAP_DATA;
      const fullMap = await data.YardMapData.getYardMap(yardMap.id);
      if (fullMap?.pdf_data) await loadPdfImage(fullMap.pdf_data);else setPdfImage(null);
      const modulesData = await data.YardModuleData.getModules(yardMap.id);
      setModules(modulesData || []);
      const statsData = await data.YardModuleData.getStats(yardMap.id);
      setStats(statsData);
      setupRealtimeSubscription(yardMap.id);
    } catch (err) {
      console.error('[YardMapV2] Error:', err);
      setError('Failed to load yard map');
    }
  };
  const loadPdfImage = async pdfData => {
    try {
      if (!window.pdfjsLib) {
        setPdfImage(null);
        return;
      }
      const base64 = pdfData.replace(/^data:application\/pdf;base64,/, '');
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const pdf = await window.pdfjsLib.getDocument({
        data: bytes
      }).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({
        scale: 2
      });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({
        canvasContext: canvas.getContext('2d'),
        viewport
      }).promise;
      const img = new Image();
      img.src = canvas.toDataURL();
      await new Promise(resolve => {
        img.onload = resolve;
      });
      setPdfImage(img);
    } catch (err) {
      console.error('[YardMapV2] PDF error:', err);
      setPdfImage(null);
    }
  };
  const setupRealtimeSubscription = yardMapId => {
    const data = window.MODA_YARD_MAP_DATA;
    if (!data?.YardMapRealtime) return;
    data.YardMapRealtime.subscribeToYardModules(yardMapId, payload => {
      if (payload.eventType === 'INSERT') setModules(prev => [...prev, payload.new]);else if (payload.eventType === 'UPDATE') {
        setModules(prev => prev.map(m => m.id === payload.new.id ? payload.new : m));
        if (payload.new.status === 'shipped_pending') {
          setShippedModule(payload.new);
          setShowShippedModal(true);
        }
      } else if (payload.eventType === 'DELETE') {
        setModules(prev => prev.filter(m => m.id !== payload.old.id));
      }
      refreshStats();
    });
    data.YardMapRealtime.subscribeToTransportStatus(payload => {
      if (payload.new?.status === 'ready_for_yard') {
        setTransportQueue(prev => prev.find(q => q.module_blm === payload.new.module_blm) ? prev : [...prev, payload.new]);
      } else if (payload.new?.status === 'in_yard') {
        setTransportQueue(prev => prev.filter(q => q.module_blm !== payload.new.module_blm));
      } else if (payload.new?.status === 'shipped') {
        const module = modules.find(m => m.blm === payload.new.module_blm);
        if (module) {
          setShippedModule(module);
          setShowShippedModal(true);
        }
      }
    });
  };
  const refreshStats = async () => {
    if (!selectedYardMap) return;
    const statsData = await window.MODA_YARD_MAP_DATA.YardModuleData.getStats(selectedYardMap.id);
    setStats(statsData);
  };

  // Canvas rendering
  useEffect(() => {
    renderCanvas();
  }, [pdfImage, modules, selectedModule, zoom, pan, isDrawMode, drawingModule]);
  const zoomRef = useRef(zoom);
  useEffect(() => {
    zoomRef.current = zoom;
  }, [zoom]);
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const handleWheel = e => {
      e.preventDefault();
      setZoom(z => Math.max(0.1, Math.min(5, z * (e.deltaY > 0 ? 0.9 : 1.1))));
    };
    canvas.addEventListener('wheel', handleWheel, {
      passive: false
    });
    return () => canvas.removeEventListener('wheel', handleWheel);
  }, []);
  const renderCanvas = () => {
    const canvas = canvasRef.current;
    const container = containerRef.current;
    if (!canvas || !container) return;
    const ctx = canvas.getContext('2d');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    ctx.fillStyle = '#e5e7eb';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(pan.x, pan.y);
    ctx.scale(zoom, zoom);
    if (pdfImage) ctx.drawImage(pdfImage, 0, 0);else if (selectedYardMap) {
      ctx.fillStyle = '#f3f4f6';
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = '#9ca3af';
      ctx.font = '16px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('No PDF uploaded', 400, 300);
    }
    modules.filter(m => m.status !== 'removed').forEach(m => drawModule(ctx, m, m.id === selectedModule?.id));
    if (isDrawMode && drawingModule) {
      ctx.strokeStyle = drawingModule.color || COLORS.blue;
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(drawingModule.x, drawingModule.y, drawingModule.width, drawingModule.height);
      ctx.setLineDash([]);
    }
    ctx.restore();
  };
  const drawModule = (ctx, module, isSelected) => {
    const {
      x,
      y,
      width,
      height,
      rotation = 0,
      color,
      abbreviation,
      blm,
      text_size = 14,
      status
    } = module;
    ctx.save();
    ctx.translate(x + width / 2, y + height / 2);
    ctx.rotate(rotation * Math.PI / 180);
    ctx.translate(-width / 2, -height / 2);
    ctx.fillStyle = color + (status === 'shipped_kept' ? '40' : '60');
    ctx.fillRect(0, 0, width, height);
    ctx.strokeStyle = status === 'shipped_kept' ? COLORS.gray : color;
    ctx.lineWidth = isSelected ? 3 : 2;
    if (status === 'shipped_kept') ctx.setLineDash([5, 5]);
    ctx.strokeRect(0, 0, width, height);
    ctx.setLineDash([]);
    ctx.fillStyle = status === 'shipped_kept' ? COLORS.gray : color;
    ctx.font = `bold ${text_size}px Inter, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(abbreviation, width / 2, height / 2 - 8);
    ctx.font = `${text_size - 2}px Inter, sans-serif`;
    ctx.fillText(blm, width / 2, height / 2 + 10);
    ctx.restore();
    if (isSelected) {
      ctx.fillStyle = COLORS.blue;
      [[x, y], [x + width, y], [x, y + height], [x + width, y + height]].forEach(([cx, cy]) => ctx.fillRect(cx - 4, cy - 4, 8, 8));
      ctx.beginPath();
      ctx.arc(x + width / 2, y - 20, 6, 0, Math.PI * 2);
      ctx.fill();
    }
  };

  // Mouse handlers
  const getCanvasCoords = e => {
    const rect = canvasRef.current.getBoundingClientRect();
    return {
      x: (e.clientX - rect.left - pan.x) / zoom,
      y: (e.clientY - rect.top - pan.y) / zoom
    };
  };
  const findModuleAtPoint = pt => {
    for (let i = modules.length - 1; i >= 0; i--) {
      const m = modules[i];
      if (m.status !== 'removed' && pt.x >= m.x && pt.x <= m.x + m.width && pt.y >= m.y && pt.y <= m.y + m.height) return m;
    }
    return null;
  };
  const handleMouseDown = e => {
    const coords = getCanvasCoords(e);
    if (isDrawMode && selectedQueueItem) {
      setDrawStart(coords);
      setDrawingModule({
        x: coords.x,
        y: coords.y,
        width: 0,
        height: 0,
        color: selectedQueueItem.color || COLORS.blue
      });
      return;
    }
    const clicked = findModuleAtPoint(coords);
    if (clicked) {
      setSelectedModule(clicked);
      setIsDragging(true);
      setDragOffset({
        x: coords.x - clicked.x,
        y: coords.y - clicked.y
      });
    } else {
      setSelectedModule(null);
      setIsPanning(true);
      setPanStart({
        x: e.clientX - pan.x,
        y: e.clientY - pan.y
      });
    }
  };
  const handleMouseMove = e => {
    const coords = getCanvasCoords(e);
    if (isDrawMode && drawStart) {
      setDrawingModule(prev => ({
        ...prev,
        x: Math.min(drawStart.x, coords.x),
        y: Math.min(drawStart.y, coords.y),
        width: Math.abs(coords.x - drawStart.x),
        height: Math.abs(coords.y - drawStart.y)
      }));
    } else if (isPanning) {
      setPan({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
    } else if (isDragging && selectedModule) {
      setModules(prev => prev.map(m => m.id === selectedModule.id ? {
        ...m,
        x: coords.x - dragOffset.x,
        y: coords.y - dragOffset.y
      } : m));
      setSelectedModule(prev => ({
        ...prev,
        x: coords.x - dragOffset.x,
        y: coords.y - dragOffset.y
      }));
    }
  };
  const handleMouseUp = async () => {
    if (isDrawMode && drawStart && drawingModule?.width > 20 && drawingModule?.height > 20) {
      await createModuleFromQueue(drawingModule);
    }
    if (isDragging && selectedModule) {
      await window.MODA_YARD_MAP_DATA.YardModuleData.updateModuleWithHistory(selectedModule.id, {
        x: selectedModule.x,
        y: selectedModule.y
      }, 'moved');
    }
    setDrawStart(null);
    setDrawingModule(null);
    setIsDrawMode(false);
    setIsPanning(false);
    setIsDragging(false);
    setIsRotating(false);
    setIsResizing(false);
  };

  // Module operations
  const createModuleFromQueue = async drawData => {
    if (!selectedYardMap || !selectedQueueItem) return;
    const data = window.MODA_YARD_MAP_DATA;
    const project = projects.find(p => p.abbreviation === selectedQueueItem.abbreviation);
    try {
      const result = await data.YardModuleData.createModule({
        yard_map_id: selectedYardMap.id,
        blm: selectedQueueItem.module_blm,
        abbreviation: selectedQueueItem.abbreviation || project?.abbreviation || 'UNK',
        color: selectedQueueItem.color || project?.color || COLORS.blue,
        x: drawData.x,
        y: drawData.y,
        width: drawData.width,
        height: drawData.height,
        rotation: 0,
        text_size: settings.defaultFontSize
      });
      if (result) {
        setModules(prev => [...prev, result]);
        await data.TransportStatusData.markInYard(selectedQueueItem.module_blm, selectedYardMap.id);
        setTransportQueue(prev => prev.filter(q => q.id !== selectedQueueItem.id));
        setSelectedQueueItem(null);
        refreshStats();
      }
    } catch (err) {
      setError('Failed to place module');
    }
  };
  const deleteSelectedModule = async () => {
    if (!selectedModule || !confirm(`Delete ${selectedModule.blm}?`)) return;
    try {
      await window.MODA_YARD_MAP_DATA.YardModuleData.deleteModule(selectedModule.id);
      setModules(prev => prev.filter(m => m.id !== selectedModule.id));
      setSelectedModule(null);
      refreshStats();
    } catch (err) {
      setError('Failed to delete');
    }
  };

  // Shipped handlers
  const handleShippedRemove = async () => {
    if (!shippedModule) return;
    const data = window.MODA_YARD_MAP_DATA;
    await data.YardModuleData.confirmShippedRemove(shippedModule.id);
    await data.TransportStatusData.markDelivered(shippedModule.blm);
    setModules(prev => prev.filter(m => m.id !== shippedModule.id));
    setShowShippedModal(false);
    setShippedModule(null);
    refreshStats();
  };
  const handleShippedKeep = async () => {
    if (!shippedModule) return;
    await window.MODA_YARD_MAP_DATA.YardModuleData.confirmShippedKeep(shippedModule.id);
    setModules(prev => prev.map(m => m.id === shippedModule.id ? {
      ...m,
      status: 'shipped_kept'
    } : m));
    setShowShippedModal(false);
    setShippedModule(null);
    refreshStats();
  };

  // Yard map management
  const handleFileUpload = async e => {
    const file = e.target.files?.[0];
    if (!file?.type.includes('pdf') || file.size > 5 * 1024 * 1024 || !uploadForm.name) {
      alert('Invalid file or missing name');
      return;
    }
    setIsUploading(true);
    try {
      const base64 = await new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
      const result = await window.MODA_YARD_MAP_DATA.YardMapData.createYardMap({
        name: uploadForm.name,
        yard_type: uploadForm.yardType,
        pdf_data: base64
      });
      if (result) {
        setYardMaps(prev => [...prev, result]);
        setUploadForm({
          name: '',
          yardType: 'front'
        });
      }
    } catch (err) {
      alert('Upload failed');
    }
    setIsUploading(false);
    if (fileInputRef.current) fileInputRef.current.value = '';
  };
  const deleteYardMap = async id => {
    if (!confirm('Delete yard map?')) return;
    await window.MODA_YARD_MAP_DATA.YardMapData.deleteYardMap(id);
    setYardMaps(prev => prev.filter(m => m.id !== id));
    if (selectedYardMap?.id === id) {
      setSelectedYardMap(null);
      setModules([]);
      setPdfImage(null);
    }
  };
  const setAsDefault = async id => {
    await window.MODA_YARD_MAP_DATA.YardSettingsData.setDefaultYardMap(id);
    setSettings(prev => ({
      ...prev,
      defaultYardMapId: id
    }));
  };

  // Filtered modules
  const filteredModules = useMemo(() => {
    const term = searchTerm.toLowerCase();
    return modules.filter(m => m.status !== 'removed' && (!term || m.blm.toLowerCase().includes(term) || m.abbreviation.toLowerCase().includes(term)));
  }, [modules, searchTerm]);
  const styles = {
    btn: v => ({
      padding: '8px 16px',
      background: v === 'primary' ? COLORS.blue : v === 'danger' ? COLORS.red : v === 'success' ? COLORS.green : '#e5e7eb',
      color: v === 'secondary' ? '#333' : '#fff',
      border: 'none',
      borderRadius: '6px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '13px'
    }),
    input: {
      padding: '8px 12px',
      borderRadius: '6px',
      border: '1px solid #ddd',
      fontSize: '14px'
    }
  };
  if (isLoading) return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      height: '400px'
    }
  }, /*#__PURE__*/React.createElement("div", null, "Loading Yard Map..."));
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      height: '100%',
      minHeight: '600px',
      background: '#fff',
      borderRadius: '12px',
      overflow: 'hidden',
      ...(isFullscreen ? {
        position: 'fixed',
        inset: 0,
        zIndex: 9999
      } : {})
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      borderBottom: '1px solid #e5e7eb',
      background: '#fafafa',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex'
    }
  }, ['map', 'settings'].map(t => /*#__PURE__*/React.createElement("button", {
    key: t,
    onClick: () => setActiveTab(t),
    style: {
      padding: '12px 24px',
      border: 'none',
      background: activeTab === t ? '#fff' : 'transparent',
      color: activeTab === t ? COLORS.blue : '#666',
      fontWeight: '600',
      cursor: 'pointer',
      borderBottom: activeTab === t ? `3px solid ${COLORS.blue}` : '3px solid transparent'
    }
  }, t === 'map' ? 'Yard Map' : 'Settings'))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsFullscreen(!isFullscreen),
    style: {
      ...styles.btn(isFullscreen ? 'danger' : 'primary'),
      margin: '8px 16px'
    }
  }, isFullscreen ? 'Exit Fullscreen' : 'Fullscreen')), activeTab === 'map' && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flex: 1,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      display: 'flex',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '16px',
      padding: '12px 16px',
      borderBottom: '1px solid #e5e7eb',
      background: '#fafafa',
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("select", {
    value: selectedYardMap?.id || '',
    onChange: e => {
      const m = yardMaps.find(x => x.id === e.target.value);
      if (m) selectYardMap(m);
    },
    style: {
      ...styles.input,
      minWidth: '200px'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "-- Select Yard Map --"), yardMaps.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.name, " (", m.yard_type, ")", m.id === settings.defaultYardMapId ? ' (Default)' : ''))), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, "Zoom: ", Math.round(zoom * 100), "%"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setZoom(z => Math.min(5, z * 1.2)),
    style: styles.btn('secondary')
  }, "+"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setZoom(z => Math.max(0.1, z / 1.2)),
    style: styles.btn('secondary')
  }, "-"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setZoom(1);
      setPan({
        x: 0,
        y: 0
      });
    },
    style: styles.btn('secondary')
  }, "Reset"), isDrawMode && /*#__PURE__*/React.createElement("span", {
    style: {
      padding: '6px 12px',
      background: COLORS.green + '20',
      borderRadius: '6px',
      color: COLORS.green,
      fontWeight: '600'
    }
  }, "Draw Mode Active"), selectedModule && /*#__PURE__*/React.createElement("button", {
    onClick: deleteSelectedModule,
    style: styles.btn('danger')
  }, "Delete Selected")), /*#__PURE__*/React.createElement("div", {
    ref: containerRef,
    style: {
      flex: 1,
      position: 'relative',
      overflow: 'hidden',
      cursor: isDrawMode ? 'crosshair' : isPanning ? 'grabbing' : 'grab'
    }
  }, /*#__PURE__*/React.createElement("canvas", {
    ref: canvasRef,
    style: {
      display: 'block',
      width: '100%',
      height: '100%'
    },
    onMouseDown: handleMouseDown,
    onMouseMove: handleMouseMove,
    onMouseUp: handleMouseUp,
    onMouseLeave: handleMouseUp
  }), !selectedYardMap && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'absolute',
      inset: 0,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      background: 'rgba(255,255,255,0.9)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      color: '#666'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '18px',
      fontWeight: '600'
    }
  }, "No Yard Map Selected"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '14px'
    }
  }, "Select from dropdown or upload in Settings"))))), selectedYardMap && /*#__PURE__*/React.createElement("div", {
    style: {
      width: '320px',
      borderLeft: '1px solid #e5e7eb',
      display: 'flex',
      flexDirection: 'column',
      background: '#fafafa',
      overflowY: 'auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '16px',
      borderBottom: '1px solid #e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: '12px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: '700',
      color: COLORS.blue
    }
  }, "Transport Queue"), /*#__PURE__*/React.createElement("span", {
    style: {
      background: transportQueue.length ? COLORS.green : '#e5e7eb',
      color: transportQueue.length ? '#fff' : '#666',
      padding: '2px 8px',
      borderRadius: '12px',
      fontSize: '12px'
    }
  }, transportQueue.length)), transportQueue.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px',
      color: '#999',
      fontSize: '13px'
    }
  }, "No modules ready") : /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: '200px',
      overflowY: 'auto'
    }
  }, transportQueue.map(item => /*#__PURE__*/React.createElement("div", {
    key: item.id,
    onClick: () => {
      setSelectedQueueItem(item);
      setIsDrawMode(true);
    },
    style: {
      padding: '10px 12px',
      background: selectedQueueItem?.id === item.id ? COLORS.blue + '15' : '#fff',
      borderRadius: '6px',
      marginBottom: '6px',
      cursor: 'pointer',
      border: selectedQueueItem?.id === item.id ? `2px solid ${COLORS.blue}` : '1px solid #e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      fontSize: '13px',
      color: COLORS.blue
    }
  }, item.module_blm), selectedQueueItem?.id === item.id && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '11px',
      color: COLORS.green,
      marginTop: '4px',
      fontWeight: '600'
    }
  }, "Click & drag on map"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '16px',
      borderBottom: '1px solid #e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      color: COLORS.blue,
      marginBottom: '12px'
    }
  }, "Statistics"), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#fff',
      padding: '12px',
      borderRadius: '8px',
      border: '1px solid #e5e7eb'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: '#666'
    }
  }, "Total"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: '700',
      color: COLORS.blue
    }
  }, stats.total)), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '16px',
      fontSize: '12px',
      marginTop: '8px'
    }
  }, /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("span", {
    style: {
      color: COLORS.green
    }
  }, "Active:"), " ", stats.active), /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("span", {
    style: {
      color: COLORS.gray
    }
  }, "Shipped:"), " ", stats.shippedKept)))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '16px',
      flex: 1,
      display: 'flex',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      color: COLORS.blue,
      marginBottom: '12px'
    }
  }, "Module Log"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    style: {
      ...styles.input,
      width: '100%',
      marginBottom: '12px'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      overflowY: 'auto'
    }
  }, filteredModules.map(m => /*#__PURE__*/React.createElement("div", {
    key: m.id,
    onClick: () => setSelectedModule(m),
    style: {
      padding: '10px 12px',
      background: selectedModule?.id === m.id ? COLORS.blue + '15' : '#fff',
      borderRadius: '6px',
      marginBottom: '6px',
      cursor: 'pointer',
      border: selectedModule?.id === m.id ? `2px solid ${COLORS.blue}` : '1px solid #e5e7eb',
      opacity: m.status === 'shipped_kept' ? 0.7 : 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      fontSize: '13px',
      color: m.status === 'shipped_kept' ? COLORS.gray : m.color
    }
  }, m.abbreviation), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: '12px',
      color: '#666'
    }
  }, m.blm))), filteredModules.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px',
      color: '#999'
    }
  }, "No modules"))))), activeTab === 'settings' && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '24px',
      maxWidth: '800px',
      overflowY: 'auto'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: '0 0 24px 0',
      color: COLORS.blue
    }
  }, "Yard Map Settings"), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#fafafa',
      padding: '20px',
      borderRadius: '8px',
      marginBottom: '24px'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0'
    }
  }, "Upload New Yard Map"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: '16px',
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      marginBottom: '4px',
      fontWeight: '600',
      fontSize: '12px',
      color: '#666'
    }
  }, "Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: uploadForm.name,
    onChange: e => setUploadForm(p => ({
      ...p,
      name: e.target.value
    })),
    style: {
      ...styles.input,
      width: '100%'
    }
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      marginBottom: '4px',
      fontWeight: '600',
      fontSize: '12px',
      color: '#666'
    }
  }, "Type"), /*#__PURE__*/React.createElement("select", {
    value: uploadForm.yardType,
    onChange: e => setUploadForm(p => ({
      ...p,
      yardType: e.target.value
    })),
    style: {
      ...styles.input,
      width: '100%'
    }
  }, YARD_TYPES.map(t => /*#__PURE__*/React.createElement("option", {
    key: t.id,
    value: t.id
  }, t.label))))), /*#__PURE__*/React.createElement("input", {
    ref: fileInputRef,
    type: "file",
    accept: ".pdf",
    onChange: handleFileUpload,
    style: {
      display: 'none'
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => fileInputRef.current?.click(),
    disabled: isUploading || !uploadForm.name,
    style: {
      ...styles.btn('primary'),
      opacity: isUploading || !uploadForm.name ? 0.5 : 1
    }
  }, isUploading ? 'Uploading...' : 'Select PDF & Upload')), /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0'
    }
  }, "Existing Yard Maps"), yardMaps.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: '#999',
      background: '#fafafa',
      borderRadius: '8px'
    }
  }, "No yard maps") : /*#__PURE__*/React.createElement("table", {
    style: {
      width: '100%',
      borderCollapse: 'collapse'
    }
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    style: {
      background: COLORS.blue,
      color: '#fff'
    }
  }, /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'left'
    }
  }, "Name"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'left'
    }
  }, "Type"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'center'
    }
  }, "Default"), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '12px',
      textAlign: 'right'
    }
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, yardMaps.map((m, i) => /*#__PURE__*/React.createElement("tr", {
    key: m.id,
    style: {
      background: i % 2 === 0 ? '#fff' : '#fafafa'
    }
  }, /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      fontWeight: '600'
    }
  }, m.name), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px'
    }
  }, YARD_TYPES.find(t => t.id === m.yard_type)?.label || m.yard_type), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      textAlign: 'center'
    }
  }, m.id === settings.defaultYardMapId ? /*#__PURE__*/React.createElement("span", {
    style: {
      color: COLORS.green,
      fontWeight: '600'
    }
  }, "Default") : /*#__PURE__*/React.createElement("button", {
    onClick: () => setAsDefault(m.id),
    style: styles.btn('secondary')
  }, "Set Default")), /*#__PURE__*/React.createElement("td", {
    style: {
      padding: '12px',
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => deleteYardMap(m.id),
    style: styles.btn('danger')
  }, "Delete"))))))), showShippedModal && shippedModule && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 10000
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#fff',
      padding: '24px',
      borderRadius: '12px',
      maxWidth: '400px',
      width: '90%'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      margin: '0 0 16px 0',
      color: COLORS.blue
    }
  }, "Module Marked Shipped"), /*#__PURE__*/React.createElement("div", {
    style: {
      background: '#f0f0f0',
      padding: '12px',
      borderRadius: '8px',
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: '700',
      color: shippedModule.color
    }
  }, shippedModule.abbreviation), /*#__PURE__*/React.createElement("div", {
    style: {
      color: '#666'
    }
  }, shippedModule.blm)), /*#__PURE__*/React.createElement("p", {
    style: {
      color: '#666',
      marginBottom: '20px'
    }
  }, "Remove from yard map?"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '12px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleShippedRemove,
    style: {
      ...styles.btn('success'),
      flex: 1
    }
  }, "Yes, Remove"), /*#__PURE__*/React.createElement("button", {
    onClick: handleShippedKeep,
    style: {
      ...styles.btn('secondary'),
      flex: 1
    }
  }, "No, Keep")))), error && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      bottom: '20px',
      right: '20px',
      padding: '12px 20px',
      background: COLORS.red,
      color: '#fff',
      borderRadius: '8px'
    }
  }, error, /*#__PURE__*/React.createElement("button", {
    onClick: () => setError(null),
    style: {
      marginLeft: '12px',
      background: 'none',
      border: 'none',
      color: '#fff',
      cursor: 'pointer'
    }
  }, "X")));
};
window.YardMapV2 = YardMapV2;
})();


// ============================================================================
// FILE: TransportModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA TRANSPORTATION MODULE
// Extracted from App.jsx for better maintainability
// ============================================================================

// ============================================================================
// MODA TRANSPORTATION MODULE - AV STYLE
// ============================================================================

const COLORS = {
  red: '#E31B23',
  blue: '#1E3A5F',
  charcoal: '#1E3A5F',
  lightGray: '#F5F6FA',
  white: '#FFFFFF',
  success: '#10B981',
  warning: '#F59E0B',
  info: '#3B82F6'
};

// Transport Stage SVG Icons (black, 16x16)
const TransportIcon = ({
  type,
  size = 16,
  color = 'currentColor'
}) => {
  const icons = {
    ready: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M7,7H17V5H19V19H5V5H7V7M12,17V15H17V17H12M7,17V15H9V17H7M7,13V11H9V13H7M10,13V11H17V13H10Z"
    })),
    staged: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M12,3L2,12H5V20H19V12H22L12,3M12,8.75A2.25,2.25 0 0,1 14.25,11A2.25,2.25 0 0,1 12,13.25A2.25,2.25 0 0,1 9.75,11A2.25,2.25 0 0,1 12,8.75M12,15C14.67,15 20,16.34 20,19V20H4V19C4,16.34 9.33,15 12,15Z"
    })),
    scheduledTransit: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M19,4H5A2,2 0 0,0 3,6V18A2,2 0 0,0 5,20H19A2,2 0 0,0 21,18V6A2,2 0 0,0 19,4M19,18H5V8H19V18M17,10H7V12H17V10M15,14H7V16H15V14Z"
    })),
    scheduledShuttle: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4M18.32,5.68A10,10 0 0,0 12,2V4A8,8 0 0,1 18.32,5.68M20,12A8,8 0 0,1 12,20V22A10,10 0 0,0 22,12H20M5.68,18.32A8,8 0 0,1 4,12H2A10,10 0 0,0 5.68,18.32M12,20A8,8 0 0,1 5.68,18.32L4.27,19.73A10,10 0 0,0 12,22V20M18.32,18.32L19.73,19.73A10,10 0 0,0 22,12H20A8,8 0 0,1 18.32,18.32Z"
    })),
    inTransit: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5M19.5,9.5L21.46,12H17V9.5M6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5M20,8H17V4H3C1.89,4 1,4.89 1,6V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V12L20,8Z"
    })),
    arrived: /*#__PURE__*/React.createElement("svg", {
      width: size,
      height: size,
      viewBox: "0 0 24 24",
      fill: color
    }, /*#__PURE__*/React.createElement("path", {
      d: "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"
    }))
  };
  return /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'inline-flex',
      alignItems: 'center',
      verticalAlign: 'middle'
    }
  }, icons[type]);
};
const TRANSPORT_STAGES = [{
  id: 'readyForYard',
  label: 'Ready for Yard',
  color: '#6366F1',
  iconType: 'ready'
}, {
  id: 'stagedInYard',
  label: 'Staged in Yard',
  color: '#8B5CF6',
  iconType: 'staged'
}, {
  id: 'scheduledTransit',
  label: 'Scheduled for Transit',
  color: '#EC4899',
  iconType: 'scheduledTransit'
}, {
  id: 'scheduledShuttle',
  label: 'Scheduled for Shuttle',
  color: '#F97316',
  iconType: 'scheduledShuttle'
}, {
  id: 'inTransit',
  label: 'In-Transit',
  color: '#0EA5E9',
  iconType: 'inTransit'
}, {
  id: 'arrived',
  label: 'Arrived to Site',
  color: '#10B981',
  iconType: 'arrived'
}];
const DEFAULT_YARDS = [{
  id: 'front',
  name: 'Front Yard',
  address: 'Autovol Property - Main Entrance',
  isAutovol: true
}, {
  id: 'back',
  name: 'Back Yard',
  address: 'Autovol Property - Rear Lot',
  isAutovol: true
}, {
  id: 'northside',
  name: 'Northside',
  address: '',
  isAutovol: false
}, {
  id: 'cherry',
  name: 'Cherry',
  address: '',
  isAutovol: false
}, {
  id: 'barger',
  name: 'Barger',
  address: '',
  isAutovol: false
}, {
  id: 'westervelt',
  name: 'Westervelt',
  address: '',
  isAutovol: false
}, {
  id: 'transit',
  name: 'Transit',
  address: 'Temporary Hold',
  isAutovol: false
}];
const SAMPLE_COMPANIES = [];
const SAMPLE_MODULES = [];

// LocalStorage Keys
const STORAGE_KEYS = {
  modules: 'autovol_transport_modules',
  yards: 'autovol_transport_yards',
  companies: 'autovol_transport_companies'
};
function TransportApp() {
  const safeParseJSON = (str, fallback) => {
    if (str && str !== 'undefined' && str !== 'null') {
      try {
        return JSON.parse(str);
      } catch (e) {
        return fallback;
      }
    }
    return fallback;
  };
  const [activeView, setActiveView] = useState('board');
  const [modules, setModules] = useState([]);
  const [yards, setYards] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedModule, setSelectedModule] = useState(null);
  const [showAddYard, setShowAddYard] = useState(false);
  const [showAddCompany, setShowAddCompany] = useState(false);
  const [filterProject, setFilterProject] = useState('all');
  const [editingYard, setEditingYard] = useState(null);
  const [editingCompany, setEditingCompany] = useState(null);
  const [viewMode, setViewMode] = useState('table'); // 'table' or 'kanban'
  const [filterStage, setFilterStage] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('serialNumber');
  const [sortDir, setSortDir] = useState('asc');
  const [projectsList, setProjectsList] = useState([]); // For YardMap dropdown
  const [selectedModuleIds, setSelectedModuleIds] = useState(new Set()); // For bulk selection
  const [showBulkModal, setShowBulkModal] = useState(false); // Bulk update modal

  // Load data from Supabase on mount - pull modules from projects table
  useEffect(() => {
    const loadData = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[Transport] Loading data from Supabase...');

          // Load yards, companies, and projects
          const [yardsData, companiesData, projectsData] = await Promise.all([window.MODA_SUPABASE_DATA.transport.getYards(), window.MODA_SUPABASE_DATA.transport.getCompanies(), window.MODA_SUPABASE_DATA.projects.getAll()]);
          setYards(yardsData.length > 0 ? yardsData : safeParseJSON(localStorage.getItem(STORAGE_KEYS.yards), DEFAULT_YARDS));
          setCompanies(companiesData.length > 0 ? companiesData : safeParseJSON(localStorage.getItem(STORAGE_KEYS.companies), SAMPLE_COMPANIES));

          // Store projects for YardMap
          setProjectsList(projectsData || []);

          // Extract modules from projects and transform for transport board
          // All modules from projects are potential transport candidates
          const allModules = [];
          (projectsData || []).forEach(project => {
            const projectModules = project.modules || [];
            projectModules.forEach(mod => {
              // Spread mod first, then override with our mapped fields
              // This ensures our stage default takes precedence
              allModules.push({
                ...mod,
                // Spread first so our overrides take precedence
                id: mod.id || `${project.id}-${mod.serial_number || mod.serialNumber}`,
                blm: mod.blm_id || mod.hitchBLM || mod.serial_number || mod.serialNumber,
                serialNumber: mod.serial_number || mod.serialNumber,
                project: project.name,
                projectId: project.id,
                unitType: mod.unit_type || mod.hitchUnit,
                // Default stage is 'readyForYard' - only use transport_stage if explicitly set
                stage: mod.transport_stage || 'readyForYard',
                yardId: mod.yard_id || null,
                transportCompanyId: mod.transport_company_id || null,
                scheduledDate: mod.scheduled_transport_date || null,
                // Map BLM fields - support both snake_case and camelCase
                hitchBLM: mod.hitchBLM || mod.hitch_blm || mod.hitch_blm_id || '',
                rearBLM: mod.rearBLM || mod.rear_blm || mod.rear_blm_id || ''
              });
            });
          });
          setModules(allModules);
          console.log('[Transport] Loaded from projects:', allModules.length, 'modules,', yardsData.length, 'yards,', companiesData.length, 'companies');
        } else {
          console.log('[Transport] Supabase not available, using localStorage');
          setModules(safeParseJSON(localStorage.getItem(STORAGE_KEYS.modules), SAMPLE_MODULES));
          setYards(safeParseJSON(localStorage.getItem(STORAGE_KEYS.yards), DEFAULT_YARDS));
          setCompanies(safeParseJSON(localStorage.getItem(STORAGE_KEYS.companies), SAMPLE_COMPANIES));
        }
      } catch (error) {
        console.error('[Transport] Error loading data:', error);
        setModules(safeParseJSON(localStorage.getItem(STORAGE_KEYS.modules), SAMPLE_MODULES));
        setYards(safeParseJSON(localStorage.getItem(STORAGE_KEYS.yards), DEFAULT_YARDS));
        setCompanies(safeParseJSON(localStorage.getItem(STORAGE_KEYS.companies), SAMPLE_COMPANIES));
      } finally {
        setIsLoading(false);
      }
    };
    const timer = setTimeout(loadData, 500);
    return () => clearTimeout(timer);
  }, []);

  // Save to localStorage as backup
  useEffect(() => {
    if (!isLoading) localStorage.setItem(STORAGE_KEYS.modules, JSON.stringify(modules));
  }, [modules, isLoading]);
  useEffect(() => {
    if (!isLoading) localStorage.setItem(STORAGE_KEYS.yards, JSON.stringify(yards));
  }, [yards, isLoading]);
  useEffect(() => {
    if (!isLoading) localStorage.setItem(STORAGE_KEYS.companies, JSON.stringify(companies));
  }, [companies, isLoading]);

  // Sync from unified layer - import modules marked "Ready for Yard" from Station Board
  useEffect(() => {
    const syncFromUnified = () => {
      if (typeof MODA_UNIFIED === 'undefined') return;

      // Get modules in YARD phase (production complete, waiting in staging yard)
      const yardModules = MODA_UNIFIED.getByPhase('yard');
      // Also get modules in transport phase (already scheduled)
      const transportModules = MODA_UNIFIED.getByPhase('transport');
      const allTransportModules = [...yardModules, ...transportModules];

      // Check for modules not yet in our transport list
      allTransportModules.forEach(unified => {
        const existsInTransport = modules.some(m => m.moduleId === unified.serialNumber || m.id === unified.id);
        if (!existsInTransport) {
          console.log(`[Transport] Auto-importing ${unified.serialNumber} from Station Board (phase: ${unified.currentPhase})`);
          setModules(prev => [...prev, {
            id: unified.id,
            moduleId: unified.serialNumber,
            blm: unified.specs?.blmHitch || '',
            project: unified.projectName || 'Unknown',
            projectAbbreviation: unified.projectAbbreviation || null,
            stage: 'ready',
            yardId: null,
            transportCompanyId: null,
            scheduledDate: null,
            notes: `Auto-imported from Station Board on ${new Date().toLocaleDateString()}`,
            importedAt: new Date().toISOString()
          }]);
        }
      });
    };

    // Run sync on mount and periodically
    syncFromUnified();
    const interval = setInterval(syncFromUnified, 10000); // Check every 10 seconds
    return () => clearInterval(interval);
  }, [modules]);
  const projects = [...new Set(modules.map(m => m.project))];
  const filteredModules = filterProject === 'all' ? modules : modules.filter(m => m.project === filterProject);
  const modulesByStage = TRANSPORT_STAGES.reduce((acc, stage) => {
    acc[stage.id] = filteredModules.filter(m => m.stage === stage.id);
    return acc;
  }, {});
  const updateModuleStage = (moduleId, newStage, additionalData = {}) => {
    setModules(prev => prev.map(m => {
      if (m.id === moduleId) {
        const {
          stage: oldStage,
          ...dataWithoutStage
        } = additionalData;
        const updated = {
          ...m,
          ...dataWithoutStage,
          stage: newStage
        };
        if (newStage === 'inTransit') updated.departureTime = new Date().toISOString();
        if (newStage === 'arrived') updated.arrivalTime = new Date().toISOString();
        return updated;
      }
      return m;
    }));
    setSelectedModule(null);
  };
  const addYard = yard => {
    setYards(prev => [...prev, {
      ...yard,
      id: `yard-${Date.now()}`
    }]);
    setShowAddYard(false);
  };
  const updateYard = (yardId, updates) => {
    setYards(prev => prev.map(y => y.id === yardId ? {
      ...y,
      ...updates
    } : y));
    setEditingYard(null);
  };
  const deleteYard = yardId => {
    if (modules.some(m => m.yardId === yardId)) {
      alert('Cannot delete yard with modules staged there. Move modules first.');
      return;
    }
    setYards(prev => prev.filter(y => y.id !== yardId));
  };
  const addCompany = company => {
    setCompanies(prev => [...prev, {
      ...company,
      id: `tc-${Date.now()}`
    }]);
    setShowAddCompany(false);
  };
  const updateCompany = (companyId, updates) => {
    setCompanies(prev => prev.map(c => c.id === companyId ? {
      ...c,
      ...updates
    } : c));
    setEditingCompany(null);
  };
  const deleteCompany = companyId => {
    if (modules.some(m => m.transportCompanyId === companyId)) {
      alert('Cannot delete company with assigned modules. Reassign modules first.');
      return;
    }
    setCompanies(prev => prev.filter(c => c.id !== companyId));
  };
  const getCompanyName = id => companies.find(c => c.id === id)?.name || 'Unassigned';
  const getYardName = id => yards.find(y => y.id === id)?.name || 'Not Staged';

  // Bulk selection helpers
  const toggleModuleSelection = moduleId => {
    setSelectedModuleIds(prev => {
      const next = new Set(prev);
      if (next.has(moduleId)) next.delete(moduleId);else next.add(moduleId);
      return next;
    });
  };
  const selectAllFiltered = () => {
    setSelectedModuleIds(new Set(filteredModules.map(m => m.id)));
  };
  const clearSelection = () => {
    setSelectedModuleIds(new Set());
  };

  // Bulk update - update stage and yard for selected modules
  const bulkUpdateModules = async (newStage, yardId) => {
    const selectedIds = Array.from(selectedModuleIds);
    if (selectedIds.length === 0) return;

    // Update local state
    setModules(prev => prev.map(m => {
      if (selectedIds.includes(m.id)) {
        return {
          ...m,
          stage: newStage,
          yardId: yardId || m.yardId
        };
      }
      return m;
    }));

    // Sync to Supabase - update modules in projects table
    if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
      try {
        // Group modules by project
        const modulesByProject = {};
        modules.filter(m => selectedIds.includes(m.id)).forEach(m => {
          if (!modulesByProject[m.projectId]) modulesByProject[m.projectId] = [];
          modulesByProject[m.projectId].push(m);
        });

        // Update each project's modules array
        for (const [projectId, projectModules] of Object.entries(modulesByProject)) {
          const project = projectsList.find(p => p.id === projectId);
          if (!project) continue;
          const updatedModules = (project.modules || []).map(mod => {
            const serial = mod.serial_number || mod.serialNumber;
            const matchingMod = projectModules.find(pm => pm.serialNumber === serial || pm.serial_number === serial);
            if (matchingMod) {
              return {
                ...mod,
                transport_stage: newStage,
                yard_id: yardId
              };
            }
            return mod;
          });
          await window.MODA_SUPABASE_DATA.projects.update(projectId, {
            modules: updatedModules
          });
        }
        console.log('[Transport] Bulk updated', selectedIds.length, 'modules to', newStage);
      } catch (err) {
        console.error('[Transport] Bulk update to Supabase failed:', err);
      }
    }
    clearSelection();
    setShowBulkModal(false);
  };

  // ============================================================================
  // STYLES - AV BRANDED
  // ============================================================================

  const styles = {
    header: {
      background: COLORS.charcoal,
      padding: '12px 32px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      borderBottom: `4px solid ${COLORS.red}`,
      position: 'sticky',
      top: 0,
      zIndex: 100
    },
    logo: {
      display: 'flex',
      alignItems: 'center',
      gap: '12px'
    },
    logoIcon: {
      width: '44px',
      height: '44px',
      background: `linear-gradient(135deg, ${COLORS.red} 0%, ${COLORS.blue} 100%)`,
      borderRadius: '10px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: COLORS.white,
      fontWeight: '800',
      fontSize: '20px',
      fontFamily: "'Inter', sans-serif"
    },
    nav: {
      display: 'flex',
      gap: '4px',
      background: 'rgba(255,255,255,0.1)',
      padding: '4px',
      borderRadius: '8px'
    },
    navBtn: active => ({
      padding: '10px 22px',
      background: active ? COLORS.blue : 'transparent',
      color: active ? COLORS.white : 'rgba(255,255,255,0.7)',
      border: 'none',
      borderRadius: '6px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '13px',
      fontFamily: "'Inter', sans-serif",
      transition: 'all 0.2s ease'
    }),
    main: {
      padding: '24px 32px',
      maxWidth: '1800px',
      margin: '0 auto'
    },
    statsBar: {
      display: 'flex',
      gap: '12px',
      marginBottom: '20px'
    },
    statCard: color => ({
      padding: '14px 22px',
      background: COLORS.white,
      borderRadius: '10px',
      borderLeft: `4px solid ${color}`,
      display: 'flex',
      alignItems: 'center',
      gap: '14px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
    }),
    boardContainer: {
      display: 'grid',
      gridTemplateColumns: 'repeat(6, 1fr)',
      gap: '16px',
      alignItems: 'start'
    },
    stageColumn: {
      background: COLORS.white,
      borderRadius: '10px',
      overflow: 'hidden',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
    },
    stageHeader: color => ({
      padding: '14px 16px',
      background: color,
      color: COLORS.white,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }),
    stageBody: {
      padding: '12px',
      maxHeight: '600px',
      overflowY: 'auto'
    },
    moduleCard: {
      background: COLORS.lightGray,
      borderRadius: '8px',
      padding: '14px',
      marginBottom: '10px',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      borderLeft: '3px solid transparent'
    },
    btn: (variant = 'primary') => ({
      padding: '10px 18px',
      background: variant === 'primary' ? COLORS.blue : variant === 'danger' ? COLORS.red : COLORS.lightGray,
      color: variant === 'secondary' ? COLORS.charcoal : COLORS.white,
      border: 'none',
      borderRadius: '6px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '13px',
      fontFamily: "'Inter', sans-serif",
      transition: 'all 0.2s ease'
    }),
    table: {
      width: '100%',
      borderCollapse: 'collapse',
      background: COLORS.white,
      borderRadius: '10px',
      overflow: 'hidden',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)'
    },
    th: {
      padding: '14px 16px',
      textAlign: 'left',
      background: COLORS.charcoal,
      color: COLORS.white,
      fontWeight: '600',
      fontSize: '13px',
      fontFamily: "'Inter', sans-serif"
    },
    td: {
      padding: '14px 16px',
      borderBottom: '1px solid #eee',
      fontSize: '13px',
      fontFamily: "'Inter', sans-serif",
      color: COLORS.charcoal
    },
    modal: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(45, 52, 54, 0.6)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    },
    modalContent: {
      background: COLORS.white,
      borderRadius: '12px',
      width: '100%',
      maxWidth: '560px',
      maxHeight: '85vh',
      overflow: 'auto',
      boxShadow: '0 25px 60px rgba(0,0,0,0.3)',
      borderTop: `4px solid ${COLORS.blue}`
    },
    modalHeader: {
      padding: '20px 24px',
      borderBottom: '1px solid #eee',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    },
    modalBody: {
      padding: '24px'
    },
    input: {
      width: '100%',
      padding: '12px 14px',
      borderRadius: '6px',
      border: '1px solid #ddd',
      fontSize: '14px',
      fontFamily: "'Inter', sans-serif",
      boxSizing: 'border-box',
      transition: 'all 0.2s ease'
    },
    label: {
      display: 'block',
      marginBottom: '6px',
      fontWeight: '600',
      fontSize: '13px',
      color: COLORS.charcoal,
      fontFamily: "'Inter', sans-serif"
    },
    fieldGroup: {
      marginBottom: '16px'
    }
  };

  // ============================================================================
  // COMPONENTS
  // ============================================================================

  const ModuleCard = ({
    module
  }) => {
    const [hovered, setHovered] = useState(false);
    return /*#__PURE__*/React.createElement("div", {
      onClick: () => setSelectedModule(module),
      onMouseEnter: () => setHovered(true),
      onMouseLeave: () => setHovered(false),
      style: {
        ...styles.moduleCard,
        background: hovered ? '#e8eaed' : COLORS.lightGray,
        borderLeftColor: hovered ? COLORS.blue : 'transparent',
        transform: hovered ? 'translateX(3px)' : 'none',
        boxShadow: hovered ? '0 2px 8px rgba(0,87,184,0.1)' : 'none'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'start',
        marginBottom: '6px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: '700',
        fontSize: '14px',
        color: COLORS.charcoal,
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.moduleId), module.scheduledDate && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '11px',
        color: COLORS.red,
        fontWeight: '600'
      }
    }, new Date(module.scheduledDate).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '12px',
        color: '#666',
        marginBottom: '4px',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.blm), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '12px',
        color: COLORS.blue,
        fontWeight: '600',
        display: 'flex',
        alignItems: 'center',
        gap: '6px'
      }
    }, module.projectAbbreviation && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '10px',
        padding: '1px 5px',
        background: '#e0f2fe',
        color: '#0369a1',
        borderRadius: '3px',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.projectAbbreviation), module.project), module.yardId && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#888',
        marginTop: '8px'
      }
    }, "\uD83D\uDCCB\x8D ", getYardName(module.yardId)), module.transportCompanyId && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#888'
      }
    }, "\uD83D\uDE9B ", getCompanyName(module.transportCompanyId)));
  };
  const StageColumn = ({
    stage,
    modules
  }) => /*#__PURE__*/React.createElement("div", {
    style: styles.stageColumn
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.stageHeader(stage.color)
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      fontWeight: '700',
      fontSize: '13px'
    }
  }, /*#__PURE__*/React.createElement(TransportIcon, {
    type: stage.iconType,
    color: "white"
  }), " ", stage.label), /*#__PURE__*/React.createElement("span", {
    style: {
      background: 'rgba(255,255,255,0.25)',
      padding: '3px 12px',
      borderRadius: '12px',
      fontSize: '12px',
      fontWeight: '700'
    }
  }, modules.length)), /*#__PURE__*/React.createElement("div", {
    style: styles.stageBody
  }, modules.map(m => /*#__PURE__*/React.createElement(ModuleCard, {
    key: m.id,
    module: m
  })), modules.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '30px 10px',
      color: '#999',
      fontSize: '12px'
    }
  }, "No modules")));
  const MobileBoardView = () => {
    const [currentStageIndex, setCurrentStageIndex] = useState(0);
    const [isAnimating, setIsAnimating] = useState(false);
    const [slideDirection, setSlideDirection] = useState(null);
    const touchStartX = React.useRef(0);
    const touchEndX = React.useRef(0);
    const currentStage = TRANSPORT_STAGES[currentStageIndex];
    const stageModules = modulesByStage[currentStage.id] || [];

    // Navigate with smooth animation
    const navigateTo = (newIndex, direction) => {
      if (isAnimating || newIndex < 0 || newIndex >= TRANSPORT_STAGES.length) return;
      setIsAnimating(true);
      setSlideDirection(direction);
      setTimeout(() => {
        setCurrentStageIndex(newIndex);
        setSlideDirection(null);
        setIsAnimating(false);
      }, 150);
    };
    const handleTouchStart = e => {
      touchStartX.current = e.touches[0].clientX;
      touchEndX.current = e.touches[0].clientX;
    };
    const handleTouchMove = e => {
      touchEndX.current = e.touches[0].clientX;
    };
    const handleTouchEnd = () => {
      const swipeDistance = touchStartX.current - touchEndX.current;
      if (swipeDistance > 50 && currentStageIndex < TRANSPORT_STAGES.length - 1) {
        navigateTo(currentStageIndex + 1, 'left');
      } else if (swipeDistance < -50 && currentStageIndex > 0) {
        navigateTo(currentStageIndex - 1, 'right');
      }
    };
    const goToPrevious = () => navigateTo(currentStageIndex - 1, 'right');
    const goToNext = () => navigateTo(currentStageIndex + 1, 'left');

    // Animation styles
    const getSlideStyle = () => {
      if (slideDirection === 'left') return {
        opacity: 0,
        transform: 'translateX(-20px)',
        transition: 'all 0.15s ease-out'
      };
      if (slideDirection === 'right') return {
        opacity: 0,
        transform: 'translateX(20px)',
        transition: 'all 0.15s ease-out'
      };
      return {
        opacity: 1,
        transform: 'translateX(0)',
        transition: 'all 0.15s ease-out'
      };
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "mobile-transport-board"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '4px',
        overflowX: 'auto',
        paddingBottom: '8px',
        marginBottom: '12px',
        WebkitOverflowScrolling: 'touch'
      }
    }, TRANSPORT_STAGES.map((stage, idx) => /*#__PURE__*/React.createElement("button", {
      key: stage.id,
      onClick: () => !isAnimating && setCurrentStageIndex(idx),
      style: {
        flexShrink: 0,
        padding: '10px 14px',
        borderRadius: '20px',
        border: 'none',
        fontSize: '12px',
        fontWeight: '600',
        cursor: 'pointer',
        background: idx === currentStageIndex ? stage.color : '#e5e7eb',
        color: idx === currentStageIndex ? 'white' : '#666',
        transition: 'all 0.2s ease'
      }
    }, stage.label, " (", (modulesByStage[stage.id] || []).length, ")"))), /*#__PURE__*/React.createElement("div", {
      onTouchStart: handleTouchStart,
      onTouchMove: handleTouchMove,
      onTouchEnd: handleTouchEnd,
      style: {
        touchAction: 'pan-y',
        ...getSlideStyle()
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        background: currentStage.color,
        color: 'white',
        padding: '16px',
        borderRadius: '12px 12px 0 0'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '8px'
      }
    }, /*#__PURE__*/React.createElement(TransportIcon, {
      type: currentStage.iconType,
      color: "white"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: '700',
        fontSize: '16px'
      }
    }, currentStage.label)), /*#__PURE__*/React.createElement("span", {
      style: {
        background: 'rgba(255,255,255,0.25)',
        padding: '4px 12px',
        borderRadius: '12px',
        fontWeight: '700'
      }
    }, stageModules.length)), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '12px',
        opacity: 0.8,
        marginTop: '4px'
      }
    }, currentStageIndex + 1, " of ", TRANSPORT_STAGES.length, " \u2022 Swipe or use arrows")), /*#__PURE__*/React.createElement("div", {
      style: {
        background: 'white',
        border: '1px solid #e5e7eb',
        borderTop: 'none',
        borderRadius: '0 0 12px 12px',
        padding: '12px',
        maxHeight: '400px',
        overflowY: 'auto',
        WebkitOverflowScrolling: 'touch'
      }
    }, stageModules.length === 0 ? /*#__PURE__*/React.createElement("div", {
      style: {
        textAlign: 'center',
        padding: '32px',
        color: '#999'
      }
    }, "No modules in this stage") : stageModules.map(module => /*#__PURE__*/React.createElement("div", {
      key: module.id,
      onClick: () => setSelectedModule(module),
      style: {
        padding: '12px',
        marginBottom: '8px',
        background: '#f8f9fa',
        borderRadius: '8px',
        borderLeft: `4px solid ${currentStage.color}`,
        cursor: 'pointer'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        marginBottom: '4px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: '700',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.moduleId), module.scheduledDate && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '11px',
        color: COLORS.red,
        fontWeight: '600'
      }
    }, new Date(module.scheduledDate).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '12px',
        color: COLORS.blue,
        fontWeight: '600',
        display: 'flex',
        alignItems: 'center',
        gap: '6px'
      }
    }, module.projectAbbreviation && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '10px',
        padding: '1px 5px',
        background: '#e0f2fe',
        color: '#0369a1',
        borderRadius: '3px',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.projectAbbreviation), module.project), module.transportCompanyId && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#888',
        marginTop: '4px'
      }
    }, "Carrier: ", getCompanyName(module.transportCompanyId)))))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px',
        marginTop: '12px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: goToPrevious,
      disabled: currentStageIndex === 0 || isAnimating,
      style: {
        flex: 1,
        padding: '14px 16px',
        borderRadius: '10px',
        border: 'none',
        fontWeight: '600',
        fontSize: '14px',
        cursor: currentStageIndex === 0 ? 'not-allowed' : 'pointer',
        background: currentStageIndex === 0 ? '#e5e7eb' : COLORS.charcoal,
        color: currentStageIndex === 0 ? '#999' : 'white',
        transition: 'all 0.2s ease',
        minHeight: '48px'
      }
    }, "Previous"), /*#__PURE__*/React.createElement("button", {
      onClick: goToNext,
      disabled: currentStageIndex === TRANSPORT_STAGES.length - 1 || isAnimating,
      style: {
        flex: 1,
        padding: '14px 16px',
        borderRadius: '10px',
        border: 'none',
        fontWeight: '600',
        fontSize: '14px',
        cursor: currentStageIndex === TRANSPORT_STAGES.length - 1 ? 'not-allowed' : 'pointer',
        background: currentStageIndex === TRANSPORT_STAGES.length - 1 ? '#e5e7eb' : COLORS.charcoal,
        color: currentStageIndex === TRANSPORT_STAGES.length - 1 ? '#999' : 'white',
        transition: 'all 0.2s ease',
        minHeight: '48px'
      }
    }, "Next")));
  };
  const BoardView = () => {
    // Mobile detection
    const isMobile = window.useIsMobile ? window.useIsMobile(768) : window.innerWidth < 768;

    // Filter and sort modules for table view
    const getFilteredModules = () => {
      let filtered = [...modules];

      // Project filter
      if (filterProject !== 'all') {
        filtered = filtered.filter(m => m.project === filterProject);
      }

      // Stage filter
      if (filterStage !== 'all') {
        filtered = filtered.filter(m => m.stage === filterStage);
      }

      // Search filter
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(m => m.blm?.toLowerCase().includes(term) || m.project?.toLowerCase().includes(term) || m.serialNumber?.toLowerCase().includes(term));
      }

      // Sort
      filtered.sort((a, b) => {
        let aVal = a[sortBy] || '';
        let bVal = b[sortBy] || '';
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });
      return filtered;
    };
    const handleSort = field => {
      if (sortBy === field) {
        setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
      } else {
        setSortBy(field);
        setSortDir('asc');
      }
    };
    const getStageName = stageId => {
      const stage = TRANSPORT_STAGES.find(s => s.id === stageId);
      return stage ? stage.label : stageId;
    };
    const getStageColor = stageId => {
      const stage = TRANSPORT_STAGES.find(s => s.id === stageId);
      return stage ? stage.color : '#999';
    };
    const filteredModules = getFilteredModules();
    if (isMobile) {
      return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
        style: {
          marginBottom: '16px'
        }
      }, /*#__PURE__*/React.createElement("select", {
        value: filterProject,
        onChange: e => setFilterProject(e.target.value),
        style: {
          ...styles.input,
          width: '100%'
        }
      }, /*#__PURE__*/React.createElement("option", {
        value: "all"
      }, "All Projects (", modules.length, " modules)"), projects.map(p => /*#__PURE__*/React.createElement("option", {
        key: p,
        value: p
      }, p, " (", modules.filter(m => m.project === p).length, ")")))), /*#__PURE__*/React.createElement(MobileBoardView, null));
    }
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '16px',
        flexWrap: 'wrap',
        gap: '12px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        background: '#e5e7eb',
        borderRadius: '6px',
        padding: '2px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setViewMode('table'),
      style: {
        padding: '6px 14px',
        border: 'none',
        borderRadius: '4px',
        background: viewMode === 'table' ? COLORS.blue : 'transparent',
        color: viewMode === 'table' ? COLORS.white : '#666',
        fontWeight: '600',
        fontSize: '12px',
        cursor: 'pointer'
      }
    }, "Table"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setViewMode('kanban'),
      style: {
        padding: '6px 14px',
        border: 'none',
        borderRadius: '4px',
        background: viewMode === 'kanban' ? COLORS.blue : 'transparent',
        color: viewMode === 'kanban' ? COLORS.white : '#666',
        fontWeight: '600',
        fontSize: '12px',
        cursor: 'pointer'
      }
    }, "Board")), /*#__PURE__*/React.createElement("select", {
      value: filterProject,
      onChange: e => setFilterProject(e.target.value),
      style: {
        ...styles.input,
        width: '200px'
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: "all"
    }, "All Projects (", modules.length, ")"), projects.map(p => /*#__PURE__*/React.createElement("option", {
      key: p,
      value: p
    }, p, " (", modules.filter(m => m.project === p).length, ")"))), viewMode === 'table' && /*#__PURE__*/React.createElement("select", {
      value: filterStage,
      onChange: e => setFilterStage(e.target.value),
      style: {
        ...styles.input,
        width: '180px'
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: "all"
    }, "All Stages"), TRANSPORT_STAGES.map(s => /*#__PURE__*/React.createElement("option", {
      key: s.id,
      value: s.id
    }, s.label))), viewMode === 'table' && /*#__PURE__*/React.createElement("input", {
      type: "text",
      placeholder: "Search modules...",
      value: searchTerm,
      onChange: e => setSearchTerm(e.target.value),
      style: {
        ...styles.input,
        width: '180px'
      }
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.statsBar
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.statCard(COLORS.info)
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '24px',
        fontWeight: '700',
        color: COLORS.info
      }
    }, modules.filter(m => m.stage === 'inTransit').length), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '11px',
        color: '#666',
        fontWeight: '500'
      }
    }, "In Transit")), /*#__PURE__*/React.createElement("div", {
      style: styles.statCard(COLORS.warning)
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '24px',
        fontWeight: '700',
        color: COLORS.warning
      }
    }, modules.filter(m => m.stage === 'scheduledTransit' || m.stage === 'scheduledShuttle').length), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '11px',
        color: '#666',
        fontWeight: '500'
      }
    }, "Scheduled")), /*#__PURE__*/React.createElement("div", {
      style: styles.statCard(COLORS.success)
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '24px',
        fontWeight: '700',
        color: COLORS.success
      }
    }, modules.filter(m => m.stage === 'arrived').length), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '11px',
        color: '#666',
        fontWeight: '500'
      }
    }, "Delivered")))), selectedModuleIds.size > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        background: COLORS.navy,
        color: COLORS.white,
        padding: '12px 20px',
        borderRadius: '8px',
        marginBottom: '16px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '16px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: '600'
      }
    }, selectedModuleIds.size, " module", selectedModuleIds.size !== 1 ? 's' : '', " selected"), /*#__PURE__*/React.createElement("button", {
      onClick: clearSelection,
      style: {
        background: 'transparent',
        border: '1px solid rgba(255,255,255,0.3)',
        color: COLORS.white,
        padding: '6px 12px',
        borderRadius: '4px',
        cursor: 'pointer',
        fontSize: '12px'
      }
    }, "Clear Selection")), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '8px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowBulkModal(true),
      style: {
        background: COLORS.teal,
        color: COLORS.white,
        border: 'none',
        padding: '8px 16px',
        borderRadius: '4px',
        cursor: 'pointer',
        fontWeight: '600',
        fontSize: '13px'
      }
    }, "Stage in Yard"))), viewMode === 'table' && /*#__PURE__*/React.createElement("div", {
      style: {
        background: COLORS.white,
        borderRadius: '8px',
        overflow: 'hidden',
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
      }
    }, /*#__PURE__*/React.createElement("table", {
      style: {
        ...styles.table,
        marginBottom: 0
      }
    }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        width: '40px'
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: filteredModules.length > 0 && filteredModules.every(m => selectedModuleIds.has(m.id)),
      onChange: e => e.target.checked ? selectAllFiltered() : clearSelection(),
      style: {
        cursor: 'pointer'
      }
    })), /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        cursor: 'pointer'
      },
      onClick: () => handleSort('serialNumber')
    }, "Serial No. ", sortBy === 'serialNumber' && (sortDir === 'asc' ? '↑' : '↓')), /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        cursor: 'pointer'
      },
      onClick: () => handleSort('project')
    }, "Project ", sortBy === 'project' && (sortDir === 'asc' ? '↑' : '↓')), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Hitch BLM"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Rear BLM"), /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        cursor: 'pointer'
      },
      onClick: () => handleSort('stage')
    }, "Stage ", sortBy === 'stage' && (sortDir === 'asc' ? '↑' : '↓')), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Yard"), /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        cursor: 'pointer'
      },
      onClick: () => handleSort('scheduledDate')
    }, "Scheduled ", sortBy === 'scheduledDate' && (sortDir === 'asc' ? '↑' : '↓')), /*#__PURE__*/React.createElement("th", {
      style: {
        ...styles.th,
        width: '80px'
      }
    }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, filteredModules.length === 0 ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
      colSpan: "9",
      style: {
        ...styles.td,
        textAlign: 'center',
        padding: '40px',
        color: '#999'
      }
    }, "No modules found matching your filters")) : filteredModules.map((module, idx) => {
      const yard = yards.find(y => y.id === module.yardId);
      const company = companies.find(c => c.id === module.transportCompanyId);
      return /*#__PURE__*/React.createElement("tr", {
        key: module.id,
        style: {
          background: selectedModuleIds.has(module.id) ? '#e0f2fe' : idx % 2 === 0 ? COLORS.white : '#fafafa'
        }
      }, /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, /*#__PURE__*/React.createElement("input", {
        type: "checkbox",
        checked: selectedModuleIds.has(module.id),
        onChange: () => toggleModuleSelection(module.id),
        style: {
          cursor: 'pointer'
        }
      })), /*#__PURE__*/React.createElement("td", {
        style: {
          ...styles.td,
          fontWeight: '600',
          color: COLORS.charcoal
        }
      }, module.serialNumber || module.serial_number), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, module.project), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, module.hitchBLM || '–'), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, module.rearBLM || '–'), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          background: getStageColor(module.stage) + '20',
          color: getStageColor(module.stage),
          padding: '4px 10px',
          borderRadius: '4px',
          fontSize: '11px',
          fontWeight: '600',
          whiteSpace: 'nowrap'
        }
      }, getStageName(module.stage))), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, yard?.name || '–'), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, module.scheduledDate || module.scheduled_transport_date ? new Date(module.scheduledDate || module.scheduled_transport_date).toLocaleDateString() : '–'), /*#__PURE__*/React.createElement("td", {
        style: styles.td
      }, /*#__PURE__*/React.createElement("button", {
        onClick: () => setSelectedModule(module),
        style: {
          ...styles.btn('secondary'),
          padding: '4px 10px',
          fontSize: '11px'
        }
      }, "Edit")));
    }))), filteredModules.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '12px 16px',
        borderTop: '1px solid #e5e7eb',
        background: '#fafafa',
        fontSize: '12px',
        color: '#666'
      }
    }, "Showing ", filteredModules.length, " of ", modules.length, " modules")), viewMode === 'kanban' && /*#__PURE__*/React.createElement("div", {
      style: styles.boardContainer
    }, TRANSPORT_STAGES.map(stage => /*#__PURE__*/React.createElement(StageColumn, {
      key: stage.id,
      stage: stage,
      modules: modulesByStage[stage.id]
    }))));
  };
  const YardsView = () => /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: 0,
      color: COLORS.charcoal,
      fontSize: '22px',
      fontWeight: '700'
    }
  }, "Staging Yards Directory"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddYard(true),
    style: styles.btn('primary'),
    onMouseOver: e => {
      e.target.style.transform = 'translateY(-2px)';
      e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
    },
    onMouseOut: e => {
      e.target.style.transform = 'none';
      e.target.style.boxShadow = 'none';
    }
  }, "+ Add Yard")), /*#__PURE__*/React.createElement("table", {
    style: styles.table
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Yard Name"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Address"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Type"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      textAlign: 'center'
    }
  }, "Modules Staged"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      width: '140px'
    }
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, yards.map((yard, idx) => {
    const moduleCount = modules.filter(m => m.yardId === yard.id).length;
    return /*#__PURE__*/React.createElement("tr", {
      key: yard.id,
      style: {
        background: idx % 2 === 0 ? COLORS.white : '#fafafa'
      }
    }, /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontWeight: '600',
        color: COLORS.charcoal
      }
    }, yard.name), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, yard.address || '–'), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, yard.isAutovol ? /*#__PURE__*/React.createElement("span", {
      style: {
        background: COLORS.red,
        color: COLORS.white,
        padding: '4px 12px',
        borderRadius: '4px',
        fontSize: '11px',
        fontWeight: '700'
      }
    }, "AUTOVOL") : /*#__PURE__*/React.createElement("span", {
      style: {
        color: '#666'
      }
    }, "External")), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        background: moduleCount > 0 ? COLORS.blue : '#eee',
        color: moduleCount > 0 ? COLORS.white : '#999',
        padding: '5px 16px',
        borderRadius: '14px',
        fontWeight: '700',
        fontSize: '13px'
      }
    }, moduleCount)), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '8px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingYard(yard),
      style: {
        ...styles.btn('secondary'),
        padding: '6px 12px'
      }
    }, "Edit"), /*#__PURE__*/React.createElement("button", {
      onClick: () => deleteYard(yard.id),
      style: {
        ...styles.btn('danger'),
        padding: '6px 12px'
      }
    }, "Delete"))));
  }))));
  const CompaniesView = () => /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      margin: 0,
      color: COLORS.charcoal,
      fontSize: '22px',
      fontWeight: '700'
    }
  }, "Transport Companies Directory"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddCompany(true),
    style: styles.btn('primary'),
    onMouseOver: e => {
      e.target.style.transform = 'translateY(-2px)';
      e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
    },
    onMouseOut: e => {
      e.target.style.transform = 'none';
      e.target.style.boxShadow = 'none';
    }
  }, "+ Add Company")), /*#__PURE__*/React.createElement("table", {
    style: styles.table
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Company Name"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Address"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Office Phone"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Contact"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Contact Phone"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      textAlign: 'center'
    }
  }, "Scheduled"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      textAlign: 'center'
    }
  }, "In Transit"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      textAlign: 'center'
    }
  }, "Delivered"), /*#__PURE__*/React.createElement("th", {
    style: {
      ...styles.th,
      width: '140px'
    }
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, companies.map((company, idx) => {
    const assigned = modules.filter(m => m.transportCompanyId === company.id);
    const scheduled = assigned.filter(m => m.stage === 'scheduledTransit' || m.stage === 'scheduledShuttle').length;
    const inTransit = assigned.filter(m => m.stage === 'inTransit').length;
    const delivered = assigned.filter(m => m.stage === 'arrived').length;
    return /*#__PURE__*/React.createElement("tr", {
      key: company.id,
      style: {
        background: idx % 2 === 0 ? COLORS.white : '#fafafa'
      }
    }, /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontWeight: '600',
        color: COLORS.charcoal
      }
    }, "\uD83D\uDE9B ", company.name), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontSize: '12px'
      }
    }, company.address), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontFamily: "'JetBrains Mono', monospace",
        fontSize: '12px'
      }
    }, company.phone), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, company.contact), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontFamily: "'JetBrains Mono', monospace",
        fontSize: '12px'
      }
    }, company.contactPhone || '–'), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: scheduled > 0 ? COLORS.warning : '#999',
        fontWeight: '700'
      }
    }, scheduled)), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: inTransit > 0 ? COLORS.info : '#999',
        fontWeight: '700'
      }
    }, inTransit)), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        textAlign: 'center'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: delivered > 0 ? COLORS.success : '#999',
        fontWeight: '700'
      }
    }, delivered)), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '8px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingCompany(company),
      style: {
        ...styles.btn('secondary'),
        padding: '6px 12px'
      }
    }, "Edit"), /*#__PURE__*/React.createElement("button", {
      onClick: () => deleteCompany(company.id),
      style: {
        ...styles.btn('danger'),
        padding: '6px 12px'
      }
    }, "Delete"))));
  }))));
  const HistoryView = () => {
    const arrivedModules = modules.filter(m => m.stage === 'arrived').sort((a, b) => new Date(b.arrivalTime || 0) - new Date(a.arrivalTime || 0));
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: '0 0 20px 0',
        color: COLORS.charcoal,
        fontSize: '22px',
        fontWeight: '700'
      }
    }, "Shipment History"), /*#__PURE__*/React.createElement("table", {
      style: styles.table
    }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Module ID"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "BLM"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Project"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Transport Company"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Scheduled Date"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Departure Time"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Arrival Time"), /*#__PURE__*/React.createElement("th", {
      style: styles.th
    }, "Notes"))), /*#__PURE__*/React.createElement("tbody", null, arrivedModules.map((module, idx) => /*#__PURE__*/React.createElement("tr", {
      key: module.id,
      style: {
        background: idx % 2 === 0 ? COLORS.white : '#fafafa'
      }
    }, /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontWeight: '600',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, module.moduleId), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontFamily: "'JetBrains Mono', monospace",
        color: '#666'
      }
    }, module.blm), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        color: COLORS.blue,
        fontWeight: '600'
      }
    }, module.project), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, getCompanyName(module.transportCompanyId)), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, module.scheduledDate ? new Date(module.scheduledDate).toLocaleDateString() : '–'), /*#__PURE__*/React.createElement("td", {
      style: styles.td
    }, module.departureTime ? new Date(module.departureTime).toLocaleString() : '–'), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        color: COLORS.success,
        fontWeight: '600'
      }
    }, module.arrivalTime ? new Date(module.arrivalTime).toLocaleString() : '–'), /*#__PURE__*/React.createElement("td", {
      style: {
        ...styles.td,
        fontSize: '12px',
        color: '#666'
      }
    }, module.notes || '–'))), arrivedModules.length === 0 && /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
      colSpan: 8,
      style: {
        ...styles.td,
        textAlign: 'center',
        padding: '50px',
        color: '#999'
      }
    }, "No completed shipments yet")))));
  };

  // Module Detail Modal
  const ModuleModal = () => {
    const [localModule, setLocalModule] = useState({
      ...selectedModule
    });
    const [shuttleDestinationYardId, setShuttleDestinationYardId] = useState(selectedModule?.shuttleDestinationYardId || '');
    const handleSave = () => {
      setModules(prev => prev.map(m => m.id === localModule.id ? localModule : m));
      setSelectedModule(null);
    };

    // Validate shuttle destination - must be off-property yard
    const validateShuttleDestination = () => {
      if (!shuttleDestinationYardId) {
        return {
          valid: false,
          error: 'Please select a destination yard for the shuttle'
        };
      }
      const destinationYard = yards.find(y => y.id === shuttleDestinationYardId);
      if (destinationYard?.isAutovol) {
        return {
          valid: false,
          error: 'Shuttles are for moving modules to off-property yards. Please select an external yard location.'
        };
      }
      return {
        valid: true
      };
    };
    const getNextStages = () => {
      const stages = [];
      if (localModule.stage === 'ready') stages.push({
        id: 'staged',
        label: 'Move to Yard',
        requiresYard: true
      });
      if (localModule.stage === 'staged') {
        stages.push({
          id: 'scheduledTransit',
          label: 'Schedule for Transit',
          requiresCompany: true,
          requiresDate: true
        });
        stages.push({
          id: 'scheduledShuttle',
          label: 'Schedule for Shuttle',
          requiresDate: true,
          requiresShuttleDestination: true
        });
      }
      if (localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') stages.push({
        id: 'inTransit',
        label: 'Mark In-Transit'
      });
      if (localModule.stage === 'inTransit') stages.push({
        id: 'arrived',
        label: 'Mark Arrived to Site'
      });
      return stages;
    };
    const currentStage = TRANSPORT_STAGES.find(s => s.id === localModule.stage);
    return /*#__PURE__*/React.createElement("div", {
      style: styles.modal
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalContent,
        borderTop: `4px solid ${currentStage?.color || COLORS.blue}`
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalHeader,
        background: currentStage?.color,
        color: COLORS.white
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: 0,
        fontSize: '18px',
        fontFamily: "'JetBrains Mono', monospace"
      }
    }, localModule.moduleId), /*#__PURE__*/React.createElement("p", {
      style: {
        margin: '4px 0 0 0',
        opacity: 0.9,
        fontSize: '13px'
      }
    }, localModule.blm, " \u2022 ", localModule.project)), /*#__PURE__*/React.createElement("button", {
      onClick: () => setSelectedModule(null),
      style: {
        background: 'rgba(255,255,255,0.2)',
        border: 'none',
        color: COLORS.white,
        width: '34px',
        height: '34px',
        borderRadius: '8px',
        cursor: 'pointer',
        fontSize: '16px',
        fontWeight: '600'
      }
    }, "\u2715")), /*#__PURE__*/React.createElement("div", {
      style: styles.modalBody
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '16px 18px',
        background: currentStage?.color + '12',
        borderRadius: '10px',
        marginBottom: '20px',
        borderLeft: `4px solid ${currentStage?.color}`
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#666',
        marginBottom: '4px',
        fontWeight: '600',
        textTransform: 'uppercase'
      }
    }, "Current Status"), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '18px',
        fontWeight: '700',
        color: COLORS.charcoal
      }
    }, currentStage?.iconType && /*#__PURE__*/React.createElement(TransportIcon, {
      type: currentStage.iconType,
      size: 20
    }), " ", currentStage?.label)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px'
      }
    }, (localModule.stage === 'ready' || localModule.stage === 'staged') && /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Staging Yard"), /*#__PURE__*/React.createElement("select", {
      value: localModule.yardId || '',
      onChange: e => setLocalModule({
        ...localModule,
        yardId: e.target.value
      }),
      style: styles.input
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "-- Select Yard --"), yards.map(y => /*#__PURE__*/React.createElement("option", {
      key: y.id,
      value: y.id
    }, y.name, " ", y.isAutovol ? '(Autovol)' : '')))), (localModule.stage === 'staged' || localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') && /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Transport Company"), /*#__PURE__*/React.createElement("select", {
      value: localModule.transportCompanyId || '',
      onChange: e => setLocalModule({
        ...localModule,
        transportCompanyId: e.target.value
      }),
      style: styles.input
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "-- Select Company --"), companies.map(c => /*#__PURE__*/React.createElement("option", {
      key: c.id,
      value: c.id
    }, c.name)))), (localModule.stage === 'staged' || localModule.stage === 'scheduledTransit' || localModule.stage === 'scheduledShuttle') && /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Scheduled Date"), /*#__PURE__*/React.createElement("input", {
      type: "date",
      value: localModule.scheduledDate || '',
      onChange: e => setLocalModule({
        ...localModule,
        scheduledDate: e.target.value
      }),
      style: styles.input
    })), localModule.stage === 'staged' && /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Shuttle Destination Yard"), /*#__PURE__*/React.createElement("select", {
      value: shuttleDestinationYardId,
      onChange: e => setShuttleDestinationYardId(e.target.value),
      style: styles.input
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "-- Select Destination --"), yards.filter(y => !y.isAutovol).map(y => /*#__PURE__*/React.createElement("option", {
      key: y.id,
      value: y.id
    }, y.name))), /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: '11px',
        color: '#888',
        marginTop: '4px'
      }
    }, "Required for shuttle (off-property yards only)"))), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Notes"), /*#__PURE__*/React.createElement("textarea", {
      value: localModule.notes || '',
      onChange: e => setLocalModule({
        ...localModule,
        notes: e.target.value
      }),
      placeholder: "Delivery instructions, special handling notes...",
      rows: 3,
      style: {
        ...styles.input,
        resize: 'vertical'
      }
    })), getNextStages().length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        borderTop: '1px solid #eee',
        paddingTop: '20px',
        marginTop: '8px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: '11px',
        color: '#666',
        marginBottom: '12px',
        fontWeight: '700',
        textTransform: 'uppercase',
        letterSpacing: '0.5px'
      }
    }, "Quick Actions"), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '10px',
        flexWrap: 'wrap'
      }
    }, getNextStages().map(nextStage => {
      const stageInfo = TRANSPORT_STAGES.find(s => s.id === nextStage.id);
      return /*#__PURE__*/React.createElement("button", {
        key: nextStage.id,
        onClick: () => {
          if (nextStage.requiresYard && !localModule.yardId) {
            alert('Please select a yard first');
            return;
          }
          if (nextStage.requiresCompany && !localModule.transportCompanyId) {
            alert('Please select a transport company first');
            return;
          }
          if (nextStage.requiresDate && !localModule.scheduledDate) {
            alert('Please set a scheduled date first');
            return;
          }
          if (nextStage.requiresShuttleDestination) {
            const validation = validateShuttleDestination();
            if (!validation.valid) {
              alert(validation.error);
              return;
            }
          }
          updateModuleStage(localModule.id, nextStage.id, {
            ...localModule,
            shuttleDestinationYardId
          });
        },
        style: {
          padding: '12px 20px',
          background: stageInfo?.color || COLORS.blue,
          color: COLORS.white,
          border: 'none',
          borderRadius: '8px',
          cursor: 'pointer',
          fontWeight: '600',
          fontSize: '13px',
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          transition: 'all 0.2s ease'
        },
        onMouseOver: e => {
          e.target.style.transform = 'translateY(-2px)';
          e.target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        },
        onMouseOut: e => {
          e.target.style.transform = 'none';
          e.target.style.boxShadow = 'none';
        }
      }, stageInfo?.iconType && /*#__PURE__*/React.createElement(TransportIcon, {
        type: stageInfo.iconType,
        color: "white"
      }), " ", nextStage.label);
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px',
        marginTop: '24px',
        paddingTop: '16px',
        borderTop: '1px solid #eee'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setSelectedModule(null),
      style: {
        ...styles.btn('secondary'),
        flex: 1
      }
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: handleSave,
      style: {
        ...styles.btn('primary'),
        flex: 1
      },
      onMouseOver: e => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
      },
      onMouseOut: e => {
        e.target.style.transform = 'none';
        e.target.style.boxShadow = 'none';
      }
    }, "Save Changes")))));
  };

  // Add Yard Modal
  const AddYardModal = () => {
    const [newYard, setNewYard] = useState({
      name: '',
      address: '',
      isAutovol: false
    });
    return /*#__PURE__*/React.createElement("div", {
      style: styles.modal
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalContent,
        maxWidth: '450px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.modalHeader
    }, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: 0,
        fontSize: '20px',
        fontWeight: '700',
        color: COLORS.charcoal
      }
    }, "Add Staging Yard"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAddYard(false),
      style: {
        background: 'none',
        border: 'none',
        fontSize: '22px',
        cursor: 'pointer',
        color: '#666'
      }
    }, "\u2715")), /*#__PURE__*/React.createElement("div", {
      style: styles.modalBody
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Yard Name *"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newYard.name,
      onChange: e => setNewYard({
        ...newYard,
        name: e.target.value
      }),
      placeholder: "e.g., East Lot",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Address"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newYard.address,
      onChange: e => setNewYard({
        ...newYard,
        address: e.target.value
      }),
      placeholder: "Full address...",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.fieldGroup,
        marginBottom: '24px'
      }
    }, /*#__PURE__*/React.createElement("label", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        cursor: 'pointer'
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: newYard.isAutovol,
      onChange: e => setNewYard({
        ...newYard,
        isAutovol: e.target.checked
      }),
      style: {
        width: '18px',
        height: '18px',
        accentColor: COLORS.red
      }
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '14px',
        fontWeight: '500'
      }
    }, "Autovol Property"))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAddYard(false),
      style: {
        ...styles.btn('secondary'),
        flex: 1
      }
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => newYard.name && addYard(newYard),
      style: {
        ...styles.btn('primary'),
        flex: 1
      },
      onMouseOver: e => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
      },
      onMouseOut: e => {
        e.target.style.transform = 'none';
        e.target.style.boxShadow = 'none';
      }
    }, "Add Yard")))));
  };

  // Edit Yard Modal
  const EditYardModal = () => {
    const [editedYard, setEditedYard] = useState({
      ...editingYard
    });
    return /*#__PURE__*/React.createElement("div", {
      style: styles.modal
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalContent,
        maxWidth: '450px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.modalHeader
    }, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: 0,
        fontSize: '20px',
        fontWeight: '700',
        color: COLORS.charcoal
      }
    }, "Edit Yard"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingYard(null),
      style: {
        background: 'none',
        border: 'none',
        fontSize: '22px',
        cursor: 'pointer',
        color: '#666'
      }
    }, "\u2715")), /*#__PURE__*/React.createElement("div", {
      style: styles.modalBody
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Yard Name *"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: editedYard.name,
      onChange: e => setEditedYard({
        ...editedYard,
        name: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Address"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: editedYard.address,
      onChange: e => setEditedYard({
        ...editedYard,
        address: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.fieldGroup,
        marginBottom: '24px'
      }
    }, /*#__PURE__*/React.createElement("label", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        cursor: 'pointer'
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: editedYard.isAutovol,
      onChange: e => setEditedYard({
        ...editedYard,
        isAutovol: e.target.checked
      }),
      style: {
        width: '18px',
        height: '18px',
        accentColor: COLORS.red
      }
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: '14px',
        fontWeight: '500'
      }
    }, "Autovol Property"))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingYard(null),
      style: {
        ...styles.btn('secondary'),
        flex: 1
      }
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => updateYard(editedYard.id, editedYard),
      style: {
        ...styles.btn('primary'),
        flex: 1
      },
      onMouseOver: e => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
      },
      onMouseOut: e => {
        e.target.style.transform = 'none';
        e.target.style.boxShadow = 'none';
      }
    }, "Save Changes")))));
  };

  // Add Company Modal
  const AddCompanyModal = () => {
    const [newCompany, setNewCompany] = useState({
      name: '',
      address: '',
      phone: '',
      contact: '',
      contactPhone: '',
      email: ''
    });
    return /*#__PURE__*/React.createElement("div", {
      style: styles.modal
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalContent,
        maxWidth: '560px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.modalHeader
    }, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: 0,
        fontSize: '20px',
        fontWeight: '700',
        color: COLORS.charcoal
      }
    }, "Add Transport Company"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAddCompany(false),
      style: {
        background: 'none',
        border: 'none',
        fontSize: '22px',
        cursor: 'pointer',
        color: '#666'
      }
    }, "\u2715")), /*#__PURE__*/React.createElement("div", {
      style: styles.modalBody
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Company Name *"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newCompany.name,
      onChange: e => setNewCompany({
        ...newCompany,
        name: e.target.value
      }),
      placeholder: "Company name...",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Address"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newCompany.address,
      onChange: e => setNewCompany({
        ...newCompany,
        address: e.target.value
      }),
      placeholder: "Full address...",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Office Phone"), /*#__PURE__*/React.createElement("input", {
      type: "tel",
      value: newCompany.phone,
      onChange: e => setNewCompany({
        ...newCompany,
        phone: e.target.value
      }),
      placeholder: "(208) 555-0000",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Email"), /*#__PURE__*/React.createElement("input", {
      type: "email",
      value: newCompany.email,
      onChange: e => setNewCompany({
        ...newCompany,
        email: e.target.value
      }),
      placeholder: "dispatch@company.com",
      style: styles.input
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px',
        marginBottom: '8px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Contact Name"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newCompany.contact,
      onChange: e => setNewCompany({
        ...newCompany,
        contact: e.target.value
      }),
      placeholder: "Primary contact...",
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Contact Phone"), /*#__PURE__*/React.createElement("input", {
      type: "tel",
      value: newCompany.contactPhone,
      onChange: e => setNewCompany({
        ...newCompany,
        contactPhone: e.target.value
      }),
      placeholder: "(208) 555-0000",
      style: styles.input
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px',
        marginTop: '16px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAddCompany(false),
      style: {
        ...styles.btn('secondary'),
        flex: 1
      }
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => newCompany.name && addCompany(newCompany),
      style: {
        ...styles.btn('primary'),
        flex: 1
      },
      onMouseOver: e => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
      },
      onMouseOut: e => {
        e.target.style.transform = 'none';
        e.target.style.boxShadow = 'none';
      }
    }, "Add Company")))));
  };

  // Edit Company Modal
  const EditCompanyModal = () => {
    const [editedCompany, setEditedCompany] = useState({
      ...editingCompany
    });
    return /*#__PURE__*/React.createElement("div", {
      style: styles.modal
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        ...styles.modalContent,
        maxWidth: '560px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.modalHeader
    }, /*#__PURE__*/React.createElement("h2", {
      style: {
        margin: 0,
        fontSize: '20px',
        fontWeight: '700',
        color: COLORS.charcoal
      }
    }, "Edit Company"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingCompany(null),
      style: {
        background: 'none',
        border: 'none',
        fontSize: '22px',
        cursor: 'pointer',
        color: '#666'
      }
    }, "\u2715")), /*#__PURE__*/React.createElement("div", {
      style: styles.modalBody
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Company Name *"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: editedCompany.name,
      onChange: e => setEditedCompany({
        ...editedCompany,
        name: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Address"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: editedCompany.address,
      onChange: e => setEditedCompany({
        ...editedCompany,
        address: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Office Phone"), /*#__PURE__*/React.createElement("input", {
      type: "tel",
      value: editedCompany.phone,
      onChange: e => setEditedCompany({
        ...editedCompany,
        phone: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Email"), /*#__PURE__*/React.createElement("input", {
      type: "email",
      value: editedCompany.email,
      onChange: e => setEditedCompany({
        ...editedCompany,
        email: e.target.value
      }),
      style: styles.input
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px',
        marginBottom: '8px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Contact Name"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: editedCompany.contact,
      onChange: e => setEditedCompany({
        ...editedCompany,
        contact: e.target.value
      }),
      style: styles.input
    })), /*#__PURE__*/React.createElement("div", {
      style: styles.fieldGroup
    }, /*#__PURE__*/React.createElement("label", {
      style: styles.label
    }, "Contact Phone"), /*#__PURE__*/React.createElement("input", {
      type: "tel",
      value: editedCompany.contactPhone,
      onChange: e => setEditedCompany({
        ...editedCompany,
        contactPhone: e.target.value
      }),
      style: styles.input
    }))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: '12px',
        marginTop: '16px'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setEditingCompany(null),
      style: {
        ...styles.btn('secondary'),
        flex: 1
      }
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => updateCompany(editedCompany.id, editedCompany),
      style: {
        ...styles.btn('primary'),
        flex: 1
      },
      onMouseOver: e => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0,87,184,0.3)';
      },
      onMouseOut: e => {
        e.target.style.transform = 'none';
        e.target.style.boxShadow = 'none';
      }
    }, "Save Changes")))));
  };

  // ============================================================================
  // MAIN RENDER
  // ============================================================================

  return /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mb-6 border-b border-gray-200"
  }, [{
    id: 'board',
    label: '🚛 Transport Board'
  }, {
    id: 'yards',
    label: '🏗️ Staging Yards'
  }, {
    id: 'companies',
    label: '🚚 Transport Companies'
  }, {
    id: 'history',
    label: '📋 Shipment History'
  }, {
    id: 'yardmap',
    label: '🗺️ Yard Map'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveView(tab.id),
    className: `px-4 py-3 font-semibold text-sm transition-all ${activeView === tab.id ? 'text-white bg-autovol-red border-b-2 border-autovol-red' : 'text-autovol-navy hover:text-autovol-red'}`,
    style: {
      borderBottom: activeView === tab.id ? '3px solid var(--autovol-red)' : '3px solid transparent'
    }
  }, tab.label))), /*#__PURE__*/React.createElement("div", {
    style: {
      minHeight: activeView === 'yardmap' ? '700px' : 'auto'
    }
  }, activeView === 'board' && /*#__PURE__*/React.createElement(BoardView, null), activeView === 'yards' && /*#__PURE__*/React.createElement(YardsView, null), activeView === 'companies' && /*#__PURE__*/React.createElement(CompaniesView, null), activeView === 'history' && /*#__PURE__*/React.createElement(HistoryView, null), activeView === 'yardmap' && (window.MODA_FEATURE_FLAGS?.flags?.enableYardMapV2 && window.YardMapV2 ? /*#__PURE__*/React.createElement(window.YardMapV2, {
    projects: projectsList
  }) : window.YardMapComponent && /*#__PURE__*/React.createElement(window.YardMapComponent, {
    projects: projectsList
  }))), selectedModule && /*#__PURE__*/React.createElement(ModuleModal, null), showAddYard && /*#__PURE__*/React.createElement(AddYardModal, null), editingYard && /*#__PURE__*/React.createElement(EditYardModal, null), showAddCompany && /*#__PURE__*/React.createElement(AddCompanyModal, null), editingCompany && /*#__PURE__*/React.createElement(EditCompanyModal, null), showBulkModal && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: COLORS.white,
      borderRadius: '12px',
      padding: '24px',
      width: '400px',
      maxWidth: '90vw'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: '18px',
      fontWeight: '700',
      color: COLORS.navy,
      marginBottom: '16px'
    }
  }, "Stage ", selectedModuleIds.size, " Module", selectedModuleIds.size !== 1 ? 's' : '', " in Yard"), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '16px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '600',
      color: '#374151',
      marginBottom: '6px'
    }
  }, "Select Yard"), /*#__PURE__*/React.createElement("select", {
    id: "bulk-yard-select",
    style: {
      width: '100%',
      padding: '10px 12px',
      border: '1px solid #d1d5db',
      borderRadius: '6px',
      fontSize: '14px'
    }
  }, yards.map(yard => /*#__PURE__*/React.createElement("option", {
    key: yard.id,
    value: yard.id
  }, yard.name)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: '20px'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'block',
      fontSize: '13px',
      fontWeight: '600',
      color: '#374151',
      marginBottom: '6px'
    }
  }, "New Stage"), /*#__PURE__*/React.createElement("select", {
    id: "bulk-stage-select",
    defaultValue: "stagedInYard",
    style: {
      width: '100%',
      padding: '10px 12px',
      border: '1px solid #d1d5db',
      borderRadius: '6px',
      fontSize: '14px'
    }
  }, TRANSPORT_STAGES.map(stage => /*#__PURE__*/React.createElement("option", {
    key: stage.id,
    value: stage.id
  }, stage.name)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: '12px'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowBulkModal(false),
    style: {
      flex: 1,
      padding: '10px',
      border: '1px solid #d1d5db',
      borderRadius: '6px',
      background: COLORS.white,
      cursor: 'pointer',
      fontWeight: '500'
    }
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const yardId = document.getElementById('bulk-yard-select').value;
      const stage = document.getElementById('bulk-stage-select').value;
      bulkUpdateModules(stage, yardId);
    },
    style: {
      flex: 1,
      padding: '10px',
      border: 'none',
      borderRadius: '6px',
      background: COLORS.teal,
      color: COLORS.white,
      cursor: 'pointer',
      fontWeight: '600'
    }
  }, "Update Modules")))));
}

// Export for use in App.jsx
window.TransportApp = TransportApp;
})();


// ============================================================================
// FILE: EquipmentModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA EQUIPMENT MODULE
// Extracted from App.jsx for better maintainability
// ============================================================================

// ============================================================================
// EQUIPMENT MODULE - Integrated
// ============================================================================

// People/Departments Data (would come from People module)
const equipmentSamplePeople = [];
const equipmentDepartments = ['Framing', 'Electrical', 'Plumbing', 'HVAC', 'Finishing', 'Welding', 'Assembly', 'Quality Control', 'Maintenance', 'Automation', 'Drywall', 'Roofing', 'Tool Crib'];

// Initial Equipment Data
const equipmentInitialData = [];
const equipmentInitialVendors = [];

// Main App
function EquipmentApp() {
  const [activeTab, setActiveTab] = useState('equipment');
  const [equipment, setEquipment] = useState([]);
  const [vendors, setVendors] = useState([]);
  const [inventoryLogs, setInventoryLogs] = useState([]);
  const [missingResolutions, setMissingResolutions] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [showEquipmentModal, setShowEquipmentModal] = useState(false);
  const [showVendorModal, setShowVendorModal] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All');
  const [filterToolStatus, setFilterToolStatus] = useState('All');
  const [isLoading, setIsLoading] = useState(true);
  const safeParseJSON = (str, fallback) => {
    if (str && str !== 'undefined' && str !== 'null') {
      try {
        return JSON.parse(str);
      } catch (e) {
        return fallback;
      }
    }
    return fallback;
  };

  // Load data from Supabase on mount
  useEffect(() => {
    const loadData = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[Equipment] Loading data from Supabase...');
          const [equipmentData, vendorsData, logsData] = await Promise.all([window.MODA_SUPABASE_DATA.equipment.getAll(), window.MODA_SUPABASE_DATA.equipment.getVendors(), window.MODA_SUPABASE_DATA.equipment.getLogs()]);
          setEquipment(equipmentData.length > 0 ? equipmentData : safeParseJSON(localStorage.getItem('modaEquipmentV2'), equipmentInitialData));
          setVendors(vendorsData.length > 0 ? vendorsData : safeParseJSON(localStorage.getItem('modaVendorsV2'), equipmentInitialVendors));
          setInventoryLogs(logsData.length > 0 ? logsData : safeParseJSON(localStorage.getItem('modaInventoryLogs'), []));
          setMissingResolutions(safeParseJSON(localStorage.getItem('modaMissingResolutions'), []));
          console.log('[Equipment] Loaded from Supabase:', equipmentData.length, 'items,', vendorsData.length, 'vendors,', logsData.length, 'logs');
        } else {
          console.log('[Equipment] Supabase not available, using localStorage');
          setEquipment(safeParseJSON(localStorage.getItem('modaEquipmentV2'), equipmentInitialData));
          setVendors(safeParseJSON(localStorage.getItem('modaVendorsV2'), equipmentInitialVendors));
          setInventoryLogs(safeParseJSON(localStorage.getItem('modaInventoryLogs'), []));
          setMissingResolutions(safeParseJSON(localStorage.getItem('modaMissingResolutions'), []));
        }
      } catch (error) {
        console.error('[Equipment] Error loading data:', error);
        setEquipment(safeParseJSON(localStorage.getItem('modaEquipmentV2'), equipmentInitialData));
        setVendors(safeParseJSON(localStorage.getItem('modaVendorsV2'), equipmentInitialVendors));
        setInventoryLogs(safeParseJSON(localStorage.getItem('modaInventoryLogs'), []));
        setMissingResolutions(safeParseJSON(localStorage.getItem('modaMissingResolutions'), []));
      } finally {
        setIsLoading(false);
      }
    };
    const timer = setTimeout(loadData, 500);
    return () => clearTimeout(timer);
  }, []);

  // Save data to localStorage as backup
  useEffect(() => {
    if (!isLoading && equipment.length > 0) localStorage.setItem('modaEquipmentV2', JSON.stringify(equipment));
  }, [equipment, isLoading]);
  useEffect(() => {
    if (!isLoading && vendors.length > 0) localStorage.setItem('modaVendorsV2', JSON.stringify(vendors));
  }, [vendors, isLoading]);
  useEffect(() => {
    if (!isLoading) localStorage.setItem('modaInventoryLogs', JSON.stringify(inventoryLogs));
  }, [inventoryLogs, isLoading]);
  useEffect(() => {
    if (!isLoading) localStorage.setItem('modaMissingResolutions', JSON.stringify(missingResolutions));
  }, [missingResolutions, isLoading]);

  // Notification system
  const showNotification = (message, type = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, {
      id,
      message,
      type
    }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 4000);
  };

  // Check for duplicate Serial ID
  const isSerialIdDuplicate = (serialId, excludeId = null) => {
    return equipment.some(e => e.serialId && (e.serialId || '').toLowerCase() === (serialId || '').toLowerCase() && e.id !== excludeId);
  };

  // Equipment CRUD
  const addEquipment = item => {
    if (item.serialId && isSerialIdDuplicate(item.serialId)) {
      showNotification(`⚠ Duplicate Serial ID: ${item.serialId} already exists!`, 'error');
      return false;
    }
    const newItem = {
      ...item,
      id: item.id || `TOOL-${String(equipment.length + 1).padStart(4, '0')}`,
      assignmentHistory: [{
        date: new Date().toISOString().split('T')[0],
        type: item.assignmentType,
        assignedTo: item.assignedTo,
        department: item.department,
        action: 'Initial Assignment'
      }]
    };
    setEquipment([...equipment, newItem]);
    showNotification(`✅ Equipment added: ${item.name}`, 'success');
    return true;
  };
  const updateEquipment = item => {
    if (item.serialId && isSerialIdDuplicate(item.serialId, item.id)) {
      showNotification(`⚠ Duplicate Serial ID: ${item.serialId} already exists!`, 'error');
      return false;
    }
    const oldItem = equipment.find(e => e.id === item.id);
    let updatedItem = {
      ...item
    };

    // Track assignment changes
    if (oldItem && (oldItem.assignmentType !== item.assignmentType || oldItem.assignedTo !== item.assignedTo || oldItem.department !== item.department)) {
      updatedItem.assignmentHistory = [...(oldItem.assignmentHistory || []), {
        date: new Date().toISOString().split('T')[0],
        type: item.assignmentType,
        assignedTo: item.assignedTo,
        department: item.department,
        action: 'Reassignment'
      }];
    }
    setEquipment(equipment.map(e => e.id === item.id ? updatedItem : e));
    showNotification(`✅ Equipment updated: ${item.name}`, 'success');
    return true;
  };
  const deleteEquipment = id => {
    if (confirm('Delete this equipment? This cannot be undone.')) {
      const item = equipment.find(e => e.id === id);
      setEquipment(equipment.filter(e => e.id !== id));
      showNotification(`🗑 Equipment deleted: ${item?.name}`, 'info');
    }
  };

  // Update tool status
  const updateToolStatus = (id, newStatus, additionalInfo = {}) => {
    setEquipment(equipment.map(e => {
      if (e.id === id) {
        const updated = {
          ...e,
          toolStatus: newStatus
        };
        if (newStatus === 'Missing') {
          updated.missingInfo = additionalInfo;
        } else if (newStatus === 'Loaned') {
          updated.loanInfo = additionalInfo;
        } else if (newStatus === 'Warranty/Repair') {
          updated.repairInfo = additionalInfo;
        }
        return updated;
      }
      return e;
    }));
  };

  // Resolve missing tool
  const resolveMissingTool = (id, resolution, notes) => {
    const tool = equipment.find(e => e.id === id);
    if (!tool) return;
    const resolutionRecord = {
      id: `RES-${Date.now()}`,
      toolId: id,
      toolName: tool.name,
      serialId: tool.serialId,
      resolution,
      notes,
      resolvedDate: new Date().toISOString(),
      resolvedBy: 'Current User' // Would come from auth
    };
    setMissingResolutions([...missingResolutions, resolutionRecord]);
    if (resolution === 'Found') {
      setEquipment(equipment.map(e => e.id === id ? {
        ...e,
        toolStatus: 'Present',
        missingInfo: null
      } : e));
      showNotification(`✅ Tool marked as Found: ${tool.name}`, 'success');
    } else {
      // Abandoned or Broken - mark as retired
      setEquipment(equipment.map(e => e.id === id ? {
        ...e,
        toolStatus: 'Present',
        status: 'Retired',
        missingInfo: null
      } : e));
      showNotification(`📋¦ Tool retired (${resolution}): ${tool.name}`, 'info');
    }
  };

  // Vendor CRUD
  const addVendor = item => {
    const newItem = {
      ...item,
      id: item.id || `VEND-${String(vendors.length + 1).padStart(4, '0')}`
    };
    setVendors([...vendors, newItem]);
    showNotification(`✅ Vendor added: ${item.name}`, 'success');
  };
  const updateVendor = item => {
    setVendors(vendors.map(v => v.id === item.id ? item : v));
    showNotification(`✅ Vendor updated: ${item.name}`, 'success');
  };
  const deleteVendor = id => {
    if (confirm('Delete this vendor?')) {
      setVendors(vendors.filter(v => v.id !== id));
    }
  };

  // Save inventory log
  const saveInventoryLog = log => {
    setInventoryLogs([...inventoryLogs, log]);

    // Update equipment statuses based on log
    log.items.forEach(item => {
      updateToolStatus(item.equipmentId, item.status, item.additionalInfo);
    });
    showNotification(`✅ Inventory log saved for ${log.department}`, 'success');
  };

  // Filtered equipment
  const filteredEquipment = equipment.filter(item => {
    const matchesSearch = (item.name || '').toLowerCase().includes((searchTerm || '').toLowerCase()) || (item.id || '').toLowerCase().includes((searchTerm || '').toLowerCase()) || (item.serialId || '').toLowerCase().includes((searchTerm || '').toLowerCase()) || (item.assignedTo || '').toLowerCase().includes((searchTerm || '').toLowerCase());
    const matchesType = filterType === 'All' || item.type === filterType;
    const matchesStatus = filterStatus === 'All' || item.status === filterStatus;
    const matchesToolStatus = filterToolStatus === 'All' || item.toolStatus === filterToolStatus;
    return matchesSearch && matchesType && matchesStatus && matchesToolStatus;
  });

  // Missing tools
  const missingTools = equipment.filter(e => e.toolStatus === 'Missing');

  // Stats
  const stats = {
    total: equipment.length,
    present: equipment.filter(e => e.toolStatus === 'Present').length,
    missing: missingTools.length,
    loaned: equipment.filter(e => e.toolStatus === 'Loaned').length,
    repair: equipment.filter(e => e.toolStatus === 'Warranty/Repair').length
  };

  // Export
  const exportToExcel = () => {
    const ws1 = XLSX.utils.json_to_sheet(equipment.map(e => ({
      ...e,
      assignmentHistory: JSON.stringify(e.assignmentHistory),
      loanInfo: JSON.stringify(e.loanInfo),
      missingInfo: JSON.stringify(e.missingInfo),
      repairInfo: JSON.stringify(e.repairInfo)
    })));
    const ws2 = XLSX.utils.json_to_sheet(vendors);
    const ws3 = XLSX.utils.json_to_sheet(inventoryLogs);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, "Equipment");
    XLSX.utils.book_append_sheet(wb, ws2, "Vendors");
    XLSX.utils.book_append_sheet(wb, ws3, "InventoryLogs");
    XLSX.writeFile(wb, `MODA_Equipment_${new Date().toISOString().split('T')[0]}.xlsx`);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, notifications.map(n => /*#__PURE__*/React.createElement("div", {
    key: n.id,
    className: `equipment-notification ${n.type === 'error' ? 'bg-red-600 text-white' : n.type === 'success' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`
  }, n.message)), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm p-4 mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '40px',
      height: '40px',
      background: 'linear-gradient(135deg, var(--autovol-red) 0%, var(--autovol-navy) 100%)',
      borderRadius: '8px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'white',
      fontWeight: '700',
      fontSize: '18px'
    }
  }, "\uD83D\uDD27"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-lg font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Tools & Equipment"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Power Tool Tracking & Inventory"))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, stats.total), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Total Tools")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-600"
  }, stats.present), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Present")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-red-600"
  }, stats.missing), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Missing")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-yellow-600"
  }, stats.loaned), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Loaned")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-600"
  }, stats.repair), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Repair"))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1 overflow-x-auto"
  }, [{
    id: 'equipment',
    label: 'Equipment',
    count: equipment.length
  }, {
    id: 'missing',
    label: 'Missing Tools',
    count: missingTools.length,
    alert: missingTools.length > 0
  }, {
    id: 'inventory',
    label: 'Inventory Log',
    count: null
  }, {
    id: 'vendors',
    label: 'Vendors',
    count: vendors.length
  }, {
    id: 'admin',
    label: 'Data Management',
    count: null
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveTab(tab.id),
    className: `equipment-tab-btn ${activeTab === tab.id ? 'active' : ''} whitespace-nowrap`
  }, tab.label, tab.count !== null && /*#__PURE__*/React.createElement("span", {
    className: `ml-2 text-xs px-2 py-0.5 rounded font-bold ${tab.alert ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'}`
  }, tab.count)))))), /*#__PURE__*/React.createElement("main", {
    className: "py-4"
  }, activeTab === 'equipment' && /*#__PURE__*/React.createElement(EquipmentDirectory, {
    equipment: filteredEquipment,
    vendors: vendors,
    people: equipmentSamplePeople,
    departments: equipmentDepartments,
    onAdd: () => {
      setEditingItem(null);
      setShowEquipmentModal(true);
    },
    onEdit: item => {
      setEditingItem(item);
      setShowEquipmentModal(true);
    },
    onDelete: deleteEquipment,
    onUpdateStatus: updateToolStatus,
    searchTerm: searchTerm,
    setSearchTerm: setSearchTerm,
    filterType: filterType,
    setFilterType: setFilterType,
    filterStatus: filterStatus,
    setFilterStatus: setFilterStatus,
    filterToolStatus: filterToolStatus,
    setFilterToolStatus: setFilterToolStatus
  }), activeTab === 'missing' && /*#__PURE__*/React.createElement(MissingToolBoard, {
    missingTools: missingTools,
    resolutions: missingResolutions,
    onResolve: resolveMissingTool
  }), activeTab === 'inventory' && /*#__PURE__*/React.createElement(InventoryLogSection, {
    equipment: equipment,
    departments: equipmentDepartments,
    logs: inventoryLogs,
    onSaveLog: saveInventoryLog
  }), activeTab === 'vendors' && /*#__PURE__*/React.createElement(VendorDirectory, {
    vendors: vendors,
    onAdd: () => {
      setEditingItem(null);
      setShowVendorModal(true);
    },
    onEdit: item => {
      setEditingItem(item);
      setShowVendorModal(true);
    },
    onDelete: deleteVendor
  }), activeTab === 'admin' && /*#__PURE__*/React.createElement(AdminPanel, {
    stats: stats,
    onExport: exportToExcel
  })), showEquipmentModal && /*#__PURE__*/React.createElement(EquipmentModal, {
    item: editingItem,
    vendors: vendors,
    people: equipmentSamplePeople,
    departments: equipmentDepartments,
    onSave: item => {
      const success = editingItem ? updateEquipment(item) : addEquipment(item);
      if (success) {
        setShowEquipmentModal(false);
        setEditingItem(null);
      }
    },
    onClose: () => {
      setShowEquipmentModal(false);
      setEditingItem(null);
    }
  }), showVendorModal && /*#__PURE__*/React.createElement(VendorModal, {
    item: editingItem,
    onSave: item => {
      editingItem ? updateVendor(item) : addVendor(item);
      setShowVendorModal(false);
      setEditingItem(null);
    },
    onClose: () => {
      setShowVendorModal(false);
      setEditingItem(null);
    }
  }));
}

// Equipment Directory
function EquipmentDirectory({
  equipment,
  vendors,
  people,
  departments,
  onAdd,
  onEdit,
  onDelete,
  onUpdateStatus,
  searchTerm,
  setSearchTerm,
  filterType,
  setFilterType,
  filterStatus,
  setFilterStatus,
  filterToolStatus,
  setFilterToolStatus
}) {
  const [selectedItem, setSelectedItem] = useState(null);
  return /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-12 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "col-span-12 lg:col-span-5"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-4 space-y-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search name, ID, serial, assignee...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "w-full px-4 py-3 border border-gray-300 rounded-lg",
    style: {
      fontSize: '14px'
    }
  }), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-2"
  }, /*#__PURE__*/React.createElement("select", {
    value: filterType,
    onChange: e => setFilterType(e.target.value),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: "All"
  }, "All Types"), /*#__PURE__*/React.createElement("option", {
    value: "Tool"
  }, "Tool"), /*#__PURE__*/React.createElement("option", {
    value: "Equipment"
  }, "Equipment"), /*#__PURE__*/React.createElement("option", {
    value: "Jig/Fixture"
  }, "Jig/Fixture")), /*#__PURE__*/React.createElement("select", {
    value: filterStatus,
    onChange: e => setFilterStatus(e.target.value),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: "All"
  }, "All Status"), /*#__PURE__*/React.createElement("option", {
    value: "Active"
  }, "Active"), /*#__PURE__*/React.createElement("option", {
    value: "Retired"
  }, "Retired")), /*#__PURE__*/React.createElement("select", {
    value: filterToolStatus,
    onChange: e => setFilterToolStatus(e.target.value),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: "All"
  }, "All Locations"), /*#__PURE__*/React.createElement("option", {
    value: "Present"
  }, "Present"), /*#__PURE__*/React.createElement("option", {
    value: "Missing"
  }, "Missing"), /*#__PURE__*/React.createElement("option", {
    value: "Loaned"
  }, "Loaned"), /*#__PURE__*/React.createElement("option", {
    value: "Warranty/Repair"
  }, "Repair"))), /*#__PURE__*/React.createElement("button", {
    onClick: onAdd,
    className: "btn-equipment-primary w-full"
  }, "+ Add Equipment")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 px-4 py-2 border-b text-sm font-semibold text-gray-600"
  }, "Equipment (", equipment.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "max-h-[calc(100vh-450px)] overflow-y-auto"
  }, equipment.map(item => /*#__PURE__*/React.createElement(EquipmentListRow, {
    key: item.id,
    item: item,
    isSelected: selectedItem?.id === item.id,
    onClick: () => setSelectedItem(item)
  })), equipment.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12 text-gray-500"
  }, "No equipment found")))), /*#__PURE__*/React.createElement("div", {
    className: "col-span-12 lg:col-span-7"
  }, selectedItem ? /*#__PURE__*/React.createElement(EquipmentDetailPanel, {
    item: selectedItem,
    onEdit: onEdit,
    onDelete: onDelete,
    onClose: () => setSelectedItem(null)
  }) : /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-12 text-center text-gray-400"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDD27"), /*#__PURE__*/React.createElement("p", {
    className: "text-lg font-medium"
  }, "Select a tool to view details"))));
}

// Equipment List Row
function EquipmentListRow({
  item,
  isSelected,
  onClick
}) {
  const getToolStatusStyle = status => {
    switch (status) {
      case 'Present':
        return 'bg-green-100 text-green-800';
      case 'Missing':
        return 'bg-red-100 text-red-800';
      case 'Loaned':
        return 'bg-yellow-100 text-yellow-800';
      case 'Warranty/Repair':
        return 'bg-blue-100 text-blue-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: `equipment-list-row ${isSelected ? 'selected' : ''}`,
    onClick: onClick
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-mono text-gray-500 serial-id"
  }, item.serialId || item.id)), /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-900 truncate",
    style: {
      fontSize: '15px'
    }
  }, item.name), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600 mt-1 font-medium"
  }, item.assignmentType === 'Individual' ? /*#__PURE__*/React.createElement("span", null, "\uD83D\uDC64 ", item.assignedTo) : /*#__PURE__*/React.createElement("span", null, "\uD83C\uDFE2 ", item.department))), /*#__PURE__*/React.createElement("div", {
    className: "ml-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: `badge ${getToolStatusStyle(item.toolStatus)}`
  }, item.toolStatus === 'Warranty/Repair' ? '🔧 Repair' : item.toolStatus))));
}

// Equipment Detail Panel
function EquipmentDetailPanel({
  item,
  onEdit,
  onDelete,
  onClose
}) {
  const getToolStatusStyle = status => {
    switch (status) {
      case 'Present':
        return 'bg-green-100 text-green-800';
      case 'Missing':
        return 'bg-red-100 text-red-800';
      case 'Loaned':
        return 'bg-yellow-100 text-yellow-800';
      case 'Warranty/Repair':
        return 'bg-blue-100 text-blue-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between mb-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 font-mono mb-1 tool-id"
  }, item.id), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-gray-900"
  }, item.name)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl font-bold",
    style: {
      width: '32px',
      height: '32px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 flex-wrap"
  }, /*#__PURE__*/React.createElement("span", {
    className: `badge ${getToolStatusStyle(item.toolStatus)}`
  }, item.toolStatus), /*#__PURE__*/React.createElement("span", {
    className: `badge ${item.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`
  }, item.status))), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Tool Identification"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Part Number / Model"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold font-mono"
  }, item.partNumber || '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Serial ID"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold font-mono text-autovol-blue serial-id"
  }, item.serialId || '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Category"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.category || '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Location"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.location || '–')))), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Current Assignment"), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 p-4 rounded-lg border-l-4",
    style: {
      borderLeftColor: '#0057B8'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Assignment Type"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.assignmentType)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Department"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.department || '–')), item.assignmentType === 'Individual' && /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Assigned To"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-lg"
  }, "\uD83D\uDC64 ", item.assignedTo))))), item.toolStatus === 'Loaned' && item.loanInfo && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3 text-yellow-700"
  }, "\uD83D\uDCCB\xA4 Loan Information"), /*#__PURE__*/React.createElement("div", {
    className: "bg-yellow-50 p-4 rounded-lg text-sm border-l-4 border-yellow-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Loaned To"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.loanInfo.loanedTo)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Department"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.loanInfo.loanedToDept)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Loan Date"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.loanInfo.loanDate)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Expected Return"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-yellow-700"
  }, item.loanInfo.expectedReturn))), item.loanInfo.reason && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 pt-3 border-t border-yellow-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Reason"), /*#__PURE__*/React.createElement("div", null, item.loanInfo.reason)))), item.toolStatus === 'Warranty/Repair' && item.repairInfo && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3 text-blue-700"
  }, "\uD83D\uDD27 Repair Information"), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 p-4 rounded-lg text-sm border-l-4 border-blue-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Service Provider"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.repairInfo.vendor)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Ticket #"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold font-mono"
  }, item.repairInfo.ticketNumber)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Sent Date"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.repairInfo.sentDate)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Expected Return"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-blue-700"
  }, item.repairInfo.expectedReturn))), /*#__PURE__*/React.createElement("div", {
    className: "mt-3 pt-3 border-t border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Issue"), /*#__PURE__*/React.createElement("div", null, item.repairInfo.issue)))), item.toolStatus === 'Missing' && item.missingInfo && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3 text-red-700"
  }, "\u26A0 Missing Tool Report"), /*#__PURE__*/React.createElement("div", {
    className: "bg-red-50 p-4 rounded-lg text-sm border-l-4 border-red-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Reported Date"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.missingInfo.reportedDate)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Reported By"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.missingInfo.reportedBy)), /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Last Known Location"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.missingInfo.lastKnownLocation))), item.missingInfo.notes && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 pt-3 border-t border-red-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Notes"), /*#__PURE__*/React.createElement("div", null, item.missingInfo.notes)))), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Purchase Information"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Vendor"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.vendor || '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Purchase Date"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.purchaseDate || '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Cost"), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.cost ? `$${parseFloat(item.cost).toFixed(2)}` : '–')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500 mb-1 font-medium"
  }, "Warranty Exp."), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.warranty || '–')))), item.assignmentHistory && item.assignmentHistory.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Assignment History"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-48 overflow-y-auto"
  }, [...item.assignmentHistory].reverse().map((h, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "text-sm p-3 bg-gray-50 rounded-lg flex justify-between items-start"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, h.action), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 mx-2"
  }, "\u2192"), h.type === 'Individual' ? /*#__PURE__*/React.createElement("span", null, "\uD83D\uDC64 ", h.assignedTo, " (", h.department, ")") : /*#__PURE__*/React.createElement("span", null, "\uD83C\uDFE2 ", h.department)), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 text-xs"
  }, h.date))))), item.notes && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Notes"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-700 bg-gray-50 p-3 rounded-lg"
  }, item.notes)), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => onEdit(item),
    className: "btn-equipment-primary flex-1"
  }, "\u270F Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onDelete(item.id),
    className: "btn-equipment-danger"
  }, "\uD83D\uDDD1 Delete"))));
}

// Missing Tool Board
function MissingToolBoard({
  missingTools,
  resolutions,
  onResolve
}) {
  const [selectedTool, setSelectedTool] = useState(null);
  const [showResolveModal, setShowResolveModal] = useState(false);

  // Calculate days missing
  const getDaysMissing = reportedDate => {
    if (!reportedDate) return 0;
    const reported = new Date(reportedDate);
    const today = new Date();
    return Math.floor((today - reported) / (1000 * 60 * 60 * 24));
  };
  return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2"
  }, "Missing Tool Tracking Board"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Track and resolve missing tools. Tools missing over 30 days are marked critical.")), missingTools.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 border-2 border-green-200 rounded-lg p-12 text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\u2705"), /*#__PURE__*/React.createElement("h3", {
    className: "text-xl font-bold text-green-800 mb-2"
  }, "All Tools Accounted For"), /*#__PURE__*/React.createElement("p", {
    className: "text-green-600"
  }, "No missing tools reported at this time.")) : /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
  }, missingTools.map(tool => {
    const daysMissing = getDaysMissing(tool.missingInfo?.reportedDate);
    const isCritical = daysMissing > 30;
    return /*#__PURE__*/React.createElement("div", {
      key: tool.id,
      className: `missing-card ${isCritical ? 'border-red-600 bg-red-50' : ''}`
    }, isCritical && /*#__PURE__*/React.createElement("div", {
      className: "bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded mb-3 inline-block"
    }, "\uD83D\uDEA8 CRITICAL: ", daysMissing, " DAYS MISSING"), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-500 font-mono mb-1 serial-id"
    }, tool.serialId || tool.id), /*#__PURE__*/React.createElement("h3", {
      className: "font-bold text-lg mb-2"
    }, tool.name), /*#__PURE__*/React.createElement("div", {
      className: "text-sm space-y-1.5 mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 font-medium"
    }, "Assigned To:"), /*#__PURE__*/React.createElement("span", {
      className: "font-semibold"
    }, tool.assignmentType === 'Individual' ? tool.assignedTo : tool.department)), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 font-medium"
    }, "Reported:"), /*#__PURE__*/React.createElement("span", {
      className: "font-semibold"
    }, tool.missingInfo?.reportedDate || 'Unknown')), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 font-medium"
    }, "Last Location:"), /*#__PURE__*/React.createElement("span", {
      className: "font-semibold"
    }, tool.missingInfo?.lastKnownLocation || 'Unknown')), !isCritical && /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 font-medium"
    }, "Days Missing:"), /*#__PURE__*/React.createElement("span", {
      className: "font-bold text-red-600"
    }, daysMissing, " days"))), tool.missingInfo?.notes && /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-600 italic border-t pt-2 mb-4 bg-gray-50 p-2 rounded"
    }, "\"", tool.missingInfo.notes, "\""), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setSelectedTool(tool);
        setShowResolveModal(true);
      },
      className: "btn-equipment-primary w-full"
    }, "Resolve"));
  })), resolutions.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-8"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-xl font-bold mb-4"
  }, "Resolution History"), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Date"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Tool"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Serial"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Resolution"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Notes"))), /*#__PURE__*/React.createElement("tbody", null, [...resolutions].reverse().map((r, idx) => /*#__PURE__*/React.createElement("tr", {
    key: r.id,
    className: "border-t",
    style: {
      background: idx % 2 === 0 ? 'white' : '#fafafa'
    }
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, new Date(r.resolvedDate).toLocaleDateString()), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 font-semibold"
  }, r.toolName), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 font-mono text-gray-500 serial-id"
  }, r.serialId), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: `badge ${r.resolution === 'Found' ? 'bg-green-100 text-green-800' : r.resolution === 'Abandoned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`
  }, r.resolution)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-600"
  }, r.notes || '–'))))))), showResolveModal && selectedTool && /*#__PURE__*/React.createElement(ResolveModal, {
    tool: selectedTool,
    onResolve: (resolution, notes) => {
      onResolve(selectedTool.id, resolution, notes);
      setShowResolveModal(false);
      setSelectedTool(null);
    },
    onClose: () => {
      setShowResolveModal(false);
      setSelectedTool(null);
    }
  }));
}

// Resolve Modal
function ResolveModal({
  tool,
  onResolve,
  onClose
}) {
  const [resolution, setResolution] = useState('');
  const [notes, setNotes] = useState('');
  const resolutionOptions = [{
    value: 'Found',
    label: '✅ Tool Found',
    description: 'Tool has been located and is back in service',
    color: 'bg-green-100 border-green-500'
  }, {
    value: 'Abandoned',
    label: '📋¦ Abandoned',
    description: 'Search abandoned - tool written off',
    color: 'bg-yellow-100 border-yellow-500'
  }, {
    value: 'Broken',
    label: '🔨 Broken/Non-repairable',
    description: 'Tool found but not repairable',
    color: 'bg-red-100 border-red-500'
  }];
  return /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-overlay",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-content",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold"
  }, "Resolve Missing Tool"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl font-bold"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 p-4 rounded-lg mb-6 border-l-4",
    style: {
      borderLeftColor: '#0057B8'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 font-mono serial-id"
  }, tool.serialId || tool.id), /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-lg"
  }, tool.name), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, "Assigned: ", tool.assignmentType === 'Individual' ? tool.assignedTo : tool.department)), /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block font-semibold mb-3"
  }, "Select Resolution:"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, resolutionOptions.map(opt => /*#__PURE__*/React.createElement("div", {
    key: opt.value,
    onClick: () => setResolution(opt.value),
    className: `p-4 rounded-lg border-2 cursor-pointer transition-all ${resolution === opt.value ? opt.color + ' border-opacity-100' : 'bg-white border-gray-200 hover:border-gray-300'}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, opt.label), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 mt-1"
  }, opt.description))))), /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block font-semibold mb-2"
  }, "Notes (required):"), /*#__PURE__*/React.createElement("textarea", {
    value: notes,
    onChange: e => setNotes(e.target.value),
    className: "w-full px-4 py-3 border border-gray-300 rounded-lg",
    rows: "3",
    placeholder: "Provide details about the resolution...",
    required: true
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      if (!resolution) {
        alert('Please select a resolution');
        return;
      }
      if (!notes.trim()) {
        alert('Please provide notes for this resolution');
        return;
      }
      onResolve(resolution, notes);
    },
    className: "btn-equipment-success flex-1"
  }, "Confirm Resolution"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "btn-equipment-secondary"
  }, "Cancel")))));
}

// Inventory Log Section
function InventoryLogSection({
  equipment,
  departments,
  logs,
  onSaveLog
}) {
  const [activeView, setActiveView] = useState('conduct');
  const [selectedDept, setSelectedDept] = useState('');
  const [inventoryItems, setInventoryItems] = useState([]);
  const [isInventoryActive, setIsInventoryActive] = useState(false);

  // Start inventory for department
  const startInventory = () => {
    if (!selectedDept) return;
    const deptEquipment = equipment.filter(e => e.department === selectedDept && e.status === 'Active');
    setInventoryItems(deptEquipment.map(e => ({
      equipmentId: e.id,
      name: e.name,
      serialId: e.serialId,
      currentStatus: e.toolStatus,
      status: null,
      additionalInfo: {}
    })));
    setIsInventoryActive(true);
  };

  // Update item status
  const updateItemStatus = (equipmentId, status) => {
    setInventoryItems(items => items.map(item => item.equipmentId === equipmentId ? {
      ...item,
      status
    } : item));
  };

  // Submit inventory
  const submitInventory = () => {
    const incompleteItems = inventoryItems.filter(i => !i.status);
    if (incompleteItems.length > 0) {
      alert(`Please mark status for all items. ${incompleteItems.length} items remaining.`);
      return;
    }
    const log = {
      id: `LOG-${Date.now()}`,
      department: selectedDept,
      date: new Date().toISOString(),
      conductedBy: 'Current User',
      items: inventoryItems,
      summary: {
        total: inventoryItems.length,
        present: inventoryItems.filter(i => i.status === 'Present').length,
        missing: inventoryItems.filter(i => i.status === 'Missing').length,
        loaned: inventoryItems.filter(i => i.status === 'Loaned').length,
        repair: inventoryItems.filter(i => i.status === 'Warranty/Repair').length
      }
    };
    onSaveLog(log);
    setIsInventoryActive(false);
    setSelectedDept('');
    setInventoryItems([]);
  };

  // Get next inventory due date (monthly)
  const getNextInventoryDate = dept => {
    const deptLogs = logs.filter(l => l.department === dept);
    if (deptLogs.length === 0) return 'Not yet conducted';
    const lastLog = deptLogs.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    const lastDate = new Date(lastLog.date);
    const nextDate = new Date(lastDate);
    nextDate.setMonth(nextDate.getMonth() + 1);
    const today = new Date();
    const isOverdue = nextDate < today;
    return {
      date: nextDate.toLocaleDateString(),
      isOverdue
    };
  };
  return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2"
  }, "Tool Inventory Log"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Monthly inventory exercises by department. Track tool status and accountability.")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mb-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('conduct'),
    className: `px-4 py-2 rounded-lg font-semibold ${activeView === 'conduct' ? 'bg-autovol-blue text-white' : 'bg-gray-200'}`
  }, "Conduct Inventory"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('history'),
    className: `px-4 py-2 rounded-lg font-semibold ${activeView === 'history' ? 'bg-autovol-blue text-white' : 'bg-gray-200'}`
  }, "View History"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('schedule'),
    className: `px-4 py-2 rounded-lg font-semibold ${activeView === 'schedule' ? 'bg-autovol-blue text-white' : 'bg-gray-200'}`
  }, "Schedule Overview")), activeView === 'conduct' && !isInventoryActive && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-4"
  }, "Start New Inventory Exercise"), /*#__PURE__*/React.createElement("div", {
    className: "max-w-md"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block mb-2 font-semibold"
  }, "Select Department:"), /*#__PURE__*/React.createElement("select", {
    value: selectedDept,
    onChange: e => setSelectedDept(e.target.value),
    className: "w-full px-4 py-2 border border-gray-300 rounded-lg mb-4"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Choose department..."), departments.map(d => /*#__PURE__*/React.createElement("option", {
    key: d,
    value: d
  }, d))), /*#__PURE__*/React.createElement("button", {
    onClick: startInventory,
    disabled: !selectedDept,
    className: "btn-equipment-primary w-full disabled:opacity-50"
  }, "Start Inventory"))), activeView === 'conduct' && isInventoryActive && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg"
  }, "Inventory: ", selectedDept), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, inventoryItems.filter(i => i.status).length, " / ", inventoryItems.length, " items marked")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setIsInventoryActive(false);
      setInventoryItems([]);
    },
    className: "btn-equipment-secondary"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: submitInventory,
    className: "btn-equipment-success"
  }, "Submit Inventory")))), inventoryItems.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "No equipment found for this department.") : /*#__PURE__*/React.createElement("div", {
    className: "divide-y"
  }, inventoryItems.map(item => /*#__PURE__*/React.createElement("div", {
    key: item.equipmentId,
    className: "p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 font-mono serial-id"
  }, item.serialId || item.equipmentId), /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, item.name)), item.status && /*#__PURE__*/React.createElement("span", {
    className: `badge ${item.status === 'Present' ? 'bg-green-100 text-green-800' : item.status === 'Missing' ? 'bg-red-100 text-red-800' : item.status === 'Loaned' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`
  }, item.status)), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 flex-wrap"
  }, ['Present', 'Missing', 'Warranty/Repair', 'Loaned'].map(status => /*#__PURE__*/React.createElement("button", {
    key: status,
    onClick: () => updateItemStatus(item.equipmentId, status),
    className: `equipment-status-btn ${item.status === status ? 'selected' : ''} ${status === 'Present' ? 'bg-green-50 text-green-800' : status === 'Missing' ? 'bg-red-50 text-red-800' : status === 'Loaned' ? 'bg-yellow-50 text-yellow-800' : 'bg-blue-50 text-blue-800'}`
  }, status === 'Present' ? '✅' : status === 'Missing' ? '❌' : status === 'Loaned' ? '📋¤' : '🔧', " ", status))))))), activeView === 'history' && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Date"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Department"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Conducted By"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center font-semibold"
  }, "Total"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center font-semibold"
  }, "Present"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center font-semibold"
  }, "Missing"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center font-semibold"
  }, "Loaned"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-center font-semibold"
  }, "Repair"))), /*#__PURE__*/React.createElement("tbody", null, logs.length === 0 ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
    colSpan: "8",
    className: "px-4 py-8 text-center text-gray-500"
  }, "No inventory logs yet.")) : [...logs].reverse().map((log, idx) => /*#__PURE__*/React.createElement("tr", {
    key: log.id,
    className: "border-t",
    style: {
      background: idx % 2 === 0 ? 'white' : '#fafafa'
    }
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, new Date(log.date).toLocaleDateString()), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 font-semibold"
  }, log.department), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, log.conductedBy), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-center"
  }, log.summary.total), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-center text-green-600 font-bold"
  }, log.summary.present), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-center text-red-600 font-bold"
  }, log.summary.missing), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-center text-yellow-600 font-bold"
  }, log.summary.loaned), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-center text-blue-600 font-bold"
  }, log.summary.repair)))))), activeView === 'schedule' && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Department"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Tool Count"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Last Inventory"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Next Due"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-semibold"
  }, "Status"))), /*#__PURE__*/React.createElement("tbody", null, departments.map((dept, idx) => {
    const deptEquip = equipment.filter(e => e.department === dept && e.status === 'Active');
    const deptLogs = logs.filter(l => l.department === dept);
    const lastLog = deptLogs.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    const nextInfo = getNextInventoryDate(dept);
    if (deptEquip.length === 0) return null;
    return /*#__PURE__*/React.createElement("tr", {
      key: dept,
      className: "border-t",
      style: {
        background: idx % 2 === 0 ? 'white' : '#fafafa'
      }
    }, /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 font-semibold"
    }, dept), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, deptEquip.length), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, lastLog ? new Date(lastLog.date).toLocaleDateString() : 'Never'), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, typeof nextInfo === 'string' ? nextInfo : nextInfo.date), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, typeof nextInfo === 'string' ? /*#__PURE__*/React.createElement("span", {
      className: "equipment-badge bg-gray-100 text-gray-800"
    }, "Pending") : nextInfo.isOverdue ? /*#__PURE__*/React.createElement("span", {
      className: "equipment-badge bg-red-100 text-red-800"
    }, "\u26A0 Overdue") : /*#__PURE__*/React.createElement("span", {
      className: "equipment-badge bg-green-100 text-green-800"
    }, "On Track")));
  })))));
}

// Vendor Directory
function VendorDirectory({
  vendors,
  onAdd,
  onEdit,
  onDelete
}) {
  const [selectedVendor, setSelectedVendor] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const filteredVendors = vendors.filter(v => (v.name || '').toLowerCase().includes((searchTerm || '').toLowerCase()));
  return /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-12 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "col-span-12 lg:col-span-5"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-4 space-y-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search vendors...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "w-full px-4 py-3 border border-gray-300 rounded-lg"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: onAdd,
    className: "btn-equipment-primary w-full"
  }, "+ Add Vendor")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 px-4 py-2 border-b text-sm font-semibold text-gray-600"
  }, "Vendors (", filteredVendors.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "max-h-[calc(100vh-400px)] overflow-y-auto"
  }, filteredVendors.map(vendor => /*#__PURE__*/React.createElement("div", {
    key: vendor.id,
    className: `equipment-list-row ${selectedVendor?.id === vendor.id ? 'selected' : ''}`,
    onClick: () => setSelectedVendor(vendor)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, vendor.name), vendor.preferred && /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-500"
  }, "\u2B50")), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 font-mono"
  }, vendor.phone)))))))), /*#__PURE__*/React.createElement("div", {
    className: "col-span-12 lg:col-span-7"
  }, selectedVendor ? /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold"
  }, selectedVendor.name), selectedVendor.preferred && /*#__PURE__*/React.createElement("span", {
    className: "equipment-badge bg-green-100 text-green-800 mt-2"
  }, "\u2B50 Preferred Vendor")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setSelectedVendor(null),
    className: "text-gray-400 hover:text-gray-600 text-2xl font-bold"
  }, "\xD7"))), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Contact Information"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 font-medium"
  }, "Contact:"), " ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, selectedVendor.contactPerson)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 font-medium"
  }, "Phone:"), " ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold font-mono"
  }, selectedVendor.phone)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 font-medium"
  }, "Email:"), " ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-blue-600"
  }, selectedVendor.email)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 font-medium"
  }, "Website:"), " ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-blue-600"
  }, selectedVendor.website)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 font-medium"
  }, "Payment Terms:"), " ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, selectedVendor.paymentTerms)))), selectedVendor.categories && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Product Categories"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, selectedVendor.categories.map((cat, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    className: "equipment-badge bg-blue-100 text-blue-800"
  }, cat)))), selectedVendor.notes && /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-3"
  }, "Notes"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-700 bg-gray-50 p-3 rounded-lg"
  }, selectedVendor.notes)), /*#__PURE__*/React.createElement("div", {
    className: "equipment-detail-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => onEdit(selectedVendor),
    className: "btn-equipment-primary flex-1"
  }, "\u270F Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onDelete(selectedVendor.id),
    className: "btn-equipment-danger"
  }, "\uD83D\uDDD1 Delete")))) : /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-12 text-center text-gray-400"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83C\uDFE2"), /*#__PURE__*/React.createElement("p", {
    className: "text-lg font-medium"
  }, "Select a vendor to view details"))));
}

// Admin Panel
function AdminPanel({
  stats,
  onExport
}) {
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold mb-4"
  }, "System Overview"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-5 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold"
  }, stats.total), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 font-medium"
  }, "Total Tools")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 bg-green-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-green-600"
  }, stats.present), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 font-medium"
  }, "Present")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 bg-red-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-red-600"
  }, stats.missing), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 font-medium"
  }, "Missing")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 bg-yellow-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-yellow-600"
  }, stats.loaned), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 font-medium"
  }, "Loaned")), /*#__PURE__*/React.createElement("div", {
    className: "text-center p-4 bg-blue-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold text-blue-600"
  }, stats.repair), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600 font-medium"
  }, "In Repair")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold mb-4"
  }, "Data Management"), /*#__PURE__*/React.createElement("button", {
    onClick: onExport,
    className: "btn-equipment-primary"
  }, "\uD83D\uDCCB\u0160 Export to Excel")));
}

// Equipment Modal
function EquipmentModal({
  item,
  vendors,
  people,
  departments,
  onSave,
  onClose
}) {
  const [formData, setFormData] = useState(item || {
    name: '',
    type: 'Tool',
    category: 'Power Tools',
    partNumber: '',
    serialId: '',
    location: '',
    status: 'Active',
    toolStatus: 'Present',
    assignmentType: 'Unassigned',
    assignedTo: null,
    department: '',
    purchaseDate: '',
    cost: '',
    vendor: '',
    warranty: '',
    notes: ''
  });

  // Auto-fill department when individual selected
  const handleAssigneeChange = personName => {
    const person = people.find(p => p.name === personName);
    setFormData({
      ...formData,
      assignedTo: personName,
      department: person ? person.department : formData.department
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-overlay",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-content",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold"
  }, item ? 'Edit Equipment' : 'Add Equipment'), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl font-bold"
  }, "\xD7")), /*#__PURE__*/React.createElement("form", {
    onSubmit: e => {
      e.preventDefault();
      onSave(formData);
    },
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Tool Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    required: true,
    value: formData.name,
    onChange: e => setFormData({
      ...formData,
      name: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    placeholder: "e.g., DeWalt 20V Impact Driver"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Part Number / Model"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.partNumber,
    onChange: e => setFormData({
      ...formData,
      partNumber: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded font-mono",
    placeholder: "e.g., DCF887B"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Serial ID (Unique) *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    required: true,
    value: formData.serialId,
    onChange: e => setFormData({
      ...formData,
      serialId: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded font-mono",
    placeholder: "e.g., DW-2024-0001"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Type"), /*#__PURE__*/React.createElement("select", {
    value: formData.type,
    onChange: e => setFormData({
      ...formData,
      type: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Tool"
  }, "Tool"), /*#__PURE__*/React.createElement("option", {
    value: "Equipment"
  }, "Equipment"), /*#__PURE__*/React.createElement("option", {
    value: "Jig/Fixture"
  }, "Jig/Fixture"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Category"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.category,
    onChange: e => setFormData({
      ...formData,
      category: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    placeholder: "e.g., Power Tools"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "border-t pt-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold mb-3"
  }, "Assignment"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Assignment Type"), /*#__PURE__*/React.createElement("select", {
    value: formData.assignmentType,
    onChange: e => setFormData({
      ...formData,
      assignmentType: e.target.value,
      assignedTo: e.target.value !== 'Individual' ? null : formData.assignedTo
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Unassigned"
  }, "Unassigned"), /*#__PURE__*/React.createElement("option", {
    value: "Individual"
  }, "Individual"), /*#__PURE__*/React.createElement("option", {
    value: "Department"
  }, "Department"))), formData.assignmentType === 'Individual' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Assigned To"), /*#__PURE__*/React.createElement("select", {
    value: formData.assignedTo || '',
    onChange: e => handleAssigneeChange(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select person..."), people.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.name
  }, p.name, " (", p.department, ")")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Department"), /*#__PURE__*/React.createElement("select", {
    value: formData.department,
    onChange: e => setFormData({
      ...formData,
      department: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    disabled: formData.assignmentType === 'Individual' && formData.assignedTo
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select department..."), departments.map(d => /*#__PURE__*/React.createElement("option", {
    key: d,
    value: d
  }, d)))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Location"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.location,
    onChange: e => setFormData({
      ...formData,
      location: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    placeholder: "e.g., Station 5"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Status"), /*#__PURE__*/React.createElement("select", {
    value: formData.status,
    onChange: e => setFormData({
      ...formData,
      status: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Active"
  }, "Active"), /*#__PURE__*/React.createElement("option", {
    value: "Retired"
  }, "Retired"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Tool Status"), /*#__PURE__*/React.createElement("select", {
    value: formData.toolStatus,
    onChange: e => setFormData({
      ...formData,
      toolStatus: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Present"
  }, "Present"), /*#__PURE__*/React.createElement("option", {
    value: "Missing"
  }, "Missing"), /*#__PURE__*/React.createElement("option", {
    value: "Loaned"
  }, "Loaned"), /*#__PURE__*/React.createElement("option", {
    value: "Warranty/Repair"
  }, "Warranty/Repair")))), /*#__PURE__*/React.createElement("div", {
    className: "border-t pt-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold mb-3"
  }, "Purchase Information"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Vendor"), /*#__PURE__*/React.createElement("select", {
    value: formData.vendor,
    onChange: e => setFormData({
      ...formData,
      vendor: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select vendor..."), vendors.map(v => /*#__PURE__*/React.createElement("option", {
    key: v.id,
    value: v.name
  }, v.name)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Purchase Date"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: formData.purchaseDate,
    onChange: e => setFormData({
      ...formData,
      purchaseDate: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Cost ($)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    step: "0.01",
    value: formData.cost,
    onChange: e => setFormData({
      ...formData,
      cost: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Warranty Expiration"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: formData.warranty,
    onChange: e => setFormData({
      ...formData,
      warranty: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData({
      ...formData,
      notes: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    rows: "2"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-4"
  }, /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "btn-equipment-primary flex-1"
  }, item ? 'Update' : 'Add', " Equipment"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "btn-equipment-secondary"
  }, "Cancel"))))));
}

// Vendor Modal
function VendorModal({
  item,
  onSave,
  onClose
}) {
  const [formData, setFormData] = useState(item || {
    name: '',
    contactPerson: '',
    phone: '',
    email: '',
    website: '',
    categories: [],
    paymentTerms: 'Net 30',
    preferred: false,
    notes: ''
  });
  const [categoryInput, setCategoryInput] = useState('');
  const addCategory = () => {
    if (categoryInput.trim() && !formData.categories.includes(categoryInput.trim())) {
      setFormData({
        ...formData,
        categories: [...formData.categories, categoryInput.trim()]
      });
      setCategoryInput('');
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-overlay",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "equipment-modal-content",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-4"
  }, item ? 'Edit' : 'Add', " Vendor"), /*#__PURE__*/React.createElement("form", {
    onSubmit: e => {
      e.preventDefault();
      onSave(formData);
    },
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Vendor Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    required: true,
    value: formData.name,
    onChange: e => setFormData({
      ...formData,
      name: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Contact Person"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.contactPerson,
    onChange: e => setFormData({
      ...formData,
      contactPerson: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Phone"), /*#__PURE__*/React.createElement("input", {
    type: "tel",
    value: formData.phone,
    onChange: e => setFormData({
      ...formData,
      phone: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded font-mono"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Email"), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: formData.email,
    onChange: e => setFormData({
      ...formData,
      email: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Website"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.website,
    onChange: e => setFormData({
      ...formData,
      website: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Payment Terms"), /*#__PURE__*/React.createElement("select", {
    value: formData.paymentTerms,
    onChange: e => setFormData({
      ...formData,
      paymentTerms: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Net 30"
  }, "Net 30"), /*#__PURE__*/React.createElement("option", {
    value: "Net 60"
  }, "Net 60"), /*#__PURE__*/React.createElement("option", {
    value: "Due on Receipt"
  }, "Due on Receipt"), /*#__PURE__*/React.createElement("option", {
    value: "COD"
  }, "COD"))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-end"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: formData.preferred,
    onChange: e => setFormData({
      ...formData,
      preferred: e.target.checked
    }),
    className: "w-4 h-4",
    style: {
      accentColor: '#C8102E'
    }
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, "Preferred Vendor")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Categories"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mb-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: categoryInput,
    onChange: e => setCategoryInput(e.target.value),
    onKeyPress: e => e.key === 'Enter' && (e.preventDefault(), addCategory()),
    className: "flex-1 px-3 py-2 border border-gray-300 rounded",
    placeholder: "Add category..."
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: addCategory,
    className: "btn-equipment-secondary"
  }, "Add")), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, formData.categories.map((cat, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    className: "equipment-badge bg-blue-100 text-blue-800 flex items-center gap-1"
  }, cat, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setFormData({
      ...formData,
      categories: formData.categories.filter(c => c !== cat)
    }),
    className: "text-red-500 hover:text-red-700 ml-1 font-bold"
  }, "\xD7"))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold mb-1"
  }, "Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData({
      ...formData,
      notes: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded",
    rows: "2"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-4"
  }, /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "btn-equipment-primary flex-1"
  }, item ? 'Update' : 'Add', " Vendor"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "btn-equipment-secondary"
  }, "Cancel"))))));
}

// Export for use in App.jsx
window.EquipmentApp = EquipmentApp;
})();


// ============================================================================
// FILE: PeopleModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA PEOPLE MODULE
// Extracted from App.jsx for better maintainability
// ============================================================================

// Memoized Employee Row Component - prevents re-renders when other rows change
const EmployeeRow = React.memo(function EmployeeRow({
  emp,
  isAdmin,
  onEdit,
  onInvite,
  onResend,
  onSetPassword,
  onMarkInactive,
  onReactivate,
  onDelete,
  getPermissionBadge,
  getAccessBadge
}) {
  const fullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix].filter(Boolean).join(' ');
  return /*#__PURE__*/React.createElement("tr", {
    className: "hover:bg-gray-50"
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, fullName || emp.name || 'Unnamed'), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, emp.email))), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm"
  }, emp.jobTitle || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm"
  }, emp.department || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm"
  }, emp.shift || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, getPermissionBadge(emp.permissions)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, getAccessBadge(emp)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 flex-wrap"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => onEdit(emp),
    className: "text-sm hover:underline",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, "Edit"), (emp.permissions === 'User' || emp.permissions === 'Admin') && emp.accessStatus !== 'invited' && emp.accessStatus !== 'active' && (emp.email ? /*#__PURE__*/React.createElement("button", {
    onClick: () => onInvite(emp),
    className: "text-sm hover:underline",
    style: {
      color: 'var(--autovol-red)'
    }
  }, "Send Invite") : /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400 italic"
  }, "Add email to invite")), emp.accessStatus === 'invited' && /*#__PURE__*/React.createElement("button", {
    onClick: () => onResend(emp),
    className: "text-sm text-orange-600 hover:underline"
  }, "Resend"), isAdmin && emp.email && (emp.permissions === 'User' || emp.permissions === 'Admin') && /*#__PURE__*/React.createElement("button", {
    onClick: () => onSetPassword(emp),
    className: "text-sm text-purple-600 hover:underline"
  }, "Set Password"), emp.isActive !== false ? /*#__PURE__*/React.createElement("button", {
    onClick: () => onMarkInactive(emp),
    className: "text-sm text-gray-500 hover:text-gray-700 hover:underline"
  }, "Mark Inactive") : /*#__PURE__*/React.createElement("button", {
    onClick: () => onReactivate(emp),
    className: "text-sm text-green-600 hover:underline"
  }, "Reactivate"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onDelete(emp.id),
    className: "text-sm text-gray-400 hover:text-red-600 hover:underline"
  }, "Remove"))));
});

// Helper to check if an ID is a valid UUID (Supabase uses UUIDs)
const isValidUUID = id => {
  if (!id || typeof id !== 'string') return false;
  // UUID v4 pattern
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return uuidPattern.test(id);
};

// People Module Component
function PeopleModule({
  employees,
  setEmployees,
  departments,
  setDepartments,
  productionStages,
  isAdmin
}) {
  const [activeView, setActiveView] = useState('directory');
  const [showEmployeeModal, setShowEmployeeModal] = useState(false);
  const [editingEmployee, setEditingEmployee] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [permissionFilter, setPermissionFilter] = useState('all');
  const [showInviteConfirm, setShowInviteConfirm] = useState(null);
  const [sortColumn, setSortColumn] = useState('name');
  const [sortDirection, setSortDirection] = useState('asc');

  // Department management state
  const [showDeptModal, setShowDeptModal] = useState(false);
  const [editingDept, setEditingDept] = useState(null);
  const [showDeleteDeptConfirm, setShowDeleteDeptConfirm] = useState(null);

  // Inactive employee state
  const [showInactiveModal, setShowInactiveModal] = useState(null);
  const [showInactiveFilter, setShowInactiveFilter] = useState(false);

  // Password set modal state
  const [showPasswordModal, setShowPasswordModal] = useState(null);
  const [newPassword, setNewPassword] = useState('');
  const [settingPassword, setSettingPassword] = useState(false);
  const handleSort = column => {
    if (sortColumn === column) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortColumn(column);
      setSortDirection('asc');
    }
  };
  const getSortValue = (emp, column) => {
    if (!emp) return '';
    switch (column) {
      case 'name':
        return [emp.lastName, emp.firstName].filter(Boolean).join(' ').toLowerCase();
      case 'lastName':
        return (emp.lastName || '').toLowerCase();
      case 'jobTitle':
        return (emp.jobTitle || '').toLowerCase();
      case 'department':
        return (emp.department || '').toLowerCase();
      case 'shift':
        return (emp.shift || '').toLowerCase();
      case 'permissions':
        const permOrder = {
          'Admin': 0,
          'User': 1,
          'No Access': 2
        };
        return permOrder[emp.permissions] ?? 3;
      case 'accessStatus':
        const statusOrder = {
          'active': 0,
          'invited': 1,
          'none': 2
        };
        return statusOrder[emp.accessStatus] ?? 3;
      default:
        return '';
    }
  };
  const filteredEmployees = (employees || []).filter(e => {
    if (!e) return false;
    // Filter by active/inactive status
    const isActive = e.isActive !== false; // Default to active if not set
    if (!showInactiveFilter && !isActive) return false; // Hide inactive unless filter is on
    if (showInactiveFilter && isActive) return false; // When showing inactive, hide active

    const searchLower = (searchTerm || '').toLowerCase();
    const fullName = [e.prefix, e.firstName, e.middleName, e.lastName, e.suffix].filter(Boolean).join(' ').toLowerCase();
    const matchesSearch = !searchTerm || fullName.includes(searchLower) || (e.name || '').toLowerCase().includes(searchLower) || (e.department || '').toLowerCase().includes(searchLower) || (e.jobTitle || '').toLowerCase().includes(searchLower) || (e.email || '').toLowerCase().includes(searchLower);
    const matchesPermission = permissionFilter === 'all' || e.permissions === permissionFilter;
    return matchesSearch && matchesPermission;
  }).sort((a, b) => {
    const aVal = getSortValue(a, sortColumn);
    const bVal = getSortValue(b, sortColumn);
    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });
  const SortHeader = ({
    column,
    label
  }) => /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200 select-none",
    onClick: () => handleSort(column)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, label, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, sortColumn === column ? sortDirection === 'asc' ? '▲' : '▼' : '⇅')));

  // State for async operations
  const [saving, setSaving] = useState(false);
  const [inviting, setInviting] = useState(false);
  const [actionMessage, setActionMessage] = useState('');
  const handleSaveEmployee = async employeeData => {
    console.log('[PeopleModule] handleSaveEmployee called with:', employeeData);
    setSaving(true);
    setActionMessage('');
    try {
      let newEmployee;
      const fullName = [employeeData.firstName, employeeData.lastName].filter(Boolean).join(' ');
      if (editingEmployee) {
        // Update existing employee
        const updated = {
          ...editingEmployee,
          ...employeeData
        };
        setEmployees(employees.map(e => e.id === editingEmployee.id ? updated : e));

        // If user has Supabase account and dashboard role changed, update in Supabase
        if (editingEmployee.supabaseUserId && employeeData.dashboardRole && employeeData.dashboardRole !== editingEmployee.dashboardRole) {
          try {
            const result = await window.MODA_SUPABASE?.updateUserRole(editingEmployee.supabaseUserId, employeeData.dashboardRole);
            if (result?.success) {
              console.log('[PeopleModule] Dashboard role updated in Supabase:', employeeData.dashboardRole);
            } else {
              console.warn('[PeopleModule] Failed to update role in Supabase:', result?.error);
            }
          } catch (err) {
            console.warn('[PeopleModule] Error updating role in Supabase:', err.message);
          }
        }
        setActionMessage(`Updated ${fullName}`);
      } else {
        // Create new employee
        const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();
        if (useSupabase) {
          // Try Supabase with timeout
          try {
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000));
            const createPromise = window.MODA_SUPABASE_DATA.employees.create(employeeData);
            newEmployee = await Promise.race([createPromise, timeoutPromise]);
            console.log('[PeopleModule] Created in Supabase:', newEmployee);
          } catch (err) {
            console.warn('[PeopleModule] Supabase failed, using local:', err.message);
            newEmployee = {
              ...employeeData,
              id: `emp_${Date.now()}`,
              accessStatus: 'none',
              createdAt: new Date().toISOString()
            };
          }
        } else {
          // Local storage fallback
          newEmployee = {
            ...employeeData,
            id: `emp_${Date.now()}`,
            accessStatus: 'none',
            createdAt: new Date().toISOString()
          };
        }
        setEmployees(prev => [...prev, newEmployee]);
        console.log('[PeopleModule] Employee added:', newEmployee);
        setActionMessage(`Added ${fullName} to directory`);
      }

      // Close modal after short delay to show success message
      setTimeout(() => {
        setShowEmployeeModal(false);
        setEditingEmployee(null);
        setActionMessage('');
      }, 1000);
    } catch (error) {
      console.error('[PeopleModule] Save error:', error);
      setActionMessage(`Error: ${error.message}`);
    } finally {
      setSaving(false);
    }
  };
  const handleDeleteEmployee = async id => {
    console.log('[PeopleModule] handleDeleteEmployee called for:', id);
    if (!confirm('Are you sure you want to remove this employee?')) return;
    try {
      const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();
      console.log('[PeopleModule] useSupabase:', useSupabase);

      // Only delete from Supabase if employee has a valid UUID (not a local emp_* ID)
      if (useSupabase && isValidUUID(id)) {
        await window.MODA_SUPABASE_DATA.employees.delete(id);
      } else if (useSupabase && !isValidUUID(id)) {
        console.log('[PeopleModule] Skipping Supabase delete - employee has local ID:', id);
      }
      setEmployees(employees.filter(e => e.id !== id));
      console.log('[PeopleModule] Employee removed from UI');
    } catch (error) {
      console.error('[PeopleModule] Delete error:', error);
      alert(`Error deleting employee: ${error.message}`);
    }
  };
  const handleSendInvite = async employee => {
    console.log('[PeopleModule] handleSendInvite called for:', employee.email);
    const empName = [employee.prefix, employee.firstName, employee.middleName, employee.lastName, employee.suffix].filter(Boolean).join(' ') || employee.name || 'Employee';
    setInviting(true);
    setShowInviteConfirm(null);
    try {
      // Check if user already exists
      console.log('[PeopleModule] Checking if user exists...');
      const existingUser = await window.MODA_SUPABASE?.checkUserByEmail(employee.email);
      console.log('[PeopleModule] existingUser result:', existingUser);
      if (existingUser?.exists) {
        // User already has account - just link them
        const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();

        // Only update Supabase if employee has a valid UUID (not a local emp_* ID)
        if (useSupabase && isValidUUID(employee.id)) {
          await window.MODA_SUPABASE_DATA.employees.update(employee.id, {
            supabaseUserId: existingUser.user.id,
            accessStatus: 'active'
          });
        } else if (useSupabase && !isValidUUID(employee.id)) {
          console.log('[PeopleModule] Skipping Supabase update - employee has local ID:', employee.id);
        }
        setEmployees(employees.map(e => e.id === employee.id ? {
          ...e,
          supabaseUserId: existingUser.user.id,
          accessStatus: 'active'
        } : e));
        alert(`${empName} already has a MODA account and has been linked!\n\nNo invite email needed - they can log in immediately.`);
        return;
      }

      // Send invite via Supabase Edge Function
      const result = await window.MODA_SUPABASE?.inviteUser(employee.email, {
        name: empName,
        dashboardRole: employee.permissions === 'Admin' ? 'admin' : 'employee',
        invitedBy: window.MODA_SUPABASE?.userProfile?.name || 'MODA Admin'
      });
      if (result?.success) {
        // Update employee status
        const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();

        // Only update Supabase if employee has a valid UUID (not a local emp_* ID)
        // The Edge Function already updates by email, so this is just for consistency
        if (useSupabase && isValidUUID(employee.id)) {
          await window.MODA_SUPABASE_DATA.employees.update(employee.id, {
            accessStatus: 'invited'
          });
        } else if (useSupabase && !isValidUUID(employee.id)) {
          console.log('[PeopleModule] Skipping Supabase update - employee has local ID:', employee.id);
        }
        setEmployees(employees.map(e => e.id === employee.id ? {
          ...e,
          accessStatus: 'invited',
          invitedAt: new Date().toISOString()
        } : e));
        alert(`Invite sent to ${empName} at ${employee.email}!\n\nThey will receive an email with a link to set up their password.`);
      } else {
        throw new Error(result?.error || 'Failed to send invite');
      }
    } catch (error) {
      console.error('[PeopleModule] Invite error:', error);
      alert(`Error sending invite: ${error.message}`);
    } finally {
      setInviting(false);
    }
  };
  const handleResendInvite = async employee => {
    // Resend is the same as send
    await handleSendInvite(employee);
  };

  // Admin function to set password directly
  const handleSetPassword = async () => {
    if (!showPasswordModal || !newPassword) return;
    if (newPassword.length < 6) {
      alert('Password must be at least 6 characters');
      return;
    }
    setSettingPassword(true);
    try {
      const result = await window.MODA_SUPABASE?.adminSetPassword(showPasswordModal.email, newPassword);
      if (result?.success) {
        // Update employee status to active
        setEmployees(employees.map(e => e.id === showPasswordModal.id ? {
          ...e,
          accessStatus: 'active'
        } : e));
        alert(`Password set successfully for ${showPasswordModal.email}!\n\nThey can now log in with this password.`);
        setShowPasswordModal(null);
        setNewPassword('');
      } else {
        throw new Error(result?.error || 'Failed to set password');
      }
    } catch (error) {
      console.error('[PeopleModule] Set password error:', error);
      alert(`Error setting password: ${error.message}`);
    } finally {
      setSettingPassword(false);
    }
  };

  // Mark employee as inactive with reason and notes
  const handleMarkInactive = async (employee, inactiveReason, inactiveNotes) => {
    try {
      const updateData = {
        isActive: false,
        inactiveReason: inactiveReason,
        inactiveNotes: inactiveNotes,
        inactiveDate: new Date().toISOString().split('T')[0] // YYYY-MM-DD
      };
      const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();

      // Only update Supabase if employee has a valid UUID (not a local emp_* ID)
      if (useSupabase && isValidUUID(employee.id)) {
        await window.MODA_SUPABASE_DATA.employees.update(employee.id, updateData);
      } else if (useSupabase && !isValidUUID(employee.id)) {
        console.log('[PeopleModule] Skipping Supabase update - employee has local ID:', employee.id);
      }
      setEmployees(employees.map(e => e.id === employee.id ? {
        ...e,
        ...updateData
      } : e));
      const empName = [employee.firstName, employee.lastName].filter(Boolean).join(' ');
      setActionMessage(`${empName} marked as inactive`);
      setShowInactiveModal(null);
      setTimeout(() => setActionMessage(''), 3000);
    } catch (error) {
      console.error('[PeopleModule] Mark inactive error:', error);
      alert(`Error marking employee inactive: ${error.message}`);
    }
  };

  // Reactivate an inactive employee
  const handleReactivate = async employee => {
    if (!confirm(`Reactivate ${employee.firstName} ${employee.lastName}?`)) return;
    try {
      const updateData = {
        isActive: true,
        inactiveReason: null,
        inactiveNotes: null,
        inactiveDate: null
      };
      const useSupabase = window.MODA_SUPABASE_DATA?.isAvailable?.();

      // Only update Supabase if employee has a valid UUID (not a local emp_* ID)
      if (useSupabase && isValidUUID(employee.id)) {
        await window.MODA_SUPABASE_DATA.employees.update(employee.id, updateData);
      } else if (useSupabase && !isValidUUID(employee.id)) {
        console.log('[PeopleModule] Skipping Supabase update - employee has local ID:', employee.id);
      }
      setEmployees(employees.map(e => e.id === employee.id ? {
        ...e,
        ...updateData
      } : e));
      setActionMessage(`${employee.firstName} ${employee.lastName} reactivated`);
      setTimeout(() => setActionMessage(''), 3000);
    } catch (error) {
      console.error('[PeopleModule] Reactivate error:', error);
      alert(`Error reactivating employee: ${error.message}`);
    }
  };
  const updateDepartmentSupervisor = (deptId, supervisorId) => {
    setDepartments(departments.map(d => d.id === deptId ? {
      ...d,
      supervisor: supervisorId
    } : d));
  };

  // Department management functions
  const handleAddDepartment = () => {
    setEditingDept({
      id: '',
      name: '',
      supervisor: null,
      linkedStationId: null
    });
    setShowDeptModal(true);
  };
  const handleEditDepartment = dept => {
    setEditingDept({
      ...dept
    });
    setShowDeptModal(true);
  };
  const handleSaveDepartment = deptData => {
    if (editingDept.id) {
      // Editing existing - also update employees if name changed
      const oldName = departments.find(d => d.id === editingDept.id)?.name;
      setDepartments(departments.map(d => d.id === editingDept.id ? {
        ...d,
        ...deptData
      } : d));
      if (oldName && oldName !== deptData.name) {
        setEmployees(employees.map(e => e.department === oldName ? {
          ...e,
          department: deptData.name
        } : e));
      }
    } else {
      // Adding new
      const newDept = {
        ...deptData,
        id: deptData.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now(),
        employeeCount: 0
      };
      setDepartments([...departments, newDept]);
    }
    setShowDeptModal(false);
    setEditingDept(null);
  };
  const handleDeleteDepartment = dept => {
    const deptEmployees = employees.filter(e => e.department === dept.name);
    if (deptEmployees.length > 0) {
      // Has employees - show confirmation
      setShowDeleteDeptConfirm(dept);
    } else {
      // No employees - delete immediately
      setDepartments(departments.filter(d => d.id !== dept.id));
    }
  };
  const confirmDeleteDepartment = () => {
    if (showDeleteDeptConfirm) {
      // Unassign employees from this department
      setEmployees(employees.map(e => e.department === showDeleteDeptConfirm.name ? {
        ...e,
        department: ''
      } : e));
      // Delete the department
      setDepartments(departments.filter(d => d.id !== showDeleteDeptConfirm.id));
      setShowDeleteDeptConfirm(null);
    }
  };
  const getLinkedStationName = stationId => {
    if (!stationId || !productionStages) return null;
    const station = productionStages.find(s => s.id === stationId);
    return station ? station.dept : null;
  };

  // Permission counts
  const permissionCounts = {
    all: employees.length,
    'No Access': employees.filter(e => e.permissions === 'No Access' || !e.permissions).length,
    'User': employees.filter(e => e.permissions === 'User').length,
    'Admin': employees.filter(e => e.permissions === 'Admin').length
  };

  // Access status badge
  const getAccessBadge = emp => {
    if (emp.permissions === 'No Access' || !emp.permissions) {
      return /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600"
      }, "No Access");
    }
    if (emp.accessStatus === 'invited') {
      return /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs rounded bg-yellow-100 text-yellow-800"
      }, "Invited");
    }
    if (emp.accessStatus === 'active') {
      return /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs rounded bg-green-100 text-green-800"
      }, "Active");
    }
    // Has permission but not invited yet
    return /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-0.5 text-xs rounded bg-orange-100 text-orange-800"
    }, "Pending Invite");
  };

  // Permission badge
  const getPermissionBadge = permission => {
    if (permission === 'Admin') {
      return /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs rounded text-white",
        style: {
          backgroundColor: 'var(--autovol-red)'
        }
      }, "Admin");
    }
    if (permission === 'User') {
      return /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs rounded text-white",
        style: {
          backgroundColor: 'var(--autovol-teal)'
        }
      }, "User");
    }
    return /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-0.5 text-xs rounded bg-gray-200 text-gray-600"
    }, "No Access");
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-autovol-navy"
  }, "People"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('directory'),
    className: `px-3 py-1 rounded ${activeView === 'directory' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`
  }, "Directory"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('departments'),
    className: `px-3 py-1 rounded ${activeView === 'departments' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`
  }, "Departments"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveView('training'),
    className: `px-3 py-1 rounded ${activeView === 'training' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`
  }, "Training"))), activeView === 'training' ? /*#__PURE__*/React.createElement(TrainingMatrixView, {
    employees: employees,
    currentUser: "Admin",
    isAdmin: isAdmin
  }) : activeView === 'directory' ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-4 items-center"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by name, department, title, email...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "flex-1 min-w-64 px-3 py-2 border rounded-lg"
  }), /*#__PURE__*/React.createElement("select", {
    value: permissionFilter,
    onChange: e => setPermissionFilter(e.target.value),
    className: "px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Permissions (", permissionCounts.all, ")"), /*#__PURE__*/React.createElement("option", {
    value: "No Access"
  }, "No Access (", permissionCounts['No Access'], ")"), /*#__PURE__*/React.createElement("option", {
    value: "User"
  }, "User (", permissionCounts['User'], ")"), /*#__PURE__*/React.createElement("option", {
    value: "Admin"
  }, "Admin (", permissionCounts['Admin'], ")")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowInactiveFilter(!showInactiveFilter),
    className: `px-3 py-2 rounded-lg border ${showInactiveFilter ? 'bg-gray-700 text-white border-gray-700' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}`
  }, showInactiveFilter ? '← Back to Active' : 'View Inactive'), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEditingEmployee(null);
      setShowEmployeeModal(true);
    },
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "+ Add Employee")), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Showing ", filteredEmployees.length, " ", showInactiveFilter ? 'inactive' : 'active', " employees"), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-x-auto"
  }, filteredEmployees.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "No employees found. ", employees.length === 0 && 'Click "Add Employee" to get started.') : /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    style: {
      backgroundColor: 'var(--autovol-gray-bg)'
    }
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement(SortHeader, {
    column: "name",
    label: "Name"
  }), /*#__PURE__*/React.createElement(SortHeader, {
    column: "jobTitle",
    label: "Job Title"
  }), /*#__PURE__*/React.createElement(SortHeader, {
    column: "department",
    label: "Department"
  }), /*#__PURE__*/React.createElement(SortHeader, {
    column: "shift",
    label: "Shift"
  }), /*#__PURE__*/React.createElement(SortHeader, {
    column: "permissions",
    label: "Permissions"
  }), /*#__PURE__*/React.createElement(SortHeader, {
    column: "accessStatus",
    label: "Access Status"
  }), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, filteredEmployees.map(emp => /*#__PURE__*/React.createElement(EmployeeRow, {
    key: emp.id,
    emp: emp,
    isAdmin: isAdmin,
    onEdit: e => {
      setEditingEmployee(e);
      setShowEmployeeModal(true);
    },
    onInvite: e => setShowInviteConfirm(e),
    onResend: handleResendInvite,
    onSetPassword: e => setShowPasswordModal(e),
    onMarkInactive: e => setShowInactiveModal(e),
    onReactivate: handleReactivate,
    onDelete: handleDeleteEmployee,
    getPermissionBadge: getPermissionBadge,
    getAccessBadge: getAccessBadge
  })))))) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, isAdmin && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleAddDepartment,
    className: "px-4 py-2 btn-primary rounded-lg flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-lg"
  }, "+"), " Add Department")), /*#__PURE__*/React.createElement("div", {
    className: "grid gap-4 md:grid-cols-2 lg:grid-cols-3"
  }, departments.map(dept => {
    const supervisor = employees.find(e => e.id === dept.supervisor);
    const deptEmployees = employees.filter(e => e.department === dept.name);
    const linkedStation = productionStages.find(s => s.id === dept.linkedStationId);
    return /*#__PURE__*/React.createElement("div", {
      key: dept.id,
      className: "bg-white rounded-lg shadow p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between mb-2"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-semibold text-gray-900"
    }, dept.name), isAdmin && /*#__PURE__*/React.createElement("div", {
      className: "flex gap-1"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleEditDepartment(dept),
      className: "p-1 text-gray-400 hover:text-autovol-teal",
      title: "Edit department"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
    }))), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDeleteDepartment(dept),
      className: "p-1 text-gray-400 hover:text-red-500",
      title: "Delete department"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
    }))))), /*#__PURE__*/React.createElement("div", {
      className: "space-y-2 text-sm"
    }, linkedStation && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-0.5 text-xs rounded ${linkedStation.color} text-white`
    }, linkedStation.dept), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 text-xs"
    }, "Station Link")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Supervisor:"), /*#__PURE__*/React.createElement("select", {
      value: dept.supervisor || '',
      onChange: e => updateDepartmentSupervisor(dept.id, e.target.value || null),
      className: "ml-2 px-2 py-1 border rounded text-sm",
      disabled: !isAdmin
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "None assigned"), employees.map(emp => {
      const empFullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix].filter(Boolean).join(' ') || emp.name || 'Unnamed';
      return /*#__PURE__*/React.createElement("option", {
        key: emp.id,
        value: emp.id
      }, empFullName);
    }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Employees:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-2 font-medium"
    }, deptEmployees.length))));
  }))), showEmployeeModal && /*#__PURE__*/React.createElement(EmployeeModal, {
    employee: editingEmployee,
    onClose: () => {
      setShowEmployeeModal(false);
      setEditingEmployee(null);
      setActionMessage('');
    },
    onSave: handleSaveEmployee,
    departments: departments,
    saving: saving,
    successMessage: actionMessage
  }), showDeptModal && editingDept && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: () => {
      setShowDeptModal(false);
      setEditingDept(null);
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, editingDept.id ? 'Edit Department' : 'Add Department'), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Department Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editingDept.name,
    onChange: e => setEditingDept({
      ...editingDept,
      name: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal",
    placeholder: "e.g., Human Resources"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Linked Production Station"), /*#__PURE__*/React.createElement("select", {
    value: editingDept.linkedStationId || '',
    onChange: e => setEditingDept({
      ...editingDept,
      linkedStationId: e.target.value || null
    }),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "None (Non-Production)"), productionStages.map(stage => /*#__PURE__*/React.createElement("option", {
    key: stage.id,
    value: stage.id
  }, stage.dept, " - ", stage.name))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "Link to a station on the Production Board for tracking")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Supervisor"), /*#__PURE__*/React.createElement("select", {
    value: editingDept.supervisor || '',
    onChange: e => setEditingDept({
      ...editingDept,
      supervisor: e.target.value || null
    }),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-autovol-teal focus:border-autovol-teal"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "None assigned"), employees.map(emp => {
    const empFullName = [emp.prefix, emp.firstName, emp.middleName, emp.lastName, emp.suffix].filter(Boolean).join(' ') || emp.name || 'Unnamed';
    return /*#__PURE__*/React.createElement("option", {
      key: emp.id,
      value: emp.id
    }, empFullName);
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end mt-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowDeptModal(false);
      setEditingDept(null);
    },
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleSaveDepartment(editingDept),
    disabled: !editingDept.name.trim(),
    className: "px-4 py-2 btn-primary rounded-lg disabled:opacity-50"
  }, editingDept.id ? 'Save Changes' : 'Add Department')))), showDeleteDeptConfirm && (() => {
    const deptEmployees = employees.filter(e => e.department === showDeleteDeptConfirm.name);
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => setShowDeleteDeptConfirm(null)
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-bold mb-2 text-red-600"
    }, "Delete Department"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-4"
    }, "Are you sure you want to delete ", /*#__PURE__*/React.createElement("strong", null, showDeleteDeptConfirm.name), "?"), deptEmployees.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded-lg mb-4 bg-yellow-50 border border-yellow-200"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-yellow-800 font-medium"
    }, "\u26A0 Warning: This department has ", deptEmployees.length, " employee", deptEmployees.length !== 1 ? 's' : '', " assigned."), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-yellow-700 mt-1"
    }, "They will be unassigned from this department but not deleted.")), showDeleteDeptConfirm.linkedStationId && /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded-lg mb-4 bg-blue-50 border border-blue-200"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-blue-800"
    }, "This department is linked to a production station. The station board will not be affected.")), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 justify-end"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowDeleteDeptConfirm(null),
      className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: confirmDeleteDepartment,
      className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
    }, "Delete Department"))));
  })(), showInviteConfirm && (() => {
    const inviteeName = [showInviteConfirm.prefix, showInviteConfirm.firstName, showInviteConfirm.middleName, showInviteConfirm.lastName, showInviteConfirm.suffix].filter(Boolean).join(' ') || showInviteConfirm.name || 'this employee';
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => setShowInviteConfirm(null)
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-bold mb-2",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "Send Invite"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-4"
    }, "Send MODA access invite to ", /*#__PURE__*/React.createElement("strong", null, inviteeName), "?"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500 mb-4"
    }, "An email will be sent to: ", /*#__PURE__*/React.createElement("strong", null, showInviteConfirm.email)), /*#__PURE__*/React.createElement("div", {
      className: "p-3 rounded-lg mb-4",
      style: {
        backgroundColor: 'var(--autovol-gray-bg)'
      }
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Permission Level:"), ' ', /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, showInviteConfirm.permissions))), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 justify-end"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowInviteConfirm(null),
      className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleSendInvite(showInviteConfirm),
      className: "px-4 py-2 btn-primary rounded-lg"
    }, "Send Invite"))));
  })(), showInactiveModal && (() => {
    const emp = showInactiveModal;
    const empName = [emp.firstName, emp.lastName].filter(Boolean).join(' ');
    return /*#__PURE__*/React.createElement(MarkInactiveModal, {
      employee: emp,
      employeeName: empName,
      onClose: () => setShowInactiveModal(null),
      onConfirm: (reason, notes) => handleMarkInactive(emp, reason, notes)
    });
  })(), showPasswordModal && (() => {
    const emp = showPasswordModal;
    const empName = [emp.firstName, emp.lastName].filter(Boolean).join(' ') || emp.email;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
      onClick: () => {
        setShowPasswordModal(null);
        setNewPassword('');
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
      onClick: e => e.stopPropagation()
    }, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-bold mb-2",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "Set Password"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-4"
    }, "Set a password for ", /*#__PURE__*/React.createElement("strong", null, empName), " (", emp.email, ")"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500 mb-4"
    }, "This will allow the user to log in immediately with this password. Use this if email invites are not working."), /*#__PURE__*/React.createElement("div", {
      className: "mb-4"
    }, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "New Password ", /*#__PURE__*/React.createElement("span", {
      className: "text-red-500"
    }, "*")), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newPassword,
      onChange: e => setNewPassword(e.target.value),
      placeholder: "Enter password (min 6 characters)",
      className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400",
      autoFocus: true
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400 mt-1"
    }, "Password is shown in plain text so you can share it with the user")), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowPasswordModal(null);
        setNewPassword('');
      },
      className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",
      disabled: settingPassword
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: handleSetPassword,
      disabled: settingPassword || newPassword.length < 6,
      className: "px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
    }, settingPassword ? 'Setting...' : 'Set Password'))));
  })());
}

// Mark Inactive Modal Component
function MarkInactiveModal({
  employee,
  employeeName,
  onClose,
  onConfirm
}) {
  const [reason, setReason] = useState('');
  const [notes, setNotes] = useState('');
  const INACTIVE_REASONS = [{
    value: 'Termination',
    label: 'Termination'
  }, {
    value: 'Resignation',
    label: 'Resignation'
  }, {
    value: 'Leave-of-Absence',
    label: 'Leave of Absence'
  }, {
    value: 'Deceased',
    label: 'Deceased'
  }, {
    value: 'Other',
    label: 'Other'
  }];
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold mb-2 text-gray-800"
  }, "Mark Employee Inactive"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-4"
  }, "Mark ", /*#__PURE__*/React.createElement("strong", null, employeeName), " as inactive?"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Inactive Reason ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("select", {
    value: reason,
    onChange: e => setReason(e.target.value),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-gray-400"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select reason..."), INACTIVE_REASONS.map(r => /*#__PURE__*/React.createElement("option", {
    key: r.value,
    value: r.value
  }, r.label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Notes (optional)"), /*#__PURE__*/React.createElement("textarea", {
    value: notes,
    onChange: e => setNotes(e.target.value),
    placeholder: "Add any additional details...",
    rows: 3,
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-gray-400 resize-none"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end mt-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onConfirm(reason, notes),
    disabled: !reason,
    className: "px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Mark Inactive"))));
}

// Employee Modal (Add/Edit)
function EmployeeModal({
  employee,
  onClose,
  onSave,
  departments,
  saving,
  successMessage
}) {
  const [formData, setFormData] = useState({
    prefix: employee?.prefix || '',
    firstName: employee?.firstName || '',
    middleName: employee?.middleName || '',
    lastName: employee?.lastName || '',
    suffix: employee?.suffix || '',
    jobTitle: employee?.jobTitle || '',
    department: employee?.department || '',
    shift: employee?.shift || 'N/A',
    hireDate: employee?.hireDate || '',
    birthDate: employee?.birthDate || '',
    email: employee?.email || '',
    phone: employee?.phone || '',
    company: employee?.company || 'Autovol',
    permissions: employee?.permissions || 'No Access',
    dashboardRole: employee?.dashboardRole || 'employee',
    accessStatus: employee?.accessStatus || 'none'
  });

  // State for custom permissions editor
  const [showCustomPermissions, setShowCustomPermissions] = useState(false);
  const [hasCustomPermissions, setHasCustomPermissions] = useState(false);

  // Check if user has custom permissions on load
  useEffect(() => {
    if (employee?.supabaseUserId) {
      window.MODA_SUPABASE?.getUserCustomPermissions(employee.supabaseUserId).then(result => {
        if (result?.hasCustomPermissions) {
          setHasCustomPermissions(true);
        }
      }).catch(() => {});
    }
  }, [employee?.supabaseUserId]);
  const dashboardRoles = window.DEFAULT_DASHBOARD_ROLES || [{
    id: 'admin',
    name: 'Admin'
  }, {
    id: 'executive',
    name: 'Executive'
  }, {
    id: 'department-supervisor',
    name: 'Department Supervisor'
  }, {
    id: 'coordinator',
    name: 'Coordinator'
  }, {
    id: 'employee',
    name: 'Employee'
  }];
  const [showInvitePrompt, setShowInvitePrompt] = useState(false);
  const handlePermissionChange = newPermission => {
    const wasNoAccess = formData.permissions === 'No Access' || !formData.permissions;
    const nowHasAccess = newPermission === 'User' || newPermission === 'Admin';
    setFormData({
      ...formData,
      permissions: newPermission
    });

    // Show invite prompt when upgrading from No Access to User/Admin
    if (wasNoAccess && nowHasAccess && formData.email) {
      setShowInvitePrompt(true);
    } else {
      setShowInvitePrompt(false);
    }
  };
  const handleSubmit = () => {
    console.log('[EmployeeModal] handleSubmit called with formData:', formData);
    onSave(formData);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",
    style: {
      zIndex: 9999
    },
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, employee ? 'Edit Employee' : 'Add Employee'), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7")), successMessage && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 rounded-lg text-sm font-medium",
    style: {
      backgroundColor: '#E6F4F5',
      color: '#007B8A'
    }
  }, successMessage), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-6 gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "col-span-1"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Prefix"), /*#__PURE__*/React.createElement("select", {
    value: formData.prefix,
    onChange: e => setFormData({
      ...formData,
      prefix: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }), /*#__PURE__*/React.createElement("option", {
    value: "Mr."
  }, "Mr."), /*#__PURE__*/React.createElement("option", {
    value: "Mrs."
  }, "Mrs."), /*#__PURE__*/React.createElement("option", {
    value: "Ms."
  }, "Ms."), /*#__PURE__*/React.createElement("option", {
    value: "Dr."
  }, "Dr."))), /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "First Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.firstName,
    onChange: e => setFormData({
      ...formData,
      firstName: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Middle Name"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.middleName,
    onChange: e => setFormData({
      ...formData,
      middleName: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", {
    className: "col-span-1"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Suffix"), /*#__PURE__*/React.createElement("select", {
    value: formData.suffix,
    onChange: e => setFormData({
      ...formData,
      suffix: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }), /*#__PURE__*/React.createElement("option", {
    value: "Jr."
  }, "Jr."), /*#__PURE__*/React.createElement("option", {
    value: "Sr."
  }, "Sr."), /*#__PURE__*/React.createElement("option", {
    value: "II"
  }, "II"), /*#__PURE__*/React.createElement("option", {
    value: "III"
  }, "III"), /*#__PURE__*/React.createElement("option", {
    value: "IV"
  }, "IV")))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Last Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.lastName,
    onChange: e => setFormData({
      ...formData,
      lastName: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Job Title"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.jobTitle,
    onChange: e => setFormData({
      ...formData,
      jobTitle: e.target.value
    }),
    placeholder: "e.g., Framer, Electrician",
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Department *"), /*#__PURE__*/React.createElement("select", {
    value: formData.department,
    onChange: e => setFormData({
      ...formData,
      department: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select department..."), departments.map(d => /*#__PURE__*/React.createElement("option", {
    key: d.id,
    value: d.name
  }, d.name)))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Shift"), /*#__PURE__*/React.createElement("select", {
    value: formData.shift,
    onChange: e => setFormData({
      ...formData,
      shift: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "N/A"
  }, "N/A"), /*#__PURE__*/React.createElement("option", {
    value: "Shift-A"
  }, "Shift-A (Mon-Thu)"), /*#__PURE__*/React.createElement("option", {
    value: "Shift-B"
  }, "Shift-B (Fri-Sun)"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Hire Date"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: formData.hireDate,
    onChange: e => setFormData({
      ...formData,
      hireDate: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Birth Date"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: formData.birthDate,
    onChange: e => setFormData({
      ...formData,
      birthDate: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Email"), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: formData.email,
    onChange: e => setFormData({
      ...formData,
      email: e.target.value
    }),
    placeholder: "email@autovol.com",
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Phone"), /*#__PURE__*/React.createElement("input", {
    type: "tel",
    value: formData.phone,
    onChange: e => setFormData({
      ...formData,
      phone: e.target.value
    }),
    placeholder: "(555) 123-4567",
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Company"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.company,
    onChange: e => setFormData({
      ...formData,
      company: e.target.value
    }),
    placeholder: "Autovol",
    className: "w-full px-3 py-2 border rounded-lg"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "Defaults to Autovol for internal employees")), /*#__PURE__*/React.createElement("div", {
    className: "border-t pt-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "MODA Permissions"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, ['No Access', 'User', 'Admin'].map(perm => /*#__PURE__*/React.createElement("button", {
    key: perm,
    type: "button",
    onClick: () => handlePermissionChange(perm),
    className: `flex-1 px-3 py-2 rounded-lg border-2 text-sm font-medium transition ${formData.permissions === perm ? perm === 'Admin' ? 'border-red-500 bg-red-50 text-red-700' : perm === 'User' ? 'border-teal-500 bg-teal-50 text-teal-700' : 'border-gray-400 bg-gray-100 text-gray-700' : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300'}`
  }, perm))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, formData.permissions === 'No Access' && 'Employee is in directory only - no MODA login access', formData.permissions === 'User' && 'Can view and update production data in MODA', formData.permissions === 'Admin' && 'Full MODA access including user management'), showInvitePrompt && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 p-3 rounded-lg",
    style: {
      backgroundColor: 'var(--autovol-red-light)'
    }
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm",
    style: {
      color: 'var(--autovol-red)'
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Note:"), " After saving, you'll be able to send an invite to this employee's email.")), !formData.email && (formData.permissions === 'User' || formData.permissions === 'Admin') && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 p-3 rounded-lg bg-yellow-50"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-yellow-800"
  }, /*#__PURE__*/React.createElement("strong", null, "Note:"), " Add an email address to enable sending invites."))), /*#__PURE__*/React.createElement("div", {
    className: "border-t pt-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Dashboard Role"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("select", {
    value: formData.dashboardRole,
    onChange: e => setFormData({
      ...formData,
      dashboardRole: e.target.value
    }),
    disabled: formData.permissions === 'No Access',
    className: `flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 ${formData.permissions === 'No Access' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : ''}`
  }, dashboardRoles.filter(r => r.id !== 'no-access').map(role => /*#__PURE__*/React.createElement("option", {
    key: role.id,
    value: role.id
  }, role.name))), employee?.supabaseUserId && formData.permissions !== 'No Access' && /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setShowCustomPermissions(true),
    className: `px-3 py-2 rounded-lg border-2 text-sm font-medium whitespace-nowrap ${hasCustomPermissions ? 'border-amber-500 bg-amber-50 text-amber-700' : 'border-gray-300 bg-white text-gray-600 hover:border-teal-500 hover:text-teal-600'}`
  }, hasCustomPermissions ? 'Edit Custom' : 'Customize')), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, formData.permissions === 'No Access' ? 'Set permissions to User or Admin to enable dashboard role selection' : hasCustomPermissions ? 'This user has custom tab permissions that override their role defaults' : dashboardRoles.find(r => r.id === formData.dashboardRole)?.description || 'Controls which tabs and features this user can access'), !employee?.supabaseUserId && formData.permissions !== 'No Access' && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-blue-600 mt-2"
  }, "Tip: After the user accepts their invite, you can set custom tab permissions for them.")), showCustomPermissions && employee?.supabaseUserId && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",
    style: {
      zIndex: 10000
    },
    onClick: () => setShowCustomPermissions(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6",
    onClick: e => e.stopPropagation()
  }, window.CustomPermissionsEditor ? /*#__PURE__*/React.createElement(window.CustomPermissionsEditor, {
    userId: employee.supabaseUserId,
    userEmail: employee.email,
    userName: [employee.firstName, employee.lastName].filter(Boolean).join(' '),
    userRole: formData.dashboardRole,
    onClose: () => setShowCustomPermissions(false),
    onSave: updatedUser => {
      setHasCustomPermissions(updatedUser.custom_tab_permissions != null && Object.keys(updatedUser.custom_tab_permissions).length > 0);
      setShowCustomPermissions(false);
    }
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, "Loading Custom Permissions Editor...")))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end mt-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSubmit,
    disabled: !formData.firstName || !formData.lastName || saving,
    className: "px-4 py-2 btn-primary rounded-lg disabled:opacity-50"
  }, saving ? 'Saving...' : employee ? 'Save Changes' : 'Add Employee')))));
}

// Export for use in App.jsx
window.PeopleModule = PeopleModule;
window.EmployeeModal = EmployeeModal;
})();


// ============================================================================
// FILE: ProjectsModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA PROJECTS DIRECTORY MODULE
// Extracted from App.jsx for better maintainability
// ============================================================================

// Projects Directory Component
function ProjectsDirectory({
  projects,
  setProjects,
  trashedProjects,
  setTrashedProjects,
  onSelectProject,
  showNewProjectModal,
  auth,
  exportData,
  importData
}) {
  const [statusFilter, setStatusFilter] = useState('all');
  const [editMode, setEditMode] = useState(false);
  const [editingProject, setEditingProject] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortField, setSortField] = useState('project_number');
  const [sortDirection, setSortDirection] = useState('desc');

  // Multi-field search filter
  const searchFilteredProjects = projects.filter(p => {
    if (!searchQuery.trim()) return true;
    const query = searchQuery.toLowerCase();
    return (p.name || '').toLowerCase().includes(query) || (p.customer || '').toLowerCase().includes(query) || (p.city || '').toLowerCase().includes(query) || (p.state || '').toLowerCase().includes(query) || (p.country || '').toLowerCase().includes(query) || (p.description || '').toLowerCase().includes(query);
  });

  // Status filter
  const statusFilteredProjects = searchFilteredProjects.filter(p => statusFilter === 'all' || p.status === statusFilter);

  // Helper: Get max serial number from project modules (for "newest" sorting)
  const getMaxSerial = project => {
    if (!project.modules || project.modules.length === 0) return -1;
    return Math.max(...project.modules.map(m => {
      const serial = m.serialNumber || '';
      const numPart = serial.replace(/\D/g, '');
      return parseInt(numPart, 10) || 0;
    }));
  };

  // Sorting
  const sortedProjects = [...statusFilteredProjects].sort((a, b) => {
    let aVal, bVal;
    if (sortField === 'project_number') {
      // Sort by project number (numeric)
      aVal = parseInt(a.project_number) || 0;
      bVal = parseInt(b.project_number) || 0;
    } else if (sortField === 'newest') {
      // Projects with 0 modules go first (to remind user to add data)
      const aHasModules = (a.modules?.length || 0) > 0;
      const bHasModules = (b.modules?.length || 0) > 0;
      if (!aHasModules && bHasModules) return -1;
      if (aHasModules && !bHasModules) return 1;
      // Then sort by max serial number (higher = newer)
      aVal = getMaxSerial(a);
      bVal = getMaxSerial(b);
    } else if (sortField === 'modules') {
      aVal = a.modules?.length || 0;
      bVal = b.modules?.length || 0;
    } else if (sortField === 'location') {
      aVal = `${a.city || ''}, ${a.state || ''}`.toLowerCase();
      bVal = `${b.city || ''}, ${b.state || ''}`.toLowerCase();
    } else {
      aVal = (a[sortField] || '').toString().toLowerCase();
      bVal = (b[sortField] || '').toString().toLowerCase();
    }
    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });
  const filteredProjects = sortedProjects;

  // Handle column header click for sorting
  const handleSort = field => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  // Sort indicator arrow
  const SortArrow = ({
    field
  }) => {
    if (sortField !== field) return /*#__PURE__*/React.createElement("span", {
      className: "text-gray-300 ml-1"
    }, "\u2195");
    return /*#__PURE__*/React.createElement("span", {
      className: "ml-1"
    }, sortDirection === 'asc' ? '↑' : '↓');
  };

  // Quick stats
  const totalModules = projects.reduce((sum, p) => sum + (p.modules?.length || 0), 0);
  const statusSummary = Object.entries({
    Active: projects.filter(p => p.status === 'Active').length,
    Complete: projects.filter(p => p.status === 'Complete').length,
    Planning: projects.filter(p => p.status === 'Planning').length,
    'On Hold': projects.filter(p => p.status === 'On Hold').length
  }).filter(([_, count]) => count > 0).map(([status, count]) => `${count} ${status}`).join(', ');
  const statusCounts = {
    'Pre-Construction': projects.filter(p => p.status === 'Pre-Construction').length,
    'Planned': projects.filter(p => p.status === 'Planned').length,
    'Active': projects.filter(p => p.status === 'Active').length,
    'Complete': projects.filter(p => p.status === 'Complete').length
  };

  // Move to trash instead of permanent delete
  const handleDeleteProject = project => {
    const trashedProject = {
      ...project,
      deletedAt: Date.now(),
      deletedBy: auth.currentUser?.name || 'Unknown'
    };
    setTrashedProjects([...trashedProjects, trashedProject]);
    setProjects(projects.filter(p => p.id !== project.id));
    setDeleteConfirm(null);
  };
  const handleUpdateProject = async updatedProject => {
    // Optimistic update to local state
    setProjects(projects.map(p => p.id === updatedProject.id ? {
      ...p,
      ...updatedProject
    } : p));
    setEditingProject(null);

    // Save to Supabase if available
    if (window.MODA_SUPABASE_DATA?.isAvailable?.() && window.MODA_SUPABASE_DATA?.projects?.update) {
      try {
        await window.MODA_SUPABASE_DATA.projects.update(updatedProject.id, updatedProject);
        console.log('[ProjectsDirectory] Project updated in Supabase:', updatedProject.id);
      } catch (err) {
        console.error('[ProjectsDirectory] Error saving to Supabase:', err);
      }
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-autovol-navy"
  }, "Project Directory"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, auth.isAdmin && /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditMode(!editMode),
    className: `px-4 py-2 rounded-lg transition flex items-center gap-2 ${editMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`
  }, editMode ? 'Done Editing' : 'Edit Projects'), /*#__PURE__*/React.createElement("button", {
    onClick: showNewProjectModal,
    className: "px-4 py-2 btn-primary rounded-lg transition flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", null, "+"), " New Project"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg px-4 py-3 flex items-center justify-between text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-gray-700"
  }, projects.length, " projects"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "|"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, totalModules.toLocaleString(), " total modules")), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, statusSummary)), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4 flex-wrap"
  }, /*#__PURE__*/React.createElement("div", {
    className: "relative flex-1 min-w-[250px]"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: searchQuery,
    onChange: e => setSearchQuery(e.target.value),
    placeholder: "Search projects by name, customer, city, state...",
    className: "w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }), /*#__PURE__*/React.createElement("svg", {
    className: "absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
  })), searchQuery && /*#__PURE__*/React.createElement("button", {
    onClick: () => setSearchQuery(''),
    className: "absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
  }, "x")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 flex-wrap"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setStatusFilter('all'),
    className: `px-3 py-1.5 rounded-full text-sm transition ${statusFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`
  }, "All (", projects.length, ")"), Object.entries(statusCounts).filter(([_, count]) => count > 0).map(([status, count]) => /*#__PURE__*/React.createElement("button", {
    key: status,
    onClick: () => setStatusFilter(status),
    className: `px-3 py-1.5 rounded-full text-sm transition ${statusFilter === status ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`
  }, status, " (", count, ")")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, filteredProjects.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, searchQuery ? `No projects match "${searchQuery}"` : 'No projects found. Click "New Project" to create one.')) : /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50 border-b"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none w-20",
    onClick: () => handleSort('project_number')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "# ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "project_number"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('name')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Project Name ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "name"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('customer')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Customer ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "customer"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('location')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Location ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "location"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('status')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Status ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "status"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('modules')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center justify-end"
  }, "Modules ", /*#__PURE__*/React.createElement(SortArrow, {
    field: "modules"
  }))), editMode && /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y divide-gray-100"
  }, filteredProjects.map(project => /*#__PURE__*/React.createElement("tr", {
    key: project.id,
    className: `${!editMode ? 'hover:bg-blue-50 cursor-pointer' : 'hover:bg-gray-50'} transition-colors`,
    onClick: () => !editMode && onSelectProject(project)
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600 font-medium"
  }, project.project_number || /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "-")), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, project.name), project.description && /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mt-0.5 truncate max-w-xs"
  }, project.description)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600"
  }, project.customer || /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "-")), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600"
  }, project.city || project.state || project.country ? /*#__PURE__*/React.createElement("span", null, project.city, project.city && project.state ? ', ' : '', project.state, project.country && project.country !== 'US' && ` (${project.country})`, !project.city && !project.state && project.country && project.country) : /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "-")), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: `inline-flex px-2 py-0.5 text-xs font-medium rounded-full ${project.status === 'Active' ? 'bg-green-100 text-green-800' : project.status === 'Complete' ? 'bg-gray-100 text-gray-800' : project.status === 'Planning' ? 'bg-blue-100 text-blue-800' : project.status === 'On Hold' ? 'bg-yellow-100 text-yellow-800' : 'bg-purple-100 text-purple-800'}`
  }, project.status)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600 text-right font-medium"
  }, project.modules?.length || 0), editMode && /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setEditingProject(project);
    },
    className: "px-2.5 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs font-medium"
  }, "Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setDeleteConfirm(project);
    },
    className: "px-2.5 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs font-medium"
  }, "Delete"))))))))), editingProject && /*#__PURE__*/React.createElement(EditProjectModal, {
    project: editingProject,
    onClose: () => setEditingProject(null),
    onSave: handleUpdateProject
  }), deleteConfirm && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: () => setDeleteConfirm(null)
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900 mb-4"
  }, "Move to Trash?"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-2"
  }, "Are you sure you want to delete ", /*#__PURE__*/React.createElement("strong", null, deleteConfirm.name), "?"), deleteConfirm.modules?.length > 0 && /*#__PURE__*/React.createElement("p", {
    className: "text-orange-600 text-sm mb-4"
  }, "\u26A0 This project has ", deleteConfirm.modules.length, " modules that will also be moved to trash."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mb-6"
  }, "\u2713 This project will be moved to Trash and can be restored within 90 days from the Data Management panel."), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setDeleteConfirm(null),
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleDeleteProject(deleteConfirm),
    className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
  }, "Move to Trash")))));
}

// Edit Project Modal
function EditProjectModal({
  project,
  onClose,
  onSave
}) {
  const [projectNumber, setProjectNumber] = useState(project.project_number || '');
  const [name, setName] = useState(project.name || '');
  const [abbreviation, setAbbreviation] = useState(project.abbreviation || '');
  const [address, setAddress] = useState(project.address || '');
  const [city, setCity] = useState(project.city || '');
  const [country, setCountry] = useState(project.country || 'US');
  const [state, setState] = useState(project.state || '');
  const [zipCode, setZipCode] = useState(project.zipCode || '');
  const [customer, setCustomer] = useState(project.customer || '');
  const [description, setDescription] = useState(project.description || '');
  const [status, setStatus] = useState(project.status || 'Planning');
  const isUS = country === 'US';
  const handleSubmit = e => {
    e.preventDefault();
    if (!name.trim()) return;
    onSave({
      ...project,
      project_number: projectNumber ? parseInt(projectNumber) : null,
      name: name.trim(),
      abbreviation: abbreviation.trim(),
      address: address.trim(),
      city: city.trim(),
      country,
      state,
      zipCode: zipCode.trim(),
      customer: customer.trim(),
      description: description.trim(),
      status
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold"
  }, "Edit Project"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-4 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Project #"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: projectNumber,
    onChange: e => setProjectNumber(e.target.value),
    placeholder: "e.g., 15",
    className: "w-full px-3 py-2 border rounded-lg text-center",
    min: "1"
  })), /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Project Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: name,
    onChange: e => setName(e.target.value),
    placeholder: "e.g., Alvarado Creek",
    className: "w-full px-3 py-2 border rounded-lg",
    required: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Abbrev."), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: abbreviation,
    onChange: e => setAbbreviation(e.target.value.toUpperCase()),
    placeholder: "AC",
    className: "w-full px-3 py-2 border rounded-lg text-center",
    maxLength: 6
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Country"), /*#__PURE__*/React.createElement("select", {
    value: country,
    onChange: e => {
      setCountry(e.target.value);
      setState('');
    },
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "US"
  }, "United States"), /*#__PURE__*/React.createElement("option", {
    value: "CA"
  }, "Canada"), /*#__PURE__*/React.createElement("option", {
    value: "MX"
  }, "Mexico"), /*#__PURE__*/React.createElement("option", {
    value: "OTHER"
  }, "Other"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Address *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: address,
    onChange: e => setAddress(e.target.value),
    placeholder: "e.g., 123 Main Street",
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "City *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: city,
    onChange: e => setCity(e.target.value),
    placeholder: "e.g., San Diego",
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, isUS ? 'State' : 'State/Province', " *"), isUS ? /*#__PURE__*/React.createElement("select", {
    value: state,
    onChange: e => setState(e.target.value),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), /*#__PURE__*/React.createElement("option", {
    value: "AL"
  }, "Alabama"), /*#__PURE__*/React.createElement("option", {
    value: "AK"
  }, "Alaska"), /*#__PURE__*/React.createElement("option", {
    value: "AZ"
  }, "Arizona"), /*#__PURE__*/React.createElement("option", {
    value: "AR"
  }, "Arkansas"), /*#__PURE__*/React.createElement("option", {
    value: "CA"
  }, "California"), /*#__PURE__*/React.createElement("option", {
    value: "CO"
  }, "Colorado"), /*#__PURE__*/React.createElement("option", {
    value: "CT"
  }, "Connecticut"), /*#__PURE__*/React.createElement("option", {
    value: "DE"
  }, "Delaware"), /*#__PURE__*/React.createElement("option", {
    value: "FL"
  }, "Florida"), /*#__PURE__*/React.createElement("option", {
    value: "GA"
  }, "Georgia"), /*#__PURE__*/React.createElement("option", {
    value: "HI"
  }, "Hawaii"), /*#__PURE__*/React.createElement("option", {
    value: "ID"
  }, "Idaho"), /*#__PURE__*/React.createElement("option", {
    value: "IL"
  }, "Illinois"), /*#__PURE__*/React.createElement("option", {
    value: "IN"
  }, "Indiana"), /*#__PURE__*/React.createElement("option", {
    value: "IA"
  }, "Iowa"), /*#__PURE__*/React.createElement("option", {
    value: "KS"
  }, "Kansas"), /*#__PURE__*/React.createElement("option", {
    value: "KY"
  }, "Kentucky"), /*#__PURE__*/React.createElement("option", {
    value: "LA"
  }, "Louisiana"), /*#__PURE__*/React.createElement("option", {
    value: "ME"
  }, "Maine"), /*#__PURE__*/React.createElement("option", {
    value: "MD"
  }, "Maryland"), /*#__PURE__*/React.createElement("option", {
    value: "MA"
  }, "Massachusetts"), /*#__PURE__*/React.createElement("option", {
    value: "MI"
  }, "Michigan"), /*#__PURE__*/React.createElement("option", {
    value: "MN"
  }, "Minnesota"), /*#__PURE__*/React.createElement("option", {
    value: "MS"
  }, "Mississippi"), /*#__PURE__*/React.createElement("option", {
    value: "MO"
  }, "Missouri"), /*#__PURE__*/React.createElement("option", {
    value: "MT"
  }, "Montana"), /*#__PURE__*/React.createElement("option", {
    value: "NE"
  }, "Nebraska"), /*#__PURE__*/React.createElement("option", {
    value: "NV"
  }, "Nevada"), /*#__PURE__*/React.createElement("option", {
    value: "NH"
  }, "New Hampshire"), /*#__PURE__*/React.createElement("option", {
    value: "NJ"
  }, "New Jersey"), /*#__PURE__*/React.createElement("option", {
    value: "NM"
  }, "New Mexico"), /*#__PURE__*/React.createElement("option", {
    value: "NY"
  }, "New York"), /*#__PURE__*/React.createElement("option", {
    value: "NC"
  }, "North Carolina"), /*#__PURE__*/React.createElement("option", {
    value: "ND"
  }, "North Dakota"), /*#__PURE__*/React.createElement("option", {
    value: "OH"
  }, "Ohio"), /*#__PURE__*/React.createElement("option", {
    value: "OK"
  }, "Oklahoma"), /*#__PURE__*/React.createElement("option", {
    value: "OR"
  }, "Oregon"), /*#__PURE__*/React.createElement("option", {
    value: "PA"
  }, "Pennsylvania"), /*#__PURE__*/React.createElement("option", {
    value: "RI"
  }, "Rhode Island"), /*#__PURE__*/React.createElement("option", {
    value: "SC"
  }, "South Carolina"), /*#__PURE__*/React.createElement("option", {
    value: "SD"
  }, "South Dakota"), /*#__PURE__*/React.createElement("option", {
    value: "TN"
  }, "Tennessee"), /*#__PURE__*/React.createElement("option", {
    value: "TX"
  }, "Texas"), /*#__PURE__*/React.createElement("option", {
    value: "UT"
  }, "Utah"), /*#__PURE__*/React.createElement("option", {
    value: "VT"
  }, "Vermont"), /*#__PURE__*/React.createElement("option", {
    value: "VA"
  }, "Virginia"), /*#__PURE__*/React.createElement("option", {
    value: "WA"
  }, "Washington"), /*#__PURE__*/React.createElement("option", {
    value: "WV"
  }, "West Virginia"), /*#__PURE__*/React.createElement("option", {
    value: "WI"
  }, "Wisconsin"), /*#__PURE__*/React.createElement("option", {
    value: "WY"
  }, "Wyoming"), /*#__PURE__*/React.createElement("option", {
    value: "DC"
  }, "Washington DC")) : /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: state,
    onChange: e => setState(e.target.value),
    placeholder: "e.g., Ontario",
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, isUS ? 'Zip Code' : 'Postal Code'), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: zipCode,
    onChange: e => setZipCode(e.target.value),
    placeholder: isUS ? 'e.g., 92101' : 'e.g., A1A 1A1',
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Status"), /*#__PURE__*/React.createElement("select", {
    value: status,
    onChange: e => setStatus(e.target.value),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Planning"
  }, "Planning"), /*#__PURE__*/React.createElement("option", {
    value: "Active"
  }, "Active"), /*#__PURE__*/React.createElement("option", {
    value: "On Hold"
  }, "On Hold"), /*#__PURE__*/React.createElement("option", {
    value: "Complete"
  }, "Complete"), /*#__PURE__*/React.createElement("option", {
    value: "Archived"
  }, "Archived")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Customer"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: customer,
    onChange: e => setCustomer(e.target.value),
    placeholder: "e.g., ABC Development Corp",
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description"), /*#__PURE__*/React.createElement("textarea", {
    value: description,
    onChange: e => setDescription(e.target.value),
    placeholder: "Phase 1 residential units...",
    className: "w-full px-3 py-2 border rounded-lg",
    rows: 2
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end pt-4"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "Save Changes"))))));
}

// Data Management Panel (Admin Only)
function DataManagementPanel({
  onClose,
  projects,
  setProjects,
  trashedProjects,
  setTrashedProjects,
  employees,
  setEmployees,
  trashedEmployees,
  setTrashedEmployees,
  exportData,
  importData
}) {
  const [activeTab, setActiveTab] = useState('trash');
  const [trashTab, setTrashTab] = useState('projects');
  const [confirmEmpty, setConfirmEmpty] = useState(false);
  const formatDate = timestamp => {
    if (!timestamp) return 'Unknown';
    return new Date(timestamp).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  const getDaysRemaining = deletedAt => {
    const ninetyDays = 90 * 24 * 60 * 60 * 1000;
    const expiresAt = deletedAt + ninetyDays;
    const remaining = Math.ceil((expiresAt - Date.now()) / (24 * 60 * 60 * 1000));
    return remaining;
  };
  const restoreProject = project => {
    const {
      deletedAt,
      deletedBy,
      ...cleanProject
    } = project;
    setProjects([...projects, cleanProject]);
    setTrashedProjects(trashedProjects.filter(p => p.id !== project.id));
  };
  const restoreEmployee = employee => {
    const {
      deletedAt,
      deletedBy,
      ...cleanEmployee
    } = employee;
    setEmployees([...employees, cleanEmployee]);
    setTrashedEmployees(trashedEmployees.filter(e => e.id !== employee.id));
  };
  const permanentlyDeleteProject = projectId => {
    setTrashedProjects(trashedProjects.filter(p => p.id !== projectId));
  };
  const permanentlyDeleteEmployee = employeeId => {
    setTrashedEmployees(trashedEmployees.filter(e => e.id !== employeeId));
  };
  const emptyTrash = () => {
    if (trashTab === 'projects') {
      setTrashedProjects([]);
    } else {
      setTrashedEmployees([]);
    }
    setConfirmEmpty(false);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b bg-gray-50 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, "\u2699"), /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, "Data Management")), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTab('trash'),
    className: `px-6 py-3 text-sm font-medium ${activeTab === 'trash' ? 'border-b-2 border-red-500 text-red-600' : 'text-gray-600'}`
  }, "\uD83D\uDDD1 Trash (", trashedProjects.length + trashedEmployees.length, ")"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTab('backup'),
    className: `px-6 py-3 text-sm font-medium ${activeTab === 'backup' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`
  }, "\uD83D\uDCBE Backup & Restore"))), /*#__PURE__*/React.createElement("div", {
    className: "p-6 overflow-y-auto",
    style: {
      maxHeight: 'calc(90vh - 140px)'
    }
  }, activeTab === 'trash' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setTrashTab('projects'),
    className: `px-4 py-2 rounded-lg text-sm font-medium ${trashTab === 'projects' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`
  }, "Projects (", trashedProjects.length, ")"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setTrashTab('employees'),
    className: `px-4 py-2 rounded-lg text-sm font-medium ${trashTab === 'employees' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`
  }, "Employees (", trashedEmployees.length, ")")), (trashTab === 'projects' && trashedProjects.length > 0 || trashTab === 'employees' && trashedEmployees.length > 0) && /*#__PURE__*/React.createElement("button", {
    onClick: () => setConfirmEmpty(true),
    className: "px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded"
  }, "Empty ", trashTab === 'projects' ? 'Projects' : 'Employees', " Trash")), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Items in trash are automatically deleted after 90 days."), trashTab === 'projects' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, trashedProjects.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "No deleted projects")) : trashedProjects.map(project => /*#__PURE__*/React.createElement("div", {
    key: project.id,
    className: "flex items-center justify-between p-3 border rounded-lg bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h4", {
    className: "font-medium text-gray-900"
  }, project.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, project.modules?.length || 0, " modules \u2022 Deleted ", formatDate(project.deletedAt)), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-orange-600"
  }, getDaysRemaining(project.deletedAt), " days until permanent deletion")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => restoreProject(project),
    className: "px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
  }, "Restore"), /*#__PURE__*/React.createElement("button", {
    onClick: () => permanentlyDeleteProject(project.id),
    className: "px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
  }, "Delete Forever"))))), trashTab === 'employees' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, trashedEmployees.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "No deleted employees")) : trashedEmployees.map(employee => /*#__PURE__*/React.createElement("div", {
    key: employee.id,
    className: "flex items-center justify-between p-3 border rounded-lg bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h4", {
    className: "font-medium text-gray-900"
  }, employee.firstName, " ", employee.lastName), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, employee.jobTitle, " \u2022 ", employee.department, " \u2022 Deleted ", formatDate(employee.deletedAt)), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-orange-600"
  }, getDaysRemaining(employee.deletedAt), " days until permanent deletion")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => restoreEmployee(employee),
    className: "px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
  }, "Restore"), /*#__PURE__*/React.createElement("button", {
    onClick: () => permanentlyDeleteEmployee(employee.id),
    className: "px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
  }, "Delete Forever")))))), activeTab === 'backup' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border rounded-lg"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900 mb-2"
  }, "\uD83D\uDCCB\xA4 Export Data"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mb-4"
  }, "Download a complete backup of all MODA data including projects, modules, employees, and trash."), /*#__PURE__*/React.createElement("button", {
    onClick: exportData,
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "Download Backup")), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border rounded-lg"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900 mb-2"
  }, "\uD83D\uDCCB\xA5 Import Data"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mb-4"
  }, "Restore MODA data from a previously exported backup file. This will replace current data."), /*#__PURE__*/React.createElement("label", {
    className: "inline-block px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700"
  }, "Select Backup File", /*#__PURE__*/React.createElement("input", {
    type: "file",
    accept: ".json",
    className: "hidden",
    onChange: e => {
      if (e.target.files[0]) {
        if (confirm('This will replace all current data. Are you sure?')) {
          importData(e.target.files[0]);
        }
      }
    }
  }))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900 mb-3"
  }, "\uD83D\uDCCB\u0160 Current Data Summary"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Projects:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, projects.length)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Trashed Projects:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, trashedProjects.length)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Employees:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, employees.length)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Trashed Employees:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, trashedEmployees.length)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Total Modules:"), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 font-medium"
  }, projects.reduce((sum, p) => sum + (p.modules?.length || 0), 0))))))), confirmEmpty && /*#__PURE__*/React.createElement("div", {
    className: "absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg p-6 max-w-sm"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg mb-2"
  }, "Empty ", trashTab === 'projects' ? 'Projects' : 'Employees', " Trash?"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 text-sm mb-4"
  }, "This will permanently delete all ", trashTab === 'projects' ? trashedProjects.length + ' projects' : trashedEmployees.length + ' employees', ". This cannot be undone."), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setConfirmEmpty(false),
    className: "px-4 py-2 bg-gray-200 rounded-lg"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: emptyTrash,
    className: "px-4 py-2 bg-red-600 text-white rounded-lg"
  }, "Delete All"))))));
}

// Export for use in App.jsx
window.ProjectsDirectory = ProjectsDirectory;
})();


// ============================================================================
// FILE: TrackerModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA MODULE TRACKER PANEL
// Extracted from App.jsx for better maintainability
// ============================================================================

// ===== MODULE TRACKER PANEL =====
// Unified lifecycle view showing all modules across all phases
function ModuleTrackerPanel({
  projects
}) {
  const [unifiedModules, setUnifiedModules] = useState({});
  const [stats, setStats] = useState({
    total: 0,
    byPhase: {}
  });
  const [selectedPhase, setSelectedPhase] = useState('all');
  const [selectedProject, setSelectedProject] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedModule, setSelectedModule] = useState(null);
  const [sortConfig, setSortConfig] = useState({
    key: 'serial',
    direction: 'asc'
  });

  // Load and sync unified modules
  useEffect(() => {
    const loadUnified = () => {
      // Check if MODA_UNIFIED is available
      if (typeof MODA_UNIFIED === 'undefined' || !MODA_UNIFIED) {
        console.warn('[ModuleTrackerPanel] MODA_UNIFIED not available yet');
        return;
      }
      try {
        MODA_UNIFIED.migrateFromProjects();
        setUnifiedModules(MODA_UNIFIED.getAll());
        setStats(MODA_UNIFIED.getStats());
      } catch (err) {
        console.error('[ModuleTrackerPanel] Error loading unified modules:', err);
      }
    };
    loadUnified();

    // Re-sync when projects change
    const interval = setInterval(loadUnified, 5000);
    return () => clearInterval(interval);
  }, [projects]);

  // Handle column sort
  const handleSort = key => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  // Sort indicator
  const SortIndicator = ({
    columnKey
  }) => {
    if (sortConfig.key !== columnKey) return /*#__PURE__*/React.createElement("span", {
      className: "text-gray-300 ml-1"
    }, "\u21C5");
    return sortConfig.direction === 'asc' ? /*#__PURE__*/React.createElement("span", {
      className: "ml-1"
    }, "\u2191") : /*#__PURE__*/React.createElement("span", {
      className: "ml-1"
    }, "\u2193");
  };

  // Filter and sort modules
  const filteredModules = useMemo(() => {
    let mods = Object.values(unifiedModules);
    if (selectedPhase !== 'all') {
      mods = mods.filter(m => m.currentPhase === selectedPhase);
    }
    if (selectedProject !== 'all') {
      mods = mods.filter(m => m.projectId === selectedProject);
    }
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      mods = mods.filter(m => (m.serialNumber || '').toLowerCase().includes(term) || (m.projectName || '').toLowerCase().includes(term) || (m.specs?.blmHitch || '').toLowerCase().includes(term) || (m.specs?.blmRear || '').toLowerCase().includes(term));
    }

    // Apply sorting
    const phaseOrder = ['production', 'yard', 'transport', 'onsite', 'complete'];
    mods.sort((a, b) => {
      let comparison = 0;
      switch (sortConfig.key) {
        case 'serial':
          comparison = (a.serialNumber || '').localeCompare(b.serialNumber || '');
          break;
        case 'project':
          comparison = (a.projectName || '').localeCompare(b.projectName || '');
          break;
        case 'blm':
          const blmA = a.specs?.blmHitch || a.specs?.blmRear || '';
          const blmB = b.specs?.blmHitch || b.specs?.blmRear || '';
          comparison = blmA.localeCompare(blmB);
          break;
        case 'phase':
          comparison = phaseOrder.indexOf(a.currentPhase) - phaseOrder.indexOf(b.currentPhase);
          break;
        case 'progress':
          const progressA = Object.values(a.production?.stageProgress || {}).reduce((sum, v) => sum + v, 0);
          const progressB = Object.values(b.production?.stageProgress || {}).reduce((sum, v) => sum + v, 0);
          comparison = progressA - progressB;
          break;
        case 'updated':
          comparison = new Date(a.updatedAt || 0) - new Date(b.updatedAt || 0);
          break;
        default:
          comparison = (a.production?.buildSequence || 0) - (b.production?.buildSequence || 0);
      }
      return sortConfig.direction === 'asc' ? comparison : -comparison;
    });
    return mods;
  }, [unifiedModules, selectedPhase, selectedProject, searchTerm, sortConfig]);
  const phaseConfig = {
    production: {
      label: 'Production',
      iconClass: 'icon-factory',
      color: '#3B82F6'
    },
    yard: {
      label: 'Yard',
      iconClass: 'icon-box',
      color: '#6366F1'
    },
    transport: {
      label: 'Transport',
      iconClass: 'icon-truck',
      color: '#F59E0B'
    },
    onsite: {
      label: 'On-Site',
      iconClass: 'icon-building',
      color: '#8B5CF6'
    },
    complete: {
      label: 'Complete',
      iconClass: 'icon-check-circle',
      color: '#10B981'
    }
  };
  const getPhaseColor = phase => phaseConfig[phase]?.color || '#6B7280';
  const getProductionProgress = mod => {
    const progress = mod.production?.stageProgress || {};
    const values = Object.values(progress);
    if (values.length === 0) return 0;
    return Math.round(values.reduce((a, b) => a + b, 0) / values.length);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col sm:flex-row sm:items-center justify-between gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-xl sm:text-2xl font-bold flex items-center gap-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-box inline-block w-6 h-6"
  }), "Module Lifecycle Tracker"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 text-sm mt-1"
  }, "Unified view of all modules: Production \u2192 Yard \u2192 Transport \u2192 On-Site \u2192 Complete")), /*#__PURE__*/React.createElement("div", {
    className: "text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-3xl font-bold",
    style: {
      color: 'var(--autovol-red)'
    }
  }, stats.total), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Total Modules"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-4"
  }, Object.entries(phaseConfig).map(([phase, config]) => /*#__PURE__*/React.createElement("button", {
    key: phase,
    onClick: () => setSelectedPhase(selectedPhase === phase ? 'all' : phase),
    className: `p-2 sm:p-4 rounded-lg border-2 transition-all ${selectedPhase === phase ? 'ring-2 ring-offset-2' : ''}`,
    style: {
      borderColor: config.color,
      backgroundColor: selectedPhase === phase ? config.color + '15' : 'white'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-center mb-1 sm:mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: `${config.iconClass} inline-block w-6 h-6 sm:w-8 sm:h-8`,
    style: {
      filter: `brightness(0) saturate(100%) sepia(1) hue-rotate(${phase === 'production' ? '200' : phase === 'yard' ? '220' : phase === 'transport' ? '30' : phase === 'onsite' ? '250' : '120'}deg)`
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "text-lg sm:text-2xl font-bold",
    style: {
      color: config.color
    }
  }, stats.byPhase?.[phase] || 0), /*#__PURE__*/React.createElement("div", {
    className: "text-xs sm:text-sm text-gray-600"
  }, config.label)))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-4 items-center bg-white p-4 rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by serial, BLM, or project...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "w-full px-4 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("select", {
    value: selectedProject,
    onChange: e => setSelectedProject(e.target.value),
    className: "px-4 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Projects"), projects.filter(p => p.status === 'Active').map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name))), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setSelectedPhase('all');
      setSelectedProject('all');
      setSearchTerm('');
    },
    className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
  }, "Clear Filters")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b",
    style: {
      backgroundColor: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-white"
  }, filteredModules.length, " Module", filteredModules.length !== 1 ? 's' : '', selectedPhase !== 'all' && ` in ${phaseConfig[selectedPhase]?.label}`)), /*#__PURE__*/React.createElement("div", {
    className: "max-h-[500px] overflow-auto",
    style: {
      WebkitOverflowScrolling: 'touch'
    }
  }, filteredModules.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "No modules found matching your criteria") : /*#__PURE__*/React.createElement("table", {
    className: "w-full",
    style: {
      minWidth: '700px'
    }
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50 sticky top-0"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('serial')
  }, "Serial ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "serial"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('project')
  }, "Project ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "project"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('blm')
  }, "BLM ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "blm"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('phase')
  }, "Phase ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "phase"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('progress')
  }, "Progress ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "progress"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleSort('updated')
  }, "Updated ", /*#__PURE__*/React.createElement(SortIndicator, {
    columnKey: "updated"
  })))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, filteredModules.map(mod => {
    const progress = getProductionProgress(mod);
    const phaseInfo = phaseConfig[mod.currentPhase];
    return /*#__PURE__*/React.createElement("tr", {
      key: mod.id,
      className: "hover:bg-gray-50 cursor-pointer",
      onClick: () => setSelectedModule(mod)
    }, /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-mono font-semibold"
    }, mod.serialNumber)), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm text-gray-600"
    }, mod.projectName || 'Unknown'), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm"
    }, mod.specs?.blmHitch || mod.specs?.blmRear ? /*#__PURE__*/React.createElement("span", {
      className: "font-mono text-xs"
    }, mod.specs?.blmHitch, mod.specs?.blmHitch && mod.specs?.blmRear && ' / ', mod.specs?.blmRear) : /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "-")), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium",
      style: {
        backgroundColor: phaseInfo?.color + '20',
        color: phaseInfo?.color
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `${phaseInfo?.iconClass} inline-block w-3 h-3`
    }), phaseInfo?.label)), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-24 h-2 bg-gray-200 rounded-full overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "h-full rounded-full transition-all",
      style: {
        width: `${progress}%`,
        backgroundColor: progress === 100 ? '#10B981' : 'var(--autovol-blue)'
      }
    })), /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-500"
    }, progress, "%"))), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-xs text-gray-500"
    }, mod.updatedAt ? new Date(mod.updatedAt).toLocaleDateString() : '-'));
  }))))), selectedModule && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6 border-b sticky top-0 bg-white flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Module ", selectedModule.serialNumber), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, selectedModule.projectName)), /*#__PURE__*/React.createElement("button", {
    onClick: () => setSelectedModule(null),
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "Lifecycle Progress"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, Object.entries(phaseConfig).map(([phase, config], idx) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: phase
  }, /*#__PURE__*/React.createElement("div", {
    className: `flex-1 p-2 sm:p-3 rounded-lg text-center ${selectedModule.currentPhase === phase ? 'ring-2' : ''}`,
    style: {
      backgroundColor: selectedModule.currentPhase === phase ? config.color + '20' : '#F3F4F6',
      ringColor: config.color
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: `${config.iconClass} inline-block w-5 h-5 sm:w-6 sm:h-6`
  })), /*#__PURE__*/React.createElement("div", {
    className: "text-xs mt-1",
    style: {
      color: selectedModule.currentPhase === phase ? config.color : '#6B7280'
    }
  }, config.label)), idx < 3 && /*#__PURE__*/React.createElement("div", {
    className: "text-gray-300"
  }, "\u2192'"))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "Specifications"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "BLM Hitch"), /*#__PURE__*/React.createElement("div", {
    className: "font-mono"
  }, selectedModule.specs?.blmHitch || '-')), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "BLM Rear"), /*#__PURE__*/React.createElement("div", {
    className: "font-mono"
  }, selectedModule.specs?.blmRear || '-')), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Unit Type"), /*#__PURE__*/React.createElement("div", null, selectedModule.specs?.unit || '-')), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Dimensions"), /*#__PURE__*/React.createElement("div", null, selectedModule.specs?.width && selectedModule.specs?.length ? `${selectedModule.specs.width}' x ${selectedModule.specs.length}'` : '-')))), Object.values(selectedModule.specs?.difficulties || {}).some(v => v) && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "Difficulties"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, selectedModule.specs.difficulties?.sidewall && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs"
  }, "Sidewall"), selectedModule.specs.difficulties?.stair && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs"
  }, "Stair"), selectedModule.specs.difficulties?.hr3Wall && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-red-100 text-red-700 rounded text-xs"
  }, "3HR Wall"), selectedModule.specs.difficulties?.short && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"
  }, "Short"), selectedModule.specs.difficulties?.doubleStudio && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-green-100 text-green-700 rounded text-xs"
  }, "Double Studio"), selectedModule.specs.difficulties?.sawbox && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs"
  }, "Sawbox"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "Production Stages (", getProductionProgress(selectedModule), "% Complete)"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-2 text-xs"
  }, Object.entries(selectedModule.production?.stageProgress || {}).map(([stage, progress]) => /*#__PURE__*/React.createElement("div", {
    key: stage,
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-gray-500 mb-1"
  }, /*#__PURE__*/React.createElement("span", null, stage), /*#__PURE__*/React.createElement("span", null, progress, "%")), /*#__PURE__*/React.createElement("div", {
    className: "h-1.5 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-full rounded-full",
    style: {
      width: `${progress}%`,
      backgroundColor: progress === 100 ? '#10B981' : progress > 0 ? '#3B82F6' : '#E5E7EB'
    }
  }))))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "History"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-40 overflow-y-auto"
  }, (selectedModule.history || []).slice().reverse().map((entry, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "flex gap-3 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-400 text-xs w-32 flex-shrink-0"
  }, new Date(entry.timestamp).toLocaleString()), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-600"
  }, entry.action)))))))));
}

// ============================================================================
// ENGINEERING ISSUE CONSTANTS
// ============================================================================
const ENGINEERING_ISSUE_CATEGORIES = [{
  id: 'design-error',
  label: 'Design Error',
  icon: '📐',
  color: '#EF4444'
}, {
  id: 'dimension-issue',
  label: 'Dimension Issue',
  icon: '📏',
  color: '#F59E0B'
}, {
  id: 'material-spec',
  label: 'Material Specification',
  icon: '🔧',
  color: '#3B82F6'
}, {
  id: 'structural',
  label: 'Structural Concern',
  icon: '🏗️',
  color: '#8B5CF6'
}, {
  id: 'mep-conflict',
  label: 'MEP Conflict',
  icon: '⚡',
  color: '#EC4899'
}, {
  id: 'drawing-update',
  label: 'Drawing Update Needed',
  icon: '📋',
  color: '#06B6D4'
}, {
  id: 'rfi',
  label: 'RFI (Request for Information)',
  icon: '❓',
  color: '#10B981'
}, {
  id: 'change-order',
  label: 'Change Order Request',
  icon: '📝',
  color: '#6366F1'
}, {
  id: 'other',
  label: 'Other',
  icon: '📌',
  color: '#6B7280'
}];

// Export for use in App.jsx
window.ModuleTrackerPanel = ModuleTrackerPanel;
})();


// ============================================================================
// FILE: AutomationModule.jsx
// ============================================================================
(function() {
/**
 * Automation Module for MODA
 * Parses daily automation stats emails and stores data for tracking.
 */

(function () {
  'use strict';

  console.log('[AutomationModule] Script starting...');
// [Removed duplicate React destructuring]
  // Storage key for localStorage
  const STORAGE_KEY = 'moda_automation_reports';

  // ============================================================================
  // DATA API - localStorage with Supabase fallback
  // ============================================================================

  const AutomationDataAPI = {
    isSupabaseAvailable() {
      return window.MODA_SUPABASE?.isInitialized && window.MODA_SUPABASE?.client;
    },
    getLocalReports() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('[AutomationData] Error reading localStorage:', e);
        return [];
      }
    },
    saveLocalReports(reports) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
      } catch (e) {
        console.error('[AutomationData] Error saving to localStorage:', e);
      }
    },
    async getAll() {
      // For now, just use localStorage
      return this.getLocalReports();
    },
    async save(parsedData, userName) {
      const report = {
        id: crypto.randomUUID(),
        date: parsedData.date,
        createdAt: new Date().toISOString(),
        createdBy: userName || 'Unknown',
        wallLine: parsedData.wallLine,
        floorLine: parsedData.floorLine
      };
      const reports = this.getLocalReports();
      reports.unshift(report);
      this.saveLocalReports(reports);
      return report;
    },
    async checkDuplicate(date) {
      const reports = this.getLocalReports();
      return reports.find(r => r.date === date);
    },
    async delete(reportId) {
      const reports = this.getLocalReports();
      const filtered = reports.filter(r => r.id !== reportId);
      this.saveLocalReports(filtered);
    }
  };

  // ============================================================================
  // EMAIL PARSER
  // ============================================================================

  function parseEmailText(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);

    // Try to find date
    let date = null;
    const datePatterns = [/(\d{1,2}\/\d{1,2}\/\d{2,4})/, /(\d{4}-\d{2}-\d{2})/, /(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}/i];
    for (const line of lines) {
      for (const pattern of datePatterns) {
        const match = line.match(pattern);
        if (match) {
          date = match[1] || match[0];
          break;
        }
      }
      if (date) break;
    }
    if (!date) {
      date = new Date().toLocaleDateString();
    }

    // Parse Wall Line data
    const wallLine = parseLineData(text, 'Wall');
    const floorLine = parseLineData(text, 'Floor');
    return {
      date,
      wallLine,
      floorLine
    };
  }
  function parseLineData(text, lineType) {
    const result = {
      modulesFinished: 0,
      scheduleVariance: 0,
      scheduleStatus: 'ON',
      totalDowntime: 0,
      issues: []
    };

    // Look for modules finished
    const modulesPattern = new RegExp(lineType + '[^\\d]*(\\d+\\.?\\d*)\\s*modules?', 'i');
    const modulesMatch = text.match(modulesPattern);
    if (modulesMatch) {
      result.modulesFinished = parseFloat(modulesMatch[1]);
    }

    // Look for schedule status
    if (text.toLowerCase().includes(lineType.toLowerCase()) && text.toLowerCase().includes('ahead')) {
      result.scheduleStatus = 'AHEAD';
    } else if (text.toLowerCase().includes(lineType.toLowerCase()) && text.toLowerCase().includes('behind')) {
      result.scheduleStatus = 'BEHIND';
    }

    // Look for downtime
    const downtimePattern = new RegExp(lineType + '[^\\d]*(\\d+\\.?\\d*)\\s*min', 'i');
    const downtimeMatch = text.match(downtimePattern);
    if (downtimeMatch) {
      result.totalDowntime = parseFloat(downtimeMatch[1]);
    }
    return result;
  }

  // ============================================================================
  // MAIN COMPONENT
  // ============================================================================

  const AutomationModule = ({
    auth
  }) => {
    const [activeView, setActiveView] = useState('upload');
    const [dragActive, setDragActive] = useState(false);
    const [parsedData, setParsedData] = useState(null);
    const [error, setError] = useState(null);
    const [processing, setProcessing] = useState(false);
    const [saving, setSaving] = useState(false);
    const [reports, setReports] = useState([]);
    const [loading, setLoading] = useState(true);
    const [successMessage, setSuccessMessage] = useState(null);

    // Check if user can edit (Admin or Production Management)
    const canEdit = auth?.isAdmin || auth?.currentUser?.dashboardRole === 'admin' || auth?.currentUser?.dashboardRole === 'production_management' || auth?.currentUser?.dashboardRole === 'production';
    useEffect(() => {
      loadReports();
    }, []);
    const loadReports = async () => {
      setLoading(true);
      try {
        const data = await AutomationDataAPI.getAll();
        setReports(data);
      } catch (e) {
        console.error('[AutomationModule] Failed to load reports:', e);
      } finally {
        setLoading(false);
      }
    };
    const handleDrag = e => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === 'dragenter' || e.type === 'dragover') {
        setDragActive(true);
      } else if (e.type === 'dragleave') {
        setDragActive(false);
      }
    };
    const processFile = async file => {
      if (!file) return;
      setError(null);
      setProcessing(true);
      try {
        const text = await file.text();
        const data = parseEmailText(text);
        setParsedData(data);
      } catch (err) {
        setError('Failed to parse file: ' + err.message);
        setParsedData(null);
      } finally {
        setProcessing(false);
      }
    };
    const handleDrop = async e => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);

      // Handle files from drag
      const files = e.dataTransfer?.files;
      const items = e.dataTransfer?.items;

      // Try to get text data first (for Outlook drag)
      if (items) {
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.kind === 'string' && item.type === 'text/plain') {
            item.getAsString(text => {
              if (text && text.length > 50) {
                setProcessing(true);
                try {
                  const data = parseEmailText(text);
                  setParsedData(data);
                } catch (err) {
                  setError('Failed to parse: ' + err.message);
                }
                setProcessing(false);
              }
            });
            return;
          }
        }
      }

      // Fall back to file handling
      if (files && files.length > 0) {
        await processFile(files[0]);
      }
    };
    const handleFileInput = async e => {
      const file = e.target.files?.[0];
      if (file) {
        await processFile(file);
      }
    };
    const handleSave = async () => {
      if (!parsedData || !canEdit) return;
      setSaving(true);
      setError(null);
      try {
        const existing = await AutomationDataAPI.checkDuplicate(parsedData.date);
        if (existing) {
          setError('A report for ' + parsedData.date + ' already exists.');
          setSaving(false);
          return;
        }
        await AutomationDataAPI.save(parsedData, auth?.name || auth?.email);
        setSuccessMessage('Report saved!');
        setParsedData(null);
        await loadReports();
        setTimeout(() => setSuccessMessage(null), 3000);
      } catch (err) {
        setError('Failed to save: ' + err.message);
      } finally {
        setSaving(false);
      }
    };
    const handleDelete = async reportId => {
      if (!canEdit) return;
      if (!confirm('Delete this report?')) return;
      try {
        await AutomationDataAPI.delete(reportId);
        await loadReports();
      } catch (err) {
        setError('Failed to delete: ' + err.message);
      }
    };
    const formatDowntime = minutes => {
      if (!minutes) return '0 min';
      return minutes + ' min';
    };

    // ============================================================================
    // RENDER
    // ============================================================================

    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-6 pb-4 border-b"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "Automation Stats"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 text-sm"
    }, "Wall Line and Floor Line production metrics")), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setActiveView('upload'),
      className: activeView === 'upload' ? 'px-3 py-1 text-sm rounded bg-blue-600 text-white' : 'px-3 py-1 text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200'
    }, "Upload"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setActiveView('history'),
      className: activeView === 'history' ? 'px-3 py-1 text-sm rounded bg-blue-600 text-white' : 'px-3 py-1 text-sm rounded bg-gray-100 text-gray-700 hover:bg-gray-200'
    }, "History (", reports.length, ")"))), successMessage && /*#__PURE__*/React.createElement("div", {
      className: "bg-green-50 border border-green-200 text-green-700 px-4 py-2 rounded mb-4 text-sm"
    }, successMessage), error && /*#__PURE__*/React.createElement("div", {
      className: "bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded mb-4 text-sm flex justify-between"
    }, /*#__PURE__*/React.createElement("span", null, error), /*#__PURE__*/React.createElement("button", {
      onClick: () => setError(null),
      className: "text-red-500 hover:text-red-700"
    }, "x")), activeView === 'upload' && /*#__PURE__*/React.createElement("div", null, !canEdit && /*#__PURE__*/React.createElement("div", {
      className: "bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-2 rounded mb-4 text-sm"
    }, "View Only: Need Admin or Production Management role to upload."), canEdit && !parsedData && /*#__PURE__*/React.createElement("div", {
      onDragEnter: handleDrag,
      onDragLeave: handleDrag,
      onDragOver: handleDrag,
      onDrop: handleDrop,
      onClick: () => document.getElementById('auto-file-input')?.click(),
      className: `border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${dragActive ? 'border-blue-400 bg-blue-50' : 'border-gray-300 bg-gray-50 hover:border-gray-400'}`
    }, /*#__PURE__*/React.createElement("input", {
      type: "file",
      id: "auto-file-input",
      accept: ".msg,.eml,.txt",
      onChange: handleFileInput,
      className: "hidden"
    }), /*#__PURE__*/React.createElement("div", {
      className: "text-gray-400 text-4xl mb-2"
    }, processing ? '...' : '+'), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 font-medium"
    }, processing ? 'Processing...' : 'Drop email here or click to browse'), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-400 text-sm mt-1"
    }, "Drag emails directly from Outlook, or upload .msg/.eml/.txt files")), parsedData && /*#__PURE__*/React.createElement("div", {
      className: "border rounded-lg p-4 bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-center mb-4"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-bold text-gray-700"
    }, "Parsed Data - ", parsedData.date), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setParsedData(null),
      className: "px-3 py-1 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: handleSave,
      disabled: saving,
      className: "px-3 py-1 text-sm rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
    }, saving ? 'Saving...' : 'Save Report'))), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded p-3 border"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "font-medium text-gray-700 mb-2"
    }, "Wall Line"), /*#__PURE__*/React.createElement("div", {
      className: "text-sm space-y-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Modules:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, parsedData.wallLine?.modulesFinished || 0)), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Status:"), /*#__PURE__*/React.createElement("span", {
      className: `font-medium ${parsedData.wallLine?.scheduleStatus === 'AHEAD' ? 'text-green-600' : parsedData.wallLine?.scheduleStatus === 'BEHIND' ? 'text-red-600' : 'text-gray-600'}`
    }, parsedData.wallLine?.scheduleStatus || 'ON')), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Downtime:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-red-600"
    }, formatDowntime(parsedData.wallLine?.totalDowntime))))), /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded p-3 border"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "font-medium text-gray-700 mb-2"
    }, "Floor Line"), /*#__PURE__*/React.createElement("div", {
      className: "text-sm space-y-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Modules:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, parsedData.floorLine?.modulesFinished || 0)), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Status:"), /*#__PURE__*/React.createElement("span", {
      className: `font-medium ${parsedData.floorLine?.scheduleStatus === 'AHEAD' ? 'text-green-600' : parsedData.floorLine?.scheduleStatus === 'BEHIND' ? 'text-red-600' : 'text-gray-600'}`
    }, parsedData.floorLine?.scheduleStatus || 'ON')), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Downtime:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-red-600"
    }, formatDowntime(parsedData.floorLine?.totalDowntime)))))))), activeView === 'history' && /*#__PURE__*/React.createElement("div", null, loading ? /*#__PURE__*/React.createElement("div", {
      className: "text-center py-8 text-gray-500"
    }, "Loading...") : reports.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "text-center py-8 text-gray-500"
    }, "No reports yet. Upload your first automation stats email.") : /*#__PURE__*/React.createElement("div", {
      className: "space-y-3"
    }, reports.map(report => /*#__PURE__*/React.createElement("div", {
      key: report.id,
      className: "border rounded-lg p-4 bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-start mb-3"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "font-bold text-gray-700"
    }, report.date), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 text-sm ml-2"
    }, "by ", report.createdBy)), canEdit && /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDelete(report.id),
      className: "text-red-500 hover:text-red-700 text-sm"
    }, "Delete")), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-4 text-sm"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Wall Line:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-2 font-medium"
    }, report.wallLine?.modulesFinished || 0, " modules"), /*#__PURE__*/React.createElement("span", {
      className: `ml-2 ${report.wallLine?.scheduleStatus === 'AHEAD' ? 'text-green-600' : report.wallLine?.scheduleStatus === 'BEHIND' ? 'text-red-600' : ''}`
    }, "(", report.wallLine?.scheduleStatus || 'ON', ")")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "Floor Line:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-2 font-medium"
    }, report.floorLine?.modulesFinished || 0, " modules"), /*#__PURE__*/React.createElement("span", {
      className: `ml-2 ${report.floorLine?.scheduleStatus === 'AHEAD' ? 'text-green-600' : report.floorLine?.scheduleStatus === 'BEHIND' ? 'text-red-600' : ''}`
    }, "(", report.floorLine?.scheduleStatus || 'ON', ")"))))))));
  };

  // Export to window
  window.AutomationModule = AutomationModule;
  console.log('[AutomationModule] Exported to window.AutomationModule');
})();
})();


// ============================================================================
// FILE: HeatMapMatrix.jsx
// ============================================================================
(function() {
/**
 * HeatMapMatrix Component
 * Displays and allows editing of difficulty settings per project
 * Grid view: Rows = Difficulty Indicators, Columns = Stations
 * Each cell shows the difficulty category (Easy/Average/Medium/Hard/Very Hard)
 */
// [Removed duplicate React destructuring]
// Difficulty categories with colors
const DIFFICULTY_CATEGORIES = [{
  id: 'easy',
  label: 'Easy',
  color: 'bg-green-100 text-green-800 border-green-300'
}, {
  id: 'average',
  label: 'Average',
  color: 'bg-gray-100 text-gray-800 border-gray-300'
}, {
  id: 'medium',
  label: 'Medium',
  color: 'bg-yellow-100 text-yellow-800 border-yellow-300'
}, {
  id: 'hard',
  label: 'Hard',
  color: 'bg-orange-100 text-orange-800 border-orange-300'
}, {
  id: 'very_hard',
  label: 'Very Hard',
  color: 'bg-red-100 text-red-800 border-red-300'
}];

// Get color class for a difficulty category
const getDifficultyColor = category => {
  const found = DIFFICULTY_CATEGORIES.find(c => c.id === category);
  return found ? found.color : 'bg-gray-100 text-gray-800 border-gray-300';
};

// Get label for a difficulty category
const getDifficultyLabel = category => {
  const found = DIFFICULTY_CATEGORIES.find(c => c.id === category);
  return found ? found.label : 'Average';
};
function HeatMapMatrix({
  project,
  productionStages,
  onClose,
  canEdit = false
}) {
  // Filter out Sign-Off station - it's just a completion indicator, not a labor station
  const laborStations = productionStages.filter(s => s.name?.toLowerCase() !== 'sign-off' && s.id !== 'sign-off');
  const [indicators, setIndicators] = useState([]);
  const [heatMapData, setHeatMapData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState(null);
  const [editingCell, setEditingCell] = useState(null);
  const [dropdownPosition, setDropdownPosition] = useState({
    top: 0,
    left: 0
  });
  const [hasChanges, setHasChanges] = useState(false);
  const [pendingChanges, setPendingChanges] = useState({});

  // Load data on mount
  useEffect(() => {
    loadData();
  }, [project?.id]);
  const loadData = async () => {
    if (!project?.id) return;
    setLoading(true);
    setError(null);
    try {
      // Get API from window global
      const api = window.HeatMapAPI;
      console.log('[HeatMapMatrix] Loading data, api:', !!api);
      if (!api) {
        throw new Error('HeatMapAPI not loaded');
      }

      // Load indicators
      const indicatorsData = await api.getDifficultyIndicators();
      console.log('[HeatMapMatrix] Indicators loaded:', indicatorsData);
      setIndicators(indicatorsData);

      // Load heat map for this project
      let heatMap = await api.getProjectHeatMap(project.id);

      // If no heat map exists, initialize with defaults
      if (!heatMap || heatMap.length === 0) {
        await api.initializeProjectHeatMap(project.id);
        heatMap = await api.getProjectHeatMap(project.id);
      }
      setHeatMapData(heatMap);
    } catch (err) {
      console.error('Error loading heat map data:', err);
      setError('Failed to load heat map data');
    } finally {
      setLoading(false);
    }
  };

  // Build matrix data structure for display
  const matrixData = useMemo(() => {
    const matrix = {};
    for (const indicator of indicators) {
      matrix[indicator.id] = {};
      for (const stage of laborStations) {
        // Check pending changes first
        const pendingKey = `${indicator.id}|${stage.id}`;
        if (pendingChanges[pendingKey]) {
          matrix[indicator.id][stage.id] = pendingChanges[pendingKey];
        } else {
          // Find existing entry
          const entry = heatMapData.find(e => e.difficulty_indicator_id === indicator.id && e.station_id === stage.id);
          matrix[indicator.id][stage.id] = entry?.difficulty_category || 'average';
        }
      }
    }
    return matrix;
  }, [indicators, heatMapData, laborStations, pendingChanges]);

  // Handle cell click to edit
  const handleCellClick = (indicatorId, stationId, event) => {
    if (!canEdit) return;

    // Get the cell's position for dropdown placement
    const rect = event.currentTarget.getBoundingClientRect();
    setDropdownPosition({
      top: rect.bottom + 4,
      left: rect.left + rect.width / 2
    });
    setEditingCell({
      indicatorId,
      stationId
    });
  };

  // Handle category selection
  const handleCategorySelect = category => {
    if (!editingCell) return;
    const key = `${editingCell.indicatorId}|${editingCell.stationId}`;
    setPendingChanges(prev => ({
      ...prev,
      [key]: category
    }));
    setHasChanges(true);
    setEditingCell(null);
  };

  // Save all pending changes
  const handleSave = async () => {
    if (!hasChanges || Object.keys(pendingChanges).length === 0) return;
    setSaving(true);
    setError(null);
    try {
      const api = window.HeatMapAPI;
      if (!api) {
        throw new Error('HeatMapAPI not loaded');
      }
      const entries = Object.entries(pendingChanges).map(([key, category]) => {
        const [indicatorId, stationId] = key.split('|');
        return {
          indicatorId,
          stationId,
          difficultyCategory: category
        };
      });
      const success = await api.bulkUpdateHeatMap(project.id, entries);
      if (success) {
        // Reload data to get fresh state
        await loadData();
        setPendingChanges({});
        setHasChanges(false);
      } else {
        setError('Failed to save changes');
      }
    } catch (err) {
      console.error('Error saving heat map:', err);
      setError('Failed to save changes');
    } finally {
      setSaving(false);
    }
  };

  // Discard pending changes
  const handleDiscard = () => {
    setPendingChanges({});
    setHasChanges(false);
    setEditingCell(null);
  };
  if (loading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg p-8 max-w-md"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin rounded-full h-6 w-6 border-b-2 border-autovol-navy"
    }), /*#__PURE__*/React.createElement("span", null, "Loading Heat Map..."))));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-[95vw] min-h-[70vh] max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-4 border-b"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-autovol-navy"
  }, "Heat Map Matrix"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, project?.name, " - Difficulty settings by station")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, hasChanges && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: handleDiscard,
    className: "px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800",
    disabled: saving
  }, "Discard"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSave,
    className: "px-4 py-1.5 text-sm bg-autovol-navy text-white rounded hover:bg-autovol-navy-light disabled:opacity-50",
    disabled: saving
  }, saving ? 'Saving...' : 'Save Changes')), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 text-gray-500 hover:text-gray-700"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  }))))), error && /*#__PURE__*/React.createElement("div", {
    className: "mx-4 mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"
  }, error), /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-2 border-b bg-gray-50 flex items-center gap-4 flex-wrap"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium text-gray-700"
  }, "Legend:"), DIFFICULTY_CATEGORIES.map(cat => /*#__PURE__*/React.createElement("span", {
    key: cat.id,
    className: `px-2 py-0.5 text-xs rounded border ${cat.color}`
  }, cat.label))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-auto p-4 pt-8"
  }, /*#__PURE__*/React.createElement("table", {
    className: "min-w-full border-collapse"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "sticky left-0 top-0 z-30 bg-gray-100 border-y border-l border-r-0 p-2 text-left text-sm font-semibold text-gray-700 min-w-[120px] shadow-[4px_0_6px_-2px_rgba(0,0,0,0.15)]"
  }, "Indicator"), laborStations.map(stage => /*#__PURE__*/React.createElement("th", {
    key: stage.id,
    className: "sticky top-0 z-20 bg-gray-100 border p-3 text-center text-xs font-medium text-gray-700 min-w-[90px]",
    title: stage.name
  }, /*#__PURE__*/React.createElement("div", {
    className: "truncate"
  }, stage.dept || stage.name))))), /*#__PURE__*/React.createElement("tbody", null, indicators.map((indicator, rowIndex) => /*#__PURE__*/React.createElement("tr", {
    key: indicator.id
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky left-0 z-10 bg-white border-y border-l border-r-0 p-3 text-sm font-medium text-gray-800 shadow-[4px_0_6px_-2px_rgba(0,0,0,0.15)]"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", null, indicator.name), indicator.is_easier && /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-green-600"
  }, "(easier)"))), laborStations.map(stage => {
    const category = matrixData[indicator.id]?.[stage.id] || 'average';
    const isEditing = editingCell?.indicatorId === indicator.id && editingCell?.stationId === stage.id;
    const isPending = pendingChanges[`${indicator.id}|${stage.id}`];
    const isFirstRow = rowIndex === 0;
    return /*#__PURE__*/React.createElement("td", {
      key: stage.id,
      className: `border p-3 text-center relative ${canEdit ? 'cursor-pointer hover:bg-gray-50' : ''}`,
      onClick: e => handleCellClick(indicator.id, stage.id, e)
    }, /*#__PURE__*/React.createElement("span", {
      className: `inline-block px-2 py-1 text-xs rounded border ${getDifficultyColor(category)} ${isPending ? 'ring-2 ring-blue-400' : ''}`
    }, getDifficultyLabel(category)));
  })))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t bg-gray-50 text-sm text-gray-600"
  }, canEdit ? /*#__PURE__*/React.createElement("p", null, "Click on any cell to change the difficulty level for that indicator/station combination.") : /*#__PURE__*/React.createElement("p", null, "View-only mode. Contact an administrator to modify difficulty settings."))), editingCell && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 z-[9998]",
    onClick: () => setEditingCell(null)
  }), /*#__PURE__*/React.createElement("div", {
    className: "fixed bg-white border-2 border-gray-300 rounded-lg shadow-2xl z-[9999] py-2 min-w-[150px]",
    style: {
      top: dropdownPosition.top,
      left: dropdownPosition.left,
      transform: 'translateX(-50%)'
    }
  }, DIFFICULTY_CATEGORIES.map(cat => /*#__PURE__*/React.createElement("button", {
    key: cat.id,
    onClick: e => {
      e.stopPropagation();
      handleCategorySelect(cat.id);
    },
    className: `w-full px-4 py-2 text-left text-sm hover:bg-gray-100 flex items-center gap-2 ${matrixData[editingCell.indicatorId]?.[editingCell.stationId] === cat.id ? 'font-semibold bg-gray-50' : ''}`
  }, /*#__PURE__*/React.createElement("span", {
    className: `inline-block w-3 h-3 rounded ${cat.color.split(' ')[0]}`
  }), cat.label)))));
}

// Export for use in App.jsx
window.HeatMapMatrix = HeatMapMatrix;
})();


// ============================================================================
// FILE: WeeklyHeatMapReport.jsx
// ============================================================================
(function() {
/**
 * WeeklyHeatMapReport Component
 * Shows module difficulty by station per day for labor planning
 * Layout: Stations as rows, Days as columns
 * Scoring: Easy=-1, Average=0, Medium=+1, Hard=+1, Very Hard=+2
 */
// [Removed duplicate React destructuring]
// Difficulty score mapping
const DIFFICULTY_SCORES = {
  easy: -1,
  average: 0,
  medium: 1,
  hard: 1,
  very_hard: 2
};

// Get color class based on aggregate score
const getScoreColor = (score, moduleCount) => {
  if (moduleCount === 0) return 'bg-gray-100 text-gray-400';
  const avgScore = score / moduleCount;
  if (avgScore <= -0.5) return 'bg-green-100 text-green-800 border-green-300';
  if (avgScore <= 0.25) return 'bg-gray-100 text-gray-800 border-gray-300';
  if (avgScore <= 0.75) return 'bg-yellow-100 text-yellow-800 border-yellow-300';
  if (avgScore <= 1.25) return 'bg-orange-100 text-orange-800 border-orange-300';
  return 'bg-red-100 text-red-800 border-red-300';
};

// Get intensity label
const getIntensityLabel = (score, moduleCount) => {
  if (moduleCount === 0) return 'No modules';
  const avgScore = score / moduleCount;
  if (avgScore <= -0.5) return 'Light';
  if (avgScore <= 0.25) return 'Normal';
  if (avgScore <= 0.75) return 'Moderate';
  if (avgScore <= 1.25) return 'Heavy';
  return 'Very Heavy';
};
function WeeklyHeatMapReport({
  projects,
  productionStages,
  weeks,
  currentWeek,
  onClose
}) {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [heatMapData, setHeatMapData] = useState({});
  const [indicators, setIndicators] = useState([]);
  const [showNextWeek, setShowNextWeek] = useState(false);
  const [selectedProject, setSelectedProject] = useState('all');

  // Get active projects
  const activeProjects = projects.filter(p => p.status === 'Active');

  // Calculate week dates
  const getWeekDates = (weekOffset = 0) => {
    const today = new Date();
    const currentMonday = new Date(today);
    const day = currentMonday.getDay();
    currentMonday.setDate(currentMonday.getDate() - day + (day === 0 ? -6 : 1) + weekOffset * 7);
    const dates = [];
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentMonday);
      date.setDate(currentMonday.getDate() + i);
      dates.push({
        dayName: dayNames[i],
        date: date,
        dateStr: date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        }),
        isWeekend: i >= 4
      });
    }
    return dates;
  };
  const currentWeekDates = getWeekDates(0);
  const nextWeekDates = getWeekDates(1);
  const displayDates = showNextWeek ? nextWeekDates : currentWeekDates;

  // Load heat map data for all active projects
  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      setError(null);
      try {
        const api = window.HeatMapAPI;
        if (!api) {
          throw new Error('HeatMapAPI not loaded');
        }

        // Load indicators
        const indicatorsData = await api.getDifficultyIndicators();
        setIndicators(indicatorsData);

        // Load heat map data for each active project
        const allHeatMapData = {};
        for (const project of activeProjects) {
          const projectHeatMap = await api.getProjectHeatMap(project.id);
          allHeatMapData[project.id] = projectHeatMap;
        }
        setHeatMapData(allHeatMapData);
      } catch (err) {
        console.error('Error loading report data:', err);
        setError('Failed to load report data');
      } finally {
        setLoading(false);
      }
    };
    loadData();
  }, [activeProjects.length]);

  // Get modules scheduled for each day based on week configuration
  const getModulesForDay = (dayIndex, weekOffset = 0) => {
    // Get the target week configuration
    const targetWeek = weekOffset === 0 ? currentWeek : weeks?.find(w => {
      const weekStart = new Date(w.weekStart);
      const targetDate = new Date(displayDates[0].date);
      targetDate.setDate(targetDate.getDate() + weekOffset * 7);
      return weekStart <= targetDate && new Date(w.weekEnd) >= targetDate;
    });
    if (!targetWeek) return [];

    // Get all modules from active projects sorted by production order
    const allModules = activeProjects.filter(p => selectedProject === 'all' || p.id === selectedProject).sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999)).flatMap(p => (p.modules || []).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name
    })));

    // Find starting module index
    const startingModule = targetWeek.startingModule;
    let startIdx = allModules.findIndex(m => m.serialNumber === startingModule);
    if (startIdx === -1) startIdx = 0;

    // Get daily targets from week config
    const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const shift1Days = ['monday', 'tuesday', 'wednesday', 'thursday'];
    const shift2Days = ['friday', 'saturday', 'sunday'];
    const dayName = dayNames[dayIndex];
    let dailyTarget = 0;
    if (shift1Days.includes(dayName)) {
      dailyTarget = targetWeek.shift1?.[dayName] || 0;
    } else {
      dailyTarget = targetWeek.shift2?.[dayName] || 0;
    }
    if (dailyTarget === 0) return [];

    // Calculate cumulative modules before this day
    let cumulativeModules = 0;
    for (let i = 0; i < dayIndex; i++) {
      const prevDayName = dayNames[i];
      if (shift1Days.includes(prevDayName)) {
        cumulativeModules += targetWeek.shift1?.[prevDayName] || 0;
      } else {
        cumulativeModules += targetWeek.shift2?.[prevDayName] || 0;
      }
    }

    // Get modules for this day
    const dayStartIdx = startIdx + cumulativeModules;
    return allModules.slice(dayStartIdx, dayStartIdx + dailyTarget);
  };

  // Calculate difficulty score for a station on a specific day
  const calculateStationDayScore = (stationId, dayIndex) => {
    const modules = getModulesForDay(dayIndex, showNextWeek ? 1 : 0);
    if (modules.length === 0) {
      return {
        score: 0,
        moduleCount: 0,
        details: []
      };
    }
    let totalScore = 0;
    const details = [];
    modules.forEach(module => {
      const projectHeatMap = heatMapData[module.projectId] || [];
      let moduleScore = 0;
      const moduleIndicators = [];

      // Check each indicator for this module's project
      indicators.forEach(indicator => {
        const entry = projectHeatMap.find(e => e.difficulty_indicator_id === indicator.id && e.station_id === stationId);
        if (entry) {
          const score = DIFFICULTY_SCORES[entry.difficulty_category] || 0;
          if (score !== 0) {
            moduleScore += score;
            moduleIndicators.push({
              name: indicator.name,
              category: entry.difficulty_category,
              score
            });
          }
        }
      });
      totalScore += moduleScore;
      if (moduleIndicators.length > 0) {
        details.push({
          serial: module.serialNumber,
          score: moduleScore,
          indicators: moduleIndicators
        });
      }
    });
    return {
      score: totalScore,
      moduleCount: modules.length,
      details
    };
  };

  // Build report data matrix
  const reportData = useMemo(() => {
    if (loading || indicators.length === 0) return [];

    // Filter out Sign-Off station - it's just a completion indicator, not a labor station
    const laborStations = productionStages.filter(s => s.name?.toLowerCase() !== 'sign-off' && s.id !== 'sign-off');
    return laborStations.map(station => {
      const dayScores = displayDates.map((_, dayIndex) => calculateStationDayScore(station.id, dayIndex));
      const weekTotal = dayScores.reduce((sum, d) => sum + d.score, 0);
      const weekModules = dayScores.reduce((sum, d) => sum + d.moduleCount, 0);
      return {
        station,
        dayScores,
        weekTotal,
        weekModules
      };
    });
  }, [loading, indicators, heatMapData, productionStages, displayDates, selectedProject, showNextWeek]);

  // Export to CSV
  const exportToCSV = () => {
    const headers = ['Station', ...displayDates.map(d => `${d.dayName} ${d.dateStr}`), 'Week Total', 'Avg Intensity'];
    const rows = reportData.map(row => [row.station.name, ...row.dayScores.map(d => d.moduleCount > 0 ? `${d.score} (${d.moduleCount} modules)` : '-'), row.weekTotal, row.weekModules > 0 ? getIntensityLabel(row.weekTotal, row.weekModules) : '-']);
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], {
      type: 'text/csv'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `weekly-heat-map-report-${showNextWeek ? 'next' : 'current'}-week.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };
  if (loading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "p-8 text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin w-8 h-8 border-4 border-autovol-teal border-t-transparent rounded-full mx-auto mb-4"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600"
    }, "Loading report data..."));
  }
  if (error) {
    return /*#__PURE__*/React.createElement("div", {
      className: "p-8 text-center"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-red-600"
    }, error));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Weekly Heat Map Report"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, showNextWeek ? 'Next Week' : 'Current Week', ": ", displayDates[0].dateStr, " - ", displayDates[6].dateStr)), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("select", {
    value: selectedProject,
    onChange: e => setSelectedProject(e.target.value),
    className: "border rounded-lg px-3 py-2 text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Projects"), activeProjects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name))), /*#__PURE__*/React.createElement("div", {
    className: "flex rounded-lg border overflow-hidden"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowNextWeek(false),
    className: `px-3 py-2 text-sm ${!showNextWeek ? 'bg-autovol-teal text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`
  }, "This Week"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowNextWeek(true),
    className: `px-3 py-2 text-sm ${showNextWeek ? 'bg-autovol-teal text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`
  }, "Next Week")), /*#__PURE__*/React.createElement("button", {
    onClick: exportToCSV,
    className: "px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  })), "Export CSV"))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-700"
  }, "Intensity:"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-green-100 text-green-800 border border-green-300"
  }, "Light"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-gray-100 text-gray-800 border border-gray-300"
  }, "Normal"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 border border-yellow-300"
  }, "Moderate"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-orange-100 text-orange-800 border border-orange-300"
  }, "Heavy"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-red-100 text-red-800 border border-red-300"
  }, "Very Heavy")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto border rounded-lg"
  }, /*#__PURE__*/React.createElement("table", {
    className: "min-w-full"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-gray-100"
  }, /*#__PURE__*/React.createElement("th", {
    className: "sticky left-0 bg-gray-100 border-r p-3 text-left text-sm font-semibold text-gray-700 min-w-[150px]"
  }, "Station"), displayDates.map((day, idx) => /*#__PURE__*/React.createElement("th", {
    key: idx,
    className: `p-3 text-center text-sm font-medium text-gray-700 min-w-[100px] ${day.isWeekend ? 'bg-gray-200' : ''}`
  }, /*#__PURE__*/React.createElement("div", null, day.dayName), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, day.dateStr))), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center text-sm font-semibold text-gray-700 min-w-[100px] bg-autovol-navy/10"
  }, "Week Total"))), /*#__PURE__*/React.createElement("tbody", null, reportData.map((row, rowIdx) => /*#__PURE__*/React.createElement("tr", {
    key: row.station.id,
    className: rowIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky left-0 bg-inherit border-r p-3 text-sm font-medium text-gray-800"
  }, /*#__PURE__*/React.createElement("div", null, row.station.dept || row.station.name), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, row.station.group)), row.dayScores.map((dayScore, dayIdx) => /*#__PURE__*/React.createElement("td", {
    key: dayIdx,
    className: `p-2 text-center ${displayDates[dayIdx].isWeekend ? 'bg-gray-100/50' : ''}`
  }, dayScore.moduleCount > 0 ? /*#__PURE__*/React.createElement("div", {
    className: `inline-block px-2 py-1 rounded border text-xs ${getScoreColor(dayScore.score, dayScore.moduleCount)}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold"
  }, dayScore.score >= 0 ? '+' : '', dayScore.score), /*#__PURE__*/React.createElement("div", {
    className: "text-[10px] opacity-75"
  }, dayScore.moduleCount, " mod")) : /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "-"))), /*#__PURE__*/React.createElement("td", {
    className: "p-2 text-center bg-autovol-navy/5"
  }, row.weekModules > 0 ? /*#__PURE__*/React.createElement("div", {
    className: `inline-block px-3 py-1 rounded border text-sm font-semibold ${getScoreColor(row.weekTotal, row.weekModules)}`
  }, row.weekTotal >= 0 ? '+' : '', row.weekTotal) : /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "-"))))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-orange-50 border border-orange-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-orange-800 mb-2"
  }, "Heaviest Days"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1 text-sm"
  }, displayDates.map((day, idx) => {
    const dayTotal = reportData.reduce((sum, row) => sum + row.dayScores[idx].score, 0);
    const dayModules = reportData.reduce((sum, row) => sum + row.dayScores[idx].moduleCount, 0);
    return {
      day,
      dayTotal,
      dayModules,
      idx
    };
  }).filter(d => d.dayModules > 0).sort((a, b) => b.dayTotal - a.dayTotal).slice(0, 3).map(d => /*#__PURE__*/React.createElement("div", {
    key: d.idx,
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", null, d.day.dayName, " ", d.day.dateStr), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-orange-700"
  }, "+", d.dayTotal))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-red-50 border border-red-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-red-800 mb-2"
  }, "Heaviest Stations"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1 text-sm"
  }, [...reportData].filter(r => r.weekModules > 0).sort((a, b) => b.weekTotal - a.weekTotal).slice(0, 3).map(row => /*#__PURE__*/React.createElement("div", {
    key: row.station.id,
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", null, row.station.dept || row.station.name), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-red-700"
  }, "+", row.weekTotal))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 border border-green-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-green-800 mb-2"
  }, "Lightest Stations"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1 text-sm"
  }, [...reportData].filter(r => r.weekModules > 0).sort((a, b) => a.weekTotal - b.weekTotal).slice(0, 3).map(row => /*#__PURE__*/React.createElement("div", {
    key: row.station.id,
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", null, row.station.dept || row.station.name), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold text-green-700"
  }, row.weekTotal >= 0 ? '+' : '', row.weekTotal)))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Scoring:"), " Easy = -1, Average = 0, Medium = +1, Hard = +1, Very Hard = +2. Scores are summed across all difficulty indicators for each module at each station. Higher positive scores indicate heavier workload requiring more labor."));
}

// Export for use in App.jsx
window.WeeklyHeatMapReport = WeeklyHeatMapReport;
})();


// ============================================================================
// FILE: WeeklyBoardPrintReport.jsx
// ============================================================================
(function() {
// ============================================================================
// WEEKLY BOARD PRINT REPORT
// 11x17 Tabloid format for floor distribution
// Detailed module view with station progress, color-coded status
// ============================================================================
// [Removed duplicate React destructuring]
// Status color mapping (matches MODA color scheme)
const STATUS_COLORS = {
  complete: {
    bg: 'bg-green-100',
    text: 'text-green-800',
    border: 'border-green-300',
    pdf: [34, 197, 94]
  },
  inProgress: {
    bg: 'bg-blue-100',
    text: 'text-blue-800',
    border: 'border-blue-300',
    pdf: [59, 130, 246]
  },
  notStarted: {
    bg: 'bg-gray-100',
    text: 'text-gray-500',
    border: 'border-gray-300',
    pdf: [156, 163, 175]
  }
};

// Get status for a module at a station
const getModuleStationStatus = (module, stationId) => {
  const progress = module?.stageProgress?.[stationId] || 0;
  if (progress === 100) return 'complete';
  if (progress > 0) return 'inProgress';
  return 'notStarted';
};

// Format date for display
const formatDate = dateStr => {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

// Format date range
const formatDateRange = (startDate, endDate) => {
  if (!startDate || !endDate) return '';
  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
};

// Get day name from index
const DAY_NAMES = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const DAY_KEYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
function WeeklyBoardPrintReport({
  projects,
  productionStages,
  currentWeek,
  selectedWeekId,
  completedWeeks,
  scheduleSetup,
  staggerConfig,
  allModules,
  activeProjects,
  lineBalance
}) {
  const [isGenerating, setIsGenerating] = useState(false);

  // Get the week data based on selection
  const weekData = useMemo(() => {
    if (selectedWeekId === 'current' || !selectedWeekId) {
      return {
        weekStart: currentWeek?.weekStart,
        weekEnd: currentWeek?.weekEnd,
        startingModule: currentWeek?.startingModule,
        shift1: scheduleSetup?.shift1 || {
          monday: 5,
          tuesday: 5,
          wednesday: 5,
          thursday: 5
        },
        shift2: scheduleSetup?.shift2 || {
          friday: 0,
          saturday: 0,
          sunday: 0
        }
      };
    }
    if (selectedWeekId === 'previous') {
      // Calculate previous week dates
      const prevStart = new Date(currentWeek?.weekStart);
      prevStart.setDate(prevStart.getDate() - 7);
      const prevEnd = new Date(prevStart);
      prevEnd.setDate(prevEnd.getDate() + 6);

      // Find completed week that matches
      const completed = completedWeeks?.find(w => {
        const wStart = new Date(w.weekStart || w.scheduleSnapshot?.weekStart);
        return Math.abs(wStart - prevStart) < 86400000; // Within 1 day
      });
      return {
        weekStart: prevStart.toISOString().split('T')[0],
        weekEnd: prevEnd.toISOString().split('T')[0],
        startingModule: completed?.scheduleSnapshot?.startingModule || currentWeek?.startingModule,
        shift1: completed?.shift1 || scheduleSetup?.shift1,
        shift2: completed?.shift2 || scheduleSetup?.shift2
      };
    }

    // Historical completed week
    const completed = completedWeeks?.find(w => w.id === selectedWeekId || w.weekId === selectedWeekId);
    if (completed) {
      return {
        weekStart: completed.weekStart || completed.scheduleSnapshot?.weekStart,
        weekEnd: completed.weekEnd || completed.scheduleSnapshot?.weekEnd,
        startingModule: completed.scheduleSnapshot?.startingModule,
        shift1: completed.shift1,
        shift2: completed.shift2
      };
    }
    return currentWeek;
  }, [selectedWeekId, currentWeek, completedWeeks, scheduleSetup]);

  // Calculate modules per day
  const modulesByDay = useMemo(() => {
    if (!weekData || !allModules?.length) return {};
    const startIdx = allModules.findIndex(m => m.serialNumber === weekData.startingModule);
    if (startIdx === -1) return {};
    const result = {};
    let currentIdx = startIdx;

    // Shift 1 days (Mon-Thu)
    ['monday', 'tuesday', 'wednesday', 'thursday'].forEach(day => {
      const count = weekData.shift1?.[day] || 0;
      result[day] = allModules.slice(currentIdx, currentIdx + count);
      currentIdx += count;
    });

    // Shift 2 days (Fri-Sun)
    ['friday', 'saturday', 'sunday'].forEach(day => {
      const count = weekData.shift2?.[day] || 0;
      result[day] = allModules.slice(currentIdx, currentIdx + count);
      currentIdx += count;
    });
    return result;
  }, [weekData, allModules]);

  // Get all modules for the week flattened with day info
  const weekModulesFlat = useMemo(() => {
    const result = [];
    DAY_KEYS.forEach((day, dayIdx) => {
      const modules = modulesByDay[day] || [];
      modules.forEach((module, idx) => {
        result.push({
          ...module,
          day: DAY_NAMES[dayIdx],
          dayKey: day,
          dayIndex: dayIdx,
          isFirstOfDay: idx === 0,
          dayModuleCount: modules.length
        });
      });
    });
    return result;
  }, [modulesByDay]);

  // Filter out Sign-Off station for display
  const displayStations = useMemo(() => (productionStages || []).filter(s => s.name?.toLowerCase() !== 'sign-off' && s.id !== 'sign-off'), [productionStages]);

  // Generate PDF
  const handleGeneratePDF = async () => {
    setIsGenerating(true);
    try {
      const {
        jsPDF
      } = window.jspdf;

      // Create 11x17 tabloid landscape document
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: [279.4, 431.8] // 11x17 inches in mm
      });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margins = {
        top: 12,
        bottom: 12,
        left: 10,
        right: 10
      };
      const contentWidth = pageWidth - margins.left - margins.right;
      let yPos = margins.top;

      // ===== HEADER =====
      doc.setFillColor(30, 41, 59); // Autovol Navy
      doc.rect(0, 0, pageWidth, 20, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Autovol Weekly Production Board', margins.left, 10);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`Week: ${formatDateRange(weekData?.weekStart, weekData?.weekEnd)}`, margins.left, 16);
      doc.setFontSize(9);
      doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - margins.right, 10, {
        align: 'right'
      });
      doc.text(`Starting Module: ${weekData?.startingModule || 'N/A'}`, pageWidth - margins.right, 16, {
        align: 'right'
      });
      yPos = 25;

      // ===== LEGEND =====
      doc.setFontSize(8);
      doc.setTextColor(0, 0, 0);
      doc.text('Status:', margins.left, yPos);

      // Complete
      doc.setFillColor(34, 197, 94);
      doc.rect(margins.left + 15, yPos - 3, 8, 4, 'F');
      doc.text('Complete', margins.left + 25, yPos);

      // In Progress
      doc.setFillColor(59, 130, 246);
      doc.rect(margins.left + 55, yPos - 3, 8, 4, 'F');
      doc.text('In Progress', margins.left + 65, yPos);

      // Not Started
      doc.setFillColor(156, 163, 175);
      doc.rect(margins.left + 100, yPos - 3, 8, 4, 'F');
      doc.text('Not Started', margins.left + 110, yPos);
      yPos += 5;

      // ===== BUILD TABLE DATA =====
      // Headers: Day, Serial, BLM ID, Unit Type, Project, then each station
      const headers = ['Day', 'Serial #', 'BLM ID', 'Unit Type', 'Project', ...displayStations.map(s => s.dept || s.name)];

      // Build rows
      const tableData = weekModulesFlat.map(module => {
        const row = [module.isFirstOfDay ? module.day : '', module.serialNumber || '', module.blmId || module.specs?.blmId || '', module.specs?.unit || module.unitType || '', module.projectName || ''];

        // Add station progress
        displayStations.forEach(station => {
          const progress = module.stageProgress?.[station.id] || 0;
          row.push(progress === 100 ? '100%' : progress > 0 ? `${progress}%` : '-');
        });
        return row;
      });

      // Calculate column widths
      const fixedColWidths = [18, 28, 22, 20, 35]; // Day, Serial, BLM, Unit, Project
      const fixedTotal = fixedColWidths.reduce((a, b) => a + b, 0);
      const stationColWidth = (contentWidth - fixedTotal) / displayStations.length;
      const columnStyles = {
        0: {
          cellWidth: fixedColWidths[0]
        },
        // Day
        1: {
          cellWidth: fixedColWidths[1],
          fontStyle: 'bold'
        },
        // Serial
        2: {
          cellWidth: fixedColWidths[2]
        },
        // BLM ID
        3: {
          cellWidth: fixedColWidths[3],
          halign: 'center'
        },
        // Unit Type
        4: {
          cellWidth: fixedColWidths[4]
        } // Project
      };

      // Station columns
      displayStations.forEach((_, idx) => {
        columnStyles[5 + idx] = {
          cellWidth: stationColWidth,
          halign: 'center',
          fontSize: 7
        };
      });

      // Generate table
      doc.autoTable({
        startY: yPos,
        head: [headers],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [13, 148, 136],
          // Autovol Teal
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          fontSize: 7,
          cellPadding: 1.5,
          halign: 'center'
        },
        bodyStyles: {
          fontSize: 7,
          cellPadding: 1.2,
          textColor: [30, 41, 59]
        },
        columnStyles: columnStyles,
        alternateRowStyles: {
          fillColor: [248, 250, 252]
        },
        margin: {
          left: margins.left,
          right: margins.right
        },
        didParseCell: function (data) {
          // Color station cells based on progress
          if (data.section === 'body' && data.column.index >= 5) {
            const value = data.cell.raw;
            if (value === '100%') {
              data.cell.styles.fillColor = [220, 252, 231]; // green-100
              data.cell.styles.textColor = [22, 101, 52]; // green-800
              data.cell.styles.fontStyle = 'bold';
            } else if (value !== '-' && value !== '') {
              data.cell.styles.fillColor = [219, 234, 254]; // blue-100
              data.cell.styles.textColor = [30, 64, 175]; // blue-800
            }
          }

          // Bold day column when it has content
          if (data.section === 'body' && data.column.index === 0 && data.cell.raw) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [241, 245, 249]; // slate-100
          }
        },
        didDrawPage: function (data) {
          // Footer on each page
          const footerY = pageHeight - 8;
          doc.setFontSize(7);
          doc.setTextColor(107, 114, 128);
          doc.text('Autovol - Weekly Production Board', margins.left, footerY);
          doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - margins.right, footerY, {
            align: 'right'
          });
          doc.text('For Internal Use Only', pageWidth / 2, footerY, {
            align: 'center'
          });
        }
      });

      // Save PDF
      const weekStr = weekData?.weekStart?.replace(/-/g, '') || 'unknown';
      doc.save(`Weekly_Board_Print_${weekStr}.pdf`);
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    } finally {
      setIsGenerating(false);
    }
  };

  // Preview table
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Weekly Board - Print Version"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, formatDateRange(weekData?.weekStart, weekData?.weekEnd), weekData?.startingModule && ` | Starting: ${weekData.startingModule}`)), /*#__PURE__*/React.createElement("button", {
    onClick: handleGeneratePDF,
    disabled: isGenerating,
    className: "px-4 py-2 btn-primary rounded-lg text-sm font-medium flex items-center gap-2"
  }, isGenerating ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "animate-spin"
  }, "..."), "Generating...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
  })), "Generate 11x17 PDF"))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-700"
  }, "Status:"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-green-100 text-green-800 border border-green-300"
  }, "Complete"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-blue-100 text-blue-800 border border-blue-300"
  }, "In Progress"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded bg-gray-100 text-gray-500 border border-gray-300"
  }, "Not Started")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto border rounded-lg"
  }, /*#__PURE__*/React.createElement("table", {
    className: "min-w-full text-xs"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-autovol-teal text-white"
  }, /*#__PURE__*/React.createElement("th", {
    className: "p-2 text-left font-semibold sticky left-0 bg-autovol-teal"
  }, "Day"), /*#__PURE__*/React.createElement("th", {
    className: "p-2 text-left font-semibold"
  }, "Serial #"), /*#__PURE__*/React.createElement("th", {
    className: "p-2 text-left font-semibold"
  }, "BLM ID"), /*#__PURE__*/React.createElement("th", {
    className: "p-2 text-center font-semibold"
  }, "Unit Type"), /*#__PURE__*/React.createElement("th", {
    className: "p-2 text-left font-semibold"
  }, "Project"), displayStations.map(station => /*#__PURE__*/React.createElement("th", {
    key: station.id,
    className: "p-2 text-center font-semibold whitespace-nowrap"
  }, station.dept || station.name)))), /*#__PURE__*/React.createElement("tbody", null, weekModulesFlat.length === 0 ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
    colSpan: 5 + displayStations.length,
    className: "p-8 text-center text-gray-500"
  }, "No modules scheduled for this week")) : weekModulesFlat.map((module, idx) => /*#__PURE__*/React.createElement("tr", {
    key: `${module.serialNumber}-${idx}`,
    className: idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'
  }, /*#__PURE__*/React.createElement("td", {
    className: `p-2 font-semibold sticky left-0 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} ${module.isFirstOfDay ? 'bg-slate-100' : ''}`
  }, module.isFirstOfDay ? module.day : ''), /*#__PURE__*/React.createElement("td", {
    className: "p-2 font-bold text-autovol-navy"
  }, module.serialNumber), /*#__PURE__*/React.createElement("td", {
    className: "p-2"
  }, module.blmId || module.specs?.blmId || '-'), /*#__PURE__*/React.createElement("td", {
    className: "p-2 text-center"
  }, module.specs?.unit || module.unitType || '-'), /*#__PURE__*/React.createElement("td", {
    className: "p-2"
  }, module.projectName), displayStations.map(station => {
    const status = getModuleStationStatus(module, station.id);
    const progress = module.stageProgress?.[station.id] || 0;
    const colors = STATUS_COLORS[status];
    return /*#__PURE__*/React.createElement("td", {
      key: station.id,
      className: "p-1 text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: `inline-block px-1.5 py-0.5 rounded text-[10px] ${colors.bg} ${colors.text} ${colors.border} border`
    }, progress === 100 ? '100%' : progress > 0 ? `${progress}%` : '-'));
  })))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Total Modules"), /*#__PURE__*/React.createElement("div", {
    className: "text-xl font-bold text-autovol-navy"
  }, weekModulesFlat.length)), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Active Projects"), /*#__PURE__*/React.createElement("div", {
    className: "text-xl font-bold text-autovol-navy"
  }, activeProjects?.length || 0)), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Stations"), /*#__PURE__*/React.createElement("div", {
    className: "text-xl font-bold text-autovol-navy"
  }, displayStations.length)), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Line Balance"), /*#__PURE__*/React.createElement("div", {
    className: "text-xl font-bold text-autovol-navy"
  }, lineBalance || weekModulesFlat.length))), /*#__PURE__*/React.createElement("div", {
    className: "bg-purple-50 border border-purple-200 rounded-lg p-4 text-sm text-purple-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Print Format:"), " This report generates an 11x17 (Tabloid) landscape PDF optimized for printing. Color coding matches MODA status colors for easy reference on the production floor."));
}

// Export for use
window.WeeklyBoardPrintReport = WeeklyBoardPrintReport;
})();


// ============================================================================
// FILE: WeeklyBoardManagementReport.jsx
// ============================================================================
(function() {
// ============================================================================
// WEEKLY BOARD MANAGEMENT REPORT
// Management summary with daily goal tracking
// Orange line shows target progress by end of shift
// ============================================================================
// [Removed duplicate React destructuring]
// Format date for display
const formatDate = dateStr => {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

// Format date range
const formatDateRange = (startDate, endDate) => {
  if (!startDate || !endDate) return '';
  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
};

// Get day name from index
const DAY_NAMES = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const DAY_KEYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
const DAY_ABBREV = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

// Calculate what time of day we're at (for goal line positioning)
const getTimeOfDayProgress = () => {
  const now = new Date();
  const hour = now.getHours();
  // Assume shift runs 6am-3pm (9 hours)
  // Before 6am = 0%, After 3pm = 100%
  if (hour < 6) return 0;
  if (hour >= 15) return 100;
  return Math.round((hour - 6) / 9 * 100);
};

// Get current day of week (0 = Monday, 6 = Sunday)
const getCurrentDayIndex = () => {
  const day = new Date().getDay();
  return day === 0 ? 6 : day - 1; // Convert Sunday=0 to Monday=0 format
};
function WeeklyBoardManagementReport({
  projects,
  productionStages,
  currentWeek,
  selectedWeekId,
  completedWeeks,
  scheduleSetup,
  staggerConfig,
  allModules,
  activeProjects,
  lineBalance
}) {
  const [isGenerating, setIsGenerating] = useState(false);

  // Get the week data based on selection
  const weekData = useMemo(() => {
    if (selectedWeekId === 'current' || !selectedWeekId) {
      return {
        weekStart: currentWeek?.weekStart,
        weekEnd: currentWeek?.weekEnd,
        startingModule: currentWeek?.startingModule,
        shift1: scheduleSetup?.shift1 || {
          monday: 5,
          tuesday: 5,
          wednesday: 5,
          thursday: 5
        },
        shift2: scheduleSetup?.shift2 || {
          friday: 0,
          saturday: 0,
          sunday: 0
        },
        isCurrent: true
      };
    }
    if (selectedWeekId === 'previous') {
      const prevStart = new Date(currentWeek?.weekStart);
      prevStart.setDate(prevStart.getDate() - 7);
      const prevEnd = new Date(prevStart);
      prevEnd.setDate(prevEnd.getDate() + 6);
      const completed = completedWeeks?.find(w => {
        const wStart = new Date(w.weekStart || w.scheduleSnapshot?.weekStart);
        return Math.abs(wStart - prevStart) < 86400000;
      });
      return {
        weekStart: prevStart.toISOString().split('T')[0],
        weekEnd: prevEnd.toISOString().split('T')[0],
        startingModule: completed?.scheduleSnapshot?.startingModule || currentWeek?.startingModule,
        shift1: completed?.shift1 || scheduleSetup?.shift1,
        shift2: completed?.shift2 || scheduleSetup?.shift2,
        isCurrent: false
      };
    }
    const completed = completedWeeks?.find(w => w.id === selectedWeekId || w.weekId === selectedWeekId);
    if (completed) {
      return {
        weekStart: completed.weekStart || completed.scheduleSnapshot?.weekStart,
        weekEnd: completed.weekEnd || completed.scheduleSnapshot?.weekEnd,
        startingModule: completed.scheduleSnapshot?.startingModule,
        shift1: completed.shift1,
        shift2: completed.shift2,
        isCurrent: false
      };
    }
    return {
      ...currentWeek,
      isCurrent: true
    };
  }, [selectedWeekId, currentWeek, completedWeeks, scheduleSetup]);

  // Calculate modules per day with progress tracking
  const dailyData = useMemo(() => {
    if (!weekData || !allModules?.length) return [];
    const startIdx = allModules.findIndex(m => m.serialNumber === weekData.startingModule);
    if (startIdx === -1) return [];
    const result = [];
    let currentIdx = startIdx;
    let cumulativeTarget = 0;
    let cumulativeComplete = 0;

    // Get week start date for calculating actual dates
    const weekStartDate = weekData.weekStart ? new Date(weekData.weekStart) : new Date();
    DAY_KEYS.forEach((day, dayIdx) => {
      const isShift1 = dayIdx < 4;
      const target = isShift1 ? weekData.shift1?.[day] || 0 : weekData.shift2?.[day] || 0;
      const modules = allModules.slice(currentIdx, currentIdx + target);
      currentIdx += target;

      // Calculate actual date for this day
      const dayDate = new Date(weekStartDate);
      dayDate.setDate(dayDate.getDate() + dayIdx);

      // Count completed modules (100% at final station or Sign-Off)
      const finalStation = productionStages?.[productionStages.length - 1];
      const signOffStation = productionStages?.find(s => s.name?.toLowerCase() === 'sign-off' || s.id === 'sign-off');
      const checkStation = signOffStation || finalStation;
      const completed = modules.filter(m => (m.stageProgress?.[checkStation?.id] || 0) === 100).length;
      const inProgress = modules.filter(m => {
        const progress = Object.values(m.stageProgress || {});
        return progress.some(p => p > 0) && (m.stageProgress?.[checkStation?.id] || 0) < 100;
      }).length;
      cumulativeTarget += target;
      cumulativeComplete += completed;
      result.push({
        day: DAY_NAMES[dayIdx],
        dayAbbrev: DAY_ABBREV[dayIdx],
        dayKey: day,
        dayIndex: dayIdx,
        date: dayDate.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        }),
        target,
        completed,
        inProgress,
        pending: target - completed - inProgress,
        cumulativeTarget,
        cumulativeComplete,
        modules,
        isShift1,
        completionRate: target > 0 ? Math.round(completed / target * 100) : 0
      });
    });
    return result;
  }, [weekData, allModules, productionStages]);

  // Calculate overall stats
  const overallStats = useMemo(() => {
    const totalTarget = dailyData.reduce((sum, d) => sum + d.target, 0);
    const totalComplete = dailyData.reduce((sum, d) => sum + d.completed, 0);
    const totalInProgress = dailyData.reduce((sum, d) => sum + d.inProgress, 0);
    return {
      totalTarget,
      totalComplete,
      totalInProgress,
      totalPending: totalTarget - totalComplete - totalInProgress,
      overallRate: totalTarget > 0 ? Math.round(totalComplete / totalTarget * 100) : 0
    };
  }, [dailyData]);

  // Current day for goal line (only for current week)
  const currentDayIndex = getCurrentDayIndex();
  const timeProgress = getTimeOfDayProgress();

  // Project breakdown
  const projectBreakdown = useMemo(() => {
    const breakdown = {};
    dailyData.forEach(day => {
      day.modules.forEach(module => {
        const projectName = module.projectName || 'Unknown';
        if (!breakdown[projectName]) {
          breakdown[projectName] = {
            total: 0,
            complete: 0,
            inProgress: 0
          };
        }
        breakdown[projectName].total++;
        const finalStation = productionStages?.[productionStages.length - 1];
        const signOffStation = productionStages?.find(s => s.name?.toLowerCase() === 'sign-off' || s.id === 'sign-off');
        const checkStation = signOffStation || finalStation;
        const progress = module.stageProgress?.[checkStation?.id] || 0;
        if (progress === 100) {
          breakdown[projectName].complete++;
        } else if (Object.values(module.stageProgress || {}).some(p => p > 0)) {
          breakdown[projectName].inProgress++;
        }
      });
    });
    return Object.entries(breakdown).map(([name, data]) => ({
      name,
      ...data,
      rate: data.total > 0 ? Math.round(data.complete / data.total * 100) : 0
    }));
  }, [dailyData, productionStages]);

  // Generate PDF
  const handleGeneratePDF = async () => {
    setIsGenerating(true);
    try {
      const {
        jsPDF
      } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'letter'
      });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margins = {
        top: 15,
        bottom: 15,
        left: 15,
        right: 15
      };
      const contentWidth = pageWidth - margins.left - margins.right;
      let yPos = margins.top;

      // ===== HEADER =====
      doc.setFillColor(30, 41, 59);
      doc.rect(0, 0, pageWidth, 22, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('Weekly Production Summary', margins.left, 11);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Week: ${formatDateRange(weekData?.weekStart, weekData?.weekEnd)}`, margins.left, 18);
      doc.setFontSize(9);
      doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - margins.right, 11, {
        align: 'right'
      });
      doc.text(`Line Balance: ${lineBalance || overallStats.totalTarget}`, pageWidth - margins.right, 17, {
        align: 'right'
      });
      yPos = 28;

      // ===== SUMMARY BOXES =====
      const boxWidth = (contentWidth - 15) / 4;
      const boxHeight = 18;
      const summaryBoxes = [{
        label: 'Target',
        value: overallStats.totalTarget,
        color: [107, 114, 128]
      }, {
        label: 'Completed',
        value: overallStats.totalComplete,
        color: [34, 197, 94]
      }, {
        label: 'In Progress',
        value: overallStats.totalInProgress,
        color: [59, 130, 246]
      }, {
        label: 'Completion Rate',
        value: `${overallStats.overallRate}%`,
        color: [13, 148, 136]
      }];
      summaryBoxes.forEach((box, idx) => {
        const x = margins.left + idx * (boxWidth + 5);
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(x, yPos, boxWidth, boxHeight, 2, 2, 'F');
        doc.setFontSize(8);
        doc.setTextColor(107, 114, 128);
        doc.text(box.label, x + 3, yPos + 5);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...box.color);
        doc.text(String(box.value), x + 3, yPos + 14);
      });
      yPos += boxHeight + 8;

      // ===== DAILY PROGRESS TABLE =====
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text('Daily Production Tracking', margins.left, yPos);
      yPos += 4;
      const dailyTableData = dailyData.map((day, idx) => {
        const isCurrentDay = weekData.isCurrent && idx === currentDayIndex;
        return [`${day.dayAbbrev} ${day.date}`, day.target.toString(), day.completed.toString(), day.inProgress.toString(), day.pending.toString(), `${day.completionRate}%`, day.cumulativeComplete.toString(), day.cumulativeTarget.toString()];
      });
      doc.autoTable({
        startY: yPos,
        head: [['Day', 'Target', 'Complete', 'In Progress', 'Pending', 'Rate', 'Cumul. Done', 'Cumul. Target']],
        body: dailyTableData,
        theme: 'striped',
        headStyles: {
          fillColor: [13, 148, 136],
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          fontSize: 9
        },
        bodyStyles: {
          fontSize: 9,
          textColor: [30, 41, 59]
        },
        columnStyles: {
          0: {
            cellWidth: 35,
            fontStyle: 'bold'
          },
          1: {
            cellWidth: 20,
            halign: 'center'
          },
          2: {
            cellWidth: 22,
            halign: 'center'
          },
          3: {
            cellWidth: 25,
            halign: 'center'
          },
          4: {
            cellWidth: 20,
            halign: 'center'
          },
          5: {
            cellWidth: 20,
            halign: 'center'
          },
          6: {
            cellWidth: 28,
            halign: 'center'
          },
          7: {
            cellWidth: 28,
            halign: 'center'
          }
        },
        margin: {
          left: margins.left,
          right: margins.right
        },
        didParseCell: function (data) {
          // Highlight current day row with orange border
          if (data.section === 'body' && weekData.isCurrent && data.row.index === currentDayIndex) {
            data.cell.styles.fillColor = [255, 237, 213]; // orange-100
          }

          // Color completion rate
          if (data.section === 'body' && data.column.index === 5) {
            const rate = parseInt(data.cell.raw) || 0;
            if (rate === 100) {
              data.cell.styles.textColor = [22, 101, 52];
              data.cell.styles.fontStyle = 'bold';
            } else if (rate >= 50) {
              data.cell.styles.textColor = [13, 148, 136];
            } else if (rate > 0) {
              data.cell.styles.textColor = [234, 88, 12];
            }
          }

          // Color completed column
          if (data.section === 'body' && data.column.index === 2) {
            const val = parseInt(data.cell.raw) || 0;
            if (val > 0) {
              data.cell.styles.textColor = [22, 101, 52];
              data.cell.styles.fontStyle = 'bold';
            }
          }
        },
        didDrawCell: function (data) {
          // Draw orange goal line after current day
          if (data.section === 'body' && weekData.isCurrent && data.row.index === currentDayIndex) {
            const cellHeight = data.cell.height;
            const lineY = data.cell.y + cellHeight * (timeProgress / 100);

            // Only draw on first column
            if (data.column.index === 0) {
              doc.setDrawColor(249, 115, 22); // orange-500
              doc.setLineWidth(0.8);
              // Draw across entire row
              const rowWidth = data.table.columns.reduce((sum, col) => sum + col.width, 0);
              doc.line(data.cell.x, lineY, data.cell.x + rowWidth, lineY);
            }
          }
        }
      });
      yPos = doc.lastAutoTable.finalY + 8;

      // ===== PROJECT BREAKDOWN =====
      if (yPos < pageHeight - 60) {
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('Project Breakdown', margins.left, yPos);
        yPos += 4;
        const projectTableData = projectBreakdown.map(p => [p.name, p.total.toString(), p.complete.toString(), p.inProgress.toString(), (p.total - p.complete - p.inProgress).toString(), `${p.rate}%`]);
        doc.autoTable({
          startY: yPos,
          head: [['Project', 'Total', 'Complete', 'In Progress', 'Pending', 'Rate']],
          body: projectTableData,
          theme: 'striped',
          headStyles: {
            fillColor: [30, 41, 59],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 9
          },
          bodyStyles: {
            fontSize: 9
          },
          margin: {
            left: margins.left,
            right: margins.right
          }
        });
      }

      // ===== FOOTER =====
      const footerY = pageHeight - 10;
      doc.setDrawColor(229, 231, 235);
      doc.line(margins.left, footerY - 3, pageWidth - margins.right, footerY - 3);
      doc.setFontSize(8);
      doc.setTextColor(107, 114, 128);
      doc.text('Autovol - Weekly Production Summary', margins.left, footerY);
      doc.text('Management Report - Confidential', pageWidth / 2, footerY, {
        align: 'center'
      });
      doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - margins.right, footerY, {
        align: 'right'
      });

      // Add legend for orange line
      if (weekData.isCurrent) {
        doc.setFontSize(7);
        doc.setTextColor(249, 115, 22);
        doc.text('Orange line indicates current time progress through shift', margins.left, footerY - 6);
      }

      // Save
      const weekStr = weekData?.weekStart?.replace(/-/g, '') || 'unknown';
      doc.save(`Weekly_Management_Report_${weekStr}.pdf`);
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    } finally {
      setIsGenerating(false);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Weekly Board - Management Summary"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, formatDateRange(weekData?.weekStart, weekData?.weekEnd), weekData?.isCurrent && ' (Current Week)')), /*#__PURE__*/React.createElement("button", {
    onClick: handleGeneratePDF,
    disabled: isGenerating,
    className: "px-4 py-2 btn-primary rounded-lg text-sm font-medium flex items-center gap-2"
  }, isGenerating ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "animate-spin"
  }, "..."), "Generating...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  })), "Export PDF"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 border border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 uppercase tracking-wide"
  }, "Target"), /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-gray-700"
  }, overallStats.totalTarget)), /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 rounded-lg p-4 border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-green-600 uppercase tracking-wide"
  }, "Completed"), /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-700"
  }, overallStats.totalComplete)), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 rounded-lg p-4 border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-blue-600 uppercase tracking-wide"
  }, "In Progress"), /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-700"
  }, overallStats.totalInProgress)), /*#__PURE__*/React.createElement("div", {
    className: "bg-teal-50 rounded-lg p-4 border border-teal-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-teal-600 uppercase tracking-wide"
  }, "Completion Rate"), /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-teal-700"
  }, overallStats.overallRate, "%"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white border rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 px-4 py-2 border-b"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-autovol-navy"
  }, "Daily Production Tracking"), weekData.isCurrent && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-orange-600 flex items-center gap-1 mt-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-3 h-0.5 bg-orange-500 inline-block"
  }), "Orange line shows where production should be by current time")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "min-w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-autovol-teal text-white"
  }, /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-left font-semibold"
  }, "Day"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Target"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Complete"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "In Progress"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Pending"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Rate"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Cumul. Done"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Cumul. Target"))), /*#__PURE__*/React.createElement("tbody", null, dailyData.map((day, idx) => {
    const isCurrentDay = weekData.isCurrent && idx === currentDayIndex;
    const isPastDay = weekData.isCurrent && idx < currentDayIndex;
    return /*#__PURE__*/React.createElement("tr", {
      key: day.dayKey,
      className: `
                                            ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}
                                            ${isCurrentDay ? 'bg-orange-50 border-l-4 border-orange-500' : ''}
                                            ${isPastDay && day.completionRate < 100 ? 'bg-red-50/30' : ''}
                                        `
    }, /*#__PURE__*/React.createElement("td", {
      className: "p-3 font-semibold"
    }, /*#__PURE__*/React.createElement("div", null, day.dayAbbrev), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, day.date)), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center"
    }, day.target), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: day.completed > 0 ? 'text-green-700 font-bold' : ''
    }, day.completed)), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: day.inProgress > 0 ? 'text-blue-700' : ''
    }, day.inProgress)), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center"
    }, day.pending), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: `
                                                px-2 py-0.5 rounded text-xs font-medium
                                                ${day.completionRate === 100 ? 'bg-green-100 text-green-800' : ''}
                                                ${day.completionRate >= 50 && day.completionRate < 100 ? 'bg-teal-100 text-teal-800' : ''}
                                                ${day.completionRate > 0 && day.completionRate < 50 ? 'bg-orange-100 text-orange-800' : ''}
                                                ${day.completionRate === 0 && day.target > 0 ? 'bg-gray-100 text-gray-600' : ''}
                                            `
    }, day.completionRate, "%")), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center font-medium"
    }, day.cumulativeComplete), /*#__PURE__*/React.createElement("td", {
      className: "p-3 text-center text-gray-500"
    }, day.cumulativeTarget));
  })), /*#__PURE__*/React.createElement("tfoot", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-autovol-navy text-white font-semibold"
  }, /*#__PURE__*/React.createElement("td", {
    className: "p-3"
  }, "Total"), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, overallStats.totalTarget), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, overallStats.totalComplete), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, overallStats.totalInProgress), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, overallStats.totalPending), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, overallStats.overallRate, "%"), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center",
    colSpan: 2
  })))))), projectBreakdown.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "bg-white border rounded-lg overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 px-4 py-2 border-b"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-autovol-navy"
  }, "Project Breakdown")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "min-w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-gray-100"
  }, /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-left font-semibold"
  }, "Project"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Total"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Complete"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "In Progress"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Pending"), /*#__PURE__*/React.createElement("th", {
    className: "p-3 text-center font-semibold"
  }, "Rate"))), /*#__PURE__*/React.createElement("tbody", null, projectBreakdown.map((project, idx) => /*#__PURE__*/React.createElement("tr", {
    key: project.name,
    className: idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'
  }, /*#__PURE__*/React.createElement("td", {
    className: "p-3 font-medium"
  }, project.name), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, project.total), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center text-green-700 font-medium"
  }, project.complete), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center text-blue-700"
  }, project.inProgress), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, project.total - project.complete - project.inProgress), /*#__PURE__*/React.createElement("td", {
    className: "p-3 text-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-0.5 rounded text-xs font-medium ${project.rate === 100 ? 'bg-green-100 text-green-800' : project.rate >= 50 ? 'bg-teal-100 text-teal-800' : 'bg-gray-100 text-gray-600'}`
  }, project.rate, "%")))))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-orange-50 border border-orange-200 rounded-lg p-4 text-sm text-orange-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Goal Tracking:"), " The orange highlight indicates the current day. For current week reports, the orange line in the PDF shows where production should be based on time of day. Use this to quickly assess if production is on track."));
}

// Export for use
window.WeeklyBoardManagementReport = WeeklyBoardManagementReport;
})();


// ============================================================================
// FILE: ReportsHub.jsx
// ============================================================================
(function() {
// ============================================================================
// REPORTS HUB COMPONENT
// Central hub for all production reports in the Reports sub-tab
// ============================================================================
// [Removed duplicate React destructuring]
// Format date for display
const formatWeekDate = dateStr => {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

// Report type definitions
const REPORT_TYPES = {
  HEAT_MAP: 'heat-map',
  WEEKLY_BOARD_PRINT: 'weekly-board-print',
  WEEKLY_BOARD_MANAGEMENT: 'weekly-board-management'
};

// Render component from window with fallback
function renderWindowComponent(componentName, props, fallbackMessage) {
  console.log(`[ReportsHub] Attempting to render ${componentName}, exists:`, !!window[componentName]);
  const Component = window[componentName];
  if (Component) {
    try {
      return React.createElement(Component, props);
    } catch (err) {
      console.error(`[ReportsHub] Error rendering ${componentName}:`, err);
      return /*#__PURE__*/React.createElement("div", {
        className: "p-8 text-center text-red-500"
      }, /*#__PURE__*/React.createElement("p", null, "Error rendering ", componentName), /*#__PURE__*/React.createElement("p", {
        className: "text-xs mt-2"
      }, err.message));
    }
  }
  console.warn(`[ReportsHub] Component ${componentName} not found on window`);
  return /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-amber-600 bg-amber-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-semibold"
  }, fallbackMessage || `Loading ${componentName}...`), /*#__PURE__*/React.createElement("p", {
    className: "text-xs mt-2"
  }, "Component \"", componentName, "\" not found. Check console for script loading errors."));
}

// Report card component
function ReportCard({
  title,
  description,
  icon,
  iconBgColor = 'bg-autovol-teal',
  status = 'active',
  // 'active', 'coming-soon', 'planned'
  onClick
}) {
  const isActive = status === 'active';
  return /*#__PURE__*/React.createElement("div", {
    className: `border-2 rounded-lg p-6 transition-all ${isActive ? 'border-gray-200 hover:border-autovol-teal hover:shadow-md cursor-pointer bg-white' : 'border-dashed border-gray-300 bg-gray-50/50'}`,
    onClick: isActive ? onClick : undefined
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: `w-10 h-10 ${isActive ? iconBgColor : 'bg-gray-300'} rounded-lg flex items-center justify-center text-white flex-shrink-0`
  }, icon), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("h4", {
    className: `font-semibold ${isActive ? 'text-autovol-navy' : 'text-gray-500'}`
  }, title), /*#__PURE__*/React.createElement("p", {
    className: `text-sm mt-1 ${isActive ? 'text-gray-600' : 'text-gray-400'}`
  }, description), /*#__PURE__*/React.createElement("div", {
    className: "mt-3 flex items-center gap-2"
  }, status === 'coming-soon' && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full"
  }, "Coming Soon"), status === 'planned' && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 bg-gray-200 text-gray-500 text-xs rounded-full"
  }, "Planned"), isActive && /*#__PURE__*/React.createElement("span", {
    className: "text-autovol-teal text-sm font-medium flex items-center gap-1"
  }, "Open Report", /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 5l7 7-7 7"
  })))))));
}

// Week selector component for reports
function WeekSelector({
  weeks,
  currentWeek,
  selectedWeekId,
  onSelectWeek,
  completedWeeks = []
}) {
  // Build list of available weeks
  const availableWeeks = useMemo(() => {
    const weekList = [];

    // Current week
    if (currentWeek) {
      weekList.push({
        id: 'current',
        label: 'Current Week',
        weekStart: currentWeek.weekStart,
        weekEnd: currentWeek.weekEnd,
        isCurrent: true
      });
    }

    // Previous week (one week before current)
    if (currentWeek?.weekStart) {
      const prevStart = new Date(currentWeek.weekStart);
      prevStart.setDate(prevStart.getDate() - 7);
      const prevEnd = new Date(prevStart);
      prevEnd.setDate(prevEnd.getDate() + 6);
      weekList.push({
        id: 'previous',
        label: 'Previous Week',
        weekStart: prevStart.toISOString().split('T')[0],
        weekEnd: prevEnd.toISOString().split('T')[0],
        isPrevious: true
      });
    }

    // Completed weeks from history
    if (completedWeeks && completedWeeks.length > 0) {
      completedWeeks.forEach(w => {
        // Skip if it matches current or previous
        if (w.weekId === 'current' || w.weekId === 'previous') return;
        weekList.push({
          id: w.id || w.weekId,
          label: `Week of ${formatWeekDate(w.weekStart || w.scheduleSnapshot?.weekStart)}`,
          weekStart: w.weekStart || w.scheduleSnapshot?.weekStart,
          weekEnd: w.weekEnd || w.scheduleSnapshot?.weekEnd,
          isCompleted: true,
          completedAt: w.completedAt
        });
      });
    }
    return weekList;
  }, [currentWeek, completedWeeks]);
  const selectedWeek = availableWeeks.find(w => w.id === selectedWeekId) || availableWeeks[0];
  return /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "text-sm font-medium text-gray-700"
  }, "Week:"), /*#__PURE__*/React.createElement("select", {
    value: selectedWeekId || 'current',
    onChange: e => onSelectWeek(e.target.value),
    className: "border rounded-lg px-3 py-2 text-sm bg-white"
  }, availableWeeks.map(week => /*#__PURE__*/React.createElement("option", {
    key: week.id,
    value: week.id
  }, week.label, week.weekStart && ` (${formatWeekDate(week.weekStart)} - ${formatWeekDate(week.weekEnd)})`))));
}

// Main Reports Hub component
function ReportsHub({
  projects,
  productionStages,
  weeks,
  currentWeek,
  completedWeeks = [],
  scheduleSetup,
  staggerConfig,
  lineBalance
}) {
  const [activeReport, setActiveReport] = useState(null);
  const [selectedWeekId, setSelectedWeekId] = useState('current');

  // Get all modules sorted by build sequence
  const allModules = useMemo(() => {
    const activeProjects = (projects || []).filter(p => p.status === 'Active').sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999));
    return activeProjects.flatMap(p => (p.modules || []).map(m => ({
      ...m,
      projectId: p.id,
      projectName: p.name
    }))).sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
  }, [projects]);

  // Get active projects
  const activeProjects = useMemo(() => (projects || []).filter(p => p.status === 'Active'), [projects]);

  // Handle report selection
  const handleOpenReport = reportType => {
    console.log('[ReportsHub] Opening report:', reportType);
    setActiveReport(reportType);
  };

  // Handle back to hub
  const handleBackToHub = () => {
    setActiveReport(null);
  };

  // Debug: log active report on each render
  console.log('[ReportsHub] Current activeReport:', activeReport, 'REPORT_TYPES:', REPORT_TYPES);

  // Render active report based on type
  if (activeReport === REPORT_TYPES.WEEKLY_BOARD_PRINT) {
    console.log('[ReportsHub] Rendering WEEKLY_BOARD_PRINT');
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: handleBackToHub,
      className: "flex items-center gap-2 text-gray-600 hover:text-autovol-navy text-sm"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M15 19l-7-7 7-7"
    })), "Back to Reports"), /*#__PURE__*/React.createElement(WeekSelector, {
      weeks: weeks,
      currentWeek: currentWeek,
      selectedWeekId: selectedWeekId,
      onSelectWeek: setSelectedWeekId,
      completedWeeks: completedWeeks
    })), renderWindowComponent('WeeklyBoardPrintReport', {
      projects,
      productionStages,
      currentWeek,
      selectedWeekId,
      completedWeeks,
      scheduleSetup,
      staggerConfig,
      allModules,
      activeProjects,
      lineBalance
    }, 'Loading Print Report...'));
  }
  if (activeReport === REPORT_TYPES.WEEKLY_BOARD_MANAGEMENT) {
    console.log('[ReportsHub] Rendering WEEKLY_BOARD_MANAGEMENT');
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: handleBackToHub,
      className: "flex items-center gap-2 text-gray-600 hover:text-autovol-navy text-sm"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M15 19l-7-7 7-7"
    })), "Back to Reports"), /*#__PURE__*/React.createElement(WeekSelector, {
      weeks: weeks,
      currentWeek: currentWeek,
      selectedWeekId: selectedWeekId,
      onSelectWeek: setSelectedWeekId,
      completedWeeks: completedWeeks
    })), renderWindowComponent('WeeklyBoardManagementReport', {
      projects,
      productionStages,
      currentWeek,
      selectedWeekId,
      completedWeeks,
      scheduleSetup,
      staggerConfig,
      allModules,
      activeProjects,
      lineBalance
    }, 'Loading Management Report...'));
  }
  if (activeReport === REPORT_TYPES.HEAT_MAP) {
    console.log('[ReportsHub] Rendering HEAT_MAP');
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: handleBackToHub,
      className: "flex items-center gap-2 text-gray-600 hover:text-autovol-navy text-sm"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M15 19l-7-7 7-7"
    })), "Back to Reports"), window.WeeklyHeatMapReport ? /*#__PURE__*/React.createElement(window.WeeklyHeatMapReport, {
      projects: projects,
      productionStages: productionStages,
      weeks: weeks,
      currentWeek: currentWeek
    }) : /*#__PURE__*/React.createElement("div", {
      className: "p-8 text-center text-gray-500"
    }, "Loading Heat Map Report..."));
  }

  // Render report hub (default view)
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Production Reports"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "Analytics, schedules, and labor planning reports"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
  }, /*#__PURE__*/React.createElement(ReportCard, {
    title: "Weekly Heat Map Report",
    description: "View module difficulty by station per day. Plan labor adjustments based on workload intensity.",
    icon: /*#__PURE__*/React.createElement("svg", {
      className: "w-5 h-5",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
    })),
    iconBgColor: "bg-autovol-teal",
    status: "active",
    onClick: () => handleOpenReport(REPORT_TYPES.HEAT_MAP)
  }), /*#__PURE__*/React.createElement(ReportCard, {
    title: "Weekly Board - Print Version",
    description: "11x17 tabloid format for floor distribution. Detailed module view with station progress, color-coded status.",
    icon: /*#__PURE__*/React.createElement("svg", {
      className: "w-5 h-5",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
    })),
    iconBgColor: "bg-purple-600",
    status: "active",
    onClick: () => handleOpenReport(REPORT_TYPES.WEEKLY_BOARD_PRINT)
  }), /*#__PURE__*/React.createElement(ReportCard, {
    title: "Weekly Board - Management Summary",
    description: "Track production against daily goals. Orange line shows target progress by end of shift.",
    icon: /*#__PURE__*/React.createElement("svg", {
      className: "w-5 h-5",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
    })),
    iconBgColor: "bg-orange-500",
    status: "active",
    onClick: () => handleOpenReport(REPORT_TYPES.WEEKLY_BOARD_MANAGEMENT)
  }), /*#__PURE__*/React.createElement(ReportCard, {
    title: "Labor Allocation",
    description: "AI-powered staffing recommendations by department based on workload.",
    icon: /*#__PURE__*/React.createElement("svg", {
      className: "w-5 h-5",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
    })),
    status: "planned"
  })), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Tip:"), " Select a report to view it. Weekly Board reports allow you to choose current, previous, or any completed week from history."));
}

// Export for use in App.jsx
window.ReportsHub = ReportsHub;
})();


// ============================================================================
// FILE: DrawingLinksPanel.jsx
// ============================================================================
(function() {
/**
 * DrawingLinksPanel Component
 * 
 * Displays quick-access links to specific pages within permit drawing packages.
 * Shows preset links (Shear Schedule, Window Schedule, etc.) and custom links.
 * Allows users with edit permissions to configure and add new links.
 */

const DrawingLinksPanel = ({
  projectId,
  projectName,
  drawings = [],
  auth,
  onRefresh
}) => {
// [Removed duplicate React destructuring]
  // State
  const [links, setLinks] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showConfigureModal, setShowConfigureModal] = useState(null); // Link being configured
  const [isExpanded, setIsExpanded] = useState(true);

  // Check if user can edit links (Admin or Production Management)
  const canEdit = useMemo(() => {
    const role = auth?.currentUser?.dashboardRole;
    return role === 'admin' || role === 'Admin' || role === 'production_management' || role === 'Production Management';
  }, [auth]);

  // Check if Supabase drawing links module is available
  const isAvailable = () => window.MODA_DRAWING_LINKS?.isAvailable?.();

  // Load links on mount
  useEffect(() => {
    const loadLinks = async () => {
      if (!projectId || !isAvailable()) {
        setIsLoading(false);
        return;
      }
      setIsLoading(true);
      try {
        // Initialize presets if needed, then get all links
        await window.MODA_DRAWING_LINKS.initializePresets(projectId, auth?.currentUser?.name || 'System');
        const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
        setLinks(data);
      } catch (error) {
        console.error('[DrawingLinksPanel] Error loading links:', error);
      } finally {
        setIsLoading(false);
      }
    };
    loadLinks();
  }, [projectId, auth]);

  // Handle clicking a link
  const handleLinkClick = useCallback(async link => {
    if (!link.package_path && !link.sharepoint_file_id) {
      // Link not configured - show configure modal if user can edit
      if (canEdit) {
        setShowConfigureModal(link);
      } else {
        alert('This link has not been configured yet.');
      }
      return;
    }

    // Open the link (extract page and open in new tab)
    await window.MODA_DRAWING_LINKS.pdf.openLink(link);
  }, [canEdit]);

  // Handle saving link configuration (with pre-extraction)
  const handleSaveLink = useCallback(async (linkId, updates, onProgress = null) => {
    try {
      // Use pre-extraction if SharePoint file is specified
      if (updates.sharepointFileId && window.MODA_DRAWING_LINKS.pdf?.createLinkWithExtraction) {
        await window.MODA_DRAWING_LINKS.pdf.createLinkWithExtraction({
          id: linkId,
          ...updates,
          createdBy: auth?.currentUser?.name || 'Unknown'
        }, projectName, onProgress);
      } else {
        await window.MODA_DRAWING_LINKS.update(linkId, updates);
      }
      // Refresh links
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
      setShowConfigureModal(null);
    } catch (error) {
      console.error('[DrawingLinksPanel] Error saving link:', error);
      // Don't show error for extraction failures - link is still saved
      if (!error.message?.includes('extraction')) {
        alert('Error saving link: ' + error.message);
      }
      // Refresh anyway - link was created, just extraction failed
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
      setShowConfigureModal(null);
    }
  }, [projectId, projectName, auth]);

  // Handle adding a new custom link (with pre-extraction)
  const handleAddLink = useCallback(async (linkData, onProgress = null) => {
    try {
      // Use pre-extraction if SharePoint file is specified
      if (linkData.sharepointFileId && window.MODA_DRAWING_LINKS.pdf?.createLinkWithExtraction) {
        await window.MODA_DRAWING_LINKS.pdf.createLinkWithExtraction({
          projectId,
          ...linkData,
          createdBy: auth?.currentUser?.name || 'Unknown'
        }, projectName, onProgress);
      } else {
        await window.MODA_DRAWING_LINKS.create({
          projectId,
          ...linkData,
          createdBy: auth?.currentUser?.name || 'Unknown'
        });
      }
      // Refresh links
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
      setShowAddModal(false);
    } catch (error) {
      console.error('[DrawingLinksPanel] Error adding link:', error);
      // Don't show error for extraction failures - link is still saved
      if (!error.message?.includes('extraction')) {
        alert('Error adding link: ' + error.message);
      }
      // Refresh anyway - link was created, just extraction failed
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
      setShowAddModal(false);
    }
  }, [projectId, projectName, auth]);

  // Handle deleting a link
  const handleDeleteLink = useCallback(async linkId => {
    if (!confirm('Delete this link?')) return;
    try {
      await window.MODA_DRAWING_LINKS.delete(linkId);
      // Refresh links
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
    } catch (error) {
      console.error('[DrawingLinksPanel] Error deleting link:', error);
      alert('Error deleting link: ' + error.message);
    }
  }, [projectId]);

  // Handle resetting a link (clear configuration)
  const handleResetLink = useCallback(async linkId => {
    if (!confirm('Reset this link? This will clear the drawing and page configuration.')) return;
    try {
      // Use empty strings for NOT NULL constrained columns
      await window.MODA_DRAWING_LINKS.update(linkId, {
        packagePath: '',
        sharepointFileId: null,
        pageNumber: '',
        extractedFileId: null,
        extractionStatus: null,
        extractedAt: null
      });
      // Refresh links
      const data = await window.MODA_DRAWING_LINKS.getByProject(projectId);
      setLinks(data);
    } catch (error) {
      console.error('[DrawingLinksPanel] Error resetting link:', error);
      alert('Error resetting link: ' + error.message);
    }
  }, [projectId]);

  // Separate preset and custom links
  const presetLinks = useMemo(() => links.filter(l => l.is_preset), [links]);
  const customLinks = useMemo(() => links.filter(l => !l.is_preset), [links]);

  // Check if a link is configured
  const isConfigured = link => !!(link.package_path || link.sharepoint_file_id);
  if (!isAvailable()) {
    return null; // Don't render if not available
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border border-gray-200 shadow-sm mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between px-4 py-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50",
    onClick: () => setIsExpanded(!isExpanded)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-link text-blue-600"
  }), /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-800"
  }, "Linked Details"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"
  }, links.length, " links")), /*#__PURE__*/React.createElement("button", {
    className: "text-gray-400 hover:text-gray-600 transition-transform duration-200",
    style: {
      transform: isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)'
    }
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M19 9l-7 7-7-7"
  })))), isExpanded && /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center py-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
  }), /*#__PURE__*/React.createElement("span", {
    className: "ml-2 text-gray-500"
  }, "Loading links...")) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, presetLinks.map(link => /*#__PURE__*/React.createElement(LinkButton, {
    key: link.id,
    link: link,
    isConfigured: isConfigured(link),
    canEdit: canEdit,
    onClick: () => handleLinkClick(link),
    onConfigure: () => setShowConfigureModal(link),
    onReset: () => handleResetLink(link.id)
  })), customLinks.map(link => /*#__PURE__*/React.createElement(LinkButton, {
    key: link.id,
    link: link,
    isConfigured: isConfigured(link),
    canEdit: canEdit,
    onClick: () => handleLinkClick(link),
    onConfigure: () => setShowConfigureModal(link),
    onDelete: () => handleDeleteLink(link.id),
    onReset: () => handleResetLink(link.id),
    isCustom: true
  })), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddModal(true),
    className: "w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-colors"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 4v16m8-8H4"
  })), "Add Link"))), showConfigureModal && /*#__PURE__*/React.createElement(ConfigureLinkModal, {
    link: showConfigureModal,
    projectId: projectId,
    onSave: handleSaveLink,
    onClose: () => setShowConfigureModal(null)
  }), showAddModal && /*#__PURE__*/React.createElement(AddLinkModal, {
    projectId: projectId,
    onAdd: handleAddLink,
    onClose: () => setShowAddModal(false)
  }));
};

/**
 * Individual link button component
 */
const LinkButton = ({
  link,
  isConfigured,
  canEdit,
  onClick,
  onConfigure,
  onDelete,
  onReset,
  isCustom
}) => {
// [Removed duplicate React destructuring]
  const [showMenu, setShowMenu] = useState(false);
  return /*#__PURE__*/React.createElement("div", {
    className: "relative group"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClick,
    className: `w-full flex items-center justify-between px-4 py-2.5 rounded-lg border transition-all ${isConfigured ? 'bg-blue-50 border-blue-200 hover:bg-blue-100 hover:border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-200 hover:bg-gray-100 text-gray-500'}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, isConfigured ? /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4 text-blue-500",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  })) : /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4 text-gray-400",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
  })), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, link.label), isConfigured && link.page_number && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-blue-200 text-blue-700 px-1.5 py-0.5 rounded"
  }, String(link.page_number).includes(',') || String(link.page_number).includes('-') ? `Pages ${link.page_number}` : `Page ${link.page_number}`), isConfigured && link.extraction_status === 'ready' && link.extracted_file_id && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded",
    title: "Pre-extracted for instant access"
  }, "Fast"), isConfigured && link.extraction_status === 'extracting' && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded animate-pulse"
  }, "Extracting...")), !isConfigured && canEdit && /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400"
  }, "Click to configure")), canEdit && /*#__PURE__*/React.createElement("div", {
    className: "absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowMenu(!showMenu);
    },
    className: "p-1 hover:bg-white rounded"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4 text-gray-400",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
  }))), showMenu && /*#__PURE__*/React.createElement("div", {
    className: "absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 py-1 min-w-[120px]"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowMenu(false);
      onConfigure();
    },
    className: "w-full px-3 py-1.5 text-left text-sm text-gray-700 hover:bg-gray-100"
  }, "Configure"), isConfigured && onReset && /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowMenu(false);
      onReset();
    },
    className: "w-full px-3 py-1.5 text-left text-sm text-orange-600 hover:bg-orange-50"
  }, "Reset Link"), isCustom && onDelete && /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowMenu(false);
      onDelete();
    },
    className: "w-full px-3 py-1.5 text-left text-sm text-red-600 hover:bg-red-50"
  }, "Delete"))));
};

/**
 * Modal for configuring a link (selecting package and page)
 * Uses folder/tile navigation to browse disciplines and select drawings
 */
const ConfigureLinkModal = ({
  link,
  projectId,
  onSave,
  onClose
}) => {
// [Removed duplicate React destructuring]
  // Navigation state: 'disciplines' -> 'drawings' -> 'configure'
  const [step, setStep] = useState('disciplines');
  const [disciplines, setDisciplines] = useState([]);
  const [selectedDiscipline, setSelectedDiscipline] = useState(null);
  const [drawings, setDrawings] = useState([]);
  const [selectedDrawing, setSelectedDrawing] = useState(null);
  const [pageNumber, setPageNumber] = useState(link.page_number || 1);
  const [description, setDescription] = useState(link.description || '');
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);

  // Load disciplines (folders) for Permit Drawings category
  useEffect(() => {
    const loadDisciplines = async () => {
      if (!projectId || !window.MODA_SUPABASE_DRAWINGS) {
        setIsLoading(false);
        return;
      }
      setIsLoading(true);
      try {
        // Get custom folders for this project
        const folders = await window.MODA_SUPABASE_DRAWINGS.folders.getByProject(projectId);

        // Filter to only Permit Drawings disciplines
        const permitCategory = folders.find(f => f.folder_type === 'category' && (f.name === 'Permit Drawings' || f.name.toLowerCase().includes('permit')));
        if (permitCategory) {
          const permitDisciplines = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === permitCategory.id);
          setDisciplines(permitDisciplines);
        } else {
          // Use default permit disciplines
          const defaultDisciplines = [{
            id: 'modular-architecture',
            name: 'Modular Architect Submittal',
            isDefault: true
          }, {
            id: 'structural-plans',
            name: 'Structural Plans Submittal',
            isDefault: true
          }, {
            id: 'mechanical',
            name: 'Mechanical Submittal',
            isDefault: true
          }, {
            id: 'electrical',
            name: 'Electrical Submittal',
            isDefault: true
          }, {
            id: 'fire-alarm',
            name: 'Fire Alarm Data Submittal',
            isDefault: true
          }, {
            id: 'title-24',
            name: 'Title 24',
            isDefault: true
          }];
          setDisciplines(defaultDisciplines);
        }
      } catch (error) {
        console.error('[ConfigureLinkModal] Error loading disciplines:', error);
      } finally {
        setIsLoading(false);
      }
    };
    loadDisciplines();
  }, [projectId]);

  // Load drawings when a discipline is selected
  const handleSelectDiscipline = async discipline => {
    setSelectedDiscipline(discipline);
    setIsLoading(true);
    try {
      // Fetch ALL drawings for this project, then filter by discipline
      // This handles cases where discipline is stored as ID or name
      const allDrawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProject(projectId);

      // Filter by discipline - match by ID, name, or partial match
      const disciplineId = discipline.id || '';
      const disciplineName = discipline.name || '';
      const filteredDrawings = allDrawings.filter(d => {
        const drawingDiscipline = (d.discipline || '').toLowerCase();
        return drawingDiscipline === disciplineId.toLowerCase() || drawingDiscipline === disciplineName.toLowerCase() || disciplineName.toLowerCase().includes(drawingDiscipline) || drawingDiscipline.includes(disciplineName.toLowerCase().split(' ')[0]);
      });
      setDrawings(filteredDrawings);
      setStep('drawings');
    } catch (error) {
      console.error('[ConfigureLinkModal] Error loading drawings:', error);
      setDrawings([]);
    } finally {
      setIsLoading(false);
    }
  };

  // Handle selecting a drawing
  const handleSelectDrawing = drawing => {
    setSelectedDrawing(drawing);
    setStep('configure');
  };

  // Extraction progress state
  const [extractionProgress, setExtractionProgress] = useState(null);

  // Handle save with extraction progress
  const handleSave = async () => {
    if (!selectedDrawing) {
      alert('Please select a drawing package');
      return;
    }

    // Get the latest version's SharePoint file ID
    const latestVersion = selectedDrawing.versions?.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))[0];
    setIsSaving(true);
    setExtractionProgress({
      status: 'starting',
      percent: 0
    });
    try {
      await onSave(link.id, {
        packagePath: latestVersion?.storage_path || '',
        sharepointFileId: latestVersion?.sharepoint_file_id || null,
        pageNumber: pageNumber || '1',
        description: description || null
      }, progress => {
        setExtractionProgress(progress);
      });
    } finally {
      setIsSaving(false);
      setExtractionProgress(null);
    }
  };

  // Go back one step
  const handleBack = () => {
    if (step === 'configure') {
      setStep('drawings');
      setSelectedDrawing(null);
    } else if (step === 'drawings') {
      setStep('disciplines');
      setSelectedDiscipline(null);
      setDrawings([]);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-200 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, step !== 'disciplines' && /*#__PURE__*/React.createElement("button", {
    onClick: handleBack,
    className: "p-1 hover:bg-gray-100 rounded transition-colors"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-gray-500",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 19l-7-7 7-7"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-gray-800"
  }, "Configure: ", link.label), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, step === 'disciplines' && 'Select a discipline folder', step === 'drawings' && `${selectedDiscipline?.name} - Select a drawing`, step === 'configure' && `${selectedDrawing?.name} - Set page number`))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-1 hover:bg-gray-100 rounded"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-gray-400",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto p-6"
  }, isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center py-12"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
  }), /*#__PURE__*/React.createElement("span", {
    className: "ml-3 text-gray-500"
  }, "Loading...")) : step === 'disciplines' ?
  /*#__PURE__*/
  /* Discipline Tiles */
  React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-3 gap-3"
  }, disciplines.map(discipline => /*#__PURE__*/React.createElement("button", {
    key: discipline.id,
    onClick: () => handleSelectDiscipline(discipline),
    className: "p-4 bg-amber-50 border-2 border-amber-200 rounded-lg hover:border-amber-400 hover:bg-amber-100 transition-all text-left"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-10 h-10 rounded-lg bg-amber-200 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder w-5 h-5 text-amber-700"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-gray-800 text-sm truncate"
  }, discipline.name))))), disciplines.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "col-span-full text-center py-8 text-gray-500"
  }, "No discipline folders found")) : step === 'drawings' ?
  /*#__PURE__*/
  /* Drawing Tiles */
  React.createElement("div", {
    className: "space-y-2"
  }, drawings.map(drawing => /*#__PURE__*/React.createElement("button", {
    key: drawing.id,
    onClick: () => handleSelectDrawing(drawing),
    className: "w-full p-3 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all text-left flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-blue-600",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-gray-800 truncate"
  }, drawing.name), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, drawing.versions?.length || 0, " version(s)")))), drawings.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "No drawings in this folder"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm mt-1"
  }, "Upload drawings to this discipline first"))) :
  /*#__PURE__*/
  /* Configure Page Number */
  React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-blue-800"
  }, selectedDrawing?.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-blue-600 mt-1"
  }, "from ", selectedDiscipline?.name), /*#__PURE__*/React.createElement("button", {
    onClick: async () => {
      const latestVersion = selectedDrawing.versions?.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))[0];
      if (latestVersion?.sharepoint_file_id && window.MODA_SHAREPOINT?.getPreviewUrl) {
        const url = await window.MODA_SHAREPOINT.getPreviewUrl(latestVersion.sharepoint_file_id);
        window.open(url, '_blank');
      } else if (latestVersion?.file_url) {
        window.open(latestVersion.file_url, '_blank');
      }
    },
    className: "mt-2 text-sm text-blue-700 hover:text-blue-900 underline flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
  })), "Open PDF to find page numbers")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Page Number(s) *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: pageNumber,
    onChange: e => setPageNumber(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "e.g., 5 or 3,7,12 or 1-5"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "Single page (5), multiple pages (3,7,12), or range (1-5)")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description (optional)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: description,
    onChange: e => setDescription(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "Additional notes about this link"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-t border-gray-200 flex justify-end gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
  }, "Cancel"), step === 'configure' && /*#__PURE__*/React.createElement("button", {
    onClick: handleSave,
    disabled: isSaving || !selectedDrawing,
    className: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors min-w-[140px]"
  }, isSaving ? /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4 animate-spin",
    fill: "none",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("circle", {
    className: "opacity-25",
    cx: "12",
    cy: "12",
    r: "10",
    stroke: "currentColor",
    strokeWidth: "4"
  }), /*#__PURE__*/React.createElement("path", {
    className: "opacity-75",
    fill: "currentColor",
    d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
  })), extractionProgress?.status === 'downloading' && 'Downloading...', extractionProgress?.status === 'extracting' && 'Extracting...', extractionProgress?.status === 'uploading' && 'Uploading...', (!extractionProgress?.status || extractionProgress?.status === 'starting') && 'Saving...') : 'Save Link'))));
};

/**
 * Modal for adding a new custom link
 * Uses folder/tile navigation to browse disciplines and select drawings
 */
const AddLinkModal = ({
  projectId,
  onAdd,
  onClose
}) => {
// [Removed duplicate React destructuring]
  // Navigation state: 'label' -> 'disciplines' -> 'drawings' -> 'configure'
  const [step, setStep] = useState('label');
  const [label, setLabel] = useState('');
  const [disciplines, setDisciplines] = useState([]);
  const [selectedDiscipline, setSelectedDiscipline] = useState(null);
  const [drawings, setDrawings] = useState([]);
  const [selectedDrawing, setSelectedDrawing] = useState(null);
  const [pageNumber, setPageNumber] = useState(1);
  const [description, setDescription] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // Load disciplines when moving to that step
  const loadDisciplines = async () => {
    if (!projectId || !window.MODA_SUPABASE_DRAWINGS) return;
    setIsLoading(true);
    try {
      const folders = await window.MODA_SUPABASE_DRAWINGS.folders.getByProject(projectId);
      const permitCategory = folders.find(f => f.folder_type === 'category' && (f.name === 'Permit Drawings' || f.name.toLowerCase().includes('permit')));
      if (permitCategory) {
        const permitDisciplines = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === permitCategory.id);
        setDisciplines(permitDisciplines);
      } else {
        const defaultDisciplines = [{
          id: 'modular-architecture',
          name: 'Modular Architect Submittal',
          isDefault: true
        }, {
          id: 'structural-plans',
          name: 'Structural Plans Submittal',
          isDefault: true
        }, {
          id: 'mechanical',
          name: 'Mechanical Submittal',
          isDefault: true
        }, {
          id: 'electrical',
          name: 'Electrical Submittal',
          isDefault: true
        }, {
          id: 'fire-alarm',
          name: 'Fire Alarm Data Submittal',
          isDefault: true
        }, {
          id: 'title-24',
          name: 'Title 24',
          isDefault: true
        }];
        setDisciplines(defaultDisciplines);
      }
    } catch (error) {
      console.error('[AddLinkModal] Error loading disciplines:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Handle proceeding from label step
  const handleLabelNext = () => {
    if (!label.trim()) {
      alert('Please enter a label for the link');
      return;
    }
    setStep('disciplines');
    loadDisciplines();
  };

  // Load drawings when a discipline is selected
  const handleSelectDiscipline = async discipline => {
    setSelectedDiscipline(discipline);
    setIsLoading(true);
    try {
      // Fetch ALL drawings for this project, then filter by discipline
      const allDrawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProject(projectId);
      const disciplineId = discipline.id || '';
      const disciplineName = discipline.name || '';
      const filteredDrawings = allDrawings.filter(d => {
        const drawingDiscipline = (d.discipline || '').toLowerCase();
        return drawingDiscipline === disciplineId.toLowerCase() || drawingDiscipline === disciplineName.toLowerCase() || disciplineName.toLowerCase().includes(drawingDiscipline) || drawingDiscipline.includes(disciplineName.toLowerCase().split(' ')[0]);
      });
      setDrawings(filteredDrawings);
      setStep('drawings');
    } catch (error) {
      console.error('[AddLinkModal] Error loading drawings:', error);
      setDrawings([]);
    } finally {
      setIsLoading(false);
    }
  };

  // Handle selecting a drawing
  const handleSelectDrawing = drawing => {
    setSelectedDrawing(drawing);
    setStep('configure');
  };

  // Extraction progress state
  const [extractionProgress, setExtractionProgress] = useState(null);

  // Handle add with extraction progress
  const handleAdd = async () => {
    if (!selectedDrawing) return;
    const latestVersion = selectedDrawing.versions?.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))[0];
    setIsSaving(true);
    setExtractionProgress({
      status: 'starting',
      percent: 0
    });
    try {
      await onAdd({
        label: label.trim(),
        packagePath: latestVersion?.storage_path || '',
        sharepointFileId: latestVersion?.sharepoint_file_id || null,
        pageNumber: pageNumber || '1',
        description: description || null,
        isPreset: false
      }, progress => {
        setExtractionProgress(progress);
      });
    } finally {
      setIsSaving(false);
      setExtractionProgress(null);
    }
  };

  // Go back one step
  const handleBack = () => {
    if (step === 'configure') {
      setStep('drawings');
      setSelectedDrawing(null);
    } else if (step === 'drawings') {
      setStep('disciplines');
      setSelectedDiscipline(null);
      setDrawings([]);
    } else if (step === 'disciplines') {
      setStep('label');
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-200 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, step !== 'label' && /*#__PURE__*/React.createElement("button", {
    onClick: handleBack,
    className: "p-1 hover:bg-gray-100 rounded transition-colors"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-gray-500",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 19l-7-7 7-7"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-gray-800"
  }, "Add Custom Link"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, step === 'label' && 'Enter a label for the link', step === 'disciplines' && 'Select a discipline folder', step === 'drawings' && `${selectedDiscipline?.name} - Select a drawing`, step === 'configure' && `${selectedDrawing?.name} - Set page number`))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-1 hover:bg-gray-100 rounded"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-gray-400",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto p-6"
  }, isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center py-12"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
  }), /*#__PURE__*/React.createElement("span", {
    className: "ml-3 text-gray-500"
  }, "Loading...")) : step === 'label' ?
  /*#__PURE__*/
  /* Label Input */
  React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Link Label *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: label,
    onChange: e => setLabel(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "e.g., Foundation Plan, Roof Framing",
    autoFocus: true
  }))) : step === 'disciplines' ?
  /*#__PURE__*/
  /* Discipline Tiles */
  React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-3 gap-3"
  }, disciplines.map(discipline => /*#__PURE__*/React.createElement("button", {
    key: discipline.id,
    onClick: () => handleSelectDiscipline(discipline),
    className: "p-4 bg-amber-50 border-2 border-amber-200 rounded-lg hover:border-amber-400 hover:bg-amber-100 transition-all text-left"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-10 h-10 rounded-lg bg-amber-200 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder w-5 h-5 text-amber-700"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-gray-800 text-sm truncate"
  }, discipline.name)))))) : step === 'drawings' ?
  /*#__PURE__*/
  /* Drawing Tiles */
  React.createElement("div", {
    className: "space-y-2"
  }, drawings.map(drawing => /*#__PURE__*/React.createElement("button", {
    key: drawing.id,
    onClick: () => handleSelectDrawing(drawing),
    className: "w-full p-3 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all text-left flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-blue-600",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-gray-800 truncate"
  }, drawing.name), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, drawing.versions?.length || 0, " version(s)")))), drawings.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "No drawings in this folder"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm mt-1"
  }, "Upload drawings to this discipline first"))) :
  /*#__PURE__*/
  /* Configure Page Number */
  React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, "Creating link:"), /*#__PURE__*/React.createElement("p", {
    className: "font-semibold text-blue-800"
  }, label), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-blue-600 mt-1"
  }, selectedDrawing?.name), /*#__PURE__*/React.createElement("button", {
    onClick: async () => {
      const latestVersion = selectedDrawing.versions?.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))[0];
      if (latestVersion?.sharepoint_file_id && window.MODA_SHAREPOINT?.getPreviewUrl) {
        const url = await window.MODA_SHAREPOINT.getPreviewUrl(latestVersion.sharepoint_file_id);
        window.open(url, '_blank');
      } else if (latestVersion?.file_url) {
        window.open(latestVersion.file_url, '_blank');
      }
    },
    className: "mt-2 text-sm text-blue-700 hover:text-blue-900 underline flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
  })), "Open PDF to find page numbers")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Page Number(s) *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: pageNumber,
    onChange: e => setPageNumber(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "e.g., 5 or 3,7,12 or 1-5"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "Single page (5), multiple pages (3,7,12), or range (1-5)")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description (optional)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: description,
    onChange: e => setDescription(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "Additional notes"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-t border-gray-200 flex justify-end gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
  }, "Cancel"), step === 'label' && /*#__PURE__*/React.createElement("button", {
    onClick: handleLabelNext,
    disabled: !label.trim(),
    className: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
  }, "Next"), step === 'configure' && /*#__PURE__*/React.createElement("button", {
    onClick: handleAdd,
    disabled: isSaving || !selectedDrawing,
    className: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors min-w-[140px]"
  }, isSaving ? /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4 animate-spin",
    fill: "none",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("circle", {
    className: "opacity-25",
    cx: "12",
    cy: "12",
    r: "10",
    stroke: "currentColor",
    strokeWidth: "4"
  }), /*#__PURE__*/React.createElement("path", {
    className: "opacity-75",
    fill: "currentColor",
    d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
  })), extractionProgress?.status === 'downloading' && 'Downloading...', extractionProgress?.status === 'extracting' && 'Extracting...', extractionProgress?.status === 'uploading' && 'Uploading...', (!extractionProgress?.status || extractionProgress?.status === 'starting') && 'Adding...') : 'Add Link'))));
};

// Export for use in other components
window.DrawingLinksPanel = DrawingLinksPanel;
})();


// ============================================================================
// FILE: DrawingsModule.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA DRAWINGS MODULE
// Document management for project drawings with version control
// Uses Supabase for storage with localStorage fallback
// ============================================================================
// [Removed duplicate React destructuring]
const DrawingsModule = ({
  projects = [],
  auth
}) => {
  // Mobile detection - view-only mode on mobile devices
  const isMobile = useMemo(() => {
    if (typeof window === 'undefined') return false;
    return window.innerWidth < 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }, []);

  // Navigation state
  const [selectedProject, setSelectedProject] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [selectedDiscipline, setSelectedDiscipline] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  // Drawing files state - flat array for current view
  const [currentDrawings, setCurrentDrawings] = useState([]);
  const [drawingCounts, setDrawingCounts] = useState({});
  const [isLoading, setIsLoading] = useState(true);
  const [uploadProgress, setUploadProgress] = useState(null); // { current, total, fileName, percent, status, timeRemaining }

  // Sorting state for Module Packages view
  const [sortColumn, setSortColumn] = useState('buildSequence'); // Default sort by Build Seq
  const [sortDirection, setSortDirection] = useState('asc'); // Default ascending

  // Modal states
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [showVersionHistory, setShowVersionHistory] = useState(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [showFolderModal, setShowFolderModal] = useState(null); // { mode: 'add'|'edit', type: 'category'|'discipline', folder?: existing }
  const [showDeleteFolderConfirm, setShowDeleteFolderConfirm] = useState(null);
  const [showDuplicatePrompt, setShowDuplicatePrompt] = useState(null); // { file, existingDrawing, metadata, disciplineToUse, onAction }
  const [uploadStartTime, setUploadStartTime] = useState(null); // Track upload start time for estimates
  const uploadCancelledRef = useRef(false); // Ref for cancel flag (refs update synchronously, unlike state)
  const [showSheetBrowser, setShowSheetBrowser] = useState(false);
  const [showEditDrawing, setShowEditDrawing] = useState(null); // Drawing object to edit
  const [showDeletedDrawings, setShowDeletedDrawings] = useState(false); // Show deleted drawings for recovery
  const [showFileInfo, setShowFileInfo] = useState(null); // Drawing object for file info modal
  const [processingDrawing, setProcessingDrawing] = useState(null); // { drawingId, status, progress }
  const [selectedDrawings, setSelectedDrawings] = useState([]); // Array of drawing IDs selected for OCR
  const [drawingSearchTerm, setDrawingSearchTerm] = useState(''); // Search/filter for drawings list
  const [showBulkRenameModal, setShowBulkRenameModal] = useState(false); // Bulk rename unlinked drawings
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false); // Toggle advanced filter panel
  const [advancedFilters, setAdvancedFilters] = useState({
    unitTypes: [],
    roomTypes: [],
    difficulties: []
  }); // Multi-select filters
  const [issueStatusFilter, setIssueStatusFilter] = useState('all'); // 'all' | 'green' | 'yellow' - filter by issue status
  const [pdfViewerData, setPdfViewerData] = useState(null); // { url, name, drawingId, versionId } for PDF viewer modal
  const [showDrawingStatusLog, setShowDrawingStatusLog] = useState(false); // Drawing status matrix modal
  const [showAIMenu, setShowAIMenu] = useState(false); // AI Analysis dropdown menu
  const [showAnalysisBrowser, setShowAnalysisBrowser] = useState(null); // 'walls' | 'fixtures' | 'changes' | null

  // Custom folders state (loaded from Supabase)
  const [customCategories, setCustomCategories] = useState([]);
  const [customDisciplines, setCustomDisciplines] = useState({});
  const [foldersLoading, setFoldersLoading] = useState(false);

  // Check if Supabase drawings module is available
  const isSupabaseAvailable = () => window.MODA_SUPABASE_DRAWINGS?.isAvailable?.();

  // Check if user can manage folders (Admin role only)
  const canManageFolders = useMemo(() => {
    const role = auth?.currentUser?.dashboardRole;
    return role === 'admin' || role === 'Admin';
  }, [auth]);

  // Available folder colors
  const FOLDER_COLORS = [{
    id: 'gray',
    label: 'Gray',
    value: 'bg-gray-100 border-gray-400'
  }, {
    id: 'red',
    label: 'Red',
    value: 'bg-red-100 border-red-400'
  }, {
    id: 'orange',
    label: 'Orange',
    value: 'bg-orange-100 border-orange-400'
  }, {
    id: 'amber',
    label: 'Amber',
    value: 'bg-amber-100 border-amber-400'
  }, {
    id: 'yellow',
    label: 'Yellow',
    value: 'bg-yellow-100 border-yellow-400'
  }, {
    id: 'lime',
    label: 'Lime',
    value: 'bg-lime-100 border-lime-400'
  }, {
    id: 'green',
    label: 'Green',
    value: 'bg-green-100 border-green-400'
  }, {
    id: 'teal',
    label: 'Teal',
    value: 'bg-teal-100 border-teal-400'
  }, {
    id: 'cyan',
    label: 'Cyan',
    value: 'bg-cyan-100 border-cyan-400'
  }, {
    id: 'blue',
    label: 'Blue',
    value: 'bg-blue-100 border-blue-400'
  }, {
    id: 'indigo',
    label: 'Indigo',
    value: 'bg-indigo-100 border-indigo-400'
  }, {
    id: 'purple',
    label: 'Purple',
    value: 'bg-purple-100 border-purple-400'
  }, {
    id: 'pink',
    label: 'Pink',
    value: 'bg-pink-100 border-pink-400'
  }, {
    id: 'slate',
    label: 'Slate',
    value: 'bg-slate-100 border-slate-400'
  }];

  // Drawing Categories (top-level folders)
  const DRAWING_CATEGORIES = [{
    id: 'permit-drawings',
    name: 'Permit Drawings',
    icon: 'icon-folder',
    color: 'bg-blue-100 border-blue-500',
    description: 'Official permit and submittal drawings'
  }, {
    id: 'shop-drawings',
    name: 'Shop Drawings',
    icon: 'icon-folder',
    color: 'bg-amber-100 border-amber-500',
    description: 'Fabrication and shop drawings'
  }];

  // Disciplines within Permit Drawings category
  const PERMIT_DISCIPLINES = [{
    id: 'aor-reference',
    name: 'AOR Reference Submittal',
    icon: 'icon-folder',
    color: 'bg-amber-100 border-amber-400'
  }, {
    id: 'architectural-general',
    name: 'Architectural General Submittal',
    icon: 'icon-folder',
    color: 'bg-blue-100 border-blue-400'
  }, {
    id: 'assembly-book',
    name: 'Assembly Book Submittal',
    icon: 'icon-folder',
    color: 'bg-purple-100 border-purple-400'
  }, {
    id: 'electrical',
    name: 'Electrical Submittal',
    icon: 'icon-folder',
    color: 'bg-yellow-100 border-yellow-400'
  }, {
    id: 'fire-alarm-data',
    name: 'Fire Alarm Data Submittal',
    icon: 'icon-folder',
    color: 'bg-red-100 border-red-400'
  }, {
    id: 'fire-alarm',
    name: 'Fire Alarm Submittal',
    icon: 'icon-folder',
    color: 'bg-red-100 border-red-400'
  }, {
    id: 'fire-sprinkler',
    name: 'Fire Sprinkler Submittal',
    icon: 'icon-folder',
    color: 'bg-orange-100 border-orange-400'
  }, {
    id: 'mechanical',
    name: 'Mechanical Submittal',
    icon: 'icon-folder',
    color: 'bg-cyan-100 border-cyan-400'
  }, {
    id: 'modular-architect',
    name: 'Modular Architect Submittal',
    icon: 'icon-folder',
    color: 'bg-indigo-100 border-indigo-400'
  }, {
    id: 'plumbing',
    name: 'Plumbing Submittal',
    icon: 'icon-folder',
    color: 'bg-teal-100 border-teal-400'
  }, {
    id: 'sprinkler-plans',
    name: 'Sprinkler Submittal Plans',
    icon: 'icon-folder',
    color: 'bg-orange-100 border-orange-400'
  }, {
    id: 'structural-documents',
    name: 'Structural Documents',
    icon: 'icon-folder',
    color: 'bg-gray-100 border-gray-400'
  }, {
    id: 'structural-plans',
    name: 'Structural Plans Submittal',
    icon: 'icon-folder',
    color: 'bg-slate-100 border-slate-400'
  }, {
    id: 'title-24',
    name: 'Title 24',
    icon: 'icon-folder',
    color: 'bg-green-100 border-green-400'
  }];

  // Disciplines within Shop Drawings category
  const SHOP_DISCIPLINES = [{
    id: 'shop-module-packages',
    name: 'Module Packages',
    icon: 'icon-folder',
    color: 'bg-emerald-100 border-emerald-400'
  }, {
    id: 'shop-soffits',
    name: 'Soffits',
    icon: 'icon-folder',
    color: 'bg-slate-100 border-slate-400'
  }, {
    id: 'shop-reference',
    name: 'Reference Sheets',
    icon: 'icon-folder',
    color: 'bg-blue-100 border-blue-400'
  }, {
    id: 'shop-prototype',
    name: 'Prototype Drawings',
    icon: 'icon-folder',
    color: 'bg-purple-100 border-purple-400'
  }, {
    id: 'shop-interior-walls',
    name: 'Interior Walls',
    icon: 'icon-folder',
    color: 'bg-cyan-100 border-cyan-400'
  }, {
    id: 'shop-end-walls',
    name: 'End Walls',
    icon: 'icon-folder',
    color: 'bg-teal-100 border-teal-400'
  }, {
    id: 'shop-corridor-walls',
    name: 'Corridor Walls',
    icon: 'icon-folder',
    color: 'bg-amber-100 border-amber-400'
  }, {
    id: 'shop-3hr-walls',
    name: '3HR Walls',
    icon: 'icon-folder',
    color: 'bg-red-100 border-red-400'
  }];

  // Get disciplines for current category
  const getCurrentDisciplines = () => {
    if (selectedCategory === 'permit-drawings') return PERMIT_DISCIPLINES;
    if (selectedCategory === 'shop-drawings') return SHOP_DISCIPLINES;
    return [];
  };

  // Legacy: All disciplines combined for backwards compatibility
  const DISCIPLINES = [...PERMIT_DISCIPLINES, ...SHOP_DISCIPLINES];

  // Storage key for localStorage fallback
  const STORAGE_KEY = 'moda_drawings_data';

  // Load drawing counts when project is selected
  useEffect(() => {
    const loadDrawingCounts = async () => {
      if (!selectedProject) {
        setDrawingCounts({});
        return;
      }
      try {
        if (isSupabaseAvailable()) {
          const counts = await window.MODA_SUPABASE_DRAWINGS.drawings.getCountsByProject(selectedProject.id);
          console.log('[Drawings] Raw counts from Supabase:', counts);
          const countsMap = {};
          counts.forEach(c => {
            countsMap[c.discipline] = c.count;
          });
          console.log('[Drawings] Counts map:', countsMap);
          setDrawingCounts(countsMap);
        } else {
          // Fallback to localStorage
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            const data = JSON.parse(stored);
            const projectDrawings = data[selectedProject.id] || {};
            const countsMap = {};
            Object.keys(projectDrawings).forEach(discipline => {
              countsMap[discipline] = (projectDrawings[discipline] || []).length;
            });
            setDrawingCounts(countsMap);
          }
        }
      } catch (error) {
        console.error('[Drawings] Error loading counts:', error);
      }
    };
    loadDrawingCounts();
  }, [selectedProject]);

  // Load drawings when discipline is selected
  useEffect(() => {
    const loadDrawings = async () => {
      if (!selectedProject || !selectedDiscipline) {
        setCurrentDrawings([]);
        return;
      }
      setIsLoading(true);
      try {
        if (isSupabaseAvailable()) {
          const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
          setCurrentDrawings(drawings);
        } else {
          // Fallback to localStorage
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            const data = JSON.parse(stored);
            const projectDrawings = data[selectedProject.id] || {};
            setCurrentDrawings(projectDrawings[selectedDiscipline] || []);
          } else {
            setCurrentDrawings([]);
          }
        }
      } catch (error) {
        console.error('[Drawings] Error loading drawings:', error);
        setCurrentDrawings([]);
      } finally {
        setIsLoading(false);
      }
    };
    loadDrawings();
  }, [selectedProject, selectedDiscipline]);

  // Load custom folders when project is selected
  useEffect(() => {
    const loadCustomFolders = async () => {
      if (!selectedProject) {
        setCustomCategories([]);
        setCustomDisciplines({});
        return;
      }
      setFoldersLoading(true);
      try {
        if (isSupabaseAvailable() && window.MODA_SUPABASE_DRAWINGS.folders) {
          // Try to load custom folders from Supabase
          let folders = await window.MODA_SUPABASE_DRAWINGS.folders.getByProject(selectedProject.id);

          // If no folders exist, initialize defaults
          if (folders.length === 0) {
            folders = await window.MODA_SUPABASE_DRAWINGS.folders.initializeDefaults(selectedProject.id, auth?.currentUser?.name || 'System');
          }

          // Separate categories and disciplines
          const categories = folders.filter(f => f.folder_type === 'category');
          const disciplines = {};
          categories.forEach(cat => {
            disciplines[cat.id] = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === cat.id);
          });
          setCustomCategories(categories);
          setCustomDisciplines(disciplines);
        }
      } catch (error) {
        console.error('[Drawings] Error loading custom folders:', error);
        // Fall back to static folders on error
      } finally {
        setFoldersLoading(false);
      }
    };
    loadCustomFolders();
  }, [selectedProject, auth]);

  // Get categories - use custom if available, otherwise static
  const getCategories = useCallback(() => {
    if (customCategories.length > 0) {
      return customCategories.map(c => ({
        id: c.id,
        name: c.name,
        color: c.color,
        description: c.is_default ? 'Default category' : 'Custom category',
        isCustom: true
      }));
    }
    return DRAWING_CATEGORIES;
  }, [customCategories]);

  // Get disciplines for a category - use custom if available
  const getDisciplinesForCategory = useCallback(categoryId => {
    // Check if we have custom disciplines for this category
    if (customDisciplines[categoryId] && customDisciplines[categoryId].length > 0) {
      return customDisciplines[categoryId].map(d => ({
        id: d.id,
        name: d.name,
        color: d.color,
        isCustom: true
      }));
    }
    // Fall back to static disciplines based on category name
    const category = customCategories.find(c => c.id === categoryId);
    if (category?.name === 'Permit Drawings' || categoryId === 'permit-drawings') {
      return PERMIT_DISCIPLINES;
    }
    if (category?.name === 'Shop Drawings' || categoryId === 'shop-drawings') {
      return SHOP_DISCIPLINES;
    }
    return [];
  }, [customCategories, customDisciplines]);

  // Handle folder create/update
  const handleSaveFolder = useCallback(async folderData => {
    if (!selectedProject || !canManageFolders) return;
    try {
      if (isSupabaseAvailable() && window.MODA_SUPABASE_DRAWINGS.folders) {
        if (folderData.id) {
          // Update existing folder
          await window.MODA_SUPABASE_DRAWINGS.folders.update(folderData.id, {
            name: folderData.name,
            color: folderData.color
          });
        } else {
          // Create new folder
          await window.MODA_SUPABASE_DRAWINGS.folders.create({
            projectId: selectedProject.id,
            parentId: folderData.parentId || null,
            name: folderData.name,
            folderType: folderData.folderType,
            color: folderData.color,
            sortOrder: folderData.sortOrder || 999,
            createdBy: auth?.currentUser?.name || 'Unknown'
          });
        }

        // Reload folders
        const folders = await window.MODA_SUPABASE_DRAWINGS.folders.getByProject(selectedProject.id);
        const categories = folders.filter(f => f.folder_type === 'category');
        const disciplines = {};
        categories.forEach(cat => {
          disciplines[cat.id] = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === cat.id);
        });
        setCustomCategories(categories);
        setCustomDisciplines(disciplines);
      }
    } catch (error) {
      console.error('[Drawings] Error saving folder:', error);
      alert('Error saving folder: ' + error.message);
    } finally {
      setShowFolderModal(null);
    }
  }, [selectedProject, auth, canManageFolders]);

  // Handle folder delete
  const handleDeleteFolder = useCallback(async folderId => {
    if (!selectedProject || !canManageFolders) return;
    try {
      if (isSupabaseAvailable() && window.MODA_SUPABASE_DRAWINGS.folders) {
        await window.MODA_SUPABASE_DRAWINGS.folders.delete(folderId);

        // Reload folders
        const folders = await window.MODA_SUPABASE_DRAWINGS.folders.getByProject(selectedProject.id);
        const categories = folders.filter(f => f.folder_type === 'category');
        const disciplines = {};
        categories.forEach(cat => {
          disciplines[cat.id] = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === cat.id);
        });
        setCustomCategories(categories);
        setCustomDisciplines(disciplines);
      }
    } catch (error) {
      console.error('[Drawings] Error deleting folder:', error);
      alert('Error deleting folder: ' + error.message);
    } finally {
      setShowDeleteFolderConfirm(null);
    }
  }, [selectedProject, canManageFolders]);

  // Handle reset folders to defaults
  const handleResetFolders = useCallback(async () => {
    if (!selectedProject || !canManageFolders) return;
    if (!confirm('Reset all folders to defaults? This will delete any custom folders you have created.')) {
      return;
    }
    setFoldersLoading(true);
    try {
      if (isSupabaseAvailable() && window.MODA_SUPABASE_DRAWINGS.folders) {
        const folders = await window.MODA_SUPABASE_DRAWINGS.folders.resetToDefaults(selectedProject.id, auth?.currentUser?.name || 'System');

        // Separate categories and disciplines
        const categories = folders.filter(f => f.folder_type === 'category');
        const disciplines = {};
        categories.forEach(cat => {
          disciplines[cat.id] = folders.filter(f => f.folder_type === 'discipline' && f.parent_id === cat.id);
        });
        setCustomCategories(categories);
        setCustomDisciplines(disciplines);

        // Reset navigation to categories level
        setSelectedCategory(null);
        setSelectedDiscipline(null);
      }
    } catch (error) {
      console.error('[Drawings] Error resetting folders:', error);
      alert('Error resetting folders: ' + error.message);
    } finally {
      setFoldersLoading(false);
    }
  }, [selectedProject, auth, canManageFolders]);

  // Get drawing count for a discipline - checks by ID and also by name-based static ID
  const getDrawingCount = useCallback((disciplineId, disciplineName) => {
    // Direct ID match
    if (drawingCounts[disciplineId]) {
      return drawingCounts[disciplineId];
    }

    // Try matching by static ID pattern based on discipline name
    // This handles the case where folders have UUID IDs but drawings were uploaded with static IDs
    if (disciplineName) {
      const staticIdMap = {
        'Module Packages': 'shop-module-packages',
        'Soffits': 'shop-soffits',
        'Reference Sheets': 'shop-reference',
        'Prototype Drawings': 'shop-prototype',
        'Interior Walls': 'shop-interior-walls',
        'End Walls': 'shop-endwalls',
        'Corridor Walls': 'shop-corridor-walls',
        '3HR Walls': 'shop-3hr-walls'
      };
      const staticId = staticIdMap[disciplineName];
      if (staticId && drawingCounts[staticId]) {
        return drawingCounts[staticId];
      }
    }
    return 0;
  }, [drawingCounts]);

  // Check if current discipline is Module Packages
  const isModulePackages = useMemo(() => {
    return selectedDiscipline === 'shop-module-packages' || selectedDiscipline === 'Module Packages';
  }, [selectedDiscipline]);

  // Find module data from project by BLM ID
  // Handles partial matches: L6M08 matches B1L6M08, L6M08 matches B2L6M08, etc.
  const findModuleByBLM = useCallback(blmId => {
    if (!blmId || !selectedProject?.modules) return null;
    const normalizedBLM = blmId.toUpperCase().replace(/[_\-\s]/g, '');

    // Extract just the L#M## part for partial matching
    const lmPattern = normalizedBLM.match(/L\d+M\d+/)?.[0];
    return selectedProject.modules.find(m => {
      const hitchBLM = (m.hitchBLM || '').toUpperCase().replace(/[_\-\s]/g, '');
      const rearBLM = (m.rearBLM || '').toUpperCase().replace(/[_\-\s]/g, '');

      // Exact match first
      if (hitchBLM === normalizedBLM || rearBLM === normalizedBLM) return true;

      // Partial match: L6M08 matches B1L6M08 (BLM ends with the pattern)
      if (lmPattern) {
        if (hitchBLM.endsWith(lmPattern) || rearBLM.endsWith(lmPattern)) return true;
      }
      return false;
    });
  }, [selectedProject]);

  // Get latest version of a drawing
  const getLatestVersion = useCallback(drawing => {
    if (!drawing.versions || drawing.versions.length === 0) return null;
    // Sort by uploaded_at descending and return first
    const sorted = [...drawing.versions].sort((a, b) => new Date(b.uploaded_at || b.uploadedAt) - new Date(a.uploaded_at || a.uploadedAt));
    return sorted[0];
  }, []);

  // Handle column sort click
  const handleSort = useCallback(column => {
    if (sortColumn === column) {
      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortColumn(column);
      setSortDirection('asc');
    }
  }, [sortColumn]);

  // Difficulty filter options
  const DIFFICULTY_OPTIONS = [{
    id: 'sidewall',
    label: 'Sidewall'
  }, {
    id: 'stair',
    label: 'Stair'
  }, {
    id: 'hr3Wall',
    label: '3HR Wall'
  }, {
    id: 'short',
    label: 'Short'
  }, {
    id: 'doubleStudio',
    label: 'Double Studio'
  }, {
    id: 'sawbox',
    label: 'Sawbox'
  }];

  // Compute available filter options from project modules
  const filterOptions = useMemo(() => {
    if (!selectedProject?.modules) return {
      unitTypes: [],
      roomTypes: [],
      topUnitTypes: [],
      topRoomTypes: []
    };
    const unitTypeCounts = {};
    const roomTypeCounts = {};
    selectedProject.modules.forEach(m => {
      // Collect unit types from both hitch and rear
      [m.hitchUnit, m.rearUnit].forEach(ut => {
        if (ut && ut.trim()) {
          const key = ut.trim().toUpperCase();
          unitTypeCounts[key] = (unitTypeCounts[key] || 0) + 1;
        }
      });
      // Collect room types from both hitch and rear
      [m.hitchRoomType, m.rearRoomType].forEach(rt => {
        if (rt && rt.trim()) {
          const key = rt.trim().toUpperCase();
          roomTypeCounts[key] = (roomTypeCounts[key] || 0) + 1;
        }
      });
    });

    // Sort by frequency and get all unique values
    const unitTypes = Object.keys(unitTypeCounts).sort((a, b) => unitTypeCounts[b] - unitTypeCounts[a]);
    const roomTypes = Object.keys(roomTypeCounts).sort((a, b) => roomTypeCounts[b] - roomTypeCounts[a]);

    // Top 4 most common for quick chips
    const topUnitTypes = unitTypes.slice(0, 4);
    const topRoomTypes = roomTypes.slice(0, 4);
    return {
      unitTypes,
      roomTypes,
      topUnitTypes,
      topRoomTypes
    };
  }, [selectedProject]);

  // Load filters from localStorage on project change
  useEffect(() => {
    if (selectedProject?.id && isModulePackages) {
      try {
        const saved = localStorage.getItem(`moda_drawings_filters_${selectedProject.id}`);
        if (saved) {
          const parsed = JSON.parse(saved);
          setAdvancedFilters(parsed);
          if (parsed.unitTypes?.length || parsed.roomTypes?.length || parsed.difficulties?.length) {
            setShowAdvancedFilters(true);
          }
        }
      } catch (e) {
        console.warn('[Drawings] Error loading saved filters:', e);
      }
    }
  }, [selectedProject?.id, isModulePackages]);

  // Save filters to localStorage when they change
  useEffect(() => {
    if (selectedProject?.id && isModulePackages) {
      try {
        localStorage.setItem(`moda_drawings_filters_${selectedProject.id}`, JSON.stringify(advancedFilters));
      } catch (e) {
        console.warn('[Drawings] Error saving filters:', e);
      }
    }
  }, [advancedFilters, selectedProject?.id, isModulePackages]);

  // Clear all filters
  const clearAdvancedFilters = useCallback(() => {
    setAdvancedFilters({
      unitTypes: [],
      roomTypes: [],
      difficulties: []
    });
    if (selectedProject?.id) {
      try {
        localStorage.removeItem(`moda_drawings_filters_${selectedProject.id}`);
      } catch (e) {}
    }
  }, [selectedProject?.id]);

  // Toggle a filter value
  const toggleFilter = useCallback((category, value) => {
    setAdvancedFilters(prev => {
      const current = prev[category] || [];
      const updated = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
      return {
        ...prev,
        [category]: updated
      };
    });
  }, []);

  // Check if any advanced filters are active
  const hasActiveFilters = useMemo(() => {
    return advancedFilters.unitTypes.length > 0 || advancedFilters.roomTypes.length > 0 || advancedFilters.difficulties.length > 0;
  }, [advancedFilters]);

  // Filter drawings by search term AND advanced filters
  const filteredDrawings = useMemo(() => {
    let results = currentDrawings;

    // Text search filter
    if (drawingSearchTerm.trim()) {
      const term = drawingSearchTerm.toLowerCase().trim();
      results = results.filter(drawing => {
        if (drawing.name.toLowerCase().includes(term)) return true;
        if (isModulePackages) {
          const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
          const linkedModule = parsedModule ? findModuleByBLM(parsedModule) : null;
          if (linkedModule) {
            if (linkedModule.serialNumber?.toLowerCase().includes(term)) return true;
            if (linkedModule.hitchBLM?.toLowerCase().includes(term)) return true;
            if (linkedModule.rearBLM?.toLowerCase().includes(term)) return true;
            if (String(linkedModule.buildSequence).includes(term)) return true;
          }
          if (parsedModule?.toLowerCase().includes(term)) return true;
        }
        return false;
      });
    }

    // Advanced filters (only for Module Packages)
    if (isModulePackages && hasActiveFilters) {
      results = results.filter(drawing => {
        const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
        const linkedModule = parsedModule ? findModuleByBLM(parsedModule) : null;

        // If drawing is unlinked, hide it when filters are active
        if (!linkedModule) return false;

        // Unit Type filter (OR within - match if hitch OR rear has any selected type)
        if (advancedFilters.unitTypes.length > 0) {
          const hitchUnit = (linkedModule.hitchUnit || '').trim().toUpperCase();
          const rearUnit = (linkedModule.rearUnit || '').trim().toUpperCase();
          const matchesUnit = advancedFilters.unitTypes.some(ut => hitchUnit === ut || rearUnit === ut);
          if (!matchesUnit) return false;
        }

        // Room Type filter (OR within - match if hitch OR rear has any selected type)
        if (advancedFilters.roomTypes.length > 0) {
          const hitchRoom = (linkedModule.hitchRoomType || '').trim().toUpperCase();
          const rearRoom = (linkedModule.rearRoomType || '').trim().toUpperCase();
          const matchesRoom = advancedFilters.roomTypes.some(rt => hitchRoom === rt || rearRoom === rt);
          if (!matchesRoom) return false;
        }

        // Difficulty filter (must have ALL selected difficulties)
        if (advancedFilters.difficulties.length > 0) {
          const matchesDifficulty = advancedFilters.difficulties.every(diff => linkedModule[diff] === true);
          if (!matchesDifficulty) return false;
        }
        return true;
      });
    }

    // Issue status filter (only for Module Packages)
    if (isModulePackages && issueStatusFilter !== 'all') {
      results = results.filter(drawing => {
        const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
        const linkedModule = parsedModule ? findModuleByBLM(parsedModule) : null;
        const hasOpenIssue = linkedModule?.id && window.MODA_ISSUE_ROUTING?.moduleHasOpenShopDrawingIssue?.(linkedModule.id);
        if (issueStatusFilter === 'yellow') {
          return hasOpenIssue === true;
        } else if (issueStatusFilter === 'green') {
          return hasOpenIssue !== true;
        }
        return true;
      });
    }
    return results;
  }, [currentDrawings, drawingSearchTerm, isModulePackages, findModuleByBLM, hasActiveFilters, advancedFilters, issueStatusFilter]);

  // Count unlinked drawings hidden by filters
  const hiddenUnlinkedCount = useMemo(() => {
    if (!isModulePackages || !hasActiveFilters) return 0;
    return currentDrawings.filter(drawing => {
      const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
      return !parsedModule || !findModuleByBLM(parsedModule);
    }).length;
  }, [currentDrawings, isModulePackages, hasActiveFilters, findModuleByBLM]);

  // Sort drawings (works for all views)
  const sortedDrawings = useMemo(() => {
    const drawingsToSort = [...filteredDrawings];

    // Sort by filename if that column is selected
    if (sortColumn === 'fileName') {
      drawingsToSort.sort((a, b) => {
        const cmp = a.name.localeCompare(b.name, undefined, {
          numeric: true
        });
        return sortDirection === 'asc' ? cmp : -cmp;
      });
      return drawingsToSort;
    }
    if (!isModulePackages) return drawingsToSort;
    return drawingsToSort.sort((a, b) => {
      const parsedA = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(a.name);
      const parsedB = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(b.name);
      const moduleA = parsedA ? findModuleByBLM(parsedA) : null;
      const moduleB = parsedB ? findModuleByBLM(parsedB) : null;
      let valA, valB;
      switch (sortColumn) {
        case 'serialNumber':
          valA = moduleA?.serialNumber || '';
          valB = moduleB?.serialNumber || '';
          break;
        case 'buildSequence':
          valA = moduleA?.buildSequence ?? 9999;
          valB = moduleB?.buildSequence ?? 9999;
          break;
        case 'hitchBLM':
          valA = moduleA?.hitchBLM || parsedA || '';
          valB = moduleB?.hitchBLM || parsedB || '';
          break;
        case 'rearBLM':
          valA = moduleA?.rearBLM || '';
          valB = moduleB?.rearBLM || '';
          break;
        default:
          valA = moduleA?.buildSequence ?? 9999;
          valB = moduleB?.buildSequence ?? 9999;
      }
      if (sortColumn === 'buildSequence') {
        return sortDirection === 'asc' ? valA - valB : valB - valA;
      }
      const cmp = String(valA).localeCompare(String(valB), undefined, {
        numeric: true
      });
      return sortDirection === 'asc' ? cmp : -cmp;
    });
  }, [filteredDrawings, isModulePackages, sortColumn, sortDirection, findModuleByBLM]);

  // Compute unlinked drawings that need attention (only for Module Packages)
  const unlinkedDrawings = useMemo(() => {
    if (!isModulePackages || !selectedProject?.modules) return [];
    const projectModules = selectedProject.modules;
    const results = [];
    for (const drawing of currentDrawings) {
      const parsedBLM = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
      const linkedModule = parsedBLM ? findModuleByBLM(parsedBLM) : null;
      if (!linkedModule) {
        // Drawing is unlinked - try to find a recommended module
        // Check if filename contains any level-module pattern that partially matches
        const fileName = drawing.name.toUpperCase().replace(/[_\-\s]/g, '');
        let recommendedModule = null;
        let recommendedName = null;

        // Try to find a module whose BLM appears in the filename
        for (const mod of projectModules) {
          const hitchLM = (mod.hitchBLM || '').match(/L\d+M\d+/)?.[0]?.toUpperCase();
          const rearLM = (mod.rearBLM || '').match(/L\d+M\d+/)?.[0]?.toUpperCase();
          if (hitchLM && fileName.includes(hitchLM)) {
            recommendedModule = mod;
            // Generate recommended filename with full BLM
            const ext = drawing.name.split('.').pop();
            if (mod.hitchBLM !== mod.rearBLM && mod.rearBLM) {
              recommendedName = `${mod.hitchBLM} - ${mod.rearBLM} - Shops.${ext}`;
            } else {
              recommendedName = `${mod.hitchBLM} - Shops.${ext}`;
            }
            break;
          }
          if (rearLM && fileName.includes(rearLM)) {
            recommendedModule = mod;
            const ext = drawing.name.split('.').pop();
            if (mod.hitchBLM !== mod.rearBLM && mod.hitchBLM) {
              recommendedName = `${mod.hitchBLM} - ${mod.rearBLM} - Shops.${ext}`;
            } else {
              recommendedName = `${mod.rearBLM} - Shops.${ext}`;
            }
            break;
          }
        }

        // Check if recommended name would conflict with existing drawing
        const wouldConflict = recommendedName && currentDrawings.some(d => d.id !== drawing.id && d.name.toLowerCase() === recommendedName.toLowerCase());
        results.push({
          drawing,
          parsedBLM,
          recommendedModule,
          recommendedName: wouldConflict ? null : recommendedName,
          hasConflict: wouldConflict
        });
      }
    }
    return results;
  }, [currentDrawings, isModulePackages, selectedProject, findModuleByBLM]);

  // Handle file upload - accepts optional targetDiscipline for uploads from category level
  const handleFileUpload = useCallback(async (files, metadata = {}, targetDiscipline = null) => {
    const disciplineToUse = targetDiscipline || selectedDiscipline;
    if (!selectedProject || !disciplineToUse || !files.length) return;

    // Reset cancellation ref at start
    uploadCancelledRef.current = false;
    const startTime = Date.now();
    setUploadStartTime(startTime);
    setUploadProgress({
      current: 0,
      total: files.length
    });

    // Get category and discipline names for SharePoint folder path
    const categoryObj = getCategories().find(c => c.id === selectedCategory);
    const categoryName = categoryObj?.name || 'Shop Drawings';

    // Get discipline name - check custom disciplines first, then static
    let disciplineName = disciplineToUse;
    const disciplines = getDisciplinesForCategory(selectedCategory);
    const disciplineObj = disciplines.find(d => d.id === disciplineToUse || d.name === disciplineToUse);
    if (disciplineObj) disciplineName = disciplineObj.name;
    try {
      if (isSupabaseAvailable()) {
        // Fetch fresh drawings list to ensure accurate duplicate detection
        const freshDrawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, disciplineToUse);

        // Local variable for bulk action (React state won't update mid-loop)
        let localBulkAction = null;

        // Upload to Supabase (which now routes to SharePoint)
        for (let i = 0; i < files.length; i++) {
          // Check if upload was cancelled (using ref for synchronous check)
          if (uploadCancelledRef.current) {
            console.log('[Drawings] Upload cancelled by user');
            break;
          }
          const file = files[i];

          // Calculate time estimate
          const elapsed = Date.now() - startTime;
          const avgTimePerFile = i > 0 ? elapsed / i : 0;
          const remainingFiles = files.length - i;
          const estimatedRemaining = avgTimePerFile * remainingFiles;
          setUploadProgress({
            current: i + 1,
            total: files.length,
            fileName: file.name,
            timeRemaining: estimatedRemaining > 0 ? estimatedRemaining : null
          });

          // Check for existing drawing with same name (use fresh data)
          const existingDrawing = freshDrawings.find(d => d.name.toLowerCase() === file.name.toLowerCase());
          if (existingDrawing) {
            let userAction = localBulkAction; // Use local bulk action if set

            if (!userAction) {
              // Show duplicate prompt and wait for user decision
              userAction = await new Promise(resolve => {
                setShowDuplicatePrompt({
                  file,
                  existingDrawing,
                  metadata,
                  disciplineToUse,
                  categoryName,
                  disciplineName,
                  remainingDuplicates: files.length - i - 1,
                  onAction: resolve
                });
              });
              setShowDuplicatePrompt(null);
            }

            // Handle "Apply to All" actions - set local variable for subsequent iterations
            if (userAction === 'skipAll') {
              localBulkAction = 'skip';
              continue; // Skip this file too
            } else if (userAction === 'newVersionAll') {
              localBulkAction = 'newVersion';
              userAction = 'newVersion';
            }
            if (userAction === 'skip') {
              continue; // Skip this file
            } else if (userAction === 'newVersion') {
              // Add as new version to existing drawing
              const nextVersion = window.MODA_SUPABASE_DRAWINGS.utils.getNextVersion(existingDrawing.versions || []);
              await window.MODA_SUPABASE_DRAWINGS.versions.create(existingDrawing.id, file, {
                version: nextVersion,
                notes: metadata.notes || `Version ${nextVersion}`,
                uploadedBy: auth?.currentUser?.name || 'Unknown',
                projectName: selectedProject.name,
                categoryName: categoryName,
                disciplineName: disciplineName,
                onProgress: progress => {
                  setUploadProgress(prev => ({
                    ...prev,
                    percent: progress.percent || 0,
                    status: progress.status || 'uploading',
                    uploaded: progress.uploaded,
                    totalBytes: progress.total,
                    speed: progress.speed
                  }));
                }
              });
              continue;
            } else if (userAction === 'replace') {
              // Delete existing and upload new
              await window.MODA_SUPABASE_DRAWINGS.drawings.delete(existingDrawing.id);
            }
            // If 'replace', fall through to create new drawing below
          }

          // Create drawing record
          const drawing = await window.MODA_SUPABASE_DRAWINGS.drawings.create({
            projectId: selectedProject.id,
            discipline: disciplineToUse,
            name: file.name,
            description: metadata.description || '',
            createdBy: auth?.currentUser?.name || 'Unknown'
          });

          // Upload first version (now routes to SharePoint if available)
          await window.MODA_SUPABASE_DRAWINGS.versions.create(drawing.id, file, {
            version: '1.0',
            notes: metadata.notes || 'Initial upload',
            uploadedBy: auth?.currentUser?.name || 'Unknown',
            // Pass context for SharePoint folder structure
            projectName: selectedProject.name,
            categoryName: categoryName,
            disciplineName: disciplineName,
            // Progress callback for upload progress bar
            onProgress: progress => {
              setUploadProgress(prev => ({
                ...prev,
                percent: progress.percent || 0,
                status: progress.status || 'uploading',
                uploaded: progress.uploaded,
                totalBytes: progress.total,
                speed: progress.speed
              }));
            }
          });
        }

        // Reload drawings
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
        setCurrentDrawings(drawings);

        // Update counts
        const counts = await window.MODA_SUPABASE_DRAWINGS.drawings.getCountsByProject(selectedProject.id);
        const countsMap = {};
        counts.forEach(c => {
          countsMap[c.discipline] = c.count;
        });
        setDrawingCounts(countsMap);
      } else {
        // Fallback to localStorage
        const stored = localStorage.getItem(STORAGE_KEY);
        const data = stored ? JSON.parse(stored) : {};
        if (!data[selectedProject.id]) data[selectedProject.id] = {};
        if (!data[selectedProject.id][selectedDiscipline]) data[selectedProject.id][selectedDiscipline] = [];
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          setUploadProgress({
            current: i + 1,
            total: files.length,
            fileName: file.name
          });
          const fileData = {
            id: `drawing-${Date.now()}-${i}`,
            name: file.name,
            description: metadata.description || '',
            created_by: auth?.currentUser?.name || 'Unknown',
            created_at: new Date().toISOString(),
            versions: [{
              id: `v1-${Date.now()}`,
              version: '1.0',
              file_name: file.name,
              file_size: file.size,
              file_type: file.type,
              uploaded_at: new Date().toISOString(),
              uploaded_by: auth?.currentUser?.name || 'Unknown',
              notes: metadata.notes || 'Initial upload',
              file_url: URL.createObjectURL(file)
            }]
          };
          data[selectedProject.id][selectedDiscipline].push(fileData);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        setCurrentDrawings(data[selectedProject.id][selectedDiscipline]);

        // Update counts
        const countsMap = {};
        Object.keys(data[selectedProject.id]).forEach(discipline => {
          countsMap[discipline] = (data[selectedProject.id][discipline] || []).length;
        });
        setDrawingCounts(countsMap);
      }
    } catch (error) {
      console.error('[Drawings] Upload error:', error);
      alert('Error uploading files: ' + error.message);
    } finally {
      setUploadProgress(null);
      setShowUploadModal(false);
      uploadCancelledRef.current = false;
      setUploadStartTime(null);
    }
  }, [selectedProject, selectedDiscipline, auth]);

  // Handle new version upload
  const handleVersionUpload = useCallback(async (drawingId, file, notes) => {
    if (!selectedProject || !selectedDiscipline || !file) return;

    // Get category and discipline names for SharePoint folder path
    const categoryObj = getCategories().find(c => c.id === selectedCategory);
    const categoryName = categoryObj?.name || 'Shop Drawings';
    let disciplineName = selectedDiscipline;
    const disciplines = getDisciplinesForCategory(selectedCategory);
    const disciplineObj = disciplines.find(d => d.id === selectedDiscipline || d.name === selectedDiscipline);
    if (disciplineObj) disciplineName = disciplineObj.name;
    try {
      if (isSupabaseAvailable()) {
        // Get existing versions to calculate next version number
        const versions = await window.MODA_SUPABASE_DRAWINGS.versions.getByDrawing(drawingId);
        const nextVersion = window.MODA_SUPABASE_DRAWINGS.utils.getNextVersion(versions);

        // Upload new version (now routes to SharePoint if available)
        await window.MODA_SUPABASE_DRAWINGS.versions.create(drawingId, file, {
          version: nextVersion,
          notes: notes || `Version ${nextVersion}`,
          uploadedBy: auth?.currentUser?.name || 'Unknown',
          // Pass context for SharePoint folder structure
          projectName: selectedProject.name,
          categoryName: categoryName,
          disciplineName: disciplineName
        });

        // Reload drawings to get updated versions
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
        setCurrentDrawings(drawings);

        // Update version history modal with refreshed data
        const updatedDrawing = drawings.find(d => d.id === drawingId);
        if (updatedDrawing) setShowVersionHistory(updatedDrawing);
      } else {
        // Fallback to localStorage
        const stored = localStorage.getItem(STORAGE_KEY);
        const data = stored ? JSON.parse(stored) : {};
        const disciplineDrawings = data[selectedProject.id]?.[selectedDiscipline] || [];
        const drawingIndex = disciplineDrawings.findIndex(d => d.id === drawingId);
        if (drawingIndex === -1) return;
        const drawing = disciplineDrawings[drawingIndex];
        const currentVersion = drawing.versions.length;
        const newVersionNum = (currentVersion + 1).toFixed(1);
        const newVersion = {
          id: `v${newVersionNum}-${Date.now()}`,
          version: newVersionNum,
          file_name: file.name,
          file_size: file.size,
          file_type: file.type,
          uploaded_at: new Date().toISOString(),
          uploaded_by: auth?.currentUser?.name || 'Unknown',
          notes: notes || `Version ${newVersionNum}`,
          file_url: URL.createObjectURL(file)
        };
        drawing.versions.push(newVersion);
        drawing.updated_at = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        setCurrentDrawings([...disciplineDrawings]);
        setShowVersionHistory(drawing);
      }
    } catch (error) {
      console.error('[Drawings] Version upload error:', error);
      alert('Error uploading version: ' + error.message);
    }
  }, [selectedProject, selectedDiscipline, auth]);

  // Handle delete drawing
  const handleDeleteDrawing = useCallback(async drawingId => {
    if (!selectedProject || !selectedDiscipline) return;
    try {
      if (isSupabaseAvailable()) {
        await window.MODA_SUPABASE_DRAWINGS.drawings.delete(drawingId);

        // Reload drawings
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
        setCurrentDrawings(drawings);

        // Update counts
        const counts = await window.MODA_SUPABASE_DRAWINGS.drawings.getCountsByProject(selectedProject.id);
        const countsMap = {};
        counts.forEach(c => {
          countsMap[c.discipline] = c.count;
        });
        setDrawingCounts(countsMap);
      } else {
        // Fallback to localStorage
        const stored = localStorage.getItem(STORAGE_KEY);
        const data = stored ? JSON.parse(stored) : {};
        const disciplineDrawings = data[selectedProject.id]?.[selectedDiscipline] || [];
        data[selectedProject.id][selectedDiscipline] = disciplineDrawings.filter(d => d.id !== drawingId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        setCurrentDrawings(data[selectedProject.id][selectedDiscipline]);

        // Update counts
        const countsMap = {};
        Object.keys(data[selectedProject.id]).forEach(discipline => {
          countsMap[discipline] = (data[selectedProject.id][discipline] || []).length;
        });
        setDrawingCounts(countsMap);
      }
    } catch (error) {
      console.error('[Drawings] Delete error:', error);
      alert('Error deleting drawing: ' + error.message);
    } finally {
      setShowDeleteConfirm(null);
    }
  }, [selectedProject, selectedDiscipline]);

  // Log drawing activity (upload, rename, delete, version add)
  const logDrawingActivity = useCallback(async (action, drawingId, details = {}) => {
    try {
      if (isSupabaseAvailable() && window.MODA_SUPABASE_DRAWINGS.activity?.log) {
        await window.MODA_SUPABASE_DRAWINGS.activity.log({
          action,
          drawing_id: drawingId,
          project_id: selectedProject?.id,
          user_name: auth?.currentUser?.name || 'Unknown',
          user_id: auth?.currentUser?.id,
          details: JSON.stringify(details),
          created_at: new Date().toISOString()
        });
      }
    } catch (error) {
      console.warn('[Drawings] Activity log error:', error);
    }
  }, [selectedProject, auth]);

  // Handle view - opens file in new browser tab for viewing (not download)
  // Uses pre-authenticated download URL to avoid Microsoft login requirement
  const handleView = useCallback(async (version, e) => {
    // Prevent default for touch/click events
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // IMPORTANT: Open window SYNCHRONOUSLY before any async calls
    // Mobile browsers block window.open if called after await
    // Open with loading page first, then redirect to actual URL
    const newWindow = window.open('about:blank', '_blank');

    // If popup was blocked, fall back to same-window navigation
    const popupBlocked = !newWindow || newWindow.closed;
    try {
      const storagePath = version.storage_path || version.storagePath;
      const sharePointFileId = version.sharepoint_file_id || version.sharepointFileId;
      let url = null;
      if (isSupabaseAvailable() && storagePath) {
        // Use getPreviewUrl for SharePoint files - returns pre-authenticated URL
        // that doesn't require Microsoft login and opens PDFs inline in browser
        url = await window.MODA_SUPABASE_DRAWINGS.versions.getPreviewUrl(storagePath, sharePointFileId);
      } else {
        url = version.file_url || version.fileUrl;
      }
      if (url) {
        // Add cache-busting timestamp to prevent browser/mobile caching
        const cacheBuster = `_cb=${Date.now()}`;
        url = url.includes('?') ? `${url}&${cacheBuster}` : `${url}?${cacheBuster}`;
        if (popupBlocked) {
          // Popup was blocked - navigate in same window as fallback
          window.location.href = url;
        } else {
          // Redirect the pre-opened window to the actual URL
          newWindow.location.href = url;
        }
      } else {
        if (!popupBlocked) newWindow.close();
        throw new Error('Could not generate view URL');
      }
    } catch (error) {
      console.error('[Drawings] View error:', error);
      if (!popupBlocked && newWindow) newWindow.close();
      alert('Error viewing file: ' + error.message);
    }
  }, []);

  // Handle open in PDF viewer with markup tools
  const handleOpenInViewer = useCallback(async (drawing, version) => {
    try {
      const storagePath = version.storage_path || version.storagePath;
      const sharePointFileId = version.sharepoint_file_id || version.sharepointFileId;
      let url = null;
      if (isSupabaseAvailable() && storagePath) {
        url = await window.MODA_SUPABASE_DRAWINGS.versions.getPreviewUrl(storagePath, sharePointFileId);
      } else {
        url = version.file_url || version.fileUrl;
      }
      if (url) {
        setPdfViewerData({
          url,
          name: drawing.name,
          drawingId: drawing.id,
          versionId: version.id
        });
      } else {
        throw new Error('Could not generate PDF URL');
      }
    } catch (error) {
      console.error('[Drawings] Open in viewer error:', error);
      alert('Error opening PDF viewer: ' + error.message);
    }
  }, []);

  // Check if user is admin (for OCR access)
  const isAdmin = useMemo(() => {
    const role = auth?.currentUser?.dashboardRole?.toLowerCase();
    return role === 'admin';
  }, [auth]);

  // Handle extract sheets - queue OCR processing for selected PDFs (background processing)
  const handleExtractSheets = useCallback(() => {
    // Admin-only check
    if (!isAdmin) {
      alert('OCR processing is restricted to Admin users only.');
      return;
    }
    if (!window.MODA_SUPABASE?.client) {
      alert('Supabase not available. Please refresh the page.');
      return;
    }
    if (!window.MODA_OCR_MANAGER) {
      alert('OCR Manager not available. Please refresh the page.');
      return;
    }
    if (selectedDrawings.length === 0) {
      alert('Please select at least one PDF file to process.');
      return;
    }

    // Get selected drawings that are PDFs
    const drawingsToProcess = currentDrawings.filter(d => selectedDrawings.includes(d.id) && d.name.toLowerCase().endsWith('.pdf'));
    if (drawingsToProcess.length === 0) {
      alert('No PDF files selected. Please select PDF files to process.');
      return;
    }

    // Get cost estimate from OCR manager
    const estimate = window.MODA_OCR_MANAGER.estimateCost(drawingsToProcess);
    const confirmed = confirm(`Queue OCR for ${drawingsToProcess.length} PDF file(s)?\n\n` + `This will use Claude Vision AI to extract title block metadata:\n` + `- Sheet Number (e.g., XE-B1L6M17-01)\n` + `- Sheet Title (e.g., ELEC ENLG PLAN)\n` + `- BLM Type (e.g., B1L6M17)\n` + `- Scale, Date, Discipline\n\n` + `COST ESTIMATE:\n` + `- Files: ${estimate.fileCount}\n` + `- Est. pages: ~${estimate.estimatedPages} (avg 15/PDF)\n` + `- Est. cost: ~$${estimate.estimatedCost}\n` + `- Per file: ~$${estimate.costPerFile}\n\n` + `Processing runs in background - you can navigate away.\n` + `Progress shown in floating indicator (bottom-right).`);
    if (!confirmed) return;

    // Queue the job with OCR manager
    const jobId = window.MODA_OCR_MANAGER.queueJob(selectedProject?.id, selectedProject?.name || 'Unknown Project', drawingsToProcess);
    console.log(`[Drawings] Queued OCR job: ${jobId} with ${drawingsToProcess.length} files`);

    // Clear selection
    setSelectedDrawings([]);
  }, [currentDrawings, selectedDrawings, selectedProject, isAdmin]);

  // Handle download - forces file download
  const handleDownload = useCallback(async version => {
    try {
      const storagePath = version.storage_path || version.storagePath;
      const fileName = version.file_name || version.fileName;
      if (isSupabaseAvailable() && storagePath) {
        const url = await window.MODA_SUPABASE_DRAWINGS.versions.getDownloadUrl(storagePath);
        if (url) {
          // Fetch and force download
          const response = await fetch(url);
          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = blobUrl;
          link.download = fileName || 'download';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(blobUrl);
        } else {
          throw new Error('Could not generate download URL');
        }
      } else {
        const fileUrl = version.file_url || version.fileUrl;
        if (fileUrl) {
          const link = document.createElement('a');
          link.href = fileUrl;
          link.download = fileName || 'download';
          link.click();
        }
      }
    } catch (error) {
      console.error('[Drawings] Download error:', error);
      alert('Error downloading file: ' + error.message);
    }
  }, []);

  // Format file size
  const formatFileSize = bytes => {
    if (!bytes) return 'Unknown';
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  // Format date
  const formatDate = dateString => {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // Handle process drawing sheets (split PDF and OCR)
  const handleProcessSheets = useCallback(async drawing => {
    if (!window.MODA_DRAWING_SHEETS?.processDrawingSheets) {
      alert('Sheet processing module not available');
      return;
    }
    const confirmed = confirm(`Process "${drawing.name}" to extract individual sheets?\n\n` + `This will split the PDF into individual pages and extract title block metadata using OCR. ` + `This may take several minutes for large files.`);
    if (!confirmed) return;
    setProcessingDrawing({
      drawingId: drawing.id,
      status: 'processing',
      progress: 0
    });
    try {
      const result = await window.MODA_DRAWING_SHEETS.processDrawingSheets(drawing.id);
      setProcessingDrawing(null);
      alert(`Successfully processed ${result.processed_sheets} sheet(s)!\n\n` + `You can now browse and filter individual sheets.`);

      // Refresh drawings to show updated state
      await loadDrawings();
    } catch (error) {
      console.error('[Drawings] Error processing sheets:', error);
      setProcessingDrawing(null);
      alert('Error processing sheets: ' + error.message);
    }
  }, []);

  // Filter and sort projects by search and project_number
  const filteredProjects = useMemo(() => {
    // First filter by search term
    let filtered = projects;
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = projects.filter(p => p.name?.toLowerCase().includes(term) || p.location?.toLowerCase().includes(term));
    }
    // Then sort by project_number (highest first, nulls at end)
    return [...filtered].sort((a, b) => {
      const aNum = parseInt(a.project_number) || 0;
      const bNum = parseInt(b.project_number) || 0;
      return bNum - aNum; // Descending order
    });
  }, [projects, searchTerm]);

  // Breadcrumb navigation
  const handleBreadcrumbClick = level => {
    if (level === 'projects') {
      setSelectedProject(null);
      setSelectedCategory(null);
      setSelectedDiscipline(null);
    } else if (level === 'categories') {
      setSelectedCategory(null);
      setSelectedDiscipline(null);
    } else if (level === 'disciplines') {
      setSelectedDiscipline(null);
    }
  };

  // =========================================================================
  // RENDER: Projects Grid View
  // =========================================================================
  const renderProjectsView = () => /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Project Drawings"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mt-1"
  }, "Select a project to view drawings")), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search projects...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64"
  }), /*#__PURE__*/React.createElement("span", {
    className: "icon-search absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 opacity-50"
  }))), filteredProjects.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder w-16 h-16 mx-auto mb-4 opacity-30",
    style: {
      display: 'block'
    }
  }), /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-medium text-gray-600"
  }, "No Projects Found"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 mt-1"
  }, searchTerm ? 'Try a different search term' : 'Create a project first to add drawings')) : /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
  }, filteredProjects.map(project => /*#__PURE__*/React.createElement("button", {
    key: project.id,
    onClick: () => setSelectedProject(project),
    className: "bg-white rounded-lg border-2 border-gray-200 p-6 text-left hover:border-blue-400 hover:shadow-lg transition-all group relative"
  }, project.project_number && /*#__PURE__*/React.createElement("div", {
    className: "absolute top-2 right-2 bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded"
  }, "#", project.project_number), /*#__PURE__*/React.createElement("div", {
    className: "flex items-start gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-12 h-12 rounded-lg bg-amber-100 flex items-center justify-center flex-shrink-0 group-hover:bg-amber-200 transition"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder w-6 h-6",
    style: {
      filter: 'invert(50%) sepia(90%) saturate(500%) hue-rotate(5deg)'
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900 truncate group-hover:text-blue-600 transition"
  }, project.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 truncate mt-1"
  }, project.location || 'No location')))))));

  // =========================================================================
  // RENDER: Categories Grid View (Permit Drawings, Shop Drawings)
  // =========================================================================
  const renderCategoriesView = () => /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-sm mb-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleBreadcrumbClick('projects'),
    className: "text-blue-600 hover:underline"
  }, "Projects"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "/"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-700 font-medium"
  }, selectedProject?.name)), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, selectedProject?.name), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mt-1"
  }, "Select a drawing category")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, canManageFolders && /*#__PURE__*/React.createElement("button", {
    onClick: handleResetFolders,
    disabled: foldersLoading,
    className: "px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition flex items-center gap-2 disabled:opacity-50",
    title: "Reset folder structure to defaults"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-refresh w-4 h-4"
  }), "Reset Folders"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowUploadModal(true),
    className: "px-4 py-2 text-white rounded-lg transition flex items-center gap-2",
    style: {
      backgroundColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-upload w-4 h-4"
  }), "Upload"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleBreadcrumbClick('projects'),
    className: "px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-arrow-left w-4 h-4"
  }), "Back to Projects"))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"
  }, getCategories().map(category => /*#__PURE__*/React.createElement("div", {
    key: category.id,
    className: "relative group/card"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setSelectedCategory(category.id),
    className: `w-full bg-white rounded-xl border-2 p-8 text-left hover:shadow-xl transition-all ${category.color}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-16 h-16 rounded-xl bg-white/80 flex items-center justify-center flex-shrink-0 shadow-md group-hover/card:shadow-lg transition"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder w-8 h-8",
    style: {
      filter: 'invert(50%) sepia(90%) saturate(500%) hue-rotate(5deg)'
    }
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-xl text-gray-900 group-hover/card:text-blue-600 transition"
  }, category.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-1"
  }, category.description || 'Drawing category')))), canManageFolders && category.isCustom && /*#__PURE__*/React.createElement("div", {
    className: "absolute top-2 right-2 opacity-0 group-hover/card:opacity-100 transition flex gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowFolderModal({
        mode: 'edit',
        type: 'category',
        folder: category
      });
    },
    className: "p-2 bg-white rounded-lg shadow hover:bg-blue-50 transition",
    title: "Edit Category"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-edit w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowDeleteFolderConfirm(category);
    },
    className: "p-2 bg-white rounded-lg shadow hover:bg-red-50 transition",
    title: "Delete Category"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-trash w-4 h-4"
  }))))), canManageFolders && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowFolderModal({
      mode: 'add',
      type: 'category'
    }),
    className: "bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-8 text-left hover:border-blue-400 hover:bg-blue-50 transition-all flex items-center justify-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-3xl text-gray-400"
  }, "+")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-lg text-gray-600"
  }, "Add Category"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-400"
  }, "Create a new folder category")))));

  // =========================================================================
  // RENDER: Disciplines Grid View (within a category)
  // =========================================================================
  const renderDisciplinesView = () => {
    const categories = getCategories();
    const currentCategory = categories.find(c => c.id === selectedCategory);
    const disciplines = getDisciplinesForCategory(selectedCategory);
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-sm mb-6"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('projects'),
      className: "text-blue-600 hover:underline"
    }, "Projects"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "/"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('categories'),
      className: "text-blue-600 hover:underline"
    }, selectedProject?.name), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "/"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-700 font-medium"
    }, currentCategory?.name)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-6"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
      className: "text-2xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, currentCategory?.name), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mt-1"
    }, "Select a discipline to view drawings")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadModal(true),
      className: "px-4 py-2 text-white rounded-lg transition flex items-center gap-2",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-upload w-4 h-4"
    }), "Upload"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('categories'),
      className: "px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-arrow-left w-4 h-4"
    }), "Back"))), (currentCategory?.name === 'Permit Drawings' || selectedCategory === 'permit-drawings') && window.DrawingLinksPanel && /*#__PURE__*/React.createElement(DrawingLinksPanel, {
      projectId: selectedProject?.id,
      projectName: selectedProject?.name,
      drawings: currentDrawings,
      auth: auth
    }), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
    }, disciplines.map(discipline => {
      const count = getDrawingCount(discipline.id, discipline.name);
      return /*#__PURE__*/React.createElement("div", {
        key: discipline.id,
        className: "relative group/card"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: () => setSelectedDiscipline(discipline.id),
        className: `w-full bg-white rounded-lg border-2 p-5 text-left hover:shadow-lg transition-all ${discipline.color}`
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-4"
      }, /*#__PURE__*/React.createElement("div", {
        className: "w-10 h-10 rounded-lg bg-white/80 flex items-center justify-center flex-shrink-0 shadow-sm"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-folder w-5 h-5",
        style: {
          filter: 'invert(50%) sepia(90%) saturate(500%) hue-rotate(5deg)'
        }
      })), /*#__PURE__*/React.createElement("div", {
        className: "flex-1 min-w-0"
      }, /*#__PURE__*/React.createElement("h3", {
        className: "font-medium text-gray-900 text-sm leading-tight"
      }, discipline.name), /*#__PURE__*/React.createElement("p", {
        className: "text-xs text-gray-500 mt-1"
      }, count, " file", count !== 1 ? 's' : '')))), canManageFolders && discipline.isCustom && /*#__PURE__*/React.createElement("div", {
        className: "absolute top-1 right-1 opacity-0 group-hover/card:opacity-100 transition flex gap-1"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: e => {
          e.stopPropagation();
          setShowFolderModal({
            mode: 'edit',
            type: 'discipline',
            folder: discipline,
            parentId: selectedCategory
          });
        },
        className: "p-1.5 bg-white rounded shadow hover:bg-blue-50 transition",
        title: "Edit Discipline"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-edit w-3 h-3"
      })), /*#__PURE__*/React.createElement("button", {
        onClick: e => {
          e.stopPropagation();
          setShowDeleteFolderConfirm(discipline);
        },
        className: "p-1.5 bg-white rounded shadow hover:bg-red-50 transition",
        title: "Delete Discipline"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-trash w-3 h-3"
      }))));
    }), canManageFolders && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowFolderModal({
        mode: 'add',
        type: 'discipline',
        parentId: selectedCategory
      }),
      className: "bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-5 text-left hover:border-blue-400 hover:bg-blue-50 transition-all flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-xl text-gray-400"
    }, "+")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-600 text-sm"
    }, "Add Discipline"), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400"
    }, "Create new folder")))));
  };

  // =========================================================================
  // RENDER: Drawings List View
  // =========================================================================
  const renderDrawingsView = () => {
    const categories = getCategories();
    const currentCategory = categories.find(c => c.id === selectedCategory);
    const disciplines = getDisciplinesForCategory(selectedCategory);
    const currentDiscipline = disciplines.find(d => d.id === selectedDiscipline);
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-sm mb-6"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('projects'),
      className: "text-blue-600 hover:underline"
    }, "Projects"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "/"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('categories'),
      className: "text-blue-600 hover:underline"
    }, selectedProject?.name), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "/"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('disciplines'),
      className: "text-blue-600 hover:underline"
    }, currentCategory?.name), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "/"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-700 font-medium"
    }, currentDiscipline?.name)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
      className: "text-2xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, currentDiscipline?.name), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mt-1"
    }, sortedDrawings.length, drawingSearchTerm ? ` of ${currentDrawings.length}` : '', " drawing", sortedDrawings.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleBreadcrumbClick('disciplines'),
      className: "px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-arrow-left w-4 h-4"
    }), "Back"), isModulePackages && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowDrawingStatusLog(true),
      className: "px-4 py-2 bg-blue-600 text-white rounded-lg transition flex items-center gap-2 hover:bg-blue-700",
      title: "View drawing status for all modules"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-grid w-4 h-4"
    }), "Status Log"), !isMobile && isModulePackages && unlinkedDrawings.length > 0 && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowBulkRenameModal(true),
      className: "px-4 py-2 bg-amber-500 text-white rounded-lg transition flex items-center gap-2 hover:bg-amber-600"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-alert-triangle w-4 h-4"
    }), "Fix Unlinked (", unlinkedDrawings.length, ")"), !isMobile && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadModal(true),
      className: "px-4 py-2 text-white rounded-lg transition flex items-center gap-2",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-upload w-4 h-4"
    }), "Upload Drawings"), !isMobile && isModulePackages && /*#__PURE__*/React.createElement("div", {
      className: "relative"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAIMenu(!showAIMenu),
      className: "px-4 py-2 bg-purple-600 text-white rounded-lg transition flex items-center gap-2 hover:bg-purple-700",
      title: "AI-powered drawing analysis"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-cpu w-4 h-4"
    }), "AI Analysis", /*#__PURE__*/React.createElement("span", {
      className: `transform transition-transform ${showAIMenu ? 'rotate-180' : ''}`
    }, "\u25BC")), showAIMenu && /*#__PURE__*/React.createElement("div", {
      className: "absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-semibold text-gray-500 px-3 py-1 uppercase"
    }, "Extract Data"), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowAIMenu(false);
        handleExtractSheets();
      },
      disabled: !isAdmin || selectedDrawings.length === 0,
      className: "w-full px-3 py-2 text-left text-sm rounded hover:bg-purple-50 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",
      title: !isAdmin ? 'Admin only' : ''
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-scan w-4 h-4 text-purple-600"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "font-medium flex items-center gap-1"
    }, "Run OCR", !isAdmin && /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-red-500"
    }, "(Admin)")), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, !isAdmin ? 'Restricted to Admin users' : selectedDrawings.length > 0 ? `Extract title blocks (${selectedDrawings.length} selected)` : 'Select PDFs first'))), /*#__PURE__*/React.createElement("div", {
      className: "border-t border-gray-100 my-2"
    }), /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-semibold text-gray-500 px-3 py-1 uppercase"
    }, "Browse Results"), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowAIMenu(false);
        setShowSheetBrowser(true);
      },
      className: "w-full px-3 py-2 text-left text-sm rounded hover:bg-blue-50 flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-layers w-4 h-4 text-blue-600"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "font-medium"
    }, "Browse Sheets"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, "View extracted sheet metadata"))), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowAIMenu(false);
        setShowAnalysisBrowser('walls');
      },
      className: "w-full px-3 py-2 text-left text-sm rounded hover:bg-green-50 flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-box w-4 h-4 text-green-600"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "font-medium"
    }, "Wall Schedule"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, "View extracted wall IDs"))), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowAIMenu(false);
        setShowAnalysisBrowser('fixtures');
      },
      className: "w-full px-3 py-2 text-left text-sm rounded hover:bg-yellow-50 flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-zap w-4 h-4 text-yellow-600"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "font-medium"
    }, "MEP Fixtures"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, "View fixture counts by category"))), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowAIMenu(false);
        setShowAnalysisBrowser('changes');
      },
      className: "w-full px-3 py-2 text-left text-sm rounded hover:bg-red-50 flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-git-compare w-4 h-4 text-red-600"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "font-medium"
    }, "Version Changes"), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, "Track design revisions")))))))), /*#__PURE__*/React.createElement("div", {
      className: "mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "relative flex-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-search w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
    }), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: drawingSearchTerm,
      onChange: e => setDrawingSearchTerm(e.target.value),
      placeholder: isModulePackages ? "Search by filename, serial no., BLM ID, or sequence..." : "Search by filename...",
      className: "w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }), drawingSearchTerm && /*#__PURE__*/React.createElement("button", {
      onClick: () => setDrawingSearchTerm(''),
      className: "absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
    }, "\u2715")), isModulePackages && /*#__PURE__*/React.createElement("select", {
      value: issueStatusFilter,
      onChange: e => setIssueStatusFilter(e.target.value),
      className: "px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
    }, /*#__PURE__*/React.createElement("option", {
      value: "all"
    }, "All Status"), /*#__PURE__*/React.createElement("option", {
      value: "green"
    }, "No Issues (Green)"), /*#__PURE__*/React.createElement("option", {
      value: "yellow"
    }, "Has Issues (Yellow)"))), isModulePackages && filterOptions.unitTypes.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "mt-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowAdvancedFilters(!showAdvancedFilters),
      className: "flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800"
    }, /*#__PURE__*/React.createElement("span", {
      className: `transform transition-transform ${showAdvancedFilters ? 'rotate-90' : ''}`
    }, "\u25B6"), "Advanced Filters", hasActiveFilters && /*#__PURE__*/React.createElement("span", {
      className: "px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full"
    }, advancedFilters.unitTypes.length + advancedFilters.roomTypes.length + advancedFilters.difficulties.length, " active")), showAdvancedFilters && /*#__PURE__*/React.createElement("div", {
      className: "mt-3 p-4 bg-gray-50 rounded-lg border border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-2"
    }, filterOptions.topUnitTypes.map(ut => /*#__PURE__*/React.createElement("button", {
      key: `chip-ut-${ut}`,
      onClick: () => toggleFilter('unitTypes', ut),
      className: `px-3 py-1 text-sm rounded-full border transition ${advancedFilters.unitTypes.includes(ut) ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}`
    }, ut)), filterOptions.topRoomTypes.map(rt => /*#__PURE__*/React.createElement("button", {
      key: `chip-rt-${rt}`,
      onClick: () => toggleFilter('roomTypes', rt),
      className: `px-3 py-1 text-sm rounded-full border transition ${advancedFilters.roomTypes.includes(rt) ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-white text-gray-700 border-gray-300 hover:border-emerald-400'}`
    }, rt)), DIFFICULTY_OPTIONS.slice(0, 3).map(diff => /*#__PURE__*/React.createElement("button", {
      key: `chip-diff-${diff.id}`,
      onClick: () => toggleFilter('difficulties', diff.id),
      className: `px-3 py-1 text-sm rounded-full border transition ${advancedFilters.difficulties.includes(diff.id) ? 'bg-amber-500 text-white border-amber-500' : 'bg-white text-gray-700 border-gray-300 hover:border-amber-400'}`
    }, diff.label)))), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-600 mb-1"
    }, "Unit Types"), /*#__PURE__*/React.createElement("select", {
      multiple: true,
      value: advancedFilters.unitTypes,
      onChange: e => {
        const selected = Array.from(e.target.selectedOptions, opt => opt.value);
        setAdvancedFilters(prev => ({
          ...prev,
          unitTypes: selected
        }));
      },
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
      style: {
        minHeight: '80px'
      }
    }, filterOptions.unitTypes.map(ut => /*#__PURE__*/React.createElement("option", {
      key: ut,
      value: ut
    }, ut))), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-1"
    }, "Ctrl+click to select multiple")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-600 mb-1"
    }, "Room Types"), /*#__PURE__*/React.createElement("select", {
      multiple: true,
      value: advancedFilters.roomTypes,
      onChange: e => {
        const selected = Array.from(e.target.selectedOptions, opt => opt.value);
        setAdvancedFilters(prev => ({
          ...prev,
          roomTypes: selected
        }));
      },
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
      style: {
        minHeight: '80px'
      }
    }, filterOptions.roomTypes.map(rt => /*#__PURE__*/React.createElement("option", {
      key: rt,
      value: rt
    }, rt))), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-1"
    }, "Ctrl+click to select multiple"))), /*#__PURE__*/React.createElement("div", {
      className: "mb-4"
    }, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-600 mb-2"
    }, "Difficulties"), /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-4"
    }, DIFFICULTY_OPTIONS.map(diff => /*#__PURE__*/React.createElement("label", {
      key: diff.id,
      className: "flex items-center gap-2 text-sm cursor-pointer"
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: advancedFilters.difficulties.includes(diff.id),
      onChange: () => toggleFilter('difficulties', diff.id),
      className: "w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500"
    }), diff.label)))), hasActiveFilters && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between pt-3 border-t border-gray-200"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-600"
    }, "Showing ", sortedDrawings.length, " of ", currentDrawings.length, " drawings", hiddenUnlinkedCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-amber-600 ml-2"
    }, "(", hiddenUnlinkedCount, " unlinked hidden)")), /*#__PURE__*/React.createElement("button", {
      onClick: clearAdvancedFilters,
      className: "px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded transition"
    }, "Clear All Filters"))))), currentDrawings.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "text-center py-20 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-file w-16 h-16 mx-auto mb-4 opacity-30",
      style: {
        display: 'block'
      }
    }), /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-medium text-gray-600"
    }, "No Drawings Yet"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 mt-1 mb-4"
    }, isMobile ? 'No drawings available' : 'Upload drawings to get started'), !isMobile && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadModal(true),
      className: "px-4 py-2 text-white rounded-lg transition inline-flex items-center gap-2",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-upload w-4 h-4"
    }), "Upload Drawings")) : sortedDrawings.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "text-center py-12 bg-gray-50 rounded-lg border border-gray-200"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-search w-12 h-12 mx-auto mb-3 opacity-30",
      style: {
        display: 'block'
      }
    }), /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-medium text-gray-600"
    }, "No Results Found"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 mt-1"
    }, hasActiveFilters ? `No drawings match the selected filters${drawingSearchTerm ? ` and "${drawingSearchTerm}"` : ''}` : `No drawings match "${drawingSearchTerm}"`), /*#__PURE__*/React.createElement("div", {
      className: "mt-3 flex items-center justify-center gap-3"
    }, drawingSearchTerm && /*#__PURE__*/React.createElement("button", {
      onClick: () => setDrawingSearchTerm(''),
      className: "text-blue-600 hover:underline"
    }, "Clear search"), hasActiveFilters && /*#__PURE__*/React.createElement("button", {
      onClick: clearAdvancedFilters,
      className: "text-red-600 hover:underline"
    }, "Clear filters"))) : /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border border-gray-200 overflow-x-auto"
    }, /*#__PURE__*/React.createElement("table", {
      className: "w-full min-w-max"
    }, /*#__PURE__*/React.createElement("thead", {
      className: "bg-gray-50 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("tr", null, window.MODA_SUPABASE?.client && /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left"
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: selectedDrawings.length > 0 && selectedDrawings.length === currentDrawings.filter(d => d.name.toLowerCase().endsWith('.pdf')).length,
      onChange: e => {
        const pdfDrawings = currentDrawings.filter(d => d.name.toLowerCase().endsWith('.pdf'));
        if (e.target.checked) {
          setSelectedDrawings(pdfDrawings.map(d => d.id));
        } else {
          setSelectedDrawings([]);
        }
      },
      className: "w-4 h-4 text-purple-600 rounded cursor-pointer",
      title: "Select all PDFs"
    })), isModulePackages && /*#__PURE__*/React.createElement("th", {
      className: "px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12"
    }, "Status"), /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
      onClick: () => handleSort('fileName')
    }, "File Name ", sortColumn === 'fileName' && (sortDirection === 'asc' ? '▲' : '▼')), isModulePackages && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
      onClick: () => handleSort('serialNumber')
    }, "Serial No. ", sortColumn === 'serialNumber' && (sortDirection === 'asc' ? '▲' : '▼')), /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
      onClick: () => handleSort('buildSequence')
    }, "Build Seq ", sortColumn === 'buildSequence' && (sortDirection === 'asc' ? '▲' : '▼')), /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
      onClick: () => handleSort('hitchBLM')
    }, "Hitch BLM ", sortColumn === 'hitchBLM' && (sortDirection === 'asc' ? '▲' : '▼')), /*#__PURE__*/React.createElement("th", {
      className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none",
      onClick: () => handleSort('rearBLM')
    }, "Rear BLM ", sortColumn === 'rearBLM' && (sortDirection === 'asc' ? '▲' : '▼'))), /*#__PURE__*/React.createElement("th", {
      className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
    }, "Version"), /*#__PURE__*/React.createElement("th", {
      className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
    }, "Updated"), /*#__PURE__*/React.createElement("th", {
      className: "px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
    }, "Actions"))), /*#__PURE__*/React.createElement("tbody", {
      className: "divide-y divide-gray-200"
    }, sortedDrawings.map(drawing => {
      const latestVersion = getLatestVersion(drawing);
      // Parse module ID from filename
      const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(drawing.name);
      // Find linked module data from project
      const linkedModule = parsedModule ? findModuleByBLM(parsedModule) : null;
      const isPdf = drawing.name.toLowerCase().endsWith('.pdf');
      const isSelected = selectedDrawings.includes(drawing.id);
      // Check if drawing is unlinked (has parsed BLM but no matching module)
      const isUnlinked = isModulePackages && parsedModule && !linkedModule;
      return /*#__PURE__*/React.createElement("tr", {
        key: drawing.id,
        className: "hover:bg-gray-50"
      }, window.MODA_SUPABASE?.client && /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4"
      }, isPdf && /*#__PURE__*/React.createElement("input", {
        type: "checkbox",
        checked: isSelected,
        onChange: e => {
          if (e.target.checked) {
            setSelectedDrawings([...selectedDrawings, drawing.id]);
          } else {
            setSelectedDrawings(selectedDrawings.filter(id => id !== drawing.id));
          }
        },
        className: "w-4 h-4 text-purple-600 rounded cursor-pointer",
        title: "Select for Claude Vision OCR"
      })), isModulePackages && /*#__PURE__*/React.createElement("td", {
        className: "px-2 py-4 text-center"
      }, (() => {
        // Check if this module has open shop-drawing issues
        const hasOpenIssue = linkedModule?.id && window.MODA_ISSUE_ROUTING?.moduleHasOpenShopDrawingIssue?.(linkedModule.id);
        const issueCount = hasOpenIssue ? window.MODA_ISSUE_ROUTING?.getOpenShopDrawingIssuesForModule?.(linkedModule.id)?.length || 0 : 0;
        return hasOpenIssue ? /*#__PURE__*/React.createElement("span", {
          className: "inline-block w-3 h-3 rounded-full bg-amber-400 border border-amber-500",
          title: `${issueCount} open shop drawing issue${issueCount > 1 ? 's' : ''}`
        }) : /*#__PURE__*/React.createElement("span", {
          className: "inline-block w-3 h-3 rounded-full bg-green-300/50 border border-green-400/30",
          title: "No issues reported"
        });
      })()), /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4"
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-3"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-file w-5 h-5 text-gray-400"
      }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-2"
      }, /*#__PURE__*/React.createElement("button", {
        type: "button",
        onClick: e => latestVersion && handleView(latestVersion, e),
        className: "font-medium text-blue-600 hover:text-blue-800 hover:underline transition cursor-pointer text-left touch-manipulation",
        style: {
          WebkitTapHighlightColor: 'transparent'
        },
        title: "Click to view drawing"
      }, drawing.name), parsedModule && !isModulePackages && /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800",
        title: "Parsed module from filename"
      }, parsedModule), isUnlinked && /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 cursor-pointer hover:bg-red-200",
        title: "No matching module found in project. Click to link manually.",
        onClick: () => setShowEditDrawing(drawing)
      }, "Unlinked")), drawing.description && /*#__PURE__*/React.createElement("div", {
        className: "text-sm text-gray-500"
      }, drawing.description)))), isModulePackages && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4 text-sm text-gray-700 font-medium"
      }, linkedModule?.serialNumber || /*#__PURE__*/React.createElement("span", {
        className: "text-gray-400"
      }, "-")), /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4 text-sm text-gray-500"
      }, linkedModule?.buildSequence || /*#__PURE__*/React.createElement("span", {
        className: "text-gray-400"
      }, "-")), /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4"
      }, linkedModule?.hitchBLM ? /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800"
      }, linkedModule.hitchBLM) : parsedModule ? /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800",
        title: "Parsed from filename"
      }, parsedModule) : /*#__PURE__*/React.createElement("span", {
        className: "text-gray-400"
      }, "-")), /*#__PURE__*/React.createElement("td", {
        className: "px-4 py-4"
      }, linkedModule?.rearBLM ? /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
      }, linkedModule.rearBLM) : /*#__PURE__*/React.createElement("span", {
        className: "text-gray-400"
      }, "-"))), /*#__PURE__*/React.createElement("td", {
        className: "px-3 py-3"
      }, /*#__PURE__*/React.createElement("span", {
        className: "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
      }, "v", latestVersion?.version || '1.0')), /*#__PURE__*/React.createElement("td", {
        className: "px-3 py-3 text-sm text-gray-500"
      }, formatDate(latestVersion?.uploaded_at || latestVersion?.uploadedAt || drawing.created_at || drawing.createdAt)), /*#__PURE__*/React.createElement("td", {
        className: "px-3 py-3 text-right"
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center justify-end gap-1"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: () => setShowFileInfo({
          drawing,
          latestVersion,
          linkedModule,
          parsedModule
        }),
        className: "p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition touch-manipulation",
        title: "File Info"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-info-circle w-4 h-4"
      })), /*#__PURE__*/React.createElement("button", {
        onClick: () => setShowEditDrawing(drawing),
        className: "p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded transition touch-manipulation",
        title: "Edit / Rename"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-edit w-4 h-4"
      })), latestVersion && /*#__PURE__*/React.createElement("button", {
        onClick: e => handleView(latestVersion, e),
        className: "p-2 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition touch-manipulation",
        title: "View in Browser"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-eye w-4 h-4"
      })), /*#__PURE__*/React.createElement("button", {
        onClick: () => setShowDeleteConfirm(drawing),
        className: "p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition touch-manipulation",
        title: "Delete"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-trash w-4 h-4"
      })))));
    })))));
  };

  // =========================================================================
  // RENDER: Upload Modal
  // =========================================================================
  const BULK_UPLOAD_WARNING_THRESHOLD = 20; // Show warning when selecting more than this many files

  const UploadModal = () => {
    const [files, setFiles] = useState([]);
    const [description, setDescription] = useState('');
    const [notes, setNotes] = useState('');
    const [dragActive, setDragActive] = useState(false);
    const [uploadCategory, setUploadCategory] = useState(selectedCategory || '');
    const [uploadDiscipline, setUploadDiscipline] = useState(selectedDiscipline || '');
    const [bulkWarningAcknowledged, setBulkWarningAcknowledged] = useState(false);

    // Get disciplines for selected upload category
    const getUploadDisciplines = () => {
      if (uploadCategory === 'permit-drawings') return PERMIT_DISCIPLINES;
      if (uploadCategory === 'shop-drawings') return SHOP_DISCIPLINES;
      return [];
    };
    const handleDrag = e => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === 'dragenter' || e.type === 'dragover') {
        setDragActive(true);
      } else if (e.type === 'dragleave') {
        setDragActive(false);
      }
    };
    const handleDrop = e => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        setFiles(Array.from(e.dataTransfer.files));
      }
    };
    const handleFileSelect = e => {
      if (e.target.files && e.target.files.length > 0) {
        setFiles(Array.from(e.target.files));
      }
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "Upload Drawings"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadModal(false),
      className: "p-2 hover:bg-gray-100 rounded-lg transition"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-close w-5 h-5"
    })))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 space-y-4"
    }, uploadProgress && /*#__PURE__*/React.createElement("div", {
      className: "bg-blue-50 border border-blue-200 rounded-lg p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm font-medium text-blue-900"
    }, uploadProgress.status === 'preparing' && 'Preparing upload...', uploadProgress.status === 'creating session' && 'Creating upload session...', uploadProgress.status === 'uploading' && `Uploading: ${uploadProgress.fileName || 'file'}`, uploadProgress.status === 'complete' && 'Upload complete!', !uploadProgress.status && `Uploading ${uploadProgress.current} of ${uploadProgress.total}...`), /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-blue-700"
    }, uploadProgress.percent || 0, "%")), /*#__PURE__*/React.createElement("div", {
      className: "w-full bg-blue-200 rounded-full h-3 overflow-hidden"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-blue-600 h-3 rounded-full transition-all duration-300 ease-out",
      style: {
        width: `${uploadProgress.percent || 0}%`
      }
    })), uploadProgress.uploaded && uploadProgress.totalBytes && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-blue-600 mt-1"
    }, formatFileSize(uploadProgress.uploaded), " / ", formatFileSize(uploadProgress.totalBytes), uploadProgress.speed && /*#__PURE__*/React.createElement("span", {
      className: "ml-2"
    }, "(", uploadProgress.speed, ")")), uploadProgress.timeRemaining && uploadProgress.timeRemaining > 1000 && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-blue-600 mt-1"
    }, "Est. time remaining: ", Math.ceil(uploadProgress.timeRemaining / 60000), " min ", Math.ceil(uploadProgress.timeRemaining % 60000 / 1000), " sec")), !uploadProgress && /*#__PURE__*/React.createElement("div", {
      onDragEnter: handleDrag,
      onDragLeave: handleDrag,
      onDragOver: handleDrag,
      onDrop: handleDrop,
      className: `border-2 border-dashed rounded-lg p-8 text-center transition ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'}`
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-upload w-12 h-12 mx-auto mb-4 opacity-50",
      style: {
        display: 'block'
      }
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-2"
    }, "Drag and drop files here, or"), /*#__PURE__*/React.createElement("label", {
      className: "inline-block px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition"
    }, /*#__PURE__*/React.createElement("span", null, "Browse Files"), /*#__PURE__*/React.createElement("input", {
      type: "file",
      multiple: true,
      onChange: handleFileSelect,
      className: "hidden",
      accept: ".pdf,.dwg,.dxf,.png,.jpg,.jpeg,.tif,.tiff"
    })), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-400 mt-2"
    }, "Supported: PDF, DWG, DXF, PNG, JPG, TIFF")), files.length > BULK_UPLOAD_WARNING_THRESHOLD && !bulkWarningAcknowledged && /*#__PURE__*/React.createElement("div", {
      className: "bg-amber-50 border border-amber-200 rounded-lg p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-alert-triangle w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "text-sm font-medium text-amber-800"
    }, "Large Batch Detected"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-amber-700 mt-1"
    }, "You've selected ", files.length, " files. For best reliability, consider uploading in batches of 20 or fewer."), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 mt-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setBulkWarningAcknowledged(true),
      className: "px-3 py-1.5 text-sm bg-amber-600 text-white rounded hover:bg-amber-700 transition"
    }, "Continue Anyway"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setFiles([]),
      className: "px-3 py-1.5 text-sm bg-white border border-amber-300 text-amber-700 rounded hover:bg-amber-50 transition"
    }, "Clear Selection"))))), files.length > 0 && (files.length <= BULK_UPLOAD_WARNING_THRESHOLD || bulkWarningAcknowledged) && /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-50 rounded-lg p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-2"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "text-sm font-medium text-gray-700"
    }, "Selected Files (", files.length, ")"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setFiles([]);
        setBulkWarningAcknowledged(false);
      },
      className: "text-xs text-gray-500 hover:text-red-600"
    }, "Clear all")), /*#__PURE__*/React.createElement("div", {
      className: "space-y-2 max-h-32 overflow-y-auto"
    }, files.map((file, i) => /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "flex items-center justify-between text-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "truncate"
    }, file.name), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400 ml-2"
    }, formatFileSize(file.size))))), files.length > 5 && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-2"
    }, "Total size: ", formatFileSize(files.reduce((sum, f) => sum + f.size, 0)))), !selectedDiscipline && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Drawing Category ", /*#__PURE__*/React.createElement("span", {
      className: "text-red-500"
    }, "*")), /*#__PURE__*/React.createElement("select", {
      value: uploadCategory,
      onChange: e => {
        setUploadCategory(e.target.value);
        setUploadDiscipline('');
      },
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "Select a category..."), DRAWING_CATEGORIES.map(cat => /*#__PURE__*/React.createElement("option", {
      key: cat.id,
      value: cat.id
    }, cat.name)))), !selectedDiscipline && uploadCategory && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Discipline ", /*#__PURE__*/React.createElement("span", {
      className: "text-red-500"
    }, "*")), /*#__PURE__*/React.createElement("select", {
      value: uploadDiscipline,
      onChange: e => setUploadDiscipline(e.target.value),
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "Select a discipline..."), getUploadDisciplines().map(disc => /*#__PURE__*/React.createElement("option", {
      key: disc.id,
      value: disc.id
    }, disc.name)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Description (optional)"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: description,
      onChange: e => setDescription(e.target.value),
      placeholder: "Brief description of these drawings",
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Version Notes (optional)"), /*#__PURE__*/React.createElement("textarea", {
      value: notes,
      onChange: e => setNotes(e.target.value),
      placeholder: "Notes about this version...",
      rows: 3,
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadModal(false),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        const targetDiscipline = selectedDiscipline || uploadDiscipline;
        if (!targetDiscipline) {
          alert('Please select a category and discipline');
          return;
        }
        handleFileUpload(files, {
          description,
          notes
        }, targetDiscipline);
      },
      disabled: files.length === 0 || !selectedDiscipline && !uploadDiscipline,
      className: "px-4 py-2 text-white rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, "Upload ", files.length > 0 ? `(${files.length})` : ''))));
  };

  // =========================================================================
  // RENDER: Version History Modal
  // =========================================================================
  const VersionHistoryModal = () => {
    const [newVersionFile, setNewVersionFile] = useState(null);
    const [newVersionNotes, setNewVersionNotes] = useState('');
    const [showUploadNew, setShowUploadNew] = useState(false);
    if (!showVersionHistory) return null;
    const drawing = showVersionHistory;
    const versions = [...(drawing.versions || [])].reverse();
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "Version History"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 text-sm mt-1"
    }, drawing.name)), /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowVersionHistory(null),
      className: "p-2 hover:bg-gray-100 rounded-lg transition"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-close w-5 h-5"
    })))), /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, !showUploadNew ? /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowUploadNew(true),
      className: "w-full mb-6 px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-upload w-5 h-5"
    }), "Upload New Version") : /*#__PURE__*/React.createElement("div", {
      className: "mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "font-medium text-blue-900 mb-3"
    }, "Upload New Version"), /*#__PURE__*/React.createElement("div", {
      className: "space-y-3"
    }, /*#__PURE__*/React.createElement("label", {
      className: "block"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-700"
    }, "Select File"), /*#__PURE__*/React.createElement("input", {
      type: "file",
      onChange: e => setNewVersionFile(e.target.files?.[0] || null),
      className: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200",
      accept: ".pdf,.dwg,.dxf,.png,.jpg,.jpeg,.tif,.tiff"
    })), /*#__PURE__*/React.createElement("label", {
      className: "block"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-sm text-gray-700"
    }, "Version Notes"), /*#__PURE__*/React.createElement("textarea", {
      value: newVersionNotes,
      onChange: e => setNewVersionNotes(e.target.value),
      placeholder: "What changed in this version?",
      rows: 2,
      className: "mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    })), /*#__PURE__*/React.createElement("div", {
      className: "flex justify-end gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setShowUploadNew(false);
        setNewVersionFile(null);
        setNewVersionNotes('');
      },
      className: "px-3 py-1.5 text-gray-600 hover:bg-gray-100 rounded transition"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        if (newVersionFile) {
          handleVersionUpload(drawing.id, newVersionFile, newVersionNotes);
          setShowUploadNew(false);
          setNewVersionFile(null);
          setNewVersionNotes('');
        }
      },
      disabled: !newVersionFile,
      className: "px-3 py-1.5 text-white rounded transition disabled:opacity-50",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, "Upload")))), /*#__PURE__*/React.createElement("div", {
      className: "space-y-4"
    }, versions.map((version, index) => /*#__PURE__*/React.createElement("div", {
      key: version.id,
      className: `relative pl-6 pb-4 ${index < versions.length - 1 ? 'border-l-2 border-gray-200' : ''}`
    }, /*#__PURE__*/React.createElement("div", {
      className: `absolute left-0 top-0 w-3 h-3 rounded-full -translate-x-[7px] ${index === 0 ? 'bg-blue-500' : 'bg-gray-300'}`
    }), /*#__PURE__*/React.createElement("div", {
      className: `bg-white rounded-lg border p-4 ${index === 0 ? 'border-blue-200 shadow-sm' : 'border-gray-200'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${index === 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}`
    }, "v", version.version), index === 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-green-600 font-medium"
    }, "Current")), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600 mt-1"
    }, version.notes || 'No notes'), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4 mt-2 text-xs text-gray-400"
    }, /*#__PURE__*/React.createElement("span", null, formatDate(version.uploadedAt)), /*#__PURE__*/React.createElement("span", null, "by ", version.uploadedBy), /*#__PURE__*/React.createElement("span", null, formatFileSize(version.fileSize)))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleView(version),
      className: "p-2 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition",
      title: "View this version"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-eye w-4 h-4"
    })), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDownload(version),
      className: "p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition",
      title: "Download this version"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-download w-4 h-4"
    }))))))))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowVersionHistory(null),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
    }, "Close"))));
  };

  // =========================================================================
  // RENDER: Duplicate File Prompt Modal
  // =========================================================================
  const DuplicatePromptModal = () => {
    if (!showDuplicatePrompt) return null;
    const {
      file,
      existingDrawing,
      onAction,
      remainingDuplicates
    } = showDuplicatePrompt;
    const existingVersion = existingDrawing.versions?.[0];
    const hasMoreFiles = remainingDuplicates > 0;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-lg w-full"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-file w-6 h-6 text-amber-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900"
    }, "Duplicate File Detected"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, "A file with this name already exists")))), /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-50 rounded-lg p-4 mb-4"
    }, /*#__PURE__*/React.createElement("p", {
      className: "font-medium text-gray-900 mb-2"
    }, file.name), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-4 text-sm"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500"
    }, "New File"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-700"
    }, formatFileSize(file.size))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500"
    }, "Existing File"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-700"
    }, formatFileSize(existingVersion?.file_size), " \u2022 v", existingVersion?.version || '1.0')))), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-700 mb-4"
    }, "What would you like to do?"), /*#__PURE__*/React.createElement("div", {
      className: "space-y-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => onAction('newVersion'),
      className: "flex-1 p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition group"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center group-hover:bg-blue-200"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-history w-5 h-5 text-blue-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "font-medium text-gray-900"
    }, "Add as New Version"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, "Keep existing and add as new version")))), hasMoreFiles && /*#__PURE__*/React.createElement("button", {
      onClick: () => onAction('newVersionAll'),
      className: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap",
      title: "Apply to all remaining duplicates"
    }, "Apply to All")), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => onAction('skip'),
      className: "flex-1 p-4 text-left border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition group"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-close w-5 h-5 text-gray-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "font-medium text-gray-900"
    }, "Skip This File"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, "Don't upload, keep existing")))), hasMoreFiles && /*#__PURE__*/React.createElement("button", {
      onClick: () => onAction('skipAll'),
      className: "px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm font-medium whitespace-nowrap",
      title: "Skip all remaining duplicates"
    }, "Skip All"))), hasMoreFiles && /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-4 text-center"
    }, remainingDuplicates, " more duplicate", remainingDuplicates > 1 ? 's' : '', " remaining"))));
  };

  // =========================================================================
  // RENDER: Delete Confirmation Modal (Soft Delete with Recovery Option)
  // =========================================================================
  const DeleteConfirmModal = () => {
    if (!showDeleteConfirm) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-md w-full"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4 mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-trash w-6 h-6 text-amber-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900"
    }, "Delete Drawing?"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, "File will be hidden but can be recovered"))), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-700 mb-2"
    }, "Are you sure you want to delete ", /*#__PURE__*/React.createElement("strong", null, showDeleteConfirm.name), "?"), /*#__PURE__*/React.createElement("div", {
      className: "bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-blue-800"
    }, /*#__PURE__*/React.createElement("strong", null, "Recovery Available:"), " The file will remain in SharePoint and can be restored by an admin if needed."))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowDeleteConfirm(null),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: async () => {
        await handleDeleteDrawing(showDeleteConfirm.id);
        await logDrawingActivity('delete', showDeleteConfirm.id, {
          name: showDeleteConfirm.name,
          versions: showDeleteConfirm.versions?.length || 1
        });
      },
      className: "px-4 py-2 bg-amber-600 text-white hover:bg-amber-700 rounded-lg transition"
    }, "Delete"))));
  };

  // =========================================================================
  // RENDER: Edit Drawing Modal (Rename, Link to Module, View Activity)
  // =========================================================================
  const EditDrawingModal = () => {
    const [newName, setNewName] = useState(showEditDrawing?.name || '');
    const [linkedModuleId, setLinkedModuleId] = useState(showEditDrawing?.linked_module_id || '');
    const [isSaving, setIsSaving] = useState(false);
    if (!showEditDrawing) return null;
    const parsedModule = window.MODA_SUPABASE_DRAWINGS?.utils?.parseModuleFromFilename?.(showEditDrawing.name);
    const currentLinkedModule = parsedModule ? findModuleByBLM(parsedModule) : null;
    const projectModules = selectedProject?.modules || [];
    const handleSave = async () => {
      setIsSaving(true);
      try {
        // Update drawing name in database
        if (newName !== showEditDrawing.name) {
          await window.MODA_SUPABASE_DRAWINGS.drawings.update(showEditDrawing.id, {
            name: newName,
            linked_module_id: linkedModuleId || null
          });

          // Log activity
          await logDrawingActivity('rename', showEditDrawing.id, {
            oldName: showEditDrawing.name,
            newName: newName,
            linkedModuleId: linkedModuleId
          });
        }

        // Refresh drawings list
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
        setCurrentDrawings(drawings);
        setShowEditDrawing(null);
      } catch (error) {
        console.error('[Drawings] Error updating drawing:', error);
        alert('Error updating drawing: ' + error.message);
      } finally {
        setIsSaving(false);
      }
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-lg w-full"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-edit w-6 h-6 text-blue-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900"
    }, "Edit Drawing"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, "Rename or link to a module")))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 space-y-4"
    }, !currentLinkedModule && parsedModule && /*#__PURE__*/React.createElement("div", {
      className: "bg-amber-50 border border-amber-200 rounded-lg p-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-amber-800"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-alert w-5 h-5"
    }), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Unlinked Drawing")), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-amber-700 mt-1"
    }, "Parsed BLM \"", parsedModule, "\" does not match any module in this project. Rename the file or manually link to a module below.")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "File Name"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: newName,
      onChange: e => setNewName(e.target.value),
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
      placeholder: "e.g., B1L3M18 - Shops.pdf"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-1"
    }, "Include the BLM ID in the filename for automatic linking (e.g., B1L3M18)")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, "Link to Module (Optional)"), /*#__PURE__*/React.createElement("select", {
      value: linkedModuleId,
      onChange: e => setLinkedModuleId(e.target.value),
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "-- Auto-detect from filename --"), projectModules.map(m => /*#__PURE__*/React.createElement("option", {
      key: m.id,
      value: m.id
    }, m.serialNumber, " - Seq #", m.buildSequence, " (", m.hitchBLM, "/", m.rearBLM, ")"))), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-1"
    }, "Override automatic BLM detection by selecting a specific module")), currentLinkedModule && /*#__PURE__*/React.createElement("div", {
      className: "bg-emerald-50 border border-emerald-200 rounded-lg p-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-emerald-800"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-check w-5 h-5"
    }), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Currently Linked")), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-emerald-700 mt-1"
    }, currentLinkedModule.serialNumber, " - Build Seq #", currentLinkedModule.buildSequence))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowEditDrawing(null),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition",
      disabled: isSaving
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: handleSave,
      disabled: isSaving || !newName.trim(),
      className: "px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition disabled:opacity-50"
    }, isSaving ? 'Saving...' : 'Save Changes'))));
  };

  // =========================================================================
  // RENDER: Bulk Rename Modal (Fix Unlinked Drawings)
  // =========================================================================
  const BulkRenameModal = () => {
    const [selectedItems, setSelectedItems] = useState(
    // Pre-select items that have a recommended name
    unlinkedDrawings.filter(u => u.recommendedName).map(u => u.drawing.id));
    const [isProcessing, setIsProcessing] = useState(false);
    const [processedCount, setProcessedCount] = useState(0);
    if (!showBulkRenameModal) return null;
    const itemsWithRecommendation = unlinkedDrawings.filter(u => u.recommendedName);
    const itemsWithoutRecommendation = unlinkedDrawings.filter(u => !u.recommendedName);
    const toggleItem = drawingId => {
      setSelectedItems(prev => prev.includes(drawingId) ? prev.filter(id => id !== drawingId) : [...prev, drawingId]);
    };
    const selectAll = () => {
      setSelectedItems(itemsWithRecommendation.map(u => u.drawing.id));
    };
    const selectNone = () => {
      setSelectedItems([]);
    };
    const handleApplyRenames = async () => {
      const itemsToRename = unlinkedDrawings.filter(u => selectedItems.includes(u.drawing.id) && u.recommendedName);
      if (itemsToRename.length === 0) return;
      setIsProcessing(true);
      setProcessedCount(0);
      try {
        for (let i = 0; i < itemsToRename.length; i++) {
          const {
            drawing,
            recommendedName,
            recommendedModule
          } = itemsToRename[i];

          // Only update the name - module linking is done by filename matching, not by ID
          await window.MODA_SUPABASE_DRAWINGS.drawings.update(drawing.id, {
            name: recommendedName
          });
          await logDrawingActivity('rename', drawing.id, {
            oldName: drawing.name,
            newName: recommendedName,
            linkedModuleSerial: recommendedModule?.serialNumber,
            bulkRename: true
          });
          setProcessedCount(i + 1);
        }

        // Refresh drawings list
        const drawings = await window.MODA_SUPABASE_DRAWINGS.drawings.getByProjectAndDiscipline(selectedProject.id, selectedDiscipline);
        setCurrentDrawings(drawings);
        setShowBulkRenameModal(false);
      } catch (error) {
        console.error('[Drawings] Error in bulk rename:', error);
        alert('Error renaming files: ' + error.message);
      } finally {
        setIsProcessing(false);
      }
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-edit w-6 h-6 text-amber-600"
    })), /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900"
    }, "Fix Unlinked Drawings"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, unlinkedDrawings.length, " drawing", unlinkedDrawings.length !== 1 ? 's' : '', " not linked to project modules")))), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 overflow-y-auto p-6"
    }, itemsWithRecommendation.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "mb-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-3"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-900"
    }, "Recommended Renames (", itemsWithRecommendation.length, ")"), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2 text-sm"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: selectAll,
      className: "text-blue-600 hover:underline"
    }, "Select All"), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-300"
    }, "|"), /*#__PURE__*/React.createElement("button", {
      onClick: selectNone,
      className: "text-gray-600 hover:underline"
    }, "Select None"))), /*#__PURE__*/React.createElement("div", {
      className: "space-y-2"
    }, itemsWithRecommendation.map(({
      drawing,
      recommendedName,
      recommendedModule
    }) => /*#__PURE__*/React.createElement("div", {
      key: drawing.id,
      className: `p-3 rounded-lg border transition cursor-pointer ${selectedItems.includes(drawing.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`,
      onClick: () => toggleItem(drawing.id)
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-3"
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: selectedItems.includes(drawing.id),
      onChange: () => toggleItem(drawing.id),
      className: "mt-1 w-4 h-4 rounded",
      onClick: e => e.stopPropagation()
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 truncate"
    }, drawing.name), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, "\u2192"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-gray-900 truncate"
    }, recommendedName)), recommendedModule && /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-emerald-600 mt-1 flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-check w-3 h-3"
    }), "Links to: ", recommendedModule.serialNumber, " (Seq #", recommendedModule.buildSequence, ")"))))))), itemsWithoutRecommendation.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-900 mb-3"
    }, "Manual Review Required (", itemsWithoutRecommendation.length, ")"), /*#__PURE__*/React.createElement("div", {
      className: "space-y-2"
    }, itemsWithoutRecommendation.map(({
      drawing,
      parsedBLM,
      hasConflict
    }) => /*#__PURE__*/React.createElement("div", {
      key: drawing.id,
      className: "p-3 rounded-lg border border-gray-200 bg-gray-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900 truncate"
    }, drawing.name), /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 mt-0.5"
    }, hasConflict ? '⚠️ Recommended name conflicts with existing file' : parsedBLM ? `Parsed BLM "${parsedBLM}" not found in project` : 'No BLM pattern detected in filename')), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setShowBulkRenameModal(false);
        setShowEditDrawing(drawing);
      },
      className: "px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded transition"
    }, "Edit"))))))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-600"
    }, selectedItems.length, " of ", itemsWithRecommendation.length, " selected"), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowBulkRenameModal(false),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition",
      disabled: isProcessing
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: handleApplyRenames,
      disabled: isProcessing || selectedItems.length === 0,
      className: "px-4 py-2 bg-amber-500 text-white hover:bg-amber-600 rounded-lg transition disabled:opacity-50 flex items-center gap-2"
    }, isProcessing ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
      className: "animate-spin"
    }, "\u23F3"), "Renaming ", processedCount, "/", selectedItems.length, "...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
      className: "icon-check w-4 h-4"
    }), "Apply ", selectedItems.length, " Rename", selectedItems.length !== 1 ? 's' : ''))))));
  };

  // =========================================================================
  // RENDER: File Info Modal (with Version History)
  // =========================================================================
  const FileInfoModal = () => {
    if (!showFileInfo) return null;
    const {
      drawing,
      latestVersion,
      linkedModule,
      parsedModule
    } = showFileInfo;

    // Sort versions by date descending (newest first)
    const sortedVersions = [...(drawing.versions || [])].sort((a, b) => new Date(b.uploaded_at || b.uploadedAt) - new Date(a.uploaded_at || a.uploadedAt));
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-info w-6 h-6 text-blue-600"
    })), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900 truncate"
    }, drawing.name), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, "File Information & Version History")))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 space-y-4 overflow-y-auto flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 md:grid-cols-4 gap-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "File Size"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, formatFileSize(latestVersion?.file_size || latestVersion?.fileSize))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "Current Version"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, "v", latestVersion?.version || '1.0')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "File Type"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, drawing.name.split('.').pop()?.toUpperCase() || 'Unknown')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "Total Versions"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, drawing.versions?.length || 1))), /*#__PURE__*/React.createElement("div", {
      className: "border-t border-gray-200 pt-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "Uploaded By"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, latestVersion?.uploaded_by || latestVersion?.uploadedBy || drawing.created_by || 'Unknown')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider"
    }, "Last Updated"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm font-medium text-gray-900"
    }, formatDate(latestVersion?.uploaded_at || latestVersion?.uploadedAt || drawing.created_at))))), isModulePackages && /*#__PURE__*/React.createElement("div", {
      className: "border-t border-gray-200 pt-4"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider mb-2"
    }, "Module Link"), linkedModule ? /*#__PURE__*/React.createElement("div", {
      className: "bg-emerald-50 border border-emerald-200 rounded-lg p-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 gap-2 text-sm"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-emerald-600"
    }, "Serial No:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-1 font-medium text-emerald-800"
    }, linkedModule.serialNumber)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-emerald-600"
    }, "Build Seq:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-1 font-medium text-emerald-800"
    }, "#", linkedModule.buildSequence)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-emerald-600"
    }, "Hitch BLM:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-1 font-medium text-emerald-800"
    }, linkedModule.hitchBLM || '-')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      className: "text-emerald-600"
    }, "Rear BLM:"), /*#__PURE__*/React.createElement("span", {
      className: "ml-1 font-medium text-emerald-800"
    }, linkedModule.rearBLM || '-')))) : parsedModule ? /*#__PURE__*/React.createElement("div", {
      className: "bg-amber-50 border border-amber-200 rounded-lg p-3"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-amber-800"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Unlinked:"), " Parsed BLM \"", parsedModule, "\" does not match any module.")) : /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, "No module ID detected in filename")), /*#__PURE__*/React.createElement("div", {
      className: "border-t border-gray-200 pt-4"
    }, /*#__PURE__*/React.createElement("p", {
      className: "text-xs text-gray-500 uppercase tracking-wider mb-3"
    }, "Version History"), sortedVersions.length > 0 ? /*#__PURE__*/React.createElement("div", {
      className: "space-y-2 max-h-48 overflow-y-auto"
    }, sortedVersions.map((version, index) => {
      const isLatest = index === 0;
      return /*#__PURE__*/React.createElement("div", {
        key: version.id || index,
        className: `flex items-center justify-between p-3 rounded-lg border ${isLatest ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'}`
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex-1 min-w-0"
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-2"
      }, /*#__PURE__*/React.createElement("span", {
        className: `font-medium ${isLatest ? 'text-blue-700' : 'text-gray-700'}`
      }, "v", version.version || '1.0'), isLatest && /*#__PURE__*/React.createElement("span", {
        className: "px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full"
      }, "Current")), /*#__PURE__*/React.createElement("div", {
        className: "text-xs text-gray-500 mt-1"
      }, formatDate(version.uploaded_at || version.uploadedAt), (version.uploaded_by || version.uploadedBy) && /*#__PURE__*/React.createElement("span", null, " by ", version.uploaded_by || version.uploadedBy)), version.notes && /*#__PURE__*/React.createElement("div", {
        className: "text-xs text-gray-600 mt-1 italic"
      }, version.notes)), /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-1 ml-2"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: e => handleView(version, e),
        className: "p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-100 rounded transition",
        title: "View this version"
      }, /*#__PURE__*/React.createElement("span", {
        className: "icon-eye w-4 h-4"
      }))));
    })) : /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500 italic"
    }, "No version history available"))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowFileInfo(null),
      className: "px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition"
    }, "Close"))));
  };

  // =========================================================================
  // RENDER: Folder Modal (Add/Edit with Color Picker)
  // =========================================================================
  const FolderModal = () => {
    const [folderName, setFolderName] = useState(showFolderModal?.folder?.name || '');
    const [folderColor, setFolderColor] = useState(showFolderModal?.folder?.color || 'bg-gray-100 border-gray-400');
    if (!showFolderModal) return null;
    const isEdit = showFolderModal.mode === 'edit';
    const isCategory = showFolderModal.type === 'category';
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-md w-full"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-b border-gray-200"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, isEdit ? 'Edit' : 'Add', " ", isCategory ? 'Category' : 'Discipline')), /*#__PURE__*/React.createElement("div", {
      className: "p-6 space-y-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-1"
    }, isCategory ? 'Category' : 'Discipline', " Name ", /*#__PURE__*/React.createElement("span", {
      className: "text-red-500"
    }, "*")), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: folderName,
      onChange: e => setFolderName(e.target.value),
      placeholder: isCategory ? 'e.g., Construction Documents' : 'e.g., HVAC Drawings',
      className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
      autoFocus: true
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-2"
    }, "Folder Color"), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-7 gap-2"
    }, FOLDER_COLORS.map(color => /*#__PURE__*/React.createElement("button", {
      key: color.id,
      onClick: () => setFolderColor(color.value),
      className: `w-8 h-8 rounded-lg border-2 transition ${color.value} ${folderColor === color.value ? 'ring-2 ring-blue-500 ring-offset-2' : ''}`,
      title: color.label
    })))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-sm font-medium text-gray-700 mb-2"
    }, "Preview"), /*#__PURE__*/React.createElement("div", {
      className: `rounded-lg border-2 p-4 ${folderColor}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-lg bg-white/80 flex items-center justify-center shadow-sm"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-folder w-5 h-5",
      style: {
        filter: 'invert(50%) sepia(90%) saturate(500%) hue-rotate(5deg)'
      }
    })), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-gray-900"
    }, folderName || 'Folder Name'))))), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowFolderModal(null),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        if (!folderName.trim()) {
          alert('Please enter a folder name');
          return;
        }
        handleSaveFolder({
          id: showFolderModal.folder?.id,
          name: folderName.trim(),
          color: folderColor,
          folderType: showFolderModal.type,
          parentId: showFolderModal.parentId
        });
      },
      disabled: !folderName.trim(),
      className: "px-4 py-2 text-white rounded-lg transition disabled:opacity-50",
      style: {
        backgroundColor: 'var(--autovol-teal)'
      }
    }, isEdit ? 'Save Changes' : 'Create Folder'))));
  };

  // =========================================================================
  // RENDER: Delete Folder Confirmation Modal
  // =========================================================================
  const DeleteFolderConfirmModal = () => {
    if (!showDeleteFolderConfirm) return null;
    const isCategory = showDeleteFolderConfirm.folder_type === 'category' || !showDeleteFolderConfirm.parent_id;
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl max-w-md w-full"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4 mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-12 h-12 rounded-full bg-red-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-trash w-6 h-6 text-red-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-bold text-gray-900"
    }, "Delete ", isCategory ? 'Category' : 'Discipline', "?"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600"
    }, "This action cannot be undone."))), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-700 mb-2"
    }, "Are you sure you want to delete ", /*#__PURE__*/React.createElement("strong", null, showDeleteFolderConfirm.name), "?"), isCategory && /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-red-600"
    }, "Warning: This will also delete all disciplines within this category.")), /*#__PURE__*/React.createElement("div", {
      className: "p-6 border-t border-gray-200 flex justify-end gap-3"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowDeleteFolderConfirm(null),
      className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
    }, "Cancel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDeleteFolder(showDeleteFolderConfirm.id),
      className: "px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg transition"
    }, "Delete"))));
  };

  // =========================================================================
  // MAIN RENDER
  // =========================================================================
  return /*#__PURE__*/React.createElement("div", {
    className: `bg-white rounded-lg shadow-sm ${isMobile ? 'p-2' : 'p-3'}`
  }, uploadProgress && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"
  }), /*#__PURE__*/React.createElement("h3", {
    className: "font-medium text-gray-900"
  }, "Uploading..."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-1"
  }, uploadProgress.current, " of ", uploadProgress.total), uploadProgress.fileName && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 mt-2 truncate"
  }, uploadProgress.fileName), uploadProgress.timeRemaining && uploadProgress.timeRemaining > 1000 && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-blue-600 mt-2"
  }, "Est. time remaining: ", Math.ceil(uploadProgress.timeRemaining / 60000), " min ", Math.ceil(uploadProgress.timeRemaining % 60000 / 1000), " sec"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      uploadCancelledRef.current = true;
      setUploadProgress(null);
      setShowUploadModal(false);
    },
    className: "mt-4 px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition border border-red-200"
  }, "Cancel Upload"))), processingDrawing && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600 mx-auto mb-4"
  }), /*#__PURE__*/React.createElement("h3", {
    className: "font-medium text-gray-900"
  }, "Processing Sheets..."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-1"
  }, "Splitting PDF and extracting title block metadata"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 mt-2"
  }, "This may take several minutes for large files"))), showUploadModal && /*#__PURE__*/React.createElement(UploadModal, null), /*#__PURE__*/React.createElement(VersionHistoryModal, null), /*#__PURE__*/React.createElement(DeleteConfirmModal, null), /*#__PURE__*/React.createElement(DuplicatePromptModal, null), /*#__PURE__*/React.createElement(EditDrawingModal, null), /*#__PURE__*/React.createElement(BulkRenameModal, null), /*#__PURE__*/React.createElement(FileInfoModal, null), /*#__PURE__*/React.createElement(FolderModal, null), /*#__PURE__*/React.createElement(DeleteFolderConfirmModal, null), pdfViewerData && window.PDFViewerModal && /*#__PURE__*/React.createElement(window.PDFViewerModal, {
    isOpen: true,
    onClose: () => setPdfViewerData(null),
    pdfUrl: pdfViewerData.url,
    drawingName: pdfViewerData.name,
    drawingId: pdfViewerData.drawingId,
    versionId: pdfViewerData.versionId
  }), showDrawingStatusLog && window.DrawingStatusLog && /*#__PURE__*/React.createElement(window.DrawingStatusLog, {
    project: selectedProject,
    drawings: currentDrawings,
    onClose: () => setShowDrawingStatusLog(false),
    onNavigateToDrawing: drawing => {
      setShowDrawingStatusLog(false);
      setDrawingSearchTerm(drawing.name);
    }
  }), showSheetBrowser && window.SheetBrowser && /*#__PURE__*/React.createElement(window.SheetBrowser, {
    projectId: selectedProject?.id,
    projectName: selectedProject?.name,
    modules: selectedProject?.modules || [],
    onClose: () => setShowSheetBrowser(false),
    auth: auth
  }), showAnalysisBrowser && window.AnalysisBrowser && /*#__PURE__*/React.createElement(window.AnalysisBrowser, {
    projectId: selectedProject?.id,
    projectName: selectedProject?.name,
    analysisType: showAnalysisBrowser,
    onClose: () => setShowAnalysisBrowser(null),
    auth: auth
  }), !selectedProject && renderProjectsView(), selectedProject && !selectedCategory && renderCategoriesView(), selectedProject && selectedCategory && !selectedDiscipline && renderDisciplinesView(), selectedProject && selectedCategory && selectedDiscipline && renderDrawingsView());
};

// Export to window for use in App.jsx
window.DrawingsModule = DrawingsModule;
})();


// ============================================================================
// FILE: PDFViewerModal.jsx
// ============================================================================
(function() {
/**
 * PDFViewerModal - In-app PDF viewer with markup capabilities
 * 
 * Features:
 * - PDF viewing via browser's native PDF renderer (object/embed)
 * - Markup tools: Text box with arrow leader, Cloud, Arrow
 * - SVG overlay for annotations (better than canvas for this use case)
 */
// [Removed duplicate React destructuring]
const PDFViewerModal = ({
  isOpen,
  onClose,
  pdfUrl,
  drawingName,
  drawingId,
  versionId
}) => {
  // Detect mobile/iPad
  const isMobile = useMemo(() => {
    if (typeof window === 'undefined') return false;
    const ua = navigator.userAgent || '';
    return /iPhone|iPad|iPod|Android/i.test(ua) || navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
  }, []);

  // PDF.js state for mobile rendering
  const [pdfDoc, setPdfDoc] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(0);
  const [scale, setScale] = useState(1);
  const [isLoadingPdf, setIsLoadingPdf] = useState(false);
  const [pdfError, setPdfError] = useState(null);
  const canvasRef = useRef(null);
  const containerRef = useRef(null);

  // Touch gesture state
  const [touchState, setTouchState] = useState({
    initialDistance: null,
    initialScale: 1,
    isPinching: false
  });

  // Debug: log the PDF URL
  useEffect(() => {
    if (isOpen && pdfUrl) {
      console.log('[PDFViewer] Opening PDF:', pdfUrl, 'Mobile:', isMobile);
    }
  }, [isOpen, pdfUrl, isMobile]);

  // Markup state
  const [activeTool, setActiveTool] = useState(null); // 'textbox', 'cloud', 'arrow'
  const [annotations, setAnnotations] = useState([]);
  const [currentAnnotation, setCurrentAnnotation] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [selectedAnnotation, setSelectedAnnotation] = useState(null);
  const [showMarkupMode, setShowMarkupMode] = useState(false);

  // Text input state
  const [textInputVisible, setTextInputVisible] = useState(false);
  const [textInputValue, setTextInputValue] = useState('');
  const [textInputPosition, setTextInputPosition] = useState({
    x: 0,
    y: 0
  });

  // Refs
  const overlayRef = useRef(null);

  // Get mouse position relative to overlay
  const getMousePos = useCallback(e => {
    if (!overlayRef.current) return {
      x: 0,
      y: 0
    };
    const rect = overlayRef.current.getBoundingClientRect();
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }, []);

  // Handle overlay mouse down
  const handleMouseDown = useCallback(e => {
    if (!activeTool || !showMarkupMode) return;
    e.preventDefault();
    const pos = getMousePos(e);
    setIsDrawing(true);
    setSelectedAnnotation(null);
    setCurrentAnnotation({
      type: activeTool,
      startX: pos.x,
      startY: pos.y,
      endX: pos.x,
      endY: pos.y,
      text: ''
    });
  }, [activeTool, showMarkupMode, getMousePos]);

  // Handle overlay mouse move
  const handleMouseMove = useCallback(e => {
    if (!isDrawing || !currentAnnotation) return;
    const pos = getMousePos(e);
    setCurrentAnnotation(prev => ({
      ...prev,
      endX: pos.x,
      endY: pos.y
    }));
  }, [isDrawing, currentAnnotation, getMousePos]);

  // Handle overlay mouse up
  const handleMouseUp = useCallback(e => {
    if (!isDrawing || !currentAnnotation) return;
    setIsDrawing(false);

    // Check if annotation has meaningful size
    const dx = Math.abs(currentAnnotation.endX - currentAnnotation.startX);
    const dy = Math.abs(currentAnnotation.endY - currentAnnotation.startY);
    if (dx < 10 && dy < 10) {
      setCurrentAnnotation(null);
      return;
    }
    if (currentAnnotation.type === 'textbox') {
      // Show text input for textbox
      setTextInputPosition({
        x: Math.min(currentAnnotation.startX, currentAnnotation.endX),
        y: Math.min(currentAnnotation.startY, currentAnnotation.endY) - 40
      });
      setTextInputVisible(true);
      setTextInputValue('');
    } else {
      // Add annotation directly for cloud and arrow
      const newAnnotation = {
        ...currentAnnotation,
        id: Date.now().toString()
      };
      setAnnotations(prev => [...prev, newAnnotation]);
      setCurrentAnnotation(null);
    }
  }, [isDrawing, currentAnnotation]);

  // Handle text input submit
  const handleTextSubmit = useCallback(() => {
    if (textInputValue.trim() && currentAnnotation) {
      const newAnnotation = {
        ...currentAnnotation,
        text: textInputValue.trim(),
        id: Date.now().toString()
      };
      setAnnotations(prev => [...prev, newAnnotation]);
    }
    setTextInputVisible(false);
    setTextInputValue('');
    setCurrentAnnotation(null);
  }, [textInputValue, currentAnnotation]);

  // Handle text input cancel
  const handleTextCancel = useCallback(() => {
    setTextInputVisible(false);
    setTextInputValue('');
    setCurrentAnnotation(null);
  }, []);

  // Delete selected annotation
  const deleteSelectedAnnotation = useCallback(() => {
    if (selectedAnnotation) {
      setAnnotations(prev => prev.filter(a => a.id !== selectedAnnotation.id));
      setSelectedAnnotation(null);
    }
  }, [selectedAnnotation]);

  // Handle click on annotation to select
  const handleAnnotationClick = useCallback((e, annotation) => {
    e.stopPropagation();
    if (!activeTool) {
      setSelectedAnnotation(annotation);
    }
  }, [activeTool]);

  // Clear all annotations
  const clearAnnotations = useCallback(() => {
    if (confirm('Clear all annotations?')) {
      setAnnotations([]);
      setSelectedAnnotation(null);
    }
  }, []);

  // Toggle markup mode
  const toggleMarkupMode = useCallback(() => {
    setShowMarkupMode(prev => !prev);
    if (showMarkupMode) {
      setActiveTool(null);
      setSelectedAnnotation(null);
    }
  }, [showMarkupMode]);

  // Handle keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = e => {
      if (!isOpen) return;
      if (e.key === 'Escape') {
        if (textInputVisible) {
          handleTextCancel();
        } else if (activeTool) {
          setActiveTool(null);
          setCurrentAnnotation(null);
        } else if (showMarkupMode) {
          setShowMarkupMode(false);
        } else {
          onClose();
        }
      } else if ((e.key === 'Delete' || e.key === 'Backspace') && !textInputVisible) {
        if (selectedAnnotation) {
          e.preventDefault();
          deleteSelectedAnnotation();
        }
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, textInputVisible, activeTool, selectedAnnotation, showMarkupMode, handleTextCancel, deleteSelectedAnnotation, onClose]);

  // Load PDF with PDF.js for mobile
  useEffect(() => {
    if (!isOpen || !pdfUrl || !isMobile) return;
    const loadPdf = async () => {
      if (!window.pdfjsLib) {
        setPdfError('PDF viewer not loaded. Please refresh the page.');
        return;
      }
      setIsLoadingPdf(true);
      setPdfError(null);
      try {
        console.log('[PDFViewer] Loading PDF with PDF.js:', pdfUrl);
        const loadingTask = window.pdfjsLib.getDocument(pdfUrl);
        const pdf = await loadingTask.promise;
        setPdfDoc(pdf);
        setTotalPages(pdf.numPages);
        setCurrentPage(1);
        setScale(1);
        console.log('[PDFViewer] PDF loaded, pages:', pdf.numPages);
      } catch (error) {
        console.error('[PDFViewer] Error loading PDF:', error);
        setPdfError('Failed to load PDF: ' + error.message);
      } finally {
        setIsLoadingPdf(false);
      }
    };
    loadPdf();
    return () => {
      if (pdfDoc) {
        pdfDoc.destroy();
        setPdfDoc(null);
      }
    };
  }, [isOpen, pdfUrl, isMobile]);

  // Render current page to canvas
  useEffect(() => {
    if (!pdfDoc || !canvasRef.current || !isMobile) return;
    const renderPage = async () => {
      try {
        const page = await pdfDoc.getPage(currentPage);
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');

        // Calculate scale to fit width
        const containerWidth = containerRef.current?.clientWidth || window.innerWidth;
        const viewport = page.getViewport({
          scale: 1
        });
        const fitScale = (containerWidth - 20) / viewport.width;
        const finalScale = fitScale * scale;
        const scaledViewport = page.getViewport({
          scale: finalScale
        });

        // Set canvas dimensions
        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;

        // Render page
        await page.render({
          canvasContext: context,
          viewport: scaledViewport
        }).promise;
        console.log('[PDFViewer] Rendered page', currentPage, 'at scale', finalScale.toFixed(2));
      } catch (error) {
        console.error('[PDFViewer] Error rendering page:', error);
      }
    };
    renderPage();
  }, [pdfDoc, currentPage, scale, isMobile]);

  // Touch handlers for pinch-to-zoom
  const handleTouchStart = useCallback(e => {
    if (e.touches.length === 2) {
      const distance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      setTouchState({
        initialDistance: distance,
        initialScale: scale,
        isPinching: true
      });
    }
  }, [scale]);
  const handleTouchMove = useCallback(e => {
    if (touchState.isPinching && e.touches.length === 2) {
      e.preventDefault();
      const distance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      const newScale = Math.min(4, Math.max(0.5, touchState.initialScale * (distance / touchState.initialDistance)));
      setScale(newScale);
    }
  }, [touchState]);
  const handleTouchEnd = useCallback(() => {
    setTouchState(prev => ({
      ...prev,
      isPinching: false,
      initialDistance: null
    }));
  }, []);

  // Page navigation for mobile
  const goToPage = useCallback(pageNum => {
    if (pageNum >= 1 && pageNum <= totalPages) {
      setCurrentPage(pageNum);
    }
  }, [totalPages]);

  // Zoom controls for mobile
  const zoomIn = useCallback(() => setScale(s => Math.min(4, s + 0.25)), []);
  const zoomOut = useCallback(() => setScale(s => Math.max(0.5, s - 0.25)), []);
  const resetZoom = useCallback(() => setScale(1), []);

  // Render arrow SVG path
  const renderArrow = (startX, startY, endX, endY, isSelected) => {
    const headLength = 15;
    const angle = Math.atan2(endY - startY, endX - startX);
    const arrowHead1X = endX - headLength * Math.cos(angle - Math.PI / 6);
    const arrowHead1Y = endY - headLength * Math.sin(angle - Math.PI / 6);
    const arrowHead2X = endX - headLength * Math.cos(angle + Math.PI / 6);
    const arrowHead2Y = endY - headLength * Math.sin(angle + Math.PI / 6);
    return /*#__PURE__*/React.createElement("g", null, /*#__PURE__*/React.createElement("line", {
      x1: startX,
      y1: startY,
      x2: endX,
      y2: endY,
      stroke: isSelected ? '#0066FF' : '#FF0000',
      strokeWidth: "3"
    }), /*#__PURE__*/React.createElement("polygon", {
      points: `${endX},${endY} ${arrowHead1X},${arrowHead1Y} ${arrowHead2X},${arrowHead2Y}`,
      fill: isSelected ? '#0066FF' : '#FF0000'
    }));
  };

  // Render cloud SVG path
  const renderCloud = (x1, y1, x2, y2, isSelected) => {
    const minX = Math.min(x1, x2);
    const minY = Math.min(y1, y2);
    const width = Math.abs(x2 - x1);
    const height = Math.abs(y2 - y1);
    if (width < 20 || height < 20) return null;

    // Create cloud path with bumps
    const numBumpsH = Math.max(3, Math.floor(width / 40));
    const numBumpsV = Math.max(2, Math.floor(height / 40));
    const bumpRadiusH = width / (numBumpsH * 2);
    const bumpRadiusV = height / (numBumpsV * 2);
    let path = `M ${minX + bumpRadiusH} ${minY + bumpRadiusH}`;

    // Top bumps
    for (let i = 0; i < numBumpsH; i++) {
      const cx = minX + bumpRadiusH + i * bumpRadiusH * 2;
      path += ` A ${bumpRadiusH} ${bumpRadiusH} 0 0 1 ${cx + bumpRadiusH * 2} ${minY + bumpRadiusH}`;
    }

    // Right bumps
    for (let i = 0; i < numBumpsV; i++) {
      const cy = minY + bumpRadiusV + i * bumpRadiusV * 2;
      path += ` A ${bumpRadiusV} ${bumpRadiusV} 0 0 1 ${minX + width - bumpRadiusV} ${cy + bumpRadiusV * 2}`;
    }

    // Bottom bumps (reverse)
    for (let i = numBumpsH - 1; i >= 0; i--) {
      const cx = minX + bumpRadiusH + i * bumpRadiusH * 2;
      path += ` A ${bumpRadiusH} ${bumpRadiusH} 0 0 1 ${cx} ${minY + height - bumpRadiusH}`;
    }

    // Left bumps
    for (let i = numBumpsV - 1; i >= 0; i--) {
      const cy = minY + bumpRadiusV + i * bumpRadiusV * 2;
      path += ` A ${bumpRadiusV} ${bumpRadiusV} 0 0 1 ${minX + bumpRadiusV} ${cy}`;
    }
    path += ' Z';
    return /*#__PURE__*/React.createElement("path", {
      d: path,
      fill: "none",
      stroke: isSelected ? '#0066FF' : '#FF0000',
      strokeWidth: "3"
    });
  };

  // Render textbox with arrow leader
  const renderTextbox = (annotation, isSelected) => {
    const {
      startX,
      startY,
      endX,
      endY,
      text
    } = annotation;

    // Text box dimensions
    const padding = 8;
    const fontSize = 14;
    const textWidth = text ? Math.max(text.length * 8, 60) : 60;
    const boxWidth = textWidth + padding * 2;
    const boxHeight = fontSize + padding * 2;

    // Position text box at start, arrow points to end
    const boxX = startX;
    const boxY = startY - boxHeight;

    // Arrow from bottom center of box to end point
    const arrowStartX = startX + boxWidth / 2;
    const arrowStartY = startY;
    return /*#__PURE__*/React.createElement("g", null, /*#__PURE__*/React.createElement("rect", {
      x: boxX,
      y: boxY,
      width: boxWidth,
      height: boxHeight,
      fill: "#FFFFCC",
      stroke: isSelected ? '#0066FF' : '#FF0000',
      strokeWidth: "2",
      rx: "3"
    }), text && /*#__PURE__*/React.createElement("text", {
      x: boxX + padding,
      y: boxY + boxHeight - padding - 2,
      fontSize: fontSize,
      fill: "#000000"
    }, text), renderArrow(arrowStartX, arrowStartY, endX, endY, isSelected));
  };

  // Render annotation based on type
  const renderAnnotation = (annotation, isSelected = false) => {
    const key = annotation.id || 'current';
    switch (annotation.type) {
      case 'arrow':
        return /*#__PURE__*/React.createElement("g", {
          key: key,
          onClick: e => annotation.id && handleAnnotationClick(e, annotation),
          style: {
            cursor: activeTool ? 'crosshair' : 'pointer'
          }
        }, renderArrow(annotation.startX, annotation.startY, annotation.endX, annotation.endY, isSelected));
      case 'cloud':
        return /*#__PURE__*/React.createElement("g", {
          key: key,
          onClick: e => annotation.id && handleAnnotationClick(e, annotation),
          style: {
            cursor: activeTool ? 'crosshair' : 'pointer'
          }
        }, renderCloud(annotation.startX, annotation.startY, annotation.endX, annotation.endY, isSelected));
      case 'textbox':
        return /*#__PURE__*/React.createElement("g", {
          key: key,
          onClick: e => annotation.id && handleAnnotationClick(e, annotation),
          style: {
            cursor: activeTool ? 'crosshair' : 'pointer'
          }
        }, renderTextbox(annotation, isSelected));
      default:
        return null;
    }
  };
  if (!isOpen) return null;
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/90 flex flex-col z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-900 text-white px-4 py-3 flex items-center justify-between flex-shrink-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-700 rounded transition",
    title: "Close (Esc)"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  }))), /*#__PURE__*/React.createElement("h2", {
    className: "font-medium truncate max-w-md"
  }, drawingName)), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: toggleMarkupMode,
    className: `px-4 py-2 rounded transition flex items-center gap-2 ${showMarkupMode ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-700 hover:bg-gray-600'}`
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    viewBox: "0 0 24 24",
    fill: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M18.5,1.15C17.97,1.15 17.46,1.34 17.07,1.73L11.26,7.55L16.91,13.2L22.73,7.39C23.5,6.61 23.5,5.35 22.73,4.56L19.89,1.73C19.5,1.34 19,1.15 18.5,1.15M10.3,8.5L4.34,14.46C3.56,15.24 3.56,16.5 4.34,17.27C5.12,18.05 6.38,18.05 7.16,17.27L13.11,11.32L10.3,8.5M2.93,17.94L1,23L6.06,21.07L2.93,17.94Z"
  })), showMarkupMode ? 'Exit Markup' : 'Markup'))), showMarkupMode && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800 text-white px-4 py-2 flex items-center gap-4 border-t border-gray-700 flex-shrink-0"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-400"
  }, "Tools:"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTool(activeTool === 'textbox' ? null : 'textbox'),
    className: `px-3 py-1.5 rounded transition flex items-center gap-2 ${activeTool === 'textbox' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`,
    title: "Text Box with Arrow Leader - Click and drag to place"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    viewBox: "0 0 24 24",
    fill: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"
  })), "Text"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTool(activeTool === 'cloud' ? null : 'cloud'),
    className: `px-3 py-1.5 rounded transition flex items-center gap-2 ${activeTool === 'cloud' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`,
    title: "Cloud Shape - Click and drag to draw"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    viewBox: "0 0 24 24",
    fill: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"
  })), "Cloud"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTool(activeTool === 'arrow' ? null : 'arrow'),
    className: `px-3 py-1.5 rounded transition flex items-center gap-2 ${activeTool === 'arrow' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`,
    title: "Arrow - Click and drag to draw"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    viewBox: "0 0 24 24",
    fill: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"
  })), "Arrow"), /*#__PURE__*/React.createElement("div", {
    className: "border-l border-gray-600 h-6 mx-2"
  }), selectedAnnotation && /*#__PURE__*/React.createElement("button", {
    onClick: deleteSelectedAnnotation,
    className: "px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded transition flex items-center gap-2",
    title: "Delete Selected (Del)"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    viewBox: "0 0 24 24",
    fill: "currentColor"
  }, /*#__PURE__*/React.createElement("path", {
    d: "M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
  })), "Delete"), annotations.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: clearAnnotations,
    className: "px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded transition text-sm",
    title: "Clear All Annotations"
  }, "Clear All"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-400"
  }, activeTool ? `Click and drag to draw ${activeTool}` : 'Select a tool or click annotation to select')), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 relative overflow-hidden bg-gray-700",
    ref: containerRef
  }, isMobile ? /*#__PURE__*/React.createElement("div", {
    className: "w-full h-full overflow-auto bg-gray-200",
    onTouchStart: handleTouchStart,
    onTouchMove: handleTouchMove,
    onTouchEnd: handleTouchEnd
  }, isLoadingPdf ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center h-full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading PDF..."))) : pdfError ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center h-full p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center bg-white rounded-lg p-6 shadow-lg max-w-sm"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-12 h-12 text-red-500 mx-auto mb-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
  })), /*#__PURE__*/React.createElement("p", {
    className: "text-red-600 font-medium mb-2"
  }, "Error Loading PDF"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm mb-4"
  }, pdfError), /*#__PURE__*/React.createElement("a", {
    href: pdfUrl,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
  }, "Open in Browser"))) : /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col items-center py-4"
  }, /*#__PURE__*/React.createElement("canvas", {
    ref: canvasRef,
    className: "shadow-lg bg-white",
    style: {
      touchAction: 'pan-x pan-y'
    }
  }))) :
  /*#__PURE__*/
  /* Desktop: Use Google Docs Viewer - bypasses X-Frame-Options restrictions */
  React.createElement("iframe", {
    src: `https://docs.google.com/viewer?url=${encodeURIComponent(pdfUrl)}&embedded=true`,
    className: "w-full h-full border-0 bg-white",
    style: {
      pointerEvents: showMarkupMode ? 'none' : 'auto'
    },
    title: drawingName
  }), showMarkupMode && /*#__PURE__*/React.createElement("svg", {
    ref: overlayRef,
    className: "absolute inset-0 w-full h-full",
    style: {
      cursor: activeTool ? 'crosshair' : 'default'
    },
    onMouseDown: handleMouseDown,
    onMouseMove: handleMouseMove,
    onMouseUp: handleMouseUp,
    onMouseLeave: () => {
      if (isDrawing) {
        setIsDrawing(false);
        setCurrentAnnotation(null);
      }
    }
  }, annotations.map(annotation => renderAnnotation(annotation, selectedAnnotation?.id === annotation.id)), currentAnnotation && renderAnnotation(currentAnnotation)), textInputVisible && /*#__PURE__*/React.createElement("div", {
    className: "absolute bg-white border-2 border-blue-500 rounded shadow-lg p-2 z-10",
    style: {
      left: textInputPosition.x,
      top: textInputPosition.y
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: textInputValue,
    onChange: e => setTextInputValue(e.target.value),
    onKeyDown: e => {
      if (e.key === 'Enter') handleTextSubmit();
      if (e.key === 'Escape') handleTextCancel();
    },
    className: "border border-gray-300 rounded px-2 py-1 text-sm w-48",
    placeholder: "Enter text...",
    autoFocus: true
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleTextSubmit,
    className: "px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
  }, "Add"), /*#__PURE__*/React.createElement("button", {
    onClick: handleTextCancel,
    className: "px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400"
  }, "Cancel")))), showMarkupMode && annotations.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800 text-white px-4 py-2 text-sm text-center border-t border-gray-700 flex-shrink-0"
  }, annotations.length, " annotation", annotations.length !== 1 ? 's' : '', " on this drawing"), isMobile && pdfDoc && !showMarkupMode && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-900 text-white px-4 py-3 flex items-center justify-between border-t border-gray-700 flex-shrink-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => goToPage(currentPage - 1),
    disabled: currentPage <= 1,
    className: "p-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-40 disabled:cursor-not-allowed"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 19l-7-7 7-7"
  }))), /*#__PURE__*/React.createElement("span", {
    className: "text-sm min-w-[80px] text-center"
  }, currentPage, " / ", totalPages), /*#__PURE__*/React.createElement("button", {
    onClick: () => goToPage(currentPage + 1),
    disabled: currentPage >= totalPages,
    className: "p-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-40 disabled:cursor-not-allowed"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 5l7 7-7 7"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: zoomOut,
    disabled: scale <= 0.5,
    className: "p-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-40"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M20 12H4"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: resetZoom,
    className: "text-sm px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 min-w-[50px]"
  }, Math.round(scale * 100), "%"), /*#__PURE__*/React.createElement("button", {
    onClick: zoomIn,
    disabled: scale >= 4,
    className: "p-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-40"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 4v16m8-8H4"
  })))), /*#__PURE__*/React.createElement("a", {
    href: pdfUrl,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "p-2 rounded bg-gray-700 hover:bg-gray-600",
    title: "Open in browser"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
  })))));
};

// Export to window for use in DrawingsModule
window.PDFViewerModal = PDFViewerModal;
})();


// ============================================================================
// FILE: DrawingStatusLog.jsx
// ============================================================================
(function() {
/**
 * DrawingStatusLog - Matrix view showing shop drawing status for all modules
 * 
 * Features:
 * - Shows all modules with their shop drawing status (has package / missing)
 * - Default sort: Module (M), Level (L), Building (B)
 * - Sawboxes defer to hitch side BLM
 * - Color coded: Green = has drawing, Red = missing drawing
 */
// [Removed duplicate React destructuring]
const DrawingStatusLog = ({
  project,
  drawings,
  onClose,
  onNavigateToDrawing
}) => {
  const [sortBy, setSortBy] = useState('module'); // 'module', 'level', 'building', 'sequence'
  const [sortDirection, setSortDirection] = useState('asc');
  const [filterStatus, setFilterStatus] = useState('all'); // 'all', 'has', 'missing'
  const [searchTerm, setSearchTerm] = useState('');

  // Parse BLM to extract Building, Level, Module components
  const parseBLM = useCallback(blm => {
    if (!blm) return {
      building: '',
      level: 0,
      module: 0,
      raw: ''
    };
    const normalized = blm.toUpperCase().replace(/[_\-\s]/g, '');

    // Pattern: B#L#M## or L#M##
    const match = normalized.match(/(?:B(\d+))?L(\d+)M(\d+)/);
    if (match) {
      return {
        building: match[1] || '1',
        level: parseInt(match[2], 10),
        module: parseInt(match[3], 10),
        raw: normalized
      };
    }
    return {
      building: '',
      level: 0,
      module: 0,
      raw: normalized
    };
  }, []);

  // Check if a module has a shop drawing
  const moduleHasDrawing = useCallback(module => {
    if (!drawings || drawings.length === 0) return false;

    // For sawboxes, use hitch BLM only
    const primaryBLM = module.sawbox ? module.hitchBLM : module.hitchBLM || module.rearBLM;
    const secondaryBLM = module.sawbox ? null : module.rearBLM !== module.hitchBLM ? module.rearBLM : null;
    const normalizedPrimary = (primaryBLM || '').toUpperCase().replace(/[_\-\s]/g, '');
    const normalizedSecondary = secondaryBLM ? secondaryBLM.toUpperCase().replace(/[_\-\s]/g, '') : null;

    // Extract L#M## patterns for matching
    const primaryLM = normalizedPrimary.match(/L\d+M\d+/)?.[0];
    const secondaryLM = normalizedSecondary?.match(/L\d+M\d+/)?.[0];
    return drawings.some(drawing => {
      const fileName = drawing.name.toUpperCase().replace(/[_\-\s]/g, '');

      // Check if filename contains the BLM
      if (normalizedPrimary && fileName.includes(normalizedPrimary)) return true;
      if (normalizedSecondary && fileName.includes(normalizedSecondary)) return true;

      // Check partial match (L#M## pattern)
      if (primaryLM && fileName.includes(primaryLM)) return true;
      if (secondaryLM && fileName.includes(secondaryLM)) return true;
      return false;
    });
  }, [drawings]);

  // Find the drawing for a module
  const findDrawingForModule = useCallback(module => {
    if (!drawings || drawings.length === 0) return null;
    const primaryBLM = module.sawbox ? module.hitchBLM : module.hitchBLM || module.rearBLM;
    const secondaryBLM = module.sawbox ? null : module.rearBLM !== module.hitchBLM ? module.rearBLM : null;
    const normalizedPrimary = (primaryBLM || '').toUpperCase().replace(/[_\-\s]/g, '');
    const normalizedSecondary = secondaryBLM ? secondaryBLM.toUpperCase().replace(/[_\-\s]/g, '') : null;
    const primaryLM = normalizedPrimary.match(/L\d+M\d+/)?.[0];
    const secondaryLM = normalizedSecondary?.match(/L\d+M\d+/)?.[0];
    return drawings.find(drawing => {
      const fileName = drawing.name.toUpperCase().replace(/[_\-\s]/g, '');
      if (normalizedPrimary && fileName.includes(normalizedPrimary)) return true;
      if (normalizedSecondary && fileName.includes(normalizedSecondary)) return true;
      if (primaryLM && fileName.includes(primaryLM)) return true;
      if (secondaryLM && fileName.includes(secondaryLM)) return true;
      return false;
    });
  }, [drawings]);

  // Process modules with drawing status
  const moduleStatuses = useMemo(() => {
    if (!project?.modules) return [];
    return project.modules.map(module => {
      const hasDrawing = moduleHasDrawing(module);
      const drawing = hasDrawing ? findDrawingForModule(module) : null;

      // For sawboxes, use hitch BLM for sorting
      const sortBLM = module.sawbox ? module.hitchBLM : module.hitchBLM || module.rearBLM;
      const parsed = parseBLM(sortBLM);
      return {
        module,
        hasDrawing,
        drawing,
        parsed,
        displayBLM: module.hitchBLM === module.rearBLM || !module.rearBLM ? module.hitchBLM : `${module.hitchBLM} / ${module.rearBLM}`
      };
    });
  }, [project?.modules, moduleHasDrawing, findDrawingForModule, parseBLM]);

  // Filter and sort modules
  const filteredAndSortedModules = useMemo(() => {
    let results = [...moduleStatuses];

    // Filter by status
    if (filterStatus === 'has') {
      results = results.filter(m => m.hasDrawing);
    } else if (filterStatus === 'missing') {
      results = results.filter(m => !m.hasDrawing);
    }

    // Filter by search term
    if (searchTerm.trim()) {
      const term = searchTerm.toLowerCase();
      results = results.filter(m => m.module.serialNumber?.toLowerCase().includes(term) || m.module.hitchBLM?.toLowerCase().includes(term) || m.module.rearBLM?.toLowerCase().includes(term) || String(m.module.buildSequence).includes(term));
    }

    // Sort - Default: Module (M), Level (L), Building (B)
    results.sort((a, b) => {
      let cmp = 0;
      switch (sortBy) {
        case 'module':
          // Primary: Module number, Secondary: Level, Tertiary: Building
          cmp = a.parsed.module - b.parsed.module;
          if (cmp === 0) cmp = a.parsed.level - b.parsed.level;
          if (cmp === 0) cmp = String(a.parsed.building).localeCompare(String(b.parsed.building));
          break;
        case 'level':
          // Primary: Level, Secondary: Module, Tertiary: Building
          cmp = a.parsed.level - b.parsed.level;
          if (cmp === 0) cmp = a.parsed.module - b.parsed.module;
          if (cmp === 0) cmp = String(a.parsed.building).localeCompare(String(b.parsed.building));
          break;
        case 'building':
          // Primary: Building, Secondary: Level, Tertiary: Module
          cmp = String(a.parsed.building).localeCompare(String(b.parsed.building));
          if (cmp === 0) cmp = a.parsed.level - b.parsed.level;
          if (cmp === 0) cmp = a.parsed.module - b.parsed.module;
          break;
        case 'sequence':
          // Build sequence
          cmp = (a.module.buildSequence || 9999) - (b.module.buildSequence || 9999);
          break;
        default:
          cmp = a.parsed.module - b.parsed.module;
      }
      return sortDirection === 'asc' ? cmp : -cmp;
    });
    return results;
  }, [moduleStatuses, filterStatus, searchTerm, sortBy, sortDirection]);

  // Statistics
  const stats = useMemo(() => {
    const total = moduleStatuses.length;
    const withDrawings = moduleStatuses.filter(m => m.hasDrawing).length;
    const missing = total - withDrawings;
    const percentage = total > 0 ? Math.round(withDrawings / total * 100) : 0;
    return {
      total,
      withDrawings,
      missing,
      percentage
    };
  }, [moduleStatuses]);

  // Handle sort column click
  const handleSort = useCallback(column => {
    if (sortBy === column) {
      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(column);
      setSortDirection('asc');
    }
  }, [sortBy]);

  // Render sort indicator
  const SortIndicator = ({
    column
  }) => {
    if (sortBy !== column) return /*#__PURE__*/React.createElement("span", {
      className: "text-gray-300 ml-1"
    }, "\u2195");
    return /*#__PURE__*/React.createElement("span", {
      className: "text-blue-600 ml-1"
    }, sortDirection === 'asc' ? '↑' : '↓');
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, "Drawing Status Log"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mt-1"
  }, project?.name, " - Shop Drawing Coverage")), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg transition"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-5 h-5 text-gray-500",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "mt-4 flex items-center gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-3 h-3 rounded-full bg-emerald-500"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-700"
  }, /*#__PURE__*/React.createElement("strong", null, stats.withDrawings), " with drawings")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-3 h-3 rounded-full bg-red-500"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-700"
  }, /*#__PURE__*/React.createElement("strong", null, stats.missing), " missing")), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-2 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-full bg-emerald-500 transition-all",
    style: {
      width: `${stats.percentage}%`
    }
  }))), /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium text-gray-700"
  }, stats.percentage, "%"))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-3 border-b border-gray-200 flex items-center gap-4 flex-wrap"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "text-sm text-gray-600"
  }, "Show:"), /*#__PURE__*/React.createElement("select", {
    value: filterStatus,
    onChange: e => setFilterStatus(e.target.value),
    className: "text-sm border border-gray-300 rounded-lg px-3 py-1.5"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Modules (", stats.total, ")"), /*#__PURE__*/React.createElement("option", {
    value: "has"
  }, "With Drawings (", stats.withDrawings, ")"), /*#__PURE__*/React.createElement("option", {
    value: "missing"
  }, "Missing Drawings (", stats.missing, ")"))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    placeholder: "Search by Serial #, BLM, or Build Seq...",
    className: "w-full max-w-xs text-sm border border-gray-300 rounded-lg px-3 py-1.5"
  })), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Showing ", filteredAndSortedModules.length, " of ", stats.total, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50 sticky top-0"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700"
  }, "Status"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100",
    onClick: () => handleSort('sequence')
  }, "Build Seq ", /*#__PURE__*/React.createElement(SortIndicator, {
    column: "sequence"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700"
  }, "Serial #"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100",
    onClick: () => handleSort('building')
  }, "Building ", /*#__PURE__*/React.createElement(SortIndicator, {
    column: "building"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100",
    onClick: () => handleSort('level')
  }, "Level ", /*#__PURE__*/React.createElement(SortIndicator, {
    column: "level"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100",
    onClick: () => handleSort('module')
  }, "Module ", /*#__PURE__*/React.createElement(SortIndicator, {
    column: "module"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700"
  }, "BLM"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700"
  }, "Drawing File"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left font-medium text-gray-700"
  }, "Flags"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y divide-gray-200"
  }, filteredAndSortedModules.map((item, index) => /*#__PURE__*/React.createElement("tr", {
    key: item.module.id || index,
    className: `hover:bg-gray-50 ${!item.hasDrawing ? 'bg-red-50' : ''}`
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, item.hasDrawing ? /*#__PURE__*/React.createElement("span", {
    className: "inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-3 h-3",
    fill: "currentColor",
    viewBox: "0 0 20 20"
  }, /*#__PURE__*/React.createElement("path", {
    fillRule: "evenodd",
    d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",
    clipRule: "evenodd"
  })), "Has Drawing") : /*#__PURE__*/React.createElement("span", {
    className: "inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-3 h-3",
    fill: "currentColor",
    viewBox: "0 0 20 20"
  }, /*#__PURE__*/React.createElement("path", {
    fillRule: "evenodd",
    d: "M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",
    clipRule: "evenodd"
  })), "Missing")), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 font-medium text-gray-900"
  }, "#", item.module.buildSequence || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-700"
  }, item.module.serialNumber || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-700"
  }, "B", item.parsed.building || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-700"
  }, "L", item.parsed.level || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-700"
  }, "M", String(item.parsed.module || '-').padStart(2, '0')), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-gray-700 font-mono text-xs"
  }, item.displayBLM || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, item.drawing ? /*#__PURE__*/React.createElement("button", {
    onClick: () => onNavigateToDrawing?.(item.drawing),
    className: "text-blue-600 hover:text-blue-800 hover:underline text-xs truncate max-w-[200px] block",
    title: item.drawing.name
  }, item.drawing.name) : /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400 text-xs"
  }, "\u2014")), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, item.module.sawbox && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 rounded text-xs bg-amber-100 text-amber-800",
    title: "Sawbox - uses hitch BLM"
  }, "SB"), item.module.sidewall && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 rounded text-xs bg-purple-100 text-purple-800"
  }, "SW"), item.module.stair && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 rounded text-xs bg-blue-100 text-blue-800"
  }, "ST"), item.module.hr3Wall && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 rounded text-xs bg-red-100 text-red-800"
  }, "3HR"))))))), filteredAndSortedModules.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12 text-gray-500"
  }, "No modules match the current filters")), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t border-gray-200 flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, "* Sawboxes defer to hitch side BLM for drawing matching"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition"
  }, "Close"))));
};

// Export to window
window.DrawingStatusLog = DrawingStatusLog;
})();


// ============================================================================
// FILE: SheetBrowser.jsx
// ============================================================================
(function() {
/**
 * MODA - Sheet Browser Component
 * 
 * Advanced filtering and viewing of individual drawing sheets extracted from
 * multi-page PDF packages. Supports filtering by module, unit type, discipline,
 * BLM type, and text search.
 */
// [Removed duplicate React destructuring]
const SheetBrowser = ({
  projectId,
  projectName,
  modules = [],
  onClose,
  auth
}) => {
  // State
  const [sheets, setSheets] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [stats, setStats] = useState(null);

  // Filter state
  const [filters, setFilters] = useState({
    moduleId: null,
    unitType: null,
    roomType: null,
    discipline: null,
    searchText: ''
  });

  // UI state
  const [selectedSheets, setSelectedSheets] = useState(new Set());
  const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
  const [sortBy, setSortBy] = useState('sheet_number'); // 'sheet_number', 'sheet_name', 'discipline'

  // Available filter options
  const [unitTypes, setUnitTypes] = useState([]);
  const [roomTypes, setRoomTypes] = useState([]);

  // Check if sheet module is available
  const isAvailable = () => window.MODA_DRAWING_SHEETS?.searchSheets;

  // Load filter options from project modules
  useEffect(() => {
    if (!modules || modules.length === 0) return;

    // Extract unique unit types from modules
    const units = new Set();
    const rooms = new Set();
    const blms = new Set();
    modules.forEach(mod => {
      // Unit types (S1, A1, C1, B2, etc.)
      if (mod.hitchUnit) units.add(mod.hitchUnit);
      if (mod.rearUnit) units.add(mod.rearUnit);

      // Room types (LIV/KIT, BED/BA, etc.)
      if (mod.hitchRoomType) rooms.add(mod.hitchRoomType);
      if (mod.rearRoomType) rooms.add(mod.rearRoomType);
    });
    setUnitTypes(Array.from(units).sort());
    setRoomTypes(Array.from(rooms).sort());
  }, [modules]);

  // Load sheets and stats
  useEffect(() => {
    if (!projectId || !isAvailable()) return;
    loadSheets();
    loadStats();
  }, [projectId, filters]);
  const loadSheets = async () => {
    setIsLoading(true);
    setError(null);
    try {
      let results = [];
      if (window.MODA_DRAWING_SHEETS?.searchSheets) {
        // Use drawing sheets module if available
        results = await window.MODA_DRAWING_SHEETS.searchSheets({
          projectId,
          ...filters
        });
      } else if (window.MODA_SUPABASE?.client) {
        // Fallback: Query database directly
        console.log('[SheetBrowser] Using direct database query');
        let query = window.MODA_SUPABASE.client.from('drawing_sheets').select('*, drawing_files(name), modules(serial_number)').eq('project_id', projectId);

        // Apply filters
        if (filters.moduleId) {
          query = query.eq('linked_module_id', filters.moduleId);
        }
        if (filters.discipline) {
          query = query.eq('discipline', filters.discipline);
        }
        if (filters.searchText) {
          query = query.or(`sheet_name.ilike.%${filters.searchText}%,sheet_title.ilike.%${filters.searchText}%`);
        }
        const {
          data,
          error
        } = await query.order('sheet_name');
        if (error) throw error;

        // Transform data to match expected format
        results = (data || []).map(sheet => ({
          ...sheet,
          sheet_id: sheet.id,
          drawing_file_name: sheet.drawing_files?.name,
          module_identifier: sheet.modules?.serial_number
        }));
      }
      setSheets(results || []);
    } catch (err) {
      console.error('[SheetBrowser] Error loading sheets:', err);
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  };
  const loadStats = async () => {
    try {
      let projectStats = null;
      if (window.MODA_DRAWING_SHEETS?.getProjectSheetStats) {
        projectStats = await window.MODA_DRAWING_SHEETS.getProjectSheetStats(projectId);
      } else if (window.MODA_SUPABASE?.client) {
        // Fallback: Calculate stats from direct query
        const {
          data,
          error
        } = await window.MODA_SUPABASE.client.from('drawing_sheets').select('discipline, linked_module_id').eq('project_id', projectId);
        if (!error && data) {
          const disciplines = new Set(data.map(s => s.discipline).filter(Boolean));
          const linkedCount = data.filter(s => s.linked_module_id).length;
          projectStats = {
            total_sheets: data.length,
            total_disciplines: disciplines.size,
            linked_sheets: linkedCount,
            unlinked_sheets: data.length - linkedCount
          };
        }
      }
      setStats(projectStats);
    } catch (err) {
      console.error('[SheetBrowser] Error loading stats:', err);
    }
  };

  // Get unique disciplines from sheets
  const disciplines = useMemo(() => {
    const unique = new Set();
    sheets.forEach(s => s.discipline && unique.add(s.discipline));
    return Array.from(unique).sort();
  }, [sheets]);

  // Sorted and filtered sheets
  const sortedSheets = useMemo(() => {
    const sorted = [...sheets];
    switch (sortBy) {
      case 'sheet_name':
        sorted.sort((a, b) => (a.sheet_name || '').localeCompare(b.sheet_name || ''));
        break;
      case 'discipline':
        sorted.sort((a, b) => (a.discipline || '').localeCompare(b.discipline || ''));
        break;
      case 'sheet_number':
      default:
        sorted.sort((a, b) => {
          if (a.drawing_file_name !== b.drawing_file_name) {
            return a.drawing_file_name.localeCompare(b.drawing_file_name);
          }
          return a.sheet_number - b.sheet_number;
        });
    }
    return sorted;
  }, [sheets, sortBy]);

  // Handlers
  const handleFilterChange = (key, value) => {
    setFilters(prev => ({
      ...prev,
      [key]: value
    }));
    setSelectedSheets(new Set()); // Clear selection on filter change
  };
  const handleToggleSheet = sheetId => {
    setSelectedSheets(prev => {
      const next = new Set(prev);
      if (next.has(sheetId)) {
        next.delete(sheetId);
      } else {
        next.add(sheetId);
      }
      return next;
    });
  };
  const handleSelectAll = () => {
    if (selectedSheets.size === sortedSheets.length) {
      setSelectedSheets(new Set());
    } else {
      setSelectedSheets(new Set(sortedSheets.map(s => s.sheet_id)));
    }
  };
  const handleViewSheet = async sheet => {
    const url = window.MODA_DRAWING_SHEETS.getSheetUrl(sheet.storage_path);
    if (url) {
      window.open(url, '_blank');
    }
  };
  const handleDownloadSheet = async sheet => {
    try {
      await window.MODA_DRAWING_SHEETS.downloadSheet(sheet);
    } catch (err) {
      console.error('[SheetBrowser] Error downloading sheet:', err);
      alert('Failed to download sheet: ' + err.message);
    }
  };
  const handleDownloadSelected = async () => {
    const selectedSheetObjects = sortedSheets.filter(s => selectedSheets.has(s.sheet_id));
    if (selectedSheetObjects.length === 0) {
      alert('No sheets selected');
      return;
    }
    try {
      await window.MODA_DRAWING_SHEETS.downloadSheetsAsZip(selectedSheetObjects, `${projectName}_sheets.zip`);
    } catch (err) {
      console.error('[SheetBrowser] Error downloading sheets:', err);
      alert('Failed to download sheets: ' + err.message);
    }
  };
  const handleClearFilters = () => {
    setFilters({
      moduleId: null,
      unitType: null,
      roomType: null,
      discipline: null,
      blmType: null,
      searchText: ''
    });
  };

  // Render helpers
  const renderFilters = () => /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-medium text-gray-900"
  }, "Filters"), /*#__PURE__*/React.createElement("button", {
    onClick: handleClearFilters,
    className: "text-sm text-blue-600 hover:text-blue-800"
  }, "Clear All")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Module"), /*#__PURE__*/React.createElement("select", {
    value: filters.moduleId || '',
    onChange: e => handleFilterChange('moduleId', e.target.value || null),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Modules"), modules.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.moduleId || m.module_id)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Unit Type"), /*#__PURE__*/React.createElement("select", {
    value: filters.unitType || '',
    onChange: e => handleFilterChange('unitType', e.target.value || null),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Types"), unitTypes.map(ut => /*#__PURE__*/React.createElement("option", {
    key: ut,
    value: ut
  }, ut)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Room Type"), /*#__PURE__*/React.createElement("select", {
    value: filters.roomType || '',
    onChange: e => handleFilterChange('roomType', e.target.value || null),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Room Types"), roomTypes.map(rt => /*#__PURE__*/React.createElement("option", {
    key: rt,
    value: rt
  }, rt)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Discipline"), /*#__PURE__*/React.createElement("select", {
    value: filters.discipline || '',
    onChange: e => handleFilterChange('discipline', e.target.value || null),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Disciplines"), Object.values(window.MODA_DRAWING_SHEETS?.DISCIPLINES || {}).map(d => /*#__PURE__*/React.createElement("option", {
    key: d,
    value: d
  }, d)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Search"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: filters.searchText,
    onChange: e => handleFilterChange('searchText', e.target.value),
    placeholder: "Sheet name or title...",
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }))));
  const renderStats = () => {
    if (!stats) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border border-gray-200 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold text-gray-900"
    }, stats.total_sheets), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-500"
    }, "Total Sheets")), /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border border-gray-200 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold text-green-600"
    }, stats.linked_modules), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-500"
    }, "Linked to Modules")), /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border border-gray-200 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold text-amber-600"
    }, stats.unlinked_sheets), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-500"
    }, "Unlinked")), /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border border-gray-200 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold text-blue-600"
    }, Object.keys(stats.by_discipline).length), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-500"
    }, "Disciplines")));
  };
  const renderToolbar = () => /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, sortedSheets.length, " sheet", sortedSheets.length !== 1 ? 's' : '', selectedSheets.size > 0 && ` (${selectedSheets.size} selected)`), selectedSheets.size > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: handleDownloadSelected,
    className: "px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-download w-4 h-4"
  }), "Download Selected")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("select", {
    value: sortBy,
    onChange: e => setSortBy(e.target.value),
    className: "px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: "sheet_number"
  }, "Sort by Sheet Number"), /*#__PURE__*/React.createElement("option", {
    value: "sheet_name"
  }, "Sort by Sheet Name"), /*#__PURE__*/React.createElement("option", {
    value: "discipline"
  }, "Sort by Discipline")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1 bg-gray-100 rounded-lg p-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setViewMode('grid'),
    className: `px-3 py-1.5 rounded text-sm transition ${viewMode === 'grid' ? 'bg-white shadow text-gray-900' : 'text-gray-600 hover:text-gray-900'}`
  }, "Grid"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setViewMode('list'),
    className: `px-3 py-1.5 rounded text-sm transition ${viewMode === 'list' ? 'bg-white shadow text-gray-900' : 'text-gray-600 hover:text-gray-900'}`
  }, "List"))));
  const renderSheetCard = sheet => /*#__PURE__*/React.createElement("div", {
    key: sheet.sheet_id,
    className: `bg-white rounded-lg border-2 p-4 transition cursor-pointer ${selectedSheets.has(sheet.sheet_id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`,
    onClick: () => handleToggleSheet(sheet.sheet_id)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between mb-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-1"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedSheets.has(sheet.sheet_id),
    onChange: () => handleToggleSheet(sheet.sheet_id),
    onClick: e => e.stopPropagation(),
    className: "w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
  }), /*#__PURE__*/React.createElement("h4", {
    className: "font-medium text-gray-900 truncate"
  }, sheet.sheet_name || `Sheet ${sheet.sheet_number}`)), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 line-clamp-2"
  }, sheet.sheet_title || 'No title'))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 mb-3"
  }, sheet.discipline && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Discipline:"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 bg-blue-100 text-blue-800 rounded"
  }, sheet.discipline)), sheet.module_identifier && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Module:"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 bg-purple-100 text-purple-800 rounded"
  }, sheet.module_identifier)), sheet.ocr_confidence && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "OCR Confidence:"), /*#__PURE__*/React.createElement("span", {
    className: window.MODA_DRAWING_SHEETS?.getConfidenceColor(sheet.ocr_confidence)
  }, window.MODA_DRAWING_SHEETS?.formatConfidence(sheet.ocr_confidence)))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 pt-3 border-t border-gray-200"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      handleViewSheet(sheet);
    },
    className: "flex-1 px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-eye w-4 h-4"
  }), "View"), /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      handleDownloadSheet(sheet);
    },
    className: "flex-1 px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-download w-4 h-4"
  }), "Download")));
  const renderSheetList = sheet => /*#__PURE__*/React.createElement("tr", {
    key: sheet.sheet_id,
    className: `hover:bg-gray-50 cursor-pointer ${selectedSheets.has(sheet.sheet_id) ? 'bg-blue-50' : ''}`,
    onClick: () => handleToggleSheet(sheet.sheet_id)
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedSheets.has(sheet.sheet_id),
    onChange: () => handleToggleSheet(sheet.sheet_id),
    onClick: e => e.stopPropagation(),
    className: "w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
  })), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, sheet.sheet_name || `Sheet ${sheet.sheet_number}`), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, sheet.drawing_file_name)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600"
  }, sheet.sheet_title || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3"
  }, sheet.discipline && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded"
  }, sheet.discipline)), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-sm text-gray-600"
  }, sheet.module_identifier || '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-4 py-3 text-right"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-end gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      handleViewSheet(sheet);
    },
    className: "p-2 text-purple-600 hover:bg-purple-50 rounded transition",
    title: "View"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-eye w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      handleDownloadSheet(sheet);
    },
    className: "p-2 text-green-600 hover:bg-green-50 rounded transition",
    title: "Download"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-download w-4 h-4"
  })))));

  // Main render
  if (!isAvailable()) {
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl p-8 max-w-md"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold text-gray-900 mb-4"
    }, "Sheet Browser Unavailable"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-6"
    }, "The sheet browser module is not available. Please ensure the drawing sheets module is loaded."), /*#__PURE__*/React.createElement("button", {
      onClick: onClose,
      className: "w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
    }, "Close")));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-6 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-gray-900"
  }, "Sheet Browser"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mt-1"
  }, projectName)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition",
    title: "Close"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-6 h-6",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M6 18L18 6M6 6l12 12"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto p-6"
  }, renderStats(), renderFilters(), renderToolbar(), isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center py-12"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"
  })) : error ? /*#__PURE__*/React.createElement("div", {
    className: "bg-red-50 border border-red-200 rounded-lg p-4 text-red-800"
  }, "Error loading sheets: ", error) : sortedSheets.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "No sheets found matching your filters.")) : viewMode === 'grid' ? /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
  }, sortedSheets.map(renderSheetCard)) : /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border border-gray-200 overflow-hidden"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedSheets.size === sortedSheets.length && sortedSheets.length > 0,
    onChange: handleSelectAll,
    className: "w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
  })), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Sheet Name"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Title"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Discipline"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Module"), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase"
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y divide-gray-200"
  }, sortedSheets.map(renderSheetList)))))));
};
window.SheetBrowser = SheetBrowser;
})();


// ============================================================================
// FILE: AnalysisBrowser.jsx
// ============================================================================
(function() {
/**
 * MODA - Analysis Browser Component
 * 
 * Unified browser for AI-extracted drawing analysis data:
 * - Walls: Wall IDs, types, dimensions
 * - Fixtures: MEP fixture counts by category
 * - Changes: Version change tracking
 */
// [Removed duplicate React destructuring]
const AnalysisBrowser = ({
  projectId,
  projectName,
  analysisType,
  // 'walls' | 'fixtures' | 'changes'
  onClose,
  auth
}) => {
  // State
  const [data, setData] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchText, setSearchText] = useState('');
  const [filterCategory, setFilterCategory] = useState(null);

  // Tab configuration
  const TABS = {
    walls: {
      title: 'Wall Schedule',
      icon: 'icon-box',
      color: 'green',
      table: 'sheet_walls',
      columns: ['wall_id', 'wall_type', 'wall_height', 'stud_spacing', 'stud_gauge', 'grid_location'],
      groupBy: 'wall_type'
    },
    fixtures: {
      title: 'MEP Fixtures',
      icon: 'icon-zap',
      color: 'yellow',
      table: 'sheet_mep_fixtures',
      columns: ['fixture_tag', 'fixture_type', 'fixture_category', 'quantity', 'description', 'room_name'],
      groupBy: 'fixture_category'
    },
    changes: {
      title: 'Version Changes',
      icon: 'icon-git-compare',
      color: 'red',
      table: 'drawing_version_changes',
      columns: ['change_type', 'change_category', 'change_severity', 'sheet_name', 'description', 'detected_at'],
      groupBy: 'change_severity'
    }
  };
  const config = TABS[analysisType] || TABS.walls;

  // Load data
  useEffect(() => {
    if (!projectId || !window.MODA_SUPABASE?.client) return;
    loadData();
  }, [projectId, analysisType]);
  const loadData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const {
        data: results,
        error: queryError
      } = await window.MODA_SUPABASE.client.from(config.table).select('*').eq('project_id', projectId).order('created_at', {
        ascending: false
      });
      if (queryError) throw queryError;
      setData(results || []);
    } catch (err) {
      console.error('[AnalysisBrowser] Error loading data:', err);
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Get unique categories for filter
  const categories = useMemo(() => {
    const groupField = config.groupBy;
    const unique = new Set(data.map(item => item[groupField]).filter(Boolean));
    return Array.from(unique).sort();
  }, [data, config.groupBy]);

  // Filter data
  const filteredData = useMemo(() => {
    let result = data;
    if (filterCategory) {
      result = result.filter(item => item[config.groupBy] === filterCategory);
    }
    if (searchText) {
      const search = searchText.toLowerCase();
      result = result.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(search)));
    }
    return result;
  }, [data, filterCategory, searchText, config.groupBy]);

  // Summary stats
  const stats = useMemo(() => {
    const grouped = {};
    data.forEach(item => {
      const key = item[config.groupBy] || 'Unknown';
      grouped[key] = (grouped[key] || 0) + 1;
    });
    return grouped;
  }, [data, config.groupBy]);

  // Severity color helper
  const getSeverityColor = severity => {
    switch (severity?.toLowerCase()) {
      case 'critical':
        return 'bg-red-100 text-red-800';
      case 'major':
        return 'bg-orange-100 text-orange-800';
      case 'moderate':
        return 'bg-yellow-100 text-yellow-800';
      case 'minor':
        return 'bg-green-100 text-green-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  // Category color helper
  const getCategoryColor = category => {
    switch (category?.toLowerCase()) {
      case 'electrical':
        return 'bg-yellow-100 text-yellow-800';
      case 'plumbing':
        return 'bg-blue-100 text-blue-800';
      case 'mechanical':
        return 'bg-purple-100 text-purple-800';
      case 'fire':
      case 'fire protection':
        return 'bg-red-100 text-red-800';
      case 'structural':
        return 'bg-gray-100 text-gray-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: `px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-${config.color}-50`
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: `${config.icon} w-6 h-6 text-${config.color}-600`
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, config.title), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, projectName, " \u2022 ", data.length, " items"))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-200 rounded-lg transition"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-x w-5 h-5"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-100 bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setFilterCategory(null),
    className: `px-3 py-1.5 rounded-full text-sm font-medium transition ${!filterCategory ? 'bg-gray-800 text-white' : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'}`
  }, "All (", data.length, ")"), Object.entries(stats).map(([category, count]) => /*#__PURE__*/React.createElement("button", {
    key: category,
    onClick: () => setFilterCategory(filterCategory === category ? null : category),
    className: `px-3 py-1.5 rounded-full text-sm font-medium transition ${filterCategory === category ? 'bg-gray-800 text-white' : analysisType === 'changes' ? getSeverityColor(category) : analysisType === 'fixtures' ? getCategoryColor(category) : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'}`
  }, category, " (", count, ")")))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-3 border-b border-gray-100"
  }, /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-search w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: searchText,
    onChange: e => setSearchText(e.target.value),
    placeholder: "Search...",
    className: "w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-auto p-6"
  }, isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center py-12"
  }, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
  }), /*#__PURE__*/React.createElement("span", {
    className: "ml-3 text-gray-600"
  }, "Loading...")) : error ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-alert-circle w-12 h-12 text-red-400 mx-auto mb-4"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-red-600"
  }, error)) : filteredData.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12"
  }, /*#__PURE__*/React.createElement("span", {
    className: `${config.icon} w-12 h-12 text-gray-300 mx-auto mb-4`
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "No ", analysisType, " data found"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-400 mt-2"
  }, "Run AI Analysis on drawings to extract ", analysisType)) : /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "bg-gray-50"
  }, config.columns.map(col => /*#__PURE__*/React.createElement("th", {
    key: col,
    className: "px-4 py-3 text-left font-semibold text-gray-700 border-b"
  }, col.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()))))), /*#__PURE__*/React.createElement("tbody", null, filteredData.map((item, idx) => /*#__PURE__*/React.createElement("tr", {
    key: item.id || idx,
    className: "border-b border-gray-100 hover:bg-gray-50"
  }, config.columns.map(col => /*#__PURE__*/React.createElement("td", {
    key: col,
    className: "px-4 py-3"
  }, col === 'change_severity' ? /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-1 rounded-full text-xs font-medium ${getSeverityColor(item[col])}`
  }, item[col]) : col === 'fixture_category' ? /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-1 rounded-full text-xs font-medium ${getCategoryColor(item[col])}`
  }, item[col]) : col === 'detected_at' || col === 'created_at' ? /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, item[col] ? new Date(item[col]).toLocaleDateString() : '-') : item[col] || '-')))))))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Showing ", filteredData.length, " of ", data.length, " items"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
  }, "Close"))));
};

// Export for use
window.AnalysisBrowser = AnalysisBrowser;
})();


// ============================================================================
// FILE: OCRProgressIndicator.jsx
// ============================================================================
(function() {
/**
 * MODA OCR Progress Indicator
 * 
 * Floating indicator in bottom-right corner that shows OCR progress.
 * Persists across navigation, supports multiple jobs, cancel capability.
 */
// [Removed duplicate React destructuring]
const OCRProgressIndicator = () => {
  const [state, setState] = useState(null);
  const [isExpanded, setIsExpanded] = useState(false);
  const [completedJobs, setCompletedJobs] = useState([]);

  // Subscribe to OCR manager state
  useEffect(() => {
    if (!window.MODA_OCR_MANAGER) {
      console.warn('[OCRProgressIndicator] OCR Manager not available');
      return;
    }
    const unsubscribe = window.MODA_OCR_MANAGER.subscribe(newState => {
      setState(newState);
    });

    // Listen for job completions
    const handleJobComplete = event => {
      const job = event.detail;
      setCompletedJobs(prev => [...prev, job]);

      // Auto-clear completed jobs after 10 seconds
      setTimeout(() => {
        setCompletedJobs(prev => prev.filter(j => j.id !== job.id));
      }, 10000);
    };
    window.addEventListener('ocr-job-complete', handleJobComplete);
    return () => {
      unsubscribe();
      window.removeEventListener('ocr-job-complete', handleJobComplete);
    };
  }, []);

  // Handle cancel
  const handleCancel = useCallback(jobId => {
    if (window.MODA_OCR_MANAGER) {
      window.MODA_OCR_MANAGER.cancelJob(jobId);
    }
  }, []);

  // Handle cancel all
  const handleCancelAll = useCallback(() => {
    if (window.MODA_OCR_MANAGER && confirm('Cancel all OCR jobs?')) {
      window.MODA_OCR_MANAGER.cancelAll();
    }
  }, []);

  // Don't render if no jobs
  if (!state || !state.isProcessing && state.jobCount === 0 && completedJobs.length === 0) {
    return null;
  }
  const {
    currentJob,
    queuedJobs,
    totalFiles,
    completedFiles,
    errorFiles
  } = state;
  const progressPercent = totalFiles > 0 ? Math.round(completedFiles / totalFiles * 100) : 0;
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed bottom-4 right-4 z-50"
  }, !isExpanded && /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsExpanded(true),
    className: "flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-full shadow-lg hover:bg-purple-700 transition-all"
  }, state.isProcessing ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, "OCR: ", completedFiles, "/", totalFiles), errorFiles > 0 && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 bg-red-500 text-xs rounded-full"
  }, errorFiles, " \u26A0")) : completedJobs.length > 0 ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "icon-check w-4 h-4"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, "OCR Complete")) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "icon-clock w-4 h-4"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, queuedJobs.length, " queued"))), isExpanded && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl border border-gray-200 w-80 overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-3 bg-purple-600 text-white flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-cpu w-5 h-5"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, "OCR Processing")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, state.isProcessing && /*#__PURE__*/React.createElement("button", {
    onClick: handleCancelAll,
    className: "p-1 hover:bg-purple-500 rounded",
    title: "Cancel all"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-x w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsExpanded(false),
    className: "p-1 hover:bg-purple-500 rounded"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-chevron-down w-4 h-4"
  })))), state.isProcessing && /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-2 bg-gray-50 border-b"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-xs text-gray-600 mb-1"
  }, /*#__PURE__*/React.createElement("span", null, "Overall Progress"), /*#__PURE__*/React.createElement("span", null, completedFiles, "/", totalFiles, " files (", progressPercent, "%)")), /*#__PURE__*/React.createElement("div", {
    className: "h-2 bg-gray-200 rounded-full overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "h-full bg-purple-600 transition-all duration-300",
    style: {
      width: `${progressPercent}%`
    }
  }))), currentJob && /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-3 border-b"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-medium text-gray-900"
  }, currentJob.projectName), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleCancel(currentJob.id),
    className: "text-xs text-red-600 hover:text-red-800"
  }, "Cancel")), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600 mb-1"
  }, currentJob.stage), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 truncate",
    title: currentJob.currentFile
  }, currentJob.currentFile), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mt-2 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-green-600"
  }, "\u2713 ", currentJob.completedCount), currentJob.errors.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-red-600"
  }, "\u26A0 ", currentJob.errors.length), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "/ ", currentJob.totalFiles))), queuedJobs.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-2 bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs font-medium text-gray-500 mb-2"
  }, "QUEUED (", queuedJobs.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1 max-h-32 overflow-y-auto"
  }, queuedJobs.map(job => /*#__PURE__*/React.createElement("div", {
    key: job.id,
    className: "flex items-center justify-between text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-700 truncate flex-1"
  }, job.projectName), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500 ml-2"
  }, job.totalFiles, " files"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleCancel(job.id),
    className: "ml-2 text-red-500 hover:text-red-700"
  }, "\u2715"))))), completedJobs.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-3 bg-green-50 border-t"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs font-medium text-green-700 mb-2"
  }, "RECENTLY COMPLETED"), completedJobs.map(job => /*#__PURE__*/React.createElement("div", {
    key: job.id,
    className: "text-xs mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, job.projectName), /*#__PURE__*/React.createElement("span", {
    className: "text-green-600"
  }, "\u2713 ", job.completedCount, "/", job.totalFiles)), job.errors.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-1 text-red-600"
  }, job.errors.length, " error(s):", /*#__PURE__*/React.createElement("ul", {
    className: "ml-2"
  }, job.errors.slice(0, 3).map((err, i) => /*#__PURE__*/React.createElement("li", {
    key: i,
    className: "truncate",
    title: err.error
  }, "\u2022 ", err.fileName, ": ", err.error)), job.errors.length > 3 && /*#__PURE__*/React.createElement("li", null, "... and ", job.errors.length - 3, " more")))))), !state.isProcessing && queuedJobs.length === 0 && completedJobs.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-6 text-center text-gray-500 text-sm"
  }, "No active OCR jobs")));
};

// Export for use
window.OCRProgressIndicator = OCRProgressIndicator;
})();


// ============================================================================
// FILE: ModuleDrawingsViewer.jsx
// ============================================================================
(function() {
/**
 * MODA - Module Drawings Viewer Component
 * 
 * Displays shop drawing packages for a specific module.
 * Accessed via QR code scan: /drawings/module/{serialNumber}
 */
// [Removed duplicate React destructuring]
const ModuleDrawingsViewer = ({
  serialNumber,
  onClose,
  auth
}) => {
  // State
  const [moduleInfo, setModuleInfo] = useState(null);
  const [drawings, setDrawings] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [hasDrawings, setHasDrawings] = useState(false);

  // Check if module drawings API is available
  const isAvailable = () => window.MODA_MODULE_DRAWINGS?.isAvailable?.();

  // Load module info and drawings
  useEffect(() => {
    const loadData = async () => {
      if (!serialNumber) {
        setError('No serial number provided');
        setIsLoading(false);
        return;
      }
      if (!isAvailable()) {
        setError('Module drawings system not available');
        setIsLoading(false);
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        // Load module info
        const info = await window.MODA_MODULE_DRAWINGS.getModuleInfo(serialNumber);
        if (!info) {
          setError(`Module "${serialNumber}" not found`);
          setIsLoading(false);
          return;
        }
        setModuleInfo(info);

        // Check if module has drawings
        const hasDraws = await window.MODA_MODULE_DRAWINGS.hasDrawings(serialNumber);
        setHasDrawings(hasDraws);
        if (!hasDraws) {
          setIsLoading(false);
          return;
        }

        // Load drawings
        const drawingsList = await window.MODA_MODULE_DRAWINGS.getBySerialNumber(serialNumber);
        setDrawings(drawingsList);
      } catch (err) {
        console.error('[ModuleDrawingsViewer] Error loading data:', err);
        setError(err.message || 'Failed to load module drawings');
      } finally {
        setIsLoading(false);
      }
    };
    loadData();
  }, [serialNumber]);

  // Handle view drawing
  const handleView = async version => {
    try {
      const url = await window.MODA_MODULE_DRAWINGS.getViewUrl(version.storage_path, version.sharepoint_file_id);
      if (url) {
        window.open(url, '_blank');
      }
    } catch (err) {
      console.error('[ModuleDrawingsViewer] Error viewing drawing:', err);
      alert('Failed to open drawing: ' + err.message);
    }
  };

  // Handle download drawing
  const handleDownload = async version => {
    try {
      const url = await window.MODA_MODULE_DRAWINGS.getDownloadUrl(version.storage_path, version.sharepoint_file_id);
      if (url) {
        window.open(url, '_blank');
      }
    } catch (err) {
      console.error('[ModuleDrawingsViewer] Error downloading drawing:', err);
      alert('Failed to download drawing: ' + err.message);
    }
  };

  // Get latest version for a drawing
  const getLatestVersion = drawing => {
    return window.MODA_MODULE_DRAWINGS.utils.getLatestVersion(drawing.versions);
  };

  // Format file size
  const formatFileSize = bytes => {
    return window.MODA_MODULE_DRAWINGS.utils.formatFileSize(bytes);
  };

  // Format date
  const formatDate = dateString => {
    return window.MODA_MODULE_DRAWINGS.utils.formatDate(dateString);
  };

  // Render loading state
  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl p-8 max-w-md"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex flex-col items-center gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600"
    }, "Loading module drawings..."))));
  }

  // Render error state
  if (error) {
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl p-8 max-w-md"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-4 mb-6"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-alert-circle w-8 h-8 text-red-600 flex-shrink-0"
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold text-gray-900 mb-2"
    }, "Error"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600"
    }, error))), /*#__PURE__*/React.createElement("button", {
      onClick: onClose,
      className: "w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
    }, "Close")));
  }

  // Render no drawings state
  if (!hasDrawings) {
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-xl shadow-2xl p-8 max-w-md"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-center"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-file w-16 h-16 mx-auto mb-4 text-gray-300",
      style: {
        display: 'block'
      }
    }), /*#__PURE__*/React.createElement("h2", {
      className: "text-xl font-bold text-gray-900 mb-2"
    }, "No Shop Drawings Found"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-4"
    }, "No shop drawing package exists for module ", /*#__PURE__*/React.createElement("strong", null, serialNumber), "."), moduleInfo && /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-50 rounded-lg p-4 mb-6 text-left"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-900 mb-2"
    }, "Module Information"), /*#__PURE__*/React.createElement("div", {
      className: "space-y-1 text-sm text-gray-600"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Serial:"), " ", moduleInfo.serial_number), moduleInfo.blm_id && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "BLM:"), " ", moduleInfo.blm_id), (moduleInfo.hitch_blm || moduleInfo.rear_blm) && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Units:"), " ", moduleInfo.hitch_blm || '-', " / ", moduleInfo.rear_blm || '-'), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Project:"), " ", moduleInfo.project_name))), /*#__PURE__*/React.createElement("button", {
      onClick: onClose,
      className: "w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
    }, "Close"))));
  }

  // Render drawings list
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-6 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-gray-900"
  }, "Shop Drawing Package"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mt-1"
  }, "Module ", serialNumber, moduleInfo?.blm_id && ` - ${moduleInfo.blm_id}`)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-x w-6 h-6"
  }))), moduleInfo && /*#__PURE__*/React.createElement("div", {
    className: "p-6 bg-gray-50 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 uppercase tracking-wide mb-1"
  }, "Serial Number"), /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, moduleInfo.serial_number)), moduleInfo.blm_id && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 uppercase tracking-wide mb-1"
  }, "BLM ID"), /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, moduleInfo.blm_id)), (moduleInfo.hitch_blm || moduleInfo.rear_blm) && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 uppercase tracking-wide mb-1"
  }, "Units"), /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, moduleInfo.hitch_blm || '-', " / ", moduleInfo.rear_blm || '-')), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 uppercase tracking-wide mb-1"
  }, "Project"), /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, moduleInfo.project_name)))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-gray-900"
  }, "Drawings (", drawings.length, ")")), drawings.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12 text-gray-500"
  }, "No drawings found") : /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, drawings.map(drawing => {
    const latestVersion = getLatestVersion(drawing);
    return /*#__PURE__*/React.createElement("div", {
      key: drawing.id,
      className: "bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3 mb-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-file w-5 h-5 text-gray-400 flex-shrink-0"
    }), /*#__PURE__*/React.createElement("h4", {
      className: "font-medium text-gray-900 truncate"
    }, drawing.name), latestVersion && /*#__PURE__*/React.createElement("span", {
      className: "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
    }, "v", latestVersion.version)), drawing.description && /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-600 mb-2"
    }, drawing.description), latestVersion && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-4 text-xs text-gray-500"
    }, /*#__PURE__*/React.createElement("span", null, formatFileSize(latestVersion.file_size)), /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, "Updated ", formatDate(latestVersion.uploaded_at)), latestVersion.uploaded_by && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, "by ", latestVersion.uploaded_by)))), latestVersion && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 flex-shrink-0"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleView(latestVersion),
      className: "px-3 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition flex items-center gap-2",
      title: "View in Browser"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-eye w-4 h-4"
    }), "View"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDownload(latestVersion),
      className: "px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition flex items-center gap-2",
      title: "Download"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-download w-4 h-4"
    }), "Download"))), drawing.versions.length > 1 && /*#__PURE__*/React.createElement("div", {
      className: "mt-3 pt-3 border-t border-gray-100"
    }, /*#__PURE__*/React.createElement("details", {
      className: "text-sm"
    }, /*#__PURE__*/React.createElement("summary", {
      className: "cursor-pointer text-gray-600 hover:text-gray-900 font-medium"
    }, drawing.versions.length, " version", drawing.versions.length !== 1 ? 's' : ''), /*#__PURE__*/React.createElement("div", {
      className: "mt-2 space-y-2"
    }, drawing.versions.map(version => /*#__PURE__*/React.createElement("div", {
      key: version.id,
      className: "flex items-center justify-between py-2 px-3 bg-gray-50 rounded"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-medium text-gray-900"
    }, "Version ", version.version), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, formatDate(version.uploaded_at), version.notes && ` - ${version.notes}`)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleView(version),
      className: "p-1.5 text-purple-600 hover:bg-purple-50 rounded transition",
      title: "View"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-eye w-4 h-4"
    })), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleDownload(version),
      className: "p-1.5 text-green-600 hover:bg-green-50 rounded transition",
      title: "Download"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-download w-4 h-4"
    })))))))));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "p-6 border-t border-gray-200 bg-gray-50"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
  }, "Close"))));
};
})();


// ============================================================================
// FILE: ModuleMenuPage.jsx
// ============================================================================
(function() {
/**
 * Module Menu Landing Page
 * 
 * Displays when a QR code is scanned from a license plate.
 * Shows navigation options for:
 * - QA (placeholder)
 * - Shop Drawing Package (Module Packages folder for that BLM)
 * - Permit Drawings
 * - Shop Drawings - Other
 */
// [Removed duplicate React destructuring]
function ModuleMenuPage() {
  const [projectId, setProjectId] = useState(null);
  const [blm, setBlm] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  useEffect(() => {
    // Parse URL parameters: /module/{projectId}/{blm}
    const path = window.location.pathname;
    const match = path.match(/\/module\/([^\/]+)\/([^\/]+)/);
    if (match) {
      setProjectId(match[1]);
      setBlm(match[2]);
      setLoading(false);
    } else {
      setError('Invalid module URL');
      setLoading(false);
    }
  }, []);
  const handleNavigation = option => {
    switch (option) {
      case 'qa':
        alert('QA Module - Coming Soon!\n\nThis will link to quality assurance documentation and checklists for this module.');
        break;
      case 'shop-drawing-package':
        // Navigate to Drawings Module filtered to Module Packages for this BLM
        window.location.hash = 'drawings';
        sessionStorage.setItem('moda_drawings_category', 'shop-drawings');
        sessionStorage.setItem('moda_drawings_discipline', 'Module Packages');
        sessionStorage.setItem('moda_drawings_search', blm);
        window.location.reload();
        break;
      case 'permit-drawings':
        // Navigate to Permit Drawings
        window.location.hash = 'drawings';
        sessionStorage.setItem('moda_drawings_category', 'permit-drawings');
        sessionStorage.setItem('moda_drawings_discipline', '');
        sessionStorage.setItem('moda_drawings_search', '');
        window.location.reload();
        break;
      case 'shop-drawings-other':
        // Navigate to Shop Drawings main folder
        window.location.hash = 'drawings';
        sessionStorage.setItem('moda_drawings_category', 'shop-drawings');
        sessionStorage.setItem('moda_drawings_discipline', '');
        sessionStorage.setItem('moda_drawings_search', '');
        window.location.reload();
        break;
      default:
        break;
    }
  };
  if (loading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "min-h-screen bg-gray-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin rounded-full h-12 w-12 border-b-2 border-autovol-navy mx-auto mb-4"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600"
    }, "Loading module information...")));
  }
  if (error) {
    return /*#__PURE__*/React.createElement("div", {
      className: "min-h-screen bg-gray-100 flex items-center justify-center p-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow-lg p-8 max-w-md text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-red-500 text-5xl mb-4"
    }, "\u26A0\uFE0F"), /*#__PURE__*/React.createElement("h1", {
      className: "text-2xl font-bold text-gray-900 mb-2"
    }, "Error"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600 mb-4"
    }, error), /*#__PURE__*/React.createElement("button", {
      onClick: () => window.location.href = '/',
      className: "px-6 py-2 bg-autovol-navy text-white rounded-lg hover:bg-autovol-navy-light"
    }, "Go to Dashboard")));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen bg-gray-100 flex items-center justify-center p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-2xl w-full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-navy text-white p-6 rounded-t-lg"
  }, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold mb-2"
  }, "Module Information"), /*#__PURE__*/React.createElement("p", {
    className: "text-blue-200"
  }, "BLM: ", blm)), /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-6 text-center"
  }, "Select an option to view module documentation and drawings:"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleNavigation('qa'),
    className: "w-full p-4 bg-gray-100 hover:bg-gray-200 rounded-lg text-left transition-colors border-2 border-gray-300 hover:border-gray-400"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCCB"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-gray-900"
  }, "QA (Placeholder)"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Quality assurance documentation")), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "\u2192"))), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleNavigation('shop-drawing-package'),
    className: "w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-left transition-colors border-2 border-emerald-400 hover:border-emerald-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCE6"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-gray-900"
  }, "Shop Drawing Package"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Module-specific shop drawings for ", blm)), /*#__PURE__*/React.createElement("span", {
    className: "text-emerald-600"
  }, "\u2192"))), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleNavigation('permit-drawings'),
    className: "w-full p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-left transition-colors border-2 border-blue-400 hover:border-blue-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCC4"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-gray-900"
  }, "Permit Drawings"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Official permit and approval drawings")), /*#__PURE__*/React.createElement("span", {
    className: "text-blue-600"
  }, "\u2192"))), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleNavigation('shop-drawings-other'),
    className: "w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-left transition-colors border-2 border-purple-400 hover:border-purple-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-2xl"
  }, "\uD83D\uDCC1"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-bold text-gray-900"
  }, "Shop Drawings - Other"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, "Browse all shop drawing categories")), /*#__PURE__*/React.createElement("span", {
    className: "text-purple-600"
  }, "\u2192"))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gray-50 rounded-b-lg border-t text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, "Scanned from license plate \u2022 Project ID: ", projectId))));
}

// Export for use in App.jsx
window.ModuleMenuPage = ModuleMenuPage;
})();


// ============================================================================
// FILE: ToastNotification.jsx
// ============================================================================
(function() {
/**
 * Global Toast Notification System for MODA
 * 
 * Provides in-app notifications that auto-dismiss.
 * Usage: window.MODA_TOAST.show('Message', 'success')
 */

(function () {
  'use strict';
// [Removed duplicate React destructuring]
  // Global toast state manager
  let toastListeners = [];
  let toastIdCounter = 0;

  // Global API for showing toasts from anywhere
  window.MODA_TOAST = {
    show: (message, type = 'success', options = {}) => {
      const toast = {
        id: ++toastIdCounter,
        message,
        type,
        // 'success', 'error', 'warning', 'info'
        duration: options.duration || 4000,
        subtitle: options.subtitle || null
      };
      toastListeners.forEach(listener => listener(toast));
      return toast.id;
    },
    success: (message, options = {}) => window.MODA_TOAST.show(message, 'success', options),
    error: (message, options = {}) => window.MODA_TOAST.show(message, 'error', options),
    warning: (message, options = {}) => window.MODA_TOAST.show(message, 'warning', options),
    info: (message, options = {}) => window.MODA_TOAST.show(message, 'info', options),
    subscribe: listener => {
      toastListeners.push(listener);
      return () => {
        toastListeners = toastListeners.filter(l => l !== listener);
      };
    }
  };

  // Toast Container Component - renders at app root level
  function ToastContainer() {
    const [toasts, setToasts] = useState([]);
    useEffect(() => {
      const unsubscribe = window.MODA_TOAST.subscribe(newToast => {
        setToasts(prev => [...prev, newToast]);

        // Auto-dismiss after duration
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== newToast.id));
        }, newToast.duration);
      });
      return unsubscribe;
    }, []);
    const removeToast = useCallback(id => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, []);
    if (toasts.length === 0) return null;
    const getToastStyles = type => {
      switch (type) {
        case 'success':
          return 'bg-green-50 border-green-500 text-green-800';
        case 'error':
          return 'bg-red-50 border-red-500 text-red-800';
        case 'warning':
          return 'bg-yellow-50 border-yellow-500 text-yellow-800';
        case 'info':
        default:
          return 'bg-blue-50 border-blue-500 text-blue-800';
      }
    };
    const getIcon = type => {
      switch (type) {
        case 'success':
          return /*#__PURE__*/React.createElement("svg", {
            className: "w-5 h-5 text-green-500",
            fill: "none",
            stroke: "currentColor",
            viewBox: "0 0 24 24"
          }, /*#__PURE__*/React.createElement("path", {
            strokeLinecap: "round",
            strokeLinejoin: "round",
            strokeWidth: "2",
            d: "M5 13l4 4L19 7"
          }));
        case 'error':
          return /*#__PURE__*/React.createElement("svg", {
            className: "w-5 h-5 text-red-500",
            fill: "none",
            stroke: "currentColor",
            viewBox: "0 0 24 24"
          }, /*#__PURE__*/React.createElement("path", {
            strokeLinecap: "round",
            strokeLinejoin: "round",
            strokeWidth: "2",
            d: "M6 18L18 6M6 6l12 12"
          }));
        case 'warning':
          return /*#__PURE__*/React.createElement("svg", {
            className: "w-5 h-5 text-yellow-500",
            fill: "none",
            stroke: "currentColor",
            viewBox: "0 0 24 24"
          }, /*#__PURE__*/React.createElement("path", {
            strokeLinecap: "round",
            strokeLinejoin: "round",
            strokeWidth: "2",
            d: "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          }));
        case 'info':
        default:
          return /*#__PURE__*/React.createElement("svg", {
            className: "w-5 h-5 text-blue-500",
            fill: "none",
            stroke: "currentColor",
            viewBox: "0 0 24 24"
          }, /*#__PURE__*/React.createElement("path", {
            strokeLinecap: "round",
            strokeLinejoin: "round",
            strokeWidth: "2",
            d: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          }));
      }
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "fixed top-4 right-4 z-[9999] space-y-2 pointer-events-none",
      style: {
        maxWidth: '400px'
      }
    }, toasts.map(toast => /*#__PURE__*/React.createElement("div", {
      key: toast.id,
      className: `pointer-events-auto flex items-start gap-3 px-4 py-3 rounded-lg shadow-lg border-l-4 ${getToastStyles(toast.type)}`,
      style: {
        animation: 'slideInRight 0.3s ease-out',
        minWidth: '280px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-shrink-0 mt-0.5"
    }, getIcon(toast.type)), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-medium text-sm"
    }, toast.message), toast.subtitle && /*#__PURE__*/React.createElement("div", {
      className: "text-xs opacity-75 mt-0.5"
    }, toast.subtitle)), /*#__PURE__*/React.createElement("button", {
      onClick: () => removeToast(toast.id),
      className: "flex-shrink-0 text-gray-400 hover:text-gray-600 text-lg leading-none",
      style: {
        marginTop: '-2px'
      }
    }, "\xD7"))));
  }

  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
  document.head.appendChild(style);

  // Export component
  window.ToastContainer = ToastContainer;
  console.log('[ToastNotification] Global toast system initialized');
})();
})();


// ============================================================================
// FILE: IssueTypesManager.jsx
// ============================================================================
(function() {
/**
 * Issue Types Manager for MODA
 * 
 * Admin component to manage issue types and their routing.
 * Types are stored in Supabase and used throughout the issue tracking system.
 * Includes export functionality for reporting.
 */
// [Removed duplicate React destructuring]
// Default issue types (used as fallback and initial seed)
const DEFAULT_ISSUE_TYPES = [{
  id: 'shop-drawing',
  label: 'Shop Drawing',
  color: '#0057B8',
  dashboard: 'engineering',
  is_active: true
}, {
  id: 'design-conflict',
  label: 'Design Conflict',
  color: '#7C3AED',
  dashboard: 'engineering',
  is_active: true
}, {
  id: 'material-supply',
  label: 'Material/Supply',
  color: '#EA580C',
  dashboard: 'supply-chain',
  is_active: true
}, {
  id: 'quality',
  label: 'Quality Issue',
  color: '#DC2626',
  dashboard: 'qa',
  is_active: true
}, {
  id: 'engineering-question',
  label: 'Engineering Question',
  color: '#0891B2',
  dashboard: 'engineering',
  is_active: true
}, {
  id: 'rfi',
  label: 'RFI Required',
  color: '#4F46E5',
  dashboard: 'rfi',
  is_active: true
}, {
  id: 'other',
  label: 'Other',
  color: '#6B7280',
  dashboard: 'engineering',
  is_active: true
}];
const DASHBOARD_OPTIONS = [{
  id: 'engineering',
  label: 'Engineering'
}, {
  id: 'supply-chain',
  label: 'Supply Chain'
}, {
  id: 'qa',
  label: 'QA'
}, {
  id: 'rfi',
  label: 'RFI'
}];
function IssueTypesManager({
  auth
}) {
  const [issueTypes, setIssueTypes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState(null);
  const [successMessage, setSuccessMessage] = useState(null);
  const [editingType, setEditingType] = useState(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newType, setNewType] = useState({
    id: '',
    label: '',
    color: '#6B7280',
    dashboard: 'engineering',
    is_active: true
  });

  // Load issue types from Supabase
  const loadIssueTypes = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (!supabase) {
        // Fallback to localStorage or defaults
        const saved = localStorage.getItem('moda_issue_types');
        if (saved) {
          setIssueTypes(JSON.parse(saved));
        } else {
          setIssueTypes(DEFAULT_ISSUE_TYPES);
          localStorage.setItem('moda_issue_types', JSON.stringify(DEFAULT_ISSUE_TYPES));
        }
        setLoading(false);
        return;
      }
      const {
        data,
        error: fetchError
      } = await supabase.from('issue_types').select('*').order('sort_order');
      if (fetchError) {
        // Table might not exist yet - use defaults
        if (fetchError.code === '42P01') {
          console.log('[IssueTypesManager] Table does not exist, using defaults');
          setIssueTypes(DEFAULT_ISSUE_TYPES);
          localStorage.setItem('moda_issue_types', JSON.stringify(DEFAULT_ISSUE_TYPES));
        } else {
          throw fetchError;
        }
      } else {
        const types = data && data.length > 0 ? data : DEFAULT_ISSUE_TYPES;
        setIssueTypes(types);
        localStorage.setItem('moda_issue_types', JSON.stringify(types));
      }
    } catch (err) {
      console.error('[IssueTypesManager] Error loading issue types:', err);
      setError('Failed to load issue types. Using cached data.');
      const saved = localStorage.getItem('moda_issue_types');
      setIssueTypes(saved ? JSON.parse(saved) : DEFAULT_ISSUE_TYPES);
    } finally {
      setLoading(false);
    }
  }, []);
  useEffect(() => {
    loadIssueTypes();
  }, [loadIssueTypes]);

  // Generate ID from label
  const generateId = label => {
    return label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  };

  // Add new issue type
  const handleAddType = async () => {
    if (!newType.label.trim()) {
      setError('Issue type name is required');
      return;
    }
    const typeId = newType.id || generateId(newType.label);

    // Check for duplicate ID
    if (issueTypes.some(t => t.id === typeId)) {
      setError('An issue type with this ID already exists');
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const typeData = {
        id: typeId,
        label: newType.label.trim(),
        color: newType.color,
        dashboard: newType.dashboard,
        is_active: true,
        sort_order: issueTypes.length + 1,
        created_at: new Date().toISOString()
      };
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        const {
          error: insertError
        } = await supabase.from('issue_types').insert(typeData);
        if (insertError && insertError.code !== '42P01') {
          throw insertError;
        }
      }

      // Update local state
      const updated = [...issueTypes, typeData];
      setIssueTypes(updated);
      localStorage.setItem('moda_issue_types', JSON.stringify(updated));

      // Update global routing
      updateGlobalRouting(updated);
      setNewType({
        id: '',
        label: '',
        color: '#6B7280',
        dashboard: 'engineering',
        is_active: true
      });
      setShowAddForm(false);
      setSuccessMessage('Issue type added successfully');
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('[IssueTypesManager] Error adding type:', err);
      setError('Failed to add issue type: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  // Update existing issue type
  const handleUpdateType = async (typeId, updates) => {
    setSaving(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        const {
          error: updateError
        } = await supabase.from('issue_types').update(updates).eq('id', typeId);
        if (updateError && updateError.code !== '42P01') {
          throw updateError;
        }
      }

      // Update local state
      const updated = issueTypes.map(t => t.id === typeId ? {
        ...t,
        ...updates
      } : t);
      setIssueTypes(updated);
      localStorage.setItem('moda_issue_types', JSON.stringify(updated));

      // Update global routing
      updateGlobalRouting(updated);
      setEditingType(null);
      setSuccessMessage('Issue type updated successfully');
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('[IssueTypesManager] Error updating type:', err);
      setError('Failed to update issue type: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  // Delete (deactivate) issue type
  const handleDeleteType = async typeId => {
    if (!confirm(`Are you sure you want to delete the "${issueTypes.find(t => t.id === typeId)?.label}" issue type? This will hide it from the issue submission form.`)) {
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        // Soft delete - just mark as inactive
        const {
          error: updateError
        } = await supabase.from('issue_types').update({
          is_active: false
        }).eq('id', typeId);
        if (updateError && updateError.code !== '42P01') {
          throw updateError;
        }
      }

      // Update local state - remove from list
      const updated = issueTypes.filter(t => t.id !== typeId);
      setIssueTypes(updated);
      localStorage.setItem('moda_issue_types', JSON.stringify(updated));

      // Update global routing
      updateGlobalRouting(updated);
      setSuccessMessage('Issue type deleted successfully');
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('[IssueTypesManager] Error deleting type:', err);
      setError('Failed to delete issue type: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  // Update global routing system with new types
  const updateGlobalRouting = types => {
    if (window.MODA_ISSUE_ROUTING) {
      window.MODA_ISSUE_ROUTING.ISSUE_TYPES = types.filter(t => t.is_active !== false);
    }
    // Dispatch event for other components to update
    window.dispatchEvent(new CustomEvent('moda-issue-types-updated', {
      detail: {
        types
      }
    }));
  };

  // Export issues data
  const handleExportIssues = async () => {
    try {
      let issues = [];
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        const {
          data,
          error
        } = await supabase.from('engineering_issues').select('*').order('created_at', {
          ascending: false
        });
        if (!error && data) {
          issues = data;
        }
      }

      // Fallback to localStorage
      if (issues.length === 0) {
        const saved = localStorage.getItem('moda_engineering_issues');
        if (saved) {
          issues = JSON.parse(saved);
        }
      }
      if (issues.length === 0) {
        setError('No issues to export');
        return;
      }

      // Create CSV
      const headers = ['Issue ID', 'Type', 'Priority', 'Status', 'Title', 'Description', 'Project', 'Module (BLM)', 'Department', 'Submitted By', 'Assigned To', 'Created', 'Updated', 'Resolved'];
      const rows = issues.map(issue => [issue.issue_display_id || '', issue.issue_type || '', issue.priority || '', issue.status || '', (issue.title || '').replace(/"/g, '""'), (issue.description || '').replace(/"/g, '""'), issue.project_name || '', issue.blm_id || '', issue.department || '', issue.submitted_by || '', issue.assigned_to || '', issue.created_at ? new Date(issue.created_at).toLocaleString() : '', issue.updated_at ? new Date(issue.updated_at).toLocaleString() : '', issue.resolved_at ? new Date(issue.resolved_at).toLocaleString() : '']);
      const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');

      // Download
      const blob = new Blob([csvContent], {
        type: 'text/csv;charset=utf-8;'
      });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `engineering_issues_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      setSuccessMessage(`Exported ${issues.length} issues to CSV`);
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('[IssueTypesManager] Export error:', err);
      setError('Failed to export issues: ' + err.message);
    }
  };

  // Render
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy, #1E3A5F)'
    }
  }, "Issue Types Manager"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 text-sm mt-1"
  }, "Configure issue types and their routing destinations")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleExportIssues,
    className: "px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
  })), "Export Issues"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddForm(true),
    className: "px-4 py-2 text-sm text-white rounded-lg flex items-center gap-2",
    style: {
      backgroundColor: 'var(--autovol-blue, #0057B8)'
    }
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M12 4v16m8-8H4"
  })), "Add Issue Type"))), error && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"
  }, error), successMessage && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm"
  }, successMessage), showAddForm && /*#__PURE__*/React.createElement("div", {
    className: "mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-3"
  }, "Add New Issue Type"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newType.label,
    onChange: e => setNewType({
      ...newType,
      label: e.target.value,
      id: generateId(e.target.value)
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
    placeholder: "e.g., Safety Issue"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "ID (auto-generated)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newType.id,
    onChange: e => setNewType({
      ...newType,
      id: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100",
    placeholder: "safety-issue"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Color"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "color",
    value: newType.color,
    onChange: e => setNewType({
      ...newType,
      color: e.target.value
    }),
    className: "w-10 h-10 rounded cursor-pointer"
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newType.color,
    onChange: e => setNewType({
      ...newType,
      color: e.target.value
    }),
    className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Route To Dashboard"), /*#__PURE__*/React.createElement("select", {
    value: newType.dashboard,
    onChange: e => setNewType({
      ...newType,
      dashboard: e.target.value
    }),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, DASHBOARD_OPTIONS.map(opt => /*#__PURE__*/React.createElement("option", {
    key: opt.id,
    value: opt.id
  }, opt.label))))), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-end gap-2 mt-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddForm(false);
      setNewType({
        id: '',
        label: '',
        color: '#6B7280',
        dashboard: 'engineering',
        is_active: true
      });
    },
    className: "px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleAddType,
    disabled: saving || !newType.label.trim(),
    className: "px-4 py-2 text-sm text-white rounded-lg disabled:opacity-50",
    style: {
      backgroundColor: 'var(--autovol-blue, #0057B8)'
    }
  }, saving ? 'Adding...' : 'Add Type'))), loading ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, "Loading issue types...") : /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, issueTypes.filter(t => t.is_active !== false).map(type => /*#__PURE__*/React.createElement("div", {
    key: type.id,
    className: "flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50"
  }, editingType === type.id ?
  /*#__PURE__*/
  // Edit mode
  React.createElement("div", {
    className: "flex-1 grid grid-cols-4 gap-4 items-center"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    defaultValue: type.label,
    id: `edit-label-${type.id}`,
    className: "px-3 py-2 border border-gray-300 rounded-lg"
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "color",
    defaultValue: type.color,
    id: `edit-color-${type.id}`,
    className: "w-8 h-8 rounded cursor-pointer"
  })), /*#__PURE__*/React.createElement("select", {
    defaultValue: type.dashboard,
    id: `edit-dashboard-${type.id}`,
    className: "px-3 py-2 border border-gray-300 rounded-lg"
  }, DASHBOARD_OPTIONS.map(opt => /*#__PURE__*/React.createElement("option", {
    key: opt.id,
    value: opt.id
  }, opt.label))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditingType(null),
    className: "px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const label = document.getElementById(`edit-label-${type.id}`).value;
      const color = document.getElementById(`edit-color-${type.id}`).value;
      const dashboard = document.getElementById(`edit-dashboard-${type.id}`).value;
      handleUpdateType(type.id, {
        label,
        color,
        dashboard
      });
    },
    className: "px-3 py-1 text-sm text-white rounded",
    style: {
      backgroundColor: 'var(--autovol-blue, #0057B8)'
    }
  }, "Save"))) :
  /*#__PURE__*/
  // View mode
  React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-4 h-4 rounded-full",
    style: {
      backgroundColor: type.color
    }
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-medium"
  }, type.label), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "ID: ", type.id, " | Routes to: ", DASHBOARD_OPTIONS.find(d => d.id === type.dashboard)?.label || type.dashboard))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditingType(type.id),
    className: "p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded",
    title: "Edit"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleDeleteType(type.id),
    className: "p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded",
    title: "Delete"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
  })))))))), /*#__PURE__*/React.createElement("div", {
    className: "mt-6 p-4 bg-blue-50 rounded-lg text-sm text-blue-800"
  }, /*#__PURE__*/React.createElement("strong", null, "Note:"), " Changes to issue types will be reflected in the Issue Submission form. Deleting a type will hide it from new submissions but won't affect existing issues."));
}

// Export to window
window.IssueTypesManager = IssueTypesManager;
})();


// ============================================================================
// FILE: IssueCategoriesManager.jsx
// ============================================================================
(function() {
/**
 * Issue Categories Manager for MODA
 * 
 * Admin component to manage issue categories per issue type.
 * Categories are stored in Supabase and used in the Issue Submission Modal.
 */
// [Removed duplicate React destructuring]
// Issue types from the routing system
const ISSUE_TYPES = [{
  id: 'shop-drawing',
  label: 'Shop Drawing',
  color: '#0057B8'
}, {
  id: 'design-conflict',
  label: 'Design Conflict',
  color: '#7C3AED'
}, {
  id: 'material-supply',
  label: 'Material/Supply',
  color: '#EA580C'
}, {
  id: 'quality',
  label: 'Quality Issue',
  color: '#DC2626'
}, {
  id: 'engineering-question',
  label: 'Engineering Question',
  color: '#0891B2'
}, {
  id: 'rfi',
  label: 'RFI Required',
  color: '#4F46E5'
}, {
  id: 'other',
  label: 'Other',
  color: '#6B7280'
}];
function IssueCategoriesManager({
  auth
}) {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState(null);
  const [selectedIssueType, setSelectedIssueType] = useState('shop-drawing');
  const [editingCategory, setEditingCategory] = useState(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newCategory, setNewCategory] = useState({
    name: '',
    description: ''
  });

  // Load categories from Supabase
  const loadCategories = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (!supabase) {
        // Fallback to localStorage
        const saved = localStorage.getItem('moda_issue_categories');
        if (saved) {
          setCategories(JSON.parse(saved));
        }
        setLoading(false);
        return;
      }
      const {
        data,
        error: fetchError
      } = await supabase.from('issue_categories').select('*').order('issue_type').order('sort_order');
      if (fetchError) throw fetchError;
      setCategories(data || []);
      // Also cache in localStorage for offline access
      localStorage.setItem('moda_issue_categories', JSON.stringify(data || []));
    } catch (err) {
      console.error('[IssueCategoriesManager] Error loading categories:', err);
      setError('Failed to load categories. Using cached data if available.');
      // Try localStorage fallback
      const saved = localStorage.getItem('moda_issue_categories');
      if (saved) {
        setCategories(JSON.parse(saved));
      }
    } finally {
      setLoading(false);
    }
  }, []);
  useEffect(() => {
    loadCategories();
  }, [loadCategories]);

  // Get categories for selected issue type
  const filteredCategories = categories.filter(c => c.issue_type === selectedIssueType && c.is_active !== false);

  // Add new category
  const handleAddCategory = async () => {
    if (!newCategory.name.trim()) {
      setError('Category name is required');
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      const categoryData = {
        issue_type: selectedIssueType,
        name: newCategory.name.trim(),
        description: newCategory.description.trim() || null,
        sort_order: filteredCategories.length + 1,
        is_active: true,
        created_by: auth?.userId || null
      };
      if (supabase) {
        const {
          data,
          error: insertError
        } = await supabase.from('issue_categories').insert(categoryData).select().single();
        if (insertError) throw insertError;
        setCategories(prev => [...prev, data]);
        localStorage.setItem('moda_issue_categories', JSON.stringify([...categories, data]));
      } else {
        // localStorage fallback
        const localCategory = {
          ...categoryData,
          id: `local-${Date.now()}`,
          created_at: new Date().toISOString()
        };
        const updated = [...categories, localCategory];
        setCategories(updated);
        localStorage.setItem('moda_issue_categories', JSON.stringify(updated));
      }
      setNewCategory({
        name: '',
        description: ''
      });
      setShowAddForm(false);
    } catch (err) {
      console.error('[IssueCategoriesManager] Error adding category:', err);
      setError(err.message || 'Failed to add category');
    } finally {
      setSaving(false);
    }
  };

  // Update category
  const handleUpdateCategory = async category => {
    setSaving(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        const {
          error: updateError
        } = await supabase.from('issue_categories').update({
          name: category.name,
          description: category.description
        }).eq('id', category.id);
        if (updateError) throw updateError;
      }

      // Update local state
      const updated = categories.map(c => c.id === category.id ? category : c);
      setCategories(updated);
      localStorage.setItem('moda_issue_categories', JSON.stringify(updated));
      setEditingCategory(null);
    } catch (err) {
      console.error('[IssueCategoriesManager] Error updating category:', err);
      setError(err.message || 'Failed to update category');
    } finally {
      setSaving(false);
    }
  };

  // Delete category (soft delete)
  const handleDeleteCategory = async categoryId => {
    if (!confirm('Are you sure you want to delete this category?')) return;
    setSaving(true);
    setError(null);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      if (supabase) {
        const {
          error: deleteError
        } = await supabase.from('issue_categories').update({
          is_active: false
        }).eq('id', categoryId);
        if (deleteError) throw deleteError;
      }

      // Update local state
      const updated = categories.map(c => c.id === categoryId ? {
        ...c,
        is_active: false
      } : c);
      setCategories(updated);
      localStorage.setItem('moda_issue_categories', JSON.stringify(updated));
    } catch (err) {
      console.error('[IssueCategoriesManager] Error deleting category:', err);
      setError(err.message || 'Failed to delete category');
    } finally {
      setSaving(false);
    }
  };

  // Reorder categories
  const handleMoveCategory = async (categoryId, direction) => {
    const currentIndex = filteredCategories.findIndex(c => c.id === categoryId);
    if (currentIndex === -1) return;
    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (newIndex < 0 || newIndex >= filteredCategories.length) return;
    setSaving(true);
    try {
      const supabase = window.MODA_SUPABASE?.client;
      const current = filteredCategories[currentIndex];
      const swap = filteredCategories[newIndex];
      if (supabase) {
        // Swap sort_order values
        await Promise.all([supabase.from('issue_categories').update({
          sort_order: swap.sort_order
        }).eq('id', current.id), supabase.from('issue_categories').update({
          sort_order: current.sort_order
        }).eq('id', swap.id)]);
      }

      // Update local state
      const updated = categories.map(c => {
        if (c.id === current.id) return {
          ...c,
          sort_order: swap.sort_order
        };
        if (c.id === swap.id) return {
          ...c,
          sort_order: current.sort_order
        };
        return c;
      });
      setCategories(updated);
      localStorage.setItem('moda_issue_categories', JSON.stringify(updated));
    } catch (err) {
      console.error('[IssueCategoriesManager] Error reordering:', err);
    } finally {
      setSaving(false);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Issue Categories"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600 mt-1"
  }, "Manage categories for each issue type. Categories appear in the Report Issue form.")), error && /*#__PURE__*/React.createElement("div", {
    className: "mx-6 mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"
  }, error), /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Select Issue Type"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, ISSUE_TYPES.map(type => /*#__PURE__*/React.createElement("button", {
    key: type.id,
    onClick: () => setSelectedIssueType(type.id),
    className: `px-4 py-2 rounded-lg border-2 text-sm font-medium transition ${selectedIssueType === type.id ? 'border-current bg-opacity-10' : 'border-gray-200 hover:border-gray-300'}`,
    style: {
      borderColor: selectedIssueType === type.id ? type.color : undefined,
      backgroundColor: selectedIssueType === type.id ? `${type.color}15` : undefined,
      color: selectedIssueType === type.id ? type.color : '#374151'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "inline-block w-2 h-2 rounded-full mr-2",
    style: {
      backgroundColor: type.color
    }
  }), type.label)))), /*#__PURE__*/React.createElement("div", {
    className: "border rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-3 bg-gray-50 border-b flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-medium text-gray-900"
  }, "Categories for ", ISSUE_TYPES.find(t => t.id === selectedIssueType)?.label), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddForm(true),
    disabled: showAddForm,
    className: "px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", null, "+"), " Add Category")), loading ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading categories...") : /*#__PURE__*/React.createElement("div", {
    className: "divide-y"
  }, showAddForm && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-blue-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newCategory.name,
    onChange: e => setNewCategory(prev => ({
      ...prev,
      name: e.target.value
    })),
    placeholder: "Category name",
    className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
    autoFocus: true
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newCategory.description,
    onChange: e => setNewCategory(prev => ({
      ...prev,
      description: e.target.value
    })),
    placeholder: "Description (optional)",
    className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleAddCategory,
    disabled: saving || !newCategory.name.trim(),
    className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
  }, saving ? 'Saving...' : 'Save'), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddForm(false);
      setNewCategory({
        name: '',
        description: ''
      });
    },
    className: "px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"
  }, "Cancel"))), filteredCategories.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "No categories defined for this issue type.", /*#__PURE__*/React.createElement("br", null), /*#__PURE__*/React.createElement("span", {
    className: "text-sm"
  }, "Click \"Add Category\" to create one.")) : filteredCategories.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)).map((category, index) => /*#__PURE__*/React.createElement("div", {
    key: category.id,
    className: "p-4 flex items-center gap-4 hover:bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleMoveCategory(category.id, 'up'),
    disabled: index === 0 || saving,
    className: "p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30",
    title: "Move up"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M5 15l7-7 7 7"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleMoveCategory(category.id, 'down'),
    disabled: index === filteredCategories.length - 1 || saving,
    className: "p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30",
    title: "Move down"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M19 9l-7 7-7-7"
  })))), editingCategory?.id === category.id ? /*#__PURE__*/React.createElement("div", {
    className: "flex-1 flex gap-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editingCategory.name,
    onChange: e => setEditingCategory(prev => ({
      ...prev,
      name: e.target.value
    })),
    className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editingCategory.description || '',
    onChange: e => setEditingCategory(prev => ({
      ...prev,
      description: e.target.value
    })),
    placeholder: "Description",
    className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleUpdateCategory(editingCategory),
    disabled: saving,
    className: "px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
  }, "Save"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditingCategory(null),
    className: "px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"
  }, "Cancel")) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, category.name), category.description && /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, category.description)), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditingCategory({
      ...category
    }),
    className: "px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-100"
  }, "Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleDeleteCategory(category.id),
    disabled: saving,
    className: "px-3 py-1.5 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50 disabled:opacity-50"
  }, "Delete")))))))));
}

// Export to window for global access
window.IssueCategoriesManager = IssueCategoriesManager;
})();


// ============================================================================
// FILE: IssueSubmissionModal.jsx
// ============================================================================
(function() {
/**
 * Issue Submission Modal for MODA Engineering Issue Tracker
 * 
 * Modal form for submitting new engineering issues.
 * Can be opened with context (from module card) or standalone.
 * Supports photo attachments and priority/type selection.
 */
// [Removed duplicate React destructuring]
function IssueSubmissionModal({
  context = null,
  projects = [],
  employees = [],
  auth = {},
  onSubmit,
  onClose
}) {
  // ===== CONSTANTS (from routing system) =====
  const ISSUE_TYPES = window.MODA_ISSUE_ROUTING?.ISSUE_TYPES || [{
    id: 'shop-drawing',
    label: 'Shop Drawing',
    color: '#0057B8'
  }, {
    id: 'design-conflict',
    label: 'Design Conflict',
    color: '#7C3AED'
  }, {
    id: 'material-supply',
    label: 'Material/Supply',
    color: '#EA580C'
  }, {
    id: 'quality',
    label: 'Quality Issue',
    color: '#DC2626'
  }, {
    id: 'engineering-question',
    label: 'Engineering Question',
    color: '#0891B2'
  }, {
    id: 'rfi',
    label: 'RFI Required',
    color: '#4F46E5'
  }, {
    id: 'other',
    label: 'Other',
    color: '#6B7280'
  }];
  const PRIORITY_LEVELS = window.MODA_ISSUE_ROUTING?.PRIORITY_LEVELS || [{
    id: 'low',
    label: 'Low',
    color: '#10B981',
    description: 'Can wait'
  }, {
    id: 'medium',
    label: 'Medium',
    color: '#F59E0B',
    description: 'Normal priority'
  }, {
    id: 'high',
    label: 'High',
    color: '#EA580C',
    description: 'Needs attention'
  }, {
    id: 'critical',
    label: 'Critical',
    color: '#DC2626',
    description: 'Blocking work'
  }];

  // Get routing destination for selected issue type
  const getRoutingDestination = issueType => {
    if (!issueType) return null;
    return window.MODA_ISSUE_ROUTING?.getDashboardLabel?.(issueType) || 'Engineering';
  };

  // ===== STATE =====
  const [formData, setFormData] = useState({
    project_id: context?.project_id || '',
    project_name: context?.project_name || '',
    blm_id: context?.blm_id || '',
    unit_type: context?.unit_type || '',
    department: context?.department || '',
    stage: context?.stage || '',
    issue_type: '',
    issue_category: '',
    // New: category within the issue type
    priority: 'medium',
    title: '',
    description: '',
    assigned_to_id: '',
    assigned_to: '',
    linked_module_ids: [],
    // Array of module IDs for Shop Drawing issues
    linked_modules_display: '',
    // Display string for selected modules
    applies_to_unit_type: false // If true, applies to all modules of selected unit type
  });
  const [photos, setPhotos] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState(null);
  const [showProjectSelect, setShowProjectSelect] = useState(!context?.project_id);
  const [issueCategories, setIssueCategories] = useState([]);
  const [loadingCategories, setLoadingCategories] = useState(true);
  const [moduleSearchTerm, setModuleSearchTerm] = useState(''); // Search filter for modules

  const fileInputRef = useRef(null);
  const modalRef = useRef(null);

  // Get current user info
  const currentUser = {
    id: auth.userId || window.MODA_SUPABASE?.userProfile?.id || null,
    name: auth.userName || window.MODA_SUPABASE?.userProfile?.name || window.MODA_SUPABASE?.userProfile?.email?.split('@')[0] || 'Unknown User'
  };

  // Engineering team members for assignment
  const engineeringTeam = employees.filter(e => e.department?.toLowerCase().includes('engineering') || e.role?.toLowerCase().includes('engineer'));

  // ===== EFFECTS =====
  useEffect(() => {
    // Close on escape key
    const handleEscape = e => {
      if (e.key === 'Escape') onClose();
    };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [onClose]);
  useEffect(() => {
    // Lock body scroll
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = '';
    };
  }, []);

  // Load issue categories from Supabase
  useEffect(() => {
    const loadCategories = async () => {
      setLoadingCategories(true);
      try {
        const supabase = window.MODA_SUPABASE?.client;
        if (supabase) {
          const {
            data,
            error: fetchError
          } = await supabase.from('issue_categories').select('*').eq('is_active', true).order('issue_type').order('sort_order');
          if (fetchError) throw fetchError;
          setIssueCategories(data || []);
          localStorage.setItem('moda_issue_categories', JSON.stringify(data || []));
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('moda_issue_categories');
          if (saved) {
            setIssueCategories(JSON.parse(saved));
          }
        }
      } catch (err) {
        console.error('[IssueSubmissionModal] Error loading categories:', err);
        // Try localStorage fallback
        const saved = localStorage.getItem('moda_issue_categories');
        if (saved) {
          setIssueCategories(JSON.parse(saved));
        }
      } finally {
        setLoadingCategories(false);
      }
    };
    loadCategories();
  }, []);

  // Get categories for the currently selected issue type
  const getCategoriesForType = useCallback(issueType => {
    if (!issueType) return [];
    return issueCategories.filter(c => c.issue_type === issueType);
  }, [issueCategories]);

  // ===== HANDLERS =====
  const handleChange = (field, value) => {
    setFormData(prev => {
      const updated = {
        ...prev,
        [field]: value
      };
      // Clear category when issue type changes
      if (field === 'issue_type') {
        updated.issue_category = '';
      }
      return updated;
    });
    setError(null);
  };
  const handleProjectChange = projectId => {
    const project = projects.find(p => p.id === projectId);
    setFormData(prev => ({
      ...prev,
      project_id: projectId,
      project_name: project?.name || ''
    }));
  };
  const handleAssigneeChange = employeeId => {
    const employee = employees.find(e => e.id === employeeId);
    setFormData(prev => ({
      ...prev,
      assigned_to_id: employeeId,
      assigned_to: employee ? `${employee.firstName || ''} ${employee.lastName || ''}`.trim() : ''
    }));
  };
  const handlePhotoCapture = async e => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    // Limit to 5 photos total
    const remaining = 5 - photos.length;
    const filesToProcess = files.slice(0, remaining);
    for (const file of filesToProcess) {
      try {
        // Compress and convert to base64
        const compressed = await compressImage(file);
        setPhotos(prev => [...prev, compressed]);
      } catch (err) {
        console.error('Error processing photo:', err);
      }
    }

    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };
  const compressImage = file => {
    return new Promise((resolve, reject) => {
      // Use MODA's photo compression if available
      if (window.compressPhoto) {
        window.compressPhoto(file, {
          maxWidth: 1200,
          quality: 0.8
        }).then(resolve).catch(reject);
        return;
      }

      // Fallback: simple base64 conversion
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };
  const removePhoto = index => {
    setPhotos(prev => prev.filter((_, i) => i !== index));
  };
  const handleSubmit = async e => {
    e.preventDefault();

    // Validation
    if (!formData.issue_type) {
      setError('Please select an issue type');
      return;
    }
    if (!formData.description.trim() || formData.description.trim().length < 5) {
      setError('Please provide a description (at least 5 characters)');
      return;
    }
    setIsSubmitting(true);
    setError(null);
    try {
      const issueData = {
        ...formData,
        photo_urls: photos,
        submitted_by: currentUser.name,
        submitted_by_id: currentUser.id
      };

      // Use routing system if available, otherwise fall back to onSubmit
      if (window.MODA_ISSUE_ROUTING?.createIssue) {
        console.log('[IssueSubmissionModal] Using routing system to create issue');
        const newIssue = await window.MODA_ISSUE_ROUTING.createIssue(issueData);
        const destination = getRoutingDestination(formData.issue_type);
        console.log('[IssueSubmissionModal] Issue created:', newIssue);
        setIsSubmitting(false);

        // Use toast notification instead of alert
        if (window.MODA_TOAST) {
          window.MODA_TOAST.success(`Issue ${newIssue.issue_display_id} submitted successfully!`, {
            subtitle: `Routed to: ${destination}`
          });
        }
        onClose();
      } else if (onSubmit) {
        console.log('[IssueSubmissionModal] Using onSubmit callback');
        await onSubmit(issueData);
        setIsSubmitting(false);
        onClose();
      } else {
        console.error('[IssueSubmissionModal] No routing system or onSubmit available');
        setError('Issue routing system not available. Please refresh and try again.');
        setIsSubmitting(false);
      }
    } catch (err) {
      console.error('[IssueSubmissionModal] Error submitting issue:', err);
      setError(err.message || 'Failed to submit issue. Please try again.');
      setIsSubmitting(false);
    }
  };
  const handleBackdropClick = e => {
    if (e.target === modalRef.current) {
      onClose();
    }
  };

  // ===== RENDER =====
  return /*#__PURE__*/React.createElement("div", {
    ref: modalRef,
    onClick: handleBackdropClick,
    className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, "Report Issue"), context?.blm_id && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-1"
  }, "Module: ", context.blm_id, " ", context.unit_type && `(${context.unit_type})`), formData.issue_type && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-blue-600 mt-1"
  }, "Will be routed to: ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, getRoutingDestination(formData.issue_type)))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-200 rounded-lg transition-colors",
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '20px',
      height: '20px',
      display: 'block'
    }
  }))), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "flex-1 overflow-y-auto p-6"
  }, error && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"
  }, error), context && /*#__PURE__*/React.createElement("div", {
    className: "mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium text-blue-800 mb-2"
  }, "Issue Context"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2 text-sm"
  }, context.project_name && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-blue-600"
  }, "Project:"), ' ', /*#__PURE__*/React.createElement("span", {
    className: "text-blue-900"
  }, context.project_name)), context.blm_id && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-blue-600"
  }, "Module:"), ' ', /*#__PURE__*/React.createElement("span", {
    className: "text-blue-900"
  }, context.blm_id)), context.department && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-blue-600"
  }, "Department:"), ' ', /*#__PURE__*/React.createElement("span", {
    className: "text-blue-900"
  }, context.department)), context.stage && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-blue-600"
  }, "Stage:"), ' ', /*#__PURE__*/React.createElement("span", {
    className: "text-blue-900"
  }, context.stage)))), showProjectSelect && /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Project"), /*#__PURE__*/React.createElement("select", {
    value: formData.project_id,
    onChange: e => handleProjectChange(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select a project..."), (() => {
    // Separate active and completed projects
    const activeProjects = projects.filter(p => p.status !== 'Completed' && p.status !== 'completed').sort((a, b) => (a.projectNumber || a.name || '').localeCompare(b.projectNumber || b.name || ''));
    const completedProjects = projects.filter(p => p.status === 'Completed' || p.status === 'completed').sort((a, b) => (a.projectNumber || a.name || '').localeCompare(b.projectNumber || b.name || ''));
    return /*#__PURE__*/React.createElement(React.Fragment, null, activeProjects.length > 0 && /*#__PURE__*/React.createElement("optgroup", {
      label: "Active Projects"
    }, activeProjects.map(p => /*#__PURE__*/React.createElement("option", {
      key: p.id,
      value: p.id
    }, p.projectNumber ? `${p.projectNumber} - ` : '', p.name))), completedProjects.length > 0 && /*#__PURE__*/React.createElement("optgroup", {
      label: "Completed Projects"
    }, completedProjects.map(p => /*#__PURE__*/React.createElement("option", {
      key: p.id,
      value: p.id
    }, p.projectNumber ? `${p.projectNumber} - ` : '', p.name))));
  })())), !context?.blm_id && formData.issue_type !== 'shop-drawing' && /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Module BLM ID (optional)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.blm_id,
    onChange: e => handleChange('blm_id', e.target.value),
    placeholder: "e.g., 21-0393",
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  })), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Issue Type ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 sm:grid-cols-4 gap-2"
  }, ISSUE_TYPES.map(type => {
    const destination = getRoutingDestination(type.id);
    return /*#__PURE__*/React.createElement("button", {
      key: type.id,
      type: "button",
      onClick: () => handleChange('issue_type', type.id),
      className: `p-3 rounded-lg border-2 text-center transition-all ${formData.issue_type === type.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`,
      title: `Routes to ${destination}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-3 h-3 rounded-full mx-auto mb-1",
      style: {
        backgroundColor: type.color
      }
    }), /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-medium text-gray-700"
    }, type.label));
  }))), formData.issue_type && /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Issue Category"), loadingCategories ? /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 py-2"
  }, "Loading categories...") : getCategoriesForType(formData.issue_type).length > 0 ? /*#__PURE__*/React.createElement("select", {
    value: formData.issue_category,
    onChange: e => handleChange('issue_category', e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select a category..."), getCategoriesForType(formData.issue_type).map(cat => /*#__PURE__*/React.createElement("option", {
    key: cat.id,
    value: cat.name
  }, cat.name))) : /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-400 py-2 italic"
  }, "No categories defined for this issue type"), formData.issue_category && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, getCategoriesForType(formData.issue_type).find(c => c.name === formData.issue_category)?.description)), formData.issue_type === 'shop-drawing' && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium text-blue-800 mb-3"
  }, "Link to Module Shop Drawing Package(s)"), formData.project_id ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-2 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: formData.applies_to_unit_type,
    onChange: e => {
      setFormData(prev => ({
        ...prev,
        applies_to_unit_type: e.target.checked,
        linked_module_ids: e.target.checked ? [] : prev.linked_module_ids
      }));
    },
    className: "w-4 h-4 text-blue-600 rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-700"
  }, "Applies to all modules of unit type: ", /*#__PURE__*/React.createElement("strong", null, formData.unit_type || 'All'))), !formData.applies_to_unit_type && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Search & Select Modules"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: moduleSearchTerm,
    onChange: e => setModuleSearchTerm(e.target.value),
    placeholder: "Search by M#, BLM, serial...",
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  })), /*#__PURE__*/React.createElement("div", {
    className: "max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-white"
  }, (() => {
    const selectedProject = projects.find(p => p.id === formData.project_id);
    const modules = selectedProject?.modules || [];
    const searchLower = moduleSearchTerm.toLowerCase();
    const filteredModules = modules.filter(m => {
      if (!moduleSearchTerm) return true;
      const searchFields = [m.serialNumber, m.hitchBLM, m.rearBLM, `M${m.buildSequence}`, `#${m.buildSequence}`, m.unitType].filter(Boolean).map(s => s.toLowerCase());
      return searchFields.some(f => f.includes(searchLower));
    }).sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));
    if (filteredModules.length === 0) {
      return /*#__PURE__*/React.createElement("div", {
        className: "p-3 text-sm text-gray-500 text-center"
      }, moduleSearchTerm ? 'No modules match your search' : 'No modules in this project');
    }
    return filteredModules.map(m => /*#__PURE__*/React.createElement("label", {
      key: m.id,
      className: `flex items-center gap-3 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 ${formData.linked_module_ids.includes(m.id) ? 'bg-blue-50' : ''}`
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: formData.linked_module_ids.includes(m.id),
      onChange: e => {
        const isChecked = e.target.checked;
        setFormData(prev => {
          const newIds = isChecked ? [...prev.linked_module_ids, m.id] : prev.linked_module_ids.filter(id => id !== m.id);

          // Build display string from selected modules
          const selectedModules = modules.filter(mod => newIds.includes(mod.id));
          const displayStr = selectedModules.map(mod => mod.hitchBLM || mod.serialNumber).join(', ');

          // Auto-populate blm_id from first selected module
          const firstModule = selectedModules[0];
          return {
            ...prev,
            linked_module_ids: newIds,
            linked_modules_display: displayStr,
            blm_id: firstModule?.hitchBLM || firstModule?.serialNumber || ''
          };
        });
      },
      className: "w-4 h-4 text-blue-600 rounded"
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-sm font-medium text-gray-900"
    }, "#", m.buildSequence, " - ", m.serialNumber), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, m.hitchBLM || 'No BLM', " ", m.unitType ? `| ${m.unitType}` : ''))));
  })()), formData.linked_module_ids.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-2 bg-white rounded border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-blue-600"
  }, "Selected: "), /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-medium text-blue-800"
  }, formData.linked_module_ids.length, " module", formData.linked_module_ids.length > 1 ? 's' : '')), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setFormData(prev => ({
      ...prev,
      linked_module_ids: [],
      linked_modules_display: '',
      blm_id: ''
    })),
    className: "text-xs text-red-600 hover:text-red-800"
  }, "Clear all"))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, formData.applies_to_unit_type ? 'Issue will apply to all modules of the selected unit type' : 'Select one or more modules to link this issue to their shop drawing packages')) : /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-amber-600 py-2"
  }, "Please select a project first to choose modules")), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Priority"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-4 gap-2"
  }, PRIORITY_LEVELS.map(level => /*#__PURE__*/React.createElement("button", {
    key: level.id,
    type: "button",
    onClick: () => handleChange('priority', level.id),
    className: `p-3 rounded-lg border-2 text-center transition-all ${formData.priority === level.id ? 'border-current' : 'border-gray-200 hover:border-gray-300'}`,
    style: {
      borderColor: formData.priority === level.id ? level.color : undefined,
      backgroundColor: formData.priority === level.id ? `${level.color}10` : undefined
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium",
    style: {
      color: level.color
    }
  }, level.label), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, level.description))))), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Title (optional)"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.title,
    onChange: e => handleChange('title', e.target.value),
    placeholder: "Brief summary of the issue",
    maxLength: 100,
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  })), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400 font-normal ml-2"
  }, "(", formData.description.length, "/500)")), /*#__PURE__*/React.createElement("textarea", {
    value: formData.description,
    onChange: e => handleChange('description', e.target.value.slice(0, 500)),
    placeholder: "Describe the issue in detail. What's wrong? Where is it? What impact does it have?",
    rows: 4,
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
  }), formData.description.length < 10 && formData.description.length > 0 && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-orange-600 mt-1"
  }, "Please provide at least 10 characters")), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Assign To (optional)"), /*#__PURE__*/React.createElement("select", {
    value: formData.assigned_to_id,
    onChange: e => handleAssigneeChange(e.target.value),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Unassigned - Engineering will triage"), engineeringTeam.length > 0 && /*#__PURE__*/React.createElement("optgroup", {
    label: "Engineering Team"
  }, engineeringTeam.map(e => /*#__PURE__*/React.createElement("option", {
    key: e.id,
    value: e.id
  }, e.firstName, " ", e.lastName))), employees.filter(e => !engineeringTeam.includes(e)).length > 0 && /*#__PURE__*/React.createElement("optgroup", {
    label: "Other Team Members"
  }, employees.filter(e => !engineeringTeam.includes(e)).map(e => /*#__PURE__*/React.createElement("option", {
    key: e.id,
    value: e.id
  }, e.firstName, " ", e.lastName))))), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "Photos (optional, max 5)"), photos.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-5 gap-2 mb-3"
  }, photos.map((photo, index) => /*#__PURE__*/React.createElement("div", {
    key: index,
    className: "relative aspect-square"
  }, /*#__PURE__*/React.createElement("img", {
    src: photo,
    alt: `Photo ${index + 1}`,
    className: "w-full h-full object-cover rounded-lg"
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => removePhoto(index),
    className: "absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"
  }, "X")))), photos.length < 5 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("input", {
    ref: fileInputRef,
    type: "file",
    accept: "image/*",
    capture: "environment",
    multiple: true,
    onChange: handlePhotoCapture,
    className: "hidden"
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => fileInputRef.current?.click(),
    className: "w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 transition-colors flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-camera",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), "Add Photo (", photos.length, "/5)")))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "Submitting as: ", /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, currentUser.name)), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    disabled: isSubmitting,
    className: "px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors disabled:opacity-50"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    onClick: handleSubmit,
    disabled: isSubmitting || !formData.issue_type || formData.description.trim().length < 5,
    className: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
  }, isSubmitting ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "animate-spin"
  }, "..."), "Submitting...") : 'Submit Issue')))));
}

// Export to window for global access
window.IssueSubmissionModal = IssueSubmissionModal;
})();


// ============================================================================
// FILE: IssueDetailModal.jsx
// ============================================================================
(function() {
/**
 * Issue Detail Modal for MODA Engineering Issue Tracker
 * 
 * Displays full issue details with:
 * - Status management
 * - Assignment
 * - Comment threading
 * - Photo gallery
 * - Activity history
 */
// [Removed duplicate React destructuring]
function IssueDetailModal({
  issue,
  employees = [],
  auth = {},
  onUpdate,
  onClose
}) {
  // ===== CONSTANTS =====
  const ISSUE_TYPES = window.MODA_SUPABASE_ISSUES?.ISSUE_TYPES || [{
    id: 'shop-drawing',
    label: 'Shop Drawing',
    color: '#0057B8'
  }, {
    id: 'design-conflict',
    label: 'Design Conflict',
    color: '#7C3AED'
  }, {
    id: 'material-supply',
    label: 'Material/Supply',
    color: '#EA580C'
  }, {
    id: 'quality',
    label: 'Quality Issue',
    color: '#DC2626'
  }, {
    id: 'engineering-question',
    label: 'Engineering Question',
    color: '#0891B2'
  }, {
    id: 'rfi',
    label: 'RFI Required',
    color: '#4F46E5'
  }, {
    id: 'other',
    label: 'Other',
    color: '#6B7280'
  }];
  const PRIORITY_LEVELS = window.MODA_SUPABASE_ISSUES?.PRIORITY_LEVELS || [{
    id: 'low',
    label: 'Low',
    color: '#10B981'
  }, {
    id: 'medium',
    label: 'Medium',
    color: '#F59E0B'
  }, {
    id: 'high',
    label: 'High',
    color: '#EA580C'
  }, {
    id: 'critical',
    label: 'Critical',
    color: '#DC2626'
  }];
  const ISSUE_STATUSES = window.MODA_SUPABASE_ISSUES?.ISSUE_STATUSES || [{
    id: 'open',
    label: 'Open',
    color: '#DC2626'
  }, {
    id: 'in-progress',
    label: 'In Progress',
    color: '#0057B8'
  }, {
    id: 'pending-info',
    label: 'Pending Info',
    color: '#F59E0B'
  }, {
    id: 'resolved',
    label: 'Resolved',
    color: '#10B981'
  }, {
    id: 'closed',
    label: 'Closed',
    color: '#6B7280'
  }];

  // ===== STATE =====
  const [activeTab, setActiveTab] = useState('details');
  const [newComment, setNewComment] = useState('');
  const [commentPhotos, setCommentPhotos] = useState([]);
  const [isSubmittingComment, setIsSubmittingComment] = useState(false);
  const [isUpdating, setIsUpdating] = useState(false);
  const [showStatusMenu, setShowStatusMenu] = useState(false);
  const [showAssignMenu, setShowAssignMenu] = useState(false);
  const [selectedPhoto, setSelectedPhoto] = useState(null);
  const [resolutionNote, setResolutionNote] = useState('');

  // Edit mode state
  const [isEditMode, setIsEditMode] = useState(false);
  const [editForm, setEditForm] = useState({
    title: issue?.title || '',
    description: issue?.description || '',
    priority: issue?.priority || 'medium'
  });
  const modalRef = useRef(null);
  const commentInputRef = useRef(null);
  const fileInputRef = useRef(null);

  // Get current user info
  const currentUser = {
    id: auth.userId || window.MODA_SUPABASE?.userProfile?.id || null,
    name: auth.userName || window.MODA_SUPABASE?.userProfile?.name || window.MODA_SUPABASE?.userProfile?.email?.split('@')[0] || 'Unknown User'
  };

  // Check if user can edit
  const canEdit = auth.canEdit || window.canUserEditTab?.('engineering') || false;

  // ===== EFFECTS =====
  useEffect(() => {
    const handleEscape = e => {
      if (e.key === 'Escape') {
        if (selectedPhoto) {
          setSelectedPhoto(null);
        } else {
          onClose();
        }
      }
    };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [onClose, selectedPhoto]);
  useEffect(() => {
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = '';
    };
  }, []);

  // ===== HELPERS =====
  const getStatusColor = status => {
    const found = ISSUE_STATUSES.find(s => s.id === status);
    return found?.color || '#6B7280';
  };
  const getPriorityColor = priority => {
    const found = PRIORITY_LEVELS.find(p => p.id === priority);
    return found?.color || '#6B7280';
  };
  const getTypeInfo = typeId => {
    return ISSUE_TYPES.find(t => t.id === typeId) || {
      label: typeId,
      color: '#6B7280'
    };
  };
  const formatDateTime = dateStr => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  };
  const getTimeAgo = dateStr => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  };

  // ===== HANDLERS =====
  const handleStatusChange = async newStatus => {
    if (!canEdit) return;
    setIsUpdating(true);
    setShowStatusMenu(false);
    try {
      let updates;
      if (window.MODA_SUPABASE_ISSUES?.issues) {
        updates = await window.MODA_SUPABASE_ISSUES.issues.updateStatus(issue.id, newStatus, currentUser.id, currentUser.name, newStatus === 'resolved' || newStatus === 'closed' ? resolutionNote : '');
      } else {
        // localStorage fallback
        const now = new Date().toISOString();
        updates = {
          ...issue,
          status: newStatus,
          updated_at: now,
          status_history: [...(issue.status_history || []), {
            status: newStatus,
            changed_by: currentUser.name,
            changed_by_id: currentUser.id,
            timestamp: now,
            note: newStatus === 'resolved' || newStatus === 'closed' ? resolutionNote : `Status changed to ${newStatus}`
          }]
        };
        if (newStatus === 'resolved' || newStatus === 'closed') {
          updates.resolved_at = now;
          updates.resolved_by = currentUser.name;
          updates.resolved_by_id = currentUser.id;
          if (resolutionNote) updates.resolution_notes = resolutionNote;
        }

        // Update localStorage
        const stored = JSON.parse(localStorage.getItem('moda_engineering_issues') || '[]');
        const idx = stored.findIndex(i => i.id === issue.id);
        if (idx !== -1) {
          stored[idx] = updates;
          localStorage.setItem('moda_engineering_issues', JSON.stringify(stored));
        }
      }
      onUpdate(updates);
      setResolutionNote('');
    } catch (err) {
      console.error('Error updating status:', err);
      alert('Failed to update status: ' + err.message);
    } finally {
      setIsUpdating(false);
    }
  };

  // Handle saving issue edits
  const handleSaveEdit = async () => {
    if (!canEdit) return;

    // Check if anything changed
    const hasChanges = editForm.title !== issue.title || editForm.description !== issue.description || editForm.priority !== issue.priority;
    if (!hasChanges) {
      setIsEditMode(false);
      return;
    }
    setIsUpdating(true);
    try {
      const now = new Date().toISOString();

      // Build edit history entry
      const editEntry = {
        edited_by: currentUser.name,
        edited_by_id: currentUser.id,
        timestamp: now,
        changes: []
      };
      if (editForm.title !== issue.title) {
        editEntry.changes.push({
          field: 'title',
          from: issue.title,
          to: editForm.title
        });
      }
      if (editForm.description !== issue.description) {
        editEntry.changes.push({
          field: 'description',
          from: issue.description,
          to: editForm.description
        });
      }
      if (editForm.priority !== issue.priority) {
        editEntry.changes.push({
          field: 'priority',
          from: issue.priority,
          to: editForm.priority
        });
      }
      let updates;
      if (window.MODA_SUPABASE_ISSUES?.issues?.update) {
        // Supabase update
        updates = await window.MODA_SUPABASE_ISSUES.issues.update(issue.id, {
          title: editForm.title,
          description: editForm.description,
          priority: editForm.priority,
          edit_history: [...(issue.edit_history || []), editEntry]
        });
      } else {
        // localStorage fallback
        updates = {
          ...issue,
          title: editForm.title,
          description: editForm.description,
          priority: editForm.priority,
          updated_at: now,
          edit_history: [...(issue.edit_history || []), editEntry]
        };
        const stored = JSON.parse(localStorage.getItem('moda_engineering_issues') || '[]');
        const idx = stored.findIndex(i => i.id === issue.id);
        if (idx !== -1) {
          stored[idx] = updates;
          localStorage.setItem('moda_engineering_issues', JSON.stringify(stored));
        }
      }
      onUpdate(updates);
      setIsEditMode(false);
    } catch (err) {
      console.error('Error saving edit:', err);
      alert('Failed to save changes: ' + err.message);
    } finally {
      setIsUpdating(false);
    }
  };

  // Cancel edit and reset form
  const handleCancelEdit = () => {
    setEditForm({
      title: issue?.title || '',
      description: issue?.description || '',
      priority: issue?.priority || 'medium'
    });
    setIsEditMode(false);
  };
  const handleAssign = async employeeId => {
    if (!canEdit) return;
    setIsUpdating(true);
    setShowAssignMenu(false);
    const employee = employees.find(e => e.id === employeeId);
    const assigneeName = employee ? `${employee.firstName || ''} ${employee.lastName || ''}`.trim() : '';
    try {
      let updates;
      if (window.MODA_SUPABASE_ISSUES?.issues) {
        updates = await window.MODA_SUPABASE_ISSUES.issues.assignTo(issue.id, employeeId, assigneeName, currentUser.name, currentUser.id);
      } else {
        // localStorage fallback
        const now = new Date().toISOString();
        updates = {
          ...issue,
          assigned_to: assigneeName,
          assigned_to_id: employeeId,
          updated_at: now,
          status: issue.status === 'open' ? 'in-progress' : issue.status,
          status_history: [...(issue.status_history || []), {
            status: issue.status === 'open' ? 'in-progress' : issue.status,
            changed_by: currentUser.name,
            changed_by_id: currentUser.id,
            timestamp: now,
            note: `Assigned to ${assigneeName}`
          }]
        };
        const stored = JSON.parse(localStorage.getItem('moda_engineering_issues') || '[]');
        const idx = stored.findIndex(i => i.id === issue.id);
        if (idx !== -1) {
          stored[idx] = updates;
          localStorage.setItem('moda_engineering_issues', JSON.stringify(stored));
        }
      }
      onUpdate(updates);
    } catch (err) {
      console.error('Error assigning issue:', err);
      alert('Failed to assign issue: ' + err.message);
    } finally {
      setIsUpdating(false);
    }
  };
  const handleAddComment = async () => {
    if (!newComment.trim()) return;
    setIsSubmittingComment(true);
    try {
      const commentData = {
        user_id: currentUser.id,
        user_name: currentUser.name,
        message: newComment.trim(),
        photo_urls: commentPhotos
      };
      let updates;
      if (window.MODA_SUPABASE_ISSUES?.issues) {
        updates = await window.MODA_SUPABASE_ISSUES.issues.addComment(issue.id, commentData);
      } else {
        // localStorage fallback
        const now = new Date().toISOString();
        const comment = {
          id: `comment-${Date.now()}`,
          ...commentData,
          timestamp: now
        };
        updates = {
          ...issue,
          comments: [...(issue.comments || []), comment],
          updated_at: now
        };
        const stored = JSON.parse(localStorage.getItem('moda_engineering_issues') || '[]');
        const idx = stored.findIndex(i => i.id === issue.id);
        if (idx !== -1) {
          stored[idx] = updates;
          localStorage.setItem('moda_engineering_issues', JSON.stringify(stored));
        }
      }
      onUpdate(updates);
      setNewComment('');
      setCommentPhotos([]);
    } catch (err) {
      console.error('Error adding comment:', err);
      alert('Failed to add comment: ' + err.message);
    } finally {
      setIsSubmittingComment(false);
    }
  };
  const handleCommentPhotoCapture = async e => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    const remaining = 3 - commentPhotos.length;
    const filesToProcess = files.slice(0, remaining);
    for (const file of filesToProcess) {
      try {
        let compressed;
        if (window.compressPhoto) {
          compressed = await window.compressPhoto(file, {
            maxWidth: 1200,
            quality: 0.8
          });
        } else {
          compressed = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }
        setCommentPhotos(prev => [...prev, compressed]);
      } catch (err) {
        console.error('Error processing photo:', err);
      }
    }
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };
  const handleBackdropClick = e => {
    if (e.target === modalRef.current) {
      onClose();
    }
  };

  // ===== RENDER =====
  const typeInfo = getTypeInfo(issue.issue_type);
  const statusInfo = ISSUE_STATUSES.find(s => s.id === issue.status) || {
    label: issue.status,
    color: '#6B7280'
  };
  const priorityInfo = PRIORITY_LEVELS.find(p => p.id === issue.priority) || {
    label: issue.priority,
    color: '#6B7280'
  };
  return /*#__PURE__*/React.createElement("div", {
    ref: modalRef,
    onClick: handleBackdropClick,
    className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-b border-gray-200 bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-mono text-sm text-gray-500 bg-gray-200 px-2 py-1 rounded"
  }, issue.issue_display_id), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 rounded text-xs font-medium",
    style: {
      backgroundColor: `${statusInfo.color}15`,
      color: statusInfo.color
    }
  }, statusInfo.label), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 rounded text-xs font-medium",
    style: {
      backgroundColor: `${priorityInfo.color}15`,
      color: priorityInfo.color
    }
  }, priorityInfo.label, " Priority"), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 rounded text-xs font-medium",
    style: {
      backgroundColor: `${typeInfo.color}15`,
      color: typeInfo.color
    }
  }, typeInfo.label)), /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, issue.title || issue.description?.substring(0, 60) || 'Untitled Issue')), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-200 rounded-lg transition-colors ml-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '20px',
      height: '20px',
      display: 'block'
    }
  })))), /*#__PURE__*/React.createElement("div", {
    className: "border-b border-gray-200 px-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-6"
  }, [{
    id: 'details',
    label: 'Details'
  }, {
    id: 'comments',
    label: `Comments (${issue.comments?.length || 0})`
  }, {
    id: 'history',
    label: 'History'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveTab(tab.id),
    className: `py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`
  }, tab.label)))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-y-auto"
  }, activeTab === 'details' && /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 lg:grid-cols-3 gap-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "lg:col-span-2 space-y-6"
  }, canEdit && !isEditMode && issue.status !== 'closed' && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsEditMode(true),
    className: "px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-edit w-4 h-4"
  }), "Edit Issue")), isEditMode ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Title"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editForm.title,
    onChange: e => setEditForm(prev => ({
      ...prev,
      title: e.target.value
    })),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
    placeholder: "Issue title..."
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description"), /*#__PURE__*/React.createElement("textarea", {
    value: editForm.description,
    onChange: e => setEditForm(prev => ({
      ...prev,
      description: e.target.value
    })),
    rows: 4,
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",
    placeholder: "Describe the issue..."
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Priority"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, PRIORITY_LEVELS.map(level => /*#__PURE__*/React.createElement("button", {
    key: level.id,
    type: "button",
    onClick: () => setEditForm(prev => ({
      ...prev,
      priority: level.id
    })),
    className: `px-3 py-1.5 rounded-lg border-2 text-sm font-medium transition ${editForm.priority === level.id ? 'border-current' : 'border-gray-200 hover:border-gray-300'}`,
    style: {
      borderColor: editForm.priority === level.id ? level.color : undefined,
      backgroundColor: editForm.priority === level.id ? `${level.color}15` : undefined,
      color: level.color
    }
  }, level.label)))), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-end gap-2 pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleCancelEdit,
    disabled: isUpdating,
    className: "px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveEdit,
    disabled: isUpdating,
    className: "px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition disabled:opacity-50"
  }, isUpdating ? 'Saving...' : 'Save Changes'))) :
  /*#__PURE__*/
  /* Description (View Mode) */
  React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-gray-500 mb-2"
  }, "Description"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-900 whitespace-pre-wrap"
  }, issue.description || 'No description provided')), issue.photo_urls?.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-gray-500 mb-2"
  }, "Photos (", issue.photo_urls.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-2"
  }, issue.photo_urls.map((photo, idx) => /*#__PURE__*/React.createElement("button", {
    key: idx,
    onClick: () => setSelectedPhoto(photo),
    className: "aspect-square rounded-lg overflow-hidden hover:opacity-90 transition-opacity"
  }, /*#__PURE__*/React.createElement("img", {
    src: photo,
    alt: `Photo ${idx + 1}`,
    className: "w-full h-full object-cover"
  }))))), issue.resolution_notes && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-green-50 border border-green-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-green-800 mb-1"
  }, "Resolution Notes"), /*#__PURE__*/React.createElement("p", {
    className: "text-green-900"
  }, issue.resolution_notes))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-gray-700 mb-3"
  }, "Context"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 text-sm"
  }, issue.project_name && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Project"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, issue.project_name)), issue.blm_id && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Module"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, issue.blm_id)), issue.unit_type && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Unit Type"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, issue.unit_type)), issue.department && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Department"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, issue.department)), issue.stage && /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Stage"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, issue.stage)))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-gray-700"
  }, "Assigned To"), canEdit && /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAssignMenu(!showAssignMenu),
    className: "text-xs text-blue-600 hover:text-blue-800"
  }, "Change"), showAssignMenu && /*#__PURE__*/React.createElement("div", {
    className: "absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10 max-h-60 overflow-y-auto"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleAssign(null),
    className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-100 text-gray-500"
  }, "Unassigned"), employees.map(e => /*#__PURE__*/React.createElement("button", {
    key: e.id,
    onClick: () => handleAssign(e.id),
    className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-100"
  }, e.firstName, " ", e.lastName))))), /*#__PURE__*/React.createElement("p", {
    className: `text-sm ${issue.assigned_to ? 'text-gray-900 font-medium' : 'text-gray-400 italic'}`
  }, issue.assigned_to || 'Unassigned')), canEdit && issue.status !== 'closed' && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-medium text-gray-700 mb-3"
  }, "Actions"), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowStatusMenu(!showStatusMenu),
    disabled: isUpdating,
    className: "w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-left hover:bg-gray-50 disabled:opacity-50"
  }, "Change Status..."), showStatusMenu && /*#__PURE__*/React.createElement("div", {
    className: "absolute left-0 top-full mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 z-10"
  }, ISSUE_STATUSES.filter(s => s.id !== issue.status).map(status => /*#__PURE__*/React.createElement("button", {
    key: status.id,
    onClick: () => handleStatusChange(status.id),
    className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-100 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-2 h-2 rounded-full",
    style: {
      backgroundColor: status.color
    }
  }), status.label)))), (issue.status === 'in-progress' || issue.status === 'pending-info') && /*#__PURE__*/React.createElement("div", {
    className: "mt-3"
  }, /*#__PURE__*/React.createElement("textarea", {
    value: resolutionNote,
    onChange: e => setResolutionNote(e.target.value),
    placeholder: "Resolution notes (optional)...",
    rows: 2,
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 space-y-1"
  }, /*#__PURE__*/React.createElement("div", null, "Created: ", formatDateTime(issue.created_at)), /*#__PURE__*/React.createElement("div", null, "By: ", issue.submitted_by), issue.updated_at !== issue.created_at && /*#__PURE__*/React.createElement("div", null, "Updated: ", formatDateTime(issue.updated_at)), issue.resolved_at && /*#__PURE__*/React.createElement("div", null, "Resolved: ", formatDateTime(issue.resolved_at), " by ", issue.resolved_by))))), activeTab === 'comments' && /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mb-6 bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("textarea", {
    ref: commentInputRef,
    value: newComment,
    onChange: e => setNewComment(e.target.value),
    placeholder: "Add a comment...",
    rows: 3,
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
  }), commentPhotos.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mt-2"
  }, commentPhotos.map((photo, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "relative w-16 h-16"
  }, /*#__PURE__*/React.createElement("img", {
    src: photo,
    alt: `Photo ${idx + 1}`,
    className: "w-full h-full object-cover rounded"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => setCommentPhotos(prev => prev.filter((_, i) => i !== idx)),
    className: "absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs"
  }, "X")))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mt-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("input", {
    ref: fileInputRef,
    type: "file",
    accept: "image/*",
    multiple: true,
    onChange: handleCommentPhotoCapture,
    className: "hidden"
  }), commentPhotos.length < 3 && /*#__PURE__*/React.createElement("button", {
    onClick: () => fileInputRef.current?.click(),
    className: "text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-camera",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Add Photo")), /*#__PURE__*/React.createElement("button", {
    onClick: handleAddComment,
    disabled: !newComment.trim() || isSubmittingComment,
    className: "px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
  }, isSubmittingComment ? 'Posting...' : 'Post Comment'))), issue.comments?.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, [...issue.comments].reverse().map(comment => /*#__PURE__*/React.createElement("div", {
    key: comment.id,
    className: "border-b border-gray-100 pb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-medium text-sm"
  }, comment.user_name?.charAt(0)?.toUpperCase() || '?'), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, comment.user_name), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400 text-sm ml-2"
  }, getTimeAgo(comment.timestamp)))), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-700 ml-10 whitespace-pre-wrap"
  }, comment.message), comment.photo_urls?.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mt-2 ml-10"
  }, comment.photo_urls.map((photo, idx) => /*#__PURE__*/React.createElement("button", {
    key: idx,
    onClick: () => setSelectedPhoto(photo),
    className: "w-20 h-20 rounded overflow-hidden"
  }, /*#__PURE__*/React.createElement("img", {
    src: photo,
    alt: `Photo ${idx + 1}`,
    className: "w-full h-full object-cover"
  }))))))) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, "No comments yet. Be the first to comment!")), activeTab === 'history' && /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, issue.status_history?.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("div", {
    className: "absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"
  }), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, [...issue.status_history].reverse().map((entry, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "relative pl-10"
  }, /*#__PURE__*/React.createElement("div", {
    className: "absolute left-2 w-5 h-5 rounded-full border-2 border-white",
    style: {
      backgroundColor: getStatusColor(entry.status)
    }
  }), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-900"
  }, ISSUE_STATUSES.find(s => s.id === entry.status)?.label || entry.status), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, formatDateTime(entry.timestamp))), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, entry.note), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 mt-1"
  }, "by ", entry.changed_by)))))) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, "No history available"))), /*#__PURE__*/React.createElement("div", {
    className: "px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
  }, "Close"))), selectedPhoto && /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 z-60 bg-black bg-opacity-90 flex items-center justify-center p-4",
    onClick: () => setSelectedPhoto(null)
  }, /*#__PURE__*/React.createElement("img", {
    src: selectedPhoto,
    alt: "Full size",
    className: "max-w-full max-h-full object-contain",
    onClick: e => e.stopPropagation()
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => setSelectedPhoto(null),
    className: "absolute top-4 right-4 p-2 bg-white rounded-full hover:bg-gray-100"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '24px',
      height: '24px',
      display: 'block'
    }
  }))));
}

// Export to window for global access
window.IssueDetailModal = IssueDetailModal;
})();


// ============================================================================
// FILE: EngineeringModule.jsx
// ============================================================================
(function() {
/**
 * Engineering Module for MODA
 * 
 * Main dashboard for Engineering Issue Tracker.
 * Allows Production to report issues to Engineering, Supply Chain, etc.
 * Features: Issue submission, dashboard view, filtering, assignment, comments.
 */
// [Removed duplicate React destructuring]
function EngineeringModule({
  projects = [],
  employees = [],
  auth = {}
}) {
  // ===== STATE =====
  const [issues, setIssues] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // UI State
  const [activeTab, setActiveTab] = useState('all');
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [selectedIssue, setSelectedIssue] = useState(null);
  const [createContext, setCreateContext] = useState(null);

  // Filters
  const [filters, setFilters] = useState({
    search: '',
    priority: '',
    issueType: '',
    project: '',
    assignedTo: ''
  });

  // Sort
  const [sortBy, setSortBy] = useState('created_at');
  const [sortOrder, setSortOrder] = useState('desc');

  // ===== CONSTANTS =====
  const ISSUE_TYPES = window.MODA_SUPABASE_ISSUES?.ISSUE_TYPES || [{
    id: 'shop-drawing',
    label: 'Shop Drawing',
    color: '#0057B8'
  }, {
    id: 'design-conflict',
    label: 'Design Conflict',
    color: '#7C3AED'
  }, {
    id: 'material-supply',
    label: 'Material/Supply',
    color: '#EA580C'
  }, {
    id: 'quality',
    label: 'Quality Issue',
    color: '#DC2626'
  }, {
    id: 'engineering-question',
    label: 'Engineering Question',
    color: '#0891B2'
  }, {
    id: 'rfi',
    label: 'RFI Required',
    color: '#4F46E5'
  }, {
    id: 'other',
    label: 'Other',
    color: '#6B7280'
  }];
  const PRIORITY_LEVELS = window.MODA_SUPABASE_ISSUES?.PRIORITY_LEVELS || [{
    id: 'low',
    label: 'Low',
    color: '#10B981'
  }, {
    id: 'medium',
    label: 'Medium',
    color: '#F59E0B'
  }, {
    id: 'high',
    label: 'High',
    color: '#EA580C'
  }, {
    id: 'critical',
    label: 'Critical',
    color: '#DC2626'
  }];
  const ISSUE_STATUSES = window.MODA_SUPABASE_ISSUES?.ISSUE_STATUSES || [{
    id: 'open',
    label: 'Open',
    color: '#DC2626'
  }, {
    id: 'in-progress',
    label: 'In Progress',
    color: '#0057B8'
  }, {
    id: 'pending-info',
    label: 'Pending Info',
    color: '#F59E0B'
  }, {
    id: 'resolved',
    label: 'Resolved',
    color: '#10B981'
  }, {
    id: 'closed',
    label: 'Closed',
    color: '#6B7280'
  }];
  const COLORS = {
    red: '#C8102E',
    blue: '#0057B8',
    charcoal: '#2D3436',
    navy: '#1a365d'
  };

  // ===== DATA LOADING =====
  useEffect(() => {
    // Wait for Supabase to initialize before loading
    const waitForSupabaseAndLoad = async () => {
      // Give Supabase a moment to initialize (it's async)
      let attempts = 0;
      const maxAttempts = 10;
      while (attempts < maxAttempts) {
        if (window.MODA_SUPABASE?.isInitialized) {
          console.log('[Engineering] Supabase ready, loading issues...');
          break;
        }
        attempts++;
        console.log('[Engineering] Waiting for Supabase initialization... attempt', attempts);
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      loadIssues();
    };
    waitForSupabaseAndLoad();

    // Listen for storage changes (when issues are added from other components)
    const handleStorageChange = e => {
      if (e.key === 'moda_engineering_issues') {
        console.log('[Engineering] Storage changed, reloading issues');
        loadIssues();
      }
    };

    // Also listen for custom event (for same-tab updates)
    const handleIssueUpdate = () => {
      console.log('[Engineering] Issue update event received, reloading');
      loadIssues();
    };
    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('moda-issues-updated', handleIssueUpdate);
    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('moda-issues-updated', handleIssueUpdate);
    };
  }, []);
  const loadIssues = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Debug: Check Supabase state
      console.log('[Engineering] Checking Supabase state:', {
        MODA_SUPABASE: !!window.MODA_SUPABASE,
        isInitialized: window.MODA_SUPABASE?.isInitialized,
        MODA_SUPABASE_ISSUES: !!window.MODA_SUPABASE_ISSUES,
        isAvailable: window.MODA_SUPABASE_ISSUES?.isAvailable?.()
      });

      // Try Supabase first (primary source for multi-user sync)
      if (window.MODA_SUPABASE_ISSUES?.isAvailable?.()) {
        console.log('[Engineering] Loading issues from Supabase...');
        try {
          const data = await window.MODA_SUPABASE_ISSUES.issues.getAll();
          console.log('[Engineering] Loaded', data?.length || 0, 'issues from Supabase');

          // If Supabase returns empty, also check localStorage (hybrid mode)
          // This handles the case where issues were created when Supabase was unavailable
          if (!data || data.length === 0) {
            const localIssues = loadFromLocalStorageSync();
            if (localIssues.length > 0) {
              console.log('[Engineering] Supabase empty, using', localIssues.length, 'issues from localStorage');
              setIssues(localIssues);
              return;
            }
          }
          setIssues(data || []);
        } catch (supabaseErr) {
          console.error('[Engineering] Supabase getAll failed:', supabaseErr);
          // Fall back to localStorage on Supabase error
          console.log('[Engineering] Falling back to localStorage due to Supabase error');
          loadFromLocalStorage();
        }
      } else {
        // Fallback to localStorage (offline mode)
        console.log('[Engineering] Supabase not available, using localStorage fallback');
        loadFromLocalStorage();
      }
    } catch (err) {
      console.error('[Engineering] Error loading issues:', err);
      setError('Failed to load issues');
      setIssues([]);
    } finally {
      setIsLoading(false);
    }
  };

  // Sync version that returns data instead of setting state (for hybrid mode check)
  const loadFromLocalStorageSync = () => {
    const stored = localStorage.getItem('moda_engineering_issues');
    if (stored && stored !== 'undefined' && stored !== 'null') {
      try {
        return JSON.parse(stored);
      } catch (parseErr) {
        console.error('[Engineering] Error parsing localStorage:', parseErr);
        return [];
      }
    }
    return [];
  };
  const loadFromLocalStorage = () => {
    const issues = loadFromLocalStorageSync();
    console.log('[Engineering] Loaded', issues.length, 'issues from localStorage');
    setIssues(issues);
  };

  // ===== STATISTICS =====
  const stats = useMemo(() => {
    const activeIssues = issues.filter(i => i.status !== 'closed');
    return {
      total: issues.length,
      open: issues.filter(i => i.status === 'open').length,
      inProgress: issues.filter(i => i.status === 'in-progress').length,
      pendingInfo: issues.filter(i => i.status === 'pending-info').length,
      resolved: issues.filter(i => i.status === 'resolved').length,
      closed: issues.filter(i => i.status === 'closed').length,
      critical: activeIssues.filter(i => i.priority === 'critical').length,
      high: activeIssues.filter(i => i.priority === 'high').length
    };
  }, [issues]);

  // ===== FILTERED & SORTED ISSUES =====
  const filteredIssues = useMemo(() => {
    let result = [...issues];

    // Tab filter
    if (activeTab === 'open') {
      result = result.filter(i => i.status === 'open');
    } else if (activeTab === 'in-progress') {
      result = result.filter(i => i.status === 'in-progress' || i.status === 'pending-info');
    } else if (activeTab === 'resolved') {
      result = result.filter(i => i.status === 'resolved' || i.status === 'closed');
    } else if (activeTab === 'my-issues') {
      const userId = auth.userId || window.MODA_SUPABASE?.userProfile?.id;
      result = result.filter(i => i.assigned_to_id === userId || i.submitted_by_id === userId);
    }

    // Search filter
    if (filters.search) {
      const search = filters.search.toLowerCase();
      result = result.filter(i => (i.issue_display_id || '').toLowerCase().includes(search) || (i.title || '').toLowerCase().includes(search) || (i.description || '').toLowerCase().includes(search) || (i.blm_id || '').toLowerCase().includes(search) || (i.project_name || '').toLowerCase().includes(search));
    }

    // Priority filter
    if (filters.priority) {
      result = result.filter(i => i.priority === filters.priority);
    }

    // Type filter
    if (filters.issueType) {
      result = result.filter(i => i.issue_type === filters.issueType);
    }

    // Project filter
    if (filters.project) {
      result = result.filter(i => i.project_id === filters.project);
    }

    // Assigned to filter
    if (filters.assignedTo) {
      result = result.filter(i => i.assigned_to_id === filters.assignedTo);
    }

    // Sort
    result.sort((a, b) => {
      let aVal, bVal;
      if (sortBy === 'priority') {
        const priorityOrder = {
          critical: 0,
          high: 1,
          medium: 2,
          low: 3
        };
        aVal = priorityOrder[a.priority] ?? 99;
        bVal = priorityOrder[b.priority] ?? 99;
      } else if (sortBy === 'created_at' || sortBy === 'updated_at') {
        aVal = new Date(a[sortBy] || 0);
        bVal = new Date(b[sortBy] || 0);
      } else {
        aVal = a[sortBy] || '';
        bVal = b[sortBy] || '';
      }
      if (sortOrder === 'asc') {
        return aVal > bVal ? 1 : -1;
      }
      return aVal < bVal ? 1 : -1;
    });
    return result;
  }, [issues, activeTab, filters, sortBy, sortOrder, auth.userId]);

  // ===== HANDLERS =====
  const handleCreateIssue = (context = null) => {
    setCreateContext(context);
    setShowCreateModal(true);
  };
  const handleIssueCreated = async newIssue => {
    try {
      if (window.MODA_SUPABASE_ISSUES?.issues) {
        const created = await window.MODA_SUPABASE_ISSUES.issues.create(newIssue);
        setIssues(prev => [created, ...prev]);
      } else {
        // localStorage fallback
        const issueNumber = parseInt(localStorage.getItem('moda_issue_counter') || '0', 10) + 1;
        localStorage.setItem('moda_issue_counter', issueNumber.toString());
        const issue = {
          ...newIssue,
          id: `issue-${Date.now()}`,
          issue_number: issueNumber,
          issue_display_id: `ENG-${String(issueNumber).padStart(4, '0')}`,
          status: 'open',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
          comments: [],
          status_history: [{
            status: 'open',
            changed_by: newIssue.submitted_by,
            timestamp: new Date().toISOString(),
            note: 'Issue created'
          }]
        };
        const updated = [issue, ...issues];
        setIssues(updated);
        localStorage.setItem('moda_engineering_issues', JSON.stringify(updated));
      }
      setShowCreateModal(false);
      setCreateContext(null);
    } catch (err) {
      console.error('[Engineering] Error creating issue:', err);
      throw err;
    }
  };
  const handleViewIssue = issue => {
    setSelectedIssue(issue);
    setShowDetailModal(true);
  };
  const handleIssueUpdated = async updatedIssue => {
    setIssues(prev => prev.map(i => i.id === updatedIssue.id ? updatedIssue : i));
    setSelectedIssue(updatedIssue);
  };
  const handleCloseDetail = () => {
    setShowDetailModal(false);
    setSelectedIssue(null);
  };
  const clearFilters = () => {
    setFilters({
      search: '',
      priority: '',
      issueType: '',
      project: '',
      assignedTo: ''
    });
  };

  // ===== HELPERS =====
  const getStatusColor = status => {
    const found = ISSUE_STATUSES.find(s => s.id === status);
    return found?.color || '#6B7280';
  };
  const getPriorityColor = priority => {
    const found = PRIORITY_LEVELS.find(p => p.id === priority);
    return found?.color || '#6B7280';
  };
  const getTypeLabel = typeId => {
    const found = ISSUE_TYPES.find(t => t.id === typeId);
    return found?.label || typeId;
  };
  const getTimeAgo = dateStr => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  };
  const hasActiveFilters = filters.search || filters.priority || filters.issueType || filters.project || filters.assignedTo;

  // ===== RENDER =====
  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-center py-20"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-center"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-600"
    }, "Loading Engineering Issues...")));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "engineering-module"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow mb-6 p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col md:flex-row md:items-center md:justify-between gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold",
    style: {
      color: COLORS.navy
    }
  }, "Engineering Issue Tracker"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mt-1"
  }, "Track and resolve production issues with Engineering")), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleCreateIssue(),
    className: "inline-flex items-center px-4 py-2 rounded-lg text-white font-medium transition-colors",
    style: {
      backgroundColor: COLORS.blue
    },
    onMouseOver: e => e.currentTarget.style.backgroundColor = '#004494',
    onMouseOut: e => e.currentTarget.style.backgroundColor = COLORS.blue
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-plus mr-2",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block'
    }
  }), "Report Issue")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-red-50 rounded-lg p-4 border border-red-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-red-600"
  }, stats.open), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-red-700"
  }, "Open")), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 rounded-lg p-4 border border-blue-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-600"
  }, stats.inProgress), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-blue-700"
  }, "In Progress")), /*#__PURE__*/React.createElement("div", {
    className: "bg-yellow-50 rounded-lg p-4 border border-yellow-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-yellow-600"
  }, stats.pendingInfo), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-yellow-700"
  }, "Pending Info")), /*#__PURE__*/React.createElement("div", {
    className: "bg-green-50 rounded-lg p-4 border border-green-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-600"
  }, stats.resolved), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-green-700"
  }, "Resolved")), /*#__PURE__*/React.createElement("div", {
    className: "bg-orange-50 rounded-lg p-4 border border-orange-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-orange-600"
  }, stats.critical + stats.high), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-orange-700"
  }, "High Priority")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4 border border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-gray-600"
  }, stats.total), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-700"
  }, "Total Issues")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "border-b border-gray-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex overflow-x-auto"
  }, [{
    id: 'all',
    label: 'All Issues',
    count: stats.total
  }, {
    id: 'open',
    label: 'Open',
    count: stats.open
  }, {
    id: 'in-progress',
    label: 'In Progress',
    count: stats.inProgress + stats.pendingInfo
  }, {
    id: 'resolved',
    label: 'Resolved',
    count: stats.resolved + stats.closed
  }, {
    id: 'my-issues',
    label: 'My Issues',
    count: null
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setActiveTab(tab.id),
    className: `px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`
  }, tab.label, tab.count !== null && /*#__PURE__*/React.createElement("span", {
    className: `ml-2 px-2 py-0.5 rounded-full text-xs ${activeTab === tab.id ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'}`
  }, tab.count))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-[200px]"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search issues...",
    value: filters.search,
    onChange: e => setFilters(f => ({
      ...f,
      search: e.target.value
    })),
    className: "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
  })), /*#__PURE__*/React.createElement("select", {
    value: filters.priority,
    onChange: e => setFilters(f => ({
      ...f,
      priority: e.target.value
    })),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Priorities"), PRIORITY_LEVELS.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.label))), /*#__PURE__*/React.createElement("select", {
    value: filters.issueType,
    onChange: e => setFilters(f => ({
      ...f,
      issueType: e.target.value
    })),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Types"), ISSUE_TYPES.map(t => /*#__PURE__*/React.createElement("option", {
    key: t.id,
    value: t.id
  }, t.label))), /*#__PURE__*/React.createElement("select", {
    value: filters.project,
    onChange: e => setFilters(f => ({
      ...f,
      project: e.target.value
    })),
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "All Projects"), projects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name))), /*#__PURE__*/React.createElement("select", {
    value: `${sortBy}-${sortOrder}`,
    onChange: e => {
      const [by, order] = e.target.value.split('-');
      setSortBy(by);
      setSortOrder(order);
    },
    className: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: "created_at-desc"
  }, "Newest First"), /*#__PURE__*/React.createElement("option", {
    value: "created_at-asc"
  }, "Oldest First"), /*#__PURE__*/React.createElement("option", {
    value: "priority-asc"
  }, "Priority (High to Low)"), /*#__PURE__*/React.createElement("option", {
    value: "priority-desc"
  }, "Priority (Low to High)"), /*#__PURE__*/React.createElement("option", {
    value: "updated_at-desc"
  }, "Recently Updated")), hasActiveFilters && /*#__PURE__*/React.createElement("button", {
    onClick: clearFilters,
    className: "px-3 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
  }, "Clear Filters")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, filteredIssues.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-12"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-400 mb-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-inbox",
    style: {
      width: '48px',
      height: '48px',
      display: 'inline-block'
    }
  })), /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-medium text-gray-900 mb-1"
  }, "No issues found"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, hasActiveFilters ? 'Try adjusting your filters' : 'Click "Report Issue" to create the first one')) : /*#__PURE__*/React.createElement("div", {
    className: "divide-y divide-gray-200"
  }, filteredIssues.map(issue => /*#__PURE__*/React.createElement("div", {
    key: issue.id,
    onClick: () => handleViewIssue(issue),
    className: "p-4 hover:bg-gray-50 cursor-pointer transition-colors"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-1 h-16 rounded-full flex-shrink-0",
    style: {
      backgroundColor: getPriorityColor(issue.priority)
    }
  }), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-mono text-sm text-gray-500"
  }, issue.issue_display_id), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded text-xs font-medium",
    style: {
      backgroundColor: `${getStatusColor(issue.status)}15`,
      color: getStatusColor(issue.status)
    }
  }, ISSUE_STATUSES.find(s => s.id === issue.status)?.label || issue.status), /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded text-xs font-medium",
    style: {
      backgroundColor: `${getPriorityColor(issue.priority)}15`,
      color: getPriorityColor(issue.priority)
    }
  }, PRIORITY_LEVELS.find(p => p.id === issue.priority)?.label || issue.priority)), /*#__PURE__*/React.createElement("h3", {
    className: "font-medium text-gray-900 truncate"
  }, issue.title || issue.description?.substring(0, 60) || 'Untitled Issue'), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-gray-500"
  }, issue.blm_id && /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-module",
    style: {
      width: '14px',
      height: '14px',
      display: 'inline-block'
    }
  }), issue.blm_id), issue.project_name && /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-folder",
    style: {
      width: '14px',
      height: '14px',
      display: 'inline-block'
    }
  }), issue.project_name), /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-tag",
    style: {
      width: '14px',
      height: '14px',
      display: 'inline-block'
    }
  }), getTypeLabel(issue.issue_type)), /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-clock",
    style: {
      width: '14px',
      height: '14px',
      display: 'inline-block'
    }
  }), getTimeAgo(issue.created_at)))), /*#__PURE__*/React.createElement("div", {
    className: "flex-shrink-0 text-right"
  }, issue.assigned_to ? /*#__PURE__*/React.createElement("div", {
    className: "text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Assigned to"), /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-gray-900"
  }, issue.assigned_to)) : /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-400 italic"
  }, "Unassigned"), issue.comments?.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-end gap-1 mt-2 text-sm text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-message",
    style: {
      width: '14px',
      height: '14px',
      display: 'inline-block'
    }
  }), issue.comments.length))))))), showCreateModal && /*#__PURE__*/React.createElement(IssueSubmissionModal, {
    context: createContext,
    projects: projects,
    employees: employees,
    auth: auth,
    onSubmit: handleIssueCreated,
    onClose: () => {
      setShowCreateModal(false);
      setCreateContext(null);
    }
  }), showDetailModal && selectedIssue && /*#__PURE__*/React.createElement(IssueDetailModal, {
    issue: selectedIssue,
    employees: employees,
    auth: auth,
    onUpdate: handleIssueUpdated,
    onClose: handleCloseDetail
  }));
}

// Export to window for global access
window.EngineeringModule = EngineeringModule;
})();


// ============================================================================
// FILE: ProcurementBoard.jsx
// ============================================================================
(function() {
/**
 * ProcurementBoard.jsx - Procurement/Supply Chain Shortage Tracking
 * 
 * Tracks material shortages reported by production teams.
 * Allows logging shortages with impacted stations, modules, and projects.
 */

const ProcurementBoard = ({
  projects = [],
  auth
}) => {
// [Removed duplicate React destructuring]
  // ============================================================================
  // STATE
  // ============================================================================

  const [shortages, setShortages] = useState([]);
  const [issues, setIssues] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(null);
  const [showIssueDetailModal, setShowIssueDetailModal] = useState(null);
  const [filterStatus, setFilterStatus] = useState('active');
  const [filterPriority, setFilterPriority] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [activeSection, setActiveSection] = useState('shortages'); // 'shortages' or 'issues'

  // Get constants from the data layer
  const STATUSES = window.MODA_SUPABASE_PROCUREMENT?.SHORTAGE_STATUSES || [{
    id: 'open',
    label: 'Open',
    color: '#DC2626'
  }, {
    id: 'ordered',
    label: 'Ordered',
    color: '#F59E0B'
  }, {
    id: 'partial',
    label: 'Partial Delivery',
    color: '#0891B2'
  }, {
    id: 'resolved',
    label: 'Resolved',
    color: '#10B981'
  }, {
    id: 'cancelled',
    label: 'Cancelled',
    color: '#6B7280'
  }];
  const PRIORITIES = window.MODA_SUPABASE_PROCUREMENT?.PRIORITY_LEVELS || [{
    id: 'low',
    label: 'Low',
    color: '#10B981'
  }, {
    id: 'medium',
    label: 'Medium',
    color: '#F59E0B'
  }, {
    id: 'high',
    label: 'High',
    color: '#EA580C'
  }, {
    id: 'critical',
    label: 'Critical',
    color: '#DC2626'
  }];
  const UNITS = window.MODA_SUPABASE_PROCUREMENT?.UNITS_OF_MEASURE || [{
    id: 'ea',
    label: 'Each (ea)'
  }, {
    id: 'ft',
    label: 'Feet (ft)'
  }, {
    id: 'lf',
    label: 'Linear Feet (lf)'
  }, {
    id: 'sqft',
    label: 'Square Feet (sqft)'
  }, {
    id: 'lbs',
    label: 'Pounds (lbs)'
  }, {
    id: 'gal',
    label: 'Gallons (gal)'
  }, {
    id: 'box',
    label: 'Box'
  }, {
    id: 'roll',
    label: 'Roll'
  }, {
    id: 'bundle',
    label: 'Bundle'
  }, {
    id: 'pallet',
    label: 'Pallet'
  }, {
    id: 'set',
    label: 'Set'
  }, {
    id: 'kit',
    label: 'Kit'
  }];

  // Production stages from constants
  const STATIONS = window.MODA_CONSTANTS?.PRODUCTION_STAGES || [{
    id: 'auto-c',
    name: 'Auto Ceiling'
  }, {
    id: 'auto-f',
    name: 'Auto Floor'
  }, {
    id: 'auto-walls',
    name: 'Auto Walls'
  }, {
    id: 'mezzanine',
    name: 'Mezzanine'
  }, {
    id: 'elec-ceiling',
    name: 'Electrical Ceiling'
  }, {
    id: 'wall-set',
    name: 'Wall Set'
  }, {
    id: 'ceiling-set',
    name: 'Ceiling Set'
  }, {
    id: 'soffits',
    name: 'Soffits'
  }, {
    id: 'mech-rough',
    name: 'Mechanical Rough'
  }, {
    id: 'elec-rough',
    name: 'Electrical Rough'
  }, {
    id: 'plumb-rough',
    name: 'Plumbing Rough'
  }, {
    id: 'exteriors',
    name: 'Exteriors'
  }, {
    id: 'drywall-bp',
    name: 'Drywall B&P'
  }, {
    id: 'drywall-ttp',
    name: 'Drywall TTP'
  }, {
    id: 'roofing',
    name: 'Roofing'
  }, {
    id: 'pre-finish',
    name: 'Pre-Finish'
  }, {
    id: 'mech-trim',
    name: 'Mechanical Trim'
  }, {
    id: 'elec-trim',
    name: 'Electrical Trim'
  }, {
    id: 'plumb-trim',
    name: 'Plumbing Trim'
  }, {
    id: 'final-finish',
    name: 'Final Finish'
  }, {
    id: 'sign-off',
    name: 'Sign-Off'
  }, {
    id: 'close-up',
    name: 'Close-Up'
  }];

  // ============================================================================
  // COLORS
  // ============================================================================

  const COLORS = {
    charcoal: '#1a1a1a',
    red: '#cc0000',
    blue: '#0057B8',
    white: '#ffffff',
    lightGray: '#f5f5f5',
    mediumGray: '#e0e0e0',
    darkGray: '#666666'
  };

  // ============================================================================
  // DATA LOADING
  // ============================================================================

  const loadShortages = useCallback(async () => {
    try {
      setLoading(true);
      if (window.MODA_SUPABASE_PROCUREMENT?.isAvailable?.()) {
        const data = await window.MODA_SUPABASE_PROCUREMENT.shortages.getAll();
        setShortages(data);
      } else {
        const stored = localStorage.getItem('moda_shortages');
        if (stored) {
          setShortages(JSON.parse(stored));
        }
      }
    } catch (error) {
      console.error('[ProcurementBoard] Error loading shortages:', error);
    } finally {
      setLoading(false);
    }
  }, []);
  const loadIssues = useCallback(() => {
    try {
      // Load issues routed to supply-chain from the issue routing system
      if (window.MODA_ISSUE_ROUTING?.getIssuesForDashboard) {
        const supplyChainIssues = window.MODA_ISSUE_ROUTING.getIssuesForDashboard('supply-chain');
        setIssues(supplyChainIssues || []);
      } else {
        // Fallback: load directly from localStorage
        const stored = localStorage.getItem('moda_supply_chain_issues');
        if (stored && stored !== 'undefined' && stored !== 'null') {
          setIssues(JSON.parse(stored));
        }
      }
    } catch (error) {
      console.error('[ProcurementBoard] Error loading issues:', error);
    }
  }, []);
  useEffect(() => {
    loadShortages();
    loadIssues();

    // Subscribe to real-time updates if available
    if (window.MODA_SUPABASE_PROCUREMENT?.isAvailable?.()) {
      const unsubscribe = window.MODA_SUPABASE_PROCUREMENT.shortages.onSnapshot(data => setShortages(data));
      return () => unsubscribe?.();
    }

    // Listen for issue updates
    const handleIssueUpdate = e => {
      if (e.detail?.dashboard === 'supply-chain') {
        loadIssues();
      }
    };
    window.addEventListener('moda-issues-updated', handleIssueUpdate);
    return () => {
      window.removeEventListener('moda-issues-updated', handleIssueUpdate);
    };
  }, [loadShortages, loadIssues]);

  // ============================================================================
  // FILTERED DATA
  // ============================================================================

  const filteredShortages = useMemo(() => {
    return shortages.filter(s => {
      // Status filter
      if (filterStatus === 'active' && ['resolved', 'cancelled'].includes(s.status)) {
        return false;
      }
      if (filterStatus !== 'all' && filterStatus !== 'active' && s.status !== filterStatus) {
        return false;
      }

      // Priority filter
      if (filterPriority !== 'all' && s.priority !== filterPriority) {
        return false;
      }

      // Search filter
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        const matchesItem = s.item?.toLowerCase().includes(term);
        const matchesSupplier = s.supplier?.toLowerCase().includes(term);
        const matchesId = s.shortage_display_id?.toLowerCase().includes(term);
        if (!matchesItem && !matchesSupplier && !matchesId) {
          return false;
        }
      }
      return true;
    });
  }, [shortages, filterStatus, filterPriority, searchTerm]);

  // ============================================================================
  // STATS
  // ============================================================================

  const stats = useMemo(() => {
    const active = shortages.filter(s => !['resolved', 'cancelled'].includes(s.status));
    const now = new Date();
    return {
      total: shortages.length,
      active: active.length,
      critical: active.filter(s => s.priority === 'critical').length,
      high: active.filter(s => s.priority === 'high').length,
      overdue: active.filter(s => s.delivery_eta && new Date(s.delivery_eta) < now).length
    };
  }, [shortages]);

  // Issue stats
  const issueStats = useMemo(() => {
    const activeIssues = issues.filter(i => !['resolved', 'closed'].includes(i.status));
    return {
      total: issues.length,
      open: issues.filter(i => i.status === 'open').length,
      inProgress: issues.filter(i => i.status === 'in-progress').length,
      resolved: issues.filter(i => i.status === 'resolved' || i.status === 'closed').length,
      critical: activeIssues.filter(i => i.priority === 'critical').length,
      high: activeIssues.filter(i => i.priority === 'high').length
    };
  }, [issues]);

  // Filtered issues
  const filteredIssues = useMemo(() => {
    return issues.filter(issue => {
      // Status filter
      if (filterStatus === 'active' && ['resolved', 'closed'].includes(issue.status)) {
        return false;
      }
      if (filterStatus !== 'all' && filterStatus !== 'active' && issue.status !== filterStatus) {
        return false;
      }

      // Priority filter
      if (filterPriority !== 'all' && issue.priority !== filterPriority) {
        return false;
      }

      // Search filter
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        const matchesTitle = issue.title?.toLowerCase().includes(term);
        const matchesDesc = issue.description?.toLowerCase().includes(term);
        const matchesId = issue.issue_display_id?.toLowerCase().includes(term);
        const matchesBlm = issue.blm_id?.toLowerCase().includes(term);
        if (!matchesTitle && !matchesDesc && !matchesId && !matchesBlm) {
          return false;
        }
      }
      return true;
    });
  }, [issues, filterStatus, filterPriority, searchTerm]);

  // Issue status constants
  const ISSUE_STATUSES = [{
    id: 'open',
    label: 'Open',
    color: '#DC2626'
  }, {
    id: 'in-progress',
    label: 'In Progress',
    color: '#0057B8'
  }, {
    id: 'pending-info',
    label: 'Pending Info',
    color: '#F59E0B'
  }, {
    id: 'resolved',
    label: 'Resolved',
    color: '#10B981'
  }, {
    id: 'closed',
    label: 'Closed',
    color: '#6B7280'
  }];

  // ============================================================================
  // HANDLERS
  // ============================================================================

  const handleCreateShortage = async formData => {
    try {
      const userProfile = window.MODA_SUPABASE?.userProfile;
      const currentUser = window.MODA_SUPABASE?.currentUser;
      const newShortage = {
        ...formData,
        reported_by: userProfile?.name || currentUser?.email || 'Unknown',
        reported_by_id: userProfile?.id || currentUser?.id || null
      };
      if (window.MODA_SUPABASE_PROCUREMENT?.isAvailable?.()) {
        await window.MODA_SUPABASE_PROCUREMENT.shortages.create(newShortage);
      } else {
        const stored = JSON.parse(localStorage.getItem('moda_shortages') || '[]');
        const shortage = {
          ...newShortage,
          id: `shortage-${Date.now()}`,
          shortage_display_id: `SHT-${String(stored.length + 1).padStart(4, '0')}`,
          status: 'open',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        stored.unshift(shortage);
        localStorage.setItem('moda_shortages', JSON.stringify(stored));
        setShortages(stored);
      }
      setShowAddModal(false);
      loadShortages();
    } catch (error) {
      console.error('[ProcurementBoard] Error creating shortage:', error);
      alert('Failed to create shortage: ' + error.message);
    }
  };
  const handleUpdateStatus = async (shortageId, newStatus) => {
    try {
      const userProfile = window.MODA_SUPABASE?.userProfile;
      const currentUser = window.MODA_SUPABASE?.currentUser;
      if (window.MODA_SUPABASE_PROCUREMENT?.isAvailable?.()) {
        await window.MODA_SUPABASE_PROCUREMENT.shortages.updateStatus(shortageId, newStatus, userProfile?.id || currentUser?.id, userProfile?.name || currentUser?.email);
      } else {
        const stored = JSON.parse(localStorage.getItem('moda_shortages') || '[]');
        const index = stored.findIndex(s => s.id === shortageId);
        if (index !== -1) {
          stored[index].status = newStatus;
          stored[index].updated_at = new Date().toISOString();
          if (newStatus === 'resolved') {
            stored[index].resolved_at = new Date().toISOString();
            stored[index].resolved_by = userProfile?.name || currentUser?.email;
          }
          localStorage.setItem('moda_shortages', JSON.stringify(stored));
          setShortages(stored);
        }
      }
      loadShortages();
    } catch (error) {
      console.error('[ProcurementBoard] Error updating status:', error);
    }
  };
  const handleUpdateIssueStatus = (issueId, newStatus) => {
    try {
      const userProfile = window.MODA_SUPABASE?.userProfile;
      const currentUser = window.MODA_SUPABASE?.currentUser;
      const userName = userProfile?.name || currentUser?.email || 'Unknown';
      if (window.MODA_ISSUE_ROUTING?.updateIssue) {
        window.MODA_ISSUE_ROUTING.updateIssue(issueId, {
          status: newStatus,
          status_history: [...(issues.find(i => i.id === issueId)?.status_history || []), {
            status: newStatus,
            changed_by: userName,
            timestamp: new Date().toISOString()
          }]
        }, 'moda_supply_chain_issues');
        loadIssues();
      }
    } catch (error) {
      console.error('[ProcurementBoard] Error updating issue status:', error);
    }
  };

  // ============================================================================
  // STYLES
  // ============================================================================

  const styles = {
    container: {
      height: '100%',
      display: 'flex',
      flexDirection: 'column',
      background: COLORS.lightGray
    },
    header: {
      background: COLORS.charcoal,
      padding: '12px 24px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      borderBottom: `4px solid ${COLORS.red}`
    },
    headerTitle: {
      color: COLORS.white,
      fontSize: '20px',
      fontWeight: '600',
      margin: 0
    },
    statsBar: {
      display: 'flex',
      gap: '16px',
      padding: '16px 24px',
      background: COLORS.white,
      borderBottom: `1px solid ${COLORS.mediumGray}`
    },
    statCard: {
      padding: '12px 20px',
      borderRadius: '8px',
      textAlign: 'center',
      minWidth: '100px'
    },
    statValue: {
      fontSize: '24px',
      fontWeight: '700',
      margin: 0
    },
    statLabel: {
      fontSize: '12px',
      color: COLORS.darkGray,
      margin: 0
    },
    toolbar: {
      display: 'flex',
      gap: '12px',
      padding: '16px 24px',
      background: COLORS.white,
      borderBottom: `1px solid ${COLORS.mediumGray}`,
      flexWrap: 'wrap',
      alignItems: 'center'
    },
    searchInput: {
      padding: '8px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px',
      minWidth: '200px'
    },
    select: {
      padding: '8px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px',
      background: COLORS.white
    },
    addButton: {
      padding: '10px 20px',
      background: COLORS.blue,
      color: COLORS.white,
      border: 'none',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '600',
      cursor: 'pointer',
      marginLeft: 'auto'
    },
    tableContainer: {
      flex: 1,
      overflow: 'auto',
      padding: '16px 24px'
    },
    table: {
      width: '100%',
      borderCollapse: 'collapse',
      background: COLORS.white,
      borderRadius: '8px',
      overflow: 'hidden',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
    },
    th: {
      padding: '12px 16px',
      textAlign: 'left',
      background: COLORS.charcoal,
      color: COLORS.white,
      fontSize: '13px',
      fontWeight: '600',
      whiteSpace: 'nowrap'
    },
    td: {
      padding: '12px 16px',
      borderBottom: `1px solid ${COLORS.mediumGray}`,
      fontSize: '14px'
    },
    badge: {
      display: 'inline-block',
      padding: '4px 10px',
      borderRadius: '12px',
      fontSize: '12px',
      fontWeight: '600'
    },
    actionButton: {
      padding: '6px 12px',
      border: 'none',
      borderRadius: '4px',
      fontSize: '12px',
      cursor: 'pointer',
      marginRight: '4px'
    }
  };

  // ============================================================================
  // RENDER HELPERS
  // ============================================================================

  const getStatusBadge = status => {
    const statusObj = STATUSES.find(s => s.id === status) || STATUSES[0];
    return /*#__PURE__*/React.createElement("span", {
      style: {
        ...styles.badge,
        background: `${statusObj.color}20`,
        color: statusObj.color
      }
    }, statusObj.label);
  };
  const getPriorityBadge = priority => {
    const priorityObj = PRIORITIES.find(p => p.id === priority) || PRIORITIES[1];
    return /*#__PURE__*/React.createElement("span", {
      style: {
        ...styles.badge,
        background: `${priorityObj.color}20`,
        color: priorityObj.color
      }
    }, priorityObj.label);
  };
  const formatDate = dateStr => {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };
  const getProjectNames = projectIds => {
    if (!projectIds || projectIds.length === 0) return '-';
    return projectIds.map(id => {
      const project = projects.find(p => p.id === id);
      return project?.abbreviation || project?.name || id;
    }).join(', ');
  };
  const getStationNames = stationIds => {
    if (!stationIds || stationIds.length === 0) return '-';
    return stationIds.map(id => {
      const station = STATIONS.find(s => s.id === id);
      return station?.name || id;
    }).join(', ');
  };

  // ============================================================================
  // RENDER HELPERS FOR ISSUES
  // ============================================================================

  const getIssueStatusBadge = status => {
    const statusObj = ISSUE_STATUSES.find(s => s.id === status) || ISSUE_STATUSES[0];
    return /*#__PURE__*/React.createElement("span", {
      style: {
        ...styles.badge,
        background: `${statusObj.color}20`,
        color: statusObj.color
      }
    }, statusObj.label);
  };
  const getIssueTypeBadge = issueType => {
    const typeColors = {
      'material-supply': '#EA580C',
      'quality': '#DC2626',
      'shop-drawing': '#0057B8',
      'design-conflict': '#7C3AED',
      'engineering-question': '#0891B2',
      'rfi': '#4F46E5',
      'other': '#6B7280'
    };
    const typeLabels = {
      'material-supply': 'Material/Supply',
      'quality': 'Quality Issue',
      'shop-drawing': 'Shop Drawing',
      'design-conflict': 'Design Conflict',
      'engineering-question': 'Engineering Question',
      'rfi': 'RFI Required',
      'other': 'Other'
    };
    const color = typeColors[issueType] || '#6B7280';
    const label = typeLabels[issueType] || issueType;
    return /*#__PURE__*/React.createElement("span", {
      style: {
        ...styles.badge,
        background: `${color}20`,
        color: color
      }
    }, label);
  };

  // ============================================================================
  // RENDER
  // ============================================================================

  return /*#__PURE__*/React.createElement("div", {
    style: styles.container
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.header
  }, /*#__PURE__*/React.createElement("h1", {
    style: styles.headerTitle
  }, "Supply Chain Board")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      background: COLORS.white,
      borderBottom: `1px solid ${COLORS.mediumGray}`
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveSection('shortages'),
    style: {
      padding: '14px 24px',
      border: 'none',
      background: activeSection === 'shortages' ? COLORS.white : '#f5f5f5',
      borderBottom: activeSection === 'shortages' ? `3px solid ${COLORS.blue}` : '3px solid transparent',
      fontSize: '14px',
      fontWeight: activeSection === 'shortages' ? '600' : '400',
      color: activeSection === 'shortages' ? COLORS.blue : COLORS.darkGray,
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    }
  }, "Shortages", stats.active > 0 && /*#__PURE__*/React.createElement("span", {
    style: {
      background: '#DC2626',
      color: 'white',
      padding: '2px 8px',
      borderRadius: '10px',
      fontSize: '12px',
      fontWeight: '600'
    }
  }, stats.active)), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveSection('issues'),
    style: {
      padding: '14px 24px',
      border: 'none',
      background: activeSection === 'issues' ? COLORS.white : '#f5f5f5',
      borderBottom: activeSection === 'issues' ? `3px solid ${COLORS.blue}` : '3px solid transparent',
      fontSize: '14px',
      fontWeight: activeSection === 'issues' ? '600' : '400',
      color: activeSection === 'issues' ? COLORS.blue : COLORS.darkGray,
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    }
  }, "Issues", issueStats.open > 0 && /*#__PURE__*/React.createElement("span", {
    style: {
      background: '#EA580C',
      color: 'white',
      padding: '2px 8px',
      borderRadius: '10px',
      fontSize: '12px',
      fontWeight: '600'
    }
  }, issueStats.open))), activeSection === 'shortages' && /*#__PURE__*/React.createElement("div", {
    style: styles.statsBar
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#f0f9ff'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: COLORS.blue
    }
  }, stats.active), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "Active Shortages")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#fef2f2'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#DC2626'
    }
  }, stats.critical), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "Critical")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#fff7ed'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#EA580C'
    }
  }, stats.high), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "High Priority")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#fefce8'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#CA8A04'
    }
  }, stats.overdue), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "Overdue"))), activeSection === 'issues' && /*#__PURE__*/React.createElement("div", {
    style: styles.statsBar
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#fef2f2'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#DC2626'
    }
  }, issueStats.open), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "Open Issues")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#f0f9ff'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: COLORS.blue
    }
  }, issueStats.inProgress), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "In Progress")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#f0fdf4'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#10B981'
    }
  }, issueStats.resolved), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "Resolved")), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.statCard,
      background: '#fff7ed'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      ...styles.statValue,
      color: '#EA580C'
    }
  }, issueStats.critical + issueStats.high), /*#__PURE__*/React.createElement("p", {
    style: styles.statLabel
  }, "High/Critical"))), /*#__PURE__*/React.createElement("div", {
    style: styles.toolbar
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: activeSection === 'shortages' ? "Search items, suppliers..." : "Search issues...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    style: styles.searchInput
  }), /*#__PURE__*/React.createElement("select", {
    value: filterStatus,
    onChange: e => setFilterStatus(e.target.value),
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: "active"
  }, "Active Only"), /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Statuses"), activeSection === 'shortages' ? STATUSES.map(s => /*#__PURE__*/React.createElement("option", {
    key: s.id,
    value: s.id
  }, s.label)) : ISSUE_STATUSES.map(s => /*#__PURE__*/React.createElement("option", {
    key: s.id,
    value: s.id
  }, s.label))), /*#__PURE__*/React.createElement("select", {
    value: filterPriority,
    onChange: e => setFilterPriority(e.target.value),
    style: styles.select
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Priorities"), PRIORITIES.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.label))), activeSection === 'shortages' && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddModal(true),
    style: styles.addButton
  }, "+ Add Shortage")), activeSection === 'shortages' && /*#__PURE__*/React.createElement("div", {
    style: styles.tableContainer
  }, loading ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: COLORS.darkGray
    }
  }, "Loading shortages...") : filteredShortages.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: COLORS.darkGray
    }
  }, "No shortages found. Click \"Add Shortage\" to report one.") : /*#__PURE__*/React.createElement("table", {
    style: styles.table
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "ID"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Item"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Qty"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Supplier"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "ETA"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Projects"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Stations"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Priority"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Status"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, filteredShortages.map(shortage => /*#__PURE__*/React.createElement("tr", {
    key: shortage.id,
    style: {
      background: shortage.priority === 'critical' ? '#fef2f2' : 'transparent'
    }
  }, /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, /*#__PURE__*/React.createElement("strong", null, shortage.shortage_display_id)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, shortage.item), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, shortage.qty, " ", shortage.uom), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, shortage.supplier || '-'), /*#__PURE__*/React.createElement("td", {
    style: {
      ...styles.td,
      color: shortage.delivery_eta && new Date(shortage.delivery_eta) < new Date() ? '#DC2626' : 'inherit'
    }
  }, formatDate(shortage.delivery_eta)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getProjectNames(shortage.projects_impacted)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getStationNames(shortage.stations_impacted)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getPriorityBadge(shortage.priority)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getStatusBadge(shortage.status)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowDetailModal(shortage),
    style: {
      ...styles.actionButton,
      background: COLORS.blue,
      color: COLORS.white
    }
  }, "View"), shortage.status === 'open' && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleUpdateStatus(shortage.id, 'ordered'),
    style: {
      ...styles.actionButton,
      background: '#F59E0B',
      color: COLORS.white
    }
  }, "Mark Ordered"), shortage.status !== 'resolved' && shortage.status !== 'cancelled' && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleUpdateStatus(shortage.id, 'resolved'),
    style: {
      ...styles.actionButton,
      background: '#10B981',
      color: COLORS.white
    }
  }, "Resolve"))))))), activeSection === 'issues' && /*#__PURE__*/React.createElement("div", {
    style: styles.tableContainer
  }, filteredIssues.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '40px',
      color: COLORS.darkGray
    }
  }, "No issues found. Material/Supply issues logged from production will appear here.") : /*#__PURE__*/React.createElement("table", {
    style: styles.table
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "ID"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Type"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Title"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Project"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "BLM ID"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Priority"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Status"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Submitted"), /*#__PURE__*/React.createElement("th", {
    style: styles.th
  }, "Actions"))), /*#__PURE__*/React.createElement("tbody", null, filteredIssues.map(issue => /*#__PURE__*/React.createElement("tr", {
    key: issue.id,
    style: {
      background: issue.priority === 'critical' ? '#fef2f2' : 'transparent'
    }
  }, /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, /*#__PURE__*/React.createElement("strong", null, issue.issue_display_id)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getIssueTypeBadge(issue.issue_type)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, issue.title || issue.description?.substring(0, 50) || '-', issue.description?.length > 50 && '...'), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, issue.project_name || '-'), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, issue.blm_id || '-'), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getPriorityBadge(issue.priority)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, getIssueStatusBadge(issue.status)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, formatDate(issue.created_at)), /*#__PURE__*/React.createElement("td", {
    style: styles.td
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowIssueDetailModal(issue),
    style: {
      ...styles.actionButton,
      background: COLORS.blue,
      color: COLORS.white
    }
  }, "View"), issue.status === 'open' && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleUpdateIssueStatus(issue.id, 'in-progress'),
    style: {
      ...styles.actionButton,
      background: '#F59E0B',
      color: COLORS.white
    }
  }, "Start"), issue.status !== 'resolved' && issue.status !== 'closed' && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleUpdateIssueStatus(issue.id, 'resolved'),
    style: {
      ...styles.actionButton,
      background: '#10B981',
      color: COLORS.white
    }
  }, "Resolve"))))))), showAddModal && /*#__PURE__*/React.createElement(AddShortageModal, {
    onClose: () => setShowAddModal(false),
    onSubmit: handleCreateShortage,
    projects: projects,
    stations: STATIONS,
    units: UNITS,
    priorities: PRIORITIES
  }), showDetailModal && /*#__PURE__*/React.createElement(ShortageDetailModal, {
    shortage: showDetailModal,
    onClose: () => setShowDetailModal(null),
    onUpdateStatus: handleUpdateStatus,
    projects: projects,
    stations: STATIONS,
    statuses: STATUSES,
    priorities: PRIORITIES
  }), showIssueDetailModal && /*#__PURE__*/React.createElement(IssueDetailModal, {
    issue: showIssueDetailModal,
    onClose: () => setShowIssueDetailModal(null),
    onUpdateStatus: handleUpdateIssueStatus,
    priorities: PRIORITIES,
    statuses: ISSUE_STATUSES
  }));
};

// ============================================================================
// ADD SHORTAGE MODAL
// ============================================================================

const AddShortageModal = ({
  onClose,
  onSubmit,
  projects,
  stations,
  units,
  priorities
}) => {
// [Removed duplicate React destructuring]
  const [formData, setFormData] = useState({
    item: '',
    uom: 'ea',
    qty: '',
    supplier: '',
    delivery_eta: '',
    priority: 'medium',
    notes: '',
    stations_impacted: [],
    modules_impacted: [],
    projects_impacted: []
  });
  const [showStationDropdown, setShowStationDropdown] = useState(false);
  const [showProjectDropdown, setShowProjectDropdown] = useState(false);
  const [showModuleDropdown, setShowModuleDropdown] = useState(false);

  // Get all modules from selected projects
  const availableModules = useMemo(() => {
    if (formData.projects_impacted.length === 0) {
      return projects.flatMap(p => (p.modules || []).map(m => ({
        ...m,
        projectName: p.abbreviation || p.name,
        projectId: p.id
      })));
    }
    return projects.filter(p => formData.projects_impacted.includes(p.id)).flatMap(p => (p.modules || []).map(m => ({
      ...m,
      projectName: p.abbreviation || p.name,
      projectId: p.id
    })));
  }, [projects, formData.projects_impacted]);
  const COLORS = {
    charcoal: '#1a1a1a',
    blue: '#0057B8',
    white: '#ffffff',
    lightGray: '#f5f5f5',
    mediumGray: '#e0e0e0',
    darkGray: '#666666'
  };
  const styles = {
    overlay: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    },
    modal: {
      background: COLORS.white,
      borderRadius: '12px',
      width: '600px',
      maxWidth: '90vw',
      maxHeight: '90vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
    },
    header: {
      padding: '20px 24px',
      borderBottom: `1px solid ${COLORS.mediumGray}`,
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    },
    title: {
      margin: 0,
      fontSize: '18px',
      fontWeight: '600'
    },
    closeButton: {
      background: 'none',
      border: 'none',
      fontSize: '24px',
      cursor: 'pointer',
      color: COLORS.darkGray
    },
    body: {
      padding: '24px'
    },
    row: {
      display: 'flex',
      gap: '16px',
      marginBottom: '16px'
    },
    field: {
      flex: 1,
      display: 'flex',
      flexDirection: 'column',
      gap: '6px'
    },
    label: {
      fontSize: '13px',
      fontWeight: '600',
      color: COLORS.charcoal
    },
    input: {
      padding: '10px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px'
    },
    select: {
      padding: '10px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px',
      background: COLORS.white
    },
    textarea: {
      padding: '10px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px',
      minHeight: '80px',
      resize: 'vertical'
    },
    multiSelectContainer: {
      position: 'relative'
    },
    multiSelectButton: {
      width: '100%',
      padding: '10px 12px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      fontSize: '14px',
      background: COLORS.white,
      textAlign: 'left',
      cursor: 'pointer',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    },
    dropdown: {
      position: 'absolute',
      top: '100%',
      left: 0,
      right: 0,
      background: COLORS.white,
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      maxHeight: '200px',
      overflow: 'auto',
      zIndex: 10
    },
    dropdownItem: {
      padding: '10px 12px',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      borderBottom: `1px solid ${COLORS.lightGray}`
    },
    checkbox: {
      width: '16px',
      height: '16px'
    },
    selectedTags: {
      display: 'flex',
      flexWrap: 'wrap',
      gap: '4px',
      marginTop: '8px'
    },
    tag: {
      display: 'inline-flex',
      alignItems: 'center',
      gap: '4px',
      padding: '4px 8px',
      background: COLORS.lightGray,
      borderRadius: '4px',
      fontSize: '12px'
    },
    tagRemove: {
      background: 'none',
      border: 'none',
      cursor: 'pointer',
      fontSize: '14px',
      color: COLORS.darkGray
    },
    footer: {
      padding: '16px 24px',
      borderTop: `1px solid ${COLORS.mediumGray}`,
      display: 'flex',
      justifyContent: 'flex-end',
      gap: '12px'
    },
    cancelButton: {
      padding: '10px 20px',
      border: `1px solid ${COLORS.mediumGray}`,
      borderRadius: '6px',
      background: COLORS.white,
      fontSize: '14px',
      cursor: 'pointer'
    },
    submitButton: {
      padding: '10px 20px',
      border: 'none',
      borderRadius: '6px',
      background: COLORS.blue,
      color: COLORS.white,
      fontSize: '14px',
      fontWeight: '600',
      cursor: 'pointer'
    }
  };
  const toggleStation = stationId => {
    setFormData(prev => ({
      ...prev,
      stations_impacted: prev.stations_impacted.includes(stationId) ? prev.stations_impacted.filter(id => id !== stationId) : [...prev.stations_impacted, stationId]
    }));
  };
  const toggleProject = projectId => {
    setFormData(prev => ({
      ...prev,
      projects_impacted: prev.projects_impacted.includes(projectId) ? prev.projects_impacted.filter(id => id !== projectId) : [...prev.projects_impacted, projectId]
    }));
  };
  const toggleModule = moduleId => {
    setFormData(prev => ({
      ...prev,
      modules_impacted: prev.modules_impacted.includes(moduleId) ? prev.modules_impacted.filter(id => id !== moduleId) : [...prev.modules_impacted, moduleId]
    }));
  };
  const handleSubmit = e => {
    e.preventDefault();
    if (!formData.item || !formData.qty) {
      alert('Please fill in Item and Quantity');
      return;
    }
    onSubmit(formData);
  };
  return /*#__PURE__*/React.createElement("div", {
    style: styles.overlay,
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modal,
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.header
  }, /*#__PURE__*/React.createElement("h2", {
    style: styles.title
  }, "Add Shortage"), /*#__PURE__*/React.createElement("button", {
    style: styles.closeButton,
    onClick: onClose
  }, "\xD7")), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.body
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Item *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.item,
    onChange: e => setFormData(prev => ({
      ...prev,
      item: e.target.value
    })),
    placeholder: "e.g., 2x4 Studs, Drywall Screws...",
    style: styles.input,
    required: true
  }))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.field,
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Quantity *"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: formData.qty,
    onChange: e => setFormData(prev => ({
      ...prev,
      qty: e.target.value
    })),
    placeholder: "0",
    style: styles.input,
    required: true,
    min: "0",
    step: "0.01"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.field,
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Unit of Measure"), /*#__PURE__*/React.createElement("select", {
    value: formData.uom,
    onChange: e => setFormData(prev => ({
      ...prev,
      uom: e.target.value
    })),
    style: styles.select
  }, units.map(u => /*#__PURE__*/React.createElement("option", {
    key: u.id,
    value: u.id
  }, u.label)))), /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.field,
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Priority"), /*#__PURE__*/React.createElement("select", {
    value: formData.priority,
    onChange: e => setFormData(prev => ({
      ...prev,
      priority: e.target.value
    })),
    style: styles.select
  }, priorities.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.label))))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Supplier"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.supplier,
    onChange: e => setFormData(prev => ({
      ...prev,
      supplier: e.target.value
    })),
    placeholder: "Supplier name",
    style: styles.input
  })), /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Delivery ETA"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: formData.delivery_eta,
    onChange: e => setFormData(prev => ({
      ...prev,
      delivery_eta: e.target.value
    })),
    style: styles.input
  }))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Projects Impacted"), /*#__PURE__*/React.createElement("div", {
    style: styles.multiSelectContainer
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    style: styles.multiSelectButton,
    onClick: () => setShowProjectDropdown(!showProjectDropdown)
  }, /*#__PURE__*/React.createElement("span", null, formData.projects_impacted.length === 0 ? 'Select projects...' : `${formData.projects_impacted.length} selected`), /*#__PURE__*/React.createElement("span", null, showProjectDropdown ? '▲' : '▼')), showProjectDropdown && /*#__PURE__*/React.createElement("div", {
    style: styles.dropdown
  }, projects.map(project => /*#__PURE__*/React.createElement("div", {
    key: project.id,
    style: styles.dropdownItem,
    onClick: () => toggleProject(project.id)
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: formData.projects_impacted.includes(project.id),
    onChange: () => {},
    style: styles.checkbox
  }), /*#__PURE__*/React.createElement("span", null, project.abbreviation || project.name))))), formData.projects_impacted.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: styles.selectedTags
  }, formData.projects_impacted.map(id => {
    const project = projects.find(p => p.id === id);
    return /*#__PURE__*/React.createElement("span", {
      key: id,
      style: styles.tag
    }, project?.abbreviation || project?.name || id, /*#__PURE__*/React.createElement("button", {
      type: "button",
      style: styles.tagRemove,
      onClick: () => toggleProject(id)
    }, "\xD7"));
  })))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Stations Impacted"), /*#__PURE__*/React.createElement("div", {
    style: styles.multiSelectContainer
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    style: styles.multiSelectButton,
    onClick: () => setShowStationDropdown(!showStationDropdown)
  }, /*#__PURE__*/React.createElement("span", null, formData.stations_impacted.length === 0 ? 'Select stations...' : `${formData.stations_impacted.length} selected`), /*#__PURE__*/React.createElement("span", null, showStationDropdown ? '▲' : '▼')), showStationDropdown && /*#__PURE__*/React.createElement("div", {
    style: styles.dropdown
  }, stations.map(station => /*#__PURE__*/React.createElement("div", {
    key: station.id,
    style: styles.dropdownItem,
    onClick: () => toggleStation(station.id)
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: formData.stations_impacted.includes(station.id),
    onChange: () => {},
    style: styles.checkbox
  }), /*#__PURE__*/React.createElement("span", null, station.name))))), formData.stations_impacted.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: styles.selectedTags
  }, formData.stations_impacted.map(id => {
    const station = stations.find(s => s.id === id);
    return /*#__PURE__*/React.createElement("span", {
      key: id,
      style: styles.tag
    }, station?.name || id, /*#__PURE__*/React.createElement("button", {
      type: "button",
      style: styles.tagRemove,
      onClick: () => toggleStation(id)
    }, "\xD7"));
  })))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Modules Impacted"), /*#__PURE__*/React.createElement("div", {
    style: styles.multiSelectContainer
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    style: styles.multiSelectButton,
    onClick: () => setShowModuleDropdown(!showModuleDropdown)
  }, /*#__PURE__*/React.createElement("span", null, formData.modules_impacted.length === 0 ? 'Select modules...' : `${formData.modules_impacted.length} selected`), /*#__PURE__*/React.createElement("span", null, showModuleDropdown ? '▲' : '▼')), showModuleDropdown && /*#__PURE__*/React.createElement("div", {
    style: styles.dropdown
  }, availableModules.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      ...styles.dropdownItem,
      color: '#999'
    }
  }, "No modules available") : availableModules.map(module => {
    const moduleId = module.id || module.serialNumber || module.serial_number;
    const displayName = module.serialNumber || module.serial_number || module.blm_id || moduleId;
    return /*#__PURE__*/React.createElement("div", {
      key: moduleId,
      style: styles.dropdownItem,
      onClick: () => toggleModule(moduleId)
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: formData.modules_impacted.includes(moduleId),
      onChange: () => {},
      style: styles.checkbox
    }), /*#__PURE__*/React.createElement("span", null, module.projectName, ": ", displayName));
  }))), formData.modules_impacted.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: styles.selectedTags
  }, formData.modules_impacted.map(id => /*#__PURE__*/React.createElement("span", {
    key: id,
    style: styles.tag
  }, id, /*#__PURE__*/React.createElement("button", {
    type: "button",
    style: styles.tagRemove,
    onClick: () => toggleModule(id)
  }, "\xD7")))))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.field
  }, /*#__PURE__*/React.createElement("label", {
    style: styles.label
  }, "Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.notes,
    onChange: e => setFormData(prev => ({
      ...prev,
      notes: e.target.value
    })),
    placeholder: "Additional details about the shortage...",
    style: styles.textarea
  })))), /*#__PURE__*/React.createElement("div", {
    style: styles.footer
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    style: styles.cancelButton,
    onClick: onClose
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    style: styles.submitButton
  }, "Add Shortage")))));
};

// ============================================================================
// SHORTAGE DETAIL MODAL
// ============================================================================

const ShortageDetailModal = ({
  shortage,
  onClose,
  onUpdateStatus,
  projects,
  stations,
  statuses,
  priorities
}) => {
  const COLORS = {
    charcoal: '#1a1a1a',
    blue: '#0057B8',
    white: '#ffffff',
    lightGray: '#f5f5f5',
    mediumGray: '#e0e0e0',
    darkGray: '#666666'
  };
  const styles = {
    overlay: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    },
    modal: {
      background: COLORS.white,
      borderRadius: '12px',
      width: '500px',
      maxWidth: '90vw',
      maxHeight: '90vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
    },
    header: {
      padding: '20px 24px',
      borderBottom: `1px solid ${COLORS.mediumGray}`,
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    },
    title: {
      margin: 0,
      fontSize: '18px',
      fontWeight: '600'
    },
    closeButton: {
      background: 'none',
      border: 'none',
      fontSize: '24px',
      cursor: 'pointer',
      color: COLORS.darkGray
    },
    body: {
      padding: '24px'
    },
    row: {
      display: 'flex',
      marginBottom: '12px'
    },
    label: {
      width: '120px',
      fontWeight: '600',
      color: COLORS.darkGray,
      fontSize: '13px'
    },
    value: {
      flex: 1,
      fontSize: '14px'
    },
    badge: {
      display: 'inline-block',
      padding: '4px 10px',
      borderRadius: '12px',
      fontSize: '12px',
      fontWeight: '600'
    },
    footer: {
      padding: '16px 24px',
      borderTop: `1px solid ${COLORS.mediumGray}`,
      display: 'flex',
      justifyContent: 'flex-end',
      gap: '12px'
    },
    button: {
      padding: '10px 20px',
      border: 'none',
      borderRadius: '6px',
      fontSize: '14px',
      cursor: 'pointer'
    }
  };
  const formatDate = dateStr => {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };
  const getProjectNames = projectIds => {
    if (!projectIds || projectIds.length === 0) return '-';
    return projectIds.map(id => {
      const project = projects.find(p => p.id === id);
      return project?.abbreviation || project?.name || id;
    }).join(', ');
  };
  const getStationNames = stationIds => {
    if (!stationIds || stationIds.length === 0) return '-';
    return stationIds.map(id => {
      const station = stations.find(s => s.id === id);
      return station?.name || id;
    }).join(', ');
  };
  const statusObj = statuses.find(s => s.id === shortage.status) || statuses[0];
  const priorityObj = priorities.find(p => p.id === shortage.priority) || priorities[1];
  return /*#__PURE__*/React.createElement("div", {
    style: styles.overlay,
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.modal,
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.header
  }, /*#__PURE__*/React.createElement("h2", {
    style: styles.title
  }, shortage.shortage_display_id), /*#__PURE__*/React.createElement("button", {
    style: styles.closeButton,
    onClick: onClose
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: styles.body
  }, /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Item:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, /*#__PURE__*/React.createElement("strong", null, shortage.item))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Quantity:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.qty, " ", shortage.uom)), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Supplier:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.supplier || '-')), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Delivery ETA:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, formatDate(shortage.delivery_eta))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Priority:"), /*#__PURE__*/React.createElement("span", {
    style: {
      ...styles.badge,
      background: `${priorityObj.color}20`,
      color: priorityObj.color
    }
  }, priorityObj.label)), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Status:"), /*#__PURE__*/React.createElement("span", {
    style: {
      ...styles.badge,
      background: `${statusObj.color}20`,
      color: statusObj.color
    }
  }, statusObj.label)), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Projects:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, getProjectNames(shortage.projects_impacted))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Stations:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, getStationNames(shortage.stations_impacted))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Modules:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.modules_impacted?.length > 0 ? shortage.modules_impacted.join(', ') : '-')), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Reported By:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.reported_by || '-')), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Created:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, formatDate(shortage.created_at))), shortage.notes && /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Notes:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.notes)), shortage.resolved_at && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Resolved:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, formatDate(shortage.resolved_at))), /*#__PURE__*/React.createElement("div", {
    style: styles.row
  }, /*#__PURE__*/React.createElement("span", {
    style: styles.label
  }, "Resolved By:"), /*#__PURE__*/React.createElement("span", {
    style: styles.value
  }, shortage.resolved_by || '-')))), /*#__PURE__*/React.createElement("div", {
    style: styles.footer
  }, shortage.status === 'open' && /*#__PURE__*/React.createElement("button", {
    style: {
      ...styles.button,
      background: '#F59E0B',
      color: COLORS.white
    },
    onClick: () => {
      onUpdateStatus(shortage.id, 'ordered');
      onClose();
    }
  }, "Mark Ordered"), shortage.status === 'ordered' && /*#__PURE__*/React.createElement("button", {
    style: {
      ...styles.button,
      background: '#0891B2',
      color: COLORS.white
    },
    onClick: () => {
      onUpdateStatus(shortage.id, 'partial');
      onClose();
    }
  }, "Partial Delivery"), !['resolved', 'cancelled'].includes(shortage.status) && /*#__PURE__*/React.createElement("button", {
    style: {
      ...styles.button,
      background: '#10B981',
      color: COLORS.white
    },
    onClick: () => {
      onUpdateStatus(shortage.id, 'resolved');
      onClose();
    }
  }, "Resolve"), /*#__PURE__*/React.createElement("button", {
    style: {
      ...styles.button,
      background: COLORS.mediumGray
    },
    onClick: onClose
  }, "Close"))));
};

// Export for use in App.jsx
window.ProcurementBoard = ProcurementBoard;
})();


// ============================================================================
// FILE: onsite/PhotoCapture.jsx
// ============================================================================
(function() {
/**
 * PhotoCapture Component for MODA On-Site Reports
 * 
 * Mobile-optimized photo capture with:
 * - Camera capture (rear camera by default)
 * - Gallery selection
 * - Automatic compression (<1MB per photo)
 * - Preview modal
 * - Delete functionality
 * - Touch-friendly 44px minimum targets
 */
// [Removed duplicate React destructuring]
function PhotoCapture({
  photos = [],
  onPhotosChange,
  maxPhotos = 5,
  maxSizeKB = 1024,
  disabled = false,
  showSizeInfo = true
}) {
  const [isUploading, setIsUploading] = useState(false);
  const [previewPhoto, setPreviewPhoto] = useState(null);
  const [previewIndex, setPreviewIndex] = useState(null);
  const cameraInputRef = useRef(null);
  const galleryInputRef = useRef(null);
  const handlePhotoUpload = async event => {
    const files = Array.from(event.target.files || []);
    if (files.length === 0) return;
    setIsUploading(true);
    const newPhotos = [...photos];
    try {
      for (const file of files) {
        if (newPhotos.length >= maxPhotos) {
          alert(`Maximum ${maxPhotos} photos allowed`);
          break;
        }

        // Use MODA_PHOTO compression utility
        const compressed = await window.MODA_PHOTO.compressImage(file, {
          maxWidth: 1200,
          maxHeight: 1200,
          quality: 0.7
        });
        const sizeKB = window.MODA_PHOTO.getBase64Size(compressed);
        if (sizeKB > maxSizeKB) {
          // Try harder compression
          const recompressed = await window.MODA_PHOTO.compressToTargetSize(file, maxSizeKB);
          newPhotos.push(recompressed);
        } else {
          newPhotos.push(compressed);
        }
      }
      onPhotosChange(newPhotos);
    } catch (error) {
      console.error('Error uploading photos:', error);
      alert('Error processing photos. Please try again.');
    } finally {
      setIsUploading(false);
      // Reset input to allow selecting same file again
      if (event.target) event.target.value = '';
    }
  };
  const deletePhoto = index => {
    if (disabled) return;
    if (confirm('Delete this photo?')) {
      const updated = photos.filter((_, i) => i !== index);
      onPhotosChange(updated);
      // Close preview if deleting the previewed photo
      if (previewIndex === index) {
        setPreviewPhoto(null);
        setPreviewIndex(null);
      }
    }
  };
  const openPreview = (photo, index) => {
    setPreviewPhoto(photo);
    setPreviewIndex(index);
  };
  const closePreview = () => {
    setPreviewPhoto(null);
    setPreviewIndex(null);
  };
  const formatSize = base64 => {
    if (!window.MODA_PHOTO) return '';
    const sizeKB = window.MODA_PHOTO.getBase64Size(base64);
    return window.MODA_PHOTO.formatFileSize(sizeKB);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "photo-capture-container"
  }, photos.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "photo-grid"
  }, photos.map((photo, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "photo-item",
    onClick: () => openPreview(photo, idx)
  }, /*#__PURE__*/React.createElement("img", {
    src: photo,
    alt: `Photo ${idx + 1}`,
    className: "photo-thumbnail"
  }), /*#__PURE__*/React.createElement("div", {
    className: "photo-number"
  }, idx + 1), !disabled && /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      deletePhoto(idx);
    },
    className: "photo-delete-btn",
    type: "button",
    "aria-label": "Delete photo"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '16px',
      height: '16px',
      display: 'block',
      filter: 'brightness(0) invert(1)'
    }
  })), showSizeInfo && /*#__PURE__*/React.createElement("div", {
    className: "photo-size"
  }, formatSize(photo))))), !disabled && photos.length < maxPhotos && /*#__PURE__*/React.createElement("div", {
    className: "photo-capture-buttons"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => cameraInputRef.current?.click(),
    disabled: isUploading,
    className: "photo-btn photo-btn-camera",
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-camera",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block',
      marginRight: '8px'
    }
  }), isUploading ? 'Processing...' : 'Take Photo'), /*#__PURE__*/React.createElement("button", {
    onClick: () => galleryInputRef.current?.click(),
    disabled: isUploading,
    className: "photo-btn photo-btn-gallery",
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-image",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block',
      marginRight: '8px'
    }
  }), isUploading ? 'Processing...' : 'Add Photo')), /*#__PURE__*/React.createElement("p", {
    className: "photo-count"
  }, photos.length, " of ", maxPhotos, " photos"), /*#__PURE__*/React.createElement("input", {
    ref: cameraInputRef,
    type: "file",
    accept: "image/*",
    capture: "environment",
    className: "hidden-input",
    onChange: handlePhotoUpload,
    disabled: disabled || isUploading
  }), /*#__PURE__*/React.createElement("input", {
    ref: galleryInputRef,
    type: "file",
    accept: "image/*",
    multiple: true,
    className: "hidden-input",
    onChange: handlePhotoUpload,
    disabled: disabled || isUploading
  }), previewPhoto && /*#__PURE__*/React.createElement("div", {
    className: "photo-preview-overlay",
    onClick: closePreview
  }, /*#__PURE__*/React.createElement("button", {
    onClick: closePreview,
    className: "preview-close-btn",
    type: "button",
    "aria-label": "Close preview"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '24px',
      height: '24px',
      display: 'block',
      filter: 'brightness(0) invert(1)'
    }
  })), /*#__PURE__*/React.createElement("img", {
    src: previewPhoto,
    alt: "Preview",
    className: "preview-image",
    onClick: e => e.stopPropagation()
  }), !disabled && /*#__PURE__*/React.createElement("div", {
    className: "preview-actions",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      deletePhoto(previewIndex);
    },
    className: "preview-delete-btn",
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-delete",
    style: {
      width: '20px',
      height: '20px',
      display: 'inline-block',
      marginRight: '8px'
    }
  }), "Delete Photo")), /*#__PURE__*/React.createElement("div", {
    className: "preview-info"
  }, "Photo ", previewIndex + 1, " of ", photos.length, showSizeInfo && ` • ${formatSize(previewPhoto)}`)), /*#__PURE__*/React.createElement("style", null, `
                .photo-capture-container {
                    width: 100%;
                }

                .photo-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 12px;
                    margin-bottom: 16px;
                }

                .photo-item {
                    position: relative;
                    aspect-ratio: 1;
                    cursor: pointer;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid #e5e7eb;
                    transition: border-color 0.2s, transform 0.2s;
                }

                .photo-item:hover {
                    border-color: #0057B8;
                    transform: scale(1.02);
                }

                .photo-thumbnail {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }

                .photo-number {
                    position: absolute;
                    top: 4px;
                    left: 4px;
                    background: #0057B8;
                    color: white;
                    font-size: 11px;
                    font-weight: 600;
                    width: 22px;
                    height: 22px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .photo-delete-btn {
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    background: #DC2626;
                    border: none;
                    border-radius: 50%;
                    width: 28px;
                    height: 28px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: background 0.2s, transform 0.2s;
                    padding: 0;
                }

                .photo-delete-btn:hover {
                    background: #B91C1C;
                    transform: scale(1.1);
                }

                .photo-size {
                    position: absolute;
                    bottom: 4px;
                    right: 4px;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 4px;
                }

                .photo-capture-buttons {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                    margin-bottom: 12px;
                }

                .photo-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 14px 16px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s;
                    min-height: 48px;
                    border: 2px solid;
                }

                .photo-btn:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }

                .photo-btn-camera {
                    background: #0057B8;
                    color: white;
                    border-color: #0057B8;
                }

                .photo-btn-camera:hover:not(:disabled) {
                    background: #004494;
                    border-color: #004494;
                }

                .photo-btn-camera .icon-camera {
                    filter: brightness(0) invert(1);
                }

                .photo-btn-gallery {
                    background: white;
                    color: #374151;
                    border-color: #d1d5db;
                }

                .photo-btn-gallery:hover:not(:disabled) {
                    background: #f9fafb;
                    border-color: #9ca3af;
                }

                .photo-count {
                    text-align: center;
                    font-size: 13px;
                    color: #6b7280;
                    margin: 0;
                }

                .hidden-input {
                    display: none;
                }

                /* Preview Modal */
                .photo-preview-overlay {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 16px;
                }

                .preview-close-btn {
                    position: absolute;
                    top: 16px;
                    right: 16px;
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    border-radius: 50%;
                    width: 44px;
                    height: 44px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: background 0.2s;
                    padding: 0;
                }

                .preview-close-btn:hover {
                    background: rgba(255, 255, 255, 0.3);
                }

                .preview-image {
                    max-width: 100%;
                    max-height: calc(100vh - 160px);
                    object-fit: contain;
                    border-radius: 8px;
                }

                .preview-actions {
                    margin-top: 16px;
                }

                .preview-delete-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 12px 24px;
                    background: #DC2626;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: background 0.2s;
                    min-height: 44px;
                }

                .preview-delete-btn:hover {
                    background: #B91C1C;
                }

                .preview-delete-btn .icon-delete {
                    filter: brightness(0) invert(1);
                }

                .preview-info {
                    position: absolute;
                    bottom: 16px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    font-size: 13px;
                    padding: 8px 16px;
                    border-radius: 20px;
                }

                /* Mobile optimizations */
                @media (max-width: 640px) {
                    .photo-grid {
                        gap: 8px;
                    }

                    .photo-btn {
                        padding: 12px;
                        font-size: 13px;
                    }

                    .photo-delete-btn {
                        width: 32px;
                        height: 32px;
                    }
                }
            `));
}

// Make component available globally
window.PhotoCapture = PhotoCapture;
})();


// ============================================================================
// FILE: onsite/IssueLogger.jsx
// ============================================================================
(function() {
/**
 * IssueLogger Component for MODA On-Site Reports
 * 
 * 3-step wizard for logging module issues quickly:
 * Step 1: Select Module
 * Step 2: Issue Details (type, description, photos)
 * Step 3: Review & Submit
 * 
 * Target: Complete issue logging in <37 seconds
 * Mobile-optimized with 44px minimum touch targets
 */
// [Removed duplicate React destructuring]
function IssueLogger({
  reportId,
  modules = [],
  onSubmit,
  onClose,
  initialModule = null
}) {
  // Wizard state
  const [currentStep, setCurrentStep] = useState(initialModule ? 2 : 1);
  const [startTime] = useState(Date.now());
  const [elapsedTime, setElapsedTime] = useState(0);

  // Form state
  const [selectedModule, setSelectedModule] = useState(initialModule);
  const [moduleSearch, setModuleSearch] = useState('');
  const [issueType, setIssueType] = useState('');
  const [severity, setSeverity] = useState('minor');
  const [trade, setTrade] = useState('');
  const [description, setDescription] = useState('');
  const [actionTaken, setActionTaken] = useState('');
  const [photos, setPhotos] = useState([]);

  // Submission state
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState(null);

  // Timer effect
  useEffect(() => {
    const timer = setInterval(() => {
      setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
    }, 1000);
    return () => clearInterval(timer);
  }, [startTime]);

  // Format elapsed time
  const formatTime = seconds => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Filter modules based on search
  const filteredModules = modules.filter(m => {
    if (!moduleSearch) return true;
    const search = moduleSearch.toLowerCase();
    const serial = (m.serial_number || m.serialNumber || '').toLowerCase();
    const blm = (m.blm_id || m.hitchBLM || '').toLowerCase();
    const unit = (m.unit_type || m.hitchUnit || '').toLowerCase();
    return serial.includes(search) || blm.includes(search) || unit.includes(search);
  });

  // Get display name for module
  const getModuleDisplayName = module => {
    if (!module) return '';
    const serial = module.serial_number || module.serialNumber || 'Unknown';
    const blm = module.blm_id || module.hitchBLM || '';
    const unit = module.unit_type || module.hitchUnit || '';
    return `${blm || unit} - SN# ${serial}`;
  };

  // Validation
  const canProceedToStep2 = selectedModule !== null;
  const canProceedToStep3 = issueType && description.trim().length >= 10;
  const canSubmit = canProceedToStep2 && canProceedToStep3;

  // Handle submit
  const handleSubmit = async () => {
    if (!canSubmit || isSubmitting) return;
    setIsSubmitting(true);
    setError(null);
    try {
      const issueData = {
        report_id: reportId,
        module_id: selectedModule.id,
        issue_type: issueType,
        severity: severity,
        trade: trade || null,
        description: description.trim(),
        action_taken: actionTaken.trim() || null,
        photos: photos
      };
      await onSubmit(issueData);
    } catch (err) {
      console.error('Error submitting issue:', err);
      setError(err.message || 'Failed to submit issue');
      setIsSubmitting(false);
    }
  };

  // Get constants from MODA_ONSITE
  const ISSUE_TYPES = window.MODA_ONSITE?.ISSUE_TYPES || [{
    id: 'quality',
    label: 'Quality Defect',
    iconClass: 'icon-quality-issue'
  }, {
    id: 'material',
    label: 'Material Shortage',
    iconClass: 'icon-material-issue'
  }, {
    id: 'question',
    label: 'Question',
    iconClass: 'icon-question'
  }, {
    id: 'site',
    label: 'Site Issue',
    iconClass: 'icon-site-issue'
  }, {
    id: 'transit',
    label: 'Transit Damage',
    iconClass: 'icon-transit-issue'
  }, {
    id: 'drawing',
    label: 'Drawing Issue',
    iconClass: 'icon-drawing-issue'
  }, {
    id: 'other',
    label: 'Other',
    iconClass: 'icon-other'
  }];
  const SEVERITY_LEVELS = window.MODA_ONSITE?.SEVERITY_LEVELS || [{
    id: 'critical',
    label: 'Critical',
    color: '#DC2626',
    description: 'Stops work'
  }, {
    id: 'major',
    label: 'Major',
    color: '#EA580C',
    description: 'Needs fix'
  }, {
    id: 'minor',
    label: 'Minor',
    color: '#16A34A',
    description: 'Cosmetic'
  }];
  const TRADES = window.MODA_ONSITE?.TRADES || ['Drywall', 'Electrical', 'Plumbing', 'HVAC', 'Framing', 'Roofing', 'Exterior', 'Flooring', 'Cabinets', 'Windows/Doors', 'Insulation', 'Paint', 'Structural', 'Other'];
  return /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-overlay"
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-modal"
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-header"
  }, /*#__PURE__*/React.createElement("div", {
    className: "header-left"
  }, /*#__PURE__*/React.createElement("h2", null, "Log Issue"), /*#__PURE__*/React.createElement("div", {
    className: `timer ${elapsedTime > 37 ? 'over-target' : ''}`
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-timer",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block',
      marginRight: '4px'
    }
  }), formatTime(elapsedTime), elapsedTime <= 37 && /*#__PURE__*/React.createElement("span", {
    className: "target-hint"
  }, "Target: 0:37"))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "close-btn",
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close",
    style: {
      width: '24px',
      height: '24px',
      display: 'block'
    }
  }))), /*#__PURE__*/React.createElement("div", {
    className: "step-progress"
  }, [1, 2, 3].map(step => /*#__PURE__*/React.createElement("div", {
    key: step,
    className: `step-item ${currentStep === step ? 'active' : ''} ${currentStep > step ? 'completed' : ''}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "step-number"
  }, currentStep > step ? '✓' : step), /*#__PURE__*/React.createElement("div", {
    className: "step-label"
  }, step === 1 ? 'Module' : step === 2 ? 'Details' : 'Review')))), /*#__PURE__*/React.createElement("div", {
    className: "step-content"
  }, currentStep === 1 && /*#__PURE__*/React.createElement("div", {
    className: "step-panel"
  }, /*#__PURE__*/React.createElement("h3", null, "Select Module"), /*#__PURE__*/React.createElement("div", {
    className: "search-box"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by serial, BLM, or unit...",
    value: moduleSearch,
    onChange: e => setModuleSearch(e.target.value),
    className: "search-input",
    autoFocus: true
  })), /*#__PURE__*/React.createElement("div", {
    className: "module-list"
  }, filteredModules.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "empty-state"
  }, "No modules found") : filteredModules.map(module => /*#__PURE__*/React.createElement("button", {
    key: module.id,
    onClick: () => setSelectedModule(module),
    className: `module-option ${selectedModule?.id === module.id ? 'selected' : ''}`,
    type: "button"
  }, /*#__PURE__*/React.createElement("div", {
    className: "module-serial"
  }, module.serial_number || module.serialNumber), /*#__PURE__*/React.createElement("div", {
    className: "module-details"
  }, module.blm_id || module.hitchBLM, (module.unit_type || module.hitchUnit) && ` • ${module.unit_type || module.hitchUnit}`))))), currentStep === 2 && /*#__PURE__*/React.createElement("div", {
    className: "step-panel"
  }, /*#__PURE__*/React.createElement("h3", null, "Issue Details"), /*#__PURE__*/React.createElement("div", {
    className: "selected-module-display"
  }, /*#__PURE__*/React.createElement("span", {
    className: "label"
  }, "Module:"), /*#__PURE__*/React.createElement("span", {
    className: "value"
  }, getModuleDisplayName(selectedModule)), /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentStep(1),
    className: "change-btn",
    type: "button"
  }, "Change")), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label required"
  }, "Issue Type"), /*#__PURE__*/React.createElement("div", {
    className: "issue-type-grid"
  }, ISSUE_TYPES.map(type => /*#__PURE__*/React.createElement("button", {
    key: type.id,
    onClick: () => setIssueType(type.id),
    className: `issue-type-btn ${issueType === type.id ? 'selected' : ''}`,
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: type.iconClass,
    style: {
      width: '24px',
      height: '24px',
      display: 'block',
      margin: '0 auto 4px'
    }
  }), /*#__PURE__*/React.createElement("span", {
    className: "type-label"
  }, type.label))))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label"
  }, "Severity"), /*#__PURE__*/React.createElement("div", {
    className: "severity-options"
  }, SEVERITY_LEVELS.map(level => /*#__PURE__*/React.createElement("button", {
    key: level.id,
    onClick: () => setSeverity(level.id),
    className: `severity-btn ${severity === level.id ? 'selected' : ''}`,
    style: {
      '--severity-color': level.color,
      borderColor: severity === level.id ? level.color : '#e5e7eb'
    },
    type: "button"
  }, /*#__PURE__*/React.createElement("span", {
    className: "severity-label"
  }, level.label), /*#__PURE__*/React.createElement("span", {
    className: "severity-desc"
  }, level.description))))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label"
  }, "Trade (optional)"), /*#__PURE__*/React.createElement("select", {
    value: trade,
    onChange: e => setTrade(e.target.value),
    className: "form-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select trade..."), TRADES.map(t => /*#__PURE__*/React.createElement("option", {
    key: t,
    value: t
  }, t)))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label required"
  }, "Description", /*#__PURE__*/React.createElement("span", {
    className: "char-count"
  }, description.length, "/10 min")), /*#__PURE__*/React.createElement("textarea", {
    value: description,
    onChange: e => setDescription(e.target.value),
    placeholder: "Describe the issue...",
    className: "form-textarea",
    rows: 3
  })), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label"
  }, "Action Taken (optional)"), /*#__PURE__*/React.createElement("textarea", {
    value: actionTaken,
    onChange: e => setActionTaken(e.target.value),
    placeholder: "What was done to address this?",
    className: "form-textarea",
    rows: 2
  })), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", {
    className: "form-label"
  }, "Photos (max 5)"), window.PhotoCapture && /*#__PURE__*/React.createElement(PhotoCapture, {
    photos: photos,
    onPhotosChange: setPhotos,
    maxPhotos: 5
  }))), currentStep === 3 && /*#__PURE__*/React.createElement("div", {
    className: "step-panel"
  }, /*#__PURE__*/React.createElement("h3", null, "Review & Submit"), error && /*#__PURE__*/React.createElement("div", {
    className: "error-message"
  }, error), /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "review-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Module"), /*#__PURE__*/React.createElement("span", {
    className: "review-value"
  }, getModuleDisplayName(selectedModule))), /*#__PURE__*/React.createElement("div", {
    className: "review-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Issue Type"), /*#__PURE__*/React.createElement("span", {
    className: "review-value"
  }, ISSUE_TYPES.find(t => t.id === issueType)?.label || issueType)), /*#__PURE__*/React.createElement("div", {
    className: "review-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Severity"), /*#__PURE__*/React.createElement("span", {
    className: "review-value severity-badge",
    style: {
      color: SEVERITY_LEVELS.find(s => s.id === severity)?.color
    }
  }, SEVERITY_LEVELS.find(s => s.id === severity)?.label || severity)), trade && /*#__PURE__*/React.createElement("div", {
    className: "review-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Trade"), /*#__PURE__*/React.createElement("span", {
    className: "review-value"
  }, trade)), /*#__PURE__*/React.createElement("div", {
    className: "review-item full-width"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Description"), /*#__PURE__*/React.createElement("p", {
    className: "review-text"
  }, description)), actionTaken && /*#__PURE__*/React.createElement("div", {
    className: "review-item full-width"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Action Taken"), /*#__PURE__*/React.createElement("p", {
    className: "review-text"
  }, actionTaken)), photos.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "review-item full-width"
  }, /*#__PURE__*/React.createElement("span", {
    className: "review-label"
  }, "Photos (", photos.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "review-photos"
  }, photos.map((photo, idx) => /*#__PURE__*/React.createElement("img", {
    key: idx,
    src: photo,
    alt: `Photo ${idx + 1}`,
    className: "review-photo"
  }))))), /*#__PURE__*/React.createElement("div", {
    className: `time-summary ${elapsedTime <= 37 ? 'success' : 'warning'}`
  }, elapsedTime <= 37 ? `Great! Completed in ${formatTime(elapsedTime)}` : `Time: ${formatTime(elapsedTime)} (target was 0:37)`))), /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-footer"
  }, currentStep > 1 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentStep(currentStep - 1),
    className: "btn-secondary",
    type: "button",
    disabled: isSubmitting
  }, "Back"), /*#__PURE__*/React.createElement("div", {
    className: "footer-spacer"
  }), currentStep < 3 ? /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentStep(currentStep + 1),
    className: "btn-primary",
    type: "button",
    disabled: currentStep === 1 ? !canProceedToStep2 : !canProceedToStep3
  }, "Next") : /*#__PURE__*/React.createElement("button", {
    onClick: handleSubmit,
    className: "btn-submit",
    type: "button",
    disabled: !canSubmit || isSubmitting
  }, isSubmitting ? 'Submitting...' : 'Submit Issue'))), /*#__PURE__*/React.createElement("style", null, `
                .issue-logger-overlay {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 9000;
                    display: flex;
                    align-items: flex-end;
                    justify-content: center;
                }

                .issue-logger-modal {
                    background: white;
                    width: 100%;
                    max-width: 600px;
                    max-height: 95vh;
                    border-radius: 16px 16px 0 0;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                }

                @media (min-width: 640px) {
                    .issue-logger-overlay {
                        align-items: center;
                        padding: 20px;
                    }
                    .issue-logger-modal {
                        border-radius: 16px;
                        max-height: 90vh;
                    }
                }

                .issue-logger-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px 20px;
                    border-bottom: 1px solid #e5e7eb;
                    background: #f9fafb;
                }

                .header-left h2 {
                    margin: 0;
                    font-size: 18px;
                    font-weight: 600;
                    color: #111827;
                }

                .timer {
                    display: flex;
                    align-items: center;
                    font-size: 14px;
                    color: #16A34A;
                    font-weight: 500;
                    margin-top: 4px;
                }

                .timer.over-target {
                    color: #DC2626;
                }

                .target-hint {
                    font-size: 11px;
                    color: #9ca3af;
                    margin-left: 8px;
                }

                .close-btn {
                    background: none;
                    border: none;
                    padding: 8px;
                    cursor: pointer;
                    border-radius: 8px;
                    transition: background 0.2s;
                }

                .close-btn:hover {
                    background: #e5e7eb;
                }

                /* Step Progress */
                .step-progress {
                    display: flex;
                    justify-content: center;
                    gap: 40px;
                    padding: 16px 20px;
                    border-bottom: 1px solid #e5e7eb;
                }

                .step-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 4px;
                }

                .step-number {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    font-weight: 600;
                    background: #e5e7eb;
                    color: #6b7280;
                    transition: all 0.2s;
                }

                .step-item.active .step-number {
                    background: #0057B8;
                    color: white;
                }

                .step-item.completed .step-number {
                    background: #16A34A;
                    color: white;
                }

                .step-label {
                    font-size: 12px;
                    color: #6b7280;
                }

                .step-item.active .step-label {
                    color: #0057B8;
                    font-weight: 500;
                }

                /* Step Content */
                .step-content {
                    flex: 1;
                    overflow-y: auto;
                    padding: 20px;
                }

                .step-panel h3 {
                    margin: 0 0 16px;
                    font-size: 16px;
                    font-weight: 600;
                    color: #111827;
                }

                /* Module Selection */
                .search-box {
                    margin-bottom: 12px;
                }

                .search-input {
                    width: 100%;
                    padding: 12px 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 14px;
                    transition: border-color 0.2s;
                }

                .search-input:focus {
                    outline: none;
                    border-color: #0057B8;
                }

                .module-list {
                    max-height: 300px;
                    overflow-y: auto;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .module-option {
                    width: 100%;
                    padding: 12px 16px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    text-align: left;
                    cursor: pointer;
                    transition: all 0.2s;
                }

                .module-option:hover {
                    border-color: #0057B8;
                    background: #f0f7ff;
                }

                .module-option.selected {
                    border-color: #0057B8;
                    background: #e0f0ff;
                }

                .module-serial {
                    font-size: 15px;
                    font-weight: 600;
                    color: #111827;
                }

                .module-details {
                    font-size: 13px;
                    color: #6b7280;
                    margin-top: 2px;
                }

                /* Selected Module Display */
                .selected-module-display {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 12px 16px;
                    background: #f0f7ff;
                    border: 1px solid #0057B8;
                    border-radius: 8px;
                    margin-bottom: 16px;
                }

                .selected-module-display .label {
                    font-size: 13px;
                    color: #6b7280;
                }

                .selected-module-display .value {
                    flex: 1;
                    font-size: 14px;
                    font-weight: 500;
                    color: #111827;
                }

                .change-btn {
                    padding: 6px 12px;
                    background: white;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }

                .change-btn:hover {
                    background: #f9fafb;
                    border-color: #9ca3af;
                }

                /* Form Groups */
                .form-group {
                    margin-bottom: 16px;
                }

                .form-label {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 13px;
                    font-weight: 500;
                    color: #374151;
                    margin-bottom: 8px;
                }

                .form-label.required::after {
                    content: '*';
                    color: #DC2626;
                    margin-left: 4px;
                }

                .char-count {
                    font-weight: 400;
                    color: #9ca3af;
                }

                /* Issue Type Grid */
                .issue-type-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 8px;
                }

                @media (max-width: 480px) {
                    .issue-type-grid {
                        grid-template-columns: repeat(3, 1fr);
                    }
                }

                .issue-type-btn {
                    padding: 12px 8px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                }

                .issue-type-btn:hover {
                    border-color: #0057B8;
                    background: #f0f7ff;
                }

                .issue-type-btn.selected {
                    border-color: #0057B8;
                    background: #e0f0ff;
                }

                .type-label {
                    font-size: 11px;
                    color: #374151;
                    display: block;
                }

                /* Severity Options */
                .severity-options {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                }

                .severity-btn {
                    padding: 12px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                }

                .severity-btn:hover {
                    border-color: var(--severity-color);
                }

                .severity-btn.selected {
                    background: color-mix(in srgb, var(--severity-color) 10%, white);
                }

                .severity-label {
                    display: block;
                    font-size: 13px;
                    font-weight: 600;
                    color: var(--severity-color);
                }

                .severity-desc {
                    display: block;
                    font-size: 11px;
                    color: #6b7280;
                    margin-top: 2px;
                }

                /* Form Inputs */
                .form-select, .form-textarea {
                    width: 100%;
                    padding: 12px 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 14px;
                    transition: border-color 0.2s;
                    font-family: inherit;
                }

                .form-select:focus, .form-textarea:focus {
                    outline: none;
                    border-color: #0057B8;
                }

                .form-textarea {
                    resize: vertical;
                    min-height: 80px;
                }

                /* Review Section */
                .review-section {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                }

                .review-item {
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 8px;
                }

                .review-item.full-width {
                    grid-column: 1 / -1;
                }

                .review-label {
                    display: block;
                    font-size: 11px;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                }

                .review-value {
                    font-size: 14px;
                    font-weight: 500;
                    color: #111827;
                }

                .review-text {
                    font-size: 14px;
                    color: #374151;
                    margin: 0;
                    line-height: 1.5;
                }

                .review-photos {
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                    margin-top: 8px;
                }

                .review-photo {
                    width: 60px;
                    height: 60px;
                    object-fit: cover;
                    border-radius: 6px;
                }

                .time-summary {
                    margin-top: 16px;
                    padding: 12px;
                    border-radius: 8px;
                    text-align: center;
                    font-size: 14px;
                    font-weight: 500;
                }

                .time-summary.success {
                    background: #DCFCE7;
                    color: #16A34A;
                }

                .time-summary.warning {
                    background: #FEF3C7;
                    color: #D97706;
                }

                .error-message {
                    padding: 12px;
                    background: #FEE2E2;
                    color: #DC2626;
                    border-radius: 8px;
                    margin-bottom: 16px;
                    font-size: 14px;
                }

                .empty-state {
                    padding: 40px 20px;
                    text-align: center;
                    color: #6b7280;
                }

                /* Footer */
                .issue-logger-footer {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 16px 20px;
                    border-top: 1px solid #e5e7eb;
                    background: #f9fafb;
                }

                .footer-spacer {
                    flex: 1;
                }

                .btn-secondary, .btn-primary, .btn-submit {
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s;
                    min-height: 44px;
                }

                .btn-secondary {
                    background: white;
                    border: 2px solid #d1d5db;
                    color: #374151;
                }

                .btn-secondary:hover:not(:disabled) {
                    background: #f9fafb;
                    border-color: #9ca3af;
                }

                .btn-primary {
                    background: #0057B8;
                    border: 2px solid #0057B8;
                    color: white;
                }

                .btn-primary:hover:not(:disabled) {
                    background: #004494;
                    border-color: #004494;
                }

                .btn-submit {
                    background: #16A34A;
                    border: 2px solid #16A34A;
                    color: white;
                }

                .btn-submit:hover:not(:disabled) {
                    background: #15803D;
                    border-color: #15803D;
                }

                .btn-secondary:disabled, .btn-primary:disabled, .btn-submit:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
            `));
}

// Make component available globally
window.IssueLogger = IssueLogger;
})();


// ============================================================================
// FILE: onsite/ReportIssueLogger.jsx
// ============================================================================
(function() {
/**
 * ReportIssueLogger Component
 * 
 * Simplified issue logger for use within the DailyReportWizard.
 * Mobile-optimized with category/subcategory selection.
 */
// [Removed duplicate React destructuring]
function ReportIssueLogger({
  modules = [],
  initialData = null,
  onSubmit,
  onClose
}) {
  // Form state
  const [selectedModule, setSelectedModule] = useState(initialData?.module_id || null);
  const [category, setCategory] = useState(initialData?.category || '');
  const [subcategory, setSubcategory] = useState(initialData?.subcategory || '');
  const [severity, setSeverity] = useState(initialData?.severity || 'minor');
  const [description, setDescription] = useState(initialData?.description || '');
  const [actionTaken, setActionTaken] = useState(initialData?.action_taken || '');
  const [photos, setPhotos] = useState(initialData?.photos || []);

  // Get constants
  const ISSUE_CATEGORIES = window.MODA_DAILY_REPORTS?.ISSUE_CATEGORIES || {};
  const SEVERITY_LEVELS = window.MODA_DAILY_REPORTS?.SEVERITY_LEVELS || [];

  // Get subcategories for selected category
  const subcategories = category ? ISSUE_CATEGORIES[category]?.subcategories || [] : [];

  // Reset subcategory when category changes
  useEffect(() => {
    if (!subcategories.find(s => s.id === subcategory)) {
      setSubcategory('');
    }
  }, [category]);

  // Validation
  const isValid = category && description.trim().length >= 10;

  // Handle submit
  const handleSubmit = () => {
    if (!isValid) return;
    onSubmit({
      module_id: selectedModule,
      category,
      subcategory: subcategory || null,
      severity,
      description: description.trim(),
      action_taken: actionTaken.trim() || null,
      photos
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-overlay",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-modal",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-header"
  }, /*#__PURE__*/React.createElement("h3", null, initialData ? 'Edit Issue' : 'Log Issue'), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "close-btn"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-content"
  }, /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Module (Optional)"), /*#__PURE__*/React.createElement("select", {
    value: selectedModule || '',
    onChange: e => setSelectedModule(e.target.value || null),
    className: "form-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "General / Site Issue"), modules.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.blm_id || m.unit_type || 'N/A', " - ", m.serial_number)))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Category *"), /*#__PURE__*/React.createElement("div", {
    className: "category-grid"
  }, Object.entries(ISSUE_CATEGORIES).map(([key, cat]) => /*#__PURE__*/React.createElement("button", {
    key: key,
    type: "button",
    className: `category-btn ${category === key ? 'selected' : ''}`,
    onClick: () => setCategory(key)
  }, cat.label)))), subcategories.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Subcategory"), /*#__PURE__*/React.createElement("div", {
    className: "subcategory-grid"
  }, subcategories.map(sub => /*#__PURE__*/React.createElement("button", {
    key: sub.id,
    type: "button",
    className: `subcategory-btn ${subcategory === sub.id ? 'selected' : ''}`,
    onClick: () => setSubcategory(sub.id)
  }, sub.label)))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Severity *"), /*#__PURE__*/React.createElement("div", {
    className: "severity-selector"
  }, SEVERITY_LEVELS.map(level => /*#__PURE__*/React.createElement("button", {
    key: level.id,
    type: "button",
    className: `severity-btn ${severity === level.id ? 'selected' : ''}`,
    style: {
      '--severity-color': level.color
    },
    onClick: () => setSeverity(level.id)
  }, /*#__PURE__*/React.createElement("span", {
    className: "severity-label"
  }, level.label), /*#__PURE__*/React.createElement("span", {
    className: "severity-desc"
  }, level.description))))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Description * (min 10 characters)"), /*#__PURE__*/React.createElement("textarea", {
    value: description,
    onChange: e => setDescription(e.target.value),
    placeholder: "Describe the issue in detail...",
    className: "form-textarea",
    rows: 3
  }), /*#__PURE__*/React.createElement("span", {
    className: "char-count"
  }, description.length, " characters")), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Action Taken"), /*#__PURE__*/React.createElement("textarea", {
    value: actionTaken,
    onChange: e => setActionTaken(e.target.value),
    placeholder: "What action was taken to address this issue?",
    className: "form-textarea",
    rows: 2
  })), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Photos"), window.PhotoCapture && /*#__PURE__*/React.createElement(PhotoCapture, {
    photos: photos,
    onPhotosChange: setPhotos,
    maxPhotos: 5
  }))), /*#__PURE__*/React.createElement("div", {
    className: "issue-logger-footer"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "btn-secondary"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: handleSubmit,
    disabled: !isValid,
    className: "btn-primary"
  }, initialData ? 'Update Issue' : 'Add Issue'))));
}

// Make component available globally
window.ReportIssueLogger = ReportIssueLogger;
})();


// ============================================================================
// FILE: onsite/IssueComments.jsx
// ============================================================================
(function() {
/**
 * IssueComments Component
 * 
 * Displays and manages comments/responses on report issues.
 * Allows team members to discuss and track issue resolution.
 */
// [Removed duplicate React destructuring]
function IssueComments({
  issueId,
  comments: initialComments = [],
  onAddComment,
  onUpdateComment,
  onDeleteComment,
  readOnly = false
}) {
  const [comments, setComments] = useState(initialComments);
  const [newComment, setNewComment] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editText, setEditText] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState(null);
  const commentsEndRef = useRef(null);

  // Update comments when props change
  useEffect(() => {
    setComments(initialComments);
  }, [initialComments]);

  // Scroll to bottom when new comment added
  useEffect(() => {
    if (commentsEndRef.current) {
      commentsEndRef.current.scrollIntoView({
        behavior: 'smooth'
      });
    }
  }, [comments.length]);

  // Handle add comment
  const handleAddComment = async () => {
    if (!newComment.trim() || isSubmitting) return;
    setIsSubmitting(true);
    setError(null);
    try {
      if (onAddComment) {
        const added = await onAddComment(issueId, newComment.trim());
        if (added) {
          setComments([...comments, added]);
        }
      } else if (window.MODA_DAILY_REPORTS) {
        const added = await window.MODA_DAILY_REPORTS.addComment(issueId, newComment.trim());
        setComments([...comments, added]);
      }
      setNewComment('');
    } catch (err) {
      console.error('Error adding comment:', err);
      setError('Failed to add comment');
    } finally {
      setIsSubmitting(false);
    }
  };

  // Handle update comment
  const handleUpdateComment = async commentId => {
    if (!editText.trim() || isSubmitting) return;
    setIsSubmitting(true);
    setError(null);
    try {
      if (onUpdateComment) {
        await onUpdateComment(commentId, editText.trim());
      } else if (window.MODA_DAILY_REPORTS) {
        await window.MODA_DAILY_REPORTS.updateComment(commentId, editText.trim());
      }
      setComments(comments.map(c => c.id === commentId ? {
        ...c,
        comment: editText.trim(),
        updated_at: new Date().toISOString()
      } : c));
      setEditingId(null);
      setEditText('');
    } catch (err) {
      console.error('Error updating comment:', err);
      setError('Failed to update comment');
    } finally {
      setIsSubmitting(false);
    }
  };

  // Handle delete comment
  const handleDeleteComment = async commentId => {
    if (!confirm('Delete this comment?')) return;
    setIsSubmitting(true);
    setError(null);
    try {
      if (onDeleteComment) {
        await onDeleteComment(commentId);
      } else if (window.MODA_DAILY_REPORTS) {
        await window.MODA_DAILY_REPORTS.deleteComment(commentId);
      }
      setComments(comments.filter(c => c.id !== commentId));
    } catch (err) {
      console.error('Error deleting comment:', err);
      setError('Failed to delete comment');
    } finally {
      setIsSubmitting(false);
    }
  };

  // Start editing
  const startEditing = comment => {
    setEditingId(comment.id);
    setEditText(comment.comment);
  };

  // Cancel editing
  const cancelEditing = () => {
    setEditingId(null);
    setEditText('');
  };

  // Format timestamp
  const formatTimestamp = timestamp => {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
  };

  // Get current user for edit/delete permissions
  const currentUser = window.MODA_SUPABASE?.currentUser;
  return /*#__PURE__*/React.createElement("div", {
    className: "issue-comments"
  }, /*#__PURE__*/React.createElement("div", {
    className: "comments-list"
  }, comments.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "no-comments"
  }, /*#__PURE__*/React.createElement("p", null, "No comments yet")) : comments.map(comment => /*#__PURE__*/React.createElement("div", {
    key: comment.id,
    className: "comment-item"
  }, editingId === comment.id ? /*#__PURE__*/React.createElement("div", {
    className: "comment-edit"
  }, /*#__PURE__*/React.createElement("textarea", {
    value: editText,
    onChange: e => setEditText(e.target.value),
    className: "edit-textarea",
    rows: 2,
    autoFocus: true
  }), /*#__PURE__*/React.createElement("div", {
    className: "edit-actions"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: cancelEditing,
    className: "btn-link",
    disabled: isSubmitting
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => handleUpdateComment(comment.id),
    className: "btn-link primary",
    disabled: !editText.trim() || isSubmitting
  }, isSubmitting ? 'Saving...' : 'Save'))) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "comment-header"
  }, /*#__PURE__*/React.createElement("span", {
    className: "comment-author"
  }, comment.author_name), /*#__PURE__*/React.createElement("span", {
    className: "comment-time"
  }, formatTimestamp(comment.created_at)), comment.updated_at && comment.updated_at !== comment.created_at && /*#__PURE__*/React.createElement("span", {
    className: "comment-edited"
  }, "(edited)")), /*#__PURE__*/React.createElement("div", {
    className: "comment-text"
  }, comment.comment), !readOnly && currentUser && comment.author_id === currentUser.id && /*#__PURE__*/React.createElement("div", {
    className: "comment-actions"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => startEditing(comment),
    className: "btn-link"
  }, "Edit"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => handleDeleteComment(comment.id),
    className: "btn-link danger"
  }, "Delete"))))), /*#__PURE__*/React.createElement("div", {
    ref: commentsEndRef
  })), error && /*#__PURE__*/React.createElement("div", {
    className: "comments-error"
  }, error), !readOnly && /*#__PURE__*/React.createElement("div", {
    className: "add-comment-form"
  }, /*#__PURE__*/React.createElement("textarea", {
    value: newComment,
    onChange: e => setNewComment(e.target.value),
    placeholder: "Add a comment...",
    className: "comment-input",
    rows: 2,
    onKeyDown: e => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        handleAddComment();
      }
    }
  }), /*#__PURE__*/React.createElement("div", {
    className: "comment-form-footer"
  }, /*#__PURE__*/React.createElement("span", {
    className: "hint"
  }, "Ctrl+Enter to submit"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: handleAddComment,
    disabled: !newComment.trim() || isSubmitting,
    className: "btn-primary btn-sm"
  }, isSubmitting ? 'Adding...' : 'Add Comment'))));
}

/**
 * IssueCommentsModal - Wrapper for displaying comments in a modal
 */
function IssueCommentsModal({
  issue,
  onClose,
  onIssueUpdate
}) {
  const [comments, setComments] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // Fetch comments on mount
  useEffect(() => {
    fetchComments();
  }, [issue.id]);
  const fetchComments = async () => {
    setIsLoading(true);
    try {
      if (window.MODA_DAILY_REPORTS) {
        const data = await window.MODA_DAILY_REPORTS.getCommentsByIssue(issue.id);
        setComments(data);
      }
    } catch (err) {
      console.error('Error fetching comments:', err);
    } finally {
      setIsLoading(false);
    }
  };

  // Get category label
  const categoryLabel = window.MODA_DAILY_REPORTS?.ISSUE_CATEGORIES[issue.category]?.label || issue.category;
  return /*#__PURE__*/React.createElement("div", {
    className: "modal-overlay",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal-content issue-comments-modal",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal-header"
  }, /*#__PURE__*/React.createElement("h3", null, "Issue Discussion"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "close-btn"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "modal-body"
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-summary-card"
  }, /*#__PURE__*/React.createElement("div", {
    className: "issue-meta"
  }, /*#__PURE__*/React.createElement("span", {
    className: `severity-badge ${issue.severity}`
  }, issue.severity), /*#__PURE__*/React.createElement("span", {
    className: "category-badge"
  }, categoryLabel), /*#__PURE__*/React.createElement("span", {
    className: `status-badge ${issue.status}`
  }, issue.status)), /*#__PURE__*/React.createElement("p", {
    className: "issue-description"
  }, issue.description), issue.action_taken && /*#__PURE__*/React.createElement("div", {
    className: "issue-action"
  }, /*#__PURE__*/React.createElement("strong", null, "Action Taken:"), " ", issue.action_taken), /*#__PURE__*/React.createElement("div", {
    className: "issue-reporter"
  }, "Reported by ", issue.reported_by_name || 'Unknown', " on", ' ', new Date(issue.reported_at).toLocaleDateString())), isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "loading-state"
  }, /*#__PURE__*/React.createElement("div", {
    className: "spinner"
  }), /*#__PURE__*/React.createElement("p", null, "Loading comments...")) : /*#__PURE__*/React.createElement(IssueComments, {
    issueId: issue.id,
    comments: comments
  })), /*#__PURE__*/React.createElement("div", {
    className: "modal-footer"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "btn-secondary"
  }, "Close"))));
}

// Make components available globally
window.IssueComments = IssueComments;
window.IssueCommentsModal = IssueCommentsModal;
})();


// ============================================================================
// FILE: onsite/DailyReportWizard.jsx
// ============================================================================
(function() {
/**
 * DailyReportWizard Component
 * 
 * Mobile-first wizard for creating daily set reports.
 * 
 * Steps:
 * 1. Report Setup - Select project, date, fetch weather
 * 2. Module Status - Mark which modules were set, set sequence
 * 3. Issues - Log any issues found (uses IssueLogger)
 * 4. Photos - Add general photos
 * 5. Review & Submit
 */
// [Removed duplicate React destructuring]
function DailyReportWizard({
  projects = [],
  onClose,
  onSubmit,
  initialProjectId = null,
  initialDate = null
}) {
  // Wizard state
  const [currentStep, setCurrentStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [isSaving, setIsSaving] = useState(false);

  // Report data
  const [reportId, setReportId] = useState(null);
  const [selectedProject, setSelectedProject] = useState(null);
  const [reportDate, setReportDate] = useState(initialDate || window.MODA_DAILY_REPORTS?.getYesterday() || '');
  const [existingReport, setExistingReport] = useState(null);

  // Weather data
  const [weatherData, setWeatherData] = useState(null);
  const [weatherSource, setWeatherSource] = useState('api');
  const [manualWeather, setManualWeather] = useState({
    temperature_high: '',
    temperature_low: '',
    conditions: '',
    wind_speed: '',
    wind_direction: '',
    precipitation: '',
    notes: ''
  });
  const [isFetchingWeather, setIsFetchingWeather] = useState(false);

  // Module data
  const [projectModules, setProjectModules] = useState([]);
  const [reportModules, setReportModules] = useState([]);
  const [moduleSearch, setModuleSearch] = useState('');

  // Issues
  const [issues, setIssues] = useState([]);
  const [showIssueLogger, setShowIssueLogger] = useState(false);
  const [editingIssue, setEditingIssue] = useState(null);

  // Photos
  const [generalPhotos, setGeneralPhotos] = useState([]);

  // General notes
  const [generalNotes, setGeneralNotes] = useState('');

  // Steps configuration
  const steps = [{
    id: 1,
    label: 'Setup',
    icon: 'icon-settings'
  }, {
    id: 2,
    label: 'Modules',
    icon: 'icon-module'
  }, {
    id: 3,
    label: 'Issues',
    icon: 'icon-warning'
  }, {
    id: 4,
    label: 'Photos',
    icon: 'icon-camera'
  }, {
    id: 5,
    label: 'Review',
    icon: 'icon-check'
  }];

  // Initialize with project if provided
  useEffect(() => {
    if (initialProjectId && projects.length > 0) {
      const project = projects.find(p => p.id === initialProjectId);
      if (project) {
        setSelectedProject(project);
      }
    }
  }, [initialProjectId, projects]);

  // Check for existing report when project/date changes
  useEffect(() => {
    if (selectedProject && reportDate) {
      checkExistingReport();
    }
  }, [selectedProject, reportDate]);

  // Fetch project modules when project selected
  useEffect(() => {
    if (selectedProject) {
      fetchProjectModules();
    }
  }, [selectedProject]);

  // Check if report already exists for this project/date
  const checkExistingReport = async () => {
    if (!window.MODA_DAILY_REPORTS) return;
    try {
      const existing = await window.MODA_DAILY_REPORTS.getReportByDate(selectedProject.id, reportDate);
      if (existing) {
        setExistingReport(existing);
        // Load existing report data
        const fullReport = await window.MODA_DAILY_REPORTS.getReport(existing.id);
        if (fullReport) {
          setReportId(fullReport.id);
          setWeatherData(fullReport.weather_conditions);
          setWeatherSource(fullReport.weather_source);
          setGeneralNotes(fullReport.general_notes || '');

          // Load modules
          if (fullReport.report_modules) {
            setReportModules(fullReport.report_modules.map(rm => ({
              ...rm,
              module: rm.modules
            })));
          }

          // Load issues
          if (fullReport.report_issues) {
            setIssues(fullReport.report_issues);
          }

          // Load photos
          if (fullReport.report_photos) {
            setGeneralPhotos(fullReport.report_photos.filter(p => !p.module_id && !p.issue_id));
          }
        }
      } else {
        setExistingReport(null);
        setReportId(null);
      }
    } catch (err) {
      console.error('Error checking existing report:', err);
    }
  };

  // Fetch modules for selected project
  const fetchProjectModules = async () => {
    if (!selectedProject) return;
    setIsLoading(true);
    try {
      // Try Supabase first
      if (window.MODA_SUPABASE?.client) {
        const {
          data,
          error
        } = await window.MODA_SUPABASE.client.from('modules').select('*').eq('project_id', selectedProject.id).order('serial_number');
        if (!error && data) {
          setProjectModules(data);
          return;
        }
      }

      // Fallback to project's embedded modules
      if (selectedProject.modules) {
        setProjectModules(selectedProject.modules);
      }
    } catch (err) {
      console.error('Error fetching modules:', err);
      setError('Failed to load project modules');
    } finally {
      setIsLoading(false);
    }
  };

  // Fetch weather for project location
  const fetchWeather = async () => {
    if (!selectedProject) return;
    setIsFetchingWeather(true);
    try {
      // Get coordinates from project location or use default
      // For now, using Phoenix, AZ as default (Autovol location)
      const lat = selectedProject.latitude || 33.4484;
      const lon = selectedProject.longitude || -112.0740;
      const weather = await window.MODA_DAILY_REPORTS.fetchWeather(lat, lon, reportDate);
      if (weather) {
        setWeatherData(weather);
        setWeatherSource('api');
      } else {
        setError('Could not fetch weather data. Please enter manually.');
        setWeatherSource('manual');
      }
    } catch (err) {
      console.error('Error fetching weather:', err);
      setWeatherSource('manual');
    } finally {
      setIsFetchingWeather(false);
    }
  };

  // Create or update report
  const saveReport = async () => {
    if (!selectedProject || !reportDate) return null;
    setIsSaving(true);
    setError(null);
    try {
      const weatherToSave = weatherSource === 'api' ? weatherData : manualWeather;
      if (reportId) {
        // Update existing
        await window.MODA_DAILY_REPORTS.updateReport(reportId, {
          weather_source: weatherSource,
          weather_conditions: weatherToSave,
          general_notes: generalNotes
        });
        return reportId;
      } else {
        // Create new
        const report = await window.MODA_DAILY_REPORTS.createReport(selectedProject.id, reportDate, {
          weatherSource,
          weatherConditions: weatherToSave,
          generalNotes,
          sharepointFolderPath: window.MODA_DAILY_REPORTS.generateSharePointPath(selectedProject.name, reportDate)
        });
        setReportId(report.id);
        return report.id;
      }
    } catch (err) {
      console.error('Error saving report:', err);
      setError(err.message || 'Failed to save report');
      return null;
    } finally {
      setIsSaving(false);
    }
  };

  // Toggle module in report
  const toggleModuleInReport = module => {
    const existing = reportModules.find(rm => rm.module_id === module.id);
    if (existing) {
      setReportModules(reportModules.filter(rm => rm.module_id !== module.id));
    } else {
      setReportModules([...reportModules, {
        module_id: module.id,
        module: module,
        set_status: 'not_set',
        set_sequence: reportModules.length + 1,
        set_time: null,
        set_by: '',
        notes: ''
      }]);
    }
  };

  // Update module status
  const updateModuleStatus = (moduleId, updates) => {
    setReportModules(reportModules.map(rm => rm.module_id === moduleId ? {
      ...rm,
      ...updates
    } : rm));
  };

  // Reorder modules (for set sequence)
  const reorderModules = (fromIndex, toIndex) => {
    const updated = [...reportModules];
    const [moved] = updated.splice(fromIndex, 1);
    updated.splice(toIndex, 0, moved);

    // Update sequence numbers
    updated.forEach((rm, idx) => {
      rm.set_sequence = idx + 1;
    });
    setReportModules(updated);
  };

  // Add issue
  const handleAddIssue = issueData => {
    const newIssue = {
      ...issueData,
      id: `temp_${Date.now()}`,
      status: 'open',
      reported_at: new Date().toISOString()
    };
    setIssues([...issues, newIssue]);
    setShowIssueLogger(false);
  };

  // Update issue
  const handleUpdateIssue = (issueId, updates) => {
    setIssues(issues.map(i => i.id === issueId ? {
      ...i,
      ...updates
    } : i));
  };

  // Delete issue
  const handleDeleteIssue = issueId => {
    if (confirm('Delete this issue?')) {
      setIssues(issues.filter(i => i.id !== issueId));
    }
  };

  // Filter modules by search
  const filteredModules = useMemo(() => {
    if (!moduleSearch) return projectModules;
    const search = moduleSearch.toLowerCase();
    return projectModules.filter(m => {
      const serial = (m.serial_number || '').toLowerCase();
      const blm = (m.blm_id || '').toLowerCase();
      const unit = (m.unit_type || '').toLowerCase();
      return serial.includes(search) || blm.includes(search) || unit.includes(search);
    });
  }, [projectModules, moduleSearch]);

  // Calculate summary stats
  const summary = useMemo(() => {
    const modulesSet = reportModules.filter(rm => rm.set_status === 'set').length;
    const modulesPartial = reportModules.filter(rm => rm.set_status === 'partial').length;
    const modulesNotSet = reportModules.filter(rm => rm.set_status === 'not_set').length;
    const criticalIssues = issues.filter(i => i.severity === 'critical').length;
    const majorIssues = issues.filter(i => i.severity === 'major').length;
    const minorIssues = issues.filter(i => i.severity === 'minor').length;
    return {
      totalModules: reportModules.length,
      modulesSet,
      modulesPartial,
      modulesNotSet,
      totalIssues: issues.length,
      criticalIssues,
      majorIssues,
      minorIssues,
      totalPhotos: generalPhotos.length
    };
  }, [reportModules, issues, generalPhotos]);

  // Validation for each step
  const canProceed = useMemo(() => {
    switch (currentStep) {
      case 1:
        return selectedProject && reportDate;
      case 2:
        return reportModules.length > 0;
      case 3:
        return true;
      // Issues are optional
      case 4:
        return true;
      // Photos are optional
      case 5:
        return true;
      default:
        return false;
    }
  }, [currentStep, selectedProject, reportDate, reportModules]);

  // Handle step navigation
  const goToStep = async step => {
    if (step > currentStep && !canProceed) return;

    // Save progress when leaving certain steps
    if (currentStep === 1 && step > 1) {
      const savedId = await saveReport();
      if (!savedId) return;
    }
    setCurrentStep(step);
  };

  // Handle final submit
  const handleSubmit = async () => {
    setIsSaving(true);
    setError(null);
    try {
      // Ensure report is saved
      let currentReportId = reportId;
      if (!currentReportId) {
        currentReportId = await saveReport();
        if (!currentReportId) throw new Error('Failed to save report');
      }

      // Save modules
      for (const rm of reportModules) {
        if (rm.id && !rm.id.startsWith('temp_')) {
          await window.MODA_DAILY_REPORTS.updateReportModule(rm.id, {
            set_status: rm.set_status,
            set_time: rm.set_time,
            set_sequence: rm.set_sequence,
            set_by: rm.set_by,
            notes: rm.notes
          });
        } else {
          await window.MODA_DAILY_REPORTS.addModuleToReport(currentReportId, rm.module_id, {
            setStatus: rm.set_status,
            setTime: rm.set_time,
            setSequence: rm.set_sequence,
            setBy: rm.set_by,
            notes: rm.notes
          });
        }
      }

      // Save issues
      for (const issue of issues) {
        if (issue.id && !issue.id.startsWith('temp_')) {
          await window.MODA_DAILY_REPORTS.updateIssue(issue.id, {
            category: issue.category,
            subcategory: issue.subcategory,
            severity: issue.severity,
            description: issue.description,
            action_taken: issue.action_taken
          });
        } else {
          await window.MODA_DAILY_REPORTS.createIssue(currentReportId, {
            moduleId: issue.module_id,
            category: issue.category,
            subcategory: issue.subcategory,
            severity: issue.severity,
            description: issue.description,
            actionTaken: issue.action_taken
          });
        }
      }

      // Save photos
      for (const photo of generalPhotos) {
        if (!photo.id || photo.id.startsWith('temp_')) {
          await window.MODA_DAILY_REPORTS.addPhoto(currentReportId, {
            photoType: 'general',
            localData: photo.data || photo.local_data,
            caption: photo.caption,
            fileName: photo.file_name
          });
        }
      }

      // Update general notes
      await window.MODA_DAILY_REPORTS.updateReport(currentReportId, {
        general_notes: generalNotes
      });

      // Call onSubmit callback
      if (onSubmit) {
        onSubmit(currentReportId);
      }
      onClose();
    } catch (err) {
      console.error('Error submitting report:', err);
      setError(err.message || 'Failed to submit report');
    } finally {
      setIsSaving(false);
    }
  };

  // Get weather display
  const getWeatherDisplay = () => {
    const data = weatherSource === 'api' ? weatherData : manualWeather;
    if (!data) return null;
    return /*#__PURE__*/React.createElement("div", {
      className: "weather-display"
    }, /*#__PURE__*/React.createElement("div", {
      className: "weather-temp"
    }, /*#__PURE__*/React.createElement("span", {
      className: "temp-high"
    }, data.temperature_high || '--', "\xB0"), /*#__PURE__*/React.createElement("span", {
      className: "temp-separator"
    }, "/"), /*#__PURE__*/React.createElement("span", {
      className: "temp-low"
    }, data.temperature_low || '--', "\xB0")), /*#__PURE__*/React.createElement("div", {
      className: "weather-conditions"
    }, data.conditions || 'Unknown'), data.wind_speed && /*#__PURE__*/React.createElement("div", {
      className: "weather-wind"
    }, "Wind: ", data.wind_speed, " mph ", data.wind_direction || ''));
  };

  // Render step content
  const renderStepContent = () => {
    switch (currentStep) {
      case 1:
        return renderSetupStep();
      case 2:
        return renderModulesStep();
      case 3:
        return renderIssuesStep();
      case 4:
        return renderPhotosStep();
      case 5:
        return renderReviewStep();
      default:
        return null;
    }
  };

  // Step 1: Setup
  const renderSetupStep = () => /*#__PURE__*/React.createElement("div", {
    className: "wizard-step setup-step"
  }, /*#__PURE__*/React.createElement("h3", null, "Report Setup"), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Project"), /*#__PURE__*/React.createElement("select", {
    value: selectedProject?.id || '',
    onChange: e => {
      const project = projects.find(p => p.id === e.target.value);
      setSelectedProject(project);
      setReportModules([]);
      setIssues([]);
    },
    className: "form-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select Project..."), projects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name)))), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "Report Date"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: reportDate,
    onChange: e => setReportDate(e.target.value),
    className: "form-input",
    max: new Date().toISOString().split('T')[0]
  }), /*#__PURE__*/React.createElement("p", {
    className: "form-hint"
  }, "Typically yesterday's date")), existingReport && /*#__PURE__*/React.createElement("div", {
    className: "existing-report-notice"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-info"
  }), /*#__PURE__*/React.createElement("span", null, "A report already exists for this date. You are editing the existing report.")), /*#__PURE__*/React.createElement("div", {
    className: "form-group weather-section"
  }, /*#__PURE__*/React.createElement("label", null, "Weather Conditions"), /*#__PURE__*/React.createElement("div", {
    className: "weather-source-toggle"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: `toggle-btn ${weatherSource === 'api' ? 'active' : ''}`,
    onClick: () => setWeatherSource('api')
  }, "Auto-fetch"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: `toggle-btn ${weatherSource === 'manual' ? 'active' : ''}`,
    onClick: () => setWeatherSource('manual')
  }, "Manual Entry")), weatherSource === 'api' ? /*#__PURE__*/React.createElement("div", {
    className: "weather-api-section"
  }, weatherData ? getWeatherDisplay() : /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: fetchWeather,
    disabled: !selectedProject || isFetchingWeather,
    className: "btn-secondary fetch-weather-btn"
  }, isFetchingWeather ? 'Fetching...' : 'Fetch Weather'), weatherData && /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: fetchWeather,
    className: "btn-link refresh-weather"
  }, "Refresh")) : /*#__PURE__*/React.createElement("div", {
    className: "weather-manual-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "weather-grid"
  }, /*#__PURE__*/React.createElement("div", {
    className: "weather-field"
  }, /*#__PURE__*/React.createElement("label", null, "High Temp (\xB0F)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: manualWeather.temperature_high,
    onChange: e => setManualWeather({
      ...manualWeather,
      temperature_high: e.target.value
    }),
    className: "form-input"
  })), /*#__PURE__*/React.createElement("div", {
    className: "weather-field"
  }, /*#__PURE__*/React.createElement("label", null, "Low Temp (\xB0F)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: manualWeather.temperature_low,
    onChange: e => setManualWeather({
      ...manualWeather,
      temperature_low: e.target.value
    }),
    className: "form-input"
  })), /*#__PURE__*/React.createElement("div", {
    className: "weather-field"
  }, /*#__PURE__*/React.createElement("label", null, "Conditions"), /*#__PURE__*/React.createElement("select", {
    value: manualWeather.conditions,
    onChange: e => setManualWeather({
      ...manualWeather,
      conditions: e.target.value
    }),
    className: "form-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), /*#__PURE__*/React.createElement("option", {
    value: "Clear"
  }, "Clear"), /*#__PURE__*/React.createElement("option", {
    value: "Partly Cloudy"
  }, "Partly Cloudy"), /*#__PURE__*/React.createElement("option", {
    value: "Cloudy"
  }, "Cloudy"), /*#__PURE__*/React.createElement("option", {
    value: "Light Rain"
  }, "Light Rain"), /*#__PURE__*/React.createElement("option", {
    value: "Rain"
  }, "Rain"), /*#__PURE__*/React.createElement("option", {
    value: "Heavy Rain"
  }, "Heavy Rain"), /*#__PURE__*/React.createElement("option", {
    value: "Windy"
  }, "Windy"), /*#__PURE__*/React.createElement("option", {
    value: "Hot"
  }, "Hot"))), /*#__PURE__*/React.createElement("div", {
    className: "weather-field"
  }, /*#__PURE__*/React.createElement("label", null, "Wind (mph)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: manualWeather.wind_speed,
    onChange: e => setManualWeather({
      ...manualWeather,
      wind_speed: e.target.value
    }),
    className: "form-input"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "weather-field full-width"
  }, /*#__PURE__*/React.createElement("label", null, "Weather Notes"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: manualWeather.notes,
    onChange: e => setManualWeather({
      ...manualWeather,
      notes: e.target.value
    }),
    placeholder: "e.g., Morning fog cleared by 9am",
    className: "form-input"
  })))));

  // Step 2: Modules
  const renderModulesStep = () => /*#__PURE__*/React.createElement("div", {
    className: "wizard-step modules-step"
  }, /*#__PURE__*/React.createElement("h3", null, "Module Set Status"), /*#__PURE__*/React.createElement("p", {
    className: "step-description"
  }, "Select modules that were scheduled for this day and update their set status."), /*#__PURE__*/React.createElement("div", {
    className: "module-search"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: moduleSearch,
    onChange: e => setModuleSearch(e.target.value),
    placeholder: "Search modules...",
    className: "search-input"
  })), /*#__PURE__*/React.createElement("div", {
    className: "modules-section"
  }, /*#__PURE__*/React.createElement("h4", null, "Available Modules (", filteredModules.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "module-list available-modules"
  }, filteredModules.map(module => {
    const isSelected = reportModules.some(rm => rm.module_id === module.id);
    return /*#__PURE__*/React.createElement("button", {
      key: module.id,
      type: "button",
      className: `module-chip ${isSelected ? 'selected' : ''}`,
      onClick: () => toggleModuleInReport(module)
    }, /*#__PURE__*/React.createElement("span", {
      className: "module-blm"
    }, module.blm_id || module.unit_type || 'N/A'), /*#__PURE__*/React.createElement("span", {
      className: "module-serial"
    }, module.serial_number), isSelected && /*#__PURE__*/React.createElement("span", {
      className: "check-icon"
    }, "\u2713"));
  }))), reportModules.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "modules-section"
  }, /*#__PURE__*/React.createElement("h4", null, "Selected Modules (", reportModules.length, ")"), /*#__PURE__*/React.createElement("p", {
    className: "section-hint"
  }, "Drag to reorder set sequence"), /*#__PURE__*/React.createElement("div", {
    className: "selected-modules-list"
  }, reportModules.map((rm, index) => /*#__PURE__*/React.createElement("div", {
    key: rm.module_id,
    className: "selected-module-card"
  }, /*#__PURE__*/React.createElement("div", {
    className: "module-sequence"
  }, rm.set_sequence), /*#__PURE__*/React.createElement("div", {
    className: "module-info"
  }, /*#__PURE__*/React.createElement("div", {
    className: "module-primary"
  }, rm.module?.blm_id || rm.module?.unit_type || 'N/A'), /*#__PURE__*/React.createElement("div", {
    className: "module-secondary"
  }, "SN: ", rm.module?.serial_number)), /*#__PURE__*/React.createElement("div", {
    className: "module-status-selector"
  }, window.MODA_DAILY_REPORTS?.SET_STATUSES.map(status => /*#__PURE__*/React.createElement("button", {
    key: status.id,
    type: "button",
    className: `status-btn ${rm.set_status === status.id ? 'active' : ''}`,
    style: {
      '--status-color': status.color
    },
    onClick: () => updateModuleStatus(rm.module_id, {
      set_status: status.id,
      set_time: status.id === 'set' ? new Date().toISOString() : rm.set_time
    })
  }, status.label))), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "remove-module-btn",
    onClick: () => toggleModuleInReport(rm.module),
    "aria-label": "Remove module"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close"
  })))))), reportModules.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "empty-state"
  }, /*#__PURE__*/React.createElement("p", null, "Select modules from the list above")));

  // Step 3: Issues
  const renderIssuesStep = () => /*#__PURE__*/React.createElement("div", {
    className: "wizard-step issues-step"
  }, /*#__PURE__*/React.createElement("h3", null, "Issues Found"), /*#__PURE__*/React.createElement("p", {
    className: "step-description"
  }, "Log any issues discovered during the set. Issues can be linked to specific modules."), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "btn-primary add-issue-btn",
    onClick: () => {
      setEditingIssue(null);
      setShowIssueLogger(true);
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-plus"
  }), "Add Issue"), issues.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "issues-list"
  }, issues.map(issue => {
    const module = reportModules.find(rm => rm.module_id === issue.module_id)?.module;
    const categoryInfo = window.MODA_DAILY_REPORTS?.ISSUE_CATEGORIES[issue.category];
    return /*#__PURE__*/React.createElement("div", {
      key: issue.id,
      className: `issue-card severity-${issue.severity}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "issue-header"
    }, /*#__PURE__*/React.createElement("span", {
      className: `severity-badge ${issue.severity}`
    }, issue.severity), /*#__PURE__*/React.createElement("span", {
      className: "issue-category"
    }, categoryInfo?.label || issue.category), module && /*#__PURE__*/React.createElement("span", {
      className: "issue-module"
    }, module.blm_id || module.serial_number)), /*#__PURE__*/React.createElement("div", {
      className: "issue-description"
    }, issue.description), issue.action_taken && /*#__PURE__*/React.createElement("div", {
      className: "issue-action"
    }, /*#__PURE__*/React.createElement("strong", null, "Action:"), " ", issue.action_taken), /*#__PURE__*/React.createElement("div", {
      className: "issue-actions"
    }, /*#__PURE__*/React.createElement("button", {
      type: "button",
      className: "btn-link",
      onClick: () => {
        setEditingIssue(issue);
        setShowIssueLogger(true);
      }
    }, "Edit"), /*#__PURE__*/React.createElement("button", {
      type: "button",
      className: "btn-link danger",
      onClick: () => handleDeleteIssue(issue.id)
    }, "Delete")));
  })) : /*#__PURE__*/React.createElement("div", {
    className: "empty-state"
  }, /*#__PURE__*/React.createElement("p", null, "No issues logged yet"), /*#__PURE__*/React.createElement("p", {
    className: "hint"
  }, "If no issues were found, you can proceed to the next step")), showIssueLogger && /*#__PURE__*/React.createElement(ReportIssueLogger, {
    modules: reportModules.map(rm => rm.module),
    initialData: editingIssue,
    onSubmit: data => {
      if (editingIssue) {
        handleUpdateIssue(editingIssue.id, data);
      } else {
        handleAddIssue(data);
      }
      setShowIssueLogger(false);
    },
    onClose: () => setShowIssueLogger(false)
  }));

  // Step 4: Photos
  const renderPhotosStep = () => /*#__PURE__*/React.createElement("div", {
    className: "wizard-step photos-step"
  }, /*#__PURE__*/React.createElement("h3", null, "General Photos"), /*#__PURE__*/React.createElement("p", {
    className: "step-description"
  }, "Add general site photos not specific to any module or issue."), window.PhotoCapture && /*#__PURE__*/React.createElement(PhotoCapture, {
    photos: generalPhotos.map(p => p.data || p.local_data),
    onPhotosChange: photos => {
      setGeneralPhotos(photos.map((data, idx) => ({
        id: `temp_${Date.now()}_${idx}`,
        data,
        photo_type: 'general',
        file_name: `general_${idx + 1}.jpg`
      })));
    },
    maxPhotos: 10
  }), /*#__PURE__*/React.createElement("div", {
    className: "form-group"
  }, /*#__PURE__*/React.createElement("label", null, "General Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: generalNotes,
    onChange: e => setGeneralNotes(e.target.value),
    placeholder: "Any additional notes about the day's activities...",
    className: "form-textarea",
    rows: 4
  })));

  // Step 5: Review
  const renderReviewStep = () => /*#__PURE__*/React.createElement("div", {
    className: "wizard-step review-step"
  }, /*#__PURE__*/React.createElement("h3", null, "Review Report"), /*#__PURE__*/React.createElement("div", {
    className: "review-header"
  }, /*#__PURE__*/React.createElement("h4", null, selectedProject?.name), /*#__PURE__*/React.createElement("div", {
    className: "review-date"
  }, new Date(reportDate).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }))), /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("h5", null, "Weather"), getWeatherDisplay() || /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No weather data")), /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("h5", null, "Modules"), /*#__PURE__*/React.createElement("div", {
    className: "summary-stats"
  }, /*#__PURE__*/React.createElement("div", {
    className: "stat-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.modulesSet), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Set")), /*#__PURE__*/React.createElement("div", {
    className: "stat-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.modulesPartial), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Partial")), /*#__PURE__*/React.createElement("div", {
    className: "stat-item"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.modulesNotSet), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Not Set"))), /*#__PURE__*/React.createElement("div", {
    className: "module-summary-list"
  }, reportModules.map(rm => /*#__PURE__*/React.createElement("div", {
    key: rm.module_id,
    className: `module-summary-item status-${rm.set_status}`
  }, /*#__PURE__*/React.createElement("span", {
    className: "module-name"
  }, rm.module?.blm_id || rm.module?.serial_number), /*#__PURE__*/React.createElement("span", {
    className: `status-badge ${rm.set_status}`
  }, rm.set_status.replace('_', ' ')))))), /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("h5", null, "Issues (", summary.totalIssues, ")"), summary.totalIssues > 0 ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "summary-stats"
  }, /*#__PURE__*/React.createElement("div", {
    className: "stat-item critical"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.criticalIssues), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Critical")), /*#__PURE__*/React.createElement("div", {
    className: "stat-item major"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.majorIssues), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Major")), /*#__PURE__*/React.createElement("div", {
    className: "stat-item minor"
  }, /*#__PURE__*/React.createElement("span", {
    className: "stat-value"
  }, summary.minorIssues), /*#__PURE__*/React.createElement("span", {
    className: "stat-label"
  }, "Minor"))), /*#__PURE__*/React.createElement("div", {
    className: "issues-summary-list"
  }, issues.map(issue => /*#__PURE__*/React.createElement("div", {
    key: issue.id,
    className: `issue-summary-item severity-${issue.severity}`
  }, /*#__PURE__*/React.createElement("span", {
    className: `severity-dot ${issue.severity}`
  }), /*#__PURE__*/React.createElement("span", {
    className: "issue-desc"
  }, issue.description.substring(0, 50), "..."))))) : /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No issues reported")), /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("h5", null, "Photos (", summary.totalPhotos, ")"), summary.totalPhotos > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "photo-thumbnails"
  }, generalPhotos.slice(0, 4).map((photo, idx) => /*#__PURE__*/React.createElement("img", {
    key: idx,
    src: photo.data || photo.local_data,
    alt: `Photo ${idx + 1}`,
    className: "photo-thumb"
  })), generalPhotos.length > 4 && /*#__PURE__*/React.createElement("div", {
    className: "photo-more"
  }, "+", generalPhotos.length - 4)) : /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No photos added")), generalNotes && /*#__PURE__*/React.createElement("div", {
    className: "review-section"
  }, /*#__PURE__*/React.createElement("h5", null, "Notes"), /*#__PURE__*/React.createElement("p", {
    className: "notes-text"
  }, generalNotes)));
  return /*#__PURE__*/React.createElement("div", {
    className: "daily-report-wizard-overlay"
  }, /*#__PURE__*/React.createElement("div", {
    className: "daily-report-wizard"
  }, /*#__PURE__*/React.createElement("div", {
    className: "wizard-header"
  }, /*#__PURE__*/React.createElement("h2", null, "Daily Set Report"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "close-btn",
    "aria-label": "Close"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "wizard-progress"
  }, steps.map((step, index) => /*#__PURE__*/React.createElement("button", {
    key: step.id,
    type: "button",
    className: `progress-step ${currentStep === step.id ? 'active' : ''} ${currentStep > step.id ? 'completed' : ''}`,
    onClick: () => goToStep(step.id),
    disabled: step.id > currentStep && !canProceed
  }, /*#__PURE__*/React.createElement("div", {
    className: "step-indicator"
  }, currentStep > step.id ? /*#__PURE__*/React.createElement("span", {
    className: "check-mark"
  }, "\u2713") : /*#__PURE__*/React.createElement("span", {
    className: "step-number"
  }, step.id)), /*#__PURE__*/React.createElement("span", {
    className: "step-label"
  }, step.label)))), error && /*#__PURE__*/React.createElement("div", {
    className: "wizard-error"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-warning"
  }), error, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setError(null),
    className: "dismiss-btn"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-close"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "wizard-content"
  }, isLoading ? /*#__PURE__*/React.createElement("div", {
    className: "loading-state"
  }, /*#__PURE__*/React.createElement("div", {
    className: "spinner"
  }), /*#__PURE__*/React.createElement("p", null, "Loading...")) : renderStepContent()), /*#__PURE__*/React.createElement("div", {
    className: "wizard-footer"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => goToStep(currentStep - 1),
    disabled: currentStep === 1 || isSaving,
    className: "btn-secondary"
  }, "Back"), /*#__PURE__*/React.createElement("div", {
    className: "step-indicator-mobile"
  }, "Step ", currentStep, " of ", steps.length), currentStep < steps.length ? /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => goToStep(currentStep + 1),
    disabled: !canProceed || isSaving,
    className: "btn-primary"
  }, isSaving ? 'Saving...' : 'Next') : /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: handleSubmit,
    disabled: isSaving,
    className: "btn-primary submit-btn"
  }, isSaving ? 'Submitting...' : 'Save Report'))));
}

// Make component available globally
window.DailyReportWizard = DailyReportWizard;
})();


// ============================================================================
// FILE: onsite/ModuleReportHistory.jsx
// ============================================================================
(function() {
/**
 * ModuleReportHistory Component
 * 
 * Displays report history for a specific module.
 * Shows all daily reports, issues, and photos associated with the module.
 * Used in Project Directory module detail view.
 */
// [Removed duplicate React destructuring]
function ModuleReportHistory({
  moduleId,
  moduleName
}) {
  const [isLoading, setIsLoading] = useState(true);
  const [reportHistory, setReportHistory] = useState([]);
  const [issues, setIssues] = useState([]);
  const [photos, setPhotos] = useState([]);
  const [activeTab, setActiveTab] = useState('reports');
  const [selectedIssue, setSelectedIssue] = useState(null);
  const [error, setError] = useState(null);

  // Fetch data on mount
  useEffect(() => {
    if (moduleId) {
      fetchModuleData();
    }
  }, [moduleId]);
  const fetchModuleData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      if (window.MODA_DAILY_REPORTS) {
        // Fetch report history
        const history = await window.MODA_DAILY_REPORTS.getModuleReportHistory(moduleId);
        setReportHistory(history || []);

        // Fetch issues
        const moduleIssues = await window.MODA_DAILY_REPORTS.getIssuesByModule(moduleId);
        setIssues(moduleIssues || []);

        // Fetch photos
        const modulePhotos = await window.MODA_DAILY_REPORTS.getPhotosByModule(moduleId);
        setPhotos(modulePhotos || []);
      }
    } catch (err) {
      console.error('Error fetching module report data:', err);
      setError('Failed to load report history');
    } finally {
      setIsLoading(false);
    }
  };

  // Format date
  const formatDate = dateStr => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };

  // Get status color
  const getStatusColor = status => {
    switch (status) {
      case 'set':
        return '#16a34a';
      case 'partial':
        return '#ea580c';
      case 'not_set':
        return '#6b7280';
      default:
        return '#6b7280';
    }
  };

  // Get severity color
  const getSeverityColor = severity => {
    switch (severity) {
      case 'critical':
        return '#dc2626';
      case 'major':
        return '#ea580c';
      case 'minor':
        return '#16a34a';
      default:
        return '#6b7280';
    }
  };
  if (isLoading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "module-report-history loading"
    }, /*#__PURE__*/React.createElement("div", {
      className: "spinner"
    }), /*#__PURE__*/React.createElement("p", null, "Loading report history..."));
  }
  if (error) {
    return /*#__PURE__*/React.createElement("div", {
      className: "module-report-history error"
    }, /*#__PURE__*/React.createElement("p", null, error), /*#__PURE__*/React.createElement("button", {
      onClick: fetchModuleData,
      className: "btn-link"
    }, "Retry"));
  }
  const hasData = reportHistory.length > 0 || issues.length > 0 || photos.length > 0;
  if (!hasData) {
    return /*#__PURE__*/React.createElement("div", {
      className: "module-report-history empty"
    }, /*#__PURE__*/React.createElement("div", {
      className: "empty-icon"
    }, /*#__PURE__*/React.createElement("span", {
      className: "icon-document"
    })), /*#__PURE__*/React.createElement("p", null, "No report history for this module"), /*#__PURE__*/React.createElement("p", {
      className: "hint"
    }, "Reports will appear here once the module is included in a daily set report."));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "module-report-history"
  }, /*#__PURE__*/React.createElement("div", {
    className: "history-header"
  }, /*#__PURE__*/React.createElement("h4", null, "Report History"), moduleName && /*#__PURE__*/React.createElement("span", {
    className: "module-name"
  }, moduleName)), /*#__PURE__*/React.createElement("div", {
    className: "history-tabs"
  }, /*#__PURE__*/React.createElement("button", {
    className: `tab-btn ${activeTab === 'reports' ? 'active' : ''}`,
    onClick: () => setActiveTab('reports')
  }, "Reports (", reportHistory.length, ")"), /*#__PURE__*/React.createElement("button", {
    className: `tab-btn ${activeTab === 'issues' ? 'active' : ''}`,
    onClick: () => setActiveTab('issues')
  }, "Issues (", issues.length, ")"), /*#__PURE__*/React.createElement("button", {
    className: `tab-btn ${activeTab === 'photos' ? 'active' : ''}`,
    onClick: () => setActiveTab('photos')
  }, "Photos (", photos.length, ")")), /*#__PURE__*/React.createElement("div", {
    className: "history-content"
  }, activeTab === 'reports' && /*#__PURE__*/React.createElement("div", {
    className: "reports-list"
  }, reportHistory.length === 0 ? /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No reports yet") : reportHistory.map((report, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "report-item"
  }, /*#__PURE__*/React.createElement("div", {
    className: "report-date"
  }, formatDate(report.report_date)), /*#__PURE__*/React.createElement("div", {
    className: "report-details"
  }, /*#__PURE__*/React.createElement("span", {
    className: "set-status",
    style: {
      color: getStatusColor(report.set_status)
    }
  }, report.set_status?.replace('_', ' ') || 'Unknown'), report.set_sequence && /*#__PURE__*/React.createElement("span", {
    className: "set-sequence"
  }, "Set #", report.set_sequence), report.issue_count > 0 && /*#__PURE__*/React.createElement("span", {
    className: "issue-count"
  }, report.issue_count, " issue", report.issue_count !== 1 ? 's' : ''), report.photo_count > 0 && /*#__PURE__*/React.createElement("span", {
    className: "photo-count"
  }, report.photo_count, " photo", report.photo_count !== 1 ? 's' : '')), report.notes && /*#__PURE__*/React.createElement("div", {
    className: "report-notes"
  }, report.notes)))), activeTab === 'issues' && /*#__PURE__*/React.createElement("div", {
    className: "issues-list"
  }, issues.length === 0 ? /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No issues reported") : issues.map(issue => {
    const categoryLabel = window.MODA_DAILY_REPORTS?.ISSUE_CATEGORIES[issue.category]?.label || issue.category;
    return /*#__PURE__*/React.createElement("div", {
      key: issue.id,
      className: `issue-item severity-${issue.severity}`,
      onClick: () => setSelectedIssue(issue)
    }, /*#__PURE__*/React.createElement("div", {
      className: "issue-header"
    }, /*#__PURE__*/React.createElement("span", {
      className: "severity-badge",
      style: {
        backgroundColor: getSeverityColor(issue.severity)
      }
    }, issue.severity), /*#__PURE__*/React.createElement("span", {
      className: "issue-category"
    }, categoryLabel), /*#__PURE__*/React.createElement("span", {
      className: `issue-status ${issue.status}`
    }, issue.status)), /*#__PURE__*/React.createElement("div", {
      className: "issue-description"
    }, issue.description), /*#__PURE__*/React.createElement("div", {
      className: "issue-meta"
    }, /*#__PURE__*/React.createElement("span", null, formatDate(issue.reported_at)), issue.report_issue_comments?.length > 0 && /*#__PURE__*/React.createElement("span", null, issue.report_issue_comments.length, " comment", issue.report_issue_comments.length !== 1 ? 's' : '')));
  })), activeTab === 'photos' && /*#__PURE__*/React.createElement("div", {
    className: "photos-grid"
  }, photos.length === 0 ? /*#__PURE__*/React.createElement("p", {
    className: "no-data"
  }, "No photos") : photos.map((photo, idx) => /*#__PURE__*/React.createElement("div", {
    key: photo.id || idx,
    className: "photo-item"
  }, photo.sharepoint_url ? /*#__PURE__*/React.createElement("a", {
    href: photo.sharepoint_url,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "photo-link"
  }, photo.thumbnail_url ? /*#__PURE__*/React.createElement("img", {
    src: photo.thumbnail_url,
    alt: photo.caption || 'Photo'
  }) : /*#__PURE__*/React.createElement("div", {
    className: "photo-placeholder"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-image"
  }), /*#__PURE__*/React.createElement("span", null, "View"))) : photo.local_data ? /*#__PURE__*/React.createElement("img", {
    src: photo.local_data,
    alt: photo.caption || 'Photo'
  }) : /*#__PURE__*/React.createElement("div", {
    className: "photo-placeholder"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-image"
  })), photo.caption && /*#__PURE__*/React.createElement("div", {
    className: "photo-caption"
  }, photo.caption), /*#__PURE__*/React.createElement("div", {
    className: "photo-date"
  }, formatDate(photo.daily_reports?.report_date || photo.created_at)))))), selectedIssue && window.IssueCommentsModal && /*#__PURE__*/React.createElement(IssueCommentsModal, {
    issue: selectedIssue,
    onClose: () => setSelectedIssue(null)
  }), /*#__PURE__*/React.createElement("style", null, `
                .module-report-history {
                    padding: 16px;
                    background: #f9fafb;
                    border-radius: 8px;
                }

                .module-report-history.loading,
                .module-report-history.error,
                .module-report-history.empty {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 32px;
                    text-align: center;
                    color: #6b7280;
                }

                .module-report-history .empty-icon {
                    width: 48px;
                    height: 48px;
                    background: #e5e7eb;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 12px;
                }

                .module-report-history .hint {
                    font-size: 13px;
                    color: #9ca3af;
                    margin-top: 4px;
                }

                .history-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 12px;
                }

                .history-header h4 {
                    margin: 0;
                    font-size: 16px;
                    font-weight: 600;
                    color: #111827;
                }

                .history-header .module-name {
                    font-size: 13px;
                    color: #6b7280;
                }

                .history-tabs {
                    display: flex;
                    gap: 4px;
                    margin-bottom: 16px;
                    border-bottom: 1px solid #e5e7eb;
                    padding-bottom: 8px;
                }

                .tab-btn {
                    padding: 8px 12px;
                    border: none;
                    background: transparent;
                    font-size: 13px;
                    font-weight: 500;
                    color: #6b7280;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s;
                }

                .tab-btn:hover {
                    background: #e5e7eb;
                }

                .tab-btn.active {
                    background: #0057B8;
                    color: white;
                }

                .history-content {
                    max-height: 400px;
                    overflow-y: auto;
                }

                .no-data {
                    text-align: center;
                    color: #9ca3af;
                    font-size: 14px;
                    padding: 24px;
                }

                /* Reports List */
                .reports-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .report-item {
                    padding: 12px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                }

                .report-date {
                    font-size: 14px;
                    font-weight: 600;
                    color: #111827;
                    margin-bottom: 4px;
                }

                .report-details {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    font-size: 12px;
                }

                .set-status {
                    font-weight: 600;
                    text-transform: capitalize;
                }

                .set-sequence,
                .issue-count,
                .photo-count {
                    color: #6b7280;
                }

                .report-notes {
                    margin-top: 8px;
                    font-size: 13px;
                    color: #374151;
                    font-style: italic;
                }

                /* Issues List */
                .issues-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .issue-item {
                    padding: 12px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                    border-left: 3px solid #6b7280;
                    cursor: pointer;
                    transition: background 0.2s;
                }

                .issue-item:hover {
                    background: #f9fafb;
                }

                .issue-item.severity-critical {
                    border-left-color: #dc2626;
                }

                .issue-item.severity-major {
                    border-left-color: #ea580c;
                }

                .issue-item.severity-minor {
                    border-left-color: #16a34a;
                }

                .issue-header {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    margin-bottom: 6px;
                }

                .severity-badge {
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: 600;
                    color: white;
                    text-transform: uppercase;
                }

                .issue-category {
                    font-size: 12px;
                    font-weight: 500;
                    color: #374151;
                }

                .issue-status {
                    font-size: 11px;
                    padding: 2px 6px;
                    border-radius: 4px;
                    background: #e5e7eb;
                    color: #374151;
                }

                .issue-status.open {
                    background: #fee2e2;
                    color: #dc2626;
                }

                .issue-status.resolved {
                    background: #dcfce7;
                    color: #16a34a;
                }

                .issue-description {
                    font-size: 13px;
                    color: #111827;
                    line-height: 1.4;
                    margin-bottom: 6px;
                }

                .issue-meta {
                    display: flex;
                    gap: 12px;
                    font-size: 11px;
                    color: #9ca3af;
                }

                /* Photos Grid */
                .photos-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                }

                .photo-item {
                    position: relative;
                    aspect-ratio: 1;
                    background: white;
                    border-radius: 6px;
                    overflow: hidden;
                    border: 1px solid #e5e7eb;
                }

                .photo-item img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }

                .photo-link {
                    display: block;
                    width: 100%;
                    height: 100%;
                }

                .photo-placeholder {
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: #f3f4f6;
                    color: #6b7280;
                    font-size: 12px;
                }

                .photo-caption {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 4px 6px;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    font-size: 10px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .photo-date {
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    padding: 2px 6px;
                    background: rgba(0, 0, 0, 0.6);
                    color: white;
                    font-size: 9px;
                    border-radius: 4px;
                }
            `));
}

// Make component available globally
window.ModuleReportHistory = ModuleReportHistory;
})();


// ============================================================================
// FILE: onsite/OnSiteTab.jsx
// ============================================================================
(function() {
// On-Site Tab - Field Operations Management
// Placeholder - rebuilding from scratch
// [Removed duplicate React destructuring]
/**
 * OnSiteTab - Main container for field operations
 * 
 * PLANNED FEATURES (to be implemented):
 * - Daily Set Reports
 * - Module tracking on-site
 * - Issue logging with photos
 * - Weather integration
 * - PDF report generation
 * 
 * This is a placeholder while we rebuild the tab from scratch.
 */
function OnSiteTab({
  projects = [],
  employees = [],
  currentUser = null
}) {
  return /*#__PURE__*/React.createElement("div", {
    className: "onsite-tab-placeholder",
    style: {
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '400px',
      padding: '40px 20px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: '80px',
      height: '80px',
      borderRadius: '50%',
      backgroundColor: '#f0f9ff',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      marginBottom: '24px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-construction",
    style: {
      width: '40px',
      height: '40px',
      display: 'block',
      opacity: 0.6
    }
  })), /*#__PURE__*/React.createElement("h2", {
    style: {
      fontSize: '24px',
      fontWeight: '600',
      color: '#1e293b',
      marginBottom: '12px'
    }
  }, "On-Site Tab - Coming Soon"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '16px',
      color: '#64748b',
      maxWidth: '400px',
      lineHeight: '1.5'
    }
  }, "This section is being rebuilt with an improved workflow for field operations and daily reporting."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: '32px',
      padding: '16px 24px',
      backgroundColor: '#fefce8',
      borderRadius: '8px',
      border: '1px solid #fef08a'
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: '14px',
      color: '#854d0e',
      margin: 0
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Status:"), " Awaiting new implementation plan")));
}

// Export for use
window.OnSiteTab = OnSiteTab;
})();


// ============================================================================
// FILE: AdminPanel.jsx
// ============================================================================
(function() {
/**
 * AdminPanel.jsx
 * Consolidated Admin tab with collapsible accordion sections grouped by category.
 * Persists expansion state to localStorage.
 */

(function () {
  'use strict';
// [Removed duplicate React destructuring]
  const STORAGE_KEY = 'moda_admin_panel_state';
  const ADMIN_SECTIONS = {
    usersAccess: {
      id: 'usersAccess',
      title: 'Users & Access',
      description: 'Manage user permissions and dashboard roles',
      sections: [{
        id: 'userPermissions',
        title: 'User Permissions',
        description: 'Manage user access and permissions'
      }, {
        id: 'dashboardRoles',
        title: 'Dashboard Roles',
        description: 'Configure role-based access control'
      }]
    },
    appConfig: {
      id: 'appConfig',
      title: 'App Configuration',
      description: 'Customize application settings and categories',
      sections: [{
        id: 'issueTypes',
        title: 'Issue Types',
        description: 'Manage issue types, routing, and export issues data'
      }, {
        id: 'issueCategories',
        title: 'Issue Categories',
        description: 'Manage sub-categories within each issue type'
      }]
    },
    system: {
      id: 'system',
      title: 'System',
      description: 'Data management and activity monitoring',
      sections: [{
        id: 'dataManagement',
        title: 'Data Management',
        description: 'Manage trash, backup and restore data'
      }, {
        id: 'activityLog',
        title: 'Activity Log',
        description: 'View system activity and audit trail'
      }]
    }
  };
  function CollapsibleSection({
    id,
    title,
    description,
    isExpanded,
    onToggle,
    children
  }) {
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg shadow overflow-hidden"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => onToggle(id),
      className: "w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors",
      style: {
        borderBottom: isExpanded ? '1px solid #e5e7eb' : 'none'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-left"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "text-lg font-semibold",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, title), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500 mt-0.5"
    }, description)), /*#__PURE__*/React.createElement("div", {
      className: "flex-shrink-0 ml-4 transition-transform duration-200",
      style: {
        transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'
      }
    }, /*#__PURE__*/React.createElement("svg", {
      width: "20",
      height: "20",
      viewBox: "0 0 20 20",
      fill: "none",
      xmlns: "http://www.w3.org/2000/svg"
    }, /*#__PURE__*/React.createElement("path", {
      d: "M5 7.5L10 12.5L15 7.5",
      stroke: "currentColor",
      strokeWidth: "2",
      strokeLinecap: "round",
      strokeLinejoin: "round"
    })))), isExpanded && /*#__PURE__*/React.createElement("div", {
      className: "p-6"
    }, children));
  }
  function CategoryHeader({
    title,
    description
  }) {
    return /*#__PURE__*/React.createElement("div", {
      className: "mb-3 mt-6 first:mt-0"
    }, /*#__PURE__*/React.createElement("h2", {
      className: "text-xs font-bold uppercase tracking-wider text-gray-400"
    }, title));
  }
  function AdminPanel({
    auth,
    onOpenDataManagement
  }) {
    const [expandedSections, setExpandedSections] = useState(() => {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Failed to load admin panel state:', e);
      }
      return {
        userPermissions: true
      };
    });
    useEffect(() => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expandedSections));
      } catch (e) {
        console.warn('Failed to save admin panel state:', e);
      }
    }, [expandedSections]);
    const toggleSection = useCallback(sectionId => {
      setExpandedSections(prev => ({
        ...prev,
        [sectionId]: !prev[sectionId]
      }));
    }, []);
    const renderSectionContent = sectionId => {
      switch (sectionId) {
        case 'userPermissions':
          return window.UserPermissionsManager ? /*#__PURE__*/React.createElement(window.UserPermissionsManager, {
            auth: auth
          }) : /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
            className: "text-gray-600 mb-4"
          }, "Manage users through Supabase Dashboard or the People module."), /*#__PURE__*/React.createElement("a", {
            href: "https://supabase.com/dashboard/project/syreuphexagezawjyjgt/auth/users",
            target: "_blank",
            rel: "noopener noreferrer",
            className: "inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
          }, "Open Supabase Auth Dashboard"));
        case 'dashboardRoles':
          return window.DashboardRoleManager ? /*#__PURE__*/React.createElement(window.DashboardRoleManager, {
            auth: auth
          }) : /*#__PURE__*/React.createElement("p", {
            className: "text-gray-500"
          }, "Loading Role Manager...");
        case 'issueTypes':
          return window.IssueTypesManager ? /*#__PURE__*/React.createElement(window.IssueTypesManager, {
            auth: auth
          }) : /*#__PURE__*/React.createElement("p", {
            className: "text-gray-500"
          }, "Issue Types Manager not loaded.");
        case 'issueCategories':
          return window.IssueCategoriesManager ? /*#__PURE__*/React.createElement(window.IssueCategoriesManager, {
            auth: auth
          }) : /*#__PURE__*/React.createElement("p", {
            className: "text-gray-500"
          }, "Issue Categories Manager not loaded.");
        case 'dataManagement':
          return /*#__PURE__*/React.createElement("div", {
            className: "flex items-center justify-between"
          }, /*#__PURE__*/React.createElement("p", {
            className: "text-gray-600"
          }, "Access trash, backup, and restore functionality."), /*#__PURE__*/React.createElement("button", {
            onClick: onOpenDataManagement,
            className: "px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition flex items-center gap-2"
          }, /*#__PURE__*/React.createElement("span", {
            className: "icon-settings",
            style: {
              width: '16px',
              height: '16px',
              display: 'inline-block'
            }
          }), "Open Data Management"));
        case 'activityLog':
          return window.ActivityLogViewer ? /*#__PURE__*/React.createElement(window.ActivityLogViewer, {
            showFilters: true,
            showExport: true,
            maxHeight: "500px"
          }) : /*#__PURE__*/React.createElement("p", {
            className: "text-gray-500"
          }, "Activity logging module not loaded.");
        default:
          return /*#__PURE__*/React.createElement("p", {
            className: "text-gray-500"
          }, "Section not found.");
      }
    };
    return /*#__PURE__*/React.createElement("div", {
      className: "space-y-2 pb-8"
    }, Object.values(ADMIN_SECTIONS).map(category => /*#__PURE__*/React.createElement("div", {
      key: category.id
    }, /*#__PURE__*/React.createElement(CategoryHeader, {
      title: category.title,
      description: category.description
    }), /*#__PURE__*/React.createElement("div", {
      className: "space-y-2"
    }, category.sections.map(section => /*#__PURE__*/React.createElement(CollapsibleSection, {
      key: section.id,
      id: section.id,
      title: section.title,
      description: section.description,
      isExpanded: !!expandedSections[section.id],
      onToggle: toggleSection
    }, renderSectionContent(section.id)))))));
  }
  window.AdminPanel = AdminPanel;
})();
})();


// ============================================================================
// FILE: ActivityLogViewer.jsx
// ============================================================================
(function() {
// ============================================================================
// MODA Activity Log Viewer Component
// Admin UI for viewing and filtering activity logs
// ============================================================================

(function () {
  'use strict';
// [Removed duplicate React destructuring]
  // Action type display config
  const ACTION_TYPE_CONFIG = {
    login: {
      label: 'Login',
      color: 'bg-green-100 text-green-800',
      icon: 'icon-login'
    },
    logout: {
      label: 'Logout',
      color: 'bg-gray-100 text-gray-800',
      icon: 'icon-logout'
    },
    login_failed: {
      label: 'Login Failed',
      color: 'bg-red-100 text-red-800',
      icon: 'icon-warning'
    },
    password_reset: {
      label: 'Password Reset',
      color: 'bg-yellow-100 text-yellow-800',
      icon: 'icon-key'
    },
    password_change: {
      label: 'Password Change',
      color: 'bg-yellow-100 text-yellow-800',
      icon: 'icon-key'
    },
    create: {
      label: 'Create',
      color: 'bg-blue-100 text-blue-800',
      icon: 'icon-plus'
    },
    read: {
      label: 'View',
      color: 'bg-gray-100 text-gray-600',
      icon: 'icon-eye'
    },
    update: {
      label: 'Update',
      color: 'bg-amber-100 text-amber-800',
      icon: 'icon-edit'
    },
    delete: {
      label: 'Delete',
      color: 'bg-red-100 text-red-800',
      icon: 'icon-trash'
    },
    import: {
      label: 'Import',
      color: 'bg-purple-100 text-purple-800',
      icon: 'icon-upload'
    },
    export: {
      label: 'Export',
      color: 'bg-purple-100 text-purple-800',
      icon: 'icon-download'
    },
    bulk_update: {
      label: 'Bulk Update',
      color: 'bg-orange-100 text-orange-800',
      icon: 'icon-layers'
    },
    view: {
      label: 'View',
      color: 'bg-gray-100 text-gray-600',
      icon: 'icon-eye'
    },
    navigate: {
      label: 'Navigate',
      color: 'bg-gray-100 text-gray-500',
      icon: 'icon-arrow'
    }
  };

  // Category display config
  const CATEGORY_CONFIG = {
    auth: {
      label: 'Authentication',
      color: 'text-green-600'
    },
    project: {
      label: 'Project',
      color: 'text-blue-600'
    },
    module: {
      label: 'Module',
      color: 'text-indigo-600'
    },
    employee: {
      label: 'Employee',
      color: 'text-purple-600'
    },
    user: {
      label: 'User',
      color: 'text-pink-600'
    },
    permission: {
      label: 'Permission',
      color: 'text-red-600'
    },
    role: {
      label: 'Role',
      color: 'text-red-600'
    },
    deviation: {
      label: 'Deviation',
      color: 'text-orange-600'
    },
    transport: {
      label: 'Transport',
      color: 'text-cyan-600'
    },
    equipment: {
      label: 'Equipment',
      color: 'text-teal-600'
    },
    schedule: {
      label: 'Schedule',
      color: 'text-amber-600'
    },
    system: {
      label: 'System',
      color: 'text-gray-600'
    }
  };

  // Severity config
  const SEVERITY_CONFIG = {
    info: {
      label: 'Info',
      color: 'bg-blue-50 border-blue-200',
      dot: 'bg-blue-400'
    },
    warning: {
      label: 'Warning',
      color: 'bg-yellow-50 border-yellow-200',
      dot: 'bg-yellow-400'
    },
    critical: {
      label: 'Critical',
      color: 'bg-red-50 border-red-200',
      dot: 'bg-red-400'
    }
  };

  // Format relative time
  function formatRelativeTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  // Format full timestamp
  function formatFullTimestamp(dateString) {
    return new Date(dateString).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  // Single log entry row
  function ActivityLogRow({
    log,
    onUserClick,
    onEntityClick
  }) {
    const [expanded, setExpanded] = useState(false);
    const actionConfig = ACTION_TYPE_CONFIG[log.action_type] || {
      label: log.action_type,
      color: 'bg-gray-100 text-gray-800'
    };
    const categoryConfig = CATEGORY_CONFIG[log.action_category] || {
      label: log.action_category,
      color: 'text-gray-600'
    };
    const severityConfig = SEVERITY_CONFIG[log.severity] || SEVERITY_CONFIG.info;
    const hasDetails = log.details && Object.keys(log.details).length > 0;
    return /*#__PURE__*/React.createElement("div", {
      className: `border-l-4 ${severityConfig.color} border rounded-r-lg mb-2 hover:shadow-sm transition-shadow`
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-3 cursor-pointer",
      onClick: () => hasDetails && setExpanded(!expanded)
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between gap-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start gap-3 flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: `w-2 h-2 rounded-full mt-2 ${severityConfig.dot}`
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 flex-wrap"
    }, /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-0.5 rounded text-xs font-medium ${actionConfig.color}`
    }, actionConfig.label), /*#__PURE__*/React.createElement("span", {
      className: `text-xs font-medium ${categoryConfig.color}`
    }, categoryConfig.label)), /*#__PURE__*/React.createElement("div", {
      className: "mt-1 text-sm text-gray-900"
    }, /*#__PURE__*/React.createElement("button", {
      className: "font-medium text-blue-600 hover:underline",
      onClick: e => {
        e.stopPropagation();
        onUserClick?.(log.user_id, log.user_email);
      }
    }, log.user_name || log.user_email || 'Unknown'), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-600"
    }, ' ', log.action_type === 'login' || log.action_type === 'logout' ? log.action_type === 'login' ? 'logged in' : 'logged out' : `${log.action_type}d`, log.entity_name && /*#__PURE__*/React.createElement(React.Fragment, null, ' ', /*#__PURE__*/React.createElement("button", {
      className: "font-medium text-indigo-600 hover:underline",
      onClick: e => {
        e.stopPropagation();
        onEntityClick?.(log.entity_type, log.entity_id);
      }
    }, log.entity_name)))))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-xs text-gray-500 whitespace-nowrap"
    }, /*#__PURE__*/React.createElement("span", {
      title: formatFullTimestamp(log.created_at)
    }, formatRelativeTime(log.created_at)), hasDetails && /*#__PURE__*/React.createElement("svg", {
      className: `w-4 h-4 transition-transform ${expanded ? 'rotate-180' : ''}`,
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M19 9l-7 7-7-7"
    }))))), expanded && hasDetails && /*#__PURE__*/React.createElement("div", {
      className: "px-3 pb-3 pt-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "ml-5 p-2 bg-gray-50 rounded text-xs font-mono overflow-x-auto"
    }, /*#__PURE__*/React.createElement("pre", {
      className: "whitespace-pre-wrap text-gray-700"
    }, JSON.stringify(log.details, null, 2)))));
  }

  // Filter panel
  function FilterPanel({
    filters,
    onFilterChange,
    onReset
  }) {
    const actionTypes = Object.keys(ACTION_TYPE_CONFIG);
    const categories = Object.keys(CATEGORY_CONFIG);
    const severities = Object.keys(SEVERITY_CONFIG);
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white border rounded-lg p-4 mb-4"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between mb-3"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-900"
    }, "Filters"), /*#__PURE__*/React.createElement("button", {
      onClick: onReset,
      className: "text-sm text-blue-600 hover:text-blue-800"
    }, "Reset")), /*#__PURE__*/React.createElement("div", {
      className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "User Email"), /*#__PURE__*/React.createElement("input", {
      type: "text",
      value: filters.userEmail || '',
      onChange: e => onFilterChange({
        userEmail: e.target.value || null
      }),
      placeholder: "Search by email...",
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "Action Type"), /*#__PURE__*/React.createElement("select", {
      value: filters.actionType || '',
      onChange: e => onFilterChange({
        actionType: e.target.value || null
      }),
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "All Actions"), actionTypes.map(type => /*#__PURE__*/React.createElement("option", {
      key: type,
      value: type
    }, ACTION_TYPE_CONFIG[type].label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "Category"), /*#__PURE__*/React.createElement("select", {
      value: filters.actionCategory || '',
      onChange: e => onFilterChange({
        actionCategory: e.target.value || null
      }),
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "All Categories"), categories.map(cat => /*#__PURE__*/React.createElement("option", {
      key: cat,
      value: cat
    }, CATEGORY_CONFIG[cat].label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "Severity"), /*#__PURE__*/React.createElement("select", {
      value: filters.severity || '',
      onChange: e => onFilterChange({
        severity: e.target.value || null
      }),
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "All Severities"), severities.map(sev => /*#__PURE__*/React.createElement("option", {
      key: sev,
      value: sev
    }, SEVERITY_CONFIG[sev].label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "Start Date"), /*#__PURE__*/React.createElement("input", {
      type: "date",
      value: filters.startDate ? filters.startDate.split('T')[0] : '',
      onChange: e => onFilterChange({
        startDate: e.target.value ? new Date(e.target.value).toISOString() : null
      }),
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
      className: "block text-xs font-medium text-gray-700 mb-1"
    }, "End Date"), /*#__PURE__*/React.createElement("input", {
      type: "date",
      value: filters.endDate ? filters.endDate.split('T')[0] : '',
      onChange: e => onFilterChange({
        endDate: e.target.value ? new Date(e.target.value + 'T23:59:59').toISOString() : null
      }),
      className: "w-full px-3 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
    }))));
  }

  // Main Activity Log Viewer component
  function ActivityLogViewer({
    initialFilters = {},
    showFilters = true,
    showExport = true,
    maxHeight = '600px',
    onUserClick,
    onEntityClick
  }) {
    const [filters, setFilters] = useState({
      userEmail: null,
      actionType: null,
      actionCategory: null,
      severity: null,
      startDate: null,
      endDate: null,
      limit: 50,
      ...initialFilters
    });
    const [showFilterPanel, setShowFilterPanel] = useState(false);

    // Use the activity logs hook
    const {
      logs,
      loading,
      error,
      totalCount,
      hasMore,
      refetch,
      loadMore
    } = window.useActivityLogs ? window.useActivityLogs(filters) : {
      logs: [],
      loading: false,
      error: 'Activity log hooks not loaded',
      totalCount: 0,
      hasMore: false,
      refetch: () => {},
      loadMore: () => {}
    };
    const handleFilterChange = useCallback(newFilters => {
      setFilters(prev => ({
        ...prev,
        ...newFilters
      }));
    }, []);
    const handleResetFilters = useCallback(() => {
      setFilters({
        userEmail: null,
        actionType: null,
        actionCategory: null,
        severity: null,
        startDate: null,
        endDate: null,
        limit: 50
      });
    }, []);
    const handleExport = useCallback(async () => {
      if (logs.length === 0) return;
      const csvContent = [['Timestamp', 'User', 'Email', 'Action', 'Category', 'Entity Type', 'Entity Name', 'Severity', 'Details'].join(','), ...logs.map(log => [formatFullTimestamp(log.created_at), `"${(log.user_name || '').replace(/"/g, '""')}"`, log.user_email, log.action_type, log.action_category, log.entity_type || '', `"${(log.entity_name || '').replace(/"/g, '""')}"`, log.severity, `"${JSON.stringify(log.details || {}).replace(/"/g, '""')}"`].join(','))].join('\n');
      const blob = new Blob([csvContent], {
        type: 'text/csv'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `activity-log-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      // Log the export action
      if (window.ActivityLog) {
        window.ActivityLog.logExport('system', 'activity_log', logs.length, 'csv');
      }
    }, [logs]);

    // Count active filters
    const activeFilterCount = useMemo(() => {
      return Object.entries(filters).filter(([key, value]) => value !== null && key !== 'limit').length;
    }, [filters]);
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-50 rounded-lg"
    }, /*#__PURE__*/React.createElement("div", {
      className: "p-4 border-b bg-white rounded-t-lg"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      className: "text-lg font-semibold text-gray-900"
    }, "Activity Log"), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, totalCount.toLocaleString(), " total entries", activeFilterCount > 0 && ` (${activeFilterCount} filter${activeFilterCount > 1 ? 's' : ''} active)`)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, showFilters && /*#__PURE__*/React.createElement("button", {
      onClick: () => setShowFilterPanel(!showFilterPanel),
      className: `px-3 py-1.5 text-sm border rounded-lg flex items-center gap-1 ${showFilterPanel || activeFilterCount > 0 ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white hover:bg-gray-50'}`
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
    })), "Filters", activeFilterCount > 0 && /*#__PURE__*/React.createElement("span", {
      className: "ml-1 px-1.5 py-0.5 bg-blue-600 text-white text-xs rounded-full"
    }, activeFilterCount)), /*#__PURE__*/React.createElement("button", {
      onClick: refetch,
      disabled: loading,
      className: "px-3 py-1.5 text-sm border rounded-lg bg-white hover:bg-gray-50 flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("svg", {
      className: `w-4 h-4 ${loading ? 'animate-spin' : ''}`,
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
    })), "Refresh"), showExport && /*#__PURE__*/React.createElement("button", {
      onClick: handleExport,
      disabled: logs.length === 0,
      className: "px-3 py-1.5 text-sm border rounded-lg bg-white hover:bg-gray-50 flex items-center gap-1 disabled:opacity-50"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-4 h-4",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
    })), "Export CSV")))), showFilterPanel && /*#__PURE__*/React.createElement("div", {
      className: "p-4 border-b"
    }, /*#__PURE__*/React.createElement(FilterPanel, {
      filters: filters,
      onFilterChange: handleFilterChange,
      onReset: handleResetFilters
    })), /*#__PURE__*/React.createElement("div", {
      className: "p-4",
      style: {
        maxHeight,
        overflowY: 'auto'
      }
    }, error && /*#__PURE__*/React.createElement("div", {
      className: "p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4"
    }, error), loading && logs.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "flex items-center justify-center py-12"
    }, /*#__PURE__*/React.createElement("div", {
      className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
    })) : logs.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "text-center py-12 text-gray-500"
    }, /*#__PURE__*/React.createElement("svg", {
      className: "w-12 h-12 mx-auto mb-4 text-gray-300",
      fill: "none",
      stroke: "currentColor",
      viewBox: "0 0 24 24"
    }, /*#__PURE__*/React.createElement("path", {
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 2,
      d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
    })), /*#__PURE__*/React.createElement("p", null, "No activity logs found"), activeFilterCount > 0 && /*#__PURE__*/React.createElement("button", {
      onClick: handleResetFilters,
      className: "mt-2 text-blue-600 hover:underline"
    }, "Clear filters")) : /*#__PURE__*/React.createElement(React.Fragment, null, logs.map(log => /*#__PURE__*/React.createElement(ActivityLogRow, {
      key: log.id,
      log: log,
      onUserClick: onUserClick,
      onEntityClick: onEntityClick
    })), hasMore && /*#__PURE__*/React.createElement("div", {
      className: "text-center py-4"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: loadMore,
      disabled: loading,
      className: "px-4 py-2 text-sm bg-white border rounded-lg hover:bg-gray-50 disabled:opacity-50"
    }, loading ? 'Loading...' : `Load More (${logs.length} of ${totalCount})`)))));
  }

  // Compact activity feed for dashboards
  function ActivityFeed({
    limit = 10,
    showHeader = true
  }) {
    const {
      recentLogs,
      isConnected
    } = window.useActivityFeed ? window.useActivityFeed({}) : {
      recentLogs: [],
      isConnected: false
    };
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(true);

    // Fetch initial logs
    useEffect(() => {
      async function fetchInitial() {
        if (!window.ActivityLog) {
          setLoading(false);
          return;
        }
        const result = await window.ActivityLog.getRecentActivity(limit);
        setLogs(result.data || []);
        setLoading(false);
      }
      fetchInitial();
    }, [limit]);

    // Merge real-time logs
    useEffect(() => {
      if (recentLogs.length > 0) {
        setLogs(prev => {
          const newLogs = [...recentLogs, ...prev];
          const uniqueLogs = newLogs.filter((log, index, self) => index === self.findIndex(l => l.id === log.id));
          return uniqueLogs.slice(0, limit);
        });
      }
    }, [recentLogs, limit]);
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white rounded-lg border"
    }, showHeader && /*#__PURE__*/React.createElement("div", {
      className: "px-4 py-3 border-b flex items-center justify-between"
    }, /*#__PURE__*/React.createElement("h3", {
      className: "font-medium text-gray-900"
    }, "Recent Activity"), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, isConnected && /*#__PURE__*/React.createElement("span", {
      className: "flex items-center gap-1 text-xs text-green-600"
    }, /*#__PURE__*/React.createElement("span", {
      className: "w-2 h-2 bg-green-500 rounded-full animate-pulse"
    }), "Live"))), /*#__PURE__*/React.createElement("div", {
      className: "divide-y max-h-80 overflow-y-auto"
    }, loading ? /*#__PURE__*/React.createElement("div", {
      className: "p-4 text-center text-gray-500"
    }, "Loading...") : logs.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "p-4 text-center text-gray-500"
    }, "No recent activity") : logs.map(log => {
      const actionConfig = ACTION_TYPE_CONFIG[log.action_type] || {};
      return /*#__PURE__*/React.createElement("div", {
        key: log.id,
        className: "px-4 py-2 hover:bg-gray-50"
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-2 text-sm"
      }, /*#__PURE__*/React.createElement("span", {
        className: `px-1.5 py-0.5 rounded text-xs ${actionConfig.color || 'bg-gray-100'}`
      }, actionConfig.label || log.action_type), /*#__PURE__*/React.createElement("span", {
        className: "text-gray-900 truncate"
      }, log.user_name || log.user_email), log.entity_name && /*#__PURE__*/React.createElement("span", {
        className: "text-gray-500 truncate"
      }, "- ", log.entity_name)), /*#__PURE__*/React.createElement("div", {
        className: "text-xs text-gray-400 mt-0.5"
      }, formatRelativeTime(log.created_at)));
    })));
  }

  // Export components
  window.ActivityLogViewer = ActivityLogViewer;
  window.ActivityFeed = ActivityFeed;
  console.log('[ActivityLogViewer] Component loaded');
})();
})();


// ============================================================================
// FILE: BuildSequenceHistory.jsx
// ============================================================================
(function() {
/**
 * Build Sequence History Viewer Component
 * Displays history of sequence changes with restore functionality
 */

const BuildSequenceHistory = ({
  projectId,
  projectName,
  modules,
  setProjects,
  auth,
  onClose
}) => {
// [Removed duplicate React destructuring]
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedEntry, setSelectedEntry] = useState(null);
  const [restoring, setRestoring] = useState(false);
  const [showConfirmRestore, setShowConfirmRestore] = useState(null);

  // Load history on mount
  useEffect(() => {
    const loadHistory = async () => {
      setLoading(true);
      try {
        if (window.MODA_SEQUENCE_HISTORY?.getHistory) {
          const data = await window.MODA_SEQUENCE_HISTORY.getHistory(projectId, 50);
          setHistory(data);
        }
      } catch (err) {
        console.error('[BuildSequenceHistory] Error loading:', err);
      } finally {
        setLoading(false);
      }
    };
    loadHistory();
  }, [projectId]);

  // Format change type for display
  const formatChangeType = type => {
    const types = {
      'manual_edit': 'Manual Edit',
      'import': 'CSV Import',
      'reorder': 'Reorder',
      'prototype_insert': 'Prototype Insert',
      'restore': 'Restored'
    };
    return types[type] || type;
  };

  // Get icon for change type
  const getChangeTypeIcon = type => {
    const icons = {
      'manual_edit': 'icon-edit',
      'import': 'icon-upload',
      'reorder': 'icon-move',
      'prototype_insert': 'icon-add',
      'restore': 'icon-restore'
    };
    return icons[type] || 'icon-edit';
  };

  // Get color for change type
  const getChangeTypeColor = type => {
    const colors = {
      'manual_edit': 'bg-blue-100 text-blue-800',
      'import': 'bg-purple-100 text-purple-800',
      'reorder': 'bg-amber-100 text-amber-800',
      'prototype_insert': 'bg-green-100 text-green-800',
      'restore': 'bg-gray-100 text-gray-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
  };

  // Compare selected entry with current state
  const comparison = useMemo(() => {
    if (!selectedEntry || !modules) return null;
    const currentSnapshot = modules.map(m => ({
      moduleId: m.id,
      serialNumber: m.serialNumber,
      buildSequence: m.buildSequence,
      hitchBLM: m.hitchBLM
    }));
    return window.MODA_SEQUENCE_HISTORY?.compareSnapshots?.(selectedEntry.sequence_snapshot, currentSnapshot) || [];
  }, [selectedEntry, modules]);

  // Handle restore
  const handleRestore = async entry => {
    setRestoring(true);
    try {
      const user = auth?.currentUser;
      const success = await window.MODA_SEQUENCE_HISTORY.restoreSnapshot(projectId, entry.id, setProjects, user);
      if (success) {
        // Refresh history
        const data = await window.MODA_SEQUENCE_HISTORY.getHistory(projectId, 50);
        setHistory(data);
        setShowConfirmRestore(null);
        setSelectedEntry(null);
      }
    } catch (err) {
      console.error('[BuildSequenceHistory] Restore error:', err);
    } finally {
      setRestoring(false);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b flex items-center justify-between flex-shrink-0"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, "Build Sequence History"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, projectName)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, "\xD7"))), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 overflow-hidden flex"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-1/2 border-r overflow-y-auto"
  }, loading ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading history...") : history.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-lg mb-2"
  }, "No history yet"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm"
  }, "Sequence changes will be logged here")) : /*#__PURE__*/React.createElement("div", {
    className: "divide-y"
  }, history.map(entry => /*#__PURE__*/React.createElement("div", {
    key: entry.id,
    className: `p-4 cursor-pointer hover:bg-gray-50 transition ${selectedEntry?.id === entry.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`,
    onClick: () => setSelectedEntry(entry)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-0.5 rounded text-xs font-medium ${getChangeTypeColor(entry.change_type)}`
  }, formatChangeType(entry.change_type)), entry.is_current && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
  }, "Current")), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-700 truncate"
  }, entry.change_description || 'No description'), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 mt-1 text-xs text-gray-500"
  }, /*#__PURE__*/React.createElement("span", null, new Date(entry.created_at).toLocaleString()), /*#__PURE__*/React.createElement("span", null, entry.module_count, " modules"), entry.changed_by_name && /*#__PURE__*/React.createElement("span", null, "by ", entry.changed_by_name))), !entry.is_current && /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      setShowConfirmRestore(entry);
    },
    className: "px-3 py-1 text-xs bg-amber-100 text-amber-700 rounded hover:bg-amber-200 flex-shrink-0"
  }, "Restore")))))), /*#__PURE__*/React.createElement("div", {
    className: "w-1/2 overflow-y-auto bg-gray-50"
  }, selectedEntry ? /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900 mb-3"
  }, "Snapshot Details"), comparison && comparison.length > 0 ? /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "text-sm font-medium text-gray-700 mb-2"
  }, "Differences from Current (", comparison.length, " changes)"), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border max-h-48 overflow-y-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-100 sticky top-0"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-left"
  }, "Serial"), /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-center"
  }, "Then"), /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-center"
  }, "Now"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, comparison.slice(0, 20).map((change, idx) => /*#__PURE__*/React.createElement("tr", {
    key: idx,
    className: change.isNew ? 'bg-green-50' : change.isRemoved ? 'bg-red-50' : ''
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 font-mono text-xs"
  }, change.serialNumber), /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 text-center"
  }, change.oldSequence ?? '-'), /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 text-center"
  }, change.newSequence ?? '-'))))), comparison.length > 20 && /*#__PURE__*/React.createElement("div", {
    className: "px-3 py-2 text-xs text-gray-500 bg-gray-50"
  }, "+ ", comparison.length - 20, " more changes"))) : comparison && /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700"
  }, "This snapshot matches the current sequence"), /*#__PURE__*/React.createElement("h4", {
    className: "text-sm font-medium text-gray-700 mb-2"
  }, "Full Sequence (", selectedEntry.module_count, " modules)"), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg border max-h-64 overflow-y-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-100 sticky top-0"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-left"
  }, "Seq"), /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-left"
  }, "Serial"), /*#__PURE__*/React.createElement("th", {
    className: "px-3 py-2 text-left"
  }, "BLM"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, selectedEntry.sequence_snapshot.sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0)).map((mod, idx) => /*#__PURE__*/React.createElement("tr", {
    key: idx,
    className: mod.isPrototype ? 'bg-purple-50' : ''
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 font-medium"
  }, mod.buildSequence), /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 font-mono text-xs"
  }, mod.serialNumber), /*#__PURE__*/React.createElement("td", {
    className: "px-3 py-1.5 text-gray-600"
  }, mod.hitchBLM || '-'))))))) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "Select an entry to view details")))), showConfirmRestore && /*#__PURE__*/React.createElement("div", {
    className: "absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-md w-full p-6"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-gray-900 mb-2"
  }, "Confirm Restore"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-4"
  }, "This will restore the build sequence to the snapshot from", ' ', /*#__PURE__*/React.createElement("strong", null, new Date(showConfirmRestore.created_at).toLocaleString()), "."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-amber-600 mb-4"
  }, "This will update ", showConfirmRestore.module_count, " module sequences. The current sequence will be saved to history before restoring."), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-end gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowConfirmRestore(null),
    className: "px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg",
    disabled: restoring
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleRestore(showConfirmRestore),
    className: "px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:opacity-50",
    disabled: restoring
  }, restoring ? 'Restoring...' : 'Restore Sequence'))))));
};

// Export
window.BuildSequenceHistory = BuildSequenceHistory;
})();


// ============================================================================
// FILE: App.jsx
// ============================================================================
(function() {
// MODA Dashboard - React Components
// Extracted from index.html for optimization
// [Removed duplicate React destructuring]
// Feature flag helper
const isFeatureEnabled = (flag, userEmail) => window.MODA_FEATURE_FLAGS?.isEnabled(flag, userEmail) || false;

// ===== AUTOVOL LOGO =====
const AUTOVOL_LOGO = "./public/autovol-logo.png";

// ===== LICENSE PLATE UTILITIES =====
const generateQRCode = text => {
  const qr = qrcode(0, 'M');
  qr.addData(text);
  qr.make();
  return qr.createDataURL(4, 0);
};
const buildModuleUrl = (baseUrl, projectId, serialNumber) => {
  // Point to the Module Scanner page
  const scannerUrl = baseUrl.replace(/[^/]*$/, 'Module_Scanner.html');
  return `${scannerUrl}?project=${encodeURIComponent(projectId)}&module=${encodeURIComponent(serialNumber)}`;
};

// Extract Building, Level, Module from BLM ID (e.g., B1L2M52 → Building 1, Level 2, Module 52)
const extractFromBLM = blmId => {
  const blm = String(blmId || '').toUpperCase();
  // Pattern: B{building}L{level}M{module} e.g., B1L2M52
  const match = blm.match(/B(\d+)L(\d+)M(\d+)/);
  if (match) {
    return {
      building: `B${match[1]}`,
      level: `L${match[2]}`,
      module: `M${match[3].padStart(2, '0')}`
    };
  }
  // Fallback: Try 3-digit serial format (e.g., 313 = Building 3, Level 1, Module 3)
  const serialMatch = String(blmId).match(/^(\d)(\d)(\d+)$/);
  if (serialMatch) {
    return {
      building: `B${serialMatch[1]}`,
      level: `L${serialMatch[2]}`,
      module: `M${serialMatch[3].padStart(2, '0')}`
    };
  }
  return {
    building: 'OTHER',
    level: 'OTHER',
    module: 'OTHER'
  };
};
const extractStack = serialNumber => {
  // Keep for backwards compatibility - now uses BLM extraction
  const result = extractFromBLM(serialNumber);
  return result.building !== 'OTHER' ? result.building : 'OTHER';
};
const extractUnitType = unitType => {
  const type = String(unitType).toUpperCase().replace(/[.\-_]/g, ' ').trim();
  const match = type.match(/^(\d*\s*B|STUDIO|STU)/i);
  return match ? match[0].replace(/\s+/g, '') : type.split(' ')[0] || 'OTHER';
};
const getLicensePlateIndicators = module => {
  const indicators = [];
  const difficulties = module.difficulties || {};
  if (difficulties.sidewall) indicators.push({
    key: 'SW',
    label: 'SW'
  });
  if (difficulties.short) indicators.push({
    key: 'SHORT',
    label: 'SHORT'
  });
  if (difficulties.stair) indicators.push({
    key: 'STAIR',
    label: 'STAIR'
  });
  if (difficulties.hr3Wall) indicators.push({
    key: '3HR',
    label: '3HR'
  });
  if (difficulties.doubleStudio) indicators.push({
    key: 'DBL',
    label: 'DBL STUDIO'
  });
  if (difficulties.sawbox) indicators.push({
    key: 'SAWBOX',
    label: 'SAWBOX'
  });
  if (difficulties.proto) indicators.push({
    key: 'PROTO',
    label: 'PROTO'
  });
  return indicators;
};
// ===== AUTHENTICATION SYSTEM =====

// ============================================================================
// DASHBOARD ROLES - CONSTANTS MOVED TO auth/AuthConstants.jsx
// ============================================================================

// Use window.ALL_AVAILABLE_TABS and window.DEFAULT_DASHBOARD_ROLES from AuthConstants.jsx
const ALL_AVAILABLE_TABS = window.ALL_AVAILABLE_TABS || [];
const DEFAULT_DASHBOARD_ROLES = window.DEFAULT_DASHBOARD_ROLES || [];

// ============================================================================
// AUTH MODULE - EXTRACTED TO auth/AuthModule.jsx
// LOGIN PAGE - EXTRACTED TO auth/LoginPage.jsx
// ROLE MANAGER - EXTRACTED TO auth/RoleManager.jsx
// ============================================================================
// ===== END AUTHENTICATION SYSTEM =====

// Production Stages Definition - 21 stations with staggers
// startingSerial: the module serial # that starts at this station this week
// stagger: offset from Automation (calculated from starting modules)
const productionStages = [{
  id: 'auto-c',
  name: 'Automation (Ceiling)',
  dept: 'AUTO-C',
  color: 'bg-slate-700',
  group: 'automation',
  startingSerial: '25-0861'
}, {
  id: 'auto-f',
  name: 'Automation (Floor)',
  dept: 'AUTO-F',
  color: 'bg-slate-600',
  group: 'automation',
  startingSerial: '25-0861'
}, {
  id: 'auto-walls',
  name: 'Automation (Walls)',
  dept: 'AUTO-W',
  color: 'bg-slate-500',
  group: 'automation',
  startingSerial: '25-0861'
}, {
  id: 'mezzanine',
  name: 'Mezzanine (FC Prep, Plumbing - Floors)',
  dept: 'MEZZ',
  color: 'bg-violet-500',
  group: null,
  startingSerial: '25-0860'
}, {
  id: 'elec-ceiling',
  name: 'Electrical - Ceilings',
  dept: 'ELEC-C',
  color: 'bg-amber-400',
  group: null,
  startingSerial: '25-0857'
}, {
  id: 'wall-set',
  name: 'Wall Set',
  dept: 'WALL',
  color: 'bg-autovol-teal',
  group: null,
  startingSerial: '25-0856'
}, {
  id: 'ceiling-set',
  name: 'Ceiling Set',
  dept: 'CEIL',
  color: 'bg-teal-400',
  group: null,
  startingSerial: '25-0855'
}, {
  id: 'soffits',
  name: 'Soffits',
  dept: 'SOFF',
  color: 'bg-sky-500',
  group: null,
  startingSerial: '25-0854'
}, {
  id: 'mech-rough',
  name: 'Mechanical Rough-In',
  dept: 'MECH-R',
  color: 'bg-cyan-600',
  group: 'mep-rough',
  startingSerial: '25-0959'
}, {
  id: 'elec-rough',
  name: 'Electrical Rough-In',
  dept: 'ELEC-R',
  color: 'bg-cyan-500',
  group: 'mep-rough',
  startingSerial: '25-0959'
}, {
  id: 'plumb-rough',
  name: 'Plumbing Rough-In',
  dept: 'PLMB-R',
  color: 'bg-cyan-400',
  group: 'mep-rough',
  startingSerial: '25-0959'
}, {
  id: 'exteriors',
  name: 'Exteriors',
  dept: 'EXT',
  color: 'bg-teal-500',
  group: null,
  startingSerial: '25-0853'
}, {
  id: 'drywall-bp',
  name: 'Drywall - BackPanel',
  dept: 'DRY-BP',
  color: 'bg-green-600',
  group: null,
  startingSerial: '25-0852'
}, {
  id: 'drywall-ttp',
  name: 'Drywall - Tape/Texture/Paint',
  dept: 'DRY-TTP',
  color: 'bg-green-500',
  group: null,
  startingSerial: '25-0846'
}, {
  id: 'roofing',
  name: 'Roofing',
  dept: 'ROOF',
  color: 'bg-amber-500',
  group: null,
  startingSerial: '25-0848'
}, {
  id: 'pre-finish',
  name: 'Pre-Finish',
  dept: 'PRE-FIN',
  color: 'bg-lime-500',
  group: null,
  startingSerial: '25-0840'
}, {
  id: 'mech-trim',
  name: 'Mechanical Trim',
  dept: 'MECH-T',
  color: 'bg-yellow-600',
  group: 'mep-trim',
  startingSerial: '25-0956'
}, {
  id: 'elec-trim',
  name: 'Electrical Trim',
  dept: 'ELEC-T',
  color: 'bg-yellow-500',
  group: 'mep-trim',
  startingSerial: '25-0956'
}, {
  id: 'plumb-trim',
  name: 'Plumbing Trim',
  dept: 'PLMB-T',
  color: 'bg-yellow-400',
  group: 'mep-trim',
  startingSerial: '25-0956'
}, {
  id: 'final-finish',
  name: 'Final Finish',
  dept: 'FINAL',
  color: 'bg-orange-500',
  group: null,
  startingSerial: '25-0958'
}, {
  id: 'sign-off',
  name: 'Module Sign-Off',
  dept: 'SIGN-OFF',
  color: 'bg-rose-500',
  group: null,
  startingSerial: '25-0955'
}, {
  id: 'close-up',
  name: 'Close-Up',
  dept: 'CLOSE',
  color: 'bg-red-500',
  group: null,
  startingSerial: '25-0953'
}];

// Station groups for visual styling
const stationGroups = {
  'automation': {
    name: 'Automation',
    borderColor: 'border-autovol-teal',
    stations: ['auto-c', 'auto-f', 'auto-walls']
  },
  'mep-rough': {
    name: 'MEP Rough-In',
    borderColor: 'border-cyan-500',
    stations: ['mech-rough', 'elec-rough', 'plumb-rough']
  },
  'mep-trim': {
    name: 'MEP Trim',
    borderColor: 'border-yellow-500',
    stations: ['mech-trim', 'elec-trim', 'plumb-trim']
  }
};

// Station staggers (offset from Automation in build sequence)
// Higher number = station is working on modules further ahead in production
// Default values as of Dec 5, 2025
const stationStaggers = {
  'auto-c': 0,
  // Automation (Ceiling) - Base
  'auto-f': 0,
  // Automation (Floor) - Parallel with Ceiling
  'auto-walls': 0,
  // Automation (Walls) - Parallel with F/C
  'mezzanine': 1,
  // Mezzanine (FC Prep, Plumbing - Floors)
  'elec-ceiling': 4,
  // Electrical - Ceilings
  'wall-set': 5,
  // Wall Set
  'ceiling-set': 6,
  // Ceiling Set
  'soffits': 7,
  // Soffits
  'mech-rough': 8,
  // Mechanical Rough-In (MEP Rough-In group)
  'elec-rough': 8,
  // Electrical Rough-In (MEP Rough-In group)
  'plumb-rough': 8,
  // Plumbing Rough-In (MEP Rough-In group)
  'exteriors': 9,
  // Exteriors
  'drywall-bp': 10,
  // Drywall - BackPanel
  'drywall-ttp': 18,
  // Drywall - Tape/Texture/Paint
  'roofing': 15,
  // Roofing
  'pre-finish': 24,
  // Pre-Finish
  'mech-trim': 25,
  // Mechanical Trim (MEP Trim group)
  'elec-trim': 25,
  // Electrical Trim (MEP Trim group)
  'plumb-trim': 25,
  // Plumbing Trim (MEP Trim group)
  'final-finish': 27,
  // Final Finish
  'sign-off': 29,
  // Module Sign-Off
  'close-up': 36 // Close-Up
};

// Difficulty color mappings
const difficultyColors = {
  sidewall: 'bg-orange-100 text-orange-800',
  stair: 'bg-purple-100 text-purple-800',
  hr3Wall: 'bg-red-100 text-red-800',
  short: 'bg-yellow-100 text-yellow-800',
  doubleStudio: 'bg-indigo-100 text-indigo-800',
  sawbox: 'bg-pink-100 text-pink-800'
};
const difficultyLabels = {
  sidewall: 'Sidewall',
  stair: 'Stair',
  hr3Wall: '3HR-Wall',
  short: 'Short',
  doubleStudio: 'Dbl Studio',
  sawbox: 'Sawbox'
};

// Default Employee Roster (from Autovol_Roster_Current.xlsx)
const defaultEmployees = [];

// ===== PRODUCTION WEEK MANAGEMENT HOOK =====
const useProductionWeeks = () => {
  // Weeks are loaded from Supabase only - no localStorage
  const [weeks, setWeeks] = useState([]);
  const [weeksLoaded, setWeeksLoaded] = useState(false);
  const [weeksSupabaseAvailable, setWeeksSupabaseAvailable] = useState(false);
  const [staggerConfig, setStaggerConfig] = useState({
    ...stationStaggers
  });
  const [staggersLoaded, setStaggersLoaded] = useState(false);

  // Stagger change log - tracks all saved stagger configurations
  const [staggerChangeLog, setStaggerChangeLog] = useState([]);
  const [changeLogLoaded, setChangeLogLoaded] = useState(false);

  // Track if there are unsaved changes
  const [hasUnsavedStaggerChanges, setHasUnsavedStaggerChanges] = useState(false);
  const [pendingStaggerChanges, setPendingStaggerChanges] = useState({});

  // Load production weeks, staggers and change log from Supabase on mount
  useEffect(() => {
    const loadFromSupabase = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          // Load production weeks
          try {
            if (window.MODA_SUPABASE_DATA.productionWeeks) {
              const supabaseWeeks = await window.MODA_SUPABASE_DATA.productionWeeks.getAll();
              if (supabaseWeeks && supabaseWeeks.length > 0) {
                setWeeks(supabaseWeeks);
                setWeeksSupabaseAvailable(true);
                console.log('[App] Loaded', supabaseWeeks.length, 'production weeks from Supabase');
              } else {
                setWeeksSupabaseAvailable(true);
                console.log('[App] No production weeks in Supabase');
              }
            }
          } catch (err) {}
          setWeeksLoaded(true);

          // Load staggers
          try {
            const supabaseStaggers = await window.MODA_SUPABASE_DATA.stationStaggers.get();
            if (supabaseStaggers && Object.keys(supabaseStaggers).length > 0) {
              setStaggerConfig(supabaseStaggers);
            } else {
              setStaggerConfig({
                ...stationStaggers
              });
            }
          } catch (err) {
            setStaggerConfig({
              ...stationStaggers
            });
          }
          setStaggersLoaded(true);

          // Load change log
          try {
            const supabaseLog = await window.MODA_SUPABASE_DATA.staggerChangeLog.getAll();
            if (supabaseLog && supabaseLog.length > 0) {
              setStaggerChangeLog(supabaseLog);
              console.log('[App] Loaded', supabaseLog.length, 'stagger change log entries from Supabase');
            } else {
              setStaggerChangeLog([]);
            }
          } catch (err) {
            console.log('[App] Stagger change log table may not exist');
            setStaggerChangeLog([]);
          }
          setChangeLogLoaded(true);
        } else {
          // Fallback to defaults
          setWeeksLoaded(true);
          setStaggersLoaded(true);
          setChangeLogLoaded(true);
        }
      } catch (error) {
        console.error('[App] Error loading staggers:', error);
        setWeeksLoaded(true);
        setStaggersLoaded(true);
        setChangeLogLoaded(true);
      }
    };
    loadFromSupabase();
  }, []);

  // Weeks are saved to Supabase only - no localStorage backup needed

  // Save staggers to localStorage as backup
  useEffect(() => {
    if (staggersLoaded) {
      localStorage.setItem('autovol_station_staggers', JSON.stringify(staggerConfig));
    }
  }, [staggerConfig, staggersLoaded]);

  // Save change log to localStorage as backup
  useEffect(() => {
    if (changeLogLoaded) {
      localStorage.setItem('autovol_stagger_change_log', JSON.stringify(staggerChangeLog));
    }
  }, [staggerChangeLog, changeLogLoaded]);
  const addWeek = async weekData => {
    const newWeek = {
      ...weekData,
      id: `week-${Date.now()}`,
      createdAt: new Date().toISOString()
    };
    setWeeks(prev => [...prev, newWeek]);

    // Sync to Supabase
    if (weeksSupabaseAvailable && window.MODA_SUPABASE_DATA?.productionWeeks) {
      try {
        await window.MODA_SUPABASE_DATA.productionWeeks.create(newWeek);
        console.log('[ProductionWeeks] Created in Supabase:', newWeek.id);
      } catch (err) {
        console.error('[ProductionWeeks] Supabase create failed:', err.message);
      }
    }
    return newWeek;
  };
  const updateWeek = async (weekId, updates) => {
    setWeeks(prev => prev.map(w => w.id === weekId ? {
      ...w,
      ...updates
    } : w));

    // Sync to Supabase
    if (weeksSupabaseAvailable && window.MODA_SUPABASE_DATA?.productionWeeks) {
      try {
        await window.MODA_SUPABASE_DATA.productionWeeks.update(weekId, updates);
        console.log('[ProductionWeeks] Updated in Supabase:', weekId);
      } catch (err) {
        console.error('[ProductionWeeks] Supabase update failed:', err.message);
      }
    }
  };
  const deleteWeek = async weekId => {
    setWeeks(prev => prev.filter(w => w.id !== weekId));

    // Sync to Supabase
    if (weeksSupabaseAvailable && window.MODA_SUPABASE_DATA?.productionWeeks) {
      try {
        await window.MODA_SUPABASE_DATA.productionWeeks.delete(weekId);
        console.log('[ProductionWeeks] Deleted from Supabase:', weekId);
      } catch (err) {
        console.error('[ProductionWeeks] Supabase delete failed:', err.message);
      }
    }
  };

  // Update stagger value (marks as pending until saved)
  const updateStagger = (stationId, value) => {
    const newValue = parseInt(value) || 0;
    setPendingStaggerChanges(prev => ({
      ...prev,
      [stationId]: newValue
    }));
    setStaggerConfig(prev => ({
      ...prev,
      [stationId]: newValue
    }));
    setHasUnsavedStaggerChanges(true);
  };

  // Save stagger changes with description to change log
  const saveStaggerChanges = async (description, userName = 'Unknown') => {
    if (!hasUnsavedStaggerChanges) return;
    const logEntry = {
      id: `stagger-${Date.now()}`,
      timestamp: new Date().toISOString(),
      description: description || 'No description provided',
      changedBy: userName,
      changes: {
        ...pendingStaggerChanges
      },
      staggersSnapshot: {
        ...staggerConfig
      }
    };

    // Save to Supabase if available
    if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
      try {
        await window.MODA_SUPABASE_DATA.stationStaggers.save(staggerConfig);
        await window.MODA_SUPABASE_DATA.staggerChangeLog.add(logEntry);
        console.log('[App] Saved staggers to Supabase');
      } catch (err) {
        console.error('[App] Error saving staggers to Supabase:', err);
      }
    }
    setStaggerChangeLog(prev => [logEntry, ...prev]);
    setPendingStaggerChanges({});
    setHasUnsavedStaggerChanges(false);
    return logEntry;
  };

  // Revert to a previous stagger configuration
  const revertToStaggerConfig = logEntryId => {
    const entry = staggerChangeLog.find(e => e.id === logEntryId);
    const snapshot = entry?.staggersSnapshot || entry?.fullConfig;
    if (snapshot) {
      setStaggerConfig({
        ...snapshot
      });
      setPendingStaggerChanges({});
      setHasUnsavedStaggerChanges(false);
    }
  };

  // Reset to default staggers
  const resetToDefaultStaggers = () => {
    setStaggerConfig({
      ...stationStaggers
    });
    setPendingStaggerChanges({});
    setHasUnsavedStaggerChanges(true);
  };
  const validateWeek = (weekData, excludeId = null) => {
    const start = new Date(weekData.weekStart);
    const end = new Date(weekData.weekEnd);
    if (end <= start) return {
      valid: false,
      error: 'End date must be after start date'
    };
    const overlap = weeks.find(w => {
      if (w.id === excludeId) return false;
      const wStart = new Date(w.weekStart);
      const wEnd = new Date(w.weekEnd);
      return start <= wEnd && end >= wStart;
    });
    if (overlap) return {
      valid: false,
      error: 'Week overlaps with existing schedule'
    };
    return {
      valid: true
    };
  };
  const getCurrentWeek = () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return weeks.find(week => {
      const start = new Date(week.weekStart);
      const end = new Date(week.weekEnd);
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      return today >= start && today <= end;
    });
  };
  const getWeekForDate = date => {
    const targetDate = new Date(date);
    targetDate.setHours(0, 0, 0, 0);
    return weeks.find(week => {
      const start = new Date(week.weekStart);
      const end = new Date(week.weekEnd);
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);
      return targetDate >= start && targetDate <= end;
    });
  };
  return {
    weeks,
    staggerConfig,
    staggerChangeLog,
    hasUnsavedStaggerChanges,
    addWeek,
    updateWeek,
    deleteWeek,
    updateStagger,
    saveStaggerChanges,
    revertToStaggerConfig,
    resetToDefaultStaggers,
    validateWeek,
    getCurrentWeek,
    getWeekForDate
  };
};

// ===== STAGGER CONFIG TAB COMPONENT =====
function StaggerConfigTab({
  productionStages,
  stationGroups,
  staggerConfig,
  staggerChangeLog,
  hasUnsavedStaggerChanges,
  updateStagger,
  saveStaggerChanges,
  revertToStaggerConfig,
  resetToDefaultStaggers,
  currentUser,
  isAdmin
}) {
  // Only admins can edit staggers
  const [changeDescription, setChangeDescription] = useState('');
  const [showChangeLog, setShowChangeLog] = useState(false);
  const [confirmRevert, setConfirmRevert] = useState(null);
  const handleSaveChanges = () => {
    if (!changeDescription.trim()) {
      alert('Please enter a description for this change');
      return;
    }
    const userName = currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'Unknown';
    saveStaggerChanges(changeDescription.trim(), userName);
    setChangeDescription('');
  };
  const handleRevert = logEntryId => {
    revertToStaggerConfig(logEntryId);
    setConfirmRevert(null);
  };
  const formatDate = isoString => {
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-semibold text-autovol-navy"
  }, "Station Stagger Configuration"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, "Configure the offset between departments. A stagger of 5 means that station is working on modules 5 positions ahead of Automation."), !isAdmin && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-amber-600 mt-1"
  }, "\uD83D\uDD12 View only - Admin access required to modify staggers")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, isAdmin && /*#__PURE__*/React.createElement("button", {
    onClick: resetToDefaultStaggers,
    className: "px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600"
  }, "Reset to Default"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowChangeLog(!showChangeLog),
    className: `px-3 py-1.5 text-sm border rounded-lg flex items-center gap-1 ${showChangeLog ? 'bg-blue-50 border-blue-300 text-blue-700' : 'border-gray-300 hover:bg-gray-50 text-gray-600'}`
  }, "\uD83D\uDCCB Change Log (", staggerChangeLog.length, ")"))), hasUnsavedStaggerChanges && isAdmin && /*#__PURE__*/React.createElement("div", {
    className: "bg-amber-50 border border-amber-300 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-amber-800 font-medium mb-2"
  }, "\u26A0\uFE0F You have unsaved stagger changes"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: changeDescription,
    onChange: e => setChangeDescription(e.target.value),
    placeholder: "Describe why you're making this change...",
    className: "flex-1 px-3 py-2 border border-amber-300 rounded-lg text-sm"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveChanges,
    disabled: !changeDescription.trim(),
    className: "px-4 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Save Changes"))), showChangeLog && /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 border rounded-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 border-b bg-gray-100 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-700"
  }, "Stagger Change History"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowChangeLog(false),
    className: "text-gray-400 hover:text-gray-600"
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "max-h-64 overflow-y-auto"
  }, staggerChangeLog.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-4 text-center text-gray-500 text-sm"
  }, "No changes recorded yet.") : /*#__PURE__*/React.createElement("div", {
    className: "divide-y"
  }, staggerChangeLog.map((entry, idx) => /*#__PURE__*/React.createElement("div", {
    key: entry.id,
    className: "p-3 hover:bg-white"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-sm"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-gray-800"
  }, entry.description), idx === 0 && /*#__PURE__*/React.createElement("span", {
    className: "px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded"
  }, "Current")), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mt-0.5"
  }, formatDate(entry.timestamp), " \u2022 by ", entry.changedBy), Object.keys(entry.changes || {}).length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-1 text-xs text-gray-600"
  }, "Changed: ", Object.entries(entry.changes).map(([station, value]) => /*#__PURE__*/React.createElement("span", {
    key: station,
    className: "inline-block bg-gray-200 px-1.5 py-0.5 rounded mr-1 mb-1"
  }, station, ": ", value)))), idx !== 0 && isAdmin && (confirmRevert === entry.id ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleRevert(entry.id),
    className: "px-2 py-1 bg-blue-600 text-white text-xs rounded"
  }, "Confirm"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setConfirmRevert(null),
    className: "px-2 py-1 bg-gray-300 text-gray-700 text-xs rounded"
  }, "Cancel")) : /*#__PURE__*/React.createElement("button", {
    onClick: () => setConfirmRevert(entry.id),
    className: "px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-100"
  }, "Revert")))))))), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "border-b"
  }, /*#__PURE__*/React.createElement("th", {
    className: "text-left py-2 px-3 font-semibold text-gray-700"
  }, "Station"), /*#__PURE__*/React.createElement("th", {
    className: "text-left py-2 px-3 font-semibold text-gray-700"
  }, "Dept Code"), /*#__PURE__*/React.createElement("th", {
    className: "text-left py-2 px-3 font-semibold text-gray-700"
  }, "Stagger Offset"), /*#__PURE__*/React.createElement("th", {
    className: "text-left py-2 px-3 font-semibold text-gray-700"
  }, "Group"))), /*#__PURE__*/React.createElement("tbody", null, productionStages.map((station, idx) => /*#__PURE__*/React.createElement("tr", {
    key: station.id,
    className: idx % 2 === 0 ? 'bg-gray-50' : ''
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, station.name), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3 font-mono"
  }, station.dept), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "0",
    max: "50",
    value: staggerConfig[station.id] || 0,
    onChange: e => isAdmin && updateStagger(station.id, e.target.value),
    disabled: !isAdmin,
    className: `w-20 px-2 py-1 border rounded text-center font-mono ${!isAdmin ? 'bg-gray-100 cursor-not-allowed' : ''}`
  })), /*#__PURE__*/React.createElement("td", {
    className: "py-2 px-3"
  }, station.group && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-gray-200 px-2 py-0.5 rounded"
  }, stationGroups[station.group]?.name || station.group))))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700"
  }, /*#__PURE__*/React.createElement("strong", null, "Tip:"), " Stagger values determine which module appears at each station on the Weekly Board. ", /*#__PURE__*/React.createElement("strong", null, "Remember to save your changes with a description!")));
}

// ============================================================================
// DASHBOARD ROLE MANAGER - EXTRACTED TO auth/RoleManager.jsx
// ============================================================================

// Main Dashboard Component (requires authentication)
function Dashboard({
  auth
}) {
  // Use URL-based navigation if feature flag is enabled, otherwise use local state
  const useUrlNav = isFeatureEnabled('enableUrlNavigation', auth.currentUser?.email) && window.useUrlNavigation;
  const [urlActiveTab, urlSetActiveTab] = useUrlNav ? window.useUrlNavigation('home') : [null, null];
  const [localActiveTab, setLocalActiveTab] = useState('home');

  // Use URL navigation if available, otherwise fall back to local state
  const activeTab = useUrlNav ? urlActiveTab : localActiveTab;
  const setActiveTab = useUrlNav ? urlSetActiveTab : setLocalActiveTab;

  // Projects state - loaded from Supabase with localStorage fallback
  const [projects, setProjectsState] = useState([]);
  const [projectsLoading, setProjectsLoading] = useState(true);
  const [projectsSynced, setProjectsSynced] = useState(false);

  // Ref to track last synced projects (prevents unnecessary sync on first load)
  const lastSyncedProjects = useRef(null);

  // Wrapper to save projects to both state and localStorage
  const setProjects = useCallback(newProjects => {
    setProjectsState(prevProjects => {
      const projectsArray = typeof newProjects === 'function' ? newProjects(prevProjects) : newProjects;
      // Save to localStorage as backup (only if valid array)
      if (Array.isArray(projectsArray)) {
        localStorage.setItem('autovol_projects', JSON.stringify(projectsArray));
      }
      return projectsArray || [];
    });
  }, []);

  // Load projects from Supabase on mount
  useEffect(() => {
    const loadProjects = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[App] Loading projects from Supabase...');
          try {
            const supabaseProjects = await window.MODA_SUPABASE_DATA.projects.getAll();
            // Map Supabase field names to UI field names
            const mappedProjects = (supabaseProjects || []).map(p => ({
              ...p,
              customer: p.client || p.customer || '',
              // Supabase uses 'client', UI uses 'customer'
              startDate: p.start_date || p.startDate,
              endDate: p.end_date || p.endDate
            }));
            setProjectsState(mappedProjects);
            // Initialize lastSyncedProjects to prevent unnecessary sync on first load
            if (lastSyncedProjects.current === null) {
              lastSyncedProjects.current = JSON.parse(JSON.stringify(mappedProjects));
            }
            setProjectsSynced(true);
            console.log('[App] Loaded', mappedProjects.length, 'projects from Supabase');
          } catch (supabaseError) {
            // Log detailed error info for debugging
            const errorDetails = {
              message: supabaseError.message,
              code: supabaseError.code,
              hint: supabaseError.hint,
              details: supabaseError.details
            };
            console.error('[App] Supabase projects error:', JSON.stringify(errorDetails));
            if (window.debugError) {
              window.debugError(`Supabase projects failed: ${supabaseError.message || 'Unknown error'}`);
              if (supabaseError.code) window.debugError(`Error code: ${supabaseError.code}`);
            }
            console.log('[App] Falling back to localStorage for projects');
            // Fallback to localStorage
            const saved = localStorage.getItem('autovol_projects');
            if (saved && saved !== 'undefined' && saved !== 'null') {
              setProjectsState(JSON.parse(saved));
              if (window.debugInfo) window.debugInfo(`Loaded ${JSON.parse(saved).length} projects from localStorage`);
            }
          }
        } else {
          // Fallback to localStorage
          console.log('[App] Supabase not available, using localStorage for projects');
          try {
            const saved = localStorage.getItem('autovol_projects');
            if (saved && saved !== 'undefined' && saved !== 'null') {
              setProjectsState(JSON.parse(saved));
            }
          } catch (e) {
            console.error('[App] Error parsing projects from localStorage:', e);
          }
        }
      } catch (error) {
        console.error('[App] Error loading projects:', error);
        // Fallback to localStorage on error
        try {
          const saved = localStorage.getItem('autovol_projects');
          if (saved && saved !== 'undefined' && saved !== 'null') {
            setProjectsState(JSON.parse(saved));
          }
        } catch (e) {
          console.error('[App] Error parsing projects fallback:', e);
        }
      } finally {
        setProjectsLoading(false);
      }
    };
    loadProjects();
  }, []);
  const [trashedProjects, setTrashedProjects] = useState(() => {
    const saved = localStorage.getItem('autovol_trash_projects');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      try {
        const parsed = JSON.parse(saved);
        // Auto-purge items older than 90 days
        const ninetyDaysAgo = Date.now() - 90 * 24 * 60 * 60 * 1000;
        return parsed.filter(p => p.deletedAt > ninetyDaysAgo);
      } catch (e) {
        return [];
      }
    }
    return [];
  });
  const [trashedEmployees, setTrashedEmployees] = useState(() => {
    const saved = localStorage.getItem('autovol_trash_employees');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      try {
        const parsed = JSON.parse(saved);
        // Auto-purge items older than 90 days
        const ninetyDaysAgo = Date.now() - 90 * 24 * 60 * 60 * 1000;
        return parsed.filter(e => e.deletedAt > ninetyDaysAgo);
      } catch (e) {
        return [];
      }
    }
    return [];
  });
  const [showDataManagement, setShowDataManagement] = useState(false);
  const [selectedProject, setSelectedProject] = useState(null);
  const [showProjectModal, setShowProjectModal] = useState(false);
  const [showImportModal, setShowImportModal] = useState(false);
  const [viewMode, setViewMode] = useState('grid'); // grid, list
  const [searchTerm, setSearchTerm] = useState('');
  const [stageFilter, setStageFilter] = useState('all');

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = e => {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }
      const key = e.key.toLowerCase();
      const ctrl = e.ctrlKey || e.metaKey;

      // Escape: Close modals
      if (key === 'escape') {
        setShowProjectModal(false);
        setShowImportModal(false);
        setShowDataManagement(false);
        return;
      }

      // Ctrl+E: Export data (admin only)
      if (ctrl && key === 'e' && auth.isAdmin) {
        e.preventDefault();
        exportData();
        return;
      }

      // Ctrl+F: Focus search (if on projects tab)
      if (ctrl && key === 'f' && activeTab === 'projects') {
        e.preventDefault();
        const searchInput = document.querySelector('input[placeholder*="Search"]');
        if (searchInput) searchInput.focus();
        return;
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [activeTab, auth.visibleTabs, auth.isAdmin]);

  // People Module State
  const [employees, setEmployees] = useState([]);
  const [employeesSynced, setEmployeesSynced] = useState(false);
  const [departments, setDepartments] = useState([]);
  const [departmentsLoaded, setDepartmentsLoaded] = useState(false);

  // Default departments based on production stages
  const getDefaultDepartments = () => productionStages.map(s => ({
    id: s.id,
    name: s.name,
    supervisor: null,
    employeeCount: 0
  }));

  // Load employees and departments from Supabase (or localStorage fallback)
  useEffect(() => {
    const loadPeopleData = async () => {
      try {
        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
          console.log('[App] Loading people data from Supabase...');

          // Load employees
          const supabaseEmployees = await window.MODA_SUPABASE_DATA.employees.getAll();
          setEmployees(supabaseEmployees);
          setEmployeesSynced(true);
          console.log('[App] Loaded', supabaseEmployees.length, 'employees from Supabase');

          // Load departments
          try {
            const supabaseDepts = await window.MODA_SUPABASE_DATA.departments.getAll();
            if (supabaseDepts && supabaseDepts.length > 0) {
              setDepartments(supabaseDepts);
              console.log('[App] Loaded', supabaseDepts.length, 'departments from Supabase');
            } else {
              // Fallback to localStorage or defaults
              const saved = localStorage.getItem('autovol_departments');
              if (saved && saved !== 'undefined' && saved !== 'null') {
                try {
                  setDepartments(JSON.parse(saved));
                } catch (e) {
                  setDepartments(getDefaultDepartments());
                }
              } else {
                setDepartments(getDefaultDepartments());
              }
            }
          } catch (deptErr) {
            console.log('[App] Departments table may not exist yet, using localStorage');
            const saved = localStorage.getItem('autovol_departments');
            if (saved && saved !== 'undefined' && saved !== 'null') {
              try {
                setDepartments(JSON.parse(saved));
              } catch (e) {
                setDepartments(getDefaultDepartments());
              }
            } else {
              setDepartments(getDefaultDepartments());
            }
          }
          setDepartmentsLoaded(true);
        } else {
          // Fallback to localStorage
          console.log('[App] Supabase not available, using localStorage');
          const saved = localStorage.getItem('autovol_employees');
          if (saved && saved !== 'undefined' && saved !== 'null') {
            try {
              const parsed = JSON.parse(saved);
              setEmployees(parsed.length > 0 ? parsed : []);
            } catch (e) {
              console.error('[App] Error parsing employees from localStorage:', e);
            }
          }
          // Load departments from localStorage
          const savedDepts = localStorage.getItem('autovol_departments');
          if (savedDepts && savedDepts !== 'undefined' && savedDepts !== 'null') {
            try {
              setDepartments(JSON.parse(savedDepts));
            } catch (e) {
              setDepartments(getDefaultDepartments());
            }
          } else {
            setDepartments(getDefaultDepartments());
          }
          setDepartmentsLoaded(true);
        }
      } catch (error) {
        console.error('[App] Error loading people data:', error);
        // Fallback to localStorage on error
        const saved = localStorage.getItem('autovol_employees');
        if (saved && saved !== 'undefined' && saved !== 'null') {
          try {
            setEmployees(JSON.parse(saved));
          } catch (e) {
            console.error('[App] Error parsing employees fallback:', e);
          }
        }
        const savedDepts = localStorage.getItem('autovol_departments');
        if (savedDepts && savedDepts !== 'undefined' && savedDepts !== 'null') {
          try {
            setDepartments(JSON.parse(savedDepts));
          } catch (e) {
            setDepartments(getDefaultDepartments());
          }
        } else {
          setDepartments(getDefaultDepartments());
        }
        setDepartmentsLoaded(true);
      }
    };
    loadPeopleData();
  }, []);

  // Save to localStorage and sync to Supabase when projects change
  useEffect(() => {
    // Only save to localStorage if not using Firestore (Firestore handles its own persistence)
    if (!projectsSynced && Array.isArray(projects) && projects.length > 0) {
      localStorage.setItem('autovol_projects', JSON.stringify(projects));
    }
    // Sync to unified layer for any modules with close-up at 100%
    MODA_UNIFIED.migrateFromProjects();

    // Sync changed projects to Supabase (debounced)
    if (projectsSynced && window.MODA_SUPABASE_DATA?.isAvailable?.() && Array.isArray(projects)) {
      // Helper to check if ID is a valid UUID (not a timestamp)
      const isValidUUID = id => {
        if (!id) return false;
        // UUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        return uuidRegex.test(String(id));
      };

      // Find projects that changed
      const syncToSupabase = async () => {
        const lastProjects = lastSyncedProjects.current || [];
        for (const project of projects) {
          // Only sync projects with valid Supabase UUIDs (skip timestamp IDs)
          if (!isValidUUID(project.id)) {
            console.log('[App] Skipping sync for non-UUID project:', project.name, project.id);
            continue;
          }
          const lastVersion = lastProjects.find(p => p.id === project.id);
          // Check if project changed (compare modules array length or stringify)
          if (!lastVersion || JSON.stringify(lastVersion) !== JSON.stringify(project)) {
            try {
              await window.MODA_SUPABASE_DATA.projects.update(project.id, project);
              console.log('[App] Synced project to Supabase:', project.name, 'modules:', project.modules?.length || 0);
            } catch (err) {
              console.error('[App] Error syncing project to Supabase:', err);
            }
          }
        }
        lastSyncedProjects.current = JSON.parse(JSON.stringify(projects));
      };

      // Debounce the sync
      const syncTimeout = setTimeout(syncToSupabase, 1000);
      return () => clearTimeout(syncTimeout);
    }
  }, [projects, projectsSynced]);
  useEffect(() => {
    localStorage.setItem('autovol_trash_projects', JSON.stringify(trashedProjects));
  }, [trashedProjects]);
  useEffect(() => {
    localStorage.setItem('autovol_trash_employees', JSON.stringify(trashedEmployees));
  }, [trashedEmployees]);

  // Save employees to localStorage as backup (even when using Supabase)
  useEffect(() => {
    if (employees.length > 0) {
      localStorage.setItem('autovol_employees', JSON.stringify(employees));
    }
  }, [employees]);
  useEffect(() => {
    localStorage.setItem('autovol_departments', JSON.stringify(departments));
  }, [departments]);

  // Export all data as JSON
  const exportData = () => {
    const data = {
      exportDate: new Date().toISOString(),
      version: '1.0',
      projects,
      trashedProjects,
      employees,
      trashedEmployees,
      departments
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `MODA_Backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Import data from JSON file
  const importData = file => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (data.projects) setProjects(data.projects);
        if (data.trashedProjects) setTrashedProjects(data.trashedProjects);
        if (data.employees) setEmployees(data.employees);
        if (data.trashedEmployees) setTrashedEmployees(data.trashedEmployees);
        if (data.departments) setDepartments(data.departments);
        alert('Data restored successfully!');
      } catch (err) {
        alert('Error reading backup file: ' + err.message);
      }
    };
    reader.readAsText(file);
  };

  // Calculate department status from ALL active projects
  const departmentStatus = useMemo(() => {
    const status = {};
    productionStages.forEach(stage => {
      status[stage.id] = {
        inProgress: 0,
        completed: 0
      };
    });
    projects.filter(p => p.status === 'Active').forEach(project => {
      (project.modules || []).forEach(module => {
        productionStages.forEach(stage => {
          const progress = module.stageProgress?.[stage.id] || 0;
          if (progress > 0 && progress < 100) {
            status[stage.id].inProgress++;
          } else if (progress === 100) {
            status[stage.id].completed++;
          }
        });
      });
    });
    return status;
  }, [projects]);

  // Active projects count
  const activeProjects = projects.filter(p => p.status === 'Active');
  const totalActiveModules = activeProjects.reduce((sum, p) => sum + (p.modules?.length || 0), 0);

  // Weekly schedule integration for Executive Dashboard
  const weeklySchedule = window.WeeklyBoardComponents?.useWeeklySchedule?.() || {
    scheduleSetup: {
      shift1: {
        monday: 5,
        tuesday: 5,
        wednesday: 5,
        thursday: 5
      },
      shift2: {
        friday: 0,
        saturday: 0,
        sunday: 0
      }
    },
    completedWeeks: [],
    updateShiftSchedule: () => {},
    getShiftTotal: () => 0,
    getLineBalance: () => 21,
    completeWeek: () => {}
  };

  // Get current week for Executive Dashboard
  const getCurrentWeek = () => {
    const now = new Date();
    const startOfYear = new Date(now.getFullYear(), 0, 1);
    const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
    return Math.ceil((days + startOfYear.getDay() + 1) / 7);
  };
  const currentWeek = getCurrentWeek();
  return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen",
    style: {
      backgroundColor: 'var(--autovol-gray-bg)'
    }
  }, /*#__PURE__*/React.createElement("header", {
    className: "bg-white shadow-sm border-b mobile-header"
  }, /*#__PURE__*/React.createElement("div", {
    className: "max-w-7xl mx-auto px-4 py-3 flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, window.MobileNavigation && /*#__PURE__*/React.createElement(window.MobileNavigation, {
    tabs: [{
      id: 'executive',
      label: 'Executive',
      icon: 'icon-executive'
    }, {
      id: 'production',
      label: 'Production',
      icon: 'icon-production'
    }, {
      id: 'projects',
      label: 'Projects',
      icon: 'icon-projects'
    }, {
      id: 'people',
      label: 'People',
      icon: 'icon-people'
    }, {
      id: 'qa',
      label: 'QA',
      icon: 'icon-qa'
    }, {
      id: 'transport',
      label: 'Transport',
      icon: 'icon-transport'
    }, {
      id: 'equipment',
      label: 'Tools & Equipment',
      icon: 'icon-equipment'
    }, {
      id: 'precon',
      label: 'Precon',
      icon: 'icon-precon'
    }, {
      id: 'tracker',
      label: 'Tracker',
      icon: 'icon-tracker'
    }, {
      id: 'drawings',
      label: 'Drawings',
      icon: 'icon-drawings'
    }, {
      id: 'engineering',
      label: 'Engineering',
      icon: 'icon-engineering'
    }, {
      id: 'onsite',
      label: 'On-Site',
      icon: 'icon-building'
    }, {
      id: 'reports',
      label: 'Reports',
      icon: 'icon-reports'
    }, {
      id: 'automation',
      label: 'Automation',
      icon: 'icon-automation'
    }].filter(tab => auth.visibleTabs.includes(tab.id)),
    activeTab: activeTab,
    onTabChange: tabId => {
      setActiveTab(tabId);
      setSelectedProject(null);
    },
    currentUser: auth.currentUser,
    onLogout: auth.logout
  }), /*#__PURE__*/React.createElement("img", {
    src: AUTOVOL_LOGO,
    alt: "Autovol Volumetric Modular",
    className: "mobile-logo",
    style: {
      height: '45px',
      width: 'auto'
    }
  }), /*#__PURE__*/React.createElement("div", {
    className: "border-l pl-4 hide-mobile",
    style: {
      borderColor: 'var(--autovol-teal)'
    }
  }, /*#__PURE__*/React.createElement("h1", {
    className: "text-lg font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Modular Operations Dashboard"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs",
    style: {
      color: 'var(--autovol-teal)'
    }
  }, "MODA"))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-right cursor-pointer hover:opacity-80 transition mobile-user-profile",
    onClick: () => setShowUserProfile(true),
    title: "View your profile"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm font-medium hide-mobile",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, auth.currentUser?.name || 'User'), /*#__PURE__*/React.createElement("span", {
    className: `text-xs px-2 py-0.5 rounded-full ${auth.isAdmin ? 'role-badge-admin' : 'role-badge-user'}`
  }, String(auth.userRole?.name || auth.currentUser?.dashboardRole || 'User'))), /*#__PURE__*/React.createElement("button", {
    onClick: () => auth.logout(),
    className: "px-3 py-1.5 text-sm rounded-lg border border-gray-300 hover:bg-gray-100 transition hide-mobile-tablet"
  }, "Sign Out")))), isFeatureEnabled('enableNavGroups', auth.currentUser?.email) && window.NavigationGroups ? /*#__PURE__*/React.createElement(window.NavigationGroups, {
    activeTab: activeTab,
    setActiveTab: setActiveTab,
    visibleTabs: auth.visibleTabs,
    canAccessAdmin: auth.canAccessAdmin,
    setSelectedProject: setSelectedProject
  }) :
  /*#__PURE__*/
  /* Original flat navigation - hidden on mobile/tablet */
  React.createElement("nav", {
    className: "bg-white border-b hide-mobile-tablet"
  }, /*#__PURE__*/React.createElement("div", {
    className: "max-w-7xl mx-auto px-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, isFeatureEnabled('enableDashboardHome', auth.currentUser?.email) && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setActiveTab('home');
      setSelectedProject(null);
    },
    className: `tab-button px-4 py-3 text-sm font-medium transition rounded-t-lg ${activeTab === 'home' ? 'active' : ''}`,
    style: activeTab === 'home' ? {
      backgroundColor: 'var(--autovol-teal)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tab-icon icon-home"
  }), "Home"), [{
    id: 'executive',
    label: 'Executive',
    icon: 'icon-executive'
  }, {
    id: 'production',
    label: 'Production',
    icon: 'icon-production'
  }, {
    id: 'projects',
    label: 'Projects',
    icon: 'icon-projects'
  }, {
    id: 'people',
    label: 'People',
    icon: 'icon-people'
  }, {
    id: 'qa',
    label: 'QA',
    icon: 'icon-qa'
  }, {
    id: 'transport',
    label: 'Transport',
    icon: 'icon-transport'
  }, {
    id: 'equipment',
    label: 'Tools & Equipment',
    icon: 'icon-equipment'
  }, {
    id: 'precon',
    label: 'Precon',
    icon: 'icon-precon'
  }, {
    id: 'onsite',
    label: 'On-Site',
    icon: 'icon-onsite'
  }, {
    id: 'engineering',
    label: 'Engineering',
    icon: 'icon-engineering'
  }, {
    id: 'automation',
    label: 'Automation',
    icon: 'icon-automation'
  }, {
    id: 'tracker',
    label: 'Tracker',
    icon: 'icon-tracker'
  }].filter(tab => auth.visibleTabs.includes(tab.id)) // FILTER BASED ON ROLE
  .map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => {
      setActiveTab(tab.id);
      setSelectedProject(null);
    },
    className: `tab-button px-4 py-3 text-sm font-medium transition rounded-t-lg ${activeTab === tab.id ? 'active' : ''}`,
    style: activeTab === tab.id ? {
      backgroundColor: 'var(--autovol-red)',
      color: 'white'
    } : {
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tab-icon ${tab.icon}`
  }), tab.label)), auth.canAccessAdmin && /*#__PURE__*/React.createElement("button", {
    key: "admin",
    onClick: () => {
      setActiveTab('admin');
      setSelectedProject(null);
    },
    className: `tab-button px-4 py-3 text-sm font-medium transition rounded-t-lg ml-auto ${activeTab === 'admin' ? 'active' : ''}`,
    style: activeTab === 'admin' ? {
      backgroundColor: 'var(--autovol-navy)',
      color: 'white'
    } : {
      backgroundColor: 'var(--autovol-gray-bg)',
      color: 'var(--autovol-navy)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tab-icon icon-admin"
  }), "Admin")))), /*#__PURE__*/React.createElement("main", {
    className: "max-w-7xl mx-auto px-4 py-6"
  }, activeTab === 'home' && isFeatureEnabled('enableDashboardHome', auth.currentUser?.email) && (window.DashboardHome ? /*#__PURE__*/React.createElement(window.DashboardHome, {
    projects: projects,
    employees: employees,
    auth: auth,
    onNavigate: tab => {
      setActiveTab(tab);
      setSelectedProject(null);
    }
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83C\uDFE0"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Dashboard Home"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading..."))), activeTab === 'production' && !selectedProject && /*#__PURE__*/React.createElement(ProductionDashboard, {
    projects: projects,
    setProjects: setProjects,
    departmentStatus: departmentStatus,
    onSelectProject: setSelectedProject,
    auth: auth
  }), activeTab === 'projects' && !selectedProject && (window.ProjectsDirectory ? /*#__PURE__*/React.createElement(window.ProjectsDirectory, {
    projects: projects,
    setProjects: setProjects,
    trashedProjects: trashedProjects,
    setTrashedProjects: setTrashedProjects,
    onSelectProject: setSelectedProject,
    showNewProjectModal: () => setShowProjectModal(true),
    auth: auth,
    exportData: exportData,
    importData: importData
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Projects Module...")), activeTab === 'people' && (window.PeopleModule ? /*#__PURE__*/React.createElement(window.PeopleModule, {
    employees: employees,
    setEmployees: setEmployees,
    departments: departments,
    setDepartments: setDepartments,
    productionStages: productionStages,
    isAdmin: auth.isAdmin
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading People Module...")), activeTab === 'executive' && (window.ExecutiveDashboard ? /*#__PURE__*/React.createElement(window.ExecutiveDashboard, {
    projects: projects,
    completedWeeks: weeklySchedule.completedWeeks,
    scheduleSetup: weeklySchedule.scheduleSetup,
    currentWeek: currentWeek
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDCCA"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Executive Dashboard"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading executive view..."))), activeTab === 'qa' && (window.QAModule ? /*#__PURE__*/React.createElement(window.QAModule, {
    projects: projects,
    employees: employees,
    currentUser: {
      name: auth.currentUser?.name,
      role: auth.userRole?.name
    },
    canEdit: auth.canEditTab('qa')
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-qa",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block'
    }
  })), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "QA Module"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading QA Module..."))), activeTab === 'transport' && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm"
  }, window.TransportApp ? /*#__PURE__*/React.createElement(window.TransportApp, {
    canEdit: auth.canEditTab('transport')
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Transport Module...")), activeTab === 'equipment' && /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-sm"
  }, window.EquipmentApp ? /*#__PURE__*/React.createElement(window.EquipmentApp, null) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Equipment Module...")), activeTab === 'precon' && /*#__PURE__*/React.createElement(PreconModule, {
    projects: projects,
    employees: employees
  }), activeTab === 'onsite' && (window.OnSiteTab ? /*#__PURE__*/React.createElement(window.OnSiteTab, {
    projects: projects,
    employees: employees,
    currentUser: auth.user
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-building",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block'
    }
  })), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "On-Site Services Module"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading..."))), activeTab === 'engineering' && (window.EngineeringModule ? /*#__PURE__*/React.createElement(window.EngineeringModule, {
    projects: projects,
    employees: employees,
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-engineering",
    style: {
      width: '64px',
      height: '64px',
      display: 'inline-block'
    }
  })), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Engineering Module"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading Engineering Issue Tracker..."))), activeTab === 'drawings' && (window.DrawingsModule ? /*#__PURE__*/React.createElement(window.DrawingsModule, {
    projects: projects,
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDCD0"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Drawings Module"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "Loading Drawings Module..."))), activeTab === 'automation' && (window.AutomationModule ? /*#__PURE__*/React.createElement(window.AutomationModule, {
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Automation Module...")), activeTab === 'tracker' && (window.ModuleTrackerPanel ? /*#__PURE__*/React.createElement(window.ModuleTrackerPanel, {
    projects: projects
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Tracker Module...")), activeTab === 'supplychain' && (window.ProcurementBoard ? /*#__PURE__*/React.createElement(window.ProcurementBoard, {
    projects: projects,
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Supply Chain Module...")), activeTab === 'admin' && auth.canAccessAdmin && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Data Management"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 text-sm mt-1"
  }, "Manage trash, backup and restore data")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowDataManagement(true),
    className: "px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-settings",
    style: {
      width: '16px',
      height: '16px',
      display: 'inline-block'
    }
  }), "Open Data Management")))), /*#__PURE__*/React.createElement("div", {
    className: "mb-6"
  }, window.UserPermissionsManager ? /*#__PURE__*/React.createElement(window.UserPermissionsManager, {
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold mb-4",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "User Management"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-4"
  }, "Manage users through Supabase Dashboard or the People module."), /*#__PURE__*/React.createElement("a", {
    href: "https://supabase.com/dashboard/project/syreuphexagezawjyjgt/auth/users",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
  }, "Open Supabase Auth Dashboard"))), /*#__PURE__*/React.createElement("div", {
    className: "mt-6"
  }, window.DashboardRoleManager ? /*#__PURE__*/React.createElement(window.DashboardRoleManager, {
    auth: auth
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-4 text-gray-500"
  }, "Loading Role Manager...")), /*#__PURE__*/React.createElement("div", {
    className: "mt-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, window.ActivityLogViewer ? /*#__PURE__*/React.createElement(window.ActivityLogViewer, {
    showFilters: true,
    showExport: true,
    maxHeight: "500px"
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Activity Log"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "Activity logging module not loaded."))))), activeTab === 'admin' && !auth.canAccessAdmin && /*#__PURE__*/React.createElement("div", {
    className: "text-center py-20"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-6xl mb-4"
  }, "\uD83D\uDD12"), /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold mb-2",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "Access Denied"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600"
  }, "You don't have permission to access this area")), selectedProject && /*#__PURE__*/React.createElement(ProjectDetail, {
    project: projects.find(p => p.id === selectedProject.id) || selectedProject,
    projects: projects,
    setProjects: setProjects,
    onBack: () => setSelectedProject(null),
    viewMode: viewMode,
    setViewMode: setViewMode,
    searchTerm: searchTerm,
    setSearchTerm: setSearchTerm,
    stageFilter: stageFilter,
    setStageFilter: setStageFilter,
    auth: auth
  })), showProjectModal && /*#__PURE__*/React.createElement(NewProjectModal, {
    onClose: () => setShowProjectModal(false),
    onSave: async project => {
      const newProject = {
        ...project,
        id: Date.now(),
        modules: [],
        createdAt: new Date().toISOString()
      };

      // Save to Supabase if available
      if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
        try {
          const savedProject = await window.MODA_SUPABASE_DATA.projects.create(newProject);
          console.log('[App] Project saved to Supabase:', savedProject.id);
          // Use the Supabase-generated ID
          setProjects([...projects, {
            ...newProject,
            id: savedProject.id
          }]);
        } catch (err) {
          console.error('[App] Error saving project to Supabase:', err);
          // Fallback to local state
          setProjects([...projects, newProject]);
        }
      } else {
        setProjects([...projects, newProject]);
      }
      setShowProjectModal(false);
    }
  }), showDataManagement && auth.isAdmin && /*#__PURE__*/React.createElement(DataManagementPanel, {
    onClose: () => setShowDataManagement(false),
    projects: projects,
    setProjects: setProjects,
    trashedProjects: trashedProjects,
    setTrashedProjects: setTrashedProjects,
    employees: employees,
    setEmployees: setEmployees,
    trashedEmployees: trashedEmployees,
    setTrashedEmployees: setTrashedEmployees,
    exportData: exportData,
    importData: importData
  }), window.OCRProgressIndicator && /*#__PURE__*/React.createElement(window.OCRProgressIndicator, null), /*#__PURE__*/React.createElement("footer", {
    className: "text-center py-3 text-xs text-gray-400 border-t bg-white",
    style: {
      marginTop: 'auto'
    }
  }, "MODA v", window.MODA_VERSION || '1.0.0'));
}

// ============================================================================
// MODULE TRACKER PANEL - EXTRACTED TO TrackerModule.jsx
// ============================================================================
const ENGINEERING_DEPARTMENTS = ['Automation', 'Auto Floor/Ceiling', 'Auto Walls', 'Mezzanine', 'Electrical', 'Wall Set', 'Ceiling Set', 'Soffits', 'Mechanical', 'Plumbing', 'Exteriors', 'Drywall', 'Roofing', 'Pre-Finish', 'Final Finish', 'Sign-Off', 'Close-Up', 'QA', 'Transport', 'On-Site', 'General'];

// Production Dashboard Component - Vertical Department Workflow
function ProductionDashboard({
  projects,
  setProjects,
  departmentStatus,
  onSelectProject,
  auth
}) {
  const activeProjects = projects.filter(p => p.status === 'Active');
  const [selectedProjectId, setSelectedProjectId] = useState(activeProjects[0]?.id || null);
  const [productionTab, setProductionTab] = useState('weekly-board');
  const [selectedWeekId, setSelectedWeekId] = useState(null); // For viewing specific weeks from Schedule Setup
  const [editWeekId, setEditWeekId] = useState(null); // For editing specific weeks from WeeklyBoard

  // Module Detail State (for Station Board "View Details" button)
  const [selectedModuleDetail, setSelectedModuleDetail] = useState(null);
  const [editMode, setEditMode] = useState(false);

  // Report Issue State
  const [showReportIssueModal, setShowReportIssueModal] = useState(false);
  const [reportIssueContext, setReportIssueContext] = useState(null);
  const [engineeringIssues, setEngineeringIssues] = useState(() => {
    const saved = localStorage.getItem('moda_engineering_issues');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      try {
        return JSON.parse(saved);
      } catch (e) {
        return [];
      }
    }
    return [];
  });

  // Production weeks integration
  const {
    weeks,
    staggerConfig,
    staggerChangeLog,
    hasUnsavedStaggerChanges,
    addWeek,
    updateWeek,
    deleteWeek,
    updateStagger,
    saveStaggerChanges,
    revertToStaggerConfig,
    resetToDefaultStaggers,
    validateWeek,
    getCurrentWeek
  } = useProductionWeeks();
  const currentWeek = getCurrentWeek();

  // Weekly schedule integration (from WeeklyBoard.jsx)
  // canEdit is controlled by useWeeklySchedule - only trevor@autovol.com and stephanie@autovol.com can edit
  const weeklySchedule = window.WeeklyBoardComponents?.useWeeklySchedule?.() || {
    scheduleSetup: {
      shift1: {
        monday: 5,
        tuesday: 5,
        wednesday: 5,
        thursday: 5
      },
      shift2: {
        friday: 0,
        saturday: 0,
        sunday: 0
      }
    },
    completedWeeks: [],
    updateShiftSchedule: () => {},
    getShiftTotal: () => 0,
    getLineBalance: () => 20,
    completeWeek: () => {},
    getCompletedWeek: () => null,
    getRecentWeeks: () => [],
    deleteCompletedWeek: () => {},
    canEdit: false,
    loading: false,
    synced: false
  };

  // Save engineering issues to localStorage (same key as EngineeringModule)
  useEffect(() => {
    localStorage.setItem('moda_engineering_issues', JSON.stringify(engineeringIssues));
  }, [engineeringIssues]);

  // Open report issue modal with context
  const openReportIssue = (module, station) => {
    setReportIssueContext({
      module,
      station,
      project: selectedProject
    });
    setShowReportIssueModal(true);
  };

  // Handle issue submission - format matches EngineeringModule
  const handleSubmitIssue = issueData => {
    const counter = parseInt(localStorage.getItem('moda_issue_counter') || '0') + 1;
    localStorage.setItem('moda_issue_counter', counter.toString());
    const newIssue = {
      id: `issue-${Date.now()}`,
      issue_number: counter,
      issue_display_id: `ENG-${String(counter).padStart(4, '0')}`,
      issue_type: issueData.category || 'other',
      priority: issueData.urgency || 'medium',
      title: issueData.title || '',
      description: issueData.description || '',
      project_name: issueData.projectName || '',
      blm_id: issueData.moduleSerial || '',
      department: issueData.department || '',
      stage: issueData.location || '',
      submitted_by: issueData.reportedBy || 'Unknown',
      photo_urls: (issueData.photos || []).map(p => p.data || p),
      status: 'open',
      comments: [],
      status_history: [{
        status: 'open',
        changed_by: issueData.reportedBy || 'Unknown',
        timestamp: new Date().toISOString(),
        note: 'Issue created'
      }],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    setEngineeringIssues(prev => [newIssue, ...prev]);
    setShowReportIssueModal(false);
    setReportIssueContext(null);
    alert(`Issue ${newIssue.issue_display_id} submitted successfully!`);
  };
  const selectedProject = projects.find(p => p.id === selectedProjectId);
  const modules = selectedProject?.modules || [];

  // Sort modules by build sequence (lower = further along)
  const sortedModules = [...modules].sort((a, b) => (a.buildSequence || 0) - (b.buildSequence || 0));

  // Categorize modules
  const categorizeModules = () => {
    const scheduled = []; // Not yet in Automation
    const inProduction = []; // Automation through Sign-Off
    const allComplete = []; // Completed Close-Up (all of them)

    sortedModules.forEach(module => {
      const progress = module.stageProgress || {};
      const autoProgress = Math.max(progress['auto-c'] || 0, progress['auto-f'] || 0, progress['auto-walls'] || 0);
      const closeUpProgress = progress['close-up'] || 0;
      if (closeUpProgress === 100) {
        // Include close-up completion timestamp if available
        const completedAt = module.stationCompletedAt?.['close-up'] || 0;
        allComplete.push({
          ...module,
          completedAt
        });
      } else if (autoProgress > 0) {
        inProduction.push(module);
      } else {
        scheduled.push(module);
      }
    });

    // Limit to 5 most recently completed (by completion timestamp)
    // For modules without timestamps (legacy), use build sequence as fallback
    const complete = allComplete.sort((a, b) => {
      if (a.completedAt && b.completedAt) return b.completedAt - a.completedAt;
      if (a.completedAt && !b.completedAt) return -1;
      if (!a.completedAt && b.completedAt) return 1;
      return (b.buildSequence || 0) - (a.buildSequence || 0);
    }).slice(0, 5).reverse(); // Oldest at top, newest at bottom

    return {
      scheduled,
      inProduction,
      complete
    };
  };

  // Update module progress for a specific station
  const updateModuleProgress = (moduleId, stationId, newProgress) => {
    setProjects(prevProjects => prevProjects.map(project => {
      if (project.id !== selectedProjectId) return project;
      return {
        ...project,
        modules: project.modules.map(module => {
          if (module.id !== moduleId) return module;
          const updatedProgress = {
            ...module.stageProgress
          };
          const wasComplete = updatedProgress[stationId] === 100;
          updatedProgress[stationId] = newProgress;

          // Track completion timestamps per station
          let stationCompletedAt = module.stationCompletedAt || {};
          if (newProgress === 100 && !wasComplete) {
            // Just marked complete - record timestamp
            stationCompletedAt = {
              ...stationCompletedAt,
              [stationId]: Date.now()
            };
          } else if (newProgress < 100 && wasComplete) {
            // Reverted from complete - remove timestamp
            stationCompletedAt = {
              ...stationCompletedAt
            };
            delete stationCompletedAt[stationId];
          }
          return {
            ...module,
            stageProgress: updatedProgress,
            stationCompletedAt
          };
        })
      };
    }));
  };
  const {
    scheduled,
    inProduction,
    complete
  } = categorizeModules();
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between flex-wrap gap-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-autovol-navy"
  }, "Production Dashboard"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, activeProjects.length > 0 && /*#__PURE__*/React.createElement("select", {
    value: selectedProjectId || '',
    onChange: e => setSelectedProjectId(e.target.value),
    className: "border rounded px-3 py-2 font-medium"
  }, activeProjects.map(p => /*#__PURE__*/React.createElement("option", {
    key: p.id,
    value: p.id
  }, p.name))))), activeProjects.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-8 text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "No active projects. Go to Projects tab to create one and set status to Active.")) : !selectedProject ? /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-8 text-center"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "Select a project to view production.")) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "border-b flex overflow-x-auto"
  }, [{
    id: 'weekly-board',
    label: 'Weekly Board'
  }, {
    id: 'module-status',
    label: 'Module Status'
  }, {
    id: 'staggers',
    label: 'Station Stagger'
  }, {
    id: 'schedule-setup',
    label: 'Schedule Setup'
  }, {
    id: 'reports',
    label: 'Reports'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    onClick: () => setProductionTab(tab.id),
    className: `px-6 py-3 text-sm font-medium transition ${productionTab === tab.id ? 'text-autovol-teal border-b-2 border-autovol-teal' : 'text-gray-500 hover:text-gray-700'}`
  }, tab.label))), /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, productionTab === 'module-status' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-3 h-3 rounded-full bg-gray-400"
  }), "Scheduled (", scheduled.length, ")", /*#__PURE__*/React.createElement("span", {
    className: "font-normal text-sm text-gray-500"
  }, "\u2013 Not yet in Automation")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2"
  }, scheduled.slice(0, 24).map(module => /*#__PURE__*/React.createElement("div", {
    key: module.id,
    className: "border rounded p-2 text-center bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-mono text-xs font-bold text-gray-600"
  }, module.serialNumber?.slice(-4)), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-400"
  }, "#", module.buildSequence))), scheduled.length > 24 && /*#__PURE__*/React.createElement("div", {
    className: "border rounded p-2 text-center bg-gray-100 text-gray-500 text-xs"
  }, "+", scheduled.length - 24, " more"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-3 h-3 rounded-full bg-autovol-teal"
  }), "In Production (", inProduction.length, ")", /*#__PURE__*/React.createElement("span", {
    className: "font-normal text-sm text-gray-500"
  }, "\u2013 Automation through Sign-Off")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2"
  }, inProduction.map(module => /*#__PURE__*/React.createElement("div", {
    key: module.id,
    className: "border rounded p-2 text-center bg-teal-50 border-autovol-teal"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-mono text-xs font-bold text-gray-800"
  }, module.serialNumber?.slice(-4)), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "#", module.buildSequence))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "w-3 h-3 rounded-full bg-green-500"
  }), "Recently Complete (", complete.length, ")", /*#__PURE__*/React.createElement("span", {
    className: "font-normal text-sm text-gray-500"
  }, "\u2013 Last 5 finished Close-Up")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-2"
  }, complete.map(module => /*#__PURE__*/React.createElement("div", {
    key: module.id,
    className: "border rounded p-2 text-center bg-green-50 border-green-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-mono text-xs font-bold text-gray-800"
  }, module.serialNumber?.slice(-4)), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "#", module.buildSequence))), complete.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-400 col-span-full"
  }, "No completed modules yet")))), productionTab === 'staggers' && /*#__PURE__*/React.createElement(StaggerConfigTab, {
    productionStages: productionStages,
    stationGroups: stationGroups,
    staggerConfig: staggerConfig,
    staggerChangeLog: staggerChangeLog,
    hasUnsavedStaggerChanges: hasUnsavedStaggerChanges,
    updateStagger: updateStagger,
    saveStaggerChanges: saveStaggerChanges,
    revertToStaggerConfig: revertToStaggerConfig,
    resetToDefaultStaggers: resetToDefaultStaggers,
    currentUser: auth.currentUser,
    isAdmin: auth.isAdmin
  }), productionTab === 'weekly-board' && (window.WeeklyBoardComponents?.WeeklyBoardTab ? /*#__PURE__*/React.createElement(window.WeeklyBoardComponents.WeeklyBoardTab, {
    projects: projects,
    productionStages: productionStages,
    staggerConfig: staggerConfig,
    currentWeek: currentWeek,
    weeks: weeks,
    scheduleSetup: weeklySchedule.scheduleSetup,
    getLineBalance: weeklySchedule.getLineBalance,
    completedWeeks: weeklySchedule.completedWeeks,
    completeWeek: weeklySchedule.completeWeek,
    addWeek: addWeek,
    onModuleClick: setSelectedModuleDetail,
    setProductionTab: setProductionTab,
    setProjects: setProjects,
    canEdit: auth.canEditTab('production'),
    initialSelectedWeekId: selectedWeekId,
    onWeekSelected: () => setSelectedWeekId(null),
    onEditWeek: weekId => {
      setEditWeekId(weekId);
      setProductionTab('schedule-setup');
    },
    onReportIssue: (module, station) => {
      setReportIssueContext({
        module,
        station,
        project: selectedProject
      });
      setShowReportIssueModal(true);
    }
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "Weekly Board component loading..."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm mt-2"
  }, "If this persists, check that WeeklyBoard.jsx is loaded."))), productionTab === 'schedule-setup' && (window.WeeklyBoardComponents?.ScheduleSetupTab ? /*#__PURE__*/React.createElement(window.WeeklyBoardComponents.ScheduleSetupTab, {
    scheduleSetup: weeklySchedule.scheduleSetup,
    updateShiftSchedule: weeklySchedule.updateShiftSchedule,
    getShiftTotal: weeklySchedule.getShiftTotal,
    getLineBalance: weeklySchedule.getLineBalance,
    weeks: weeks,
    currentWeek: currentWeek,
    addWeek: addWeek,
    updateWeek: updateWeek,
    deleteWeek: deleteWeek,
    validateWeek: validateWeek,
    allModules: (() => {
      // Get regular modules from active projects
      const regularModules = activeProjects.sort((a, b) => (a.productionOrder || 999) - (b.productionOrder || 999)).flatMap(p => (p.modules || []).map(m => ({
        ...m,
        projectId: p.id,
        projectName: p.name,
        projectAbbreviation: p.abbreviation,
        projectProductionOrder: p.productionOrder || 999
      })));

      // Get scheduled prototypes from ALL projects (not just active)
      const scheduledPrototypes = (projects || []).flatMap(p => (p.modules || []).filter(m => m.isPrototype && m.insertedAfter).map(m => ({
        ...m,
        projectId: p.id,
        projectName: p.name,
        projectAbbreviation: p.abbreviation,
        projectProductionOrder: p.productionOrder || 999
      })));

      // Combine and sort
      const combined = [...regularModules.filter(m => !(m.isPrototype && m.insertedAfter)), ...scheduledPrototypes];
      return combined.sort((a, b) => {
        if (a.projectProductionOrder !== b.projectProductionOrder) return a.projectProductionOrder - b.projectProductionOrder;
        return (a.buildSequence || 0) - (b.buildSequence || 0);
      });
    })(),
    projects: projects,
    setProjects: setProjects,
    canEdit: auth.isAdmin || auth.currentUser?.email && ['trevor@autovol.com', 'stephanie@autovol.com'].includes(auth.currentUser.email.toLowerCase()),
    userEmail: auth.currentUser?.email,
    onViewWeek: weekId => {
      setSelectedWeekId(weekId);
      setProductionTab('weekly-board');
    },
    initialEditWeekId: editWeekId,
    onEditWeekHandled: () => setEditWeekId(null)
  }) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement("p", null, "Schedule Setup component loading..."), /*#__PURE__*/React.createElement("p", {
    className: "text-sm mt-2"
  }, "If this persists, check that WeeklyBoard.jsx is loaded."))), productionTab === 'reports' && (window.ReportsHub ? /*#__PURE__*/React.createElement(window.ReportsHub, {
    projects: projects,
    productionStages: productionStages,
    weeks: weeks,
    currentWeek: currentWeek ? {
      ...currentWeek,
      startingModule: currentWeek.startingModule,
      shift1: weeklySchedule.scheduleSetup.shift1,
      shift2: weeklySchedule.scheduleSetup.shift2
    } : null,
    completedWeeks: weeklySchedule.completedWeeks,
    scheduleSetup: weeklySchedule.scheduleSetup,
    staggerConfig: staggerConfig,
    lineBalance: weeklySchedule.getLineBalance()
  }) : /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "Loading Reports Hub..."))))), showReportIssueModal && reportIssueContext && (window.IssueSubmissionModal ? /*#__PURE__*/React.createElement(window.IssueSubmissionModal, {
    context: {
      project_id: reportIssueContext.project?.id,
      project_name: reportIssueContext.project?.name,
      blm_id: reportIssueContext.module?.serialNumber || reportIssueContext.module?.hitchBLM,
      unit_type: reportIssueContext.module?.hitchUnit,
      department: reportIssueContext.station?.name || '',
      stage: reportIssueContext.station?.id || ''
    },
    projects: projects,
    employees: [],
    auth: auth,
    onClose: () => {
      setShowReportIssueModal(false);
      setReportIssueContext(null);
    }
  }) : /*#__PURE__*/React.createElement(ReportIssueModal, {
    context: reportIssueContext,
    onSubmit: handleSubmitIssue,
    onClose: () => {
      setShowReportIssueModal(false);
      setReportIssueContext(null);
    }
  })), selectedModuleDetail && /*#__PURE__*/React.createElement(ModuleDetailModal, {
    module: selectedModuleDetail,
    project: selectedProject,
    projects: projects,
    setProjects: setProjects,
    onClose: () => {
      setSelectedModuleDetail(null);
      setEditMode(false);
    },
    editMode: editMode,
    setEditMode: setEditMode
  }));
}

// ============================================================================
// REPORT ISSUE MODAL COMPONENT
// ============================================================================
function ReportIssueModal({
  context,
  onSubmit,
  onClose
}) {
  const {
    module,
    station,
    project
  } = context;
  const fileInputRef = useRef(null);
  const URGENCY_LEVELS = [{
    id: 'low',
    label: 'Low',
    color: '#10B981',
    bgColor: '#D1FAE5'
  }, {
    id: 'medium',
    label: 'Medium',
    color: '#F59E0B',
    bgColor: '#FEF3C7'
  }, {
    id: 'high',
    label: 'High',
    color: '#EA580C',
    bgColor: '#FFEDD5'
  }, {
    id: 'critical',
    label: 'Critical',
    color: '#DC2626',
    bgColor: '#FEE2E2'
  }];
  const [formData, setFormData] = useState({
    title: '',
    category: '',
    urgency: 'medium',
    department: station?.name || '',
    moduleSerial: module?.serialNumber || '',
    projectName: project?.name || '',
    description: '',
    reportedBy: '',
    contactPhone: '',
    location: station?.name || '',
    photos: []
  });
  const [photoPreview, setPhotoPreview] = useState([]);
  const handlePhotoCapture = e => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = event => {
        setPhotoPreview(prev => [...prev, event.target.result]);
        setFormData(prev => ({
          ...prev,
          photos: [...prev.photos, {
            data: event.target.result,
            name: file.name,
            timestamp: new Date().toISOString()
          }]
        }));
      };
      reader.readAsDataURL(file);
    });
  };
  const removePhoto = index => {
    setPhotoPreview(prev => prev.filter((_, i) => i !== index));
    setFormData(prev => ({
      ...prev,
      photos: prev.photos.filter((_, i) => i !== index)
    }));
  };
  const handleSubmit = e => {
    e.preventDefault();
    if (!formData.title || !formData.category || !formData.reportedBy) {
      alert('Please fill in Title, Category, and Your Name');
      return;
    }
    onSubmit(formData);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b sticky top-0 bg-white z-10",
    style: {
      borderTopColor: 'var(--autovol-red)',
      borderTopWidth: '4px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold",
    style: {
      color: 'var(--autovol-navy)'
    }
  }, "\u26A0\uFE0F Report Issue to Engineering"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-1"
  }, "Module: ", /*#__PURE__*/React.createElement("span", {
    className: "font-mono font-semibold"
  }, module?.serialNumber), station && /*#__PURE__*/React.createElement(React.Fragment, null, " \u2022 Station: ", /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, station.name)))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-gray-100 rounded-lg text-2xl"
  }, "\xD7"))), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "p-6 space-y-5"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-1"
  }, "Issue Title ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.title,
    onChange: e => setFormData({
      ...formData,
      title: e.target.value
    }),
    placeholder: "Brief description of the issue",
    className: "w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",
    required: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, "Issue Category ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-2"
  }, ENGINEERING_ISSUE_CATEGORIES.map(cat => /*#__PURE__*/React.createElement("button", {
    key: cat.id,
    type: "button",
    onClick: () => setFormData({
      ...formData,
      category: cat.id
    }),
    className: `p-2 rounded-lg border-2 text-left transition text-sm ${formData.category === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`
  }, /*#__PURE__*/React.createElement("span", {
    className: "mr-1"
  }, cat.icon), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, cat.label))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, "Urgency Level ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2"
  }, URGENCY_LEVELS.map(u => /*#__PURE__*/React.createElement("button", {
    key: u.id,
    type: "button",
    onClick: () => setFormData({
      ...formData,
      urgency: u.id
    }),
    className: `p-2 rounded-lg border-2 text-left transition text-sm ${formData.urgency === u.id ? 'ring-2 ring-offset-1' : ''}`,
    style: {
      borderColor: u.color,
      backgroundColor: formData.urgency === u.id ? u.bgColor : 'white'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium",
    style: {
      color: u.color
    }
  }, u.label))))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Department"), /*#__PURE__*/React.createElement("select", {
    value: formData.department,
    onChange: e => setFormData({
      ...formData,
      department: e.target.value
    }),
    className: "w-full px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select department..."), ENGINEERING_DEPARTMENTS.map(dept => /*#__PURE__*/React.createElement("option", {
    key: dept,
    value: dept
  }, dept)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Location/Station"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.location,
    onChange: e => setFormData({
      ...formData,
      location: e.target.value
    }),
    placeholder: "e.g., Station 5, Bay 3",
    className: "w-full px-3 py-2 border rounded-lg"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-1"
  }, "Detailed Description"), /*#__PURE__*/React.createElement("textarea", {
    value: formData.description,
    onChange: e => setFormData({
      ...formData,
      description: e.target.value
    }),
    placeholder: "Describe the issue in detail...",
    rows: 3,
    className: "w-full px-3 py-2 border rounded-lg"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, "Photos (Optional)"), /*#__PURE__*/React.createElement("input", {
    ref: fileInputRef,
    type: "file",
    accept: "image/*",
    multiple: true,
    capture: "environment",
    onChange: handlePhotoCapture,
    className: "hidden"
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => fileInputRef.current?.click(),
    className: "px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-gray-400 hover:bg-gray-50 w-full"
  }, "\uD83D\uDCF7 Add Photos"), photoPreview.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mt-2 flex-wrap"
  }, photoPreview.map((src, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "relative"
  }, /*#__PURE__*/React.createElement("img", {
    src: src,
    alt: `Photo ${idx + 1}`,
    className: "w-20 h-20 object-cover rounded-lg"
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => removePhoto(idx),
    className: "absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs"
  }, "\xD7"))))), /*#__PURE__*/React.createElement("div", {
    className: "border-t pt-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-3"
  }, "Your Information"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Your Name ", /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "*")), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: formData.reportedBy,
    onChange: e => setFormData({
      ...formData,
      reportedBy: e.target.value
    }),
    placeholder: "Full name",
    className: "w-full px-3 py-2 border rounded-lg",
    required: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Phone"), /*#__PURE__*/React.createElement("input", {
    type: "tel",
    value: formData.contactPhone,
    onChange: e => setFormData({
      ...formData,
      contactPhone: e.target.value
    }),
    placeholder: "(555) 123-4567",
    className: "w-full px-3 py-2 border rounded-lg"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-4 border-t"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: onClose,
    className: "flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "flex-1 px-4 py-2 text-white rounded-lg font-medium",
    style: {
      backgroundColor: 'var(--autovol-red)'
    }
  }, "\uD83D\uDCCB Submit Issue")))));
}

// ============================================================================
// PROJECTS DIRECTORY - EXTRACTED TO ProjectsModule.jsx
// ============================================================================

// Project Detail View        // Project Detail View
function ProjectDetail({
  project,
  projects,
  setProjects,
  onBack,
  viewMode,
  setViewMode,
  searchTerm,
  setSearchTerm,
  stageFilter,
  setStageFilter,
  auth
}) {
  // Check if user can manage imports (Admin or Production Management)
  const canManageImports = auth?.isAdmin || auth?.currentUser?.dashboardRole === 'production_management';
  const [showImportModal, setShowImportModal] = useState(false);
  const [selectedModule, setSelectedModule] = useState(null);
  const [editMode, setEditMode] = useState(false);
  const [editingModule, setEditingModule] = useState(null);
  const [showLicensePlates, setShowLicensePlates] = useState(false);
  const [showGoOnlineModal, setShowGoOnlineModal] = useState(false);
  const [goOnlineNotification, setGoOnlineNotification] = useState(null);
  const [importNotification, setImportNotification] = useState(null);
  const [showHeatMapMatrix, setShowHeatMapMatrix] = useState(false);
  const [editingAbbreviation, setEditingAbbreviation] = useState(false);
  const [abbreviationValue, setAbbreviationValue] = useState(project.abbreviation || '');

  // Report Issue State
  const [showReportIssueModal, setShowReportIssueModal] = useState(false);
  const [reportIssueContext, setReportIssueContext] = useState(null);
  const [engineeringIssues, setEngineeringIssues] = useState(() => {
    const saved = localStorage.getItem('moda_engineering_issues');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      try {
        return JSON.parse(saved);
      } catch (e) {
        return [];
      }
    }
    return [];
  });
  const [difficultyFilters, setDifficultyFilters] = useState({
    sidewall: false,
    stair: false,
    hr3Wall: false,
    short: false,
    doubleStudio: false,
    sawbox: false
  });

  // Module list sorting state
  const [moduleSortField, setModuleSortField] = useState('serialNumber');
  const [moduleSortDirection, setModuleSortDirection] = useState('asc');

  // Get fresh project data from projects array to ensure we have latest modules
  const currentProject = projects.find(p => p.id === project.id) || project;
  const modules = currentProject.modules || [];

  // Toggle difficulty filter
  const toggleDifficultyFilter = key => {
    setDifficultyFilters(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  // Check if any difficulty filter is active
  const anyDifficultyFilterActive = Object.values(difficultyFilters).some(v => v);

  // Filter modules
  const filteredModules = modules.filter(m => {
    const matchesSearch = !searchTerm || m.serialNumber?.toLowerCase().includes(searchTerm.toLowerCase()) || m.hitchBLM?.toLowerCase().includes(searchTerm.toLowerCase()) || m.rearBLM?.toLowerCase().includes(searchTerm.toLowerCase()) || String(m.hitchUnit)?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStage = stageFilter === 'all' || m.stageProgress?.[stageFilter] > 0 && m.stageProgress?.[stageFilter] < 100;

    // Difficulty filter - show modules that have ANY of the selected difficulties
    const matchesDifficulty = !anyDifficultyFilterActive || difficultyFilters.sidewall && m.difficulties?.sidewall || difficultyFilters.stair && m.difficulties?.stair || difficultyFilters.hr3Wall && m.difficulties?.hr3Wall || difficultyFilters.short && m.difficulties?.short || difficultyFilters.doubleStudio && m.difficulties?.doubleStudio || difficultyFilters.sawbox && m.difficulties?.sawbox;
    return matchesSearch && matchesStage && matchesDifficulty;
  });

  // Get current stage for display (defined before sortedModules which uses it)
  const getCurrentStage = module => {
    const stageProgress = module.stageProgress || {};
    for (let i = productionStages.length - 1; i >= 0; i--) {
      const stage = productionStages[i];
      if (stageProgress[stage.id] > 0) {
        return {
          stage,
          progress: stageProgress[stage.id]
        };
      }
    }
    return {
      stage: null,
      progress: 0
    };
  };

  // Module sorting handler
  const handleModuleSort = field => {
    if (moduleSortField === field) {
      setModuleSortDirection(moduleSortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setModuleSortField(field);
      setModuleSortDirection('asc');
    }
  };

  // Sort indicator for module table
  const ModuleSortArrow = ({
    field
  }) => {
    if (moduleSortField !== field) return /*#__PURE__*/React.createElement("span", {
      className: "text-gray-300 ml-1"
    }, "\u2195");
    return /*#__PURE__*/React.createElement("span", {
      className: "ml-1"
    }, moduleSortDirection === 'asc' ? '↑' : '↓');
  };

  // Sort filtered modules
  const sortedModules = [...filteredModules].sort((a, b) => {
    let aVal, bVal;
    const {
      stage: aStage,
      progress: aProgress
    } = getCurrentStage(a);
    const {
      stage: bStage,
      progress: bProgress
    } = getCurrentStage(b);
    switch (moduleSortField) {
      case 'serialNumber':
        aVal = (a.serialNumber || '').replace(/\D/g, '');
        bVal = (b.serialNumber || '').replace(/\D/g, '');
        aVal = parseInt(aVal, 10) || 0;
        bVal = parseInt(bVal, 10) || 0;
        break;
      case 'buildSequence':
        aVal = parseInt(a.buildSequence, 10) || 0;
        bVal = parseInt(b.buildSequence, 10) || 0;
        break;
      case 'hitchUnit':
        aVal = (a.hitchUnit || '').toLowerCase();
        bVal = (b.hitchUnit || '').toLowerCase();
        break;
      case 'dimensions':
        aVal = (parseFloat(a.moduleWidth) || 0) * (parseFloat(a.moduleLength) || 0);
        bVal = (parseFloat(b.moduleWidth) || 0) * (parseFloat(b.moduleLength) || 0);
        break;
      case 'hitchBLM':
        aVal = (a.hitchBLM || '').toLowerCase();
        bVal = (b.hitchBLM || '').toLowerCase();
        break;
      case 'rearBLM':
        aVal = (a.rearBLM || '').toLowerCase();
        bVal = (b.rearBLM || '').toLowerCase();
        break;
      case 'stage':
        aVal = aStage?.name || '';
        bVal = bStage?.name || '';
        break;
      case 'progress':
        aVal = aProgress || 0;
        bVal = bProgress || 0;
        break;
      default:
        aVal = (a[moduleSortField] || '').toString().toLowerCase();
        bVal = (b[moduleSortField] || '').toString().toLowerCase();
    }
    if (aVal < bVal) return moduleSortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return moduleSortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  // Save engineering issues to localStorage (same key as EngineeringModule)
  useEffect(() => {
    localStorage.setItem('moda_engineering_issues', JSON.stringify(engineeringIssues));
  }, [engineeringIssues]);

  // Open report issue modal with context
  const openReportIssue = (module, station) => {
    setReportIssueContext({
      module,
      station: station || null,
      project: currentProject
    });
    setShowReportIssueModal(true);
  };

  // Handle issue submission - format matches EngineeringModule
  const handleSubmitIssue = issueData => {
    const counter = parseInt(localStorage.getItem('moda_issue_counter') || '0') + 1;
    localStorage.setItem('moda_issue_counter', counter.toString());
    const newIssue = {
      id: `issue-${Date.now()}`,
      issue_number: counter,
      issue_display_id: `ENG-${String(counter).padStart(4, '0')}`,
      issue_type: issueData.category || 'other',
      priority: issueData.urgency || 'medium',
      title: issueData.title || '',
      description: issueData.description || '',
      project_name: issueData.projectName || '',
      blm_id: issueData.moduleSerial || '',
      department: issueData.department || '',
      stage: issueData.location || '',
      submitted_by: issueData.reportedBy || 'Unknown',
      photo_urls: (issueData.photos || []).map(p => p.data || p),
      status: 'open',
      comments: [],
      status_history: [{
        status: 'open',
        changed_by: issueData.reportedBy || 'Unknown',
        timestamp: new Date().toISOString(),
        note: 'Issue created'
      }],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    setEngineeringIssues(prev => [newIssue, ...prev]);
    setShowReportIssueModal(false);
    setReportIssueContext(null);
    alert(`Issue ${newIssue.issue_display_id} submitted successfully!`);
  };

  // Update project modules
  const updateProjectModules = newModules => {
    const updatedProjects = projects.map(p => p.id === project.id ? {
      ...p,
      modules: newModules
    } : p);
    setProjects(updatedProjects);
  };

  // Import handler
  const handleImport = async importedModules => {
    const newModules = importedModules.map((m, idx) => ({
      ...m,
      id: Date.now() + idx,
      stageProgress: productionStages.reduce((acc, stage) => {
        acc[stage.id] = 0;
        return acc;
      }, {})
    }));
    updateProjectModules([...modules, ...newModules]);
    setShowImportModal(false);

    // Generate module package folders in Drawings
    if (window.MODA_SUPABASE_DRAWINGS?.isAvailable?.()) {
      try {
        const result = await window.MODA_SUPABASE_DRAWINGS.folders.generateAllModulePackages(project.id, newModules, auth?.currentUser?.email || 'system');
        console.log('[ProjectDetail] Generated module packages:', result.created, 'created,', result.skipped, 'skipped');
      } catch (err) {
        console.error('[ProjectDetail] Error generating module packages:', err);
      }
    }

    // Show success notification
    setImportNotification({
      message: `Successfully imported ${newModules.length} module${newModules.length !== 1 ? 's' : ''}!`,
      type: 'success'
    });
    setTimeout(() => setImportNotification(null), 5000);
  };

  // Update project status
  const updateProjectStatus = newStatus => {
    const updatedProjects = projects.map(p => p.id === project.id ? {
      ...p,
      status: newStatus
    } : p);
    setProjects(updatedProjects);
  };

  // Update project abbreviation
  const saveAbbreviation = () => {
    const cleanValue = abbreviationValue.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
    const updatedProjects = projects.map(p => p.id === project.id ? {
      ...p,
      abbreviation: cleanValue || null
    } : p);
    setProjects(updatedProjects);
    setAbbreviationValue(cleanValue);
    setEditingAbbreviation(false);
  };

  // Get progress color class
  const getProgressClass = progress => {
    if (progress === 100) return 'stage-bg-100';
    if (progress >= 75) return 'stage-bg-75';
    if (progress >= 50) return 'stage-bg-50';
    if (progress >= 25) return 'stage-bg-25';
    return 'stage-bg-0';
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("button", {
    onClick: onBack,
    className: "text-autovol-red hover:text-autovol-red text-sm mb-2 flex items-center gap-1"
  }, "\u2190 Back to Projects"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-autovol-navy"
  }, project.name), editingAbbreviation ? /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: abbreviationValue,
    onChange: e => setAbbreviationValue(e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3)),
    placeholder: "ABC",
    maxLength: 3,
    className: "w-14 px-2 py-1 border rounded text-center font-mono text-sm uppercase",
    autoFocus: true,
    onKeyDown: e => {
      if (e.key === 'Enter') saveAbbreviation();
      if (e.key === 'Escape') {
        setEditingAbbreviation(false);
        setAbbreviationValue(project.abbreviation || '');
      }
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: saveAbbreviation,
    className: "text-green-600 hover:text-green-700 text-sm px-1"
  }, "Save"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEditingAbbreviation(false);
      setAbbreviationValue(project.abbreviation || '');
    },
    className: "text-gray-400 hover:text-gray-600 text-sm px-1"
  }, "Cancel")) : /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditingAbbreviation(true),
    className: "px-2 py-0.5 text-sm font-mono bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition",
    title: "Click to edit abbreviation (used on Weekly Board)"
  }, currentProject.abbreviation || '---')), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, project.address ? `${project.address}, ${project.city}, ${project.state}` : project.location || ''), project.description && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-600"
  }, project.description), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mt-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: `px-2 py-0.5 text-xs rounded ${project.status === 'Active' ? 'bg-green-100 text-green-800' : project.status === 'Complete' ? 'bg-gray-100 text-gray-800' : project.status === 'Planned' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}`
  }, project.status), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600"
  }, modules.length, " modules"))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, project.status !== 'Active' && modules.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowGoOnlineModal(true),
    className: "px-4 py-2 btn-secondary rounded-lg transition"
  }, "Schedule Online"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowLicensePlates(true),
    disabled: modules.length === 0,
    className: `px-4 py-2 rounded-lg transition flex items-center gap-2 ${modules.length === 0 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-autovol-navy text-white hover:bg-autovol-navy-light'}`
  }, "\uD83C\uDFF7\uFE0F License Plates"), window.MODA_FEATURE_FLAGS?.flags?.enableHeatMapMatrix && canManageImports && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowHeatMapMatrix(true),
    className: "px-4 py-2 btn-secondary rounded-lg transition flex items-center gap-2",
    title: "Configure difficulty settings for labor forecasting"
  }, "Heat Map"), canManageImports && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const headers = ['Serial Number', 'Build Sequence', 'Module Width', 'Module Length', 'Square Footage', 'HITCH BLM ID', 'HITCH Unit', 'HITCH Room', 'HITCH Room Type', 'REAR BLM ID', 'REAR Unit', 'REAR Room', 'REAR Room Type', 'Sidewall (X)', 'Stair (X)', '3HR-Wall (X)', 'Short (X)', 'Double Studio (X)', 'Sawbox (X)', 'Proto (X)'];
      const csvContent = headers.join(',') + '\n';
      const blob = new Blob([csvContent], {
        type: 'text/csv;charset=utf-8;'
      });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `Module_Import_Template_${project.name.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    },
    className: "px-4 py-2 btn-secondary rounded-lg transition"
  }, "Export Template"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowImportModal(true),
    className: "px-4 py-2 btn-primary rounded-lg transition"
  }, "Import Modules")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap items-center gap-4"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search serial, BLM, unit...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "px-3 py-2 border rounded-lg flex-1 min-w-48"
  }), /*#__PURE__*/React.createElement("select", {
    value: stageFilter,
    onChange: e => setStageFilter(e.target.value),
    className: "px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("option", {
    value: "all"
  }, "All Stages"), productionStages.map(stage => /*#__PURE__*/React.createElement("option", {
    key: stage.id,
    value: stage.id
  }, stage.name))), /*#__PURE__*/React.createElement("select", {
    value: `${moduleSortField}-${moduleSortDirection}`,
    onChange: e => {
      const [field, dir] = e.target.value.split('-');
      setModuleSortField(field);
      setModuleSortDirection(dir);
    },
    className: "px-3 py-2 border rounded-lg"
  }, /*#__PURE__*/React.createElement("optgroup", {
    label: "Sort By"
  }, /*#__PURE__*/React.createElement("option", {
    value: "buildSequence-asc"
  }, "Build Seq (Low to High)"), /*#__PURE__*/React.createElement("option", {
    value: "buildSequence-desc"
  }, "Build Seq (High to Low)"), /*#__PURE__*/React.createElement("option", {
    value: "serialNumber-asc"
  }, "Serial # (A-Z)"), /*#__PURE__*/React.createElement("option", {
    value: "serialNumber-desc"
  }, "Serial # (Z-A)"), /*#__PURE__*/React.createElement("option", {
    value: "hitchUnit-asc"
  }, "Unit Type (A-Z)"), /*#__PURE__*/React.createElement("option", {
    value: "hitchUnit-desc"
  }, "Unit Type (Z-A)"), /*#__PURE__*/React.createElement("option", {
    value: "hitchBLM-asc"
  }, "Hitch BLM (A-Z)"), /*#__PURE__*/React.createElement("option", {
    value: "hitchBLM-desc"
  }, "Hitch BLM (Z-A)"), /*#__PURE__*/React.createElement("option", {
    value: "rearBLM-asc"
  }, "Rear BLM (A-Z)"), /*#__PURE__*/React.createElement("option", {
    value: "rearBLM-desc"
  }, "Rear BLM (Z-A)"), /*#__PURE__*/React.createElement("option", {
    value: "dimensions-asc"
  }, "Size (Small to Large)"), /*#__PURE__*/React.createElement("option", {
    value: "dimensions-desc"
  }, "Size (Large to Small)"), /*#__PURE__*/React.createElement("option", {
    value: "stage-asc"
  }, "Stage (A-Z)"), /*#__PURE__*/React.createElement("option", {
    value: "stage-desc"
  }, "Stage (Z-A)"), /*#__PURE__*/React.createElement("option", {
    value: "progress-asc"
  }, "Progress (Low to High)"), /*#__PURE__*/React.createElement("option", {
    value: "progress-desc"
  }, "Progress (High to Low)"))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1 border rounded-lg p-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setViewMode('grid'),
    className: `px-3 py-1 rounded ${viewMode === 'grid' ? 'bg-gray-800 text-white' : 'text-gray-600'}`
  }, "Grid"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setViewMode('list'),
    className: `px-3 py-1 rounded ${viewMode === 'list' ? 'bg-gray-800 text-white' : 'text-gray-600'}`
  }, "List"))), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap items-center gap-2 mt-3 pt-3 border-t"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-600 font-medium"
  }, "Difficulty Filters:"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('sidewall'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.sidewall ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-600 border-gray-300 hover:border-orange-400'}`
  }, "Sidewall"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('stair'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.stair ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-600 border-gray-300 hover:border-purple-400'}`
  }, "Stair"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('hr3Wall'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.hr3Wall ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-600 border-gray-300 hover:border-red-400'}`
  }, "3HR-Wall"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('short'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.short ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-600 border-gray-300 hover:border-yellow-400'}`
  }, "Short"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('doubleStudio'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.doubleStudio ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-400'}`
  }, "Dbl Studio"), /*#__PURE__*/React.createElement("button", {
    onClick: () => toggleDifficultyFilter('sawbox'),
    className: `px-2 py-1 text-xs rounded-full border transition ${difficultyFilters.sawbox ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-gray-300 hover:border-green-400'}`
  }, "Sawbox"), anyDifficultyFilterActive && /*#__PURE__*/React.createElement("button", {
    onClick: () => setDifficultyFilters({
      sidewall: false,
      stair: false,
      hr3Wall: false,
      short: false,
      doubleStudio: false,
      sawbox: false
    }),
    className: "px-2 py-1 text-xs text-gray-500 hover:text-gray-700 underline"
  }, "Clear filters")), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-2"
  }, "Showing ", filteredModules.length, " of ", modules.length, " modules")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-900"
  }, "Project Modules")), modules.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, "No modules imported yet. Click \"Import Modules\" to add modules from Excel.") : viewMode === 'grid' ? /*#__PURE__*/React.createElement("div", {
    className: "p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
  }, sortedModules.map(module => {
    const {
      stage: currentStage,
      progress
    } = getCurrentStage(module);
    const hasDifficulties = Object.values(module.difficulties || {}).some(v => v);
    return /*#__PURE__*/React.createElement("div", {
      key: module.id,
      onClick: () => setSelectedModule(module),
      className: "border rounded-lg p-4 hover:shadow-md transition cursor-pointer"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between items-start mb-3"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("h4", {
      className: "font-bold text-lg text-gray-900"
    }, module.serialNumber), module.isPrototype && /*#__PURE__*/React.createElement("span", {
      className: "text-yellow-500 cursor-help",
      title: "Prototype",
      style: {
        fontSize: '14px'
      }
    }, "\u2605"), module.excludeFromSchedule && /*#__PURE__*/React.createElement("span", {
      className: "text-orange-500 cursor-help",
      title: "Excluded from Weekly Board schedule",
      style: {
        fontSize: '12px'
      }
    }, "\uD83D\uDEAB")), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, "Build Seq: ", module.buildSequence)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, currentStage && /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-1 text-xs rounded ${getProgressClass(progress)} ${progress === 100 ? 'text-white' : progress >= 50 ? 'text-white' : 'text-gray-800'}`
    }, currentStage.name), /*#__PURE__*/React.createElement("div", {
      className: "relative group"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
      },
      className: "p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-gray-600",
      title: "More options"
    }, "\u22EE"), /*#__PURE__*/React.createElement("div", {
      className: "absolute right-0 top-full mt-1 w-40 bg-white rounded-lg shadow-lg border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-20"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setSelectedModule(module);
      },
      className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
    }, "\uD83D\uDC41\uFE0F View Details"), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setSelectedModule(module);
        setEditMode(true);
      },
      className: "w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
    }, "\u270F\uFE0F Edit Module"), /*#__PURE__*/React.createElement("div", {
      className: "border-t"
    }), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        openReportIssue(module, null);
      },
      className: "w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
    }, "\u26A0\uFE0F Report Issue"), project.status === 'Active' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "border-t"
    }), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        const updatedProjects = projects.map(p => {
          if (p.id !== project.id) return p;
          return {
            ...p,
            modules: p.modules.map(m => m.id === module.id ? {
              ...m,
              excludeFromSchedule: !m.excludeFromSchedule
            } : m)
          };
        });
        setProjects(updatedProjects);
      },
      className: `w-full px-3 py-2 text-left text-sm flex items-center gap-2 ${module.excludeFromSchedule ? 'hover:bg-green-50 text-green-600' : 'hover:bg-orange-50 text-orange-600'}`
    }, module.excludeFromSchedule ? '📅 Include in Schedule' : '🚫 Exclude from Schedule')))))), /*#__PURE__*/React.createElement("div", {
      className: "text-sm text-gray-600 mb-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, "Unit:"), " ", module.hitchUnit || 'N/A'), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-4 text-sm text-gray-600 mb-3"
    }, /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("strong", null, "W:"), " ", module.moduleWidth, "'"), /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("strong", null, "L:"), " ", module.moduleLength, "'"), /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("strong", null, "SF:"), " ", module.squareFootage)), /*#__PURE__*/React.createElement("div", {
      className: "border-t pt-2 space-y-1 text-sm"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 w-12"
    }, "HITCH:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, module.hitchBLM || 'N/A'), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "|"), /*#__PURE__*/React.createElement("span", null, module.hitchRoomType || 'N/A')), /*#__PURE__*/React.createElement("div", {
      className: "flex gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500 w-12"
    }, "REAR:"), /*#__PURE__*/React.createElement("span", {
      className: "font-medium"
    }, module.rearBLM || 'N/A'), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-500"
    }, "|"), /*#__PURE__*/React.createElement("span", null, module.rearRoomType || 'N/A'))), hasDifficulties && /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-1 mt-3 pt-2 border-t"
    }, Object.entries(module.difficulties || {}).map(([key, value]) => value && /*#__PURE__*/React.createElement("span", {
      key: key,
      className: `px-2 py-0.5 text-xs rounded ${difficultyColors[key]}`
    }, difficultyLabels[key]))), progress > 0 && /*#__PURE__*/React.createElement("div", {
      className: "mt-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex justify-between text-xs text-gray-500 mb-1"
    }, /*#__PURE__*/React.createElement("span", null, currentStage?.name), /*#__PURE__*/React.createElement("span", null, progress, "%")), /*#__PURE__*/React.createElement("div", {
      className: "w-full bg-gray-200 rounded-full h-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: `h-2 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`,
      style: {
        width: `${progress}%`
      }
    }))));
  })) : /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-50"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('serialNumber')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Serial # ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "serialNumber"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('buildSequence')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Build Seq ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "buildSequence"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('hitchUnit')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Unit ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "hitchUnit"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('dimensions')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Dimensions ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "dimensions"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('hitchBLM')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Hitch BLM ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "hitchBLM"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('rearBLM')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Rear BLM ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "rearBLM"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('stage')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Stage ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "stage"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none",
    onClick: () => handleModuleSort('progress')
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center"
  }, "Progress ", /*#__PURE__*/React.createElement(ModuleSortArrow, {
    field: "progress"
  }))), /*#__PURE__*/React.createElement("th", {
    className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
  }, "Difficulties"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, sortedModules.map(module => {
    const {
      stage: currentStage,
      progress
    } = getCurrentStage(module);
    return /*#__PURE__*/React.createElement("tr", {
      key: module.id,
      onClick: () => setSelectedModule(module),
      className: "hover:bg-gray-50 cursor-pointer"
    }, /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 font-medium"
    }, /*#__PURE__*/React.createElement("span", {
      className: "flex items-center gap-1"
    }, module.serialNumber, module.isPrototype && /*#__PURE__*/React.createElement("span", {
      className: "text-yellow-500 cursor-help",
      title: "Prototype",
      style: {
        fontSize: '12px'
      }
    }, "\u2605"))), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, module.buildSequence), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, module.hitchUnit), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3 text-sm"
    }, module.moduleWidth, "' x ", module.moduleLength, "'"), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, module.hitchBLM), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, module.rearBLM), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, currentStage && /*#__PURE__*/React.createElement("span", {
      className: `px-2 py-1 text-xs rounded ${getProgressClass(progress)} ${progress >= 50 ? 'text-white' : ''}`
    }, currentStage.name)), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-20 bg-gray-200 rounded-full h-2"
    }, /*#__PURE__*/React.createElement("div", {
      className: `h-2 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`,
      style: {
        width: `${progress}%`
      }
    })), /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-500"
    }, progress, "%"))), /*#__PURE__*/React.createElement("td", {
      className: "px-4 py-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex flex-wrap gap-1"
    }, Object.entries(module.difficulties || {}).map(([key, value]) => value && /*#__PURE__*/React.createElement("span", {
      key: key,
      className: `px-1.5 py-0.5 text-xs rounded ${difficultyColors[key]}`
    }, difficultyLabels[key])))));
  }))))), showImportModal && /*#__PURE__*/React.createElement(ImportModal, {
    onClose: () => setShowImportModal(false),
    onImport: handleImport
  }), selectedModule && /*#__PURE__*/React.createElement(ModuleDetailModal, {
    module: selectedModule,
    project: project,
    projects: projects,
    setProjects: setProjects,
    onClose: () => {
      setSelectedModule(null);
      setEditMode(false);
    },
    editMode: editMode,
    setEditMode: setEditMode
  }), showLicensePlates && /*#__PURE__*/React.createElement(LicensePlateGenerator, {
    project: currentProject,
    modules: modules,
    onClose: () => setShowLicensePlates(false)
  }), showHeatMapMatrix && window.HeatMapMatrix && /*#__PURE__*/React.createElement(window.HeatMapMatrix, {
    project: currentProject,
    productionStages: productionStages,
    onClose: () => setShowHeatMapMatrix(false),
    canEdit: canManageImports
  }), showReportIssueModal && reportIssueContext && (window.IssueSubmissionModal ? /*#__PURE__*/React.createElement(window.IssueSubmissionModal, {
    context: {
      project_id: reportIssueContext.project?.id,
      project_name: reportIssueContext.project?.name,
      blm_id: reportIssueContext.module?.serialNumber || reportIssueContext.module?.hitchBLM,
      unit_type: reportIssueContext.module?.hitchUnit,
      department: reportIssueContext.station?.name || '',
      stage: reportIssueContext.station?.id || ''
    },
    projects: projects,
    employees: [],
    auth: auth,
    onClose: () => {
      setShowReportIssueModal(false);
      setReportIssueContext(null);
    }
  }) : /*#__PURE__*/React.createElement(ReportIssueModal, {
    context: reportIssueContext,
    onSubmit: handleSubmitIssue,
    onClose: () => {
      setShowReportIssueModal(false);
      setReportIssueContext(null);
    }
  })), showGoOnlineModal && /*#__PURE__*/React.createElement(GoOnlineModal, {
    project: currentProject,
    modules: modules,
    onClose: () => setShowGoOnlineModal(false),
    onConfirm: (selectedModuleIds, insertAfterSerial) => {
      // Calculate next productionOrder (max existing + 1)
      const maxProductionOrder = Math.max(0, ...projects.filter(p => p.productionOrder != null).map(p => p.productionOrder));
      const nextProductionOrder = maxProductionOrder + 1;

      // Update project status to Active and assign productionOrder
      const updatedProjects = projects.map(p => {
        if (p.id !== project.id) return p;

        // If specific modules selected, mark them as online
        const updatedModules = p.modules.map(m => {
          if (selectedModuleIds === 'all' || selectedModuleIds.includes(m.id)) {
            return {
              ...m,
              isOnline: true
            };
          }
          return m;
        });
        return {
          ...p,
          status: 'Active',
          modules: updatedModules,
          productionOrder: p.productionOrder ?? nextProductionOrder
        };
      });
      setProjects(updatedProjects);
      setShowGoOnlineModal(false);

      // Show success notification
      const count = selectedModuleIds === 'all' ? modules.length : selectedModuleIds.length;
      setGoOnlineNotification({
        message: `Project "${project.name}" is now Active with ${count} module${count !== 1 ? 's' : ''} online!`,
        type: 'success'
      });
      setTimeout(() => setGoOnlineNotification(null), 5000);
    }
  }), goOnlineNotification && /*#__PURE__*/React.createElement("div", {
    className: "fixed top-4 right-4 z-[200] bg-green-50 border-l-4 border-green-500 text-green-800 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, "\u2705"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, goOnlineNotification.message), /*#__PURE__*/React.createElement("button", {
    onClick: () => setGoOnlineNotification(null),
    className: "text-green-600 hover:text-green-800 ml-2"
  }, "\xD7")), importNotification && /*#__PURE__*/React.createElement("div", {
    className: "fixed top-4 right-4 z-[200] bg-blue-50 border-l-4 border-blue-500 text-blue-800 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xl"
  }, "\uD83D\uDCE5"), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, importNotification.message), /*#__PURE__*/React.createElement("button", {
    onClick: () => setImportNotification(null),
    className: "text-blue-600 hover:text-blue-800 ml-2"
  }, "\xD7")));
}

// ===== SCHEDULE ONLINE MODAL =====
function GoOnlineModal({
  project,
  modules,
  onClose,
  onConfirm
}) {
  const [mode, setMode] = useState('all'); // 'all' or 'select'
  const [selectedModules, setSelectedModules] = useState(new Set());
  const [insertAfter, setInsertAfter] = useState('');
  const [confirmationText, setConfirmationText] = useState('');
  const [showConfirmStep, setShowConfirmStep] = useState(false);

  // Check if confirmation text matches project name (case-insensitive)
  const isConfirmationValid = confirmationText.toLowerCase().trim() === project.name.toLowerCase().trim();

  // Get modules already online (for insert after dropdown)
  const onlineModules = modules.filter(m => m.isOnline);
  const toggleModule = moduleId => {
    setSelectedModules(prev => {
      const next = new Set(prev);
      if (next.has(moduleId)) {
        next.delete(moduleId);
      } else {
        next.add(moduleId);
      }
      return next;
    });
  };
  const selectAll = () => setSelectedModules(new Set(modules.map(m => m.id)));
  const selectNone = () => setSelectedModules(new Set());
  const handleConfirm = () => {
    if (mode === 'all') {
      onConfirm('all', null);
    } else {
      onConfirm(Array.from(selectedModules), insertAfter);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b bg-green-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-green-800"
  }, "Schedule Online"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-green-600"
  }, "Activate project: ", project.name)), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "p-2 hover:bg-green-100 rounded-lg text-2xl text-green-600"
  }, "\xD7"))), !showConfirmStep ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700"
  }, "Which modules to put online?"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setMode('all'),
    className: `p-3 rounded-lg border-2 text-left transition ${mode === 'all' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-gray-800"
  }, "All Modules"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, modules.length, " modules")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setMode('select'),
    className: `p-3 rounded-lg border-2 text-left transition ${mode === 'select' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-gray-800"
  }, "Select Modules"), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, "e.g., prototypes only")))), mode === 'select' && /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700"
  }, "Select Modules (", selectedModules.size, " selected)"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: selectAll,
    className: "text-xs text-blue-600 hover:underline"
  }, "Select All"), /*#__PURE__*/React.createElement("button", {
    onClick: selectNone,
    className: "text-xs text-gray-500 hover:underline"
  }, "Clear"))), /*#__PURE__*/React.createElement("div", {
    className: "max-h-48 overflow-y-auto border rounded-lg p-2 space-y-1"
  }, modules.map(m => /*#__PURE__*/React.createElement("label", {
    key: m.id,
    className: "flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedModules.has(m.id),
    onChange: () => toggleModule(m.id),
    className: "w-4 h-4 text-green-600 rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-mono text-sm"
  }, m.serialNumber), m.isPrototype && /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-500 text-xs"
  }, "\u2605 Prototype"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400 ml-auto"
  }, "#", m.buildSequence)))), onlineModules.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Insert after existing module (optional)"), /*#__PURE__*/React.createElement("select", {
    value: insertAfter,
    onChange: e => setInsertAfter(e.target.value),
    className: "w-full border rounded-lg px-3 py-2 text-sm"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "At end of schedule"), onlineModules.map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.serialNumber
  }, "After ", m.serialNumber, " (#", m.buildSequence, ")"))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, /*#__PURE__*/React.createElement("strong", null, "Summary:"), " Project will be set to ", /*#__PURE__*/React.createElement("span", {
    className: "text-green-600 font-semibold"
  }, "Active"), " status with", ' ', mode === 'all' ? /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, modules.length, " modules") : /*#__PURE__*/React.createElement("span", {
    className: "font-semibold"
  }, selectedModules.size, " selected modules"), ' ', "ready for production scheduling."))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-end gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowConfirmStep(true),
    disabled: mode === 'select' && selectedModules.size === 0,
    className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Continue"))) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-yellow-50 border border-yellow-200 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-yellow-600 text-xl flex-shrink-0"
  }, "\u26A0"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-yellow-800"
  }, "Confirm Project Activation"), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-yellow-700 mt-1"
  }, "This action will set the project to ", /*#__PURE__*/React.createElement("strong", null, "Active"), " status and add modules to the production schedule.")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, "Type the project name to confirm: ", /*#__PURE__*/React.createElement("span", {
    className: "text-green-600"
  }, project.name)), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: confirmationText,
    onChange: e => setConfirmationText(e.target.value),
    placeholder: project.name,
    className: `w-full px-4 py-2 border-2 rounded-lg transition ${confirmationText && !isConfirmationValid ? 'border-red-300 bg-red-50' : isConfirmationValid ? 'border-green-500 bg-green-50' : 'border-gray-300'}`,
    autoFocus: true
  }), confirmationText && !isConfirmationValid && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-red-600 mt-1"
  }, "Project name doesn't match")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-lg p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-600"
  }, /*#__PURE__*/React.createElement("strong", null, "You are about to:"), /*#__PURE__*/React.createElement("ul", {
    className: "mt-2 space-y-1 list-disc list-inside"
  }, /*#__PURE__*/React.createElement("li", null, "Set ", /*#__PURE__*/React.createElement("strong", null, project.name), " to Active status"), /*#__PURE__*/React.createElement("li", null, "Put ", mode === 'all' ? modules.length : selectedModules.size, " module(s) online"), /*#__PURE__*/React.createElement("li", null, "Add these modules to the Weekly Board schedule"))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t flex justify-between"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowConfirmStep(false);
      setConfirmationText('');
    },
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Back"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: handleConfirm,
    disabled: !isConfirmationValid,
    className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Schedule Online"))))));
}

// ===== LICENSE PLATE GENERATOR =====
function LicensePlateGenerator({
  project,
  modules,
  onClose
}) {
  const [selectedModules, setSelectedModules] = useState(new Set(modules.map((_, i) => i)));
  const [searchTerm, setSearchTerm] = useState('');
  const [buildingFilters, setBuildingFilters] = useState(new Set());
  const [levelFilters, setLevelFilters] = useState(new Set());
  const [difficultyFilters, setDifficultyFilters] = useState(new Set());
  const [unitTypeFilters, setUnitTypeFilters] = useState(new Set());
  const [seqFrom, setSeqFrom] = useState('');
  const [seqTo, setSeqTo] = useState('');
  const [previewModule, setPreviewModule] = useState(modules[0] || null);
  const [previewSide, setPreviewSide] = useState('H');
  const [pageSize, setPageSize] = useState('letter');
  const [footerNotes, setFooterNotes] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const baseUrl = window.location.origin + window.location.pathname;
  const pageSizes = {
    letter: {
      width: 612,
      height: 792,
      label: 'Letter (8.5" × 11")'
    },
    legal: {
      width: 612,
      height: 1008,
      label: 'Legal (8.5" × 14")'
    },
    tabloid: {
      width: 792,
      height: 1224,
      label: 'Tabloid (11" × 17")'
    }
  };

  // Extract filter options
  const filterOptions = useMemo(() => {
    const buildings = new Map();
    const levels = new Map();
    const difficulties = new Map();
    const unitTypes = new Map();
    modules.forEach(module => {
      // Extract from BLM ID (hitchBLM) for Building/Level
      const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
      if (blmData.building !== 'OTHER') {
        buildings.set(blmData.building, (buildings.get(blmData.building) || 0) + 1);
      }
      if (blmData.level !== 'OTHER') {
        levels.set(blmData.level, (levels.get(blmData.level) || 0) + 1);
      }
      const indicators = getLicensePlateIndicators(module);
      indicators.forEach(ind => {
        difficulties.set(ind.key, (difficulties.get(ind.key) || 0) + 1);
      });
      const unitType = extractUnitType(module.hitchUnit || module.unitType || '');
      unitTypes.set(unitType, (unitTypes.get(unitType) || 0) + 1);
    });

    // Sort buildings and levels naturally (B1, B2, B3... and L0, L1, L2...)
    const sortNatural = (a, b) => {
      const numA = parseInt(a[0].slice(1)) || 0;
      const numB = parseInt(b[0].slice(1)) || 0;
      return numA - numB;
    };
    return {
      buildings: Array.from(buildings.entries()).sort(sortNatural),
      levels: Array.from(levels.entries()).sort(sortNatural),
      difficulties: Array.from(difficulties.entries()),
      unitTypes: Array.from(unitTypes.entries()).sort((a, b) => a[0].localeCompare(b[0]))
    };
  }, [modules]);

  // Filter modules
  const filteredModules = useMemo(() => {
    return modules.filter(module => {
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        const serial = String(module.serialNumber || '').toLowerCase();
        const buildSeq = String(module.buildSequence || '').toLowerCase();
        const unitType = String(module.hitchUnit || module.unitType || '').toLowerCase();
        const blm = String(module.hitchBLM || '').toLowerCase();
        if (!serial.includes(term) && !buildSeq.includes(term) && !unitType.includes(term) && !blm.includes(term)) return false;
      }
      // Building filter
      if (buildingFilters.size > 0) {
        const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
        if (!buildingFilters.has(blmData.building)) return false;
      }
      // Level filter
      if (levelFilters.size > 0) {
        const blmData = extractFromBLM(module.hitchBLM || module.serialNumber || '');
        if (!levelFilters.has(blmData.level)) return false;
      }
      if (difficultyFilters.size > 0) {
        const indicators = getLicensePlateIndicators(module);
        const indicatorKeys = indicators.map(i => i.key);
        if (!Array.from(difficultyFilters).some(f => indicatorKeys.includes(f))) return false;
      }
      if (unitTypeFilters.size > 0) {
        const unitType = extractUnitType(module.hitchUnit || module.unitType || '');
        if (!unitTypeFilters.has(unitType)) return false;
      }
      const seq = parseInt(module.buildSequence) || 0;
      if (seqFrom && seq < parseInt(seqFrom)) return false;
      if (seqTo && seq > parseInt(seqTo)) return false;
      return true;
    });
  }, [modules, searchTerm, buildingFilters, levelFilters, difficultyFilters, unitTypeFilters, seqFrom, seqTo]);
  const toggleFilter = (set, setFn, value) => {
    const newSet = new Set(set);
    newSet.has(value) ? newSet.delete(value) : newSet.add(value);
    setFn(newSet);
  };
  const clearFilters = () => {
    setBuildingFilters(new Set());
    setLevelFilters(new Set());
    setDifficultyFilters(new Set());
    setUnitTypeFilters(new Set());
    setSeqFrom('');
    setSeqTo('');
    setSearchTerm('');
  };
  const hasActiveFilters = buildingFilters.size > 0 || levelFilters.size > 0 || difficultyFilters.size > 0 || unitTypeFilters.size > 0 || seqFrom || seqTo || searchTerm;
  const selectAllFiltered = () => {
    const indices = filteredModules.map(m => modules.indexOf(m));
    setSelectedModules(new Set(indices));
  };
  const selectNone = () => setSelectedModules(new Set());
  const toggleModuleSelection = moduleIdx => {
    const newSelected = new Set(selectedModules);
    newSelected.has(moduleIdx) ? newSelected.delete(moduleIdx) : newSelected.add(moduleIdx);
    setSelectedModules(newSelected);
  };
  const selectedInFiltered = Array.from(selectedModules).filter(idx => filteredModules.includes(modules[idx])).length;

  // PDF Generation
  const generatePDF = async () => {
    const selectedArray = Array.from(selectedModules).filter(idx => filteredModules.includes(modules[idx])).sort((a, b) => {
      const seqA = parseInt(modules[a].buildSequence) || 0;
      const seqB = parseInt(modules[b].buildSequence) || 0;
      return seqA - seqB;
    });
    if (selectedArray.length === 0) return alert('Please select at least one module');
    setIsGenerating(true);
    try {
      const {
        jsPDF
      } = window.jspdf;
      const size = pageSizes[pageSize];
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: [size.width, size.height]
      });
      let isFirstPage = true;
      for (const idx of selectedArray) {
        const module = modules[idx];
        if (!isFirstPage) doc.addPage();
        isFirstPage = false;
        drawPlate(doc, module, 'H', size);
        doc.addPage();
        drawPlate(doc, module, 'R', size);
      }
      doc.save(`License_Plates_${project.name.replace(/\s+/g, '_')}_${new Date().toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: '2-digit'
      }).replace(/\//g, '-')}.pdf`);
    } catch (error) {
      alert('Error generating PDF: ' + error.message);
    } finally {
      setIsGenerating(false);
    }
  };
  const drawPlate = (doc, module, side, size) => {
    const {
      width,
      height
    } = size;
    const centerX = width / 2;
    const scale = height > 900 ? height > 1100 ? 1.3 : 1.15 : 1;
    const serial = module.serialNumber || '';
    const buildSeq = module.buildSequence || '';
    const blm = side === 'H' ? module.hitchBLM || '' : module.rearBLM || '';
    const unitType = module.hitchUnit || module.unitType || '';
    const indicators = getLicensePlateIndicators(module);
    const moduleMenuUrl = `https://modulardashboard.com/module/${project.id}/${blm}`;
    let y = 50 * scale;
    doc.setFontSize(14 * scale).setFont('helvetica', 'bold');
    doc.text(`PROJECT: ${project.name.toUpperCase()}`, centerX, y, {
      align: 'center'
    });
    y += 18 * scale;
    doc.text(`LOCATION: ${(project.address ? `${project.city}, ${project.state}` : project.location || '').toUpperCase()}`, centerX, y, {
      align: 'center'
    });
    y += 35 * scale;
    doc.setFontSize(36 * scale).text(`#${buildSeq}`, centerX, y, {
      align: 'center'
    });
    y += 45 * scale;
    doc.setFontSize(42 * scale).text(String(serial), centerX, y, {
      align: 'center'
    });
    y += 55 * scale;
    doc.setFontSize(54 * scale).text(`(${side}) - ${blm}`, centerX, y, {
      align: 'center'
    });
    y += 50 * scale;
    if (indicators.length > 0) {
      doc.setTextColor(220, 38, 38).setFontSize(24 * scale);
      doc.text(indicators.map(i => i.label).join('; '), centerX, y, {
        align: 'center'
      });
      doc.setTextColor(0, 0, 0);
    }
    y += 35 * scale;
    doc.setFontSize(32 * scale).text(String(unitType).toUpperCase(), centerX, y, {
      align: 'center'
    });
    y += 50 * scale;

    // Always show QR code
    doc.setFontSize(8 * scale).setFont('helvetica', 'bold');
    doc.text('Module Information', centerX, y, {
      align: 'center'
    });
    y += 12 * scale;
    const qr = qrcode(0, 'M');
    qr.addData(moduleMenuUrl);
    qr.make();
    const qrSize = 100 * scale;
    doc.addImage(qr.createDataURL(4, 0), 'PNG', centerX - qrSize / 2, y, qrSize, qrSize);
    y += qrSize + 12 * scale;
    doc.setFontSize(8 * scale).setFont('helvetica', 'normal');
    doc.text('Scan for drawings & info', centerX, y, {
      align: 'center'
    });
    let footerY = height - 50 * scale;
    doc.setFontSize(10 * scale);
    doc.text(new Date().toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    }), centerX, footerY, {
      align: 'center'
    });
    if (footerNotes?.trim()) {
      doc.setFont('helvetica', 'italic').setFontSize(9 * scale);
      doc.text(footerNotes.trim(), centerX, footerY - 15 * scale, {
        align: 'center'
      });
    }
  };

  // Filter Chip Component
  const FilterChip = ({
    label,
    count,
    selected,
    onClick,
    color = 'blue'
  }) => {
    const colors = {
      blue: selected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400',
      orange: selected ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-400',
      purple: selected ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-700 border-gray-300 hover:border-purple-400',
      red: selected ? 'bg-red-600 text-white border-red-600' : 'bg-white text-gray-700 border-gray-300 hover:border-red-400',
      yellow: selected ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-700 border-gray-300 hover:border-yellow-400',
      green: selected ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-700 border-gray-300 hover:border-green-400',
      pink: selected ? 'bg-pink-600 text-white border-pink-600' : 'bg-white text-gray-700 border-gray-300 hover:border-pink-400'
    };
    return /*#__PURE__*/React.createElement("button", {
      onClick: onClick,
      className: `px-3 py-1.5 rounded-full border text-sm font-medium flex items-center gap-1.5 transition ${colors[color]}`
    }, label, count !== undefined && /*#__PURE__*/React.createElement("span", {
      className: `text-xs px-1.5 rounded-full ${selected ? 'bg-white/30' : 'bg-gray-200'}`
    }, count));
  };
  const difficultyColors = {
    'PROTO': 'pink',
    'STAIR': 'purple',
    '3HR': 'red',
    'SW': 'orange',
    'SHORT': 'yellow',
    'DBL': 'blue',
    'SAWBOX': 'green'
  };

  // Plate Preview Component
  const PlatePreview = ({
    module,
    side
  }) => {
    if (!module) return /*#__PURE__*/React.createElement("div", {
      className: "bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center text-gray-500"
    }, "Select a module to preview");
    const serial = module.serialNumber || '';
    const buildSeq = module.buildSequence || '';
    const blm = side === 'H' ? module.hitchBLM || '' : module.rearBLM || '';
    const unitType = module.hitchUnit || module.unitType || '';
    const indicators = getLicensePlateIndicators(module);
    const moduleMenuUrl = `https://modulardashboard.com/module/${project.id}/${blm}`;
    return /*#__PURE__*/React.createElement("div", {
      className: "bg-white border-2 border-gray-400 rounded p-4 w-64 text-center mx-auto shadow-lg",
      style: {
        fontFamily: 'Arial, sans-serif'
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-gray-700"
    }, "PROJECT: ", project.name.toUpperCase()), /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-gray-700 mb-2"
    }, "LOCATION: ", (project.address ? `${project.city}, ${project.state}` : project.location || '').toUpperCase()), /*#__PURE__*/React.createElement("div", {
      className: "text-3xl font-bold text-gray-900"
    }, "#", buildSeq), /*#__PURE__*/React.createElement("div", {
      className: "text-2xl font-bold text-gray-800 my-1"
    }, serial), /*#__PURE__*/React.createElement("div", {
      className: "text-4xl font-bold my-2",
      style: {
        color: 'var(--autovol-navy)'
      }
    }, "(", side, ") - ", blm), indicators.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "text-red-600 font-bold text-sm my-1"
    }, indicators.map(i => i.label).join('; ')), /*#__PURE__*/React.createElement("div", {
      className: "text-xl font-bold text-gray-800 my-1"
    }, String(unitType).toUpperCase()), /*#__PURE__*/React.createElement("div", {
      className: "my-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "text-xs font-bold text-gray-600 mb-1"
    }, "Module Information"), /*#__PURE__*/React.createElement("img", {
      src: generateQRCode(moduleMenuUrl),
      className: "w-20 h-20 mx-auto",
      alt: "QR Code"
    }), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 mt-1"
    }, "Scan for drawings & info")), footerNotes && /*#__PURE__*/React.createElement("div", {
      className: "text-xs italic text-gray-600 my-1"
    }, footerNotes), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500 border-t pt-2 mt-2"
    }, /*#__PURE__*/React.createElement("div", null, new Date().toLocaleDateString('en-US', {
      month: '2-digit',
      day: '2-digit',
      year: '2-digit'
    }))));
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-autovol-gray z-50 overflow-auto"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-navy text-white p-4 sticky top-0 z-10 shadow-lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "max-w-7xl mx-auto flex items-center justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "hover:bg-autovol-navy-light p-2 rounded flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("span", null, "\u2190"), " Back"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
    className: "text-xl font-bold flex items-center gap-2"
  }, "\uD83C\uDFF7\uFE0F License Plate Generator"), /*#__PURE__*/React.createElement("p", {
    className: "text-blue-200 text-sm"
  }, project.name, " \u2022 ", modules.length, " modules"))))), /*#__PURE__*/React.createElement("div", {
    className: "max-w-7xl mx-auto p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-1 lg:grid-cols-4 gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "lg:col-span-1 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "\uD83C\uDFE2 Building"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, filterOptions.buildings.length > 0 ? filterOptions.buildings.map(([building, count]) => /*#__PURE__*/React.createElement(FilterChip, {
    key: building,
    label: building,
    count: count,
    selected: buildingFilters.has(building),
    onClick: () => toggleFilter(buildingFilters, setBuildingFilters, building),
    color: "blue"
  })) : /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "No building data"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "\uD83D\uDCCB\u0160 Level"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, filterOptions.levels.length > 0 ? filterOptions.levels.map(([level, count]) => /*#__PURE__*/React.createElement(FilterChip, {
    key: level,
    label: level,
    count: count,
    selected: levelFilters.has(level),
    onClick: () => toggleFilter(levelFilters, setLevelFilters, level),
    color: "purple"
  })) : /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "No level data"))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "\u26A0 Difficulty"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, filterOptions.difficulties.map(([diff, count]) => /*#__PURE__*/React.createElement(FilterChip, {
    key: diff,
    label: diff,
    count: count,
    selected: difficultyFilters.has(diff),
    onClick: () => toggleFilter(difficultyFilters, setDifficultyFilters, diff),
    color: difficultyColors[diff] || 'blue'
  }))), filterOptions.difficulties.length === 0 && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "No difficulty indicators")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "\uD83C\uDFE0 Unit Type"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, filterOptions.unitTypes.map(([type, count]) => /*#__PURE__*/React.createElement(FilterChip, {
    key: type,
    label: type,
    count: count,
    selected: unitTypeFilters.has(type),
    onClick: () => toggleFilter(unitTypeFilters, setUnitTypeFilters, type),
    color: "green"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "\uD83D\uDCE2 Sequence Range"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "number",
    placeholder: "From",
    value: seqFrom,
    onChange: e => setSeqFrom(e.target.value),
    className: "w-20 border rounded px-2 py-1.5 text-sm",
    min: "1"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "to"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    placeholder: "To",
    value: seqTo,
    onChange: e => setSeqTo(e.target.value),
    className: "w-20 border rounded px-2 py-1.5 text-sm",
    min: "1"
  }))), hasActiveFilters && /*#__PURE__*/React.createElement("button", {
    onClick: clearFilters,
    className: "w-full py-2 text-sm text-autovol-red hover:bg-red-50 rounded-lg border border-red-200 font-medium"
  }, "\u2715 Clear All Filters")), /*#__PURE__*/React.createElement("div", {
    className: "lg:col-span-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-b"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap items-center gap-3 mb-3"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy"
  }, "Modules"), /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, filteredModules.length, " of ", modules.length, " shown"), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: selectAllFiltered,
    className: "text-sm text-autovol-teal hover:underline font-medium"
  }, "Select All"), /*#__PURE__*/React.createElement("button", {
    onClick: selectNone,
    className: "text-sm text-gray-600 hover:underline font-medium"
  }, "Select None")), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Search by serial, sequence, or unit type...",
    value: searchTerm,
    onChange: e => setSearchTerm(e.target.value),
    className: "w-full border rounded-lg px-3 py-2 text-sm"
  })), /*#__PURE__*/React.createElement("div", {
    className: "max-h-[500px] overflow-y-auto"
  }, filteredModules.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "p-8 text-center text-gray-500"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-4xl mb-2"
  }, "\uD83D\uDCCD"), /*#__PURE__*/React.createElement("p", null, "No modules match your filters"), /*#__PURE__*/React.createElement("button", {
    onClick: clearFilters,
    className: "mt-2 text-autovol-teal hover:underline font-medium"
  }, "Clear filters")) : filteredModules.map(module => {
    const idx = modules.indexOf(module);
    const isSelected = selectedModules.has(idx);
    const indicators = getLicensePlateIndicators(module);
    return /*#__PURE__*/React.createElement("div", {
      key: idx,
      className: `p-3 border-b flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'bg-blue-50' : ''}`,
      onClick: () => toggleModuleSelection(idx)
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: isSelected,
      readOnly: true,
      className: "w-4 h-4 rounded"
    }), /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-bold text-gray-900"
    }, "#", module.buildSequence), /*#__PURE__*/React.createElement("span", {
      className: "text-gray-700"
    }, module.serialNumber)), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 text-sm text-gray-500"
    }, /*#__PURE__*/React.createElement("span", null, module.hitchUnit || module.unitType), /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, "H:", module.hitchBLM), /*#__PURE__*/React.createElement("span", null, "R:", module.rearBLM)), indicators.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "flex gap-1 mt-1"
    }, indicators.map((ind, i) => /*#__PURE__*/React.createElement("span", {
      key: i,
      className: "text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-medium"
    }, ind.label)))), /*#__PURE__*/React.createElement("button", {
      onClick: e => {
        e.stopPropagation();
        setPreviewModule(module);
      },
      className: "p-2 text-gray-400 hover:text-autovol-teal hover:bg-teal-50 rounded",
      title: "Preview"
    }, "\uD83D\uDC41\x81"));
  })))), /*#__PURE__*/React.createElement("div", {
    className: "lg:col-span-1 space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "Preview"), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-center gap-2 mb-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setPreviewSide('H'),
    className: `px-4 py-1.5 rounded text-sm font-medium transition-colors ${previewSide === 'H' ? 'bg-autovol-navy text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`
  }, "Hitch (H)"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setPreviewSide('R'),
    className: `px-4 py-1.5 rounded text-sm font-medium transition-colors ${previewSide === 'R' ? 'bg-autovol-navy text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`
  }, "Rear (R)")), /*#__PURE__*/React.createElement(PlatePreview, {
    module: previewModule,
    side: previewSide
  })), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-autovol-navy mb-3"
  }, "PDF Settings"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Page Size"), /*#__PURE__*/React.createElement("select", {
    value: pageSize,
    onChange: e => setPageSize(e.target.value),
    className: "w-full border rounded-lg px-3 py-2 text-sm"
  }, Object.entries(pageSizes).map(([key, val]) => /*#__PURE__*/React.createElement("option", {
    key: key,
    value: key
  }, val.label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Footer Notes"), /*#__PURE__*/React.createElement("textarea", {
    value: footerNotes,
    onChange: e => setFooterNotes(e.target.value),
    placeholder: "e.g., Rev 2, Updated 11/23...",
    className: "w-full border rounded-lg px-3 py-2 text-sm",
    rows: 2,
    maxLength: 100
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, footerNotes.length, "/100")))), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-autovol-teal-light rounded-lg p-3 mb-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Selected Modules:"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-gray-900"
  }, selectedInFiltered)), /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "Total Pages:"), /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-autovol-teal"
  }, selectedInFiltered * 2))), /*#__PURE__*/React.createElement("button", {
    onClick: generatePDF,
    disabled: isGenerating || selectedInFiltered === 0,
    className: `w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 transition-colors ${isGenerating || selectedInFiltered === 0 ? 'bg-gray-400 cursor-not-allowed' : 'btn-primary'}`
  }, isGenerating ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "animate-spin"
  }, "\u23F3"), "Generating...") : /*#__PURE__*/React.createElement(React.Fragment, null, "\uD83D\uDCCB\u201E Generate ", selectedInFiltered * 2, " Plates")))))));
}

// Module Detail Modal
function ModuleDetailModal({
  module,
  project,
  projects,
  setProjects,
  onClose,
  editMode,
  setEditMode
}) {
  const [editingModule, setEditingModule] = useState({
    ...module
  });

  // Close on Escape key
  useEffect(() => {
    const handleEscapeKey = e => {
      if (e.key === 'Escape') {
        onClose();
      }
    };
    document.addEventListener('keydown', handleEscapeKey);
    return () => document.removeEventListener('keydown', handleEscapeKey);
  }, [onClose]);
  const handleSave = () => {
    const updatedProjects = projects.map(p => {
      if (p.id === project.id) {
        return {
          ...p,
          modules: p.modules.map(m => m.id === module.id ? editingModule : m)
        };
      }
      return p;
    });
    setProjects(updatedProjects);

    // DUAL-WRITE: When close-up hits 100%, update unified layer to "Ready for Yard"
    const closeUpProgress = editingModule.stageProgress?.['close-up'] || 0;
    const wasCloseUpComplete = module.stageProgress?.['close-up'] === 100;
    if (closeUpProgress === 100 && !wasCloseUpComplete) {
      // Module just completed production - mark as Ready for Yard
      console.log(`[MODA] Module ${editingModule.serialNumber} completed close-up - marking Ready for Yard`);

      // IMPORTANT: Save to localStorage IMMEDIATELY before sync
      // React setState is async, so migrateFromProjects would read stale data
      localStorage.setItem('autovol_projects', JSON.stringify(updatedProjects));
      console.log(`[MODA] Saved project data to localStorage`);

      // Now sync to unified layer with fresh data
      MODA_UNIFIED.migrateFromProjects();

      // Then update transport status to 'ready' (Ready for Yard)
      MODA_UNIFIED.updateTransport(editingModule.id, {
        status: MODA_UNIFIED.TRANSPORT_STAGES.READY,
        completedProductionAt: new Date().toISOString()
      }, 'station-board');
      console.log(`[MODA] Module ${editingModule.serialNumber} now in Yard phase - Ready for Transport`);
    }
    setEditMode(false);
    onClose();
  };
  const updateField = (field, value) => {
    setEditingModule(prev => ({
      ...prev,
      [field]: value
    }));
  };
  const updateStageProgress = (stageId, value) => {
    setEditingModule(prev => ({
      ...prev,
      stageProgress: {
        ...prev.stageProgress,
        [stageId]: parseInt(value)
      }
    }));
  };
  const displayModule = editMode ? editingModule : module;
  const handleOpenShopDrawing = async () => {
    // First, try the new Drawings Module system
    if (window.MODA_MODULE_DRAWINGS?.isAvailable()) {
      try {
        // Try searching by serial number first
        let hasDrawings = await window.MODA_MODULE_DRAWINGS.hasDrawings(displayModule.serialNumber);
        let searchTerm = displayModule.serialNumber;

        // If not found, try searching by BLM IDs
        if (!hasDrawings && displayModule.hitchBLM) {
          hasDrawings = await window.MODA_MODULE_DRAWINGS.hasDrawings(displayModule.hitchBLM);
          if (hasDrawings) searchTerm = displayModule.hitchBLM;
        }
        if (!hasDrawings && displayModule.rearBLM && displayModule.rearBLM !== displayModule.hitchBLM) {
          hasDrawings = await window.MODA_MODULE_DRAWINGS.hasDrawings(displayModule.rearBLM);
          if (hasDrawings) searchTerm = displayModule.rearBLM;
        }
        if (hasDrawings) {
          // Open the Drawings Module filtered to this module
          // Navigate to Drawings tab with module filter
          if (window.location.hash !== '#drawings') {
            window.location.hash = 'drawings';
          }
          // Store the search term for the Drawings Module to pick up
          sessionStorage.setItem('moda_drawings_module_filter', searchTerm);
          onClose();
          return;
        }
      } catch (error) {
        console.error('[Module Detail] Error checking drawings:', error);
      }
    }

    // Fallback to old shopDrawingLinks system
    const shopDrawingLinks = project?.shopDrawingLinks || {};
    const blmToCheck = [displayModule.hitchBLM, displayModule.rearBLM].filter(Boolean);
    let foundUrl = null;
    for (const blm of blmToCheck) {
      if (shopDrawingLinks[blm]) {
        foundUrl = shopDrawingLinks[blm];
        break;
      }
    }
    if (foundUrl) {
      window.open(foundUrl, '_blank');
    } else {
      const blmList = blmToCheck.length > 0 ? blmToCheck.join(', ') : 'No BLM';
      alert(`Shop Drawing Not Found\n\nNo shop drawing link found for module ${displayModule.serialNumber} (BLM: ${blmList}).\n\nTo add shop drawings:\n1. Go to Drawings → Shop Drawings → Module Packages\n2. Upload drawings to the folder for this module\n\nOr add legacy links: Projects → Edit Project → Shop Drawing Links.`);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-start mb-6 sticky top-0 bg-white pt-2 pb-4 -mt-2 border-b"
  }, /*#__PURE__*/React.createElement("div", null, editMode ? /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 items-center"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "text-xs text-gray-500"
  }, "Serial Number"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.serialNumber || '',
    onChange: e => updateField('serialNumber', e.target.value),
    className: "block text-xl font-bold px-2 py-1 border rounded w-32"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "text-xs text-gray-500"
  }, "Build Seq"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: displayModule.buildSequence || '',
    onChange: e => updateField('buildSequence', parseInt(e.target.value) || 0),
    className: "block text-lg px-2 py-1 border rounded w-20"
  }))) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("h2", {
    className: "text-2xl font-bold text-autovol-navy"
  }, displayModule.serialNumber), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500"
  }, "Build Sequence: ", displayModule.buildSequence))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, editMode ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: handleSave,
    className: "px-3 py-1 btn-secondary rounded"
  }, "Save"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEditMode(false);
      setEditingModule({
        ...module
      });
    },
    className: "px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
  }, "Cancel")) : /*#__PURE__*/React.createElement("button", {
    onClick: () => setEditMode(true),
    className: "px-3 py-1 btn-primary rounded"
  }, "Edit"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7"))), /*#__PURE__*/React.createElement("div", {
    className: "mb-6 grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleOpenShopDrawing,
    className: "py-3 bg-autovol-navy text-white rounded-lg font-medium hover:bg-autovol-navy-light transition flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-file"
  }), " Open Shop Drawing"), /*#__PURE__*/React.createElement("button", {
    onClick: () => alert('License Plate Viewer - Coming Soon!\n\nThis will show the module license plate with download and QR code options.'),
    className: "py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "icon-tag"
  }), " View License Plate")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, "Width"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: displayModule.moduleWidth,
    onChange: e => updateField('moduleWidth', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-semibold"
  }, displayModule.moduleWidth, "'")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, "Length"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: displayModule.moduleLength,
    onChange: e => updateField('moduleLength', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-semibold"
  }, displayModule.moduleLength, "'")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-sm text-gray-500"
  }, "Square Footage"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: displayModule.squareFootage,
    onChange: e => updateField('squareFootage', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-semibold"
  }, displayModule.squareFootage ? parseFloat(displayModule.squareFootage).toFixed(2) : '—', " SF"))), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "HITCH Side"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "BLM ID"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.hitchBLM || '',
    onChange: e => updateField('hitchBLM', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.hitchBLM)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Unit"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.hitchUnit || '',
    onChange: e => updateField('hitchUnit', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.hitchUnit)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Room"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.hitchRoom || '',
    onChange: e => updateField('hitchRoom', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.hitchRoom)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Room Type"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.hitchRoomType || '',
    onChange: e => updateField('hitchRoomType', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.hitchRoomType)))), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "REAR Side"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg text-sm"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "BLM ID"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.rearBLM || '',
    onChange: e => updateField('rearBLM', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.rearBLM)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Unit"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.rearUnit || '',
    onChange: e => updateField('rearUnit', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.rearUnit)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Room"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.rearRoom || '',
    onChange: e => updateField('rearRoom', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.rearRoom)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-500"
  }, "Room Type"), editMode ? /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: displayModule.rearRoomType || '',
    onChange: e => updateField('rearRoomType', e.target.value),
    className: "w-full mt-1 px-2 py-1 border rounded"
  }) : /*#__PURE__*/React.createElement("p", {
    className: "font-medium"
  }, displayModule.rearRoomType)))), /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "Difficulty Indicators"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, Object.entries(difficultyLabels).map(([key, label]) => /*#__PURE__*/React.createElement("label", {
    key: key,
    className: `flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${displayModule.difficulties?.[key] ? difficultyColors[key] : 'bg-gray-100'}`
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: displayModule.difficulties?.[key] || false,
    onChange: e => {
      if (editMode) {
        setEditingModule(prev => ({
          ...prev,
          difficulties: {
            ...prev.difficulties,
            [key]: e.target.checked
          }
        }));
      }
    },
    disabled: !editMode,
    className: "rounded"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-sm"
  }, label))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold text-gray-700 mb-2"
  }, "Production Progress"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, productionStages.map(stage => {
    const progress = displayModule.stageProgress?.[stage.id] || 0;
    return /*#__PURE__*/React.createElement("div", {
      key: stage.id,
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("span", {
      className: "w-36 text-sm text-gray-600"
    }, stage.name), editMode ? /*#__PURE__*/React.createElement("input", {
      type: "range",
      min: "0",
      max: "100",
      step: "25",
      value: progress,
      onChange: e => updateStageProgress(stage.id, e.target.value),
      className: "flex-1"
    }) : /*#__PURE__*/React.createElement("div", {
      className: "flex-1 bg-gray-200 rounded-full h-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: `h-3 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-autovol-teal'}`,
      style: {
        width: `${progress}%`
      }
    })), /*#__PURE__*/React.createElement("span", {
      className: "w-10 text-right text-sm"
    }, progress, "%"));
  }))))));
}

// Import Modal Component
function ImportModal({
  onClose,
  onImport
}) {
  const [dragActive, setDragActive] = useState(false);
  const [preview, setPreview] = useState(null);
  const [error, setError] = useState(null);
  const handleFile = file => {
    setError(null);
    if (!file) {
      setError('No file selected');
      return;
    }
    console.log('Processing file:', file.name, file.type, file.size);
    const reader = new FileReader();
    reader.onerror = () => {
      setError('Error reading file');
    };
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        console.log('File loaded, size:', data.length);
        if (typeof XLSX === 'undefined') {
          setError('Excel library not loaded. Please refresh the page.');
          return;
        }
        const workbook = XLSX.read(data, {
          type: 'array'
        });
        console.log('Workbook sheets:', workbook.SheetNames);
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
          header: 1
        });
        console.log('Rows found:', jsonData.length);
        console.log('First row (headers):', jsonData[0]);
        if (jsonData.length < 2) {
          setError('File must have at least a header row and one data row');
          return;
        }
        const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
        const modules = [];
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (!row || row.length === 0 || !row[0]) continue;
          const getVal = keywords => {
            for (const keyword of keywords) {
              const idx = headers.findIndex(h => h.includes(keyword.toLowerCase()));
              if (idx !== -1 && row[idx] !== undefined) return row[idx];
            }
            return '';
          };
          modules.push({
            serialNumber: getVal(['serial']) || row[0],
            buildSequence: getVal(['build', 'sequence']) || i,
            moduleWidth: parseFloat(getVal(['width'])) || 0,
            moduleLength: parseFloat(getVal(['length'])) || 0,
            squareFootage: parseFloat(getVal(['square', 'sf', 'footage'])) || 0,
            hitchBLM: getVal(['hitch blm', 'hitch_blm']) || getVal(['blm']) || '',
            hitchUnit: getVal(['hitch unit', 'hitch_unit']) || getVal(['unit']) || '',
            hitchRoom: getVal(['hitch room', 'hitch_room']) || '',
            hitchRoomType: getVal(['hitch room type', 'hitch_room_type', 'hitch type']) || '',
            rearBLM: getVal(['rear blm', 'rear_blm']) || '',
            rearUnit: getVal(['rear unit', 'rear_unit']) || '',
            rearRoom: getVal(['rear room', 'rear_room']) || '',
            rearRoomType: getVal(['rear room type', 'rear_room_type', 'rear type']) || '',
            difficulties: {
              sidewall: String(getVal(['sidewall'])).toLowerCase() === 'x' || String(getVal(['sidewall'])).toLowerCase() === 'true',
              stair: String(getVal(['stair'])).toLowerCase() === 'x' || String(getVal(['stair'])).toLowerCase() === 'true',
              hr3Wall: String(getVal(['3hr', '3 hr', 'three hr'])).toLowerCase() === 'x' || String(getVal(['3hr'])).toLowerCase() === 'true',
              short: String(getVal(['short'])).toLowerCase() === 'x' || String(getVal(['short'])).toLowerCase() === 'true',
              doubleStudio: String(getVal(['double', 'dbl studio'])).toLowerCase() === 'x' || String(getVal(['double studio'])).toLowerCase() === 'true',
              sawbox: String(getVal(['sawbox'])).toLowerCase() === 'x' || String(getVal(['sawbox'])).toLowerCase() === 'true'
            },
            isPrototype: String(getVal(['proto', 'prototype'])).toLowerCase() === 'x' || String(getVal(['proto', 'prototype'])).toLowerCase() === 'true'
          });
        }
        if (modules.length === 0) {
          setError('No valid modules found in file. Make sure your file has data rows after the header.');
          console.log('No modules parsed from file');
          return;
        }
        console.log('Successfully parsed', modules.length, 'modules');
        setPreview({
          modules,
          headers: jsonData[0]
        });
      } catch (err) {
        console.error('Import error:', err);
        setError('Error reading file: ' + err.message + '. Check browser console for details.');
      }
    };
    reader.readAsArrayBuffer(file);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold"
  }, "Import Modules from Excel"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7")), !preview ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: `border-2 border-dashed rounded-lg p-12 text-center transition ${dragActive ? 'border-autovol-teal bg-autovol-teal-light' : 'border-gray-300'}`,
    onDragOver: e => {
      e.preventDefault();
      setDragActive(true);
    },
    onDragLeave: () => setDragActive(false),
    onDrop: e => {
      e.preventDefault();
      setDragActive(false);
      handleFile(e.dataTransfer.files[0]);
    }
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-2"
  }, "Drag and drop your Excel file here, or"), /*#__PURE__*/React.createElement("label", {
    className: "inline-block px-4 py-2 btn-primary rounded-lg cursor-pointer"
  }, "Browse Files", /*#__PURE__*/React.createElement("input", {
    type: "file",
    accept: ".xlsx,.xls,.csv",
    className: "hidden",
    onChange: e => handleFile(e.target.files[0])
  }))), error && /*#__PURE__*/React.createElement("p", {
    className: "text-red-600 mt-4"
  }, error), /*#__PURE__*/React.createElement("div", {
    className: "mt-6 p-4 bg-gray-50 rounded-lg"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-semibold mb-2"
  }, "Expected Columns:"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2 text-sm text-gray-600"
  }, /*#__PURE__*/React.createElement("span", null, "\u2022 Serial Number"), /*#__PURE__*/React.createElement("span", null, "\u2022 Build Sequence"), /*#__PURE__*/React.createElement("span", null, "\u2022 Module Width"), /*#__PURE__*/React.createElement("span", null, "\u2022 Module Length"), /*#__PURE__*/React.createElement("span", null, "\u2022 Square Footage"), /*#__PURE__*/React.createElement("span", null, "\u2022 HITCH BLM ID"), /*#__PURE__*/React.createElement("span", null, "\u2022 HITCH Unit"), /*#__PURE__*/React.createElement("span", null, "\u2022 HITCH Room"), /*#__PURE__*/React.createElement("span", null, "\u2022 HITCH Room Type"), /*#__PURE__*/React.createElement("span", null, "\u2022 REAR BLM ID"), /*#__PURE__*/React.createElement("span", null, "\u2022 REAR Unit"), /*#__PURE__*/React.createElement("span", null, "\u2022 REAR Room"), /*#__PURE__*/React.createElement("span", null, "\u2022 REAR Room Type"), /*#__PURE__*/React.createElement("span", null, "\u2022 Sidewall (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 Stair (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 3HR-Wall (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 Short (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 Double Studio (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 Sawbox (X)"), /*#__PURE__*/React.createElement("span", null, "\u2022 Proto (X)")))) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "mb-4 p-4 bg-green-50 border border-green-200 rounded-lg"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-green-800 font-medium"
  }, "\u2713 Found ", preview.modules.length, " modules to import")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto max-h-64 mb-4"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-sm"
  }, /*#__PURE__*/React.createElement("thead", {
    className: "bg-gray-100 sticky top-0"
  }, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "px-2 py-1 text-left"
  }, "Serial #"), /*#__PURE__*/React.createElement("th", {
    className: "px-2 py-1 text-left"
  }, "Build Seq"), /*#__PURE__*/React.createElement("th", {
    className: "px-2 py-1 text-left"
  }, "Dimensions"), /*#__PURE__*/React.createElement("th", {
    className: "px-2 py-1 text-left"
  }, "Hitch BLM"), /*#__PURE__*/React.createElement("th", {
    className: "px-2 py-1 text-left"
  }, "Unit"))), /*#__PURE__*/React.createElement("tbody", {
    className: "divide-y"
  }, preview.modules.slice(0, 10).map((m, i) => /*#__PURE__*/React.createElement("tr", {
    key: i
  }, /*#__PURE__*/React.createElement("td", {
    className: "px-2 py-1 font-medium"
  }, m.serialNumber), /*#__PURE__*/React.createElement("td", {
    className: "px-2 py-1"
  }, m.buildSequence), /*#__PURE__*/React.createElement("td", {
    className: "px-2 py-1"
  }, m.moduleWidth, "' x ", m.moduleLength, "'"), /*#__PURE__*/React.createElement("td", {
    className: "px-2 py-1"
  }, m.hitchBLM), /*#__PURE__*/React.createElement("td", {
    className: "px-2 py-1"
  }, m.hitchUnit))))), preview.modules.length > 10 && /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 mt-2 text-center"
  }, "...and ", preview.modules.length - 10, " more")), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setPreview(null),
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onImport(preview.modules),
    className: "px-4 py-2 btn-primary rounded-lg"
  }, "Import ", preview.modules.length, " Modules"))))));
}

// New Project Modal
function NewProjectModal({
  onClose,
  onSave
}) {
  const [projectNumber, setProjectNumber] = useState('');
  const [name, setName] = useState('');
  const [abbreviation, setAbbreviation] = useState('');
  const [address, setAddress] = useState('');

  // Handle abbreviation input - limit to 3 uppercase letters
  const handleAbbreviationChange = e => {
    const value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 3);
    setAbbreviation(value);
  };
  const [city, setCity] = useState('');
  const [country, setCountry] = useState('US');
  const [state, setState] = useState('');
  const [zipCode, setZipCode] = useState('');
  const [customer, setCustomer] = useState('');
  const [description, setDescription] = useState('');
  const isUS = country === 'US';
  const [status, setStatus] = useState('Planning');
  return /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between items-center mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold"
  }, "New Project"), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "text-gray-400 hover:text-gray-600 text-2xl"
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-4 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Project #"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: projectNumber,
    onChange: e => setProjectNumber(e.target.value),
    placeholder: "e.g., 15",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center",
    min: "1"
  })), /*#__PURE__*/React.createElement("div", {
    className: "col-span-2"
  }, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Project Name *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: name,
    onChange: e => setName(e.target.value),
    placeholder: "e.g., Alvarado Creek",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Abbrev."), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: abbreviation,
    onChange: handleAbbreviationChange,
    placeholder: "AC",
    maxLength: 3,
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase text-center font-mono"
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Country"), /*#__PURE__*/React.createElement("select", {
    value: country,
    onChange: e => {
      setCountry(e.target.value);
      setState('');
    },
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: "US"
  }, "United States"), /*#__PURE__*/React.createElement("option", {
    value: "CA"
  }, "Canada"), /*#__PURE__*/React.createElement("option", {
    value: "MX"
  }, "Mexico"), /*#__PURE__*/React.createElement("option", {
    value: "OTHER"
  }, "Other"))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Address *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: address,
    onChange: e => setAddress(e.target.value),
    placeholder: "e.g., 123 Main Street",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  })), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "City *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: city,
    onChange: e => setCity(e.target.value),
    placeholder: "e.g., San Diego",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, isUS ? 'State' : 'State/Province', " *"), isUS ? /*#__PURE__*/React.createElement("select", {
    value: state,
    onChange: e => setState(e.target.value),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select..."), /*#__PURE__*/React.createElement("option", {
    value: "AL"
  }, "Alabama"), /*#__PURE__*/React.createElement("option", {
    value: "AK"
  }, "Alaska"), /*#__PURE__*/React.createElement("option", {
    value: "AZ"
  }, "Arizona"), /*#__PURE__*/React.createElement("option", {
    value: "AR"
  }, "Arkansas"), /*#__PURE__*/React.createElement("option", {
    value: "CA"
  }, "California"), /*#__PURE__*/React.createElement("option", {
    value: "CO"
  }, "Colorado"), /*#__PURE__*/React.createElement("option", {
    value: "CT"
  }, "Connecticut"), /*#__PURE__*/React.createElement("option", {
    value: "DE"
  }, "Delaware"), /*#__PURE__*/React.createElement("option", {
    value: "FL"
  }, "Florida"), /*#__PURE__*/React.createElement("option", {
    value: "GA"
  }, "Georgia"), /*#__PURE__*/React.createElement("option", {
    value: "HI"
  }, "Hawaii"), /*#__PURE__*/React.createElement("option", {
    value: "ID"
  }, "Idaho"), /*#__PURE__*/React.createElement("option", {
    value: "IL"
  }, "Illinois"), /*#__PURE__*/React.createElement("option", {
    value: "IN"
  }, "Indiana"), /*#__PURE__*/React.createElement("option", {
    value: "IA"
  }, "Iowa"), /*#__PURE__*/React.createElement("option", {
    value: "KS"
  }, "Kansas"), /*#__PURE__*/React.createElement("option", {
    value: "KY"
  }, "Kentucky"), /*#__PURE__*/React.createElement("option", {
    value: "LA"
  }, "Louisiana"), /*#__PURE__*/React.createElement("option", {
    value: "ME"
  }, "Maine"), /*#__PURE__*/React.createElement("option", {
    value: "MD"
  }, "Maryland"), /*#__PURE__*/React.createElement("option", {
    value: "MA"
  }, "Massachusetts"), /*#__PURE__*/React.createElement("option", {
    value: "MI"
  }, "Michigan"), /*#__PURE__*/React.createElement("option", {
    value: "MN"
  }, "Minnesota"), /*#__PURE__*/React.createElement("option", {
    value: "MS"
  }, "Mississippi"), /*#__PURE__*/React.createElement("option", {
    value: "MO"
  }, "Missouri"), /*#__PURE__*/React.createElement("option", {
    value: "MT"
  }, "Montana"), /*#__PURE__*/React.createElement("option", {
    value: "NE"
  }, "Nebraska"), /*#__PURE__*/React.createElement("option", {
    value: "NV"
  }, "Nevada"), /*#__PURE__*/React.createElement("option", {
    value: "NH"
  }, "New Hampshire"), /*#__PURE__*/React.createElement("option", {
    value: "NJ"
  }, "New Jersey"), /*#__PURE__*/React.createElement("option", {
    value: "NM"
  }, "New Mexico"), /*#__PURE__*/React.createElement("option", {
    value: "NY"
  }, "New York"), /*#__PURE__*/React.createElement("option", {
    value: "NC"
  }, "North Carolina"), /*#__PURE__*/React.createElement("option", {
    value: "ND"
  }, "North Dakota"), /*#__PURE__*/React.createElement("option", {
    value: "OH"
  }, "Ohio"), /*#__PURE__*/React.createElement("option", {
    value: "OK"
  }, "Oklahoma"), /*#__PURE__*/React.createElement("option", {
    value: "OR"
  }, "Oregon"), /*#__PURE__*/React.createElement("option", {
    value: "PA"
  }, "Pennsylvania"), /*#__PURE__*/React.createElement("option", {
    value: "RI"
  }, "Rhode Island"), /*#__PURE__*/React.createElement("option", {
    value: "SC"
  }, "South Carolina"), /*#__PURE__*/React.createElement("option", {
    value: "SD"
  }, "South Dakota"), /*#__PURE__*/React.createElement("option", {
    value: "TN"
  }, "Tennessee"), /*#__PURE__*/React.createElement("option", {
    value: "TX"
  }, "Texas"), /*#__PURE__*/React.createElement("option", {
    value: "UT"
  }, "Utah"), /*#__PURE__*/React.createElement("option", {
    value: "VT"
  }, "Vermont"), /*#__PURE__*/React.createElement("option", {
    value: "VA"
  }, "Virginia"), /*#__PURE__*/React.createElement("option", {
    value: "WA"
  }, "Washington"), /*#__PURE__*/React.createElement("option", {
    value: "WV"
  }, "West Virginia"), /*#__PURE__*/React.createElement("option", {
    value: "WI"
  }, "Wisconsin"), /*#__PURE__*/React.createElement("option", {
    value: "WY"
  }, "Wyoming"), /*#__PURE__*/React.createElement("option", {
    value: "DC"
  }, "Washington DC")) : /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: state,
    onChange: e => setState(e.target.value),
    placeholder: "e.g., Ontario",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, isUS ? 'Zip Code' : 'Postal Code'), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: zipCode,
    onChange: e => setZipCode(e.target.value),
    placeholder: isUS ? 'e.g., 92101' : 'e.g., A1A 1A1',
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Status"), /*#__PURE__*/React.createElement("select", {
    value: status,
    onChange: e => setStatus(e.target.value),
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }, /*#__PURE__*/React.createElement("option", {
    value: "Planning"
  }, "Planning"), /*#__PURE__*/React.createElement("option", {
    value: "Active"
  }, "Active"), /*#__PURE__*/React.createElement("option", {
    value: "On Hold"
  }, "On Hold"), /*#__PURE__*/React.createElement("option", {
    value: "Complete"
  }, "Complete"), /*#__PURE__*/React.createElement("option", {
    value: "Archived"
  }, "Archived")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Customer"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: customer,
    onChange: e => setCustomer(e.target.value),
    placeholder: "e.g., ABC Development Corp",
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Description"), /*#__PURE__*/React.createElement("textarea", {
    value: description,
    onChange: e => setDescription(e.target.value),
    placeholder: "Phase 1 residential units...",
    rows: 2,
    className: "w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 justify-end mt-6"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onSave({
      project_number: projectNumber ? parseInt(projectNumber) : null,
      name,
      abbreviation: abbreviation || undefined,
      address,
      city,
      country,
      state,
      zipCode,
      customer,
      description,
      status
    }),
    disabled: !name || !address || !city || !state,
    className: "px-4 py-2 btn-primary rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
  }, "Create Project")))));
}

// ============================================================================
// EXTRACTED MODULES:

function App() {
  // useAuth must be called unconditionally - React hooks rule
  // The hook itself handles the case when auth isn't ready
  const auth = window.useAuth();

  // If not logged in, show login page
  if (!auth.currentUser) {
    return window.LoginPage ? /*#__PURE__*/React.createElement(window.LoginPage, {
      auth: auth
    }) : /*#__PURE__*/React.createElement("div", {
      className: "p-8 text-center"
    }, "Loading...");
  }

  // If logged in, show dashboard
  return /*#__PURE__*/React.createElement(Dashboard, {
    auth: auth
  });
}

// Only render App after useAuth is available (unless another route already handled rendering)
if (!window.MODA_ROUTE_HANDLED) {
  if (window.useAuth) {
    ReactDOM.render(/*#__PURE__*/React.createElement(App, null), document.getElementById('root'));
  } else {
    // Wait for AuthModule to load
    const checkAuth = setInterval(() => {
      if (window.useAuth) {
        clearInterval(checkAuth);
        ReactDOM.render(/*#__PURE__*/React.createElement(App, null), document.getElementById('root'));
      }
    }, 50);
  }
}

// ============================================================================
// EMERGENCY RECOVERY FUNCTION
// Accessible from browser console in case of lockout
// ============================================================================
window.MODA_EMERGENCY_ADMIN_RESTORE = function () {
  console.log('🚨 EMERGENCY ADMIN RESTORE INITIATED');

  // Restore Trevor as protected admin
  let users = [];
  try {
    const saved = localStorage.getItem('autovol_users');
    if (saved && saved !== 'undefined' && saved !== 'null') {
      users = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Error parsing users:', e);
  }
  const trevor = users.find(u => u.email === 'trevor@autovol.com' || u.firstName === 'Trevor' && u.lastName === 'Fletcher');
  if (trevor) {
    trevor.dashboardRole = 'admin';
    trevor.isProtected = true;
    localStorage.setItem('autovol_users', JSON.stringify(users));
    console.log('✅ Trevor Fletcher restored as protected Admin');
    alert('✅ Admin access restored to Trevor Fletcher. Refreshing page...');
    window.location.reload();
  } else {
    console.error('❌ Trevor Fletcher not found in user records');
    alert('❌ Could not find Trevor Fletcher in user records');
  }
};

// Log system status
console.log('🛡️ MODA Dashboard Role System Loaded');
console.log('🛡️ Emergency recovery: MODA_EMERGENCY_ADMIN_RESTORE()');
console.log('🛡️ Trevor Fletcher account is protected');
})();
