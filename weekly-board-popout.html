<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Board - MODA</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link href="./css/styles.css" rel="stylesheet">
    <link href="./css/professional-icons.css" rel="stylesheet">
    <link href="./css/dark-mode.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--autovol-gray-bg, #f5f5f5);
            margin: 0;
            padding: 0;
        }
        .popout-header {
            background: linear-gradient(135deg, #1E3A5F 0%, #2d4a6f 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .popout-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .popout-header .logo {
            width: 32px;
            height: 32px;
        }
        .popout-content {
            padding: 0;
            min-height: calc(100vh - 56px);
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 56px);
            color: #666;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #1E3A5F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            opacity: 0.9;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        .sync-dot.loading {
            background: #f59e0b;
        }
        .sync-dot.error {
            background: #ef4444;
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .back-to-moda {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .back-to-moda:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="popout-header">
            <h1>
                <img src="./public/autovol-logo.png" alt="MODA" class="logo" />
                Weekly Board
            </h1>
            <div class="sync-indicator">
                <div class="sync-dot loading"></div>
                <span>Loading...</span>
            </div>
        </div>
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px;">Loading Weekly Board...</p>
        </div>
    </div>
    
    <!-- Feature Flags -->
    <script src="./js/config/featureFlags.js"></script>
    
    <!-- MODA Core -->
    <script src="./js/core/moda-core.js"></script>
    
    <!-- API Client -->
    <script src="./js/api.js"></script>
    
    <!-- Supabase Integration -->
    <script src="./js/supabase-client.js?v=9"></script>
    <script src="./js/supabase-data.js?v=2"></script>
    <script src="./js/supabase-activity-log.js"></script>
    <script src="./js/supabase-issues.js"></script>
    
    <!-- Hooks -->
    <script src="./js/hooks/useMobile.js"></script>
    <script src="./js/hooks/useActivityLogger.js"></script>
    
    <!-- UI Components -->
    <script type="text/babel" src="./js/components/ui/Modal.jsx"></script>
    <script type="text/babel" src="./js/components/ui/StatusBadge.jsx"></script>
    <script type="text/babel" src="./js/components/ui/DifficultyBadge.jsx"></script>
    <script type="text/babel" src="./js/components/ui/ProgressBar.jsx"></script>
    
    <!-- Weekly Board Component -->
    <script type="text/babel" src="./js/components/WeeklyBoard.jsx"></script>
    
    <!-- Pop-out App -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        
        // Production Stages Definition (same as App.jsx)
        const productionStages = [
            { id: 'auto-c', name: 'Automation (Ceiling)', dept: 'AUTO-C', color: 'bg-slate-700', group: 'automation' },
            { id: 'auto-f', name: 'Automation (Floor)', dept: 'AUTO-F', color: 'bg-slate-600', group: 'automation' },
            { id: 'auto-walls', name: 'Automation (Walls)', dept: 'AUTO-W', color: 'bg-slate-500', group: 'automation' },
            { id: 'mezzanine', name: 'Mezzanine (FC Prep, Plumbing - Floors)', dept: 'MEZZ', color: 'bg-violet-500', group: null },
            { id: 'elec-ceiling', name: 'Electrical - Ceilings', dept: 'ELEC-C', color: 'bg-amber-400', group: null },
            { id: 'wall-set', name: 'Wall Set', dept: 'WALL', color: 'bg-autovol-teal', group: null },
            { id: 'ceiling-set', name: 'Ceiling Set', dept: 'CEIL', color: 'bg-teal-400', group: null },
            { id: 'soffits', name: 'Soffits', dept: 'SOFF', color: 'bg-sky-500', group: null },
            { id: 'mech-rough', name: 'Mechanical Rough-In', dept: 'MECH-R', color: 'bg-cyan-600', group: 'mep-rough' },
            { id: 'elec-rough', name: 'Electrical Rough-In', dept: 'ELEC-R', color: 'bg-cyan-500', group: 'mep-rough' },
            { id: 'plumb-rough', name: 'Plumbing Rough-In', dept: 'PLMB-R', color: 'bg-cyan-400', group: 'mep-rough' },
            { id: 'exteriors', name: 'Exteriors', dept: 'EXT', color: 'bg-teal-500', group: null },
            { id: 'drywall-bp', name: 'Drywall - BackPanel', dept: 'DRY-BP', color: 'bg-green-600', group: null },
            { id: 'drywall-ttp', name: 'Drywall - Tape/Texture/Paint', dept: 'DRY-TTP', color: 'bg-green-500', group: null },
            { id: 'roofing', name: 'Roofing', dept: 'ROOF', color: 'bg-amber-500', group: null },
            { id: 'pre-finish', name: 'Pre-Finish', dept: 'PRE-FIN', color: 'bg-lime-500', group: null },
            { id: 'mech-trim', name: 'Mechanical Trim', dept: 'MECH-T', color: 'bg-yellow-600', group: 'mep-trim' },
            { id: 'elec-trim', name: 'Electrical Trim', dept: 'ELEC-T', color: 'bg-yellow-500', group: 'mep-trim' },
            { id: 'plumb-trim', name: 'Plumbing Trim', dept: 'PLMB-T', color: 'bg-yellow-400', group: 'mep-trim' },
            { id: 'final-finish', name: 'Final Finish', dept: 'FINAL', color: 'bg-orange-500', group: null },
            { id: 'sign-off', name: 'Module Sign-Off', dept: 'SIGN-OFF', color: 'bg-rose-500', group: null },
            { id: 'close-up', name: 'Close-Up', dept: 'CLOSE', color: 'bg-red-500', group: null }
        ];
        
        // Default stagger config
        const defaultStaggerConfig = {
            'auto-c': 0, 'auto-f': 0, 'auto-walls': 0, 'mezzanine': 1,
            'elec-ceiling': 4, 'wall-set': 5, 'ceiling-set': 6, 'soffits': 7,
            'mech-rough': 8, 'elec-rough': 8, 'plumb-rough': 8, 'exteriors': 9,
            'drywall-bp': 10, 'drywall-ttp': 18, 'roofing': 15, 'pre-finish': 24,
            'mech-trim': 25, 'elec-trim': 25, 'plumb-trim': 25, 'final-finish': 26,
            'sign-off': 27, 'close-up': 28
        };
        
        const WeeklyBoardPopout = () => {
            const [projects, setProjects] = useState([]);
            const [weeks, setWeeks] = useState([]);
            const [staggerConfig, setStaggerConfig] = useState(defaultStaggerConfig);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [syncStatus, setSyncStatus] = useState('loading');
            const [currentUser, setCurrentUser] = useState(null);
            
            // Use the weekly schedule hook from WeeklyBoard.jsx
            const weeklySchedule = window.WeeklyBoardComponents?.useWeeklySchedule?.() || {
                scheduleSetup: { shift1: { monday: 5, tuesday: 5, wednesday: 5, thursday: 5 }, shift2: { friday: 0, saturday: 0, sunday: 0 } },
                completedWeeks: [],
                updateShiftSchedule: () => {},
                getShiftTotal: () => 0,
                getLineBalance: () => 20,
                completeWeek: () => {},
                getCompletedWeek: () => null,
                getRecentWeeks: () => [],
                deleteCompletedWeek: () => {},
                canEdit: false,
                loading: false,
                synced: false
            };
            
            // Load data from Supabase
            useEffect(() => {
                const loadData = async () => {
                    try {
                        // Check auth state
                        if (window.MODA_SUPABASE_CLIENT?.getSession) {
                            const session = await window.MODA_SUPABASE_CLIENT.getSession();
                            if (session?.user) {
                                setCurrentUser(session.user);
                            }
                        }
                        
                        // Load projects from Supabase
                        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
                            console.log('[Popout] Loading projects from Supabase...');
                            const supabaseProjects = await window.MODA_SUPABASE_DATA.projects.getAll();
                            const mappedProjects = (supabaseProjects || []).map(p => ({
                                ...p,
                                customer: p.client || p.customer || '',
                                startDate: p.start_date || p.startDate,
                                endDate: p.end_date || p.endDate
                            }));
                            setProjects(mappedProjects);
                            console.log('[Popout] Loaded', mappedProjects.length, 'projects');
                            
                            // Load weeks from localStorage (same as main app)
                            const savedWeeks = localStorage.getItem('autovol_production_weeks');
                            if (savedWeeks) {
                                setWeeks(JSON.parse(savedWeeks));
                            }
                            
                            // Load stagger config
                            const savedStaggers = localStorage.getItem('autovol_stagger_config');
                            if (savedStaggers) {
                                setStaggerConfig(JSON.parse(savedStaggers));
                            }
                            
                            setSyncStatus('connected');
                        } else {
                            // Fallback to localStorage
                            console.log('[Popout] Supabase not available, using localStorage');
                            const saved = localStorage.getItem('autovol_projects');
                            if (saved) setProjects(JSON.parse(saved));
                            
                            const savedWeeks = localStorage.getItem('autovol_production_weeks');
                            if (savedWeeks) setWeeks(JSON.parse(savedWeeks));
                            
                            setSyncStatus('localStorage');
                        }
                        
                        setLoading(false);
                    } catch (err) {
                        console.error('[Popout] Error loading data:', err);
                        setError(err.message);
                        setSyncStatus('error');
                        setLoading(false);
                    }
                };
                
                // Wait for Supabase to initialize
                const initTimeout = setTimeout(loadData, 500);
                return () => clearTimeout(initTimeout);
            }, []);
            
            // Get current week
            const currentWeek = useMemo(() => {
                const now = new Date();
                return weeks.find(w => {
                    const start = new Date(w.startDate);
                    const end = new Date(w.endDate);
                    return now >= start && now <= end;
                }) || weeks[0] || null;
            }, [weeks]);
            
            // Handle project updates
            const handleSetProjects = useCallback(async (newProjects) => {
                const updated = typeof newProjects === 'function' ? newProjects(projects) : newProjects;
                setProjects(updated);
                
                // Save to localStorage as backup
                localStorage.setItem('autovol_projects', JSON.stringify(updated));
                
                // Sync to Supabase if available
                if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
                    // The individual module updates are handled by the WeeklyBoard component
                    console.log('[Popout] Projects updated');
                }
            }, [projects]);
            
            // Add week handler
            const addWeek = useCallback((weekData) => {
                const newWeeks = [...weeks, weekData];
                setWeeks(newWeeks);
                localStorage.setItem('autovol_production_weeks', JSON.stringify(newWeeks));
            }, [weeks]);
            
            // Check if user can edit
            const canEdit = currentUser?.email && 
                ['trevor@autovol.com', 'stephanie@autovol.com'].includes(currentUser.email.toLowerCase());
            
            if (loading) {
                return (
                    <div>
                        <header className="popout-header">
                            <h1>
                                <img src="./public/autovol-logo.png" alt="MODA" className="logo" />
                                Weekly Board
                            </h1>
                            <div className="sync-indicator">
                                <div className="sync-dot loading"></div>
                                <span>Loading...</span>
                            </div>
                        </header>
                        <div className="loading-container">
                            <div className="loading-spinner"></div>
                            <p style={{ marginTop: '16px' }}>Loading data from Supabase...</p>
                        </div>
                    </div>
                );
            }
            
            if (error) {
                return (
                    <div>
                        <header className="popout-header">
                            <h1>
                                <img src="./public/autovol-logo.png" alt="MODA" className="logo" />
                                Weekly Board
                            </h1>
                            <button className="back-to-moda" onClick={() => window.opener?.focus()}>
                                Back to MODA
                            </button>
                        </header>
                        <div className="loading-container">
                            <div style={{ color: '#ef4444', marginBottom: '16px', fontSize: '48px' }}>!</div>
                            <p style={{ color: '#ef4444', fontWeight: 500 }}>{error}</p>
                            <button 
                                onClick={() => window.location.reload()}
                                style={{
                                    marginTop: '16px',
                                    padding: '8px 16px',
                                    background: '#1E3A5F',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                }}
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }
            
            const WeeklyBoardTab = window.WeeklyBoardComponents?.WeeklyBoardTab;
            
            if (!WeeklyBoardTab) {
                return (
                    <div>
                        <header className="popout-header">
                            <h1>
                                <img src="./public/autovol-logo.png" alt="MODA" className="logo" />
                                Weekly Board
                            </h1>
                        </header>
                        <div className="loading-container">
                            <p>Weekly Board component not loaded. Please refresh.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                style={{
                                    marginTop: '16px',
                                    padding: '8px 16px',
                                    background: '#1E3A5F',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                }}
                            >
                                Refresh
                            </button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div>
                    <header className="popout-header">
                        <h1>
                            <img src="./public/autovol-logo.png" alt="MODA" className="logo" />
                            Weekly Board
                        </h1>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                            <div className="sync-indicator">
                                <div className={`sync-dot ${syncStatus === 'error' ? 'error' : ''}`}></div>
                                <span>{syncStatus === 'connected' ? 'Live' : syncStatus === 'localStorage' ? 'Offline' : 'Error'}</span>
                            </div>
                            <button className="back-to-moda" onClick={() => window.opener?.focus()}>
                                Back to MODA
                            </button>
                        </div>
                    </header>
                    <div className="popout-content">
                        <WeeklyBoardTab
                            projects={projects}
                            productionStages={productionStages}
                            staggerConfig={staggerConfig}
                            currentWeek={currentWeek}
                            weeks={weeks}
                            scheduleSetup={weeklySchedule.scheduleSetup}
                            getLineBalance={weeklySchedule.getLineBalance}
                            completedWeeks={weeklySchedule.completedWeeks}
                            completeWeek={weeklySchedule.completeWeek}
                            addWeek={addWeek}
                            onModuleClick={() => {}}
                            setProductionTab={() => {}}
                            setProjects={handleSetProjects}
                            canEdit={canEdit}
                            initialSelectedWeekId={null}
                            onWeekSelected={() => {}}
                            onEditWeek={() => {}}
                            onReportIssue={() => {}}
                            isPopout={true}
                        />
                    </div>
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<WeeklyBoardPopout />, document.getElementById('root'));
    </script>
</body>
</html>
