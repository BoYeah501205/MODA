<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Board - MODA</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="./css/tailwind-output.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link href="./css/styles.css" rel="stylesheet">
    <link href="./css/professional-icons.css" rel="stylesheet">
    <link href="./css/dark-mode.css" rel="stylesheet">
    
    <style>
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--autovol-gray-bg, #f5f5f5);
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #666;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #1E3A5F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px;">Loading Weekly Board...</p>
        </div>
    </div>
    
    <!-- Feature Flags -->
    <script src="./js/config/featureFlags.js"></script>
    
    <!-- MODA Core -->
    <script src="./js/core/moda-core.js"></script>
    
    <!-- API Client -->
    <script src="./js/api.js"></script>
    
    <!-- Supabase Integration -->
    <script src="./js/supabase-client.js?v=9"></script>
    <script src="./js/supabase-data.js?v=2"></script>
    <script src="./js/supabase-activity-log.js"></script>
    <script src="./js/supabase-issues.js"></script>
    
    <!-- Hooks -->
    <script src="./js/hooks/useMobile.js"></script>
    <script src="./js/hooks/useActivityLogger.js"></script>
    
    <!-- UI Components -->
    <script type="text/babel" src="./js/components/ui/Modal.jsx"></script>
    <script type="text/babel" src="./js/components/ui/StatusBadge.jsx"></script>
    <script type="text/babel" src="./js/components/ui/DifficultyBadge.jsx"></script>
    <script type="text/babel" src="./js/components/ui/ProgressBar.jsx"></script>
    
    <!-- Weekly Board Component -->
    <script type="text/babel" src="./js/components/WeeklyBoard.jsx"></script>
    
    <!-- Pop-out App -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        
        // Production Stages Definition (same as App.jsx)
        const productionStages = [
            { id: 'auto-c', name: 'Automation (Ceiling)', dept: 'AUTO-C', color: 'bg-slate-700', group: 'automation' },
            { id: 'auto-f', name: 'Automation (Floor)', dept: 'AUTO-F', color: 'bg-slate-600', group: 'automation' },
            { id: 'auto-walls', name: 'Automation (Walls)', dept: 'AUTO-W', color: 'bg-slate-500', group: 'automation' },
            { id: 'mezzanine', name: 'Mezzanine (FC Prep, Plumbing - Floors)', dept: 'MEZZ', color: 'bg-violet-500', group: null },
            { id: 'elec-ceiling', name: 'Electrical - Ceilings', dept: 'ELEC-C', color: 'bg-amber-400', group: null },
            { id: 'wall-set', name: 'Wall Set', dept: 'WALL', color: 'bg-autovol-teal', group: null },
            { id: 'ceiling-set', name: 'Ceiling Set', dept: 'CEIL', color: 'bg-teal-400', group: null },
            { id: 'soffits', name: 'Soffits', dept: 'SOFF', color: 'bg-sky-500', group: null },
            { id: 'mech-rough', name: 'Mechanical Rough-In', dept: 'MECH-R', color: 'bg-cyan-600', group: 'mep-rough' },
            { id: 'elec-rough', name: 'Electrical Rough-In', dept: 'ELEC-R', color: 'bg-cyan-500', group: 'mep-rough' },
            { id: 'plumb-rough', name: 'Plumbing Rough-In', dept: 'PLMB-R', color: 'bg-cyan-400', group: 'mep-rough' },
            { id: 'exteriors', name: 'Exteriors', dept: 'EXT', color: 'bg-teal-500', group: null },
            { id: 'drywall-bp', name: 'Drywall - BackPanel', dept: 'DRY-BP', color: 'bg-green-600', group: null },
            { id: 'drywall-ttp', name: 'Drywall - Tape/Texture/Paint', dept: 'DRY-TTP', color: 'bg-green-500', group: null },
            { id: 'roofing', name: 'Roofing', dept: 'ROOF', color: 'bg-amber-500', group: null },
            { id: 'pre-finish', name: 'Pre-Finish', dept: 'PRE-FIN', color: 'bg-lime-500', group: null },
            { id: 'mech-trim', name: 'Mechanical Trim', dept: 'MECH-T', color: 'bg-yellow-600', group: 'mep-trim' },
            { id: 'elec-trim', name: 'Electrical Trim', dept: 'ELEC-T', color: 'bg-yellow-500', group: 'mep-trim' },
            { id: 'plumb-trim', name: 'Plumbing Trim', dept: 'PLMB-T', color: 'bg-yellow-400', group: 'mep-trim' },
            { id: 'final-finish', name: 'Final Finish', dept: 'FINAL', color: 'bg-orange-500', group: null },
            { id: 'sign-off', name: 'Module Sign-Off', dept: 'SIGN-OFF', color: 'bg-rose-500', group: null },
            { id: 'close-up', name: 'Close-Up', dept: 'CLOSE', color: 'bg-red-500', group: null }
        ];
        
        // Default stagger config
        const defaultStaggerConfig = {
            'auto-c': 0, 'auto-f': 0, 'auto-walls': 0, 'mezzanine': 1,
            'elec-ceiling': 4, 'wall-set': 5, 'ceiling-set': 6, 'soffits': 7,
            'mech-rough': 8, 'elec-rough': 8, 'plumb-rough': 8, 'exteriors': 9,
            'drywall-bp': 10, 'drywall-ttp': 18, 'roofing': 15, 'pre-finish': 24,
            'mech-trim': 25, 'elec-trim': 25, 'plumb-trim': 25, 'final-finish': 26,
            'sign-off': 27, 'close-up': 28
        };
        
        const WeeklyBoardPopout = () => {
            const [projects, setProjects] = useState([]);
            const [weeks, setWeeks] = useState([]);
            const [staggerConfig, setStaggerConfig] = useState(defaultStaggerConfig);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [syncStatus, setSyncStatus] = useState('loading');
            const [currentUser, setCurrentUser] = useState(null);
            
            // Use the weekly schedule hook from WeeklyBoard.jsx
            const weeklySchedule = window.WeeklyBoardComponents?.useWeeklySchedule?.() || {
                scheduleSetup: { shift1: { monday: 5, tuesday: 5, wednesday: 5, thursday: 5 }, shift2: { friday: 0, saturday: 0, sunday: 0 } },
                completedWeeks: [],
                updateShiftSchedule: () => {},
                getShiftTotal: () => 0,
                getLineBalance: () => 20,
                completeWeek: () => {},
                getCompletedWeek: () => null,
                getRecentWeeks: () => [],
                deleteCompletedWeek: () => {},
                canEdit: false,
                loading: false,
                synced: false
            };
            
            // Load data from Supabase
            useEffect(() => {
                const loadData = async () => {
                    try {
                        // Check auth state
                        if (window.MODA_SUPABASE_CLIENT?.getSession) {
                            const session = await window.MODA_SUPABASE_CLIENT.getSession();
                            if (session?.user) {
                                setCurrentUser(session.user);
                            }
                        }
                        
                        // Load projects from Supabase
                        if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
                            console.log('[Popout] Loading data from Supabase...');
                            
                            // Load projects
                            const supabaseProjects = await window.MODA_SUPABASE_DATA.projects.getAll();
                            const mappedProjects = (supabaseProjects || []).map(p => ({
                                ...p,
                                customer: p.client || p.customer || '',
                                startDate: p.start_date || p.startDate,
                                endDate: p.end_date || p.endDate
                            }));
                            setProjects(mappedProjects);
                            console.log('[Popout] Loaded', mappedProjects.length, 'projects');
                            
                            // Load weeks from Supabase (same as main app)
                            if (window.MODA_SUPABASE_DATA.productionWeeks) {
                                try {
                                    const supabaseWeeks = await window.MODA_SUPABASE_DATA.productionWeeks.getAll();
                                    if (supabaseWeeks && supabaseWeeks.length > 0) {
                                        setWeeks(supabaseWeeks);
                                        console.log('[Popout] Loaded', supabaseWeeks.length, 'production weeks from Supabase');
                                    } else {
                                        console.log('[Popout] No production weeks in Supabase');
                                    }
                                } catch (weekErr) {
                                    console.error('[Popout] Error loading weeks from Supabase:', weekErr);
                                }
                            }
                            
                            // Load stagger config from Supabase
                            if (window.MODA_SUPABASE_DATA.staggers) {
                                try {
                                    const supabaseStaggers = await window.MODA_SUPABASE_DATA.staggers.getAll();
                                    if (supabaseStaggers && Object.keys(supabaseStaggers).length > 0) {
                                        setStaggerConfig(supabaseStaggers);
                                        console.log('[Popout] Loaded staggers from Supabase');
                                    }
                                } catch (staggerErr) {
                                    console.error('[Popout] Error loading staggers from Supabase:', staggerErr);
                                    // Fallback to localStorage
                                    const savedStaggers = localStorage.getItem('autovol_stagger_config');
                                    if (savedStaggers) {
                                        setStaggerConfig(JSON.parse(savedStaggers));
                                    }
                                }
                            } else {
                                // Fallback to localStorage for staggers
                                const savedStaggers = localStorage.getItem('autovol_stagger_config');
                                if (savedStaggers) {
                                    setStaggerConfig(JSON.parse(savedStaggers));
                                }
                            }
                            
                            setSyncStatus('connected');
                        } else {
                            // Fallback to localStorage
                            console.log('[Popout] Supabase not available, using localStorage');
                            const saved = localStorage.getItem('autovol_projects');
                            if (saved) setProjects(JSON.parse(saved));
                            
                            const savedWeeks = localStorage.getItem('autovol_production_weeks');
                            if (savedWeeks) setWeeks(JSON.parse(savedWeeks));
                            
                            const savedStaggers = localStorage.getItem('autovol_stagger_config');
                            if (savedStaggers) setStaggerConfig(JSON.parse(savedStaggers));
                            
                            setSyncStatus('localStorage');
                        }
                        
                        setLoading(false);
                    } catch (err) {
                        console.error('[Popout] Error loading data:', err);
                        setError(err.message);
                        setSyncStatus('error');
                        setLoading(false);
                    }
                };
                
                // Wait for Supabase to initialize
                const initTimeout = setTimeout(loadData, 500);
                return () => clearTimeout(initTimeout);
            }, []);
            
            // Get current week - find by today's date
            const currentWeek = useMemo(() => {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                return weeks.find(w => {
                    const start = new Date(w.weekStart || w.startDate);
                    const end = new Date(w.weekEnd || w.endDate);
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    return now >= start && now <= end;
                }) || weeks[0] || null;
            }, [weeks]);
            
            // Handle project updates
            const handleSetProjects = useCallback(async (newProjects) => {
                const updated = typeof newProjects === 'function' ? newProjects(projects) : newProjects;
                setProjects(updated);
                
                // Save to localStorage as backup
                localStorage.setItem('autovol_projects', JSON.stringify(updated));
                
                // Sync to Supabase if available
                if (window.MODA_SUPABASE_DATA?.isAvailable?.()) {
                    // The individual module updates are handled by the WeeklyBoard component
                    console.log('[Popout] Projects updated');
                }
            }, [projects]);
            
            // Add week handler
            const addWeek = useCallback((weekData) => {
                const newWeeks = [...weeks, weekData];
                setWeeks(newWeeks);
                localStorage.setItem('autovol_production_weeks', JSON.stringify(newWeeks));
            }, [weeks]);
            
            // Check if user can edit
            const canEdit = currentUser?.email && 
                ['trevor@autovol.com', 'stephanie@autovol.com'].includes(currentUser.email.toLowerCase());
            
            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <p style={{ marginTop: '16px' }}>Loading Weekly Board...</p>
                    </div>
                );
            }
            
            if (error) {
                return (
                    <div className="loading-container">
                        <div style={{ color: '#ef4444', marginBottom: '16px', fontSize: '48px' }}>!</div>
                        <p style={{ color: '#ef4444', fontWeight: 500 }}>{error}</p>
                        <button 
                            onClick={() => window.location.reload()}
                            style={{
                                marginTop: '16px',
                                padding: '8px 16px',
                                background: '#1E3A5F',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer'
                            }}
                        >
                            Retry
                        </button>
                    </div>
                );
            }
            
            const WeeklyBoardTab = window.WeeklyBoardComponents?.WeeklyBoardTab;
            
            if (!WeeklyBoardTab) {
                return (
                    <div className="loading-container">
                        <p>Weekly Board component not loaded. Please refresh.</p>
                        <button 
                            onClick={() => window.location.reload()}
                            style={{
                                marginTop: '16px',
                                padding: '8px 16px',
                                background: '#1E3A5F',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer'
                            }}
                        >
                            Refresh
                        </button>
                    </div>
                );
            }
            
            return (
                <div style={{ height: '100vh' }}>
                    <WeeklyBoardTab
                        projects={projects}
                        productionStages={productionStages}
                        staggerConfig={staggerConfig}
                        currentWeek={currentWeek}
                        weeks={weeks}
                        scheduleSetup={weeklySchedule.scheduleSetup}
                        getLineBalance={weeklySchedule.getLineBalance}
                        completedWeeks={weeklySchedule.completedWeeks}
                        completeWeek={weeklySchedule.completeWeek}
                        addWeek={addWeek}
                        onModuleClick={() => {}}
                        setProductionTab={() => {}}
                        setProjects={handleSetProjects}
                        canEdit={canEdit}
                        initialSelectedWeekId={null}
                        onWeekSelected={() => {}}
                        onEditWeek={() => {}}
                        onReportIssue={() => {}}
                        isPopout={true}
                    />
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<WeeklyBoardPopout />, document.getElementById('root'));
    </script>
</body>
</html>
